# Windows ç’°å¢ƒè³‡æ–™åº«é…ç½®æŒ‡å—

## è³‡æ–™åº«ç’°å¢ƒ

**Windows æ­£å¼ç’°å¢ƒ**ï¼šé€£æ¥æ­£å¼å€ SQL Server

## é€£æ¥å­—ä¸²è¨­å®š

### æ–¹å¼ä¸€ï¼šä¿®æ”¹ appsettings.Production.json

**ä½ç½®**ï¼š`DmsSystem.Api/appsettings.Production.json`

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=æ­£å¼ä¼ºæœå™¨ä½å€;Database=DMS;User Id=æ­£å¼ä½¿ç”¨è€…;Password=æ­£å¼å¯†ç¢¼;TrustServerCertificate=True;MultipleActiveResultSets=True"
  }
}
```

**âš ï¸ é‡è¦**ï¼šè«‹æ›¿æ›ç‚ºæ­£å¼ç’°å¢ƒçš„å¯¦éš›é€£æ¥è³‡è¨Š

### æ–¹å¼äºŒï¼šä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼ˆæ¨è–¦ï¼Œæ›´å®‰å…¨ï¼‰

**PowerShell**ï¼š
```powershell
$env:ConnectionStrings__DefaultConnection="Server=æ­£å¼ä¼ºæœå™¨ä½å€;Database=DMS;User Id=æ­£å¼ä½¿ç”¨è€…;Password=æ­£å¼å¯†ç¢¼;TrustServerCertificate=True;MultipleActiveResultSets=True"
$env:ASPNETCORE_ENVIRONMENT="Production"
```

**å‘½ä»¤æç¤ºå­—å…ƒï¼ˆCMDï¼‰**ï¼š
```cmd
set ConnectionStrings__DefaultConnection=Server=æ­£å¼ä¼ºæœå™¨ä½å€;Database=DMS;User Id=æ­£å¼ä½¿ç”¨è€…;Password=æ­£å¼å¯†ç¢¼;TrustServerCertificate=True;MultipleActiveResultSets=True
set ASPNETCORE_ENVIRONMENT=Production
```

## é€£æ¥å­—ä¸²æ ¼å¼èªªæ˜

```
Server=<ä¼ºæœå™¨ä½å€>,<åŸ è™Ÿ>;Database=<è³‡æ–™åº«åç¨±>;User Id=<ä½¿ç”¨è€…åç¨±>;Password=<å¯†ç¢¼>;TrustServerCertificate=True;MultipleActiveResultSets=True
```

### åƒæ•¸èªªæ˜

- **Server**: SQL Server ä½å€å’ŒåŸ è™Ÿï¼ˆæ­£å¼ç’°å¢ƒï¼‰
- **Database**: è³‡æ–™åº«åç¨±ï¼ˆé è¨­ç‚º `DMS`ï¼‰
- **User Id**: SQL Server ç™»å…¥å¸³è™Ÿ
- **Password**: SQL Server ç™»å…¥å¯†ç¢¼
- **TrustServerCertificate**: ä¿¡ä»»ä¼ºæœå™¨æ†‘è­‰
- **MultipleActiveResultSets**: å…è¨±å¤šå€‹æ´»å‹•çµæœé›†

## ç’°å¢ƒè®Šæ•¸å„ªå…ˆé †åº

ASP.NET Core æœƒä¾ç…§ä»¥ä¸‹é †åºè¼‰å…¥è¨­å®šï¼ˆå¾Œé¢çš„æœƒè¦†è“‹å‰é¢çš„ï¼‰ï¼š

1. `appsettings.json`
2. `appsettings.{Environment}.json`ï¼ˆä¾‹å¦‚ `appsettings.Production.json`ï¼‰
3. ç’°å¢ƒè®Šæ•¸

## è¨­å®š ASP.NET Core ç’°å¢ƒ

### Windows PowerShell
```powershell
$env:ASPNETCORE_ENVIRONMENT="Production"
```

### Windows CMD
```cmd
set ASPNETCORE_ENVIRONMENT=Production
```

## é©—è­‰é€£æ¥

### ä½¿ç”¨ SQL Server Management Studio (SSMS)

1. é–‹å•Ÿ SSMS
2. è¼¸å…¥ä¼ºæœå™¨ä½å€ã€ä½¿ç”¨è€…åç¨±å’Œå¯†ç¢¼
3. é€£æ¥æ¸¬è©¦

### ä½¿ç”¨å‘½ä»¤åˆ—

```powershell
sqlcmd -S æ­£å¼ä¼ºæœå™¨ä½å€ -U æ­£å¼ä½¿ç”¨è€… -P æ­£å¼å¯†ç¢¼ -d DMS -Q "SELECT DB_NAME()"
```

## å¸¸è¦‹å•é¡Œ

### Q: å¦‚ä½•ç¢ºèªé€£æ¥å­—ä¸²æ˜¯å¦æ­£ç¢ºï¼Ÿ

A: åŸ·è¡Œæ‡‰ç”¨ç¨‹å¼æ™‚ï¼Œå¦‚æœé€£æ¥å­—ä¸²éŒ¯èª¤ï¼Œæœƒåœ¨å•Ÿå‹•æ™‚æ‹‹å‡ºä¾‹å¤–ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨ SQL Server Management Studio æˆ– `sqlcmd` æ¸¬è©¦é€£æ¥ã€‚

### Q: å¦‚ä½•ä¿è­·ç”Ÿç”¢ç’°å¢ƒçš„å¯†ç¢¼ï¼Ÿ

A: 
1. ä½¿ç”¨ç’°å¢ƒè®Šæ•¸ï¼ˆæ¨è–¦ï¼‰
2. ä½¿ç”¨ Azure Key Vault æˆ–å…¶ä»–å¯†ç¢¼ç®¡ç†æœå‹™
3. ä¸è¦åœ¨ç¨‹å¼ç¢¼ä¸­ç¡¬ç·¨ç¢¼å¯†ç¢¼

### Q: é€£æ¥å¤±æ•—æ€éº¼è¾¦ï¼Ÿ

A: æª¢æŸ¥ï¼š
1. SQL Server æ˜¯å¦æ­£åœ¨é‹è¡Œ
2. é˜²ç«ç‰†è¨­å®šæ˜¯å¦å…è¨±é€£æ¥
3. é€£æ¥å­—ä¸²ä¸­çš„åƒæ•¸æ˜¯å¦æ­£ç¢º
4. ä½¿ç”¨è€…å¸³è™Ÿæ˜¯å¦æœ‰è¶³å¤ æ¬Šé™
5. ç¶²è·¯é€£ç·šæ˜¯å¦æ­£å¸¸

### Q: å¦‚ä½•åˆ‡æ›ä¸åŒçš„è³‡æ–™åº«ï¼Ÿ

A: ä¿®æ”¹é€£æ¥å­—ä¸²ä¸­çš„ `Database` åƒæ•¸ï¼Œæˆ–ä½¿ç”¨ä¸åŒçš„ç’°å¢ƒè®Šæ•¸è¨­å®šã€‚

## âš ï¸ é‡è¦æé†’

- **æ­¤é…ç½®å°ˆç‚º Windows æ­£å¼ç’°å¢ƒè¨­è¨ˆ**
- è«‹ç¢ºä¿æ‚¨æœ‰æ­£å¼å€ SQL Server çš„é€£æ¥æ¬Šé™
- ç”Ÿç”¢ç’°å¢ƒå¯†ç¢¼è«‹å¦¥å–„ä¿ç®¡ï¼Œä¸è¦æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»çµ±

## ğŸ”„ è³‡æ–™åº«æ›´æ–°ï¼ˆEF Scaffold ä¸€éµé‡ç”Ÿï¼‰

> ä¾å¾ª AI_CONTEXT åŸå‰‡ï¼šæŠŠå°å¤–æŒ‡ä»¤å¯«åœ¨æ–‡ä»¶ä¸­ï¼Œä¾›æ—¥å¾Œã€Œç„¡è…¦ã€é‡ç”Ÿ Domain/DbContextã€‚

### âš ï¸ é‡è¦ï¼šåŸ·è¡Œç’°å¢ƒèªªæ˜

**`Scaffold-DbContext` å‘½ä»¤åªèƒ½åœ¨ Visual Studio çš„å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°ï¼ˆPackage Manager Consoleï¼‰ä¸­ä½¿ç”¨ï¼**

- âœ… **æ­£ç¢º**ï¼šåœ¨ Visual Studio ä¸­é–‹å•Ÿå°ˆæ¡ˆ â†’ å·¥å…· â†’ NuGet å¥—ä»¶ç®¡ç†å™¨ â†’ å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°
- âŒ **éŒ¯èª¤**ï¼šåœ¨ PowerShellã€CMD æˆ–çµ‚ç«¯æ©Ÿä¸­ç›´æ¥åŸ·è¡Œ `Scaffold-DbContext`ï¼ˆæœƒå‡ºç¾ã€Œç„¡æ³•è¾¨è­˜ã€éŒ¯èª¤ï¼‰

å¦‚æœè¦åœ¨å‘½ä»¤åˆ—åŸ·è¡Œï¼Œè«‹ä½¿ç”¨ `dotnet ef` å·¥å…·ï¼ˆè¦‹ä¸‹æ–¹èªªæ˜ï¼‰ã€‚

---

### æ–¹å¼ä¸€ï¼šVisual Studio å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°ï¼ˆæ¨è–¦ï¼‰

**æ­¥é©Ÿ**ï¼š
1. åœ¨ Visual Studio 2022 ä¸­é–‹å•Ÿ `DMS.sln`
2. å·¥å…· â†’ NuGet å¥—ä»¶ç®¡ç†å™¨ â†’ å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°
3. ç¢ºèªã€Œé è¨­å°ˆæ¡ˆã€é¸æ“‡ `DmsSystem.Infrastructure`
4. è¤‡è£½ä»¥ä¸‹æŒ‡ä»¤ä¸¦è²¼ä¸ŠåŸ·è¡Œï¼š

```
Scaffold-DbContext "Name=ConnectionStrings:DefaultConnection" Microsoft.EntityFrameworkCore.SqlServer `
  -Project "DmsSystem.Infrastructure" `
  -StartupProject "DmsSystem.Api" `
  -OutputDir "..\DmsSystem.Domain\Entities" `
  -ContextDir "Persistence\Contexts" `
  -Namespace "DmsSystem.Domain.Entities" `
  -ContextNamespace "DmsSystem.Infrastructure.Persistence.Contexts" `
  -Force
```

**ç”¨é€”**ï¼šè¦†å¯«ä¸¦é‡æ–°ç”¢ç”Ÿ DbContextï¼ˆInfrastructure/Persistence/Contextsï¼‰èˆ‡å¯¦é«”ï¼ˆDomain/Entitiesï¼‰ï¼Œä¿æŒç¾æœ‰å°ˆæ¡ˆçµæ§‹èˆ‡å‘½åç©ºé–“ã€‚

---

### æ–¹å¼äºŒï¼šdotnet-ef CLIï¼ˆå‘½ä»¤åˆ—ï¼‰

**å‰ç½®æ­¥é©Ÿï¼šå®‰è£ dotnet-ef å·¥å…·**

å¦‚æœå°šæœªå®‰è£ï¼Œè«‹å…ˆåŸ·è¡Œï¼š

```powershell
dotnet tool install --global dotnet-ef
```

**åŸ·è¡Œæ­¥é©Ÿ**ï¼š
1. é–‹å•Ÿ PowerShell æˆ–å‘½ä»¤æç¤ºå­—å…ƒ
2. åˆ‡æ›åˆ°æ–¹æ¡ˆæ ¹ç›®éŒ„ï¼ˆ`DmsSystem/`ï¼‰
3. åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```powershell
dotnet ef dbcontext scaffold "Name=ConnectionStrings:DefaultConnection" Microsoft.EntityFrameworkCore.SqlServer `
  --project DmsSystem.Infrastructure `
  --startup-project DmsSystem.Api `
  --output-dir ../DmsSystem.Domain/Entities `
  --context-dir Persistence/Contexts `
  --namespace DmsSystem.Domain.Entities `
  --context-namespace DmsSystem.Infrastructure.Persistence.Contexts `
  --force
```

**ç”¨é€”**ï¼šåŒä¸Šï¼Œé©ç”¨æ–¼å‘½ä»¤åˆ—/CI/CDã€‚`--force` æœƒè¦†å¯«ç¾æœ‰æª”æ¡ˆï¼ŒåŸ·è¡Œå‰è«‹å…ˆå‚™ä»½æˆ–ç¢ºèªç„¡æ‰‹æ”¹çš„æ¨¡å‹ç¨‹å¼ç¢¼ã€‚

---

### æ•…éšœæ’é™¤

#### âŒ éŒ¯èª¤ï¼š`Scaffold-DbContext : ç„¡æ³•è¾¨è­˜ 'Scaffold-DbContext' è©å½™...`

**åŸå› **ï¼šåœ¨ PowerShell/CMD ä¸­åŸ·è¡Œï¼Œè€Œé Visual Studio å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. **æ–¹æ¡ˆ A**ï¼šä½¿ç”¨ Visual Studio å¥—ä»¶ç®¡ç†å™¨ä¸»æ§å°ï¼ˆè¦‹ä¸Šæ–¹ã€Œæ–¹å¼ä¸€ã€ï¼‰
2. **æ–¹æ¡ˆ B**ï¼šä½¿ç”¨ `dotnet ef` CLIï¼ˆè¦‹ä¸Šæ–¹ã€Œæ–¹å¼äºŒã€ï¼‰

#### âŒ éŒ¯èª¤ï¼š`æ‰¾ä¸åˆ°å‘½ä»¤ 'dotnet-ef'` æˆ– `æ‰¾ä¸åˆ°å‘½ä»¤ 'dotnet ef'`

**åŸå› **ï¼šå°šæœªå®‰è£ dotnet-ef å·¥å…·ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
```powershell
dotnet tool install --global dotnet-ef
```

å®‰è£å®Œæˆå¾Œï¼Œé‡æ–°åŸ·è¡Œ `dotnet ef` æŒ‡ä»¤ã€‚

#### âŒ éŒ¯èª¤ï¼šé€£æ¥å­—ä¸²ç„¡æ³•è®€å–

**åŸå› **ï¼š`appsettings.Production.json` ä¸­çš„ `DefaultConnection` è¨­å®šä¸æ­£ç¢ºã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
1. ç¢ºèª `DmsSystem.Api/appsettings.Production.json` ä¸­æœ‰æ­£ç¢ºçš„é€£æ¥å­—ä¸²
2. æˆ–ä½¿ç”¨ç’°å¢ƒè®Šæ•¸è¨­å®šé€£æ¥å­—ä¸²ï¼ˆè¦‹ä¸Šæ–¹ã€Œé€£æ¥å­—ä¸²è¨­å®šã€ï¼‰

#### âš ï¸ æ³¨æ„äº‹é …

- `--force` / `-Force` æœƒ**è¦†å¯«**ç¾æœ‰æª”æ¡ˆï¼ŒåŸ·è¡Œå‰è«‹ç¢ºèªï¼š
  - å·²å‚™ä»½æ‰‹å‹•ä¿®æ”¹çš„å¯¦é«”é¡åˆ¥
  - æˆ–ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶ï¼ˆGitï¼‰è¿½è¹¤è®Šæ›´
- è‹¥åƒ…éœ€ç‰¹å®šè³‡æ–™è¡¨ï¼Œå¯åœ¨æŒ‡ä»¤å¾ŒåŠ ä¸Šï¼š
  - `--table MDS.FUND_DIV`ï¼ˆåƒ…ç”¢ç”Ÿ FUND_DIV è¡¨ï¼‰
  - `--table MDS.FUND_DIV --table MDS.FUND_DIV_SET`ï¼ˆå¤šå€‹è¡¨ï¼‰

## ğŸ”— ç›¸é—œæ–‡ä»¶

- **å®Œæ•´ç’°å¢ƒè¨­å®š**ï¼š[Windows é–‹ç™¼ç’°å¢ƒå®Œæ•´æ‰‹å†Š](./WINDOWS-DEVELOPMENT/01-Windowsé–‹ç™¼ç’°å¢ƒå®Œæ•´æ‰‹å†Š.md)
- **å¿«é€Ÿé–‹å§‹**ï¼š[å¿«é€Ÿé–‹å§‹æŒ‡å—](./00-å¿«é€Ÿé–‹å§‹.md)
