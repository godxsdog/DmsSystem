# DMS 系統使用者手冊

## 🎯 快速開始

### 前置需求

- Windows 作業系統
- Visual Studio 2022
- .NET 8.0 SDK
- 正式區 SQL Server 連接權限

### 第一步：確認資料庫連接

**為什麼需要這一步？**
- 系統需要 SQL Server 資料庫來儲存資料
- 必須連接到正式區 SQL Server

**如何確認：**
1. 確認正式區 SQL Server 正在運行
2. 確認連接字串已正確設定（參考 [資料庫配置指南](./03-資料庫配置.md)）
3. 使用 SQL Server Management Studio 測試連接

### 第二步：啟動後端 API

**為什麼需要這一步？**
- 後端 API 提供資料處理和查詢功能
- 前端需要透過 API 來存取資料

**使用 Visual Studio 2022：**
1. 開啟 `DMS.sln`
2. 設定啟動專案為 `DmsSystem.Api`
3. 設定環境為 `Production`
4. 按 `F5` 啟動

**或使用命令列：**
```powershell
cd DmsSystem.Api
$env:ASPNETCORE_ENVIRONMENT="Production"
dotnet run
```

**應該看到：**
```
[INF] 應用程式啟動完成
[INF] Now listening on: http://localhost:5137
```

**檢查是否成功：**
1. 打開瀏覽器訪問：http://localhost:5137/swagger
2. 應該看到 Swagger API 文件頁面

**保持這個終端視窗開啟**，API 需要持續運行

### 第三步：啟動前端（新終端視窗）

**為什麼需要這一步？**
- 前端提供使用者介面
- 讓使用者可以上傳檔案和查看資料

**如何執行：**
```powershell
cd react-client
npm install
npm run dev
```

**應該看到：**
```
  VITE v5.x.x  ready in xxx ms

  ➜  Local:   http://localhost:5173/
```

**檢查是否成功：**
1. 打開瀏覽器訪問：http://localhost:5173
2. 應該看到 DMS 系統的首頁

---

## 📊 資料流程說明

### 整體架構流程

```
┌─────────────┐
│  使用者      │
│  (瀏覽器)    │
└──────┬──────┘
       │
       │ HTTP 請求
       ▼
┌─────────────────┐
│  React 前端      │
│  (Port 5173)     │
│  - 檔案上傳介面   │
│  - 資料檢視介面   │
└──────┬──────────┘
       │
       │ RESTful API
       │ (http://localhost:5137)
       ▼
┌─────────────────┐
│  .NET API       │
│  (Port 5137)     │
│  - 驗證輸入      │
│  - 處理請求      │
└──────┬──────────┘
       │
       │ 業務邏輯
       ▼
┌─────────────────┐
│  Application    │
│  Service 層      │
│  - 檔案解析      │
│  - 資料處理      │
└──────┬──────────┘
       │
       │ 資料存取
       ▼
┌─────────────────┐
│  Infrastructure │
│  Repository     │
└──────┬──────────┘
       │
       │ SQL 查詢
       ▼
┌─────────────────┐
│  正式區 SQL Server│
│  - 儲存資料      │
└─────────────────┘
```

### 檔案上傳流程

1. **使用者在網頁選擇檔案**：點擊「選擇檔案」按鈕，選擇 .xlsx 或 .csv 檔案
2. **前端發送檔案到 API**：使用 `FormData` 包裝檔案，發送 POST 請求
3. **API 驗證檔案**：檢查檔案格式、大小等
4. **API 呼叫 Service 處理**：將檔案串流傳給 Service 層
5. **Service 使用檔案解析器**：根據檔案類型選擇對應的解析器
6. **檔案解析器實作**：Excel 使用 NPOI，CSV 使用 CsvHelper
7. **Service 套用業務邏輯**：自動填入處理日期、員工編號等欄位
8. **Service 儲存到資料庫**：呼叫 Repository 的批次新增方法
9. **Repository 執行資料庫操作**：使用 Entity Framework Core 批次新增
10. **回傳結果給前端**：前端收到成功訊息和新增筆數

### 資料查詢流程

1. **使用者點擊「資料檢視」**：在網頁上點擊「資料檢視」標籤
2. **前端發送查詢請求**：發送 GET 請求到 API
3. **API Controller 接收請求**：接收查詢參數（分頁資訊）
4. **Controller 呼叫 Repository**：取得所有資料
5. **Repository 查詢資料庫**：使用 Entity Framework Core 查詢
6. **Controller 處理分頁**：根據分頁參數篩選資料
7. **回傳 JSON 資料**：回傳分頁結果
8. **前端顯示資料**：將資料設定到 state，React 自動重新渲染表格

---

## 🔄 資料串接說明

### 資料如何從資料庫到網頁

```
正式區 SQL Server 資料庫
    │
    │ Entity Framework Core 映射
    ▼
Domain Entities (ShmtSource1, ShmtSource4, etc.)
    │
    │ Repository 查詢
    ▼
Application Service
    │
    │ Controller 處理
    ▼
API Response (JSON)
    │
    │ HTTP 傳輸
    ▼
React Frontend
    │
    │ State 管理
    ▼
UI 顯示 (表格、列表)
```

---

## 🎓 為什麼要這樣設計？

### 1. 分層架構的好處

- **每層職責清楚**：Domain、Application、Infrastructure、Api 各司其職
- **可以獨立測試**：每層都可以單獨測試
- **可以獨立替換**：換資料庫或檔案解析器只需換實作

### 2. 前後端分離的好處

- **後端提供 API**：任何前端都可以使用
- **可以同時支援網頁、手機 App**：前端可以自由選擇技術棧

### 3. 介面導向的好處

- **定義 `IFileParser` 介面**：可以實作 Excel 解析器、CSV 解析器
- **換解析器只需換實作**：不用改業務邏輯

---

## 📝 執行檢查清單

### 啟動前檢查
- [ ] 已安裝 Visual Studio 2022
- [ ] 已安裝 .NET 8 SDK
- [ ] 已安裝 Node.js 和 npm
- [ ] 正式區 SQL Server 正在運行
- [ ] 資料庫連接字串已正確設定

### 啟動步驟
- [ ] 步驟 1：確認資料庫連接
- [ ] 步驟 2：啟動後端 API
- [ ] 步驟 3：啟動前端

### 驗證步驟
- [ ] 可以訪問 Swagger：http://localhost:5137/swagger
- [ ] 可以訪問前端：http://localhost:5173
- [ ] 前端可以顯示資料
- [ ] 可以上傳檔案

---

## 🐛 常見問題

### Q: API 啟動失敗，顯示資料庫連接錯誤

**A:** 
1. 確認正式區 SQL Server 正在運行
2. 檢查 `appsettings.Production.json` 中的連接字串
3. 參考 [資料庫配置指南](./03-資料庫配置.md)

### Q: 前端無法連接到 API

**A:**
1. 確認 API 正在運行（檢查終端視窗）
2. 確認 API URL 正確：http://localhost:5137
3. 檢查瀏覽器控制台的錯誤訊息

### Q: 資料顯示為空

**A:**
1. 確認資料庫中有資料
2. 檢查 API 是否正常回傳資料（使用 Swagger 測試）
3. 檢查前端 API 客戶端設定

---

## 📚 相關文件

- **快速開始**：[快速開始指南](./00-快速開始.md)
- **完整環境設定**：[Windows 開發環境完整手冊](./WINDOWS-DEVELOPMENT/01-Windows開發環境完整手冊.md)
- **資料庫配置**：[資料庫配置指南](./03-資料庫配置.md)
- **系統架構**：[架構指南](./01-架構指南.md)

---

**現在您可以開始使用系統了！** 🎉

如有任何問題，請參考其他文件或檢查執行狀態報告。
