# 測試指南

## 執行測試

### 單元測試

```bash
cd DmsSystem
dotnet test DmsSystem.Tests/DmsSystem.Tests.csproj
```

### 執行特定測試類別

```bash
dotnet test --filter "FullyQualifiedName~ShareholderMeetingDetailServiceTests"
```

### 執行特定測試方法

```bash
dotnet test --filter "FullyQualifiedName~ProcessUploadAsync_WithValidFile_ReturnsSuccess"
```

## 測試覆蓋率

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

## 測試專案結構

```
DmsSystem.Tests/
├── Services/              # Service 單元測試
│   ├── ShareholderMeetingDetailServiceTests.cs
│   └── CompanyInfoUploadServiceTests.cs
├── Validators/            # 驗證器測試
│   └── FileUploadValidatorTests.cs
└── Integration/           # 整合測試
    └── ApiIntegrationTests.cs
```

## 測試案例說明

### ShareholderMeetingDetailServiceTests

- ✅ `ProcessUploadAsync_WithValidFile_ReturnsSuccess` - 測試有效檔案上傳
- ✅ `ProcessUploadAsync_WithEmptyFile_ReturnsSuccessWithZeroRows` - 測試空檔案
- ✅ `ProcessUploadAsync_WithParserException_ReturnsFailure` - 測試解析錯誤處理

### FileUploadValidatorTests

- ✅ `Validate_WithNullFile_ShouldHaveError` - 測試空檔案驗證
- ✅ `Validate_WithValidXlsxFile_ShouldSucceed` - 測試有效 XLSX 檔案
- ✅ `Validate_WithValidCsvFile_ShouldSucceed` - 測試有效 CSV 檔案
- ✅ `Validate_WithInvalidExtension_ShouldHaveError` - 測試無效副檔名
- ✅ `Validate_WithFileTooLarge_ShouldHaveError` - 測試檔案過大
- ✅ `Validate_WithEmptyFile_ShouldHaveError` - 測試空檔案大小

## 手動測試 API

### 使用 Swagger

1. 啟動 API：
```bash
cd DmsSystem.Api
dotnet run
```

2. 訪問 http://localhost:5137/swagger

3. 測試上傳端點：
   - POST `/api/ShareholderMeetings/upload-shmtsource1`
   - POST `/api/CompanyInfo/upload-shmtsource4`
   - POST `/api/StockBalance/upload`

### 使用 curl

```bash
# 測試股東會明細上傳
curl -X POST "http://localhost:5137/api/ShareholderMeetings/upload-shmtsource1" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@test.xlsx"
```

## 測試資料

測試資料檔案應放在 `DmsSystem.Tests/TestData/` 目錄下。

## 持續整合

建議在 CI/CD 流程中加入測試執行：

```yaml
- name: Run Tests
  run: dotnet test --no-build --verbosity normal
```

