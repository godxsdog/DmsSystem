# 測試指南

## 執行測試

### 單元測試

```bash
cd DmsSystem
dotnet test DmsSystem.Tests/DmsSystem.Tests.csproj
```

### 執行特定測試類別

```bash
dotnet test --filter "FullyQualifiedName~ShareholderMeetingDetailServiceTests"
```

### 執行特定測試方法

```bash
dotnet test --filter "FullyQualifiedName~ProcessUploadAsync_WithValidFile_ReturnsSuccess"
```

## 測試覆蓋率

```bash
dotnet test /p:CollectCoverage=true /p:CoverletOutputFormat=opencover
```

## 測試專案結構

```
DmsSystem.Tests/
├── Services/              # Service 單元測試
│   ├── ShareholderMeetingDetailServiceTests.cs
│   └── CompanyInfoUploadServiceTests.cs
├── Validators/            # 驗證器測試
│   └── FileUploadValidatorTests.cs
└── Integration/           # 整合測試
    └── ApiIntegrationTests.cs
```

## 測試案例說明

### ShareholderMeetingDetailServiceTests

- ✅ `ProcessUploadAsync_WithValidFile_ReturnsSuccess` - 測試有效檔案上傳
- ✅ `ProcessUploadAsync_WithEmptyFile_ReturnsSuccessWithZeroRows` - 測試空檔案
- ✅ `ProcessUploadAsync_WithParserException_ReturnsFailure` - 測試解析錯誤處理

### FileUploadValidatorTests

- ✅ `Validate_WithNullFile_ShouldHaveError` - 測試空檔案驗證
- ✅ `Validate_WithValidXlsxFile_ShouldSucceed` - 測試有效 XLSX 檔案
- ✅ `Validate_WithValidCsvFile_ShouldSucceed` - 測試有效 CSV 檔案
- ✅ `Validate_WithInvalidExtension_ShouldHaveError` - 測試無效副檔名
- ✅ `Validate_WithFileTooLarge_ShouldHaveError` - 測試檔案過大
- ✅ `Validate_WithEmptyFile_ShouldHaveError` - 測試空檔案大小

## 執行與測試系統

### 重要概念：Swagger 與 React 的區別

#### Swagger（API 文檔與測試工具）
- **位置**：運行在後端 API 伺服器上
- **URL**：`http://localhost:5137/swagger` 或 `https://localhost:7036/swagger`
- **用途**：
  - 查看所有 API 端點的文檔
  - 直接在瀏覽器中測試 API
  - 查看 API 的請求和回應格式
- **啟動方式**：當後端 API 啟動時自動可用（注意：目前 Swagger 已停用）

#### React（前端應用）
- **位置**：運行在獨立的開發伺服器上（Vite）
- **URL**：`http://localhost:5173`
- **用途**：
  - 用戶界面（UI）
  - 檔案上傳功能
  - 資料顯示頁面
- **啟動方式**：需要單獨執行 `npm run dev`

### 執行步驟

#### 1. 啟動後端 API

**方式 A：使用 Visual Studio 2022**
1. 開啟 `DMS.sln`
2. 設定 `DmsSystem.Api` 為啟動專案
3. 選擇啟動設定檔：
   - **http**：`http://localhost:5137`
   - **https**：`https://localhost:7036`
4. 按 F5 或點擊「執行」
5. **如果瀏覽器沒有自動開啟**，請手動訪問：
   - HTTP：`http://localhost:5137/swagger`
   - HTTPS：`https://localhost:7036/swagger`

**方式 B：使用命令列**
```bash
cd DmsSystem.Api
dotnet run
```

啟動後，訪問：`http://localhost:5137/swagger`

#### 2. 啟動前端 React（可選）

如果需要測試完整的前端功能：

```bash
cd react-client
npm install  # 僅首次需要
npm run dev
```

啟動後，訪問：`http://localhost:5173`

### 常見問題

#### Q1：執行後 Swagger 沒有自動跳出頁面？

**解決方案**：
1. 檢查 VS2022 的啟動設定檔是否正確
2. 確認 `launchSettings.json` 中的 `launchBrowser` 設為 `true`
3. **手動訪問**：在瀏覽器中輸入 `http://localhost:5137/swagger`

#### Q2：Swagger 頁面顯示 404？

**可能原因**：
- API 尚未完全啟動（等待幾秒後再試）
- 環境變數設定錯誤
- 連接字串設定錯誤導致啟動失敗

**解決方案**：
1. 檢查 Visual Studio 的「輸出」視窗，查看是否有錯誤訊息
2. 確認 `appsettings.json` 中的資料庫連接字串正確
3. 檢查 `Program.cs` 中的 Swagger 設定

#### Q3：React 和 Swagger 是同一個網頁嗎？

**不是**。它們是完全不同的應用：
- **Swagger**：後端 API 文檔工具（`localhost:5137/swagger`）
- **React**：前端用戶界面（`localhost:5173`）

#### Q4：如何確認 API 已成功啟動？

**檢查方式**：
1. 查看 Visual Studio 的「輸出」視窗，應該看到：
   ```
   應用程式啟動完成
   Now listening on: http://localhost:5137
   ```
2. 訪問 `http://localhost:5137/swagger`，應該看到 Swagger UI
3. 訪問 `http://localhost:5137/api/DataView/shareholder-meetings`，應該看到 JSON 資料

### 預設連接埠

| 服務 | 連接埠 | URL |
|------|--------|-----|
| API (HTTP) | 5137 | `http://localhost:5137` |
| API (HTTPS) | 7036 | `https://localhost:7036` |
| Swagger | 5137 | `http://localhost:5137/swagger` |
| React (Vite) | 5173 | `http://localhost:5173` |

## 手動測試 API

### 使用 Swagger UI

1. 訪問 `http://localhost:5137/swagger`
2. 展開任何 API 端點（例如 `GET /api/DataView/shareholder-meetings`）
3. 點擊「Try it out」
4. 點擊「Execute」
5. 查看回應結果

### 使用 curl（命令列）

```bash
# 測試股東會資料
curl http://localhost:5137/api/DataView/shareholder-meetings

# 測試公司資訊
curl http://localhost:5137/api/DataView/company-info

# 測試股票餘額
curl http://localhost:5137/api/DataView/stock-balance

# 測試配息資料查詢
curl http://localhost:5137/api/Dividends

# 測試特定基金配息資料
curl "http://localhost:5137/api/Dividends?fundNo=D109"
```

### 測試上傳端點

```bash
# 測試股東會明細上傳
curl -X POST "http://localhost:5137/api/ShareholderMeetings/upload-shmtsource1" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@test.xlsx"

# 測試配息 CSV 匯入
curl -X POST "http://localhost:5137/api/Dividends/import" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@dividen_5a1_IT版JP 匯入 FAS.csv"
```

## 配息功能測試

### 測試資料說明

根據 `dividen_5a1_IT版JP 匯入 FAS.csv` 檔案，包含以下測試資料：

**基金代號列表**：
- D109, D110, D111, D123, D124, D125 (D108 系列)
- D113, D114, D115, D126, D127, D128, D132 (D112 系列)
- D137, D138, D139 (D136 系列)
- 以及其他基金...

**配息資訊**：
- **配息基準日**: 2020-07-06
- **配息頻率**: M (月配)
- **配息年度**: 2020

### 測試案例 1：匯入 CSV 檔案

**步驟**：
1. 開啟前端應用程式（http://localhost:5173）
2. 點擊「配息管理」標籤
3. 在「1. 匯入可分配收益 CSV 檔案」區塊：
   - 點擊「選擇檔案」
   - 選擇 `dividen_5a1_IT版JP 匯入 FAS.csv`
   - 點擊「匯入檔案」

**預期結果**：
- 顯示匯入結果：
  - 新增：X 筆（X 為 CSV 中的資料筆數）
  - 更新：0 筆
  - 失敗：0 筆
- 無錯誤訊息
- 顯示明顯的成功/失敗指示器

### 測試案例 2：查詢已載入的配息資料

**測試 2.1：查詢所有配息資料**
1. 在「3. 查詢已載入的配息資料」區塊
2. 不填寫任何篩選條件
3. 點擊「查詢配息資料」

**預期結果**：顯示所有已載入的配息資料（約 55 筆）

**測試 2.2：依基金代號查詢**
1. 在「基金代號」欄位輸入：`D109`
2. 點擊「查詢配息資料」

**預期結果**：只顯示基金代號為 D109 的配息資料（1 筆）

**測試 2.3：依配息頻率查詢**
1. 在「配息頻率」下拉選單選擇：`月配 (M)`
2. 點擊「查詢配息資料」

**預期結果**：顯示所有月配的配息資料

**測試 2.4：依日期範圍查詢**
1. 在「開始日期」輸入：`2020-07-01`
2. 在「結束日期」輸入：`2020-07-31`
3. 點擊「查詢配息資料」

**預期結果**：顯示 2020 年 7 月的所有配息資料

**測試 2.5：組合查詢**
1. 在「基金代號」輸入：`D112`
2. 在「配息頻率」選擇：`月配 (M)`
3. 在「開始日期」輸入：`2020-07-01`
4. 點擊「查詢配息資料」

**預期結果**：顯示 D112 系列基金在 2020 年 7 月及之後的月配資料

### 測試案例 3：執行配息計算與確認

**前置條件**：
- 已匯入 CSV 檔案
- 資料庫中需要有對應的 NAV 和單位數資料

**測試步驟**：
1. 在「2. 執行配息計算與確認」區塊
2. 輸入：
   - 基金代號：`D109`
   - 配息基準日：`2020-07-06`
   - 配息頻率：`月配 (M)`
3. 點擊「執行計算與確認」

**預期結果**：
- 如果資料庫中有對應的 NAV 和單位數：
  - 顯示計算成功
  - 顯示 NAV、單位數、總可分配金額、配息率等資訊
- 如果沒有對應資料：
  - 顯示錯誤訊息：「此配息基準淨值尚未公告，不可進行確認作業！」或「基準日單位數為零或未找到」

### 測試檢查清單

- [ ] CSV 檔案成功匯入，無錯誤
- [ ] 可以查詢所有配息資料
- [ ] 可以依基金代號篩選
- [ ] 可以依配息頻率篩選
- [ ] 可以依日期範圍篩選
- [ ] 組合查詢功能正常
- [ ] 查詢結果表格顯示正確
- [ ] 配息計算功能正常（需有 NAV 和單位數資料）
- [ ] 錯誤處理正確
- [ ] 前端錯誤訊息顯示詳細

### 快速測試指令（API 測試）

```bash
# 查詢所有配息資料
curl http://localhost:5137/api/Dividends

# 查詢特定基金
curl "http://localhost:5137/api/Dividends?fundNo=D109"

# 查詢特定日期範圍
curl "http://localhost:5137/api/Dividends?startDate=2020-07-01&endDate=2020-07-31"

# 組合查詢
curl "http://localhost:5137/api/Dividends?fundNo=D112&dividendType=M&startDate=2020-07-01"
```

## 測試資料

測試資料檔案應放在 `DmsSystem.Tests/TestData/` 目錄下。

## 持續整合

建議在 CI/CD 流程中加入測試執行：

```yaml
- name: Run Tests
  run: dotnet test --no-build --verbosity normal
```

## 相關文件

- **配息功能詳細測試案例**：[配息功能測試案例](./FEATURES/DIVIDEND/TEST_CASES.md)
- **快速開始**：[快速開始指南](./00-快速開始.md)

