# 配息功能測試案例 (5A1 / 5A3)

## 📋 測試資料說明

根據 `dividen_5a1_IT版JP 匯入 FAS.csv` 檔案，包含以下測試資料：

### 基金代號列表
- D109, D110, D111, D123, D124, D125 (D108 系列)
- D113, D114, D115, D126, D127, D128, D132 (D112 系列)
- D137, D138, D139 (D136 系列)
- 以及其他基金...

### 配息資訊
- **配息基準日**: 2020-07-06
- **配息頻率**: M (月配)
- **配息年度**: 2020

---

## 🟢 5A1 可分配收益計算測試

### 測試案例 1：匯入 CSV 檔案

**步驟**
1. 開啟前端應用程式（http://localhost:5173）
2. 點擊「配息管理」標籤
3. 在「1. 匯入可分配收益 CSV 檔案」區塊：
   - 點擊「選擇檔案」
   - 選擇 `dividen_5a1_IT版JP 匯入 FAS.csv`
   - 點擊「匯入檔案」

**預期結果**
- 顯示匯入結果：
  - 新增：X 筆（X 為 CSV 中的資料筆數）
  - 更新：0 筆
  - 失敗：0 筆
- 無錯誤訊息
- 顯示明顯的成功/失敗指示器

### 測試案例 2：查詢已載入的配息資料

**測試 2.1：查詢所有配息資料**
1. 在「3. 查詢已載入的配息資料」區塊
2. 不填寫任何篩選條件
3. 點擊「查詢配息資料」

**預期結果**：顯示所有已載入的配息資料（約 55 筆）

**測試 2.2：依基金代號查詢**
1. 在「基金代號」欄位輸入：`D109`
2. 點擊「查詢配息資料」

**預期結果**：只顯示基金代號為 D109 的配息資料（1 筆）

**測試 2.3：依配息頻率查詢**
1. 在「配息頻率」下拉選單選擇：`月配 (M)`
2. 點擊「查詢配息資料」

**預期結果**：顯示所有月配的配息資料

**測試 2.4：依日期範圍查詢**
1. 在「開始日期」輸入：`2020-07-01`
2. 在「結束日期」輸入：`2020-07-31`
3. 點擊「查詢配息資料」

**預期結果**：顯示 2020 年 7 月的所有配息資料

**測試 2.5：組合查詢**
1. 在「基金代號」輸入：`D112`
2. 在「配息頻率」選擇：`月配 (M)`
3. 在「開始日期」輸入：`2020-07-01`
4. 點擊「查詢配息資料」

**預期結果**：顯示 D112 系列基金在 2020 年 7 月及之後的月配資料

### 測試案例 3：執行配息計算與確認（單筆）

**前置條件**
- 已匯入 CSV 檔案
- 資料庫中需要有對應的 NAV 和單位數資料

**步驟**
1. 在「2. 執行配息計算與確認」區塊
2. 輸入：
   - 基金代號：`D109`
   - 配息基準日：`2020-07-06`
   - 配息頻率：`月配 (M)`
3. 點擊「執行計算與確認」

**預期結果**
- 如果資料庫中有對應的 NAV 和單位數：
  - 顯示計算成功
  - 顯示 NAV、單位數、總可分配金額、配息率等資訊
- 如果沒有對應資料：
  - 顯示錯誤訊息：「此配息基準淨值尚未公告，不可進行確認作業！」或「基準日單位數為零或未找到」

### 測試案例 4：執行批量計算與確認（批量）

**測試 4.1：批量確認所有待處理項目**
1. 確保已匯入多筆 CSV 資料（STEP2_STATUS = 'C'）
2. 點擊「批量計算所有未確認項目」綠色按鈕（不需輸入基金代號）
3. 系統將自動找出所有狀態為 'C' 的項目進行計算

**預期結果**
- 顯示「批量計算結果」對話框或訊息
- 顯示總處理筆數、成功筆數、失敗筆數
- 顯示失敗項目的詳細原因

**測試 4.2：批量確認指定日期的待處理項目**
1. 輸入配息基準日：`2020-07-06`
2. 點擊「批量計算所有未確認項目」
3. 系統將僅計算該日期的未確認項目

### 測試案例 5：驗證資料完整性

**測試 5.1：驗證匯入的資料欄位**
1. 查詢任一基金（例如 D109）
2. 檢查以下欄位是否有值：
   - fundNo: D109
   - dividendDate: 2020-07-06
   - dividendType: M
   - div1: 2062749（當期-債息/利息收入）
   - divTot: 0（可分配總金額，CSV 中為 0）

**測試 5.2：驗證空值處理**
1. 查詢基金 D109
2. 確認 pre_div1_b 和 div1_b 欄位正確處理為 0（CSV 中為空）

### 測試案例 6：錯誤處理測試

**測試 6.1：查詢不存在的基金**
1. 在「基金代號」輸入：`XXXXX`
2. 點擊「查詢配息資料」

**預期結果**：顯示「查詢結果（共 0 筆）」，無錯誤訊息

**測試 6.2：查詢不存在的日期範圍**
1. 在「開始日期」輸入：`2025-01-01`
2. 在「結束日期」輸入：`2025-12-31`
3. 點擊「查詢配息資料」

**預期結果**：顯示「查詢結果（共 0 筆）」，無錯誤訊息

---

## 🔵 5A3 配息組成維護與上傳 EC 測試

### 測試案例 1：匯入配息組成 CSV

**準備工作**
- 準備一個包含 `FundNo`, `DividendDate`, `DividendType`, `InterestRate`, `CapitalRate` 的 CSV 檔案。

**API 測試指令**
```bash
curl -X POST "http://localhost:5137/api/Dividends/composition/import" \
  -H "Content-Type: multipart/form-data" \
  -F "file=@composition_test.csv"
```

**預期結果**
- 成功匯入
- 資料庫 `MDS.FUND_DIV` 表中的 `I_RATE` 和 `C_RATE` 欄位被更新
- `STEP4_STATUS` 更新為 'C' (待確認)

### 測試案例 2：上傳配息資料至 EC

**步驟**
1. 確保 5A1 計算已完成（STEP2_STATUS = 'O'）
2. 確保 5A3 組成已匯入（STEP4_STATUS = 'C'）
3. 呼叫上傳 API

**API 測試指令**
```bash
curl -X POST "http://localhost:5137/api/Dividends/D109/2020-07-06/M/upload-ec"
```

**預期結果**
- 回傳成功訊息 "上傳 EC 成功"
- `MDS.FUND_DIV` 表中狀態更新：
  - `STEP3_STATUS` = 'O' (單位配息上傳成功)
  - `STEP4_STATUS` = 'O' (配息組成上傳成功)

---

## ✅ 測試檢查清單總結

- [ ] (5A1) CSV 檔案成功匯入，無錯誤
- [ ] (5A1) 可以查詢所有配息資料
- [ ] (5A1) 可以依基金代號、配息頻率、日期範圍篩選
- [ ] (5A1) 查詢結果表格顯示正確
- [ ] (5A1) 單筆配息計算功能正常（需有 NAV 和單位數資料）
- [ ] (5A1) 批量配息計算功能正常
- [ ] (5A1) 錯誤處理正確
- [ ] (5A3) 配息組成 CSV 匯入成功
- [ ] (5A3) 配息資料上傳 EC 成功
