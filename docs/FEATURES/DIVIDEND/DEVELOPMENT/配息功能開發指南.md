# é…æ¯åŠŸèƒ½é–‹ç™¼æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡ä»¶èªªæ˜å¦‚ä½•å°‡ DMS5A åŸºé‡‘é…æ¯ç³»çµ±å¾ PowerBuilder + Oracle è½‰ç§»è‡³ .NET 8.0 + MS SQL Serverï¼Œä¸¦å»ºç«‹ React å‰ç«¯é é¢ã€‚

---

## ğŸ¯ é…æ¯æµç¨‹ç¸½è¦½

### äº”æ­¥é©Ÿé«˜éšæµç¨‹

| æ­¥é©Ÿ | ä½œæ¥­åç¨± | ä¸»è¦åŠŸèƒ½ | é—œéµè¼¸å‡º |
|------|---------|---------|---------|
| **Step 1** | mds1511 é…æ¯åƒæ•¸è¨­å®š | è¨­å®šåŸºé‡‘é…æ¯é †åºã€é »ç‡ã€è²»ç”¨æ‰£é™¤ã€æœ¬é‡‘åˆ†é…ç­‰åƒæ•¸ | é…æ¯è¦å‰‡è¨­å®šæª” |
| **Step 2** | mds1512 ç›®æ¨™é…æ¯ç‡è¨­å®š | è¨­å®šå„åŸºé‡‘ç›®æ¨™é…æ¯ç‡ï¼Œä½œç‚ºå¾ŒçºŒé…æ¯è¨ˆç®—åŸºæº– | ç›®æ¨™é…æ¯ç‡è¨­å®š |
| **Step 3** | dms5A1 å¯åˆ†é…é¤˜é¡ç¶­è­·ä½œæ¥­ | åŒ¯å…¥å¯åˆ†é…æ”¶ç›Šé‡‘é¡ï¼Œé€²è¡Œé…æ¯è¨ˆç®—èˆ‡åˆ†æ”¤ | é…æ¯é‡‘é¡èˆ‡åˆ†æ”¤çµæœ |
| **Step 4** | dms5A3 å¢ƒå…§é…æ¯çµ„æˆè³‡è¨Šä¸Šå‚³EC | å°‡é…æ¯çµ„æˆè³‡è¨Šä¸Šå‚³è‡³å®˜ç¶² | æœ¬é‡‘/åˆ©æ¯æ¯”ä¾‹å…¬å‘Š |
| **Step 5** | mds153 å¢ƒå…§é…æ¯è³‡è¨Šæ¦‚æ³ç¸½è¡¨è½‰å‡º | ç”¢ç”Ÿé…æ¯è³‡è¨Šæ¦‚æ³ç¸½è¡¨ä¾›å…§éƒ¨ç®¡ç†èˆ‡ç¨½æ ¸ | é…æ¯è³‡è¨Šç¸½è¡¨ |

---

## ğŸ“Š è³‡æ–™è¡¨çµæ§‹

### æ ¸å¿ƒé…æ¯è³‡æ–™è¡¨ï¼ˆMDS Schemaï¼‰

1. **MDS.FUND_DIV_SET** - é…æ¯åƒæ•¸è¨­å®šè¡¨
   - å„²å­˜é…æ¯åˆ†æ”¤é †åºã€æ˜¯å¦å¯é…æœ¬é‡‘ã€è²»ç”¨æ‰£é™¤ç­‰è¨­å®š

2. **MDS.FUND_DIV** - å¯åˆ†é…æ”¶ç›Šè¨ˆç®—èˆ‡æš«å­˜è¡¨
   - å„²å­˜åŒ¯å…¥çš„å¯åˆ†é…æ”¶ç›Šè³‡æ–™ã€è¨ˆç®—çµæœã€é…æ¯æ¯”ç‡

3. **MDS.FUND_DIV_OBJ** - ç›®æ¨™é…æ¯ç‡è¨­å®šè¡¨
   - å„²å­˜å„åŸºé‡‘çš„ç›®æ¨™é…æ¯ç‡æˆ–ç›®æ¨™é…æ¯é‡‘é¡

4. **MDS.FUND_DIVIDEND** - é…æ¯çµ„æˆè¡¨
   - å„²å­˜é…æ¯çµ„æˆè³‡è¨Šï¼ˆæœ¬é‡‘/åˆ©æ¯æ¯”ä¾‹ï¼‰

5. **MDS.FUND_DIV_EXEC_LOG** - åŸ·è¡Œæ—¥èªŒè¡¨
   - è¨˜éŒ„æ“ä½œèˆ‡æ‰¹æ¬¡åŸ·è¡Œæ—¥èªŒ

### è¼”åŠ©è³‡æ–™è¡¨

- **NAV.NAV** - åŸºé‡‘æ·¨å€¼è¡¨
- **FAS.FUND_LEDGE** - åŸºé‡‘ç¸½å–®ä½æ•¸è¡¨
- **FAS.FUND** - åŸºé‡‘åŸºæœ¬è³‡æ–™è¡¨

---

## ğŸ”§ Step 1: é…æ¯åƒæ•¸è¨­å®šï¼ˆmds1511ï¼‰

### åŠŸèƒ½èªªæ˜

è¨­å®šå„åŸºé‡‘é…æ¯æ™‚çš„æ”¶ç›Šåˆ†æ”¤é †åºã€å¯å¦åˆ†é…æœ¬é‡‘ã€è²»ç”¨æ‰£é™¤ç­‰è¦å‰‡ã€‚

### ä¸»è¦æ¬„ä½

| æ¬„ä½åç¨± | èªªæ˜ | å‹åˆ¥ |
|---------|------|------|
| fund_no | åŸºé‡‘ä»£ç¢¼ | NVARCHAR(20) |
| div_type | é…æ¯é »ç‡ | CHAR(1) (M/Q/S/Y) |
| item01_seq ~ item10_seq | åˆ†æ”¤é †åºï¼ˆ1-10ï¼‰ | INT |
| fee_type | æ˜¯å¦æœ‰è²»ç”¨æ‰£é™¤ | CHAR(1) (Y/N) |
| capital_type | æ˜¯å¦å…è¨±åˆ†é…æœ¬é‡‘ | CHAR(1) (Y/N) |

### æ¥­å‹™è¦å‰‡

1. **åˆ†æ”¤é †åº**ï¼šä¾ `item01_seq` ~ `item10_seq` çš„æ•¸å­—éå¢æ±ºå®šå…ˆå¾Œ
2. **è²»ç”¨æ‰£é™¤**ï¼šè‹¥ `fee_type=Y`ï¼Œé…æ¯å‰é ˆå…ˆæ‰£é™¤è²»ç”¨ï¼ˆç›®å‰è²»ç”¨ç‚º 0ï¼‰
3. **æœ¬é‡‘åˆ†é…**ï¼šè‹¥ `capital_type=Y`ï¼Œæ”¶ç›Šä¸è¶³å¯ç”±æœ¬é‡‘è£œè¶³

### .NET å¯¦ä½œè¦åŠƒ

**Entity**ï¼š
```csharp
// DmsSystem.Domain/Entities/FundDivSet.cs
public class FundDivSet
{
    public string FundNo { get; set; }
    public char DivType { get; set; } // M/Q/S/Y
    public int Item01Seq { get; set; }
    // ... item02_seq ~ item10_seq
    public char FeeType { get; set; } // Y/N
    public char CapitalType { get; set; } // Y/N
}
```

**Repository**ï¼š
```csharp
// DmsSystem.Application/Interfaces/IFundDivSetRepository.cs
public interface IFundDivSetRepository
{
    Task<FundDivSet?> GetByFundNoAndDivTypeAsync(string fundNo, char divType);
    Task CreateAsync(FundDivSet fundDivSet);
    Task UpdateAsync(FundDivSet fundDivSet);
}
```

**Service**ï¼š
```csharp
// DmsSystem.Application/Services/FundDivSetService.cs
public interface IFundDivSetService
{
    Task<FundDivSetDto> GetSettingsAsync(string fundNo, char divType);
    Task CreateOrUpdateSettingsAsync(FundDivSetDto dto);
}
```

**Controller**ï¼š
```csharp
// DmsSystem.Api/Controllers/FundDivSetController.cs
[ApiController]
[Route("api/[controller]")]
public class FundDivSetController : ControllerBase
{
    [HttpGet("{fundNo}/{divType}")]
    public async Task<IActionResult> GetSettings(string fundNo, char divType);
    
    [HttpPost]
    public async Task<IActionResult> CreateOrUpdate([FromBody] FundDivSetDto dto);
}
```

---

## ğŸ¯ Step 2: ç›®æ¨™é…æ¯ç‡è¨­å®šï¼ˆmds1512ï¼‰

### åŠŸèƒ½èªªæ˜

è¨­å®šå„åŸºé‡‘ç›®æ¨™é…æ¯ç‡ï¼Œä½œç‚ºå¾ŒçºŒé…æ¯è¨ˆç®—çš„åŸºæº–ã€‚

### ä¸»è¦æ¬„ä½

| æ¬„ä½åç¨± | èªªæ˜ | å‹åˆ¥ |
|---------|------|------|
| fund_no | åŸºé‡‘ä»£ç¢¼ | NVARCHAR(20) |
| div_type | é…æ¯é »ç‡ | CHAR(1) |
| div_obj | ç›®æ¨™é…æ¯ç‡ï¼ˆå¹´åŒ–ï¼‰ | DECIMAL(18,6) |
| div_obj_amt | ç›®æ¨™é…æ¯é‡‘é¡ï¼ˆæ¯å–®ä½ï¼‰ | DECIMAL(18,6) |
| tx_date | ç”Ÿæ•ˆæ—¥æœŸ | DATE |

### æ¥­å‹™è¦å‰‡

1. **å„ªå…ˆé †åº**ï¼šè‹¥åŒæ™‚æœ‰ `div_obj_amt` å’Œ `div_obj`ï¼Œå„ªå…ˆæ¡ç”¨ `div_obj_amt`
2. **ç”Ÿæ•ˆæ—¥æœŸæ§ç®¡**ï¼šä»¥é…æ¯åŸºæº–æ—¥å‘å‰å›æº¯æœ€è¿‘ä¸€ç­†ä¸è¶…éåŸºæº–æ—¥çš„è¨­å®š
3. **åæ¨è¨ˆç®—**ï¼šè‹¥è¨­å®š `div_obj_amt`ï¼Œç³»çµ±æœƒè‡ªå‹•è¨ˆç®—å°æ‡‰çš„ `div_obj`

### .NET å¯¦ä½œè¦åŠƒ

**Entity**ï¼š
```csharp
// DmsSystem.Domain/Entities/FundDivObj.cs
public class FundDivObj
{
    public string FundNo { get; set; }
    public char DivType { get; set; }
    public decimal? DivObj { get; set; } // å¹´åŒ–é…æ¯ç‡
    public decimal? DivObjAmt { get; set; } // æ¯å–®ä½ç›®æ¨™é…æ¯é‡‘é¡
    public DateTime TxDate { get; set; } // ç”Ÿæ•ˆæ—¥æœŸ
}
```

**Service**ï¼š
```csharp
// DmsSystem.Application/Services/FundDivObjService.cs
public interface IFundDivObjService
{
    Task<FundDivObjDto?> GetEffectiveTargetAsync(string fundNo, char divType, DateTime dividendDate);
    Task CreateOrUpdateTargetAsync(FundDivObjDto dto);
}
```

---

## ğŸ“¥ Step 3: å¯åˆ†é…é¤˜é¡ç¶­è­·ä½œæ¥­ï¼ˆdms5A1ï¼‰

### åŠŸèƒ½èªªæ˜

åŒ¯å…¥å¯åˆ†é…æ”¶ç›Šè³‡æ–™ï¼ˆCSVï¼‰ï¼Œé€²è¡Œé…æ¯è¨ˆç®—èˆ‡åˆ†æ”¤ã€‚

### CSV æª”æ¡ˆæ ¼å¼

**å¿…è¦æ¬„ä½**ï¼ˆä¾åºç‚ºç¬¬1~18æ¬„ï¼‰ï¼š
```
fund_master_no, fund_no, dividend_date, dividend_type,
pre_div1, pre_div2, pre_div3, pre_div4, pre_div5,
div1, div2, div3, div4, div5,
pre_div1_b, div1_b,
fee, div_tot
```

### è¨ˆç®—é‚è¼¯

#### 1. åŸºæœ¬è¨ˆç®—

```csharp
// ç•¶æœŸæ”¶ç›Š
decimal periodIncome = div1 + div2 + div3 + div4 + div5;

// æœŸåˆæ”¶ç›Š
decimal beginIncome = pre_div1 + pre_div2 + pre_div3 + pre_div4 + pre_div5;

// æ·¨æ”¶ç›Š
decimal netIncome = periodIncome + beginIncome - fee;

// æ¯å–®ä½å¯åˆ†é…æ”¶ç›Š
decimal divRate = netIncome / units;
```

#### 2. ç›®æ¨™é…æ¯é‡‘é¡è¨ˆç®—

```csharp
// é »ç‡ä¿‚æ•¸
int freqFactor = divType switch
{
    'M' => 12,  // æœˆé…
    'Q' => 4,   // å­£é…
    'S' => 2,   // åŠå¹´é…
    'Y' => 1,   // å¹´é…
    _ => 1
};

// ç›®æ¨™é…æ¯é‡‘é¡
decimal divRateObj;
if (divObjAmt > 0)
{
    // å„ªå…ˆæ¡ç”¨æ¯å–®ä½ç›®æ¨™é‡‘é¡
    divRateObj = divObjAmt;
    // åæ¨å¹´åŒ–é…æ¯ç‡
    divObj = Math.Floor(divObjAmt / nav * freqFactor * 1000000) / 1000000;
}
else if (divObj > 0)
{
    // ä½¿ç”¨å¹´åŒ–é…æ¯ç‡æ›ç®—
    divRateObj = divObj / freqFactor * nav;
}
else
{
    // ä½¿ç”¨å¯¦éš›å¯åˆ†é…æ”¶ç›Šæ¨ä¼°
    divRateObj = divRate;
}
```

#### 3. æœ¬é‡‘è£œè¶³åˆ¤æ–·

```csharp
if (divRate < divRateObj)
{
    if (capitalType == 'Y')
    {
        // å…è¨±æœ¬é‡‘è£œè¶³
        decimal capitalRate = divRateObj - divRate;
        // æœ¬é‡‘è£œè¶³é‡‘é¡
        decimal capitalAmount = capitalRate * units;
    }
    else
    {
        // ä¸å¯é…æœ¬é‡‘ï¼Œä¸‹ä¿®è‡³å¯åˆ†é…é‡‘é¡
        divRateObj = divRate;
    }
}
```

#### 4. æ”¶ç›Šåˆ†æ”¤è¨ˆç®—

ä¾ `item01_seq` ~ `item10_seq` çš„é †åºï¼Œå°‡é…æ¯é‡‘é¡åˆ†æ”¤è‡³å„æ”¶ç›Šé …ç›®ã€‚

### .NET å¯¦ä½œè¦åŠƒ

**Entity**ï¼š
```csharp
// DmsSystem.Domain/Entities/FundDiv.cs
public class FundDiv
{
    public string FundMasterNo { get; set; }
    public string FundNo { get; set; }
    public DateTime DividendDate { get; set; }
    public char DividendType { get; set; }
    
    // æœŸåˆæ”¶ç›Š
    public decimal PreDiv1 { get; set; }
    // ... PreDiv2 ~ PreDiv5
    
    // ç•¶æœŸæ”¶ç›Š
    public decimal Div1 { get; set; }
    // ... Div2 ~ Div5
    
    // è²»ç”¨
    public decimal Fee { get; set; }
    
    // è¨ˆç®—çµæœ
    public decimal DivRate { get; set; } // æ¯å–®ä½å¯åˆ†é…æ”¶ç›Š
    public decimal DivRateObj { get; set; } // æ¯å–®ä½ç›®æ¨™é…æ¯é‡‘é¡
    public decimal CapitalRate { get; set; } // æœ¬é‡‘é…æ¯æ¯”ç‡
    
    // ç‹€æ…‹
    public char Step2Status { get; set; } // C=å¾…ç¢ºèª, Y=å·²ç¢ºèª
}
```

**File Parser**ï¼š
```csharp
// DmsSystem.Infrastructure/FileParsing/FundDivCsvParser.cs
public class FundDivCsvParser : IFileParser<FundDivCsvRecord>
{
    public Task<List<FundDivCsvRecord>> ParseAsync(Stream stream);
}
```

**Service**ï¼š
```csharp
// DmsSystem.Application/Services/FundDivService.cs
public interface IFundDivService
{
    Task<UploadResult> UploadAndCalculateAsync(Stream fileStream);
    Task<FundDivDto> GetByFundNoAndDateAsync(string fundNo, DateTime dividendDate);
    Task ConfirmAsync(string fundNo, DateTime dividendDate);
}
```

**Controller**ï¼š
```csharp
// DmsSystem.Api/Controllers/FundDivController.cs
[ApiController]
[Route("api/[controller]")]
public class FundDivController : ControllerBase
{
    [HttpPost("upload")]
    public async Task<IActionResult> Upload([FromForm] IFormFile file);
    
    [HttpGet("{fundNo}/{dividendDate}")]
    public async Task<IActionResult> Get(string fundNo, DateTime dividendDate);
    
    [HttpPost("confirm")]
    public async Task<IActionResult> Confirm([FromBody] ConfirmRequest request);
}
```

---

## ğŸ¨ å‰ç«¯é é¢è¦åŠƒ

### 1. é…æ¯åƒæ•¸è¨­å®šé é¢

**è·¯ç”±**ï¼š`/dividend/settings`

**åŠŸèƒ½**ï¼š
- æŸ¥è©¢ç¾æœ‰è¨­å®š
- æ–°å¢/ç·¨è¼¯é…æ¯åƒæ•¸
- è¨­å®šåˆ†æ”¤é †åºï¼ˆæ‹–æ›³æ’åºï¼‰
- è¨­å®šæ˜¯å¦å¯é…æœ¬é‡‘ã€è²»ç”¨æ‰£é™¤

**å…ƒä»¶**ï¼š
```typescript
// react-client/src/pages/DividendSettings.tsx
export function DividendSettings() {
  // æŸ¥è©¢ã€æ–°å¢ã€ç·¨è¼¯é…æ¯åƒæ•¸
}
```

### 2. ç›®æ¨™é…æ¯ç‡è¨­å®šé é¢

**è·¯ç”±**ï¼š`/dividend/targets`

**åŠŸèƒ½**ï¼š
- æŸ¥è©¢ç¾æœ‰ç›®æ¨™é…æ¯ç‡
- æ–°å¢/ç·¨è¼¯ç›®æ¨™é…æ¯ç‡
- é¡¯ç¤ºç”Ÿæ•ˆæ—¥æœŸç¯„åœ

### 3. å¯åˆ†é…é¤˜é¡ç¶­è­·é é¢

**è·¯ç”±**ï¼š`/dividend/maintenance`

**åŠŸèƒ½**ï¼š
- CSV æª”æ¡ˆä¸Šå‚³
- é¡¯ç¤ºåŒ¯å…¥çµæœ
- é¡¯ç¤ºè¨ˆç®—çµæœï¼ˆé…æ¯é‡‘é¡ã€åˆ†æ”¤æ˜ç´°ï¼‰
- ç¢ºèªé…æ¯ï¼ˆè®Šæ›´ç‹€æ…‹ï¼‰

**å…ƒä»¶**ï¼š
```typescript
// react-client/src/pages/DividendMaintenance.tsx
export function DividendMaintenance() {
  // æª”æ¡ˆä¸Šå‚³
  // è¨ˆç®—çµæœé¡¯ç¤º
  // ç¢ºèªæŒ‰éˆ•
}
```

### 4. é…æ¯çµ„æˆè³‡è¨Šé é¢

**è·¯ç”±**ï¼š`/dividend/composition`

**åŠŸèƒ½**ï¼š
- æŸ¥è©¢é…æ¯çµ„æˆè³‡è¨Š
- ä¸Šå‚³è‡³ ECï¼ˆå®˜ç¶²ï¼‰

---

## ğŸ“ é–‹ç™¼é †åºå»ºè­°

### Phase 1: åŸºç¤æ¶æ§‹
1. å»ºç«‹ Entityï¼ˆFundDivSet, FundDivObj, FundDivï¼‰
2. å»ºç«‹ Repository ä»‹é¢èˆ‡å¯¦ä½œ
3. å»ºç«‹è³‡æ–™è¡¨ï¼ˆMS SQL Serverï¼‰

### Phase 2: Step 1 & Step 2
1. å¯¦ä½œé…æ¯åƒæ•¸è¨­å®š API
2. å¯¦ä½œç›®æ¨™é…æ¯ç‡è¨­å®š API
3. å»ºç«‹å‰ç«¯è¨­å®šé é¢

### Phase 3: Step 3 æ ¸å¿ƒåŠŸèƒ½
1. å¯¦ä½œ CSV æª”æ¡ˆè§£æå™¨
2. å¯¦ä½œé…æ¯è¨ˆç®—é‚è¼¯
3. å¯¦ä½œæ”¶ç›Šåˆ†æ”¤é‚è¼¯
4. å»ºç«‹å‰ç«¯ç¶­è­·é é¢

### Phase 4: Step 4 & Step 5
1. å¯¦ä½œé…æ¯çµ„æˆè³‡è¨Šä¸Šå‚³
2. å¯¦ä½œé…æ¯è³‡è¨Šç¸½è¡¨è½‰å‡º

---

## ğŸ” åƒè€ƒæ–‡ä»¶

- **BRD**ï¼š`../é…æ¯ç›¸é—œæ–‡ä»¶/BRD_åŸºé‡‘é…æ¯æµç¨‹_v1.md`
- **æ¥­å‹™é‚è¼¯**ï¼š`../é…æ¯ç›¸é—œæ–‡ä»¶/é…æ¯æ¥­å‹™é‚è¼¯èªªæ˜ ver1.md`
- **è³‡æ–™è¡¨æ¸…å–®**ï¼š`../é…æ¯ç›¸é—œæ–‡ä»¶/DMS5A_ç›¸é—œè³‡æ–™è¡¨æ¸…å–®.md`
- **è½‰ç§»æ–‡ä»¶**ï¼š`../é…æ¯ç›¸é—œæ–‡ä»¶/åŸºé‡‘é…æ¯ç³»çµ±è½‰ç§»RDæ–‡ä»¶.md`

---

## âš ï¸ æ³¨æ„äº‹é …

1. **è³‡æ–™å‹åˆ¥è½‰æ›**ï¼šOracle â†’ MS SQL Server
   - NUMBER â†’ DECIMAL(18,6)
   - VARCHAR2 â†’ NVARCHAR
   - DATE â†’ DATETIME2

2. **æ—¥æœŸè¨ˆç®—**ï¼šéœ€å¯¦ä½œç‡Ÿæ¥­æ—¥è¨ˆç®—é‚è¼¯ï¼ˆä½¿ç”¨ `f_relative_date2` å‡½æ•¸ï¼‰

3. **ç²¾åº¦æ§åˆ¶**ï¼šé…æ¯è¨ˆç®—æ¶‰åŠé‡‘é¡ï¼Œéœ€æ³¨æ„å°æ•¸é»ç²¾åº¦

4. **ç‹€æ…‹æ§ç®¡**ï¼šStep 2 ç‹€æ…‹ï¼ˆC=å¾…ç¢ºèª, Y=å·²ç¢ºèªï¼‰éœ€æ­£ç¢ºæ§ç®¡

---

**é–‹å§‹é–‹ç™¼å‰ï¼Œè«‹å…ˆé–±è®€æ‰€æœ‰é…æ¯ç›¸é—œæ–‡ä»¶ï¼Œç¢ºèªæ¥­å‹™é‚è¼¯ç†è§£æ­£ç¢ºã€‚**

