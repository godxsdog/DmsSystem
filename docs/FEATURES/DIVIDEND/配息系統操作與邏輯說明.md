# 配息系統操作與邏輯說明文件

本文件詳細說明 DmsSystem 配息模組的操作流程、計算邏輯及資料流向，供使用者與開發者參考。

## 1. 系統概述

配息模組（5A1）主要功能為匯入基金可分配收益（CSV），根據基金淨值（NAV）、單位數（Unit）及配息參數設定，計算每單位配息金額、年化配息率及本金分配比例，並將結果儲存至 `MDS.FUND_DIV` 資料表。

---

## 2. 操作流程与验证

### 步驟 1：匯入可分配收益 CSV

1.  **操作**：
    - 進入「配息管理」頁面。
    - 在「1. 匯入可分配收益 CSV 檔案」區塊，點擊「選擇檔案」並選擇 `.csv` 檔案（需為 Big5 編碼）。
    - 點擊「匯入檔案」。

2.  **邏輯**：
    - 系統讀取 CSV，**跳過前 3 行說明文字**。
    - 讀取第 4 行標題列與後續資料列。
    - 將資料寫入 `MDS.FUND_DIV` 資料表：
        - 若該基金代號、日期、配息頻率已存在，則**更新 (UPDATE)** 數值。
        - 若不存在，則**新增 (INSERT)** 數值。
    - **此階段更新的欄位**：
        - `FUND_NO`, `DIVIDEND_YEAR`, `DIVIDEND_DATE`, `DIVIDEND_TYPE`
        - `NAV` (CSV 內的淨值)
        - `PRE_DIV1` ~ `PRE_DIV5`, `DIV1` ~ `DIV5`, `PRE_DIV1_B`, `DIV1_B`
        - `FEE` (費用)
        - `DIV_TOT` (CSV 內的總金額)

3.  **驗證**：
    - 網頁顯示「匯入成功！」，並列出新增/更新/失敗筆數。
    - **此時 Table 尚不會自動顯示新資料**，需進行步驟 3 查詢。

### 步驟 2：執行配息計算與確認

1.  **操作**：
    - 在「2. 執行配息計算與確認」區塊，輸入：
        - **基金代號**（如 `A001`）
        - **配息基準日**（如 `2024-01-01`）
        - **配息頻率**（M/Q/S/Y）
    - 點擊「執行計算與確認」。

2.  **邏輯**（核心計算）：
    - 系統會從資料庫撈取 `FUND_DIV`（剛匯入的資料）、`FUND_DIV_SET`（參數設定）、`FUND_DIV_OBJ`（目標配息率）。
    - 根據邏輯計算出 **每單位配息金額 (`DivRate`)**、**目標配息率 (`DivObjRate`)**、**本金分攤 (`CapitalRate`)** 以及 **各來源分攤比率**。
    - 將計算結果**寫回資料庫** (`UPDATE MDS.FUND_DIV`)。

3.  **驗證**：
    - 網頁下方「計算結果」區塊會顯示：
        - 基準日淨值 (NAV)
        - 基準日單位數
        - 總可分配金額 (`divTot`)
        - 每單位可分配收益 (`divRate`)
        - 每單位本金配息比率 (`capitalRate`)
    - 若顯示數值，代表計算成功並已寫入 DB。

### 步驟 3：查詢與驗證資料

1.  **操作**：
    - 在「3. 查詢已載入的配息資料」區塊。
    - 輸入篩選條件（如基金代號），點擊「查詢配息資料」。

2.  **邏輯**：
    - 系統查詢 `MDS.FUND_DIV` 資料表。
    - 回傳所有符合條件的紀錄。

3.  **驗證**：
    - **如何在 Table 看到更新成功？**
        - 在查詢結果表格中，檢查對應的「基金代號」與「配息基準日」列。
        - 確認 **NAV**、**單位數**、**總可分配金額**、**配息率** 欄位是否有值且正確。
        - 若「配息率」有值，代表步驟 2 計算已成功完成。

---

## 3. 詳細計算邏輯 (Step-by-Step)

以下是「執行計算與確認」按鈕背後的詳細邏輯，對應程式碼 `DividendService.ConfirmAsync`：

### 1. 準備資料
- **取得 NAV (`nav`)**：查詢 `NAV.NAV` 表（條件：基金代號 + 基準日）。
- **取得 單位數 (`unit`)**：查詢 `FAS.FUND_LEDGE` 表（條件：基金代號 + 基準日）。
    - *注意：若 NAV 或 Unit 為 0 或找不到，計算會終止並報錯。*
- **取得 匯入資料 (`fundDiv`)**：查詢 `MDS.FUND_DIV` 表（剛匯入的資料）。
- **取得 參數設定 (`divSet`)**：查詢 `MDS.FUND_DIV_SET` 表（分攤順序、本金分配設定 `CAPITAL_TYPE`）。
- **取得 目標配息率 (`divObj`)**：查詢 `MDS.FUND_DIV_OBJ` 表（取得最近一期的 `DIV_OBJ` 或 `DIV_OBJ_AMT`）。
- **取得 上期配息率 (`previousDiv`)**：查詢 `MDS.FUND_DIV` 表（上一期資料）。

### 2. 計算基本數值
- **總可分配金額 (`divTot`)**：
  $$ \text{divTot} = \sum(\text{PRE\_DIV1..5}) + \sum(\text{DIV1..5}) - \text{FEE} $$
  *(若結果 < 0 則為 0)*
  
- **每單位可分配收益 (`divRate`)**：
  $$ \text{divRate} = \text{divTot} / \text{unit} $$
  *(四捨五入至小數點後 6 位)*

- **年化配息率 (`rate`)**（僅供參考，不直接寫入）：
  依頻率換算：
  - 月配 (M): $\text{divRate} \times 12 / \text{nav}$
  - 季配 (Q): $\text{divRate} \times 4 / \text{nav}$
  - 半年 (S): $\text{divRate} \times 2 / \text{nav}$
  - 年配 (Y): $\text{divRate} / \text{nav}$

### 3. 計算目標配息金額 (`divRateObj`)
系統根據設定的目標是「金額」還是「比率」來決定：
- **若設定固定金額 (`DIV_OBJ_AMT > 0`)**：
  - `divRateObj` (每單位配息金額) = `DIV_OBJ_AMT`
  - 反推年化率 `divObjRate`。
- **若設定目標比率 (`DIV_OBJ`)**：
  - 根據年化率反推每單位金額：
  - 例如月配：`temp = divObjRate / 12 * nav`
  - `divRateObj` = `temp` (無條件捨去至小數第 6 位)

### 4. 計算本金補足 (`capitalRate`)
判斷是否需要動用本金來滿足目標配息金额。

1. **初步比較**：
   若 **目標金額 (`divRateObj`) > 可分配收益 (`divRate`)**：
   - 若 `CAPITAL_TYPE == 'N'` (不可配本金)：
     - 強制調降目標：`divRateObj = divRate`
   - 若 `CAPITAL_TYPE == 'Y'` (可配本金)：
     - `capitalRate` (本金) = `divRateObj - divRate`

2. **扣除費用後檢核**：
   - 計算扣費後可用金額：`availableAfterFee = max(0, divRate - feeRate)`
   - 若 `availableAfterFee < divRateObj`：
     - 若 `CAPITAL_TYPE == 'Y'`：`capitalRate += (divRateObj - availableAfterFee)`
     - 若 `CAPITAL_TYPE == 'N'`：目標下修 `divRateObj = availableAfterFee`，`capitalRate = 0`

### 5. 收益分攤計算
根據 `MDS.FUND_DIV_SET` 設定的 10 個項目順序 (`ITEM01_SEQ` ~ `ITEM10_SEQ`)，依序分配收益來源。

- **來源**：`PRE_DIV1`~`5`, `DIV1`~`5`。
- **邏輯**：
  - 依照順序 1 到 10，將對應來源的金額換算成每單位金額 (`rateCal[i]`)。
  - 累加 `divRateTot` (初始為 `capitalRate`)。
  - 若累加後超過目標 `divRateObj`，則該項目僅分配差額，後續項目設為 0。
  - 若最後總和仍不足目標且可配本金，則增加 `capitalRate` 補足。

### 6. 更新資料庫
最後執行 SQL 更新 `MDS.FUND_DIV`：
- **更新欄位**：
  - `NAV`, `UNIT` (使用系統查詢值)
  - `DIV_TOT` (計算值)
  - `DIV_RATE` (計算值)
  - `DIV_RATE_M` (目標配息金額 `divRateObj`)
  - `CAPITAL_RATE` (本金 `capitalRate`)
  - `DIV_OBJ` (目標年化率 `divObjRate`)
  - 各項分攤比率 (`PRE_DIV1_RATE`...`DIV5_RATE` 等)

---

## 4. 資料庫欄位對照表 (MDS.FUND_DIV)

| 欄位名稱 | 說明 | 來源/計算方式 |
| :--- | :--- | :--- |
| **FUND_NO** | 基金代號 | CSV / 輸入 |
| **DIVIDEND_DATE** | 配息基準日 | CSV / 輸入 |
| **NAV** | 淨值 | CSV 匯入初始值，計算後更新為系統值 |
| **UNIT** | 單位數 | 計算時從 `FAS.FUND_LEDGE` 取得 |
| **DIV_TOT** | 總可分配金額 | `Sum(PreDiv) + Sum(Div) - Fee` |
| **DIV_RATE** | 每單位可分配收益 | `DIV_TOT / UNIT` |
| **DIV_RATE_M** | **每單位實際配息金額** | 計算後的目標金額 (含本金) |
| **CAPITAL_RATE** | 每單位本金配息 | 若收益不足目標時補足的金額 |
| **DIV_OBJ** | 目標年化配息率 | 來自 `FUND_DIV_OBJ` 或反推 |
| **I_RATE** | 收益分配比率 | 5A3 匯入 (對應 `INTEREST_DIVIDEND`) |
| **C_RATE** | 本金分配比率 | 5A3 匯入 (對應 `PRINCIPAL_DIVIDEND`) |
| **STEP2_STATUS** | 5A1 確認狀態 | 'C'=未確認, 'O'=已確認 |
| **STEP4_STATUS** | 5A3 上傳狀態 | 'C'=未上傳, 'O'=已上傳 |---

## 5. 配息組成維護與上傳 EC (5A3)

此功能用於維護配息的組成比例（收益分配率與本金分配率），並將結果上傳至 EC 官網（WPS 系統）。

### 步驟 1：匯入配息組成檔案 (CSV)

1.  **操作**：
    - 進入「配息管理」>「上傳 EC 官網」頁籤。
    - 在「1. 匯入配息組成檔案 (CSV)」區塊，上傳包含 `interest_rate` 與 `capital_rate` 的 CSV 檔案。
    - 點擊「匯入組成檔案」。2.  **邏輯**：
    - 系統讀取 CSV，自動偵測並跳過中文標頭行（若存在），讀取英文標頭。
    - **前置條件**：該基金與日期的配息資料（5A1）必須已存在於 `MDS.FUND_DIV` 中。若不存在，匯入將失敗（提示「找不到對應記錄」）。
    - **更新邏輯**：
        - 僅更新狀態為 **未確認 (`STEP4_STATUS = 'C'`)** 或 **無狀態 (NULL)** 的記錄。
        - 若記錄已確認上傳 (`STEP4_STATUS = 'O'`)，則不會更新，避免覆蓋已發布資料。
    - **更新欄位**：
        - `I_RATE` (收益分配比率)
        - `C_RATE` (本金分配比率)
        - `STEP4_STATUS` = 'C'
        - `STEP4_CRE_TIME` = 當前時間

### 步驟 2：查詢與確認

1.  **操作**：
    - 在「2. 上傳 EC 官網」區塊，輸入查詢條件（基金代號、配息基準日）。
    - 點擊「查詢配息資料」。
    - 點擊「查詢匯入資料」可直接篩選剛剛匯入的項目。2.  **檢視**：
    - 表格顯示各基金的「本金比率」、「收益比率」。
    - 「配息狀態」對應 5A1 (`STEP3_STATUS`)。
    - 「組成狀態」對應 5A3 (`STEP4_STATUS`)，未上傳前應為「未上傳」(C)。

### 步驟 3：批量上傳 EC

1.  **操作**：
    - 勾選要上傳的項目（可多選）。
    - 點擊「上傳選取項目至 EC」。

2.  **邏輯**：
    - 系統執行雙重更新：
        1.  **本地狀態更新**：
            - 更新 `MDS.FUND_DIV` 表。
            - 設定 `STEP3_STATUS = 'O'` (單位配息確認)。
            - 設定 `STEP4_STATUS = 'O'` (配息組成確認)。
            - 更新確認時間 (`STEP3_COF_TIME`, `STEP4_COF_TIME`)。
        2.  **WPS 資料寫入** (模擬 PB 行為)：
            - 使用 `MERGE` 語句寫入 `WPS.FUND_DIVIDEND` 表。
            - 若資料已存在則 **更新 (UPDATE)** `INTEREST_DIVIDEND`, `PRINCIPAL_DIVIDEND`, `LAST_MODIFIED`。
            - 若資料不存在則 **新增 (INSERT)** 完整配息紀錄。
            - 欄位對照：
                - `UNIT_DIVIDEND_RATE` <- `DIV_RATE`
                - `MONTH_DIVIDEND_RATE` <- `DIV_RATE_M`
                - `YEAR_DIVIDEND_RATE` <- `DIV_RATE_O`
                - `INTEREST_DIVIDEND` <- `I_RATE`
                - `PRINCIPAL_DIVIDEND` <- `C_RATE`

3.  **驗證**：
    - 上傳成功後，表格中的「配息狀態」與「組成狀態」應變更為「已上傳」(綠色)。
