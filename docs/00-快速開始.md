# Windows 環境快速開始指南

## 🚀 5 分鐘快速啟動

### 前置需求

- Windows 作業系統
- Visual Studio 2022
- .NET 8.0 SDK
- 正式區 SQL Server 連接權限

### 1. 取得程式碼

```powershell
git clone <repository-url>
cd DmsSystem
```

### 2. 還原套件

**在 Visual Studio 2022：**
1. 開啟 `DMS.sln`
2. 右鍵點擊方案 → 「還原 NuGet 套件」

**或使用命令列：**
```powershell
dotnet restore
```

### 3. 設定資料庫連接

編輯 `DmsSystem.Api/appsettings.Production.json`，設定正式區 SQL Server 連接字串。

**詳細說明**：請參考 [資料庫配置指南](./03-資料庫配置.md)

### 4. 啟動系統

**使用 Visual Studio 2022（推薦）：**
1. 開啟 `DMS.sln`
2. 設定啟動專案為 `DmsSystem.Api`
3. 設定環境為 `Production`
4. 按 `F5` 啟動
5. API 將在 http://localhost:5137 啟動

**或使用命令列：**
```powershell
cd DmsSystem.Api
$env:ASPNETCORE_ENVIRONMENT="Production"
dotnet run
```

### 5. 啟動前端（可選）

```powershell
cd react-client
npm install  # 僅首次需要
npm run dev
```

前端將在 http://localhost:5173 啟動

### 6. 查看結果

- **前端應用**：訪問 http://localhost:5173
- **API 文檔（Swagger）**：訪問 http://localhost:5137/swagger（注意：目前 Swagger 已停用）

---

## 📝 詳細說明

- **完整環境設定**：請參考下方「完整環境設定」章節
- **資料庫配置**：[資料庫配置指南](./03-資料庫配置.md)
- **系統架構**：[架構指南](./01-架構指南.md)
- **Git 版本控制**：[Git 版本控制指南](#git-版本控制)
- **執行與測試**：[測試指南](./04-測試指南.md)

---

## 🖥️ 完整環境設定

### 環境說明

- **作業系統**：Windows
- **開發工具**：Visual Studio 2022
- **資料庫**：正式 SQL Server（已建立）
- **用途**：正式環境執行、生產部署

### 首次設定檢查清單

- [ ] 已安裝 Visual Studio 2022
- [ ] 已安裝 .NET 8 SDK
- [ ] 已取得最新程式碼
- [ ] 已還原 NuGet 套件
- [ ] 已設定資料庫連接字串（參考 [資料庫配置指南](./03-資料庫配置.md)）
- [ ] 已測試資料庫連接

### 每次啟動檢查清單

- [ ] 確認 SQL Server 正在運行
- [ ] 確認連接字串正確
- [ ] 確認環境變數設定（如使用）
- [ ] 啟動 API 並檢查日誌
- [ ] 測試 API 可訪問

---

## ⚙️ 環境配置

### 資料庫連接字串設定

**詳細說明**：請參考 [資料庫配置指南](./03-資料庫配置.md)

### 前端配置（如果需要）

**位置**：`react-client/.env.production`

```
VITE_API_BASE_URL=http://正式API位址:5137
```

---

## 🔍 錯誤診斷與報告

### 產生錯誤報告（Windows）

建立批次檔 `generate-error-report.bat`：

```batch
@echo off
echo === DMS 系統錯誤報告 === > ERROR_REPORT.txt
echo 生成時間: %date% %time% >> ERROR_REPORT.txt
echo. >> ERROR_REPORT.txt

echo === 系統資訊 === >> ERROR_REPORT.txt
echo 作業系統: %OS% >> ERROR_REPORT.txt
ver >> ERROR_REPORT.txt
echo .NET 版本: >> ERROR_REPORT.txt
dotnet --version >> ERROR_REPORT.txt 2>&1
echo Node 版本: >> ERROR_REPORT.txt
node --version >> ERROR_REPORT.txt 2>&1
echo. >> ERROR_REPORT.txt

echo === API 建置狀態 === >> ERROR_REPORT.txt
cd DmsSystem.Api
dotnet build >> ..\ERROR_REPORT.txt 2>&1
cd .. >> ERROR_REPORT.txt
echo. >> ERROR_REPORT.txt

echo === 環境變數 === >> ERROR_REPORT.txt
echo ASPNETCORE_ENVIRONMENT: %ASPNETCORE_ENVIRONMENT% >> ERROR_REPORT.txt
echo ConnectionStrings__DefaultConnection: %ConnectionStrings__DefaultConnection% >> ERROR_REPORT.txt
echo. >> ERROR_REPORT.txt

echo === Git 狀態 === >> ERROR_REPORT.txt
git status --short >> ERROR_REPORT.txt
echo. >> ERROR_REPORT.txt

echo === 分支資訊 === >> ERROR_REPORT.txt
git branch --show-current >> ERROR_REPORT.txt
git log -1 --oneline >> ERROR_REPORT.txt

echo 錯誤報告已產生：ERROR_REPORT.txt
notepad ERROR_REPORT.txt
```

**使用方式**：
1. 雙擊執行 `generate-error-report.bat`
2. 將產生的 `ERROR_REPORT.txt` 內容複製
3. 提供給開發人員進行除錯

### 常見錯誤與解決

#### 錯誤 1：資料庫連接失敗

**錯誤訊息**：
```
A network-related or instance-specific error occurred while establishing a connection to SQL Server
```

**解決步驟**：
1. 確認 SQL Server 服務正在運行
2. 確認防火牆允許連接
3. 測試連接（參考 [資料庫配置指南](./03-資料庫配置.md)）
4. 檢查連接字串格式是否正確
5. 確認使用者帳號有足夠權限

#### 錯誤 2：找不到組件

**錯誤訊息**：
```
Could not load file or assembly
```

**解決步驟**：
```powershell
dotnet clean
dotnet restore
dotnet build
```

#### 錯誤 3：連接字串未設定

**錯誤訊息**：
```
資料庫連接字串未設定
```

**解決步驟**：
1. 確認 `appsettings.Production.json` 存在
2. 確認連接字串格式正確
3. 或使用環境變數設定

**詳細說明**：請參考 [資料庫配置指南](./03-資料庫配置.md)

---

## 🏗️ 建置與部署

### 建置專案

**在 Visual Studio 2022：**
1. 建置 → 重建方案（或按 `Ctrl+Shift+B`）

**或使用命令列：**
```powershell
dotnet build --configuration Release
```

### 發佈專案

**發佈為可執行檔：**
```powershell
cd DmsSystem.Api
dotnet publish -c Release -o ./publish
```

**發佈檔案位置**：`DmsSystem.Api/publish/`

### 部署到 IIS（可選）

1. 安裝 .NET 8.0 Hosting Bundle
2. 在 IIS 中建立應用程式集區（使用 .NET CLR 版本：無 Managed 程式碼）
3. 建立網站，指向發佈資料夾
4. 設定應用程式集區

---

## 🛠️ Visual Studio 2022 使用技巧

### 設定多個啟動專案

如果需要同時啟動 API 和多個專案：

1. 右鍵點擊方案 → 屬性
2. 選擇「多個啟動專案」
3. 設定各專案的動作

### 偵錯設定

1. 在 `launchSettings.json` 中設定環境變數
2. 使用「偵錯」→「視窗」→「輸出」查看日誌
3. 設定中斷點進行除錯

### 查看日誌

**應用程式日誌位置**：
- 檔案日誌：`logs/dms-YYYYMMDD.txt`（在專案目錄下）
- 輸出視窗：在 Visual Studio 的「輸出」視窗查看

---

## 🔄 Git 版本控制

### 取得最新程式碼

```powershell
# 切換到 main 分支
git checkout main

# 取得遠端最新變更
git pull origin main
```

### 還原 NuGet 套件

**在 Visual Studio 2022：**
1. 開啟 `DMS.sln`
2. 右鍵點擊方案 → 「還原 NuGet 套件」

**或使用命令列：**
```powershell
dotnet restore
```

### 重新建置專案

```powershell
dotnet clean
dotnet build
```

### 切換分支

```powershell
# 查看所有分支
git branch -a

# 切換到特定分支
git checkout <branch-name>

# 建立新分支
git checkout -b <new-branch-name>
```

### 提交變更

```powershell
# 查看變更狀態
git status

# 加入變更
git add -A
# 或加入特定檔案
git add <file-path>

# 提交變更（使用中文 commit message）
git commit -m "功能：描述變更內容"

# 推送到遠端
git push origin <branch-name>
```

### Commit 訊息規範

**格式**：
```
<type>: <subject>

<body>
```

**Type 類型**：
- `功能` - 新功能
- `修正` - 修復 bug
- `文件` - 文件變更
- `重構` - 重構程式碼
- `測試` - 測試相關
- `建置` - 建置或工具

**範例**：
```
功能：新增配息資料查詢 API

- 新增 GET /api/Dividends 端點
- 支援基金代號、配息頻率、日期範圍篩選
- 前端新增查詢 UI 和結果表格顯示
```

### 處理衝突

```powershell
# 1. 取得最新 main
git checkout main
git pull origin main

# 2. 切換回你的分支
git checkout feature/your-feature

# 3. 合併 main 到你的分支
git merge main

# 4. 解決衝突後
git add .
git commit -m "合併：解決與 main 的衝突"

# 5. 推送
git push
```

### 禁止事項

1. **不要直接推送到 main**：必須透過 Pull Request
2. **不要提交敏感資訊**：密碼、API Key 等
3. **不要強制推送 main**：會破壞歷史
4. **不要提交大型檔案**：使用 Git LFS 或外部儲存

---

## ⚠️ 重要提醒

1. **密碼安全**：正式環境的密碼請妥善保管，不要提交到 Git
2. **環境變數**：建議使用環境變數而非直接寫在設定檔中
3. **備份**：部署前請備份資料庫
4. **測試**：部署到正式環境前，請先在測試環境驗證
5. **此版本專為 Windows 環境設計**，連接正式區 SQL Server
6. **請確保您有正式區 SQL Server 的連接權限**
7. **資料庫連接字串必須正確設定才能啟動系統**

---

**如有問題，請產生錯誤報告並提供給開發人員。**
