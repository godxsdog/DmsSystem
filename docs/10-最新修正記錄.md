# 最新修正記錄

## 📅 修正日期
2024-12-08

## 🔧 配息功能修正

### 1. CsvHelper 配置修正

**問題**：`System.ArgumentNullException` - CsvHelper 在建立 `CsvConfiguration` 時因 `attributesType` 為 null 拋出例外。

**修正**：
- 使用單參數 `CsvConfiguration(CultureInfo.InvariantCulture)` 建構子
- 手動註冊 `DividendCsvMap` 實例，避免泛型方法觸發自動掃描
- 升級 CsvHelper 從 30.0.1 到 33.1.0，統一版本

**檔案**：`DmsSystem.Application/Services/DividendService.cs`

### 2. CSV 檔案格式處理

**問題**：CSV 檔案前 3 行是說明文字，第 4 行才是真正的欄位標題。

**修正**：
- 在讀取 CSV 前先跳過前 3 行說明文字
- 從第 4 行開始讀取真正的資料

**檔案**：`DmsSystem.Application/Services/DividendService.cs`

### 3. 空值欄位處理

**問題**：`CsvHelper.TypeConversion.TypeConverterException` - CSV 中的 `pre_div1_b` 和 `div1_b` 欄位可能為空字串，無法轉換為 `decimal`。

**修正**：
- 將 `PreDiv1B` 和 `Div1B` 改為可為 null 的 `decimal?`
- 在 `DividendCsvMap` 中將這兩個欄位標記為 `Optional()`
- 寫入資料庫時使用 `?? 0` 將 null 轉為 0

**檔案**：`DmsSystem.Application/Services/DividendService.cs`

### 4. SQL 欄位修正

**問題**：`Microsoft.Data.SqlClient.SqlException` - INSERT 語句中包含不存在的 `STATUS`、`STATUS_C`、`UPD_USER`、`UPD_DATE` 欄位。

**修正**：
- 從 INSERT 語句中移除不存在的欄位
- 在 `DmsDbContext` 中使用 `Ignore()` 忽略這些欄位

**檔案**：
- `DmsSystem.Application/Services/DividendService.cs`
- `DmsSystem.Infrastructure/Persistence/Contexts/DmsDbContext.cs`

### 5. 資料型別修正

**問題**：`System.InvalidCastException` - `DividendYear` 欄位在資料庫中是 `DECIMAL(4,0)`，但實體中定義為 `int?`。

**修正**：
- 將 `FundDiv.DividendYear` 從 `int?` 改為 `decimal?`
- 在 EF 配置中明確指定 `decimal(4,0)` 類型

**檔案**：
- `DmsSystem.Domain/Entities/FundDiv.cs`
- `DmsSystem.Infrastructure/Persistence/Contexts/DmsDbContext.cs`

### 6. 配息資料查詢功能

**新增功能**：
- 新增 `IFundDivRepository.GetAllAsync` 方法，支援篩選查詢
- 新增 `GET /api/Dividends` API 端點
- 前端新增配息資料查詢 UI，支援基金代號、配息頻率、日期範圍篩選
- 查詢結果以表格形式顯示

**檔案**：
- `DmsSystem.Application/Interfaces/IFundDivRepository.cs`
- `DmsSystem.Infrastructure/Persistence/Repositories/FundDivRepository.cs`
- `DmsSystem.Api/Controllers/DividendsController.cs`
- `react-client/src/pages/Dividend.tsx`

---

## 🏗️ 程式碼重構

### SQL 語句重構

**問題**：程式碼中直接包含大量 SQL 字串，影響程式碼整潔度和可讀性。

**修正**：
- 建立 `DividendSqlQueries` 類別存放所有配息相關 SQL 語句
- 將 `DividendService` 中的 SQL 字串常數移至 `DividendSqlQueries`
- 更新 `DividendService` 使用 SQL 資源類別中的常數

**檔案**：
- `DmsSystem.Infrastructure/Persistence/SqlQueries/DividendSqlQueries.cs`（新增）
- `DmsSystem.Application/Services/DividendService.cs`

**優勢**：
- 程式碼更整潔，業務邏輯與 SQL 分離
- SQL 語句集中管理，易於維護和修改
- 提升程式碼可讀性

---

## 🐛 錯誤處理改進

### 1. 前端錯誤處理

**問題**：匯入後沒有顯示成功或失敗訊息，或只顯示「Failed to fetch」通用錯誤。

**修正**：
- 改進錯誤訊息解析，正確處理後端 `GlobalExceptionHandlerMiddleware` 返回的錯誤格式
- 使用 `response.text()` 先取得回應內容再解析 JSON，更好處理錯誤
- 加入詳細的 console logging（API 回應狀態、內容）
- 新增明顯的成功/失敗指示器（綠色/紅色框）
- 當匯入成功但沒有新增/更新資料時顯示警告訊息

**檔案**：`react-client/src/pages/Dividend.tsx`

### 2. CORS 設定改進

**問題**：`System.UriFormatException` - CORS 設定中使用 `new Uri(origin)` 解析 origin，當 origin 格式無效時會拋出例外。

**修正**：
- 使用 `Uri.TryCreate` 安全解析 URI
- 開發環境允許所有 localhost port，解決 CORS 問題

**檔案**：`DmsSystem.Api/Program.cs`

---

## 📝 Commit Message 規範

**變更**：所有 commit message 改為中文，提升可讀性。

**格式範例**：
```
功能：新增配息資料查詢 API

- 新增 GET /api/Dividends 端點
- 支援基金代號、配息頻率、日期範圍篩選
- 前端新增查詢 UI 和結果表格顯示
```

**Type 類型**：
- `功能` - 新功能
- `修正` - 修復 bug
- `文件` - 文件變更
- `重構` - 重構程式碼
- `測試` - 測試相關
- `建置` - 建置或工具

---

## 📚 文件整合

### 文件結構優化

**變更**：
- 將 `WINDOWS-DEVELOPMENT/` 資料夾的內容整合到主要文件中
- `00-快速開始.md` 現在包含完整的 Windows 環境設定、Git 版本控制、錯誤診斷等
- `03-資料庫配置.md` 現在包含資料庫操作、備份、還原等
- `04-測試指南.md` 現在包含執行測試、配息功能測試等
- 刪除重複的 `WINDOWS-DEVELOPMENT/` 資料夾

**優勢**：
- 文件結構更清晰，減少重複
- 所有 Windows 環境相關內容集中在主要文件中
- 更容易找到需要的資訊

---

## ✅ 修正檢查清單

### 配息功能
- [x] CsvHelper 配置修正完成
- [x] CSV 檔案格式處理完成
- [x] 空值欄位處理完成
- [x] SQL 欄位修正完成
- [x] 資料型別修正完成
- [x] 配息資料查詢功能完成

### 程式碼重構
- [x] SQL 語句移至資源類別
- [x] 程式碼整潔度提升

### 錯誤處理
- [x] 前端錯誤處理改進
- [x] CORS 設定改進
- [x] 錯誤訊息顯示改進

### 文件
- [x] 文件整合完成
- [x] Commit message 改為中文
- [x] 測試案例文件完成

---

## 🔗 相關文件

- **配息功能測試案例**：[配息功能測試案例](./FEATURES/DIVIDEND/TEST_CASES.md)
- **快速開始**：[快速開始指南](./00-快速開始.md)
- **測試指南**：[測試指南](./04-測試指南.md)
- **資料庫配置**：[資料庫配置指南](./03-資料庫配置.md)

---

**所有修正已完成並推送到遠端倉庫。**
