# 資料庫遷移指南（Mac → Windows）

## 📋 概述

本指南說明如何將 Mac 開發環境（Docker SQL Server）的資料遷移到 Windows 正式環境（公司 SQL Server）。

## ⚠️ 重要提醒

- **備份優先**：遷移前務必備份 Mac 環境的資料庫
- **測試驗證**：遷移後務必驗證資料完整性
- **環境確認**：確認 Windows 環境的 SQL Server 已準備就緒

## 🔄 遷移流程

### 步驟 1：在 Mac 環境備份資料庫

```bash
# 進入專案目錄
cd /Users/kaichanghuang/Documents/Phoenix\ Code/DmsSystem

# 備份整個資料庫
docker exec dms-sqlserver /opt/mssql-tools/bin/sqlcmd \
  -S localhost \
  -U sa \
  -P 'DmsSystem@2024' \
  -Q "BACKUP DATABASE DMS TO DISK = '/var/opt/mssql/backup/DMS_backup.bak' WITH FORMAT"

# 將備份檔案複製到本機
docker cp dms-sqlserver:/var/opt/mssql/backup/DMS_backup.bak ./DMS_backup.bak
```

**或使用 SQL 腳本匯出資料：**

```bash
# 匯出所有資料表結構和資料
docker exec dms-sqlserver /opt/mssql-tools/bin/sqlcmd \
  -S localhost \
  -U sa \
  -P 'DmsSystem@2024' \
  -d DMS \
  -Q "SELECT * FROM RIS.SHMT_SOURCE1" \
  -s "," -W -h -1 > shmt_source1_export.csv
```

### 步驟 2：準備 Windows 環境

1. **確認 SQL Server 已安裝並運行**
2. **確認資料庫已建立**（如果尚未建立，執行初始化腳本）
3. **確認連接權限**（測試連接字串）

### 步驟 3：遷移資料

#### 方法 A：使用備份檔案還原（推薦）

```powershell
# 在 Windows 環境執行
# 1. 將備份檔案複製到 Windows 電腦

# 2. 使用 SQL Server Management Studio 還原
# 或使用 sqlcmd：
sqlcmd -S YOUR_SERVER -U YOUR_USER -P YOUR_PASSWORD `
  -Q "RESTORE DATABASE DMS FROM DISK = 'C:\path\to\DMS_backup.bak' WITH REPLACE"
```

#### 方法 B：使用 SQL 腳本遷移

1. **在 Mac 環境產生 SQL 腳本：**

```bash
# 產生資料表結構腳本
docker exec dms-sqlserver /opt/mssql-tools/bin/sqlcmd \
  -S localhost \
  -U sa \
  -P 'DmsSystem@2024' \
  -d DMS \
  -Q "SELECT * FROM INFORMATION_SCHEMA.TABLES" \
  -o tables_list.txt

# 產生資料匯出腳本（針對每個重要資料表）
docker exec dms-sqlserver /opt/mssql-tools/bin/sqlcmd \
  -S localhost \
  -U sa \
  -P 'DmsSystem@2024' \
  -d DMS \
  -Q "SELECT * FROM RIS.SHMT_SOURCE1 FOR JSON PATH" \
  -o shmt_source1_data.json
```

2. **在 Windows 環境執行 SQL 腳本：**

```powershell
# 使用 sqlcmd 執行腳本
sqlcmd -S YOUR_SERVER -U YOUR_USER -P YOUR_PASSWORD `
  -d DMS `
  -i migration_script.sql
```

#### 方法 C：使用 bcp 工具（大量資料）

```bash
# Mac 環境：匯出資料
docker exec dms-sqlserver /opt/mssql-tools/bin/bcp \
  RIS.SHMT_SOURCE1 out /tmp/shmt_source1.dat \
  -S localhost -U sa -P 'DmsSystem@2024' \
  -d DMS -c -t"," -r"\n"

docker cp dms-sqlserver:/tmp/shmt_source1.dat ./shmt_source1.dat
```

```powershell
# Windows 環境：匯入資料
bcp RIS.SHMT_SOURCE1 in C:\path\to\shmt_source1.dat `
  -S YOUR_SERVER -U YOUR_USER -P YOUR_PASSWORD `
  -d DMS -c -t"," -r"\n"
```

### 步驟 4：驗證資料遷移

#### 檢查資料筆數

```powershell
# 在 Windows 環境執行
sqlcmd -S YOUR_SERVER -U YOUR_USER -P YOUR_PASSWORD `
  -d DMS `
  -Q "SELECT COUNT(*) FROM RIS.SHMT_SOURCE1"
```

**與 Mac 環境比較：**

```bash
# Mac 環境
docker exec dms-sqlserver /opt/mssql-tools/bin/sqlcmd \
  -S localhost \
  -U sa \
  -P 'DmsSystem@2024' \
  -d DMS \
  -Q "SELECT COUNT(*) FROM RIS.SHMT_SOURCE1"
```

#### 檢查重要資料表

```powershell
# 檢查所有重要資料表
$tables = @(
    "RIS.SHMT_SOURCE1",
    "RIS.SHMT_SOURCE4",
    "DMS.STOCK_BALANCE",
    "DMS.CONTRACT"
)

foreach ($table in $tables) {
    Write-Host "檢查 $table..."
    sqlcmd -S YOUR_SERVER -U YOUR_USER -P YOUR_PASSWORD `
      -d DMS `
      -Q "SELECT COUNT(*) FROM $table"
}
```

### 步驟 5：更新應用程式設定

1. **更新連接字串**（`appsettings.Production.json`）：

```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=DMS;User Id=YOUR_USER;Password=YOUR_PASSWORD;TrustServerCertificate=True;MultipleActiveResultSets=True"
  }
}
```

2. **測試連接**：

```powershell
cd DmsSystem.Api
dotnet run
# 檢查是否能正常連接資料庫
```

## 📝 遷移檢查清單

### 遷移前
- [ ] Mac 環境資料庫已備份
- [ ] Windows 環境 SQL Server 已準備就緒
- [ ] 已確認 Windows 環境的連接資訊
- [ ] 已準備遷移腳本或工具

### 遷移中
- [ ] 資料已成功匯出/備份
- [ ] 資料已成功匯入 Windows 環境
- [ ] 資料表結構已正確建立

### 遷移後
- [ ] 資料筆數已驗證（與 Mac 環境一致）
- [ ] 重要資料表已檢查
- [ ] 應用程式連接字串已更新
- [ ] 應用程式已測試並正常運行
- [ ] 功能測試已通過

## 🔍 常見問題

### Q1：遷移後資料筆數不一致

**可能原因：**
- 遷移過程中資料遺失
- 資料表結構不同
- 權限問題導致部分資料未遷移

**解決方法：**
1. 檢查遷移日誌
2. 重新執行遷移
3. 檢查資料表結構是否一致

### Q2：遷移後應用程式無法連接

**可能原因：**
- 連接字串錯誤
- 權限不足
- 防火牆設定

**解決方法：**
1. 檢查連接字串格式
2. 測試 SQL Server 連接
3. 檢查防火牆設定

### Q3：遷移時間過長

**建議：**
- 使用備份檔案還原（最快）
- 僅遷移必要的資料表
- 在非業務時間執行遷移

## 📚 相關文件

- [Windows 開發環境完整手冊](./01-Windows開發環境完整手冊.md)
- [Mac 開發環境完整手冊](../MAC-DEVELOPMENT-ONLY/01-Mac開發環境完整手冊.md)
- [資料庫配置](../03-資料庫配置.md)

---

**遷移完成後，請更新專案文件並通知相關人員。**

