# 報酬率計算公式白話文說明

## 程式碼位置
檔案: `丟/隨/FAS5/S_GETHISTORYTRADE.sql`  
行號: 第 685、842、1198、1408 行

---

## 完整程式碼

```sql
,(SELECT ROUND(
    (FAS_REDEMPTION.AMOUNT / 
     SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
               THEN CERTIFICATE.AMOUNT 
               ELSE CERTIFICATE.COST 
          END 
          * RED_CERTIFICATE.REDEMPTION_SHARE 
          / RED_CERTIFICATE.CERTIFICATE_SHARE)) 
     - 1) * 100, 2)
  FROM FAS.CERTIFICATE,
       FAS.RED_CERTIFICATE
  WHERE FAS.CERTIFICATE.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
    AND FAS.CERTIFICATE.CERTIFICATE_NO = FAS.RED_CERTIFICATE.CERTIFICATE_NO
    AND FAS_REDEMPTION.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
    AND FAS_REDEMPTION.TX_DATE = FAS.RED_CERTIFICATE.TX_DATE
    AND FAS_REDEMPTION.BROKER_NO = FAS.RED_CERTIFICATE.BROKER_NO
    AND FAS_REDEMPTION.BRANCH_NO = FAS.RED_CERTIFICATE.BRANCH_NO
    AND FAS_REDEMPTION.SER_NO = FAS.RED_CERTIFICATE.SER_NO
) RATE
```

---

## 白話文解釋

### 基本概念

這個公式是在計算客戶**贖回基金時賺了多少百分比**。

就像你買股票:
- 買進價: 10,000 元
- 賣出價: 11,000 元
- 賺了: 1,000 元
- 報酬率: (11,000 / 10,000 - 1) × 100 = 10%

---

## 公式拆解說明

### 第一步：計算贖回金額 (分子)

```sql
FAS_REDEMPTION.AMOUNT
```

**白話文**: 客戶這次贖回拿回多少錢

**例子**: 客戶贖回後拿回 11,000 元

---

### 第二步：計算當初的成本 (分母)

這是最複雜的部分，分成三小步：

#### 2-1. 決定用哪個欄位當成本

```sql
CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT    -- 配息再申購或V系列: 用申購金額
     ELSE CERTIFICATE.COST      -- 一般基金: 用實際成本
END
```

**白話文**: 
- **如果是**配息再申購 (分行代碼='7000') **或者** V系列基金 (基金代碼開頭是V)
  - 就用 `AMOUNT` (申購金額) 當成本
- **如果不是**
  - 就用 `COST` (扣掉手續費後的實際成本) 當成本

**為什麼要這樣分?**
- 配息再申購: 通常免手續費，COST 可能是 0，所以用 AMOUNT 比較準
- V系列基金: 資料處理方式特殊，用 AMOUNT 比較符合實際狀況
- 一般基金: COST 已經扣掉手續費，是真正的成本

**例子**:
```
一般基金申購:
  - 申購金額 (AMOUNT): 10,000 元
  - 手續費: 100 元
  - 實際成本 (COST): 9,900 元
  → 用 9,900 元 (COST)

配息再申購:
  - 申購金額 (AMOUNT): 1,000 元
  - 手續費: 0 元 (免手續費)
  - 實際成本 (COST): 0 或很小
  → 用 1,000 元 (AMOUNT)
```

#### 2-2. 計算部分贖回的成本比例

```sql
成本 * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE
```

**白話文**: 如果客戶只贖回一部分，要算出對應的成本

**為什麼要乘這個比例?**
- 客戶可能有多筆申購
- 這次只贖回其中一部分
- 要算出這次贖回的那部分，當初花了多少錢

**例子**:
```
情況：客戶之前買了 1000 單位，這次贖回 300 單位

第一筆申購: 成本 5,000 元，持有 500 單位
  → 這次贖回 150 單位 (500 的 30%)
  → 對應成本 = 5,000 × (150/500) = 1,500 元

第二筆申購: 成本 6,000 元，持有 500 單位  
  → 這次贖回 150 單位 (500 的 30%)
  → 對應成本 = 6,000 × (150/500) = 1,800 元

總成本 = 1,500 + 1,800 = 3,300 元
```

**欄位說明**:
- `RED_CERTIFICATE.REDEMPTION_SHARE`: 這次贖回的單位數 (例如: 150)
- `RED_CERTIFICATE.CERTIFICATE_SHARE`: 這張證券原本的單位數 (例如: 500)
- 比例 = 150/500 = 0.3 (30%)

#### 2-3. 加總所有相關證券的成本

```sql
SUM(成本 * 贖回比例)
```

**白話文**: 把客戶所有相關的申購記錄，依照贖回比例算出的成本，全部加起來

**例子**:
```
客戶有 3 筆申購記錄，這次部分贖回:

第 1 筆: 成本 5,000 × 贖回比例 0.3 = 1,500
第 2 筆: 成本 6,000 × 贖回比例 0.3 = 1,800  
第 3 筆: 成本 4,000 × 贖回比例 0.2 = 800

總成本 = 1,500 + 1,800 + 800 = 4,100 元
```

---

### 第三步：計算報酬率

```sql
(贖回金額 / 總成本 - 1) × 100
```

**白話文**: 
1. 贖回金額 ÷ 總成本 = 倍數
2. 倍數 - 1 = 賺的比例 (小數)
3. × 100 = 轉成百分比

**例子**:
```
贖回金額: 11,000 元
總成本: 10,000 元

計算:
  11,000 / 10,000 = 1.1
  1.1 - 1 = 0.1
  0.1 × 100 = 10

結果: 報酬率 10%
```

---

### 第四步：四捨五入到小數點後 2 位

```sql
ROUND(..., 2)
```

**白話文**: 四捨五入到小數點後 2 位

**例子**:
```
原始: 10.567%
四捨五入: 10.57%
```

---

## 完整範例

### 範例 1：一般基金，完整流程

**客戶交易記錄**:
```
第 1 筆申購: 
  - 申購金額 (AMOUNT): 10,000 元
  - 手續費: 100 元
  - 實際成本 (COST): 9,900 元
  - 單位數: 1,000 單位

第 2 筆申購:
  - 申購金額 (AMOUNT): 5,000 元
  - 手續費: 50 元
  - 實際成本 (COST): 4,950 元
  - 單位數: 500 單位
```

**這次贖回**:
```
贖回金額: 11,000 元
贖回單位數: 600 單位
  - 從第 1 筆贖回: 400 單位 (40%)
  - 從第 2 筆贖回: 200 單位 (40%)
```

**計算過程**:

**步驟 1**: 決定用哪個欄位
- 這是一般基金 (不是 V 系列，也不是配息再申購)
- 用 `COST` (實際成本)

**步驟 2**: 計算成本
```
第 1 筆: 9,900 × (400/1000) = 9,900 × 0.4 = 3,960 元
第 2 筆: 4,950 × (200/500) = 4,950 × 0.4 = 1,980 元
總成本 = 3,960 + 1,980 = 5,940 元
```

**步驟 3**: 計算報酬率
```
(11,000 / 5,940 - 1) × 100
= (1.8519 - 1) × 100
= 0.8519 × 100
= 85.19%
```

**步驟 4**: 四捨五入
```
85.19% → 85.19%
```

**結果**: 這次贖回的報酬率是 **85.19%**

---

### 範例 2：V系列基金

**客戶交易記錄**:
```
V系列基金申購:
  - 申購金額 (AMOUNT): 10,000 元
  - 實際成本 (COST): 9,900 元 (被清空為 0)
  - 單位數: 1,000 單位
```

**這次贖回**:
```
贖回金額: 11,000 元
贖回單位數: 1,000 單位 (全部)
```

**計算過程**:

**步驟 1**: 決定用哪個欄位
- 這是 V 系列基金 (FUND_NO LIKE 'V%')
- 用 `AMOUNT` (申購金額)

**步驟 2**: 計算成本
```
10,000 × (1000/1000) = 10,000 元
```

**步驟 3**: 計算報酬率
```
(11,000 / 10,000 - 1) × 100
= (1.1 - 1) × 100
= 0.1 × 100
= 10%
```

**結果**: 報酬率是 **10%**

---

### 範例 3：配息再申購

**客戶交易記錄**:
```
配息再申購 (BRANCH_NO = '7000'):
  - 申購金額 (AMOUNT): 1,000 元 (配息金額)
  - 實際成本 (COST): 0 元 (免手續費)
  - 單位數: 100 單位
```

**這次贖回**:
```
贖回金額: 1,100 元
贖回單位數: 100 單位 (全部)
```

**計算過程**:

**步驟 1**: 決定用哪個欄位
- 這是配息再申購 (BRANCH_NO = '7000')
- 用 `AMOUNT` (申購金額)

**步驟 2**: 計算成本
```
1,000 × (100/100) = 1,000 元
```

**步驟 3**: 計算報酬率
```
(1,100 / 1,000 - 1) × 100
= (1.1 - 1) × 100
= 10%
```

**結果**: 報酬率是 **10%**

---

## 為什麼會出錯？

### 錯誤情況：成本是 0

如果計算出來的總成本是 0，就會變成:

```
贖回金額 / 0 = 錯誤！
```

這就是**除以零錯誤** (ORA-01476)

### 什麼時候會成本是 0？

**情況 1**: V 系列的 AMOUNT 被清空
```
V 系列基金:
  - AMOUNT = 0 (被系統清理)
  - COST = 9,900 (保留)
  
但是公式用 AMOUNT:
  成本 = 0 → 除以零錯誤！
```

**情況 2**: 一般基金的 COST 是 0
```
配息再申購 (但沒有標記 BRANCH_NO='7000'):
  - AMOUNT = 1,000
  - COST = 0 (免手續費)
  
但是公式用 COST:
  成本 = 0 → 除以零錯誤！
```

---

## 總結

### 公式的核心邏輯

```
報酬率 = (賣出金額 / 買進成本 - 1) × 100
```

### 三個關鍵步驟

1. **決定成本欄位**: 
   - V系列/配息再申購 → 用 AMOUNT
   - 一般基金 → 用 COST

2. **計算部分贖回的成本**:
   - 成本 × (贖回單位 / 總單位)
   - 把所有相關申購記錄的成本加總

3. **計算百分比**:
   - (贖回金額 / 總成本 - 1) × 100
   - 四捨五入到小數點後 2 位

### 潛在問題

- **沒有檢查成本是否為 0**
- 如果成本是 0 → 除以零錯誤
- V 系列特別容易出現 AMOUNT=0 的狀況

### 解決方法

在計算前加上檢查:
```sql
CASE WHEN 總成本 = 0 
     THEN 0 
     ELSE (贖回金額 / 總成本 - 1) × 100
END
```
