# 報酬率計算 16 種組合完整分析

## 分析維度

- **基金類型**: 一般基金 vs V 系列
- **執行環境**: EC 環境 vs FAS51 環境
- **AMOUNT 狀態**: = 0 vs ≠ 0
- **COST 狀態**: = 0 vs ≠ 0

**總計**: 2 × 2 × 2 × 2 = **16 種組合**

---

## 執行邏輯差異

### EC 環境 (S_GETHISTORYTRADE.sql)

```sql
-- 第 685, 842, 1198, 1408 行
CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT    -- V系列用 AMOUNT
     ELSE CERTIFICATE.COST      -- 一般基金用 COST
END
```

**特性**:
- ❌ **無零檢查保護**
- 直接執行除法運算
- 除以零會拋出 ORA-01476 錯誤

### FAS51 環境 (d_fas51_balance.srd)

```powerbuilder
-- 第 136 行
if(shares > 0 and cost=0, 0, currency_value / cost - 1)
```

**特性**:
- ✅ **有零檢查保護** (但不完整)
- 保護條件: `shares > 0 and cost = 0`
- 統一使用 `COST` 欄位
- 成本為 0 時顯示 "-" 或返回 0

---

## 完整 16 種組合分析表

### 表格說明

| 圖示 | 意義 |
|------|------|
| ✅ | 不會跳錯,正常計算 |
| ❌ | 會跳錯 (除以零錯誤) |
| ⚠️ | 理論上會跳錯,但實務上不會遇到 |
| 🛡️ | 有保護機制,顯示 "-" 或 0 |

---

### EC 環境 + 一般基金 (使用 COST)

| # | AMOUNT | COST | 使用欄位 | 分母值 | 結果 | 說明 |
|---|--------|------|---------|--------|------|------|
| 1 | = 0 | = 0 | COST | 0 | ❌ **跳錯** | 除以零錯誤 |
| 2 | = 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |
| 3 | ≠ 0 | = 0 | COST | 0 | ❌ **跳錯** | 除以零錯誤 |
| 4 | ≠ 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |

**總結**:
- ✅ 正常: 2 種 (50%)
- ❌ 跳錯: 2 種 (50%)
- **關鍵**: COST 是否為 0

---

### EC 環境 + V 系列 (使用 AMOUNT)

| # | AMOUNT | COST | 使用欄位 | 分母值 | 結果 | 說明 |
|---|--------|------|---------|--------|------|------|
| 5 | = 0 | = 0 | AMOUNT | 0 | ❌ **跳錯** | 除以零錯誤 |
| 6 | = 0 | ≠ 0 | AMOUNT | 0 | ❌ **跳錯** | 除以零錯誤 (COST 不影響) |
| 7 | ≠ 0 | = 0 | AMOUNT | ≠ 0 | ✅ 正常 | 正常計算報酬率 |
| 8 | ≠ 0 | ≠ 0 | AMOUNT | ≠ 0 | ✅ 正常 | 正常計算報酬率 |

**總結**:
- ✅ 正常: 2 種 (50%)
- ❌ 跳錯: 2 種 (50%)
- **關鍵**: AMOUNT 是否為 0
- **注意**: 組合 #6 最容易被忽略 (COST≠0 但 AMOUNT=0 仍會跳錯)

---

### FAS51 環境 + 一般基金 (使用 COST + 有保護)

| # | AMOUNT | COST | 使用欄位 | 分母值 | 結果 | 說明 |
|---|--------|------|---------|--------|------|------|
| 9 | = 0 | = 0 | COST | 0 | 🛡️ 有保護 | if(shares>0 and cost=0) 返回 0 |
| 10 | = 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |
| 11 | ≠ 0 | = 0 | COST | 0 | 🛡️ 有保護 | if(shares>0 and cost=0) 返回 0 |
| 12 | ≠ 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |

**總結**:
- ✅ 正常: 2 種 (50%)
- 🛡️ 有保護: 2 種 (50%)
- ❌ 跳錯: 0 種 (0%)
- **關鍵**: 有 `if(shares>0 and cost=0, 0, ...)` 保護
- **注意**: 保護假設 `shares > 0`,如果 `shares = 0 and cost = 0` 仍可能跳錯

---

### FAS51 環境 + V 系列 (使用 COST + 有保護)

| # | AMOUNT | COST | 使用欄位 | 分母值 | 結果 | 說明 |
|---|--------|------|---------|--------|------|------|
| 13 | = 0 | = 0 | COST | 0 | 🛡️ 有保護 | if(shares>0 and cost=0) 返回 0 |
| 14 | = 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |
| 15 | ≠ 0 | = 0 | COST | 0 | 🛡️ 有保護 | if(shares>0 and cost=0) 返回 0 |
| 16 | ≠ 0 | ≠ 0 | COST | ≠ 0 | ✅ 正常 | 正常計算報酬率 |

**總結**:
- ✅ 正常: 2 種 (50%)
- 🛡️ 有保護: 2 種 (50%)
- ❌ 跳錯: 0 種 (0%)
- **關鍵**: FAS51 不區分 V 系列,統一用 COST + 保護機制
- **優勢**: V 系列的 AMOUNT=0 問題不影響 FAS51

---

## 統計總結

### 依環境分類

| 環境 | 一般基金 | V系列 | 合計 |
|------|---------|-------|------|
| **EC** | ✅2 ❌2 | ✅2 ❌2 | ✅4 ❌4 (50%跳錯率) |
| **FAS51** | ✅2 🛡️2 | ✅2 🛡️2 | ✅4 🛡️4 (0%跳錯率) |

### 依基金類型分類

| 基金類型 | EC環境 | FAS51環境 | 合計 |
|---------|--------|----------|------|
| **一般基金** | ✅2 ❌2 | ✅2 🛡️2 | ✅4 🛡️2 ❌2 |
| **V系列** | ✅2 ❌2 | ✅2 🛡️2 | ✅4 🛡️2 ❌2 |

### 關鍵發現

**EC 環境**:
- 跳錯率: **50%** (8種組合中4種會跳錯)
- 跳錯條件: 使用的欄位 = 0
  - 一般基金: `COST = 0` 就跳錯
  - V 系列: `AMOUNT = 0` 就跳錯

**FAS51 環境**:
- 跳錯率: **0%** (實務上)
- 保護機制: `if(shares>0 and cost=0, 0, ...)`
- 統一用 COST,避開 V 系列 AMOUNT=0 問題

---

## 最容易被忽略的組合

### 組合 #6: EC + V系列 + AMOUNT=0 + COST≠0

```
情境: V系列基金的 AMOUNT 被清空,但 COST 保留
資料: AMOUNT = 0, COST = 9900

預期: "COST還有值,應該不會出錯吧?"
實際: ❌ 除以零錯誤!

原因: EC 對 V 系列使用 AMOUNT,不看 COST
```

**這是最常見的誤解!**

### 組合 #3: EC + 一般基金 + AMOUNT≠0 + COST=0

```
情境: 配息再申購,免手續費
資料: AMOUNT = 1000, COST = 0 (或很小)

預期: "AMOUNT有值,應該不會出錯吧?"
實際: ❌ 除以零錯誤!

原因: EC 對一般基金使用 COST,不看 AMOUNT
```

---

## 實際案例說明

### 案例 1: V系列資料清理 (組合 #6)

**背景**:
```sql
-- 基金清算時清空 AMOUNT
UPDATE FAS.CERTIFICATE 
SET AMOUNT = 0 
WHERE FUND_NO LIKE 'V%' AND CANCEL_DATE IS NOT NULL;
```

**資料狀態**:
- AMOUNT = 0 (被清空)
- COST = 9900 (保留)

**結果**:
- EC 環境: ❌ 跳錯 (使用 AMOUNT=0)
- FAS51 環境: ✅ 正常 (使用 COST=9900)

### 案例 2: 配息再申購 (組合 #3)

**背景**:
```sql
-- 配息再申購,免手續費
INSERT INTO FAS.CERTIFICATE 
VALUES (..., AMOUNT=1000, COST=0, BRANCH_NO='7000', ...);
```

**資料狀態**:
- AMOUNT = 1000 (配息金額)
- COST = 0 (免手續費)

**結果**:
- EC 環境 (一般基金): ❌ 跳錯 (使用 COST=0)
- EC 環境 (配息,BRANCH_NO='7000'): ✅ 正常 (使用 AMOUNT=1000)
- FAS51 環境: 🛡️ 有保護 (檢查 cost=0)

---

## 修正建議

### 方案 1: 加入零檢查 (EC 環境)

```sql
-- 修正前 (第 685 行)
FAS_REDEMPTION.AMOUNT / SUM(...)

-- 修正後
CASE 
    WHEN SUM(...) = 0 THEN 0
    ELSE ROUND((FAS_REDEMPTION.AMOUNT / SUM(...) - 1) * 100, 2)
END
```

**影響**:
- 將 4 種跳錯組合 → 0 種跳錯
- EC 環境跳錯率: 50% → 0%

### 方案 2: 統一使用 COST (EC 環境)

```sql
-- 修正前
CASE WHEN CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT 
     ELSE CERTIFICATE.COST 
END

-- 修正後
CERTIFICATE.COST  -- 統一使用 COST
```

**影響**:
- V 系列改用 COST (與 FAS51 一致)
- 需要確認 V 系列 COST 欄位的正確性
- 可能影響現有報酬率數值

### 方案 3: 改善 FAS51 保護機制

```powerbuilder
-- 修正前
if(shares > 0 and cost=0, 0, currency_value / cost - 1)

-- 修正後
if(cost = 0, 0, currency_value / cost - 1)
```

**影響**:
- 更完整的保護 (不依賴 shares > 0)
- 理論上的 shares=0 and cost=0 也能處理

---

## 測試檢查表

### EC 環境測試

- [ ] 一般基金 + COST=0 → 應顯示錯誤或 0
- [ ] 一般基金 + COST≠0 → 應正常顯示報酬率
- [ ] V系列 + AMOUNT=0 → 應顯示錯誤或 0
- [ ] V系列 + AMOUNT≠0 → 應正常顯示報酬率
- [ ] 配息再申購 (BRANCH_NO='7000') → 應正常顯示

### FAS51 環境測試

- [ ] 任何基金 + COST=0 → 應顯示 "-" 或 0
- [ ] 任何基金 + COST≠0 → 應正常顯示報酬率
- [ ] V系列 + AMOUNT=0 + COST≠0 → 應正常顯示 (不受 AMOUNT 影響)

---

## 結論

### 核心問題

1. **EC 環境**: 依基金類型使用不同欄位 + 沒有零檢查 = **50% 跳錯率**
2. **FAS51 環境**: 統一使用 COST + 有零保護 = **0% 跳錯率**

### 關鍵差異

| 項目 | EC 環境 | FAS51 環境 |
|------|---------|-----------|
| 成本欄位 | 一般:COST / V系列:AMOUNT | 統一:COST |
| 零檢查 | ❌ 無 | ✅ 有 |
| 跳錯風險 | ⚠️ 高 (50%) | ✅ 低 (0%) |
| V系列問題 | ❌ 受影響 | ✅ 不受影響 |

### 最佳實踐

**立即行動**:
1. EC 環境加入零檢查保護 (方案 1)
2. 測試所有 16 種組合

**長期規劃**:
1. 調查為何當初 V 系列要用 AMOUNT
2. 驗證 V 系列 COST 欄位的正確性
3. 考慮統一使用 COST (方案 2)
