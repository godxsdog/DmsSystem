--------------------------------------------------------
--  已建立檔案 - 星期五-1月-16-2026   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Trigger AA_ACCOUNTSTATUS_TRIGGER
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_ACCOUNTSTATUS_TRIGGER" BEFORE
    UPDATE OR INSERT ON ECS.aa_accountstatus
    FOR EACH ROW
DECLARE
BEGIN
    SELECT utl_raw.cast_to_raw(sys_guid()) INTO :new.dataflag FROM dual;
END;

/
ALTER TRIGGER "ECS"."AA_ACCOUNTSTATUS_TRIGGER" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_BULLETINFILE_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_BULLETINFILE_TRIDFG" 
    before update or insert on ECS.aa_bulletinfile
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_BULLETINFILE_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_BULLETIN_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_BULLETIN_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_Bulletin
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
 end;

/
ALTER TRIGGER "ECS"."AA_BULLETIN_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_CUSTOMER_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_CUSTOMER_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_Customer
    for each row
 declare
 begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
 end;

/
ALTER TRIGGER "ECS"."AA_CUSTOMER_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_DEPTGROUP_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_DEPTGROUP_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_DeptGROUP
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
 end;

/
ALTER TRIGGER "ECS"."AA_DEPTGROUP_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_DEPT_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_DEPT_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_Dept
    for each row
 declare
 begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
 end;

/
ALTER TRIGGER "ECS"."AA_DEPT_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_EXCEPTIONLOG_TRIGGER
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_EXCEPTIONLOG_TRIGGER" --TraggerName請自行修正
BEFORE INSERT ON ECS.AA_EXCEPTION_LOG   --TableName當然是指定欄位的Table
FOR EACH ROW
BEGIN
    IF :new.LOG_SRNO IS NULL THEN       --SRNO就是流水號的欄位名稱啦
        SELECT Seq_AAExceptionLogSrno.nextval INTO :new.LOG_SRNO FROM dual;
    END IF;
END;

/
ALTER TRIGGER "ECS"."AA_EXCEPTIONLOG_TRIGGER" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_GROUPRIGHT_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_GROUPRIGHT_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_GROUPRight
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_GROUPRIGHT_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_GROUP_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_GROUP_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_GROUP
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_GROUP_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_LOGINLOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_LOGINLOG_TRIDFG" 
    before update or insert on ECS.aa_loginlog
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_LOGINLOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_REPORTDETAILSCHEMA_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_REPORTDETAILSCHEMA_TRIDFG" 
    before update or insert on ECS.aa_reportdetailschema
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_REPORTDETAILSCHEMA_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_REPORTMASTERSCHEMA_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_REPORTMASTERSCHEMA_TRIDFG" 
    before update or insert on ECS.aa_reportmasterschema
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_REPORTMASTERSCHEMA_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_REVIEWMODEL_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_REVIEWMODEL_TRIDFG" 
    before update or insert on ECS.AA_REVIEWMODEL
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_REVIEWMODEL_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SCRIPTING_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SCRIPTING_DATAFLAG" 
    before update or insert on ECS.AA_SCRIPTING
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SCRIPTING_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SCRIPTING_EXPORT_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SCRIPTING_EXPORT_LOG_TRG" 
    before insert on ECS.aa_scripting_export_log  
    for each row
     WHEN (new.LOG_SRNO IS NULL) BEGIN

    SELECT AA_SCRIPTING_EXPORT_LOG_SEQ.NEXTVAL
    INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."AA_SCRIPTING_EXPORT_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SCRIPTING_GROUP_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SCRIPTING_GROUP_TRIDFG" 
    before update or insert on ECS.AA_SCRIPTING_GROUP
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SCRIPTING_GROUP_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOSLOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOSLOG_TRIDFG" 
    before update or insert on ECS.AA_Srnoslog
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOSLOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOSSETDTLLOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOSSETDTLLOG_TRIDFG" 
    before update or insert on ECS.AA_SRNOSSETDTLlog
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOSSETDTLLOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOSSETDTL_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOSSETDTL_TRIDFG" 
    before update or insert on ECS.AA_SRNOSSETDTL
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOSSETDTL_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOSSETLOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOSSETLOG_TRIDFG" 
    before update or insert on ECS.AA_SRNOSSETlog
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOSSETLOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOSSET_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOSSET_TRIDFG" 
    before update or insert on ECS.AA_Srnosset
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOSSET_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_SRNOS_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_SRNOS_TRIDFG" 
    before update or insert on ECS.AA_Srnos
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_SRNOS_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_TREEPATTERN_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_TREEPATTERN_TRIDFG" 
    before update or insert on ECS.AA_Treepattern
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_TREEPATTERN_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USERGROUP_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USERGROUP_TRIDFG" 
    before update or insert on ECS.Aa_Usergroup
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_USERGROUP_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USERPWDHISTORY_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USERPWDHISTORY_TRIDFG" 
    before update or insert on ECS.AA_Userpwdhistory
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_USERPWDHISTORY_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USER_DISABLE_LOG_TRI_RK
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USER_DISABLE_LOG_TRI_RK" 
    BEFORE INSERT ON ECS.AA_USER_DISABLE_LOG
    FOR EACH ROW
DECLARE
    -- LOCAL VARIABLES HERE
BEGIN
    IF :NEW.RK IS NULL THEN
        SELECT SEQ_AA_USER_DISABLE_LOG.NEXTVAL INTO :NEW.RK FROM DUAL;
    END IF;
END;

/
ALTER TRIGGER "ECS"."AA_USER_DISABLE_LOG_TRI_RK" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USER_FUNCTION_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USER_FUNCTION_LOG_TRG" 
    BEFORE INSERT ON ECS.AA_USER_FUNCTION_LOG
    FOR EACH ROW
     WHEN (new.LOG_SRNO IS NULL) BEGIN

    SELECT SEQ_AA_USER_FUNCTION_LOG_SRNO.NEXTVAL
    INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."AA_USER_FUNCTION_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USER_LOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USER_LOG_TRIDFG" 
    before update or insert on ECS.AA_User_Log
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_USER_LOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger AA_USER_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."AA_USER_TRIGGER_DATAFLAG" 
    before update or insert on ECS.AA_USER
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."AA_USER_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger API_LOG_SRNO_BIR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."API_LOG_SRNO_BIR" 
BEFORE INSERT ON ECS.API_LOG
FOR EACH ROW 
  BEGIN
    SELECT ECS.API_LOG_SRNO_SEQUENCE.NEXTVAL 
    INTO :NEW.SRNO
    FROM DUAL;
  END;
/
ALTER TRIGGER "ECS"."API_LOG_SRNO_BIR" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BATCHJOBLOG_TRI_SRNO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BATCHJOBLOG_TRI_SRNO" 
    BEFORE INSERT ON ECS.BATCHJOBLOG
    FOR EACH ROW
DECLARE
    -- LOCAL VARIABLES HERE
BEGIN
    IF :NEW.SRNO IS NULL THEN
        SELECT SEQ_BATCHJOBLOG.NEXTVAL INTO :NEW.SRNO FROM DUAL;
    END IF;
END;

/
ALTER TRIGGER "ECS"."BATCHJOBLOG_TRI_SRNO" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BATCHJOBPROCESS_TRI_BATCHNO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BATCHJOBPROCESS_TRI_BATCHNO" 
    BEFORE INSERT ON ECS.BATCHJOBPROCESS
    FOR EACH ROW
DECLARE
    -- LOCAL VARIABLES HERE
BEGIN
    IF :NEW.BATCHNO IS NULL THEN
        SELECT SEQ_BATCHJOBPROCESS.NEXTVAL INTO :NEW.BATCHNO FROM DUAL;
    END IF;
END;

/
ALTER TRIGGER "ECS"."BATCHJOBPROCESS_TRI_BATCHNO" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BROWSER_LOG_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BROWSER_LOG_DATAFLAG" 
BEFORE UPDATE OR INSERT ON ECS.BROWSER_LOG
FOR EACH ROW
DECLARE
  BEGIN
    SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID())
    INTO :NEW.DATA_FLAG
    FROM DUAL;
  END;
/
ALTER TRIGGER "ECS"."BROWSER_LOG_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BROWSER_LOG_SRNO_BIR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BROWSER_LOG_SRNO_BIR" 
BEFORE INSERT ON ECS.BROWSER_LOG
FOR EACH ROW
  BEGIN
    SELECT ECS.BROWSER_LOG_SRNO_SEQUENCE.NEXTVAL
    INTO :NEW.SRNO
    FROM DUAL;
  END;
/
ALTER TRIGGER "ECS"."BROWSER_LOG_SRNO_BIR" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BYPASSHISTORYDTL_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BYPASSHISTORYDTL_TRIDFG" 
    before update or insert on ECS.bypasshistoryDTL
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."BYPASSHISTORYDTL_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BYPASSHISTORY_LOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BYPASSHISTORY_LOG_TRIDFG" 
    before update or insert on ECS.bypasshistory_log
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."BYPASSHISTORY_LOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger BYPASSHISTORY_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."BYPASSHISTORY_TRIGGER_DATAFLAG" 
    before update or insert on ECS.bypasshistory
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."BYPASSHISTORY_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_CRNCY_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_CRNCY_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN_CRNCY    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_CRNCY_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_FUNDDTL_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_FUNDDTL_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN_FUNDDTL    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_FUNDDTL_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_FUND_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_FUND_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN_FUND
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_FUND_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_MKT_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_MKT_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN_MKT    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_MKT_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CAMPAIGN_RSP_TIME_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CAMPAIGN_RSP_TIME_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.CAMPAIGN_RSP_TIME    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."CAMPAIGN_RSP_TIME_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COD005_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COD005_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.COD005
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."COD005_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COD006_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COD006_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.COD006
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."COD006_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COMMENTHISTORYDTL_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COMMENTHISTORYDTL_TRIDFG" 
    before update or insert on ECS.commenthistoryDTL
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."COMMENTHISTORYDTL_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COMMENTHISTORY_LOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COMMENTHISTORY_LOG_TRIDFG" 
    before update or insert on ECS.commenthistory_LOG
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."COMMENTHISTORY_LOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COMMENTHISTORY_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COMMENTHISTORY_TRIDFG" 
    before update or insert on ECS.commenthistory
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."COMMENTHISTORY_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COUNTRY_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COUNTRY_TRIDFG" 
    before update or insert on ECS.country
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."COUNTRY_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COUPON_DATA_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COUPON_DATA_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.COUPON_DATA    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."COUPON_DATA_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger COUPON_PROGRAM_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."COUPON_PROGRAM_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.COUPON_PROGRAM    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."COUPON_PROGRAM_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger CURRENCY_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."CURRENCY_TRIDFG" 
    before update or insert on ECS.currency
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."CURRENCY_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger DEL_MD_TRIGGERS_T_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."DEL_MD_TRIGGERS_T_TRG" 
    AFTER DELETE ON ECS.MD_TABLES 
    FOR EACH ROW 
BEGIN
    DELETE FROM MD_TRIGGERS WHERE MD_TRIGGERS.TABLE_OR_VIEW_ID_FK = :OLD.ID AND MD_TRIGGERS.TRIGGER_ON_FLAG = 'T';
END;

/
ALTER TRIGGER "ECS"."DEL_MD_TRIGGERS_T_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger DEL_MD_TRIGGERS_V_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."DEL_MD_TRIGGERS_V_TRG" 
    AFTER DELETE ON ECS.MD_VIEWS
    FOR EACH ROW 
BEGIN
    DELETE FROM MD_TRIGGERS WHERE MD_TRIGGERS.TABLE_OR_VIEW_ID_FK = :OLD.ID AND MD_TRIGGERS.TRIGGER_ON_FLAG = 'V';
END;

/
ALTER TRIGGER "ECS"."DEL_MD_TRIGGERS_V_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger EMAIL_NOTICE_LIST_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."EMAIL_NOTICE_LIST_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.EMAIL_NOTICE_LIST
FOR EACH ROW
DECLARE

BEGIN
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."EMAIL_NOTICE_LIST_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_PUSH_MESSAGE_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_PUSH_MESSAGE_LOG_TRG" 
BEFORE INSERT ON ECS.FS_PUSH_MESSAGE_LOG
FOR EACH ROW
 WHEN (new.LOG_SRNO IS NULL) BEGIN

    SELECT SEQ_FS_PUSH_MESSAGE_LOG.NEXTVAL
    INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."FS_PUSH_MESSAGE_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_PUSH_MESSAGE_QUEUE_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_PUSH_MESSAGE_QUEUE_TRG" 
BEFORE INSERT ON ECS.FS_PUSH_MESSAGE_QUEUE
FOR EACH ROW
 WHEN (new.SRNO IS NULL) BEGIN

  SELECT SEQ_FS_PUSH_MESSAGE_QUEUE.NEXTVAL
  INTO :new.SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."FS_PUSH_MESSAGE_QUEUE_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_PUSH_TIMING_SERVICE_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_PUSH_TIMING_SERVICE_LOG_TRG" 
BEFORE INSERT ON ECS.FS_PUSH_TIMING_SERVICE_LOG
FOR EACH ROW
 WHEN (new.LOG_SRNO IS NULL) BEGIN

  SELECT SEQ_FS_PUSH_TIMING_SERVICE_LOG.NEXTVAL
  INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."FS_PUSH_TIMING_SERVICE_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_SERVICE_ACTION_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_SERVICE_ACTION_LOG_TRG" 
BEFORE INSERT ON ECS.FS_SERVICE_ACTION_LOG
FOR EACH ROW
 WHEN (new.LOG_SRNO IS NULL) BEGIN

  SELECT SEQ_FS_SERVICE_ACTION_LOG .NEXTVAL
  INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."FS_SERVICE_ACTION_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_SQL_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_SQL_LOG_TRG" 
    before insert on ECS.fs_sql_log
    for each row
     WHEN (new.LOG_SRNO IS NULL) begin
    SELECT SEQ_FS_SOL_LOG.NEXTVAL
    INTO :new.LOG_SRNO FROM dual;
end FS_SQL_LOG_TRG;

/
ALTER TRIGGER "ECS"."FS_SQL_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FS_TOKEN_SERVICE_LOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FS_TOKEN_SERVICE_LOG_TRG" 
BEFORE INSERT ON ECS.FS_TOKEN_SERVICE_LOG
FOR EACH ROW
 WHEN (new.LOG_SRNO IS NULL) BEGIN

    SELECT SEQ_FS_TOKEN_SERVICE_LOG.NEXTVAL
    INTO :new.LOG_SRNO FROM dual;

END;

/
ALTER TRIGGER "ECS"."FS_TOKEN_SERVICE_LOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger FUND
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FUND" 
  BEFORE UPDATE OR INSERT ON ECS.FUND
FOR EACH ROW
DECLARE

BEGIN
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."FUND" ENABLE;
  GRANT UPDATE ON "ECS"."FUND" TO "ECROBO";
  GRANT SELECT ON "ECS"."FUND" TO "ECROBO";
  GRANT INSERT ON "ECS"."FUND" TO "ECROBO";
  GRANT DELETE ON "ECS"."FUND" TO "ECROBO";
--------------------------------------------------------
--  DDL for Trigger FUND_SHARE_CLASS_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."FUND_SHARE_CLASS_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.FUND_SHARE_CLASS    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."FUND_SHARE_CLASS_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger HOLDER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."HOLDER_DATAFLAG" 
BEFORE UPDATE OR INSERT ON ECS.HOLDER 
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."HOLDER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger HOLDER_DOC_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."HOLDER_DOC_DATAFLAG" 
BEFORE UPDATE OR INSERT ON ECS.HOLDER_DOC 
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."HOLDER_DOC_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger HOLDER_REJECT_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."HOLDER_REJECT_DATAFLAG" 
BEFORE UPDATE OR INSERT ON ECS.HOLDER_REJECT 
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."HOLDER_REJECT_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger HOLDER_TMP_LOG_T01
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."HOLDER_TMP_LOG_T01" 
  AFTER UPDATE OR INSERT OR DELETE ON ECS.HOLDER_TMP
  FOR EACH ROW

BEGIN
  IF INSERTING THEN
    INSERT INTO ECS.HOLDER_TMP_LOG
      (LOGSRNO,
       LOGTIME,
       LOGTYPE,
       ID,
       OPEN_TYPE,
       IS_ES_ACCOUNT,
       NAME,
       STEP_ID,
       FIRST_NAME,
       MIDDLE_NAME,
       LAST_NAME,
       BIRTH_DATE,
       NATIONALITY,
       BIRTH_COUNTRY,
       TEL_H_COUNTRY,
       TEL_H_AREA,
       TEL_H_NO,
       TEL_H_EXT,
       TEL_O_COUNTRY,
       TEL_O_AREA,
       TEL_O_NO,
       TEL_O_EXT,
       MOBILE_COUNTRY,
       MOBILE,
       FAX_COUNTRY,
       FAX_AREA,
       FAX_NO,
       FAX_EXT,
       EMAIL,
       CONTACT_ADDRESS_COUNTRY,
       POST_CODE,
       CONTACT_ADDRESS,
       REG_ADDRESS_COUNTRY,
       REG_POST_CODE,
       REG_ADDRESS,
       CURRENT_ADDRESS_COUNTRY,
       CURRENT_POST_CODE,
       CURRENT_ADDRESS,
       REP_NATIONALITY_CODE,
       REPRESENTATIVE,
       REPRESENTATIVE_ID,
       REP_BIRTH_DATE,
       REP_ADDRESS,
       REP_NATIONALITY_CODE1,
       REPRESENTATIVE1,
       REPRESENTATIVE1_ID,
       REP_BIRTH_DATE1,
       REP_ADDRESS1,
       EDM_ACCEPTED,
       NAV_EPAPER,
       US_TAX,
       FATCA_TYPE,
       TAX_COUNTRY1,
       TAX_NUM1,
       TAXNOREASON1,
       TAXATION_REMARK1,
       TAX_COUNTRY2,
       TAX_NUM2,
       TAXNOREASON2,
       TAXATION_REMARK2,
       TAX_COUNTRY3,
       TAX_NUM3,
       TAXNOREASON3,
       TAXATION_REMARK3,
       FIS_CURRENCY_NO_TWD,
       FIS_BANK_NO_TWD,
       FIS_BRANCH_NO_TWD,
       FIS_AC_CODE_TWD,
       FIS_SEAL_DATE_TWD,
       FIS_CURRENCY_NO_FCY,
       FIS_BANK_NO_TWD_FCY,
       FIS_BRANCH_NO_TWD_FCY,
       FIS_AC_CODE_TWD_FCY,
       FIS_SEAL_DATE_FCY,
       TDCC_CURRENCY_NO,
       TDCC_BANK_NO,
       TDCC_BRANCH_NO,
       TDCC_AC_CODE,
       TDCC_SEAL_DATE,
       TDCC_CURRENCY_NO_FCY,
       TDCC_BANK_NO_TWD_FCY,
       TDCC_BRANCH_NO_TWD_FCY,
       TDCC_AC_CODE_TWD_FCY,
       TDCC_SEAL_DATE_FCY,
       MARRIED,
       MARRIED_OTHER,
       MS_NUM_CODE,
       MS_NUM,
       PROFESSION,
       PROFESSION_OTHERS_NEW,
       POSITION,
       POSITION_OTHERS,
       MAJOR_ILLNESS,
       INVEST_CODE,
       INV_KNOWLEDGE,
       INV_KNOWLEDGE_OTHER,
       INV_ORI,
       INV_ORI_OTHER,
       CUST_RESIDENCE_STATUS,
       CUST_RESIDENCE_STATUS_TXT,
       CUST_MIND_STATUS,
       BF_AGE_CODE,
       EDUCATION,
       INV_TOOL,
       INV_EXPERIENCE,
       INV_GOAL,
       INV_FAIL_METHOD,
       FAMILY_INCOME,
       SIGNIFICANT_NEEDS,
       LIQUIDITY_NEEDS,
       PRICE_VOLATILITY,
       GENDAR,
       KYC_SCROE,
       RISK_LEVEL,
       SPONSOR_ID,
       APPLY_DTTM,
       FINISH_DTTM,
       IP_ADDR,
       UPDATE_DTTM,
       CONTACT_CITY,
       CONTACT_AREA,
       REG_CITY,
       REG_AREA,
       EMPLOYER,
       CURRENT_CITY,
       CURRENT_AREA,
       IS_SAME_PERM_ADDR,
       IS_SAME_CURRENT_REG,
       IS_SAME_CURRENT_PERM,
       IS_UPLOAD_PAPERWORK,
       ACCOUNT_NO,
       TDCC_ACCT_NO,
       VULNERABLE_CLAIM
       )
    VALUES
      (ECS.HOLDER_TMP_LOG_SEQUENCE.NEXTVAL,
       SYSDATE,
       'A',
       :new.ID,
       :new.OPEN_TYPE,
       :new.IS_ES_ACCOUNT,
       :new.NAME,
       :new.STEP_ID,
       :new.FIRST_NAME,
       :new.MIDDLE_NAME,
       :new.LAST_NAME,
       :new.BIRTH_DATE,
       :new.NATIONALITY,
       :new.BIRTH_COUNTRY,
       :new.TEL_H_COUNTRY,
       :new.TEL_H_AREA,
       :new.TEL_H_NO,
       :new.TEL_H_EXT,
       :new.TEL_O_COUNTRY,
       :new.TEL_O_AREA,
       :new.TEL_O_NO,
       :new.TEL_O_EXT,
       :new.MOBILE_COUNTRY,
       :new.MOBILE,
       :new.FAX_COUNTRY,
       :new.FAX_AREA,
       :new.FAX_NO,
       :new.FAX_EXT,
       :new.EMAIL,
       :new.CONTACT_ADDRESS_COUNTRY,
       :new.POST_CODE,
       :new.CONTACT_ADDRESS,
       :new.REG_ADDRESS_COUNTRY,
       :new.REG_POST_CODE,
       :new.REG_ADDRESS,
       :new.CURRENT_ADDRESS_COUNTRY,
       :new.CURRENT_POST_CODE,
       :new.CURRENT_ADDRESS,
       :new.REP_NATIONALITY_CODE,
       :new.REPRESENTATIVE,
       :new.REPRESENTATIVE_ID,
       :new.REP_BIRTH_DATE,
       :new.REP_ADDRESS,
       :new.REP_NATIONALITY_CODE1,
       :new.REPRESENTATIVE1,
       :new.REPRESENTATIVE1_ID,
       :new.REP_BIRTH_DATE1,
       :new.REP_ADDRESS1,
       :new.EDM_ACCEPTED,
       :new.NAV_EPAPER,
       :new.US_TAX,
       :new.FATCA_TYPE,
       :new.TAX_COUNTRY1,
       :new.TAX_NUM1,
       :new.TAXNOREASON1,
       :new.TAXATION_REMARK1,
       :new.TAX_COUNTRY2,
       :new.TAX_NUM2,
       :new.TAXNOREASON2,
       :new.TAXATION_REMARK2,
       :new.TAX_COUNTRY3,
       :new.TAX_NUM3,
       :new.TAXNOREASON3,
       :new.TAXATION_REMARK3,
       :new.FIS_CURRENCY_NO_TWD,
       :new.FIS_BANK_NO_TWD,
       :new.FIS_BRANCH_NO_TWD,
       :new.FIS_AC_CODE_TWD,
       :new.FIS_SEAL_DATE_TWD,
       :new.FIS_CURRENCY_NO_FCY,
       :new.FIS_BANK_NO_TWD_FCY,
       :new.FIS_BRANCH_NO_TWD_FCY,
       :new.FIS_AC_CODE_TWD_FCY,
       :new.FIS_SEAL_DATE_FCY,
       :new.TDCC_CURRENCY_NO,
       :new.TDCC_BANK_NO,
       :new.TDCC_BRANCH_NO,
       :new.TDCC_AC_CODE,
       :new.TDCC_SEAL_DATE,
       :new.TDCC_CURRENCY_NO_FCY,
       :new.TDCC_BANK_NO_TWD_FCY,
       :new.TDCC_BRANCH_NO_TWD_FCY,
       :new.TDCC_AC_CODE_TWD_FCY,
       :new.TDCC_SEAL_DATE_FCY,
       :new.MARRIED,
       :new.MARRIED_OTHER,
       :new.MS_NUM_CODE,
       :new.MS_NUM,
       :new.PROFESSION,
       :new.PROFESSION_OTHERS_NEW,
       :new.POSITION,
       :new.POSITION_OTHERS,
       :new.MAJOR_ILLNESS,
       :new.INVEST_CODE,
       :new.INV_KNOWLEDGE,
       :new.INV_KNOWLEDGE_OTHER,
       :new.INV_ORI,
       :new.INV_ORI_OTHER,
       :new.CUST_RESIDENCE_STATUS,
       :new.CUST_RESIDENCE_STATUS_TXT,
       :new.CUST_MIND_STATUS,
       :new.BF_AGE_CODE,
       :new.EDUCATION,
       :new.INV_TOOL,
       :new.INV_EXPERIENCE,
       :new.INV_GOAL,
       :new.INV_FAIL_METHOD,
       :new.FAMILY_INCOME,
       :new.SIGNIFICANT_NEEDS,
       :new.LIQUIDITY_NEEDS,
       :new.PRICE_VOLATILITY,
       :new.GENDAR,
       :new.KYC_SCROE,
       :new.RISK_LEVEL,
       :new.SPONSOR_ID,
       :new.APPLY_DTTM,
       :new.FINISH_DTTM,
       :new.IP_ADDR,
       :new.UPDATE_DTTM,
       :new.CONTACT_CITY,
       :new.CONTACT_AREA,
       :new.REG_CITY,
       :new.REG_AREA,
       :new.EMPLOYER,
       :new.CURRENT_CITY,
       :new.CURRENT_AREA,
       :new.IS_SAME_PERM_ADDR,
       :new.IS_SAME_CURRENT_REG,
       :new.IS_SAME_CURRENT_PERM,
       :new.IS_UPLOAD_PAPERWORK,
       :new.ACCOUNT_NO,
       :new.TDCC_ACCT_NO,
       :new.VULNERABLE_CLAIM
       );
  ELSIF UPDATING THEN
    INSERT INTO ECS.HOLDER_TMP_LOG
      (LOGSRNO,
       LOGTIME,
       LOGTYPE,
       ID,
       OPEN_TYPE,
       IS_ES_ACCOUNT,
       NAME,
       STEP_ID,
       FIRST_NAME,
       MIDDLE_NAME,
       LAST_NAME,
       BIRTH_DATE,
       NATIONALITY,
       BIRTH_COUNTRY,
       TEL_H_COUNTRY,
       TEL_H_AREA,
       TEL_H_NO,
       TEL_H_EXT,
       TEL_O_COUNTRY,
       TEL_O_AREA,
       TEL_O_NO,
       TEL_O_EXT,
       MOBILE_COUNTRY,
       MOBILE,
       FAX_COUNTRY,
       FAX_AREA,
       FAX_NO,
       FAX_EXT,
       EMAIL,
       CONTACT_ADDRESS_COUNTRY,
       POST_CODE,
       CONTACT_ADDRESS,
       REG_ADDRESS_COUNTRY,
       REG_POST_CODE,
       REG_ADDRESS,
       CURRENT_ADDRESS_COUNTRY,
       CURRENT_POST_CODE,
       CURRENT_ADDRESS,
       REP_NATIONALITY_CODE,
       REPRESENTATIVE,
       REPRESENTATIVE_ID,
       REP_BIRTH_DATE,
       REP_ADDRESS,
       REP_NATIONALITY_CODE1,
       REPRESENTATIVE1,
       REPRESENTATIVE1_ID,
       REP_BIRTH_DATE1,
       REP_ADDRESS1,
       EDM_ACCEPTED,
       NAV_EPAPER,
       US_TAX,
       FATCA_TYPE,
       TAX_COUNTRY1,
       TAX_NUM1,
       TAXNOREASON1,
       TAXATION_REMARK1,
       TAX_COUNTRY2,
       TAX_NUM2,
       TAXNOREASON2,
       TAXATION_REMARK2,
       TAX_COUNTRY3,
       TAX_NUM3,
       TAXNOREASON3,
       TAXATION_REMARK3,
       FIS_CURRENCY_NO_TWD,
       FIS_BANK_NO_TWD,
       FIS_BRANCH_NO_TWD,
       FIS_AC_CODE_TWD,
       FIS_SEAL_DATE_TWD,
       FIS_CURRENCY_NO_FCY,
       FIS_BANK_NO_TWD_FCY,
       FIS_BRANCH_NO_TWD_FCY,
       FIS_AC_CODE_TWD_FCY,
       FIS_SEAL_DATE_FCY,
       TDCC_CURRENCY_NO,
       TDCC_BANK_NO,
       TDCC_BRANCH_NO,
       TDCC_AC_CODE,
       TDCC_SEAL_DATE,
       TDCC_CURRENCY_NO_FCY,
       TDCC_BANK_NO_TWD_FCY,
       TDCC_BRANCH_NO_TWD_FCY,
       TDCC_AC_CODE_TWD_FCY,
       TDCC_SEAL_DATE_FCY,
       MARRIED,
       MARRIED_OTHER,
       MS_NUM_CODE,
       MS_NUM,
       PROFESSION,
       PROFESSION_OTHERS_NEW,
       POSITION,
       POSITION_OTHERS,
       MAJOR_ILLNESS,
       INVEST_CODE,
       INV_KNOWLEDGE,
       INV_KNOWLEDGE_OTHER,
       INV_ORI,
       INV_ORI_OTHER,
       CUST_RESIDENCE_STATUS,
       CUST_RESIDENCE_STATUS_TXT,
       CUST_MIND_STATUS,
       BF_AGE_CODE,
       EDUCATION,
       INV_TOOL,
       INV_EXPERIENCE,
       INV_GOAL,
       INV_FAIL_METHOD,
       FAMILY_INCOME,
       SIGNIFICANT_NEEDS,
       LIQUIDITY_NEEDS,
       PRICE_VOLATILITY,
       GENDAR,
       KYC_SCROE,
       RISK_LEVEL,
       SPONSOR_ID,
       APPLY_DTTM,
       FINISH_DTTM,
       IP_ADDR,
       UPDATE_DTTM,
       CONTACT_CITY,
       CONTACT_AREA,
       REG_CITY,
       REG_AREA,
       EMPLOYER,
       CURRENT_CITY,
       CURRENT_AREA,
       IS_SAME_PERM_ADDR,
       IS_SAME_CURRENT_REG,
       IS_SAME_CURRENT_PERM,
       IS_UPLOAD_PAPERWORK,
       ACCOUNT_NO,
       TDCC_ACCT_NO,
       VULNERABLE_CLAIM
       )
    VALUES
      (ECS.HOLDER_TMP_LOG_SEQUENCE.NEXTVAL,
       SYSDATE,
       'U',
       :new.ID,
       :new.OPEN_TYPE,
       :new.IS_ES_ACCOUNT,
       :new.NAME,
       :new.STEP_ID,
       :new.FIRST_NAME,
       :new.MIDDLE_NAME,
       :new.LAST_NAME,
       :new.BIRTH_DATE,
       :new.NATIONALITY,
       :new.BIRTH_COUNTRY,
       :new.TEL_H_COUNTRY,
       :new.TEL_H_AREA,
       :new.TEL_H_NO,
       :new.TEL_H_EXT,
       :new.TEL_O_COUNTRY,
       :new.TEL_O_AREA,
       :new.TEL_O_NO,
       :new.TEL_O_EXT,
       :new.MOBILE_COUNTRY,
       :new.MOBILE,
       :new.FAX_COUNTRY,
       :new.FAX_AREA,
       :new.FAX_NO,
       :new.FAX_EXT,
       :new.EMAIL,
       :new.CONTACT_ADDRESS_COUNTRY,
       :new.POST_CODE,
       :new.CONTACT_ADDRESS,
       :new.REG_ADDRESS_COUNTRY,
       :new.REG_POST_CODE,
       :new.REG_ADDRESS,
       :new.CURRENT_ADDRESS_COUNTRY,
       :new.CURRENT_POST_CODE,
       :new.CURRENT_ADDRESS,
       :new.REP_NATIONALITY_CODE,
       :new.REPRESENTATIVE,
       :new.REPRESENTATIVE_ID,
       :new.REP_BIRTH_DATE,
       :new.REP_ADDRESS,
       :new.REP_NATIONALITY_CODE1,
       :new.REPRESENTATIVE1,
       :new.REPRESENTATIVE1_ID,
       :new.REP_BIRTH_DATE1,
       :new.REP_ADDRESS1,
       :new.EDM_ACCEPTED,
       :new.NAV_EPAPER,
       :new.US_TAX,
       :new.FATCA_TYPE,
       :new.TAX_COUNTRY1,
       :new.TAX_NUM1,
       :new.TAXNOREASON1,
       :new.TAXATION_REMARK1,
       :new.TAX_COUNTRY2,
       :new.TAX_NUM2,
       :new.TAXNOREASON2,
       :new.TAXATION_REMARK2,
       :new.TAX_COUNTRY3,
       :new.TAX_NUM3,
       :new.TAXNOREASON3,
       :new.TAXATION_REMARK3,
       :new.FIS_CURRENCY_NO_TWD,
       :new.FIS_BANK_NO_TWD,
       :new.FIS_BRANCH_NO_TWD,
       :new.FIS_AC_CODE_TWD,
       :new.FIS_SEAL_DATE_TWD,
       :new.FIS_CURRENCY_NO_FCY,
       :new.FIS_BANK_NO_TWD_FCY,
       :new.FIS_BRANCH_NO_TWD_FCY,
       :new.FIS_AC_CODE_TWD_FCY,
       :new.FIS_SEAL_DATE_FCY,
       :new.TDCC_CURRENCY_NO,
       :new.TDCC_BANK_NO,
       :new.TDCC_BRANCH_NO,
       :new.TDCC_AC_CODE,
       :new.TDCC_SEAL_DATE,
       :new.TDCC_CURRENCY_NO_FCY,
       :new.TDCC_BANK_NO_TWD_FCY,
       :new.TDCC_BRANCH_NO_TWD_FCY,
       :new.TDCC_AC_CODE_TWD_FCY,
       :new.TDCC_SEAL_DATE_FCY,
       :new.MARRIED,
       :new.MARRIED_OTHER,
       :new.MS_NUM_CODE,
       :new.MS_NUM,
       :new.PROFESSION,
       :new.PROFESSION_OTHERS_NEW,
       :new.POSITION,
       :new.POSITION_OTHERS,
       :new.MAJOR_ILLNESS,
       :new.INVEST_CODE,
       :new.INV_KNOWLEDGE,
       :new.INV_KNOWLEDGE_OTHER,
       :new.INV_ORI,
       :new.INV_ORI_OTHER,
       :new.CUST_RESIDENCE_STATUS,
       :new.CUST_RESIDENCE_STATUS_TXT,
       :new.CUST_MIND_STATUS,
       :new.BF_AGE_CODE,
       :new.EDUCATION,
       :new.INV_TOOL,
       :new.INV_EXPERIENCE,
       :new.INV_GOAL,
       :new.INV_FAIL_METHOD,
       :new.FAMILY_INCOME,
       :new.SIGNIFICANT_NEEDS,
       :new.LIQUIDITY_NEEDS,
       :new.PRICE_VOLATILITY,
       :new.GENDAR,
       :new.KYC_SCROE,
       :new.RISK_LEVEL,
       :new.SPONSOR_ID,
       :new.APPLY_DTTM,
       :new.FINISH_DTTM,
       :new.IP_ADDR,
       :new.UPDATE_DTTM,
       :new.CONTACT_CITY,
       :new.CONTACT_AREA,
       :new.REG_CITY,
       :new.REG_AREA,
       :new.EMPLOYER,
       :new.CURRENT_CITY,
       :new.CURRENT_AREA,
       :new.IS_SAME_PERM_ADDR,
       :new.IS_SAME_CURRENT_REG,
       :new.IS_SAME_CURRENT_PERM,
       :new.IS_UPLOAD_PAPERWORK,
       :new.ACCOUNT_NO,
       :new.TDCC_ACCT_NO,
       :new.VULNERABLE_CLAIM
       );
  ELSIF DELETING THEN
    INSERT INTO ECS.HOLDER_TMP_LOG
      (LOGSRNO,
       LOGTIME,
       LOGTYPE,
       ID,
       OPEN_TYPE,
       IS_ES_ACCOUNT,
       NAME,
       STEP_ID,
       FIRST_NAME,
       MIDDLE_NAME,
       LAST_NAME,
       BIRTH_DATE,
       NATIONALITY,
       BIRTH_COUNTRY,
       TEL_H_COUNTRY,
       TEL_H_AREA,
       TEL_H_NO,
       TEL_H_EXT,
       TEL_O_COUNTRY,
       TEL_O_AREA,
       TEL_O_NO,
       TEL_O_EXT,
       MOBILE_COUNTRY,
       MOBILE,
       FAX_COUNTRY,
       FAX_AREA,
       FAX_NO,
       FAX_EXT,
       EMAIL,
       CONTACT_ADDRESS_COUNTRY,
       POST_CODE,
       CONTACT_ADDRESS,
       REG_ADDRESS_COUNTRY,
       REG_POST_CODE,
       REG_ADDRESS,
       CURRENT_ADDRESS_COUNTRY,
       CURRENT_POST_CODE,
       CURRENT_ADDRESS,
       REP_NATIONALITY_CODE,
       REPRESENTATIVE,
       REPRESENTATIVE_ID,
       REP_BIRTH_DATE,
       REP_ADDRESS,
       REP_NATIONALITY_CODE1,
       REPRESENTATIVE1,
       REPRESENTATIVE1_ID,
       REP_BIRTH_DATE1,
       REP_ADDRESS1,
       EDM_ACCEPTED,
       NAV_EPAPER,
       US_TAX,
       FATCA_TYPE,
       TAX_COUNTRY1,
       TAX_NUM1,
       TAXNOREASON1,
       TAXATION_REMARK1,
       TAX_COUNTRY2,
       TAX_NUM2,
       TAXNOREASON2,
       TAXATION_REMARK2,
       TAX_COUNTRY3,
       TAX_NUM3,
       TAXNOREASON3,
       TAXATION_REMARK3,
       FIS_CURRENCY_NO_TWD,
       FIS_BANK_NO_TWD,
       FIS_BRANCH_NO_TWD,
       FIS_AC_CODE_TWD,
       FIS_SEAL_DATE_TWD,
       FIS_CURRENCY_NO_FCY,
       FIS_BANK_NO_TWD_FCY,
       FIS_BRANCH_NO_TWD_FCY,
       FIS_AC_CODE_TWD_FCY,
       FIS_SEAL_DATE_FCY,
       TDCC_CURRENCY_NO,
       TDCC_BANK_NO,
       TDCC_BRANCH_NO,
       TDCC_AC_CODE,
       TDCC_SEAL_DATE,
       TDCC_CURRENCY_NO_FCY,
       TDCC_BANK_NO_TWD_FCY,
       TDCC_BRANCH_NO_TWD_FCY,
       TDCC_AC_CODE_TWD_FCY,
       TDCC_SEAL_DATE_FCY,
       MARRIED,
       MARRIED_OTHER,
       MS_NUM_CODE,
       MS_NUM,
       PROFESSION,
       PROFESSION_OTHERS_NEW,
       POSITION,
       POSITION_OTHERS,
       MAJOR_ILLNESS,
       INVEST_CODE,
       INV_KNOWLEDGE,
       INV_KNOWLEDGE_OTHER,
       INV_ORI,
       INV_ORI_OTHER,
       CUST_RESIDENCE_STATUS,
       CUST_RESIDENCE_STATUS_TXT,
       CUST_MIND_STATUS,
       BF_AGE_CODE,
       EDUCATION,
       INV_TOOL,
       INV_EXPERIENCE,
       INV_GOAL,
       INV_FAIL_METHOD,
       FAMILY_INCOME,
       SIGNIFICANT_NEEDS,
       LIQUIDITY_NEEDS,
       PRICE_VOLATILITY,
       GENDAR,
       KYC_SCROE,
       RISK_LEVEL,
       SPONSOR_ID,
       APPLY_DTTM,
       FINISH_DTTM,
       IP_ADDR,
       UPDATE_DTTM,
       CONTACT_CITY,
       CONTACT_AREA,
       REG_CITY,
       REG_AREA,
       EMPLOYER,
       CURRENT_CITY,
       CURRENT_AREA,
       IS_SAME_PERM_ADDR,
       IS_SAME_CURRENT_REG,
       IS_SAME_CURRENT_PERM,
       IS_UPLOAD_PAPERWORK,
       ACCOUNT_NO,
       TDCC_ACCT_NO,
       VULNERABLE_CLAIM
       )
    VALUES
      (ECS.HOLDER_TMP_LOG_SEQUENCE.NEXTVAL,
       SYSDATE,
       'D',
       :old.ID,
       :old.OPEN_TYPE,
       :old.IS_ES_ACCOUNT,
       :old.NAME,
       :old.STEP_ID,
       :old.FIRST_NAME,
       :old.MIDDLE_NAME,
       :old.LAST_NAME,
       :old.BIRTH_DATE,
       :old.NATIONALITY,
       :old.BIRTH_COUNTRY,
       :old.TEL_H_COUNTRY,
       :old.TEL_H_AREA,
       :old.TEL_H_NO,
       :old.TEL_H_EXT,
       :old.TEL_O_COUNTRY,
       :old.TEL_O_AREA,
       :old.TEL_O_NO,
       :old.TEL_O_EXT,
       :old.MOBILE_COUNTRY,
       :old.MOBILE,
       :old.FAX_COUNTRY,
       :old.FAX_AREA,
       :old.FAX_NO,
       :old.FAX_EXT,
       :old.EMAIL,
       :old.CONTACT_ADDRESS_COUNTRY,
       :old.POST_CODE,
       :old.CONTACT_ADDRESS,
       :old.REG_ADDRESS_COUNTRY,
       :old.REG_POST_CODE,
       :old.REG_ADDRESS,
       :old.CURRENT_ADDRESS_COUNTRY,
       :old.CURRENT_POST_CODE,
       :old.CURRENT_ADDRESS,
       :old.REP_NATIONALITY_CODE,
       :old.REPRESENTATIVE,
       :old.REPRESENTATIVE_ID,
       :old.REP_BIRTH_DATE,
       :old.REP_ADDRESS,
       :old.REP_NATIONALITY_CODE1,
       :old.REPRESENTATIVE1,
       :old.REPRESENTATIVE1_ID,
       :old.REP_BIRTH_DATE1,
       :old.REP_ADDRESS1,
       :old.EDM_ACCEPTED,
       :old.NAV_EPAPER,
       :old.US_TAX,
       :old.FATCA_TYPE,
       :old.TAX_COUNTRY1,
       :old.TAX_NUM1,
       :old.TAXNOREASON1,
       :old.TAXATION_REMARK1,
       :old.TAX_COUNTRY2,
       :old.TAX_NUM2,
       :old.TAXNOREASON2,
       :old.TAXATION_REMARK2,
       :old.TAX_COUNTRY3,
       :old.TAX_NUM3,
       :old.TAXNOREASON3,
       :old.TAXATION_REMARK3,
       :old.FIS_CURRENCY_NO_TWD,
       :old.FIS_BANK_NO_TWD,
       :old.FIS_BRANCH_NO_TWD,
       :old.FIS_AC_CODE_TWD,
       :old.FIS_SEAL_DATE_TWD,
       :old.FIS_CURRENCY_NO_FCY,
       :old.FIS_BANK_NO_TWD_FCY,
       :old.FIS_BRANCH_NO_TWD_FCY,
       :old.FIS_AC_CODE_TWD_FCY,
       :old.FIS_SEAL_DATE_FCY,
       :old.TDCC_CURRENCY_NO,
       :old.TDCC_BANK_NO,
       :old.TDCC_BRANCH_NO,
       :old.TDCC_AC_CODE,
       :old.TDCC_SEAL_DATE,
       :old.TDCC_CURRENCY_NO_FCY,
       :old.TDCC_BANK_NO_TWD_FCY,
       :old.TDCC_BRANCH_NO_TWD_FCY,
       :old.TDCC_AC_CODE_TWD_FCY,
       :old.TDCC_SEAL_DATE_FCY,
       :old.MARRIED,
       :old.MARRIED_OTHER,
       :old.MS_NUM_CODE,
       :old.MS_NUM,
       :old.PROFESSION,
       :old.PROFESSION_OTHERS_NEW,
       :old.POSITION,
       :old.POSITION_OTHERS,
       :old.MAJOR_ILLNESS,
       :old.INVEST_CODE,
       :old.INV_KNOWLEDGE,
       :old.INV_KNOWLEDGE_OTHER,
       :old.INV_ORI,
       :old.INV_ORI_OTHER,
       :old.CUST_RESIDENCE_STATUS,
       :old.CUST_RESIDENCE_STATUS_TXT,
       :old.CUST_MIND_STATUS,
       :old.BF_AGE_CODE,
       :old.EDUCATION,
       :old.INV_TOOL,
       :old.INV_EXPERIENCE,
       :old.INV_GOAL,
       :old.INV_FAIL_METHOD,
       :old.FAMILY_INCOME,
       :old.SIGNIFICANT_NEEDS,
       :old.LIQUIDITY_NEEDS,
       :old.PRICE_VOLATILITY,
       :old.GENDAR,
       :old.KYC_SCROE,
       :old.RISK_LEVEL,
       :old.SPONSOR_ID,
       :old.APPLY_DTTM,
       :old.FINISH_DTTM,
       :old.IP_ADDR,
       :old.UPDATE_DTTM,
       :old.CONTACT_CITY,
       :old.CONTACT_AREA,
       :old.REG_CITY,
       :old.REG_AREA,
       :old.EMPLOYER,
       :old.CURRENT_CITY,
       :old.CURRENT_AREA,
       :old.IS_SAME_PERM_ADDR,
       :old.IS_SAME_CURRENT_REG,
       :old.IS_SAME_CURRENT_PERM,
       :old.IS_UPLOAD_PAPERWORK,
       :old.ACCOUNT_NO,
       :old.TDCC_ACCT_NO,
       :old.VULNERABLE_CLAIM
       );
  END IF;
END;

/
ALTER TRIGGER "ECS"."HOLDER_TMP_LOG_T01" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MARKET_GROUP_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MARKET_GROUP_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.MARKET_GROUP    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."MARKET_GROUP_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MARKET_ID_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MARKET_ID_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.MARKET_ID    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."MARKET_ID_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_ADDITIONAL_PROPERTY_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_ADDITIONAL_PROPERTY_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_ADDITIONAL_PROPERTIES 
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_ADDITIONAL_PROPERTY_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_CATALOGS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_CATALOGS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_CATALOGS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_CATALOGS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_COLUMNS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_COLUMNS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_COLUMNS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_COLUMNS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_CONNECTIONS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_CONNECTIONS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_CONNECTIONS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_CONNECTIONS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_CONSTRAINTS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_CONSTRAINTS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_CONSTRAINTS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_CONSTRAINTS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_CONSTRAINT_DETAILS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_CONSTRAINT_DETAILS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_CONSTRAINT_DETAILS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_CONSTRAINT_DETAILS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_DERIVATIVES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_DERIVATIVES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_DERIVATIVES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_DERIVATIVES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_GROUPS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_GROUPS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_GROUPS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_GROUPS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_GROUP_MEMBERS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_GROUP_MEMBERS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_GROUP_MEMBERS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_GROUP_MEMBERS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_GROUP_PRIVILEGES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_GROUP_PRIVILEGES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_GROUP_PRIVILEGES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_GROUP_PRIVILEGES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_INDEXES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_INDEXES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_INDEXES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_INDEXES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_INDEX_DETAILS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_INDEX_DETAILS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_INDEX_DETAILS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_INDEX_DETAILS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_MIGR_DEPENDENCY_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_MIGR_DEPENDENCY_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_MIGR_DEPENDENCY
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_MIGR_DEPENDENCY_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_MIGR_PARAMETER_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_MIGR_PARAMETER_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_MIGR_PARAMETER
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_MIGR_PARAMETER_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_MIGR_WEAKDEP_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_MIGR_WEAKDEP_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_MIGR_WEAKDEP
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_MIGR_WEAKDEP_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_OTHER_OBJECTS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_OTHER_OBJECTS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_OTHER_OBJECTS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_OTHER_OBJECTS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_PACKAGES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_PACKAGES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_PACKAGES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_PACKAGES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_PRIVILEGES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_PRIVILEGES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_PRIVILEGES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_PRIVILEGES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_PROJECTS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_PROJECTS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_PROJECTS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_PROJECTS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_SCHEMAS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_SCHEMAS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_SCHEMAS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_SCHEMAS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_SEQUENCES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_SEQUENCES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_SEQUENCES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_SEQUENCES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_STORED_PROGRAMS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_STORED_PROGRAMS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_STORED_PROGRAMS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_STORED_PROGRAMS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_SYNONYMS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_SYNONYMS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_SYNONYMS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_SYNONYMS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_TABLESPACES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_TABLESPACES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_TABLESPACES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_TABLESPACES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_TABLES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_TABLES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_TABLES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_TABLES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_TRIGGERS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_TRIGGERS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_TRIGGERS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_TRIGGERS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_USERS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_USERS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_USERS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_USERS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_USER_DEFINED_DATA_TYPES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_USER_DEFINED_DATA_TYPES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_USER_DEFINED_DATA_TYPES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_USER_DEFINED_DATA_TYPES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_USER_PRIVILEGES_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_USER_PRIVILEGES_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_USER_PRIVILEGES
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_USER_PRIVILEGES_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MD_VIEWS_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MD_VIEWS_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MD_VIEWS
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MD_VIEWS_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MIGRLOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MIGRLOG_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MIGRLOG
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MIGRLOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MIGR_DATATYPE_MAP_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MIGR_DATATYPE_MAP_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MIGR_DATATYPE_TRANSFORM_MAP
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MIGR_DATATYPE_MAP_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MIGR_DATATYPE_RULE_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MIGR_DATATYPE_RULE_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MIGR_DATATYPE_TRANSFORM_RULE
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MIGR_DATATYPE_RULE_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger MIGR_GENERATION_ORDER_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."MIGR_GENERATION_ORDER_TRG" 
BEFORE INSERT OR UPDATE ON ECS.MIGR_GENERATION_ORDER
FOR EACH ROW
BEGIN
    if inserting and :new.id is null then
        :new.id := MD_META.get_next_id;
    end if;
END;

/
ALTER TRIGGER "ECS"."MIGR_GENERATION_ORDER_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD074_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD074_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD074
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD074_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD076_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD076_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD076
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD076_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD077_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD077_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD077
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD077_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD700_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD700_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD700
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD700_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD701_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD701_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD701
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD701_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD702_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD702_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD702
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD702_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD703_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD703_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD703
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD703_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD704_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD704_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD704
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD704_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD705_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD705_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD705
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD705_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD706_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD706_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD706
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD706_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD707_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD707_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD707
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD707_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD711_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD711_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD711
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD711_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD712_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD712_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD712
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD712_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OFD713_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OFD713_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OFD713
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OFD713_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OPENACC_DEF_COUPON_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OPENACC_DEF_COUPON_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.OPENACC_DEF_COUPON
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OPENACC_DEF_COUPON_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OPEN_TOKEN_POOL_SRNO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OPEN_TOKEN_POOL_SRNO" 
BEFORE INSERT ON ECS.OPEN_TOKEN_POOL
FOR EACH ROW
  
BEGIN
    SELECT ECS.OPEN_TOKEN_POOL_SRNO_SEQUENCE.NEXTVAL
    INTO :NEW.SRNO
    FROM DUAL;
  END;

/
ALTER TRIGGER "ECS"."OPEN_TOKEN_POOL_SRNO" ENABLE;
--------------------------------------------------------
--  DDL for Trigger OTP_RECORD_SRNO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."OTP_RECORD_SRNO" 
BEFORE INSERT ON ECS.OTP_RECORD
FOR EACH ROW
BEGIN
  SELECT ECS.OTP_RECORD_SEQUENCE.NEXTVAL
  INTO :NEW.SRNO
  FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."OTP_RECORD_SRNO" ENABLE;
--------------------------------------------------------
--  DDL for Trigger REWARD_CHANGE_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."REWARD_CHANGE_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.REWARD_CHANGE
FOR EACH ROW
DECLARE

BEGIN
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."REWARD_CHANGE_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger RSP036_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."RSP036_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.RSP036
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."RSP036_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SHORT_MESSAGE_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SHORT_MESSAGE_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.SHORT_MESSAGE    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."SHORT_MESSAGE_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SQL_LOG_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SQL_LOG_DATAFLAG" 
BEFORE UPDATE OR INSERT ON ECS.SQL_LOG
FOR EACH ROW
DECLARE
  BEGIN
    SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID())
    INTO :NEW.DATA_FLAG
    FROM DUAL;
  END;

/
ALTER TRIGGER "ECS"."SQL_LOG_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SQL_LOG_SRNO_BIR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SQL_LOG_SRNO_BIR" 
BEFORE INSERT ON ECS.SQL_LOG
FOR EACH ROW 
  BEGIN
    SELECT ECS.SQL_LOG_SRNO_SEQUENCE.NEXTVAL
    INTO :NEW.SRNO
    FROM DUAL;
  END;
/
ALTER TRIGGER "ECS"."SQL_LOG_SRNO_BIR" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWMAILCLASS_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWMAILCLASS_TRIGGER_DATAFLAG" 
    before update or insert on ECS.SWMailClass
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."SWMAILCLASS_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWMAILMESSAGELOG_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWMAILMESSAGELOG_TRIDFG" 
    before update or insert on ECS.swmailmessagelog
    for each row
declare
begin
    select sys_guid() into :new.LOGNO from dual;
end;

/
ALTER TRIGGER "ECS"."SWMAILMESSAGELOG_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWMAILMESSAGE_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWMAILMESSAGE_TRG" 
BEFORE INSERT ON ECS.SWMAILMESSAGE
FOR EACH ROW
BEGIN
    IF :new.SENDNO IS NULL THEN
        SELECT SWMAILMESSAGE_id_seq.nextval INTO :new.SENDNO FROM dual;
    END IF;
END;

/
ALTER TRIGGER "ECS"."SWMAILMESSAGE_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWMAILMESSAGE_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWMAILMESSAGE_TRIDFG" 
    before update or insert on ECS.swmailmessage
    for each row
declare
begin
    select sys_guid() into :new.MAILID from dual;
end;

/
ALTER TRIGGER "ECS"."SWMAILMESSAGE_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWMAILTEMPLATE_TRIG_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWMAILTEMPLATE_TRIG_DATAFLAG" 
    before update or insert on ECS.SWMAILTEMPLATE
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."SWMAILTEMPLATE_TRIG_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWPRODUCTSDETAIL_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWPRODUCTSDETAIL_TRIDFG" 
    before update or insert on ECS.swproductsdetail
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."SWPRODUCTSDETAIL_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWPRODUCTS_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWPRODUCTS_TRIDFG" 
    before update or insert on ECS.swproducts
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."SWPRODUCTS_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWSMTP_TRIGGER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWSMTP_TRIGGER_DATAFLAG" 
    before update or insert on ECS.SWSMTP
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."SWSMTP_TRIGGER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SWTIMESENDLOG_TRG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SWTIMESENDLOG_TRG" 
BEFORE INSERT ON ECS.SWTIMESENDLOG
FOR EACH ROW
BEGIN
    IF :new.LOGNO IS NULL THEN
        SELECT SWTIMESENDLOG_id_seq.nextval INTO :new.LOGNO FROM dual;
    END IF;
END;

/
ALTER TRIGGER "ECS"."SWTIMESENDLOG_TRG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger SYSTEM_PARAMETER_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."SYSTEM_PARAMETER_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.SYSTEM_PARAMETER    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."SYSTEM_PARAMETER_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger TODO_TRIDFG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."TODO_TRIDFG" 
    before update or insert on ECS.todo
    for each row
declare
begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;
end;

/
ALTER TRIGGER "ECS"."TODO_TRIDFG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger TOKEN_POOL_SRNO_BIR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."TOKEN_POOL_SRNO_BIR" 
BEFORE INSERT ON ECS.TOKEN_POOL
FOR EACH ROW
  BEGIN
    SELECT ECS.TOKEN_POOL_SRNO_SEQUENCE.NEXTVAL
    INTO :NEW.SRNO
    FROM DUAL;
  END;
/
ALTER TRIGGER "ECS"."TOKEN_POOL_SRNO_BIR" ENABLE;
--------------------------------------------------------
--  DDL for Trigger TRPARAMS_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."TRPARAMS_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.TRPARAMS
FOR EACH ROW
DECLARE

BEGIN 
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;
END;

/
ALTER TRIGGER "ECS"."TRPARAMS_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Trigger TX_CURRENCY_DATAFLAG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE TRIGGER "ECS"."TX_CURRENCY_DATAFLAG" 
  BEFORE UPDATE OR INSERT ON ECS.TX_CURRENCY    
FOR EACH ROW
DECLARE   

BEGIN     
  SELECT UTL_RAW.CAST_TO_RAW(SYS_GUID()) INTO :NEW.DATAFLAG FROM DUAL;   
END;

/
ALTER TRIGGER "ECS"."TX_CURRENCY_DATAFLAG" ENABLE;
--------------------------------------------------------
--  DDL for Procedure CLOBTOBLOB_SQLDEVELOPER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."CLOBTOBLOB_SQLDEVELOPER" 
  ( 
    tableNameL      VARCHAR2 , 
    clobColumnNameL VARCHAR2, 
    blobColumnNameL VARCHAR2 ) 
AS 
  tableName      VARCHAR2 ( 500 ) := '';--to_UPPER(tableNameL); 
  clobColumnName VARCHAR2 ( 500 ) := '';--to_UPPER(clobColumNameL); 
  blobColumnName VARCHAR2 ( 500 ) := '';--to_UPPER(blobColumNameL); 
  tmpString      VARCHAR2 ( 500 ) := ''; 
  errorOut       BOOLEAN          := false; 
  inputLength    NUMBER; -- size of input CLOB 
  offSet         NUMBER := 1; 
  pieceMaxSize   NUMBER := 500;          -- the max size of each peice 
  piece          VARCHAR2 ( 500 CHAR ) ; -- these pieces will make up the entire CLOB 
  currentPlace   NUMBER := 1;            -- this is where were up to in the CLOB 
  blobLoc BLOB;                          -- blob locator in the table 
  clobLoc CLOB;                          -- clob locator pointsthis is the value from the dat file 
  myquery VARCHAR2 ( 2000 ) ; 
  -- THIS HAS TO BE CHANGED FOR SPECIFIC CUSTOMER TABLE 
  -- AND COLUMN NAMES 
  --CURSOR cur; 
TYPE cur_typ 
IS 
  REF 
  CURSOR; 
    cur cur_typ; 
    --cur_rec cur%ROWTYPE; 
  BEGIN 
    tableName      := UPPER ( tableNameL ) ; 
    clobColumnName := UPPER ( clobColumnNameL ) ; 
    blobColumnName := UPPER ( blobColumnNameL ) ; 
    BEGIN 
      EXECUTE immediate 'select table_name from user_tables where table_name = :1 ' INTO tmpString USING tableName; 
      IF ( tmpString != tableName ) THEN 
        errorOut     := true; 
      ELSE 
        BEGIN 
          EXECUTE immediate 'select COLUMN_NAME from user_tab_columns where table_name = :1 and COLUMN_NAME = :2 ' INTO tmpString USING tableName, clobColumnName; 
          IF ( tmpString != clobColumnName ) THEN 
            errorOut     := true; 
          ELSE 
            EXECUTE immediate 'select COLUMN_NAME from user_tab_columns where table_name = :1 and COLUMN_NAME = :2 ' INTO tmpString USING tableName, blobColumnName; 
            IF ( tmpString != blobColumnName ) THEN 
              errorOut     := true; 
            END IF; 
          END IF; 
        END; 
      END IF; 
    EXCEPTION 
    WHEN OTHERS THEN 
      errorOut := true; 
    END; 
    IF ( errorOut = true ) THEN 
      raise_application_error ( -20001, 'Invalid parameters' ) ; 
    END IF; 
    EXECUTE immediate 'update ' || tableName || ' set ' || blobColumnName || '= empty_blob() ' ; 
    myquery := 'SELECT '||clobColumnName||' clob_column , '||blobColumnName||' blob_column FROM ' || tableName || ' FOR UPDATE'; 
    OPEN cur FOR myquery;-- using clobColumName, blobColumnName ; 
    FETCH cur 
       INTO clobLoc, 
      blobLoc ; 

  WHILE cur%FOUND 
  LOOP 
    --RETRIVE THE clobLoc and blobLoc 
    --clobLoc := cur_rec.clob_column; 
    --blobLoc := cur_rec.blob_column; 
    currentPlace := 1; -- reset evertime 
    -- find the lenght of the clob 
    inputLength := DBMS_LOB.getLength ( clobLoc ) ; 
    -- loop through each peice 
    LOOP 
      IF (inputLength > 0) 
      THEN 
      -- get the next piece and add it to the clob 
      piece := DBMS_LOB.subStr ( clobLoc,pieceMaxSize,currentPlace ) ; 
      -- append this piece to the BLOB 
      DBMS_LOB.WRITEAPPEND ( blobLoc, LENGTH ( piece ) /2, HEXTORAW ( piece ) ) ; 
      currentPlace := currentPlace                     + pieceMaxSize ; 
      END IF; 
      EXIT 
    WHEN inputLength < currentplace; 
    END LOOP; 
    FETCH cur 
       INTO clobLoc, 
      blobLoc ; 
  END LOOP; 
  EXECUTE immediate 'alter table ' || tableName || ' drop column ' || clobColumnName; 
  --unnecessary after ddl 
  COMMIT; 
END CLOBtoBLOB_sqldeveloper;

/

  GRANT EXECUTE ON "ECS"."CLOBTOBLOB_SQLDEVELOPER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure FISR11TMP_F2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."FISR11TMP_F2" 
-- =============================================
-- Author:		stu
-- Create date: 2007/11/27
-- Description:	財金外幣扣款回覆
-- 2013/11/11 MOD BY litchi 核印扣款，mapping不到時給99
-- 2019.08.15 tingting 調整為ORACLE版本
-- 2019.11.13 ChengYu 調整扣款進度欄位值，扣款成功代碼為PS00
-- 2020.01.03 ChengYu 更新ECS.PURCHASE【EC申購】時，新增欄位RESULT_CODE(交易結果)
-- =============================================
(
    -- Add the parameters for the function here
    XDATALIST   NVARCHAR2,
    XONLY_KEY   NVARCHAR2,
    ERR_MSG     OUT NVARCHAR2
)
--with encryption
IS
    XNONSUCS_CODE   VARCHAR2(2);
    XSUB_STATUS     VARCHAR2(2);  --2011/02/16, Modify by rgb for 固定為4001及0000
BEGIN

    FOR REC IN (
        SELECT  CP_RCODE
               ,BATCH_ID
               ,BATCH_SRNO
               ,CP_SEQ
          FROM TABLE(ECS.FISR11TMP_F1(XDATALIST,XONLY_KEY)) FISR11TMP_F1
    ) LOOP
    BEGIN

        BEGIN

            SELECT SUB_SUS_CODE         --公司扣款代碼  以"17"加上代碼，必須存在於COD006代碼種類檔中
              INTO XNONSUCS_CODE
              FROM ECS.OFD713 
             WHERE BANK_HQ = 'ALL'
               AND SEAL_TYPE = '3'      --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
               AND BANK_MEDIA_CODE = REC.CP_RCODE;

            -- 2013/11/11 MOD BY litchi 核印扣款，mapping不到時給99
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    XNONSUCS_CODE := '99';

        END;

        -- 2019.11.13 ChengYu 調整扣款進度欄位值，扣款成功代碼為PS00
        XSUB_STATUS := CASE WHEN REC.CP_RCODE IN ('PS00') THEN '2' ELSE '3' END;    --扣款進度 0：未扣款；1：扣款中；2：扣款成功；3：扣款失敗 (CTL014：117)

        /*
        IF REC.CP_SOURCE_ID = '1' THEN --定期定額
        BEGIN
            UPDATE RSP008
               --2011/02/16, Modify by rgb for 固定為4001及0000
               --SET SUB_STATUS = CASE XCP_RCODE WHEN '4001' THEN '2' ELSE '3' END,
                   --BANK_MEDIA_CODE = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XCP_RCODE END,
                   --NONSUCS_CODE  = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XNONSUCS_CODE END,
               SET SUB_STATUS = XSUB_STATUS,
                   BANK_MEDIA_CODE = CASE XSUB_STATUS WHEN '2' THEN '' ELSE XCP_RCODE END,
                   NONSUCS_CODE  = CASE XSUB_STATUS WHEN '2' THEN '' ELSE XNONSUCS_CODE END,
                   SEAL_RTN_TYPE = 'C'
             WHERE BATCH_ID = XCP_BATCH_ID
               AND BATCH_SRNO = XCP_BATCH_SRNO
               AND TRADE_NO = XCP_SEQ
               AND SUB_STATUS = '1';

            IF SQL%RowCount = 0 THEN
            BEGIN
                SET ERR_MSG = XCP_BATCH_ID + '-' + XCP_SEQ + ':找不到定期定額資料';
                RETURN;
            END;
            END IF;

            IF SQL%RowCount > 1 THEN
            BEGIN
                SET ERR_MSG = XCP_BATCH_ID + '-' + XCP_SEQ + ':定期定額設定扣款成功或失敗超過1筆';
                RETURN;
            END;
            END IF;
        END;
        END IF;
        */

        --IF REC.CP_SOURCE_ID = '2' THEN --指定扣款
        BEGIN
            UPDATE ECS.PURCHASE
               --2011/02/16, Modify by rgb for 固定為4001及0000
               --SET SUB_STATUS = CASE XCP_RCODE WHEN '4001' THEN '2' ELSE '3' END,
                   ----20101101, Modify by rgb for 檔案回覆時若為扣款失敗則處理碼更新為作廢
                   --ALLOT_PROC_CODE = CASE XCP_RCODE WHEN '4001' THEN '0' ELSE 'D' END,
                   --BANK_MEDIA_CODE = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XCP_RCODE END,
                   --NONSUCS_CODE  = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XNONSUCS_CODE END,
               SET SUB_STATUS = XSUB_STATUS,                                                    --扣款進度 0：未扣款；1：扣款中；2：扣款成功；3：扣款失敗 (CTL014：117)
                   --20110613, Modify by matt for 原扣款失敗的申購資料,會同時將 OFD221. ALLOT_PROC_CODE = 'D' ，此段規則取消
                   --ALLOT_PROC_CODE = CASE XSUB_STATUS WHEN '2' THEN '0' ELSE 'D' END,
                   BANK_MEDIA_CODE = CASE XSUB_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,   --扣款失敗代碼(扣款行)
                   NONSUCS_CODE = CASE XSUB_STATUS WHEN '2' THEN '' ELSE XNONSUCS_CODE END,     --扣款失敗代碼(公司) 以"17"加上代碼，必須存在於COD006代碼種類檔中
                   -- 2020.01.03 ChengYu 更新ECS.PURCHASE【EC申購】時，新增欄位RESULT_CODE(交易結果)
                   RESULT_CODE = CASE XSUB_STATUS WHEN '2' THEN '00' ELSE '01' END
                   --SEAL_RTN_TYPE = 'C'
             WHERE BATCH_ID = REC.BATCH_ID
               AND BATCH_SRNO = REC.BATCH_SRNO
               AND TRADE_NO = REC.CP_SEQ
               AND SUB_STATUS = '1';            --扣款進度 0：未扣款；1：扣款中；2：扣款成功；3：扣款失敗 (CTL014：117)


            IF SQL%RowCount = 0 THEN
            BEGIN
                ERR_MSG := REC.BATCH_ID || '-' || REC.CP_SEQ || ':找不到一般申購資料';
                RETURN;
            END;
            END IF;

            IF SQL%RowCount > 1 THEN
            BEGIN
                ERR_MSG := REC.BATCH_ID || '-' || REC.CP_SEQ || '一般申購設定扣款成功或失敗超過1筆';
                RETURN;
            END;
            END IF;
        END;
        --END IF;

        /*
        IF (XCP_SOURCE_ID = '3') OR (XCP_SOURCE_ID = '4')  --E/C扣款或IVR扣款
        BEGIN
            UPDATE OFD621A
               --2011/02/16, Modify by rgb for 固定為4001及0000
               --SET SUB_STATUS = CASE XCP_RCODE WHEN '4001' THEN '2' ELSE '3' END,
                   --BANK_MEDIA_CODE = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XCP_RCODE END,
                   --NONSUCS_CODE  = CASE XCP_RCODE WHEN '4001' THEN '' ELSE XNONSUCS_CODE END,
               SET SUB_STATUS = XSUB_STATUS,
                   BANK_MEDIA_CODE = CASE XSUB_STATUS WHEN '2' THEN '' ELSE XCP_RCODE END,
                   NONSUCS_CODE  = CASE XSUB_STATUS WHEN '2' THEN '' ELSE XNONSUCS_CODE END,
                   SEAL_RTN_TYPE = 'C'
             WHERE BATCH_ID = XCP_BATCH_ID
               AND BATCH_SRNO = XCP_BATCH_SRNO
               AND TRADE_NO = XCP_SEQ
               AND SUB_STATUS = '1';

            IF SQL%RowCount = 0 THEN
            BEGIN
                SET ERR_MSG = XCP_BATCH_ID + '-' + XCP_SEQ + ':找不到E/C扣款或IVR扣款申購資料';
                RETURN;
            END;
            END IF;

            IF SQL%RowCount > 1 THEN
            BEGIN
                SET ERR_MSG = XCP_BATCH_ID + '-' + XCP_SEQ + 'E/C扣款或IVR扣款申購設定扣款成功或失敗超過1筆';
                RETURN;
            END;
            END IF;
        END;
        END IF;
        */

    END;
    END LOOP;

END FISR11TMP_F2;

/

  GRANT EXECUTE ON "ECS"."FISR11TMP_F2" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure FISR11TMP_P1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."FISR11TMP_P1" 
-- =============================================
-- Author:      stu
-- Create date: 2007/11/27
-- Description:	財金外幣扣款回覆處理介面
-- 2019.08.15 tingting 調整為ORACLE版本
-- =============================================
(
    -- Add the parameters for the function here
    XDATALIST   NVARCHAR2,
    XONLY_KEY   NVARCHAR2,
    MSG         OUT NVARCHAR2
) 
--with encryption
AS
BEGIN

    IF (XDATALIST <> 'DEL') THEN
    BEGIN
        IF (XDATALIST = 'DEF') THEN
        BEGIN
           ECS.FISR11TMP_F2 ('ALL', XONLY_KEY, MSG);
        END;
        ELSE
        BEGIN
           ECS.FISR11TMP_F2 (XDATALIST, XONLY_KEY, MSG);
        END;
        END IF;
    END;
    END IF;

    DELETE FROM FISR11FST  WHERE ONLY_KEY = XONLY_KEY;
    DELETE FROM FISR11TMP  WHERE ONLY_KEY = XONLY_KEY;
    DELETE FROM FISR11TAIL WHERE ONLY_KEY = XONLY_KEY;

END FISR11TMP_P1;

/

  GRANT EXECUTE ON "ECS"."FISR11TMP_P1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure FISR12TMP_F2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."FISR12TMP_F2" 
-- =============================================
-- Author:      stu
-- Create date: 2007/11/09
-- Description:	財金外幣核印回覆
--              異動相同ACH帳號為FIS的扣款方式
-- 2013/11/11 MOD BY litchi 核印扣款，mapping不到時給99
-- 2016.10.17 Mod By Joyce 取消異動相同ACH帳號為FIS的扣款方式處理
-- 2019.09.06 tingting 調整為ORACLE版本
-- 2019.10.29 ChengYu 修正收檔日期條件判斷式
-- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
-- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
-- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
-- 2020.03.23 ChengYu 調整幣別欄位判斷方式，FAS.HOLDER_BANK_EC【受益人扣款帳號】、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】 MMA、FCY對應ECS.OFD702的幣別ALL
-- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
-- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)
-- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- =============================================
(
    -- Add the parameters for the function here
    XDATALIST   NVARCHAR2,
    XONLY_KEY   NVARCHAR2
    --ERR_MSG     OUT NVARCHAR2
)
--with encryption
IS
    XUpdateDate         DATE;
    XCP_RDATE           NVARCHAR2(10);
    XSEAL_FAIL_ID_CO    VARCHAR2(10);
    XAGENT_BANK         NVARCHAR2(3);
    XSUB_BANK_CODE      VARCHAR2(7);
    XBATCH_ID           VARCHAR2(20);
    --XON_LINE_DATE       DATE;
    --XSEAL_DAY           INT;
    XSEAL_STATUS        VARCHAR2(2);  --2011/02/16, Modify by rgb for 固定為00及13
    -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
    XRSP_NO             VARCHAR2(20);
    XRSP_SRNO           INT;
    XRSP_CHG_NO         VARCHAR2(20);
    XRSP_CHG_SRNO       INT;
    XNEW_OLD            VARCHAR2(6);
    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
    XSOURCE_CD          VARCHAR2(1);
    -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
    --帳號異動檔更新至帳號主檔變數
    CHG_AC_BANK         VARCHAR2(3);
    CHG_AC_BRANCH       VARCHAR2(4);
    CHG_AC_CODE         VARCHAR2(20);
    CHG_AC_NAME         VARCHAR2(100);
    CHG_FIS_SNAME       VARCHAR2(15);
    CHG_CURRENCY_NO     VARCHAR2(3);
    CHG_DEPOSITORY_NO   VARCHAR2(2);
    CHG_NEW_AC_BANK     VARCHAR2(3);
    CHG_NEW_AC_BRANCH   VARCHAR2(4);
    CHG_NEW_AC_CODE     VARCHAR2(20);
    CHG_NEW_AC_NAME     VARCHAR2(100);
    CHG_NEW_FIS_SNAME   VARCHAR2(15);
    CHG_CURRENCY_NO_OLD   VARCHAR2(3);
    CHG_DEPOSITORY_NO_OLD VARCHAR2(2);
BEGIN

  XUpdateDate := SYSDATE;

  SELECT RETURN_DATE
    INTO XCP_RDATE
    FROM ECS.SEALTMP
   WHERE ONLY_KEY = XONLY_KEY;

  /*
  SELECT XON_LINE_DATE = ISNULL(MIN(ON_LINE_DATE),'1900/1/1'),
         XSEAL_DAY = ISNULL(MIN(SEAL_DAY),0)
    FROM CTL015
  */

    FOR REC IN (
        SELECT  CP_TIX
               ,CP_RBANK
               ,CP_RCLNO
               ,CP_RID
               ,CP_DATE
               ,CP_RCODE
               ,CP_SEQ
               ,CP_PBANK
               ,CP_CURTYPE
               ,CREATEID
               ,CP_USERNO
          FROM TABLE(ECS.FISR12TMP_F1(XDATALIST,XONLY_KEY)) FISR12TMP_F1
    ) LOOP
    BEGIN

        /*
        BEGIN

            SELECT SUB_SUS_CODE
              INTO XSEAL_FAIL_ID_CO
              FROM ECS.OFD712
             WHERE BANK_HQ = 'ALL'
               AND SEAL_TYPE = '3'
               AND BANK_MEDIA_CODE = REC.CP_RCODE;

            -- 2013/11/11 MOD BY litchi 核印扣款，mapping不到時給99
            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    XNONSUCS_CODE := '99';

        END;
        */

      --農漁會要抓七碼
      --SELECT XSUB_BANK_CODE = CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN REC.CP_RBANK ELSE ECS.f_GetBankHQ(REC.CP_RBANK) END
      --  FROM OFD020V
      -- WHERE ((SUBSTRING(REC.CP_RBANK, 4, 4) = '0000' AND BANK_BRH = SUBSTRING(REC.CP_RBANK,1,3)) OR
      --        (SUBSTRING(REC.CP_RBANK, 4, 4) <> '0000' AND BANK_BRH = REC.CP_RBANK))

      --先抓取要更新的批號
      SELECT BATCH_ID,
             SUB_BANK_CODE,
             RSP_NO,
             RSP_SRNO,
             RSP_CHG_NO,
             RSP_CHG_SRNO,
             NEW_OLD,
             -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
             SOURCE_CD
        INTO XBATCH_ID,
             XSUB_BANK_CODE,
             -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
             XRSP_NO,
             XRSP_SRNO,
             XRSP_CHG_NO,
             XRSP_CHG_SRNO,
             XNEW_OLD,
             -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
             XSOURCE_CD
        FROM ECS.OFD701
       --WHERE OFD701.SUB_BANK_CODE = XSUB_BANK_CODE
       WHERE (SELECT UNIT_CODE FROM ECS.OFD074 WHERE BANK_HQ = OFD701.SUB_BANK_CODE AND SEAL_TYPE = '3' AND ROWNUM = 1) = REC.CP_RBANK
         -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
         AND SUB_ACC_NO = REC.CP_RCLNO
         AND SUB_ID_NO = REC.CP_RID
         AND SEAL_TYPE = '3'
         --AND ((SEAL_STATUS = '1' AND REC.CP_DATE >= XON_LINE_DATE) OR (SEAL_STATUS <> '2' AND REC.CP_DATE < XON_LINE_DATE) )
         AND SEAL_STATUS = '1'
         -- 2019.10.29 ChengYu 修正收檔日期條件判斷式
         AND TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD') <= TO_DATE(REC.CP_DATE,'YYYYMMDD');

      --已有回覆資料則不更新
      IF (SQL%RowCount <> 0) THEN
      BEGIN

          --先抓取要更新的代理行
          SELECT SUBSTR(CP_SORG,1,3)
            INTO XAGENT_BANK
            FROM FISR12FST
           WHERE FISR12FST.ONLY_KEY = XONLY_KEY;

          --for各核印方式只有一家代理行的情況下
          IF (SQL%RowCount = 0) THEN
          BEGIN
            SELECT DATA_CENTER
              INTO XAGENT_BANK
              FROM ECS.OFD074
             WHERE BANK_HQ = SUBSTR(REC.CP_RBANK,1,3)
               AND SEAL_TYPE = '3'
               AND BANK_SUB_TYPE IN ('1','2','4','5')
               AND ROWNUM = 1;
          END;
          END IF;

          --2011/02/16, Modify by rgb for 固定為00及13
          -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
          --XSEAL_STATUS := CASE WHEN REC.CP_RCODE IN ('00', '13') THEN '2' ELSE '3' END;
          XSEAL_STATUS := CASE WHEN REC.CP_RCODE = '0' THEN '2' ELSE '3' END;

          UPDATE ECS.OFD701
             SET SEAL_STATUS = XSEAL_STATUS,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE 'F' || REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE NVL(XSEAL_FAIL_ID_CO,' ' ) END,
                 RETURN_DATE = CASE WHEN RETURN_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') THEN RETURN_DATE
                                    ELSE TO_DATE(XCP_RDATE,'YYYY/MM/DD') END,
                 RECEIPT_DOC_ID1 = CASE WHEN XSEAL_STATUS = '2' THEN 'N' ELSE RECEIPT_DOC_ID1 END,
                 RECEIPT_DOC_ID2 = CASE WHEN XSEAL_STATUS = '2' THEN RECEIPT_DOC_ID2 ELSE 'N' END
           WHERE OFD701.SUB_BANK_CODE = XSUB_BANK_CODE
             -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
             AND SUB_ACC_NO = REC.CP_RCLNO
             AND SUB_ID_NO = REC.CP_RID
             AND SEAL_TYPE = '3'
             --AND ((SEAL_STATUS = '1' AND REC.CP_DATE >= XON_LINE_DATE) OR (SEAL_STATUS <> '2' AND REC.CP_DATE < XON_LINE_DATE))
             AND SEAL_STATUS = '1'
             -- 2019.10.29 ChengYu 修正收檔日期條件判斷式
             AND TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD') <= TO_DATE(REC.CP_DATE,'YYYYMMDD');

          INSERT INTO ECS.OFD702
                (DATA_SEQ,
                 BATCH_ID,
                 BATCH_SRNO,
                 AGENT_BANK,
                 SUB_BANK_CODE,
                 SUB_ACC_NO,
                 -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
                 RSP_NO,
                 RSP_SRNO,
                 RSP_CHG_NO,
                 RSP_CHG_SRNO,
                 NEW_OLD,
                 ISRETRY,
                 SEAL_TYPE,
                 TRADE_TYPE,
                 TRADE_DATE,
                 SEAL_STATUS,
                 SEAL_FAIL_ID_BK,
                 SEAL_FAIL_ID_CO,
                 SEAL_USER_NO,
                 -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
                 TRADE_NO, SUB_ID_NO, ACC_SUB_ID, STATUS, CreateID,
                 -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
                 -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
                 CreateDate,UpdateID, UpdateDate, EntryID, EntryDate, VerifyID, VerifyDate, ApproveID, ApproveDate,CRNCY_CD,SOURCE_CD)
            VALUES
                ((SELECT NVL(MAX(DATA_SEQ),0) + 1 FROM ECS.OFD702),
                 NVL(XBATCH_ID,'OLD9999999999'),
                 REC.CP_SEQ,
                 NVL(XAGENT_BANK,' '),
                 XSUB_BANK_CODE,
                 REC.CP_RCLNO,
                 -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
                 XRSP_NO,
                 XRSP_SRNO,
                 XRSP_CHG_NO,
                 XRSP_CHG_SRNO,
                 XNEW_OLD,
                 'N',
                 '3',
                 '1',
                 TO_DATE(XCP_RDATE,'YYYY/MM/DD'),
                 XSEAL_STATUS,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 CASE XSEAL_STATUS WHEN '2' THEN '' ELSE 'F' || REC.CP_RCODE END,
                 CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 REC.CP_USERNO,
                 -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位RSP_NO(契約書號)、RSP_SRNO(契約序號)、RSP_CHG_NO(契約變更書號)、RSP_CHG_SRNO(契約變更序號)、NEW_OLD(新舊戶)、ISRETRY(重送碼)、STATUS(資料狀態碼)
                 REC.CP_SEQ, REC.CP_RID, 'ALL', '301', REC.CREATEID,
                 -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
                 -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
                 XUpdateDate, REC.CREATEID, XUpdateDate, REC.CREATEID, XUpdateDate, REC.CREATEID, XUpdateDate, REC.CREATEID, XUpdateDate,REC.CP_CURTYPE,XSOURCE_CD);

          /*
          --根據核印結果,回寫至該帳號所屬的定額契約書中
          UPDATE RSP006
             SET SEAL_STATUS = XSEAL_STATUS,
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_RTN_DATE = CASE WHEN SEAL_RTN_DATE <> '1900/1/1' THEN SEAL_RTN_DATE
                                 ELSE cast(XCP_RDATE as datetime) END,
                 DFT_BNG_SUB_DATE = CASE WHEN XSEAL_STATUS = '2' AND DFT_BNG_SUB_DATE = '1900/1/1' THEN CAST(ECS.f_Nvl(DFT_BNG_SUB_DATE,ECS.f_GetBusinessDay(cast(XCP_RDATE as datetime),'1',XSEAL_DAY)) as DATETIME) ELSE DFT_BNG_SUB_DATE END  --可開始扣款日 = 核印回覆日 + CTL015.SEAL_DAY個公司營業日
           WHERE SUB_BANK_CODE = XSUB_BANK_CODE
             AND ECS.PADRight(SUB_ACCOUNT_NO,16,' ') = REC.CP_RCLNO
             AND ECS.PADRight(SUB_ID_NO,11,' ') = REC.CP_RID
             AND SEAL_STATUS = '1'
             AND SEAL_TYPE = '3'
             AND ((XON_LINE_DATE <= cast(REC.CP_DATE as datetime) AND BATCH_ID = XBATCH_ID) OR XON_LINE_DATE > cast(REC.CP_DATE as datetime));
          */

          /*
          UPDATE RSP013
             SET SEAL_STATUS = XSEAL_STATUS,
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_RTN_DATE = CASE WHEN SEAL_RTN_DATE <> '1900/1/1' THEN SEAL_RTN_DATE
                                 ELSE cast(XCP_RDATE as datetime) END
           WHERE ECS.f_Nvl(AFT_SUB_BANK_CODE,BEF_SUB_BANK_CODE) = XSUB_BANK_CODE
             AND ECS.f_Nvl(ECS.PADRight(AFT_SUB_ACCOUNT_NO,16,' '),ECS.PADRight(BEF_SUB_ACCOUNT_NO,16,' ')) = REC.CP_RCLNO
             AND ECS.f_Nvl(ECS.PADRight(AFT_SUB_ID_NO,11,' '),ECS.PADRight(BEF_SUB_ID_NO,11,' ')) = REC.CP_RID
             AND SEAL_STATUS = '1'
             AND ECS.f_Nvl(AFT_SEAL_TYPE,BEF_SEAL_TYPE) = '3'
             AND IS_SEAL_YN = 'Y'  --變更扣款帳號相關欄位
             --AND CHG_UPD_DTTM = '1900/01/01'  --未生效
             AND ((XON_LINE_DATE <= cast(REC.CP_DATE as datetime) AND BATCH_ID = XBATCH_ID) OR XON_LINE_DATE > cast(REC.CP_DATE as datetime));
          */
          -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
          IF XSOURCE_CD = '3' THEN
          BEGIN
          UPDATE FAS.HOLDER_BANK_EC
             SET --REJECT_CODE = CASE WHEN REC.CP_RCODE <> 0 THEN REC.CP_RCODE ELSE '' END,    --退件原因
                 SEAL_STATUS = XSEAL_STATUS,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE 'F' || REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_DATE = TO_DATE(REC.CP_DATE,'YYYYMMDD'),
                 SEAL_RTN_DATE = TO_DATE(XCP_RDATE,'YYYY/MM/DD'),
                 -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                 VERIFIED = CASE XSEAL_STATUS WHEN '2' THEN TO_DATE(XCP_RDATE,'YYYY/MM/DD') ELSE NULL END,
                 REJECTED = CASE XSEAL_STATUS WHEN '3' THEN TO_DATE(XCP_RDATE,'YYYY/MM/DD') ELSE NULL END,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 REJECT_CODE = CASE XSEAL_STATUS WHEN '3' THEN 'F' || REC.CP_RCODE ELSE '' END,
                 BATCH_ID = XBATCH_ID,
                 TRADE_NO = REC.CP_SEQ
           WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
             AND ID = TRIM(REC.CP_RID)
             AND AC_BANK = SUBSTR(REC.CP_RBANK,1,3)
             -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值、增加存取CRNCY_CD(幣別)欄位
             AND AC_CODE = REC.CP_RCLNO
             -- 2020.03.23 ChengYu 調整幣別欄位判斷方式，FAS.HOLDER_BANK_EC【受益人扣款帳號】、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】 MMA、FCY對應ECS.OFD702的幣別ALL
             AND CASE WHEN CURRENCY_NO = 'MMA' OR CURRENCY_NO = 'FCY' THEN 'ALL' ELSE CURRENCY_NO END = REC.CP_CURTYPE;
          END;
          -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)
          ELSIF XSOURCE_CD = '4' THEN
          BEGIN
          -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
          -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
          UPDATE FAS.HOLDER_BANK_EC_CHANGE
             SET SEAL_STATUS = XSEAL_STATUS,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE 'F' || REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN ' ' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_DATE = TO_DATE(REC.CP_DATE,'YYYYMMDD'),
                 SEAL_RTN_DATE = TO_DATE(XCP_RDATE,'YYYY/MM/DD'),
                 -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                 VERIFIED = CASE XSEAL_STATUS WHEN '2' THEN TO_DATE(XCP_RDATE,'YYYY/MM/DD') ELSE NULL END,
                 REJECTED = CASE XSEAL_STATUS WHEN '3' THEN TO_DATE(XCP_RDATE,'YYYY/MM/DD') ELSE NULL END,
                 -- 2020.03.27 ChengYu 因瀚亞區別外幣扣款與外幣核印錯誤代碼而在外幣核印錯誤代碼開頭加F
                 REJECT_CODE = CASE XSEAL_STATUS WHEN '3' THEN 'F' || REC.CP_RCODE ELSE '' END,
                 BATCH_ID = XBATCH_ID,
                 TRADE_NO = REC.CP_SEQ
           WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
             AND ID = TRIM(REC.CP_RID)
             AND NVL(NEW_AC_BANK,AC_BANK) = SUBSTR(REC.CP_RBANK,1,3)
             AND NVL(NEW_AC_CODE,AC_CODE) = REC.CP_RCLNO
             -- 2020.03.23 ChengYu 調整幣別欄位判斷方式，FAS.HOLDER_BANK_EC【受益人扣款帳號】、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】 MMA、FCY對應ECS.OFD702的幣別ALL
             AND CASE WHEN NVL(CURRENCY_NO,CURRENCY_NO_OLD) = 'MMA' OR NVL(CURRENCY_NO,CURRENCY_NO_OLD) = 'FCY' THEN 'ALL' ELSE CURRENCY_NO END = REC.CP_CURTYPE;

             -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】 
             IF XSEAL_STATUS = '2' THEN
             BEGIN
                SELECT  AC_BANK
                       ,AC_BRANCH
                       ,AC_CODE
                       ,AC_NAME
                       ,FIS_SNAME
                       ,CURRENCY_NO_OLD
                       ,DEPOSITORY_NO_OLD
                       ,NVL(NEW_AC_BANK,AC_BANK)
                       ,NVL(NEW_AC_BRANCH,AC_BRANCH)
                       ,NVL(NEW_AC_CODE,AC_CODE)
                       ,NVL(NEW_AC_NAME,AC_NAME)
                       ,NVL(NEW_FIS_SNAME,FIS_SNAME)
                       ,NVL(CURRENCY_NO,CURRENCY_NO_OLD)
                       ,NVL(DEPOSITORY_NO,DEPOSITORY_NO_OLD)
                  INTO  CHG_AC_BANK
                       ,CHG_AC_BRANCH
                       ,CHG_AC_CODE
                       ,CHG_AC_NAME
                       ,CHG_FIS_SNAME
                       ,CHG_CURRENCY_NO
                       ,CHG_DEPOSITORY_NO
                       ,CHG_NEW_AC_BANK
                       ,CHG_NEW_AC_BRANCH
                       ,CHG_NEW_AC_CODE
                       ,CHG_NEW_AC_NAME
                       ,CHG_NEW_FIS_SNAME
                       ,CHG_CURRENCY_NO_OLD
                       ,CHG_DEPOSITORY_NO_OLD
                  FROM FAS.HOLDER_BANK_EC_CHANGE
                 WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
                   AND ID = TRIM(REC.CP_RID)
                   AND NVL(NEW_AC_BANK,AC_BANK) = SUBSTR(REC.CP_RBANK,1,3)
                   AND NVL(NEW_AC_CODE,AC_CODE) = REC.CP_RCLNO
                   AND CASE WHEN NVL(CURRENCY_NO,CURRENCY_NO_OLD) = 'MMA' OR NVL(CURRENCY_NO,CURRENCY_NO_OLD) = 'FCY' THEN 'ALL' ELSE CURRENCY_NO END = REC.CP_CURTYPE;

                   UPDATE FAS.HOLDER_BANK_EC
                     SET  HOLDER_BANK_EC.AC_BANK = NVL(CHG_NEW_AC_BANK,CHG_AC_BANK)
                         ,HOLDER_BANK_EC.AC_BRANCH = NVL(CHG_NEW_AC_BRANCH,CHG_AC_BRANCH)
                         ,HOLDER_BANK_EC.AC_CODE = NVL(CHG_NEW_AC_CODE,CHG_AC_CODE)
                         ,HOLDER_BANK_EC.AC_NAME = NVL(CHG_NEW_AC_NAME,CHG_AC_NAME)
                         ,HOLDER_BANK_EC.FIS_SNAME = NVL(CHG_NEW_FIS_SNAME,CHG_FIS_SNAME)
                         ,HOLDER_BANK_EC.CURRENCY_NO = NVL(CHG_CURRENCY_NO,CHG_CURRENCY_NO_OLD)
                         ,HOLDER_BANK_EC.DEPOSITORY_NO = NVL(CHG_DEPOSITORY_NO,CHG_DEPOSITORY_NO_OLD)
                         ,HOLDER_BANK_EC.SEAL_STATUS = '2'
                         ,HOLDER_BANK_EC.SEAL_DATE = TO_DATE(REC.CP_DATE,'YYYYMMDD')
                         ,HOLDER_BANK_EC.SEAL_RTN_DATE = TO_DATE(XCP_RDATE,'YYYY/MM/DD')
                         ,HOLDER_BANK_EC.VERIFIED = TO_DATE(XCP_RDATE,'YYYY/MM/DD')
                         ,REJECTED = ''
                         ,HOLDER_BANK_EC.SEAL_FAIL_ID_CO = ' '
                         ,HOLDER_BANK_EC.SEAL_FAIL_ID_BK = ' '
                         ,HOLDER_BANK_EC.REJECT_CODE = ''
                         ,HOLDER_BANK_EC.BATCH_ID = XBATCH_ID
                         ,HOLDER_BANK_EC.TRADE_NO = REC.CP_SEQ
                   WHERE ID = TRIM(REC.CP_RID)
                     AND HOLDER_BANK_EC.AC_BANK = CHG_AC_BANK
                     AND HOLDER_BANK_EC.AC_CODE = CHG_AC_CODE
                     AND HOLDER_BANK_EC.CURRENCY_NO = CHG_CURRENCY_NO_OLD
                     AND HOLDER_BANK_EC.DEPOSITORY_NO = CHG_DEPOSITORY_NO_OLD;

             END;
             END IF;             

          END;
          END IF;
          /*翻成上列寫法
          --20100504, Modify by rgb for 核印回覆時更新OFD607A
          SELECT REMIT_CFM_NO, DATA_SEQ
            INTO #BMS005_TMP
            FROM BMS005
            JOIN OFD020V
              ON OFD020V.BANK_BRH = BMS005.BANK_BRH
           WHERE CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN BMS005.BANK_BRH ELSE ECS.f_GetBankHQ(BMS005.BANK_BRH) END = XSUB_BANK_CODE
             AND ECS.PADRight(ACCOUNT_NO,16,' ') = REC.CP_RCLNO
             AND (SELECT ECS.PADRight(ID_NO,11,' ') FROM BMS001 WHERE BMS001.BF_NO = BMS005.BF_NO) = REC.CP_RID
             --2011/02/16, Modify by rgb for 固定為00及13
             --AND (SEAL_STATUS = '1' OR (SEAL_STATUS = '3' AND REC.CP_RCODE = '00' AND TERMINATE_DATE = '1900/01/01'))
             AND (SEAL_STATUS = '1' OR (SEAL_STATUS = '3' AND XSEAL_STATUS = '2' AND TERMINATE_DATE = '1900/01/01'))
             AND SEAL_TYPE = '3';

          UPDATE OFD607A
             SET PROCESS_YN = 'Y'
            FROM OFD607A
            JOIN OFD601
              ON OFD601.BF_SRNO = OFD607A.BF_SRNO
            JOIN BMS005
              ON BMS005.BF_NO = OFD601.BF_NO
            JOIN #BMS005_TMP A
              ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
             AND A.DATA_SEQ = BMS005.DATA_SEQ;
          --20100517, Modify by rgb for 不過濾A2、B8
          -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

          --根據核印結果,回寫至該帳號所屬的授權帳號中
          UPDATE BMS005
             SET SEAL_STATUS = XSEAL_STATUS,
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_DATE = TO_DATE(REC.CP_DATE,'YYYYMMDD'),
                 SEAL_RTN_DATE = cast(XCP_RDATE as datetime),
                 BATCH_ID = XBATCH_ID,
                 TRADE_NO = REC.CP_SEQ
            FROM BMS005
            JOIN #BMS005_TMP A
              ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
             AND A.DATA_SEQ = BMS005.DATA_SEQ;
          DROP TABLE #BMS005_TMP;
          */

          /* 2019.09.04 tingting FAS.HOLDER_BANK_EC 目前沒有UPDATE權限
          UPDATE FAS.HOLDER_BANK_EC_CHANGE
             SET --REJECT_CODE = CASE WHEN REC.CP_RCODE <> 0 THEN REC.CP_RCODE ELSE '' END,    --退件原因
                 SEAL_STATUS = XSEAL_STATUS,
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_DATE = TO_DATE(REC.CP_DATE,'YYYYMMDD'),
                 SEAL_RTN_DATE = TO_DATE(XCP_RDATE,'YYYY/MM/DD'),
                 BATCH_ID = XBATCH_ID,
                 TRADE_NO = REC.CP_SEQ
           WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
             AND ID = REC.CP_RID
             AND AC_BANK = SUBSTR(REC.CP_RBANK,1,3)
             AND AC_CODE = REC.CP_RCLNO;
          */

          /*翻成上列寫法
          --20100504, Modify by rgb for 核印回覆時更新OFD607A
          SELECT BF_CHG_NO, DATA_SEQ
            INTO #BMS005CHG_TMP
            FROM BMS005CHG
            JOIN OFD020V
              ON OFD020V.BANK_BRH = BMS005CHG.AFT_BANK_BRH
           WHERE CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN BMS005CHG.AFT_BANK_BRH ELSE ECS.f_GetBankHQ(AFT_BANK_BRH) END = XSUB_BANK_CODE
             AND ECS.PADRight(AFT_ACCOUNT_NO,16,' ') = REC.CP_RCLNO
             AND (SELECT ECS.PADRight(AFT_ID_NO,11,' ') FROM BMS001CHG WHERE BMS001CHG.BF_CHG_NO = BMS005CHG.BF_CHG_NO) = REC.CP_RID
             AND SEAL_STATUS = '1'
             AND AFT_SEAL_TYPE = '3'
             AND IS_SEAL_YN = 'Y'; --變更扣款帳號相關欄位

          UPDATE OFD607A
             SET PROCESS_YN = 'Y'
            FROM OFD607A
            JOIN OFD601
              ON OFD601.BF_SRNO = OFD607A.BF_SRNO
            JOIN BMS005CHG
              ON BMS005CHG.BF_NO = OFD601.BF_NO
            JOIN #BMS005CHG_TMP A
              ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
             AND A.DATA_SEQ = BMS005CHG.DATA_SEQ;
          --20100517, Modify by rgb for 不過濾A2、B8
          -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

          --根據核印結果,回寫至該帳號所屬的授權帳號變更書中
          UPDATE BMS005CHG
             SET SEAL_STATUS = XSEAL_STATUS,
                 SEAL_FAIL_ID_BK = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE REC.CP_RCODE END,
                 SEAL_FAIL_ID_CO = CASE XSEAL_STATUS WHEN '2' THEN '' ELSE XSEAL_FAIL_ID_CO END,
                 SEAL_RTN_DATE = cast(XCP_RDATE as datetime),
                 BATCH_ID = XBATCH_ID,
                 TRADE_NO = REC.CP_SEQ
            FROM BMS005CHG
            JOIN #BMS005CHG_TMP A
              ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
             AND A.DATA_SEQ = BMS005CHG.DATA_SEQ
          DROP TABLE #BMS005CHG_TMP;
          */

      END;
      END IF;

    END;
    END LOOP;

END;

/

  GRANT EXECUTE ON "ECS"."FISR12TMP_F2" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure FISR12TMP_P1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."FISR12TMP_P1" 
-- =============================================
-- Author:      stu
-- Create date: 2007/11/27
-- Description:	財金外幣核印回覆處理介面
-- 2019.09.06 tingting 調整為ORACLE版本
-- =============================================
(
    -- Add the parameters for the function here
    XDATALIST   NVARCHAR2,
    XONLY_KEY   NVARCHAR2,
    MSG         OUT NVARCHAR2
) 
--with encryption
AS
BEGIN

    IF (XDATALIST <> 'DEL') THEN
    BEGIN
        IF (XDATALIST = 'DEF') THEN
        BEGIN
            ECS.FISR12TMP_F2 ('ALL', XONLY_KEY);
        END;
        ELSE
        BEGIN
            ECS.FISR12TMP_F2 (XDATALIST, XONLY_KEY);
        END;
        END IF;
    END;
    END IF;

  DELETE FROM FISR12FST  WHERE ONLY_KEY = XONLY_KEY;
  DELETE FROM FISR12TMP  WHERE ONLY_KEY = XONLY_KEY;
  DELETE FROM FISR12TAIL WHERE ONLY_KEY = XONLY_KEY;
  DELETE FROM SEALTMP    WHERE ONLY_KEY = XONLY_KEY;

END;

/

  GRANT EXECUTE ON "ECS"."FISR12TMP_P1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_AA_LOGINLOG_TX
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_AA_LOGINLOG_TX" 
(

  v_stridataid IN CHAR DEFAULT NULL ,

  v_intiLogSrNo IN NUMBER DEFAULT NULL ,

  v_datiLoginDateTime IN DATE DEFAULT sysdate ,
   
  v_intiLoginType IN NUMBER DEFAULT 1 ,

  v_striUserID IN VARCHAR2 DEFAULT ' ' ,

  v_striHostName IN VARCHAR2 DEFAULT ' ' ,

  v_striCreateID IN VARCHAR2 DEFAULT ' ' ,

  v_datiCreateDate IN DATE DEFAULT sysdate ,

  v_striUpdID IN VARCHAR2 DEFAULT ' ' ,

  v_datiUpdDate IN DATE DEFAULT sysdate ,
   
  v_striRecheckID IN VARCHAR2 DEFAULT ' ' ,
  v_datiRecheckDate IN DATE DEFAULT sysdate ,
  v_striReviewID IN VARCHAR2 DEFAULT ' ' ,
  v_datiReviewDate IN DATE DEFAULT sysdate ,
  v_pwdErrorCount IN NUMBER DEFAULT (0) ,
  v_banMark IN NUMBER DEFAULT (0) ,
  --v_tspiDataFlag IN RAW DEFAULT NULL ,
  v_striDBAction IN VARCHAR2 DEFAULT ' ',
  v_strLoginSystem IN VARCHAR2 DEFAULT ' ', 

  v_result out integer
)
AS
m_v_datiCreateDate Date;
m_v_datiUpdDate Date;
m_v_datiRecheckDate Date;
m_v_datiReviewDate Date;
m_v_stridataid CHAR;
BEGIN
   v_result := -1;
   --檢核預設值

   IF v_datiCreateDate IS NULL THEN
      m_v_datiCreateDate := to_date('1900/01/01','YYYY/MM/DD') ;
   ELSE
      m_v_datiCreateDate := v_datiCreateDate;
   END IF;
   IF v_datiUpdDate IS NULL THEN
      m_v_datiUpdDate :=to_date('1900/01/01','YYYY/MM/DD') ;
   ELSE
      m_v_datiUpdDate := v_datiUpdDate;      
   END IF;

   IF v_datiRecheckDate IS NULL THEN
      m_v_datiRecheckDate := to_date('1900/01/01','YYYY/MM/DD') ;
   ELSE
      m_v_datiRecheckDate := v_datiRecheckDate;
   END IF;


   IF v_datiReviewDate IS NULL THEN
      m_v_datiReviewDate := to_date('1900/01/01','YYYY/MM/DD') ;
   ELSE
      m_v_datiReviewDate  := v_datiRecheckDate;
   END IF;



  IF v_striDBAction = 'A' THEN

   BEGIN

      IF v_stridataid = '00000000-0000-0000-0000-000000000000' THEN
         m_v_stridataid := SYS_GUID() ;
      END IF;

   END;
   END IF;

   --判斷DBType
   --A：新增
   --U：修改
   --D：刪除
   --IF v_striDBAction = 'A' THEN

   BEGIN
      INSERT INTO AA_LOGINLOG
        ( dataid,logsrno,
          LoginDateTime, LoginType, UserID, HostName
          , LOGINSYSTEM, ERRORTIMES, BANMARK
        ,status
        , CreateID, CreateDate
        , UpdateID, UpdateDate
        , VerifyID, VerifyDate
        , ApproveID, ApproveDate 
        , RejectID,  RejectDate)

        VALUES 
        ( SYS_GUID(),loginlog_srno.nextval 
        , sysdate, v_intiLoginType, v_striUserID, v_striHostName
        , v_strLoginSystem, v_pwdErrorCount, v_banMark 
        ,'301'
        , v_striCreateID, m_v_datiCreateDate
        , v_striUpdID, m_v_datiUpdDate
        , v_striRecheckID, m_v_datiUpdDate
        , v_striReviewID, m_v_datiUpdDate 
        , v_striUpdID, m_v_datiUpdDate );
        v_result := 1;

        commit;
        exception
        when no_data_found then
        v_result := -1;
        commit;
   END;
   /*
   ELSE
      IF v_striDBAction = 'U' THEN

      BEGIN
         UPDATE AA_LOGINLOG
            SET LoginDateTime = v_datiLoginDateTime,
                LoginType = v_intiLoginType,
                UserID = v_striUserID,
                HostName = v_striHostName,
                CreateID = v_striCreateID,
                CreateDate = v_datiCreateDate,
                UpdateID = v_striUpdID,
                UpdateDate = v_datiUpdDate,
                VerifyID = v_striRecheckID,
                VerifyDate = v_datiRecheckDate,
                ApproveID = v_striReviewID,
                ApproveDate = v_datiReviewDate
            WHERE LogSrNo = v_intiLogSrNo;
      END;
      ELSE
         IF v_striDBAction = 'D' THEN

         BEGIN
            DELETE AA_LOGINLOG

             WHERE LogSrNo = v_intiLogSrNo;
         END;
         END IF;
      END IF;
      */
   --END IF;

END;

/

  GRANT EXECUTE ON "ECS"."S_AA_LOGINLOG_TX" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_AA_USER_CHANGEPWD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_AA_USER_CHANGEPWD" 
(
  v_striUpdateID  IN VARCHAR2 DEFAULT NULL ,
  v_striUserID    IN VARCHAR2 DEFAULT NULL ,
  v_striNewPwd    IN VARCHAR2 DEFAULT NULL,
  v_result        out integer
)
AS
   v_intExpirePeriod NUMBER(10,0);
   v_datExpireDate DATE;
   v_datOldExpireDate DATE;

BEGIN


   --檢核預設值
   IF v_striUserID IS NULL THEN

   BEGIN
      --      RAISERROR('此欄位為PK，不得為空白',16,1)
      raise_application_error( -20002, 's_AA_User_ChangePwd' );
      RETURN;
   END;
   END IF;
   IF v_striNewPwd IS NULL THEN

   BEGIN
      --RAISERROR('新密碼不得空白，請檢查',16,1)
      raise_application_error( -20002, 's_AA_User_ChangePwd' );
      RETURN;
   END;
   END IF;
   --    IF @striOldPwd =@striNewPwd
   --      RAISERROR('新舊密碼不得相同，請檢查',16,1)
   --SQL Statement
   SELECT EXPIREDATE

     INTO v_datOldExpireDate
     FROM AA_User
    WHERE UserID = v_striUserID;
   --取得密碼有效期間的天數
   SELECT PwdChgDay

     INTO v_intExpirePeriod
     FROM AA_SysParam WHERE ROWNUM <= 1;
   --若無資料，預設60天
   IF v_intExpirePeriod IS NULL THEN

   BEGIN
      v_intExpirePeriod := 60 ;
      v_datExpireDate := sqlserver_utilities.dateadd('DAY', v_intExpirePeriod, SYSDATE) ;
   END;

   --若設成0，代表密碼永久有效[ExpireDate=1900/01/01，代表密碼永久有效]
   ELSE
      IF v_intExpirePeriod = 0 THEN
         v_datExpireDate :=to_date('1900/01/01','YYYY/MM/DD') ;

      --變更密碼
      ELSE

      BEGIN
         v_datExpireDate := SYSDATE + v_intExpirePeriod ;
      END;
      END IF;
   END IF;
   UPDATE AA_User
      SET Pwd = v_striNewPwd,
          PwdChangeDate = SYSDATE,
          PwdErrorCount = 0,
          IsForceChangePwd = 0--密碼更改後就不需強迫變更密碼-->0
          ,
          EXPIREDATE = v_datExpireDate,
          UpdateID = v_striUpdateID,
          UpdateDate = SYSDATE
      WHERE UserID = v_striUserID;
      v_result := 1;
      exception
        when no_data_found then
        v_result := -1;
END;

/

  GRANT EXECUTE ON "ECS"."S_AA_USER_CHANGEPWD" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_AA_USER_DISABLE_AUTOJOB
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_AA_USER_DISABLE_AUTOJOB" 
IS
  BATCHNO NUMBER;
  JOBSTATUS NUMBER;
  JOBENDTIME DATE DEFAULT NULL;
  JOBMSG NCLOB DEFAULT NULL;
  PROCESSSTATUS CHAR DEFAULT '0';
  PROCESSCONTENT NCLOB DEFAULT NULL;
  JOBNAME NVARCHAR2(100);
  NOW DATE;
  ERROR1 NCLOB DEFAULT NULL;
BEGIN
  JOBNAME := '超過60天未登入帳號禁用檢查';
  NOW := SYSDATE;

  --建立此次JOBPROCESS
  JOBMSG := '準備執行';
  S_CREATEBATCHJOBPROCESS(NOW,'',JOBNAME,NOW,0,JOBMSG,BATCHNO);

  --寫入「開始執行」的JOB LOG (0尚未執行,1執行中,2執行成功,3執行失敗)
  JOBSTATUS := 1;
  JOBENDTIME := NULL;
  JOBMSG := '開始';
  PROCESSSTATUS := 1;
  PROCESSCONTENT := JOBNAME || ' 開始';
  S_UPDATEBATCHJOBPROCESS(BATCHNO,JOBSTATUS,JOBENDTIME,NULL,JOBMSG,PROCESSSTATUS,PROCESSCONTENT);

  --執行AutoJob排程
  BEGIN
    --新增禁用記錄檔，當超過60天未登入
    INSERT INTO AA_USER_DISABLE_LOG  (USERID,LASTLOGINDATE,LASTSTOPDATE,BANMARK,STOPREASON)
    SELECT RESULT.*
    FROM (
      SELECT B.USERID,NVL(C.LOGINDATETIME,B.LASTLOGINDATE)LASTLOGINDATE,NOW AS LASTSTOPDATE,2 AS BANMARK,1 AS STOPREASON
      FROM AA_USER B
      LEFT JOIN (
        SELECT A.USERID,A.LOGINDATETIME
        FROM (SELECT ROW_NUMBER() OVER (PARTITION BY USERID ORDER BY LOGINDATETIME DESC) AS RN , AA_LOGINLOG.* FROM AA_LOGINLOG) A
        WHERE A.RN = 1
      ) C ON B.USERID = C.USERID
      WHERE B.BANMARK = 1 AND FLOOR(SYSDATE - NVL(C.LOGINDATETIME,B.CREATEDATE)) > 60
    ) RESULT;

    --將帳號設為禁用，當超過60天未登入
    UPDATE AA_USER
    SET BANMARK = 2, LASTSTOPDATE = NOW
    WHERE USERID IN (
      SELECT B.USERID
      FROM AA_USER B
      LEFT JOIN (
        SELECT A.USERID,A.LOGINDATETIME
        FROM (SELECT ROW_NUMBER() OVER (PARTITION BY USERID ORDER BY LOGINDATETIME DESC) AS RN ,AA_LOGINLOG.* FROM AA_LOGINLOG) A
        WHERE A.RN = 1
      ) C ON B.USERID = C.USERID
      WHERE B.BANMARK = 1
      AND FLOOR(SYSDATE - NVL(C.LOGINDATETIME,B.CREATEDATE)) > 60
    );

    COMMIT;
    GOTO SUCCESS;

  EXCEPTION
    WHEN OTHERS
    THEN
      ROLLBACK;
      GOTO FAIL; --DBMS_OUTPUT.PUT_LINE(SQLCODE);
  END;

  --寫入「執行成功」的JOB LOG (0尚未執行,1執行中,2執行成功,3執行失敗)
  <<SUCCESS>>
  JOBSTATUS := 2;
  JOBENDTIME := SYSDATE;
  JOBMSG := '執行成功';
  PROCESSSTATUS := 1;
  PROCESSCONTENT := JOBNAME || ' 執行成功';
  S_UPDATEBATCHJOBPROCESS(BATCHNO,JOBSTATUS,JOBENDTIME,NULL,JOBMSG,PROCESSSTATUS,PROCESSCONTENT);
  GOTO FINALLY;

  --寫入「執行失敗」的JOB LOG (0尚未執行,1執行中,2執行成功,3執行失敗)
  <<FAIL>>
  JOBSTATUS := 3;
  JOBENDTIME := SYSDATE;
  JOBMSG := '執行失敗';
  PROCESSSTATUS := 0;
  PROCESSCONTENT := JOBNAME || ' 執行失敗';
  S_UPDATEBATCHJOBPROCESS(BATCHNO,JOBSTATUS,JOBENDTIME,NULL,JOBMSG,PROCESSSTATUS,PROCESSCONTENT);
  GOTO FINALLY;

  --寫入「執行完成」的JOB LOG
  <<FINALLY>>
  PROCESSCONTENT := '結束';
  S_CREATEBATCHJOBLOG(BATCHNO,PROCESSSTATUS,PROCESSCONTENT,ERROR1);

END S_AA_USER_DISABLE_AUTOJOB;

/

  GRANT EXECUTE ON "ECS"."S_AA_USER_DISABLE_AUTOJOB" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ADDBULLETIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ADDBULLETIN" 
(
  v_Status      IN VARCHAR2 , 
  v_CreateID    IN VARCHAR2 ,
  v_CreateDate  IN DATE  ,
  v_UpdateID    IN VARCHAR2 ,
  v_UpdateDate  IN DATE  ,
  v_EntryID     IN VARCHAR2 ,
  v_EntryDate   IN DATE  ,
  v_VerifyID    IN VARCHAR2 ,
  v_VerifyDate  IN DATE  ,
  v_RejectID    IN VARCHAR2 ,
  v_RejectDate  IN DATE  ,
  v_ApproveID   IN VARCHAR2 ,
  v_ApproveDate IN DATE  ,
  v_dataid      IN NCHAR,
  v_Message			IN VARCHAR2,
  v_Title       IN VARCHAR2,          
  v_IsActive    IN Number,          
  v_BeginDate   IN Date,          
  v_EndDate     IN Date,  
  v_result out integer
)
AS
m_SrNO  NUMBER(5,0):=0;
begin

select AA_BULLETIN_SRNO_SEQ.Nextval
into m_SrNO
from dual;


INSERT INTO  AA_Bulletin           
           (
            SrNO
           ,Message              
           ,Title                
           ,IsActive             
           ,BeginDate            
           ,EndDate              
           ,dataid               
           ,Status               
           ,CreateID             
           ,CreateDate           
           ,UpdateID             
           ,UpdateDate           
           ,EntryID              
           ,EntryDate            
           ,VerifyID             
           ,VerifyDate           
           ,RejectID             
           ,RejectDate           
           ,ApproveID            
           ,ApproveDate)         
     VALUES                        
           (
            m_SrNO
           ,v_Message               
           ,v_Title                 
           ,v_IsActive              
           ,v_BeginDate             
           ,v_EndDate               
           ,v_dataid                
           ,v_Status                
           ,v_CreateID              
           ,v_CreateDate            
           ,v_UpdateID              
           ,v_UpdateDate            
           ,v_EntryID               
           ,v_EntryDate             
           ,v_VerifyID              
           ,v_VerifyDate            
           ,v_RejectID              
           ,v_RejectDate            
           ,v_ApproveID             
           ,v_ApproveDate) ;         

           v_result := m_SrNO;


end s_AddBulletin;

/

  GRANT EXECUTE ON "ECS"."S_ADDBULLETIN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ADDBYPASSHISTORY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ADDBYPASSHISTORY" 
(
  v_ByPassUserID IN NVARCHAR2,
--v_Status      IN NVARCHAR2 , --直接給值302
  v_CreateID    IN NVARCHAR2 ,
  v_CreateDate  IN DATE  ,
  v_UpdateID    IN NVARCHAR2 ,
  v_UpdateDate  IN DATE  ,
  v_EntryID     IN NVARCHAR2 ,
  v_EntryDate   IN DATE  ,
  v_VerifyID    IN NVARCHAR2 ,
  v_VerifyDate  IN DATE  ,
  v_RejectID    IN NVARCHAR2 ,
  v_RejectDate  IN DATE  ,
  v_ApproveID   IN NVARCHAR2 ,
  v_ApproveDate IN DATE  ,
  v_ByPassAction IN NVARCHAR2,
  v_ByPassDataID IN NCHAR,
  v_ByPassFunctionID IN NVARCHAR2,
  v_LastApproveDate IN DATE  ,
  v_ByPassUpdateDate IN DATE,
  v_dataid IN NCHAR,
  v_InputDataStatuscode Nvarchar2,--準備作EVA的那筆data的status code
  v_Permission_EVAFlowKind NVarchar2,--PermissionInfo中的EVAFlowKind
  v_result out integer
)
AS
m_HistoryID  NUMBER(5,0):=0;
begin

if(v_Permission_EVAFlowKind = 1)or(substr(v_InputDataStatuscode,1,1)= u'3')
Then 
--覆核後新增的第一筆ByPass前，先把將舊的ByPass資料搬移至LOG檔再刪除

Begin
      Insert into tempByPassLog
      Select
        ByPassHistory.HistoryID,
        ByPassHistoryDtl.HistorySrNo,        
        ByPassHistory.ByPassUserID,
        ByPassHistory.ByPassFunctionID,
        ByPassHistory.ByPassDataID,
        ByPassHistory.ByPassAction,
        ByPassHistory.ByPassUpdateDate,
        ByPassHistory.Status,
        ByPassHistory.CreateID,
        ByPassHistory.CreateDate,
        ByPassHistory.EntryID,
        ByPassHistory.EntryDate,
        ByPassHistory.UpdateID,
        ByPassHistory.UpdateDate,
        ByPassHistory.VerifyID,
        ByPassHistory.VerifyDate,
        ByPassHistory.ApproveID,
        ByPassHistory.ApproveDate,
        ByPassHistoryDtl.Bypassmsg,
        ByPassHistory.dataflag
      from ByPassHistory
      inner join ByPassHistoryDtl
      on ByPassHistory.HistoryID = ByPassHistoryDtl.HistoryID
      Where     ByPassHistory.HistoryID         = ByPassHistoryDtl.HistoryID
        And     ByPassHistory.ByPassDataID      = v_ByPassDataID
        And     ByPassHistory.ByPassFunctionID  = v_ByPassFunctionID
        And     to_char(ByPassHistory.ByPassUpdateDate,'DD-MON-YYYY HH24:MI:SSSSS' )
                <= to_char(v_LastApproveDate,'DD-MON-YYYY HH24:MI:SSSSS' )  ;


      Delete ByPassHistory
      where ByPassHistory.HistoryID in (Select HistoryID from tempByPassLog);


      Delete ByPassHistoryDtl
      where ByPassHistoryDtl.HistoryID in (Select HistoryID from tempByPassLog);
END;
end if;

Insert into ByPassHistory_Log
Select * from tempByPassLog  ;


select BYPASSHISTORY_HISTORYID_SEQ.Nextval
into m_HistoryID
from dual;


INSERT INTO  ByPassHistory
           (

           HistoryID
           ,ByPassUserID
           , ByPassFunctionID
           , ByPassDataID
           , ByPassAction
           , ByPassUpdateDate
           , dataid
           , Status
           , CreateID
           , CreateDate
           , UpdateID
           , UpdateDate
           , EntryID
           , EntryDate
           , VerifyID
           , VerifyDate
           , RejectID
           , RejectDate
           , ApproveID
           , ApproveDate

            )
      VALUES
            (            
             m_HistoryID
            ,v_ByPassUserID
            ,v_ByPassFunctionID
            ,v_ByPassDataID
            ,v_ByPassAction
            ,v_ByPassUpdateDate
            ,v_dataid
            ,'302'
            ,v_CreateID
            ,v_CreateDate
           ,v_UpdateID
           ,v_UpdateDate
           ,v_EntryID
           ,v_EntryDate
           ,v_VerifyID
           ,v_VerifyDate
           ,v_RejectID
           ,v_RejectDate
           ,v_ApproveID
           ,v_ApproveDate) ;

           v_result := m_HistoryID;        


end s_AddByPassHistory;

/

  GRANT EXECUTE ON "ECS"."S_ADDBYPASSHISTORY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ADDOBSERVATIONFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ADDOBSERVATIONFUNDDATA" 
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WFUNDNO_ISINCODE       VARCHAR2,          -- 基金代碼;國際證券代碼,基金代碼;國際證券代碼
     OUTDT                  OUT SYS_REFCURSOR  -- AddObservationErrList
) IS

XID VARCHAR2(10);          -- 受益人ID
XWARNS_TYPE VARCHAR2(1);   -- 警示方式
XERROR_MSG  VARCHAR2(100); -- 錯誤訊息
XDATA_NUM   INTEGER;       -- 資料筆數
XERR_FORM   VARCHAR(1);    -- 錯誤來源
XCOUNT      INTEGER;       --資料表資料筆數

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        XWARNS_TYPE := '3';
        XERROR_MSG := '無法取得受益人ID，請檢查！';
        XERR_FORM := '1';
        GOTO TO_ERR;                                
  END;  

    -- 傳入筆數
    SELECT COUNT(1)
      INTO XDATA_NUM
      FROM (SELECT  LINE.VALUE1 AS WFUND_NO   -- 基金代碼
                   ,LINE.VALUE2 AS WISIN_CODE -- 申購幣別
              FROM (TABLE(ECS.F_FormatStringListToTable(WFUNDNO_ISINCODE))
                     )LINE
           ) TB_FUND_ISIN;

    FOR I IN 1..XDATA_NUM LOOP

      -- 以傳入參數:基金代碼、國際證券代碼 找出不在基金主檔上的資料組合成錯誤訊息(XERROR_MSG)
      SELECT  '2' AS ERR_FORM
             ,'3' AS WARNS_TYPE
             ,CASE WHEN TB_FUND_FINAL.FUND_NO IS NULL THEN TRIM(CONCAT(XERROR_MSG,TB_FUND_FINAL.INPUT_FUND_NO||';'||TB_FUND_FINAL.INPUT_ISIN_CODE||','))
                   ELSE XERROR_MSG
              END AS ERROR_MSG
        INTO  XERR_FORM
             ,XWARNS_TYPE
             ,XERROR_MSG
        FROM (SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             ELSE ''
                        END AS FUND_NO
                      ,TB_FUND.VALUE1 AS INPUT_FUND_NO
                      ,TB_FUND.VALUE2 AS INPUT_ISIN_CODE
                      ,ROWNUM() AS NUM
                FROM (TABLE(ECS.F_FormatStringListToTable(WFUNDNO_ISINCODE))
                     )TB_FUND
                LEFT JOIN FAS.FUND FUND_FUND_NO    -- 基金主檔(基金代碼去找)
                  ON FUND_FUND_NO.FUND_NO = TB_FUND.VALUE1
                LEFT JOIN FAS.FUND FUND_ISIN_CODE  -- 國際證券代碼(國際證券代碼去找)
                  ON FUND_ISIN_CODE.ISIN_CODE = TB_FUND.VALUE2
             ) TB_FUND_FINAL
       WHERE TB_FUND_FINAL.NUM = I;

    END LOOP;

    -- 2018.10.03 ChengYu 檢查停損停利到價通知(WPS.FUND_ALERT)是否已經有資料 BEGIN
    SELECT COUNT(1) AS COUNT
      INTO XCOUNT
      FROM WPS.FUND_ALERT
      JOIN (SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             ELSE ''
                        END AS FUND_NO
              FROM (TABLE(ECS.F_FormatStringListToTable(WFUNDNO_ISINCODE))
                   )TB_FUND
              LEFT JOIN FAS.FUND FUND_FUND_NO    -- 基金主檔(基金代碼去找)
                ON FUND_FUND_NO.FUND_NO = TB_FUND.VALUE1
              LEFT JOIN FAS.FUND FUND_ISIN_CODE  -- 國際證券代碼(國際證券代碼去找)
                ON FUND_ISIN_CODE.ISIN_CODE = TB_FUND.VALUE2
           ) TB_DATA 
        ON TB_DATA.FUND_NO = FUND_ALERT.FUND_NO
      LEFT JOIN ECS.MSGINFO MSGINFO_T012
        ON MSGINFO_T012.MSGID = 'T012'
     WHERE FUND_ALERT.ID = XID
       AND FUND_ALERT.TYPE = '1';

    IF XCOUNT > 0 THEN
      BEGIN
        SELECT  '3' AS ERR_FORM
               ,MSGINFO_T012.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T012.MSGCONTENT AS ERROR_MSG
          INTO  XERR_FORM
               ,XWARNS_TYPE 
               ,XERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T012
         WHERE MSGINFO_T012.MSGID = 'T012';
      END;
    END IF;

    IF XERROR_MSG IS NOT NULL THEN 
      GOTO TO_ERR;      
    ELSE
      XERR_FORM := '';
      XWARNS_TYPE := '';       
    END IF ;

    -- 2018.10.03 ChengYu 檢查停損停利到價通知(WPS.FUND_ALERT)是否已經有資料 END

    INSERT INTO WPS.FUND_ALERT
         (
            FUND_ALERT.ID 
           ,FUND_ALERT.FUND_NO 
           ,FUND_ALERT.TYPE
         )
    SELECT  XID      AS ID
           ,TB_FUND_FINAL.FUND_NO AS FUND_NO
           ,'1'      AS TYPE
      FROM (SELECT  CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                         WHEN FUND_ISIN.FUND_NO IS NOT NULL THEN FUND_ISIN.FUND_NO
                         ELSE NULL
                    END AS FUND_NO
                   ,WFUND_NO AS INPUT_FUND_NO
                   ,WISIN_CODE AS INPUT_ISIN_CODE
                   ,ROWNUM AS NUM
              FROM (SELECT  LINE.VALUE1 AS WFUND_NO   -- 基金代碼
                           ,LINE.VALUE2 AS WISIN_CODE -- 申購幣別
                      FROM (TABLE(ECS.F_FormatStringListToTable(WFUNDNO_ISINCODE))
                           )LINE
                   ) TB_FUND_ISIN
              LEFT JOIN FAS.FUND FUND_FUND_NO
                ON FUND_FUND_NO.FUND_NO = TB_FUND_ISIN.WFUND_NO
              LEFT JOIN FAS.FUND FUND_ISIN
                ON FUND_ISIN.ISIN_CODE = TB_FUND_ISIN.WISIN_CODE
           ) TB_FUND_FINAL;    

      <<TO_ERR>>
      -- AddObservationErrList
      OPEN OUTDT FOR
    SELECT  XWARNS_TYPE AS WARNS_TYPE
           ,CASE WHEN XERR_FORM ='2' THEN '(FUND_NO;ISINCODE):'|| SUBSTR(XERROR_MSG,1,LENGTH(XERROR_MSG)-1)||' 找不到基金代碼' 
                 ELSE XERROR_MSG
            END AS ERROR_MSG
      FROM DUAL
     WHERE XERROR_MSG IS NOT NULL;

END s_AddObservationFundData;

/

  GRANT EXECUTE ON "ECS"."S_ADDOBSERVATIONFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ADDSHOPPINGCARTMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ADDSHOPPINGCARTMP" 
(
     WACCOUNT_NO            INTEGER,                -- 受益人戶號
     WSHOP_CART_DATA        VARCHAR2,               -- 交易日期
     WIP_A                  VARCHAR2,               -- IP位址A
     WIP_B                  VARCHAR2,               -- IP位址B
     WIP_C                  VARCHAR2,               -- IP位址C
     WIP_D                  VARCHAR2,               -- IP位址D
     OUTDT                  OUT SYS_REFCURSOR       -- MASTER
     
) IS

XSYS_DTTM DATE:=SYSDATE; -- 查詢日期
XID VARCHAR2(10);        -- 受益人ID
XDATE_NUM INTEGER;       -- 資料筆數

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  -- 購物車紀錄檔是否有重複的資料存在
  SELECT COUNT(1)
    INTO XDATE_NUM
    FROM ECS.SHOP_CART SHOP_CART
   WHERE SHOP_CART.ID = XID;

  IF(XDATE_NUM > 0 ) THEN

    OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO.MSGTYPE AS WARNS_TYPE
               ,MSGINFO.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO
         WHERE MSGINFO.MSGID = 'T011';

  ELSE 

    OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS
               ,'' AS WARNS_TYPE 
               ,'' AS ERROR_MSG
          FROM DUAL;

    INSERT INTO ECS.SHOP_CART SHOP_CART
         (
            SHOP_CART.ID
           ,SHOP_CART.SHOP_CART_DATA
           ,SHOP_CART.IP_A
           ,SHOP_CART.IP_B
           ,SHOP_CART.IP_C
           ,SHOP_CART.IP_D
           ,SHOP_CART.CREATION_DATE
         )
    SELECT  XID AS ID
           ,WSHOP_CART_DATA AS SHOP_CART_DATA
           ,WIP_A AS IP_A
           ,WIP_B AS IP_B
           ,WIP_C AS IP_C
           ,WIP_D AS IP_D
           ,XSYS_DTTM AS CREATION_DATE
      FROM DUAL;

  END IF;

END s_AddShoppingCarTmp;

/

  GRANT EXECUTE ON "ECS"."S_ADDSHOPPINGCARTMP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ADDTABLEDATAFLAGANDTRIGGER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ADDTABLEDATAFLAGANDTRIGGER" (tableName in VARCHAR2)

 AS
  v_tablename   varchar2(30);
  v_TriggerName varchar2(100);
  v_statement   varchar2(1000);

begin
  --取得table name,並組成trigger name
  v_tablename   := tableName;
  v_TriggerName := tableName || '_Trigger_DataFlag';
  --新增 DataFlag 欄位,但新設為Nullable
  v_statement := 'Alter TABLE ' || v_tablename ||
                 ' add  DataFlag RAW(32) null';
  EXECUTE IMMEDIATE v_statement;
  COMMIT;
  --update DataFlag value
  v_statement := '
update  ' || v_tablename || '
 set DATAFLAG = utl_raw.cast_to_raw(sys_guid())
where 1=1 ';
  EXECUTE IMMEDIATE v_statement;
  COMMIT;
  --修改DataFlag欄位,改為 not null
  v_statement := '
Alter table ' || v_tablename || '
 modify  DataFlag RAW(32)  not null';
  EXECUTE IMMEDIATE v_statement;
  COMMIT;
  --create trigger,但 DB Login帳號須有create Trigger的權限,
  --GRANT CREATE ANY TRIGGER TO [DB Login帳號]
  EXECUTE IMMEDIATE '
    create or replace trigger ' || v_TriggerName || '
     before update or insert on ' || v_tablename || '
    for each row
  declare

  begin
    select utl_raw.cast_to_raw(sys_guid()) into :new.dataflag from dual;

  end;';
  COMMIT;
end s_AddTableDataFlagAndTrigger;

/

  GRANT EXECUTE ON "ECS"."S_ADDTABLEDATAFLAGANDTRIGGER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_ADD_BROWSER_LOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_ADD_BROWSER_LOG" 
(   
    WUSER_CODE              IN VARCHAR2,
    WCOMPANY_CODE           IN VARCHAR2,
    WTOKEN_ID               IN VARCHAR2,
    WSESSION_ID             IN VARCHAR2,
    WBROWSER_DATE           IN VARCHAR2,
    WIP_ADDR                IN VARCHAR2,
    WBROWSER_PAGE           IN VARCHAR2,
    WFUNCTION_CODE          IN VARCHAR2,
    WACTION_NAME            IN VARCHAR2,
    WDATA_ID                IN VARCHAR2,
    OUTDT                   OUT SYS_REFCURSOR
) IS

--變數宣告
XIS_SUCCESSFUL    INTEGER;
XMESSAGE          NVARCHAR2(200);
XRESULT_CODE      VARCHAR2(10);
XBROWSER_DATE     TIMESTAMP;
XSYS_ID           VARCHAR2(10);

BEGIN

  -- 指定變數
  XIS_SUCCESSFUL := 1;                         -- 1：代表成功；0：代表失敗
  XMESSAGE       := '新增 SQL_LOG 成功';       -- 執行訊息
  XRESULT_CODE   := '0';                       -- 訊息代碼
  XSYS_ID        :='SYSTEM';

  BEGIN
    SELECT 
       To_date(WBROWSER_DATE, 'yyyy/mm/dd hh24:mi:ss')
       INTO XBROWSER_DATE 
    FROM DUAL;
     EXCEPTION
       WHEN OTHERS THEN
           XIS_SUCCESSFUL := 0;
           XMESSAGE := SUBSTR(SQLERRM, 1, 200) ; --'紀錄 BROWSER LOG 時，轉換 BROWSER_DATE 發生異常 ，請連絡系統管理員';
           XRESULT_CODE := '1';
           Raise_application_error(-20000, xMESSAGE);
           GOTO TO_END;
  END;   

  --雖然有傳入 CreateDate, UpdateDate，但是不用
  --還是一律以 sp 的執行時間為主
  -- CreateID, UpdateID，則一律用 SYSTEM 帳號寫入

  -- 紀錄一筆 BROWSER LOG
  BEGIN
        INSERT INTO ECS.BROWSER_LOG
        (
              USER_CODE
             ,COMPANY_CODE
             ,TOKEN_ID
             ,SESSION_ID
             ,BROWSER_DATE
             ,IP_ADDR
             ,BROWSER_PAGE
             ,FUNCTION_CODE
             ,ACTION_NAME
             ,DATA_ID
             ,CREATE_ID
             ,CREATE_DATE
             ,UPDATE_ID
             ,UPDATE_DATE
         )
         VALUES
         (
              WUSER_CODE
             ,WCOMPANY_CODE
             ,WTOKEN_ID
             ,WSESSION_ID
             ,XBROWSER_DATE
             ,WIP_ADDR
             ,WBROWSER_PAGE
             ,WFUNCTION_CODE
             ,WACTION_NAME
             ,WDATA_ID
             ,XSYS_ID
             ,SYSDATE
             ,XSYS_ID
             ,SYSDATE
         );

    EXCEPTION
       WHEN OTHERS THEN
           XIS_SUCCESSFUL := 0;
           XMESSAGE := SUBSTR(SQLERRM, 1, 200) ;
           XRESULT_CODE := '1';
           Raise_application_error(-20000, '紀錄 BROWSER LOG 發生異常 ，請連絡系統管理員\r\n' + xMESSAGE);
           GOTO TO_END;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT XIS_SUCCESSFUL AS ISSUCCESSFAUL, XMESSAGE AS MESSAGE, XRESULT_CODE AS RESULTCODE
    FROM DUAL;


END S_API_ADD_BROWSER_LOG;

/

  GRANT EXECUTE ON "ECS"."S_API_ADD_BROWSER_LOG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_ADD_SQL_LOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_ADD_SQL_LOG" (
       WUSER_CODE            IN VARCHAR2,
       WCOMPANY_CODE         IN VARCHAR2,
       WTOKEN_ID             IN VARCHAR2,
       WSESSION_ID           IN VARCHAR2,
       WIP_ADDR              IN VARCHAR2,
       WFUNCTION_CODE        IN VARCHAR2,
       WLOG_TIME             IN VARCHAR2,
       WCOMMAND_TYPE         IN VARCHAR2,
       WCOMMAND_TEXT         IN VARCHAR2,
       WDATA_ID              IN VARCHAR2,
       OUTDT                 OUT SYS_REFCURSOR
  ) IS

--變數宣告
XIS_SUCCESSFUL    INTEGER;
XMESSAGE          NVARCHAR2(200);
XRESULT_CODE      VARCHAR2(10);
XLOG_TIME         TIMESTAMP;
XSYS_ID           VARCHAR2(10);

BEGIN

  -- 指定變數
  XIS_SUCCESSFUL := 1;                         -- 1：代表成功；0：代表失敗
  XMESSAGE       := '新增 SQL_LOG 成功';       -- 執行訊息
  XRESULT_CODE   := '0';                       -- 訊息代碼
  XSYS_ID        :='SYSTEM';

  BEGIN

    SELECT
       To_date(WLOG_TIME, 'yyyy/mm/dd hh24:mi:ss')
       INTO XLOG_TIME
    FROM DUAL;
     EXCEPTION
       WHEN OTHERS THEN
           XIS_SUCCESSFUL := 0;
           XMESSAGE := SUBSTR(SQLERRM, 1, 200) ; --'紀錄 BROWSER LOG 時，轉換 BROWSER_DATE 發生異常 ，請連絡系統管理員';
           XRESULT_CODE := '1';
           Raise_application_error(-20000, xMESSAGE);
           GOTO TO_END;
  END;

  --雖然有傳入 CreateDate, UpdateDate，但是不用
  --還是一律以 sp 的執行時間為主
  -- CreateID, UpdateID，則一律用 SYSTEM 帳號寫入

  -- 紀錄一筆 sql log
  BEGIN

     INSERT INTO ECS.SQL_LOG
     (
         USER_CODE
        ,COMPANY_CODE
        ,TOKEN_ID
        ,SESSION_ID
        ,IP_ADDR
        ,FUNCTION_CODE
        ,LOG_TIME
        ,COMMAND_TYPE
        ,COMMAND_TEXT
        ,DATA_ID
        ,CREATE_ID
        ,CREATE_DATE
        ,UPDATE_ID
        ,UPDATE_DATE
     )
     VALUES
     (
         WUSER_CODE
        ,WCOMPANY_CODE
        ,WTOKEN_ID
        ,WSESSION_ID
        ,WIP_ADDR
        ,WFUNCTION_CODE
        ,XLOG_TIME
        ,WCOMMAND_TYPE
        ,WCOMMAND_TEXT
        ,WDATA_ID
        ,XSYS_ID
        ,SYSDATE
        ,XSYS_ID
        ,SYSDATE
     );


    EXCEPTION
       WHEN OTHERS THEN
           XIS_SUCCESSFUL := 0;
           XMESSAGE := '紀錄 SQL LOG 發生異常 ，請連絡系統管理員';
           XRESULT_CODE := '1';
           GOTO TO_END;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT XIS_SUCCESSFUL AS ISSUCCESSFAUL, XMESSAGE AS MESSAGE, XRESULT_CODE AS RESULTCODE
    FROM DUAL;

END S_API_ADD_SQL_LOG;

/

  GRANT EXECUTE ON "ECS"."S_API_ADD_SQL_LOG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CHECK_MOBILE_MSGPWD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CHECK_MOBILE_MSGPWD" (V_ID          IN VARCHAR2, --身分別
                                                      V_MOBILE      IN VARCHAR2, --手機號碼
                                                      V_MOBILE_PWD  IN VARCHAR2, --手機驗證碼 
                                                      V_SEND_TYPE   IN VARCHAR2, --簡訊發送種類 \ 1：新開戶；2：繼續開戶；3：開戶進度查詢                                              
                                                      OUTDT         OUT SYS_REFCURSOR) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_PWD_EFFECTIVE_TIME DATE;
  X_MOBILE_PWD VARCHAR2(30);
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

   --假如可發送有效時間大於新訊息要傳送時間時, 則不允許
   BEGIN

   	  BEGIN
      SELECT T.MOBILE_PWD ,T.PWD_EFFECTIVE_TIME 
        INTO X_MOBILE_PWD,X_PWD_EFFECTIVE_TIME
      FROM (SELECT * FROM (
                     SELECT *
                     FROM ECS.OTP_RECORD 
                     WHERE OTP_RECORD.MOBILE = V_MOBILE
                      AND OTP_RECORD.ID = V_ID 
                      AND OTP_RECORD.SEND_TYPE = V_SEND_TYPE
                      AND CREATION_DATE > sysdate - 1/24
                      ORDER BY CREATION_DATE DESC 
                    )
            WHERE rownum = 1) T;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
            X_Message          := '手機尚未發送過驗證碼!';
            X_IsSuccessful     := '1';
            GOTO FAIL;
      END;

      IF X_MOBILE_PWD != V_MOBILE_PWD THEN
        BEGIN
            X_Message          := '請輸入正確的手機驗證碼!';
            X_IsSuccessful := '1';            
            GOTO FAIL;
        END;
      END IF;

      IF X_PWD_EFFECTIVE_TIME < SYSDATE  THEN
        BEGIN
            X_Message          := '您所輸入的驗證碼已過期，請重新發送手機驗證碼!';     
            GOTO FAIL;
        END;
      END IF;
   END;

   GOTO TO_END; 
  <<FAIL>>
   X_IsSuccessful := '0';
   X_ResultCode :=  '1';

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"

      FROM DUAL;

END S_API_CHECK_MOBILE_MSGPWD;

/

  GRANT EXECUTE ON "ECS"."S_API_CHECK_MOBILE_MSGPWD" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CHECK_OPEN_ACC_STATUS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CHECK_OPEN_ACC_STATUS" 
-- =============================================
  -- Author:        邱皇瑋
  -- Create date:   20180726
  -- Description:   判斷開戶狀態
  -- 2020.12.16 by Chengyu 預約開戶與線上開戶確認頁步驟為99
  -- =============================================
(V_ID          IN VARCHAR2, --身分別
 V_SEND_TYPE   IN VARCHAR2, --發送別\1:預約開戶, 2:繼續開戶, 3:進度查詢
 V_DEVICE_TYPE IN VARCHAR2, --來源別\1:電腦, 2:\手持裝置
 OUTDT         OUT SYS_REFCURSOR,
 OUTDATA       OUT SYS_REFCURSOR) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_PROCESS_CODE VARCHAR2(20);
  X_ECS_STATUS   VARCHAR2(2);
  X_STEP_ID      VARCHAR2(10);
  X_TARGET_TYPE  VARCHAR2(20);
  X_CASE_CODE    VARCHAR2(10);
  X_COUNT        INT;

  X_IS_HAS_HOLDER VARCHAR(1);
  X_HOLDER_AMC_CNT INT;
  X_HOLDER_EC_DATE DATE;
  X_IS_ECS_HOLDER VARCHAR(1);
  X_IS_ECS_HOLDER_TMP VARCHAR(1);
  X_OLD_UPGRADE_TYPE VARCHAR(1);
  X_OFFSHORE_DATE DATE;
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_ECS_STATUS   := '';
  X_IsSuccessful := '1';
  X_PROCESS_CODE := '';
  X_TARGET_TYPE  := ''; --目標處理方式\空白:有錯誤, 0:新開戶,1:繼續開戶, 2:進度查詢
  X_CASE_CODE    := '';
  X_COUNT        := 0;

  X_IS_HAS_HOLDER := 'N';
  X_HOLDER_AMC_CNT := 0;
  X_HOLDER_EC_DATE := NULL;
  X_IS_ECS_HOLDER := 'N';
  X_IS_ECS_HOLDER_TMP := 'N';
  X_OLD_UPGRADE_TYPE := '';
  X_OFFSHORE_DATE := NULL;

  --開戶進度
  BEGIN
    --判斷HAS.HOLDER是否有資料
    BEGIN
      SELECT 'Y',ECS_STATUS ,EC_DATE,OFFSHORE_DATE
      INTO X_IS_HAS_HOLDER,X_ECS_STATUS,X_HOLDER_EC_DATE,X_OFFSHORE_DATE
      FROM FAS.HOLDER 
      WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_IS_HAS_HOLDER := 'N';        
    END;

    --判斷ECS.HOLDER是否有資料，若有表示已完成網路開戶作業資料填寫
    BEGIN
      SELECT 'Y',PROCESS_CODE
      INTO X_IS_ECS_HOLDER,X_PROCESS_CODE
      FROM ECS.HOLDER
      WHERE ID = V_ID;    
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_IS_ECS_HOLDER := 'N';        
    END;      

    --判斷ECS.HOLDER_TMP是否有資料，若有表示已進行網路開戶作業資料填寫
    BEGIN
      SELECT 'Y',STEP_ID
      INTO X_IS_ECS_HOLDER_TMP,X_STEP_ID
      FROM ECS.HOLDER_TMP
      WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_IS_ECS_HOLDER_TMP := 'N';        
    END;        

    --判斷FAS.HOLDER_DIVIDEND_AMC是否有四筆資料，若有表示基金公司已完成核印
    BEGIN
      SELECT COUNT(*)
        INTO X_HOLDER_AMC_CNT
        FROM FAS.HOLDER_AMC
       WHERE ID = V_ID
       GROUP BY ID;   
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_HOLDER_AMC_CNT := 0;        
    END;           

    --判斷HAS.HOLDER是否有資料，若有表示已開戶或者為舊戶
    IF X_IS_HAS_HOLDER = 'Y' THEN
      BEGIN
        --判斷FAS.HOLDER_DIVIDEND_AMC是否有四筆資料，若有表示基金公司已完成核印
         IF X_HOLDER_AMC_CNT = 4 THEN
          BEGIN
            --EC_DATE = Null表示客戶尚未啟用EC交易戶，為舊戶升級(當作新開戶)
            IF X_HOLDER_EC_DATE IS NULL THEN
              BEGIN
                  X_OLD_UPGRADE_TYPE := '1';
                  GOTO OLD_UPGRADE;
              END;
            ELSE
              --EC_DATE != Null  表示已有開戶資料
              BEGIN
                --表示客戶已經完成開戶(電子交易戶啟用)
                IF X_ECS_STATUS = '1' THEN
                  BEGIN
                    IF X_OFFSHORE_DATE IS NULL THEN
                      BEGIN
                        X_OLD_UPGRADE_TYPE := '3';
                        GOTO OLD_UPGRADE;                        
                      END;
                    ELSE
                      BEGIN
                        X_Message := ECS.FN_GETMSG('OPN002');
                        X_CASE_CODE := '1';
                        GOTO FAIL;                             
                      END;
                    END IF;               
                  END;
                ELSIF X_ECS_STATUS = '2' THEN
                  --停用戶
                  BEGIN
                    X_Message := ECS.FN_GETMSG('OPN003');
                    X_CASE_CODE := '2';
                    GOTO FAIL; 
                  END;
                ELSE
                  --特殊戶
                  BEGIN
                    X_Message := ECS.FN_GETMSG('OPN004');
                    X_CASE_CODE := '3';
                    GOTO FAIL; 
                  END;                  
                END IF;
              END;
            END IF;
          END;
        ELSE
        --沒有表示，此客戶四家基金公司尚未齊全,為舊戶升級(當作新開戶)
          BEGIN
            X_OLD_UPGRADE_TYPE := '2';
            GOTO OLD_UPGRADE;          
          END;
        END IF;
      END;
    ELSE
      BEGIN
        --開戶審查
        IF X_IS_ECS_HOLDER = 'Y' THEN
          BEGIN
            GOTO OPEN_REVIEW;
          END;
        ELSE
          BEGIN
            --為暫存戶
            IF X_IS_ECS_HOLDER_TMP = 'Y' THEN
              BEGIN
                GOTO OPEN_TEMP;              
              END;
            ELSE
              BEGIN
                GOTO NEW_ACC;                
              END;
            END IF; 
          END;
        END IF;         
      END;
    END IF;


  END;

  --舊戶升級
  <<OLD_UPGRADE>>
  IF X_IS_ECS_HOLDER = 'Y' THEN
    BEGIN
      IF V_SEND_TYPE = '1' THEN   --預約開戶
        BEGIN
          X_Message := ECS.FN_GETMSG('OPN006');            
          X_TARGET_TYPE := '0';
          X_CASE_CODE := '4';
          GOTO FAIL;       
        END;
      ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
        BEGIN
          -- 2020.12.16 by Chengyu 預約開戶與線上開戶確認頁步驟為99
          --進入到預約開戶完成頁(99)
          X_Message     := '';
          X_STEP_ID     := '99';
          X_TARGET_TYPE := '1';
          X_CASE_CODE := '5'; 
          GOTO SUCCESS;        
        END;
      ELSE  --進度查詢
        BEGIN
          X_Message     := '';
          X_STEP_ID     := '';
          X_TARGET_TYPE := '2';
          X_CASE_CODE := '6'; 
          GOTO SUCCESS; 
        END;
      END IF;    
    END;
  ELSE
    BEGIN
      --為暫存戶 - 進入目前步驟
      IF X_IS_ECS_HOLDER_TMP = 'Y' THEN
        BEGIN
          IF V_SEND_TYPE = '1' THEN   --預約開戶
            BEGIN
              X_Message := ECS.FN_GETMSG('OPN007');            
              X_TARGET_TYPE := '1';
              X_CASE_CODE := '7';
              GOTO FAIL;
            END;
          ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
            BEGIN
              X_Message     := '';
              X_TARGET_TYPE := '1';
              X_CASE_CODE := '8';
              GOTO SUCCESS;      
            END;
          ELSE  --進度查詢
            BEGIN
              X_Message := ECS.FN_GETMSG('OPN007');            
              X_TARGET_TYPE := '1';
              X_CASE_CODE := '9';
              GOTO FAIL;
            END;
          END IF;             
        END;
      ELSE
        --新開戶 - 顯示警語
        BEGIN

          IF V_SEND_TYPE = '1' THEN   --預約開戶
            BEGIN
              GOTO NEW_ACC;
            END;
          ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
            BEGIN
              IF X_OLD_UPGRADE_TYPE = '1' THEN
                X_Message := ECS.FN_GETMSG('OPN001');
                X_CASE_CODE := '10';
              ELSIF X_OLD_UPGRADE_TYPE = '2' THEN
                X_Message := ECS.FN_GETMSG('OPN005');
                X_CASE_CODE := '11';                
              ELSE
                X_Message := ECS.FN_GETMSG('OPN009');
                X_CASE_CODE := '23';
              END IF;         

              X_TARGET_TYPE := '0';
              GOTO FAIL;   
            END;
          ELSE  --進度查詢
            BEGIN
              IF X_OLD_UPGRADE_TYPE = '1' THEN
                X_Message := ECS.FN_GETMSG('OPN001');
                X_CASE_CODE := '12';
              ELSIF X_OLD_UPGRADE_TYPE = '2' THEN
                X_Message := ECS.FN_GETMSG('OPN005');
                X_CASE_CODE := '13';                   
              ELSE
                X_Message := ECS.FN_GETMSG('OPN009');
                X_CASE_CODE := '24';
              END IF;  

              X_TARGET_TYPE := '0';
              GOTO FAIL;
            END;
          END IF;
        END;
      END IF; 
    END;
  END IF;  

  --開戶審查
  <<OPEN_REVIEW>>
  IF V_SEND_TYPE = '1' THEN   --預約開戶
    BEGIN
      X_Message := ECS.FN_GETMSG('OPN006');            
      X_TARGET_TYPE := '2';
      X_CASE_CODE := '14';
      GOTO FAIL;  
    END;
  ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
    BEGIN
      -- 2020.12.16 by Chengyu 預約開戶與線上開戶確認頁步驟為99
      --進入到預約開戶完成頁(99)
      X_Message     := '';
      X_STEP_ID     := '99';
      X_TARGET_TYPE := '1';
      X_CASE_CODE := '15';
      GOTO SUCCESS;        
    END;
  ELSE  --進度查詢
    BEGIN
      X_Message     := '';
      X_STEP_ID     := '';
      X_TARGET_TYPE := '2';
      X_CASE_CODE := '16';
      GOTO SUCCESS;       
    END;
  END IF;  

  --暫存戶
  <<OPEN_TEMP>>
  IF V_SEND_TYPE = '1' THEN   --預約開戶
    BEGIN
      X_Message := ECS.FN_GETMSG('OPN007');            
      X_TARGET_TYPE := '1';
      X_CASE_CODE := '17';
      GOTO FAIL;  
    END;
  ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
    BEGIN
      X_Message     := '';
      X_TARGET_TYPE := '1';
      X_CASE_CODE := '18';
      GOTO SUCCESS;        
    END;
  ELSE  --進度查詢
    BEGIN
      X_Message := ECS.FN_GETMSG('OPN007');            
      X_TARGET_TYPE := '1';
      X_CASE_CODE := '19';
      GOTO FAIL;  
    END;
  END IF;    

  --新開戶
  <<NEW_ACC>>
  IF V_SEND_TYPE = '1' THEN   --預約開戶
    BEGIN
      X_Message     := '';
      X_STEP_ID     := '01_1';
      X_TARGET_TYPE := '0';
      X_CASE_CODE := '20';
      GOTO SUCCESS;
    END;
  ELSIF V_SEND_TYPE = '2' THEN --繼續開戶
    BEGIN
      X_Message := ECS.FN_GETMSG('OPN008');            
      X_TARGET_TYPE := '0';
      X_CASE_CODE := '21';
      GOTO FAIL;        
    END;
  ELSE  --進度查詢
    BEGIN
      X_Message := ECS.FN_GETMSG('OPN008');            
      X_TARGET_TYPE := '0';
      X_CASE_CODE := '22';
      GOTO FAIL;
    END;
  END IF;  


  --失敗
  <<FAIL>>
  X_IsSuccessful := '0';
  X_ResultCode := '1';
  GOTO TO_END;

  --完成
  <<SUCCESS>>
  X_IsSuccessful := '1';
  X_ResultCode := '0';
  GOTO TO_END;

  --結束
  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

  OPEN OUTDATA FOR
    SELECT X_STEP_ID AS "STEP_ID", 
           X_TARGET_TYPE AS "TARGET_TYPE",
           X_CASE_CODE AS "CASE_CODE",
           'FAS.HOLDER:' || X_IS_HAS_HOLDER ||  
           ',AMC_CNT:' || X_HOLDER_AMC_CNT || 
           ',EC_DATE:' || TO_CHAR(X_HOLDER_EC_DATE, 'YYYY/MM/DD')|| 
           ',ECS.HOLDER:' || X_IS_ECS_HOLDER || 
           ',HOLDER_TMP:' || X_IS_ECS_HOLDER_TMP || 
           ',UPGRADE_TYPE:' || X_OLD_UPGRADE_TYPE AS REMARK
      FROM DUAL;

END S_API_CHECK_OPEN_ACC_STATUS;

/

  GRANT EXECUTE ON "ECS"."S_API_CHECK_OPEN_ACC_STATUS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CHECK_ROBO_SIGN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CHECK_ROBO_SIGN" 
-- =============================================
-- Author:        王仁劭
-- Create date:   20180810
-- Description:   判斷是否允許執行ROBO簽署作業
-- 2018.10.08 tingting 增加「只有境內戶或只有境外戶不可簽署」的檢核
-- 2018.10.29 tingting 移除預約開戶受益人不可再做簽署的判斷
-- 2018.10.31 JIANXIN MOD 調整境內外開戶的判斷邏輯
-- 2018.10.31 ChengYu 錯誤訊息從ECS.MSGINFO抓取
-- 2018.11.15 yunchu 前端要求顯示訊息時,回傳須為200(非500)
-- =============================================
(
    V_ACCOUNT_NO        IN NUMBER,              --戶號
    OUTDT               OUT SYS_REFCURSOR,      --ResultModel
    OUTDT2              OUT SYS_REFCURSOR       --輸出
) IS
    --傳出變數
    X_IsSuccessful      VARCHAR2(1) := '0';     --是否成功(0:失敗 1:成功)
    X_Message           VARCHAR2(255) := '';    --錯誤訊息
    X_ResultCode        VARCHAR2(30) := '1';    --訊息代碼(0:正確 1:錯誤)
    X_IS_SIGN           VARCHAR2(2) := 'N';     --是否允許簽屬

    --變數
    X_COUNT             NUMBER;                 --資料筆數
    X_ID                VARCHAR2(255);          --受益人ID
    X_ROBO_AGREEMENT    VARCHAR2(1);            --ROBO同意書\Y:是  N:否
BEGIN

    --1.檢查受益人是否存在受益人基本資料檔
    SELECT COUNT(*)
      INTO X_COUNT
      FROM FAS.HOLDER                           --受益人基本資料
     WHERE ACCOUNT_NO = V_ACCOUNT_NO;

    IF X_COUNT = 0 THEN
    BEGIN
        -- 2018.10.31 ChengYu 錯誤訊息從ECS.MSGINFO抓取
        SELECT MSGINFO.MSGCONTENT
          INTO X_Message
          FROM ECS.MSGINFO MSGINFO
         WHERE MSGINFO.MSGID = 'ROB007';

         -- 2018.11.15 yunchu 前端要求顯示訊息時,回傳須為200(非500)
         X_IsSuccessful := '1';

        GOTO TO_END;
    END;
    END IF;

    --2.檢查受益人是否簽過ROBO同意書
    SELECT ID,                                  --受益人ID
           ROBO_AGREEMENT                       --ROBO同意書\Y:是  N:否
      INTO X_ID,
           X_ROBO_AGREEMENT 
      FROM FAS.HOLDER                           --受益人基本資料
     WHERE ACCOUNT_NO = V_ACCOUNT_NO;

    IF X_ROBO_AGREEMENT = 'Y' THEN
    BEGIN
        -- 2018.10.31 ChengYu 錯誤訊息從ECS.MSGINFO抓取
        SELECT MSGINFO.MSGCONTENT
          INTO X_Message
          FROM ECS.MSGINFO MSGINFO
         WHERE MSGINFO.MSGID = 'ROB008';

         -- 2018.11.15 yunchu 前端要求顯示訊息時,回傳須為200(非500)
         X_IsSuccessful := '1';

        GOTO TO_END;
    END;
    END IF;

    -- 20181008 tingting 增加「只有境內戶或只有境外戶不可簽署」的檢核
    -- 3.判斷「只有境內戶或只有境外戶不可簽署」
    SELECT COUNT(*)
      INTO X_COUNT
      FROM FAS.HOLDER_AMC                       --受益人開戶別
     WHERE HOLDER_AMC.ID = X_ID
       -- 2018.10.31 JIANXIN MOD 調整境內外開戶的判斷邏輯
       AND ((AMC_NO = '01' AND ACCOUNT_NO IS NOT NULL )
            OR
            (AMC_NO IN ('02','03') AND (ACCOUNT_NO IS NOT NULL OR OFFSHORE_ACCT_NO IS NOT NULL))
           );

    -- 2018.10.31 JIANXIN MOD 調整境內外開戶的判斷邏輯
    IF X_COUNT < 3 THEN
    BEGIN
        -- 2018.10.31 ChengYu 錯誤訊息從ECS.MSGINFO抓取
        SELECT MSGINFO.MSGCONTENT
          INTO X_Message
          FROM ECS.MSGINFO MSGINFO
         WHERE MSGINFO.MSGID = 'ROB005';

         -- 2018.11.15 yunchu 前端要求顯示訊息時,回傳須為200(非500)
         X_IsSuccessful := '1';

        GOTO TO_END;
    END;
    END IF;

    -- 2018.10.31 JIANXIN 增加「只有開立境內及境外扣款授權帳戶不可簽署」的檢核
    -- 4.判斷「只有開立境內及境外扣款授權帳戶不可簽署」
    SELECT COUNT(*) 
      INTO X_COUNT
      FROM FAS.HOLDER_BANK
     WHERE HOLDER_BANK.ECS = 'Y'
       AND FUND_TYPE = 'A'
       AND FUND_CATEGORY = '0'
       AND SYSDATE BETWEEN VALID_FROM AND NVL(CLOSE_DATE,TO_DATE('9998/12/31','YYYY/MM/DD'))
       AND ID = X_ID;

    IF X_COUNT = 0 THEN
    BEGIN
        SELECT MSGINFO.MSGCONTENT
          INTO X_Message
          FROM ECS.MSGINFO MSGINFO
         WHERE MSGINFO.MSGID = 'ROB006';

         -- 2018.11.15 yunchu 前端要求顯示訊息時,回傳須為200(非500)
         X_IsSuccessful := '1';

        GOTO TO_END;
    END;
    END IF;

    --其餘狀況回傳成功、可允許簽署
    X_IsSuccessful := '1';
    X_ResultCode := '0';
    X_IS_SIGN := 'Y';

    <<TO_END>>
    OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

    OPEN OUTDT2 FOR
    SELECT X_IS_SIGN AS IS_SIGN 
      FROM DUAL;

END S_API_CHECK_ROBO_SIGN;

/

  GRANT EXECUTE ON "ECS"."S_API_CHECK_ROBO_SIGN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CHECK_SPONSOR_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CHECK_SPONSOR_DATA" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 檢查推薦人資料
  -- =============================================
(V_ID_NO      IN VARCHAR2, --身分證
 V_SPONSOR_ID IN VARCHAR2, --推薦人代碼
 OUTDT        OUT SYS_REFCURSOR) IS

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_ID           VARCHAR2(10);
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  --判斷推薦碼是否存在於ECS.HOLDER!
  BEGIN

  	BEGIN
      SELECT ID INTO X_ID
              FROM FAS.HOLDER
             WHERE ECS_STATUS = 1
               AND CLOSE_DATE IS NULL
               AND ACCOUNT_NO = V_SPONSOR_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_Message      := '此推薦碼不存在!';
        X_IsSuccessful := '0';
        X_ResultCode   := '1';
        GOTO TO_END;        
    END;

  END;


  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_CHECK_SPONSOR_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_CHECK_SPONSOR_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CHECK_TOKEN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CHECK_TOKEN" (V_ID IN VARCHAR2, --使用者代號
                                          V_TOKEN_ID  IN VARCHAR2, --TokenId
                                          OUTDT       OUT SYS_REFCURSOR) IS
  X_SRNO            NUMBER;
  X_CREATE_TIME     DATE;
  X_REFRESH_TIME    DATE;
  X_TIMEOUT_MINUTES NUMBER;
  X_TOKEN_STATUS    VARCHAR2(10);

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);

BEGIN

  -- 指定變數
  X_SRNO            := 0;
  X_CREATE_TIME     := SYSDATE;
  X_REFRESH_TIME    := SYSDATE;
  X_TIMEOUT_MINUTES := 0;
  X_TOKEN_STATUS    := '';

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  --TOKEN為空
  BEGIN
    IF V_TOKEN_ID IS NULL THEN
      BEGIN
        X_Message      := '由於逾時過久或者版本更新，確保您資料安全與版本，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --取得Token資料
  BEGIN
    BEGIN
      SELECT SRNO, CREATION_DATE, REFRESH_TIME, TIMEOUT_MINUTES, TOKEN_STATUS
        INTO X_SRNO,
             X_CREATE_TIME,
             X_REFRESH_TIME,
             X_TIMEOUT_MINUTES,
             X_TOKEN_STATUS
        FROM ECS.TOKEN_POOL --WITH(NOLOCK)
       WHERE ID = V_ID
         AND TOKEN_ID = V_TOKEN_ID;
    EXCEPTION WHEN NO_DATA_FOUND THEN
          X_Message      := '您所登入憑證資料不存在，煩請重新登入!';
          X_ResultCode   := '7';
          X_IsSuccessful := '0';
          GOTO TO_END;
    END;
  END;

  --換版，造成憑證失效
  BEGIN
    IF X_SRNO = 0 THEN
      BEGIN
        X_Message      := '您所登入憑證資料不存在，煩請重新登入!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --換版，造成憑證失效
  BEGIN
    IF X_TOKEN_STATUS = '1' THEN
      BEGIN
        X_Message      := '目前版本更換中或者已更換過版本，為確保版本的正確性及舊版本暫存資料清除，煩請關閉瀏覽器後再登入系統!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --重覆登入，造成憑證失效
  BEGIN
    IF X_TOKEN_STATUS = '2' THEN
      BEGIN
        X_Message      := '您重複登入造成舊有憑證失效，煩請重新登入!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --登出
  BEGIN
    IF X_TOKEN_STATUS = '3' THEN
      BEGIN
        X_Message      := '您已經登出造成舊有憑證失效，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --過期，造成憑證失效
  BEGIN
    SELECT X_REFRESH_TIME + X_TIMEOUT_MINUTES / 60 / 24
      INTO X_REFRESH_TIME
      FROM DUAL;
    IF X_REFRESH_TIME < SYSDATE THEN
      BEGIN
        X_Message      := '由於逾時過久，確保您資料安全，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  BEGIN
    UPDATE ECS.TOKEN_POOL
       SET REFRESH_TIME = SYSDATE
     WHERE ID = V_ID
       AND TOKEN_ID = V_TOKEN_ID;
    GOTO TO_END;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_CHECK_TOKEN;

/

  GRANT EXECUTE ON "ECS"."S_API_CHECK_TOKEN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_CREATE_TOKEN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_CREATE_TOKEN" (V_ID       VARCHAR2, -- 使用者代號
                                           V_TOKEN_ID        VARCHAR2, -- TokenId
                                           V_TIMEOUT_MINUTES NUMBER,   -- 逾時時間
                                           OUTDT             OUT SYS_REFCURSOR -- 輸出
                                           ) IS

  X_IsSuccessful VARCHAR2(1); -- 是否成功
  X_Message      VARCHAR2(255); -- 錯誤訊息
  X_ResultCode   VARCHAR2(30); -- ResultCode

  X_CREATE_TIME  DATE; -- 產生時間
  X_REFRESH_TIME DATE; -- 更新時間

BEGIN

  -- 指定變數
  X_IsSuccessful := '1'; -- 受否成功
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := 0; -- 訊息代碼
  X_CREATE_TIME  := SYSDATE; -- 建立時間
  X_REFRESH_TIME := SYSDATE; -- 更新時間

  --檢查客戶(UserInfo)是否存在
  BEGIN
    --將舊的Token更新重複登入
    UPDATE ECS.TOKEN_POOL
       SET TOKEN_STATUS = '2'
     WHERE ID = V_ID
       AND TOKEN_STATUS = '0';

    --產生Token
    INSERT INTO ECS.TOKEN_POOL
      (ID,
       TOKEN_ID,
       CREATION_DATE,
       REFRESH_TIME,
       TIMEOUT_MINUTES,
       TOKEN_STATUS)
    VALUES
      (V_ID,
       V_TOKEN_ID,
       X_CREATE_TIME,
       X_REFRESH_TIME,
       V_TIMEOUT_MINUTES,
       '0');
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_CREATE_TOKEN;

/

  GRANT EXECUTE ON "ECS"."S_API_CREATE_TOKEN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_ADDR_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_ADDR_DATA" (OUTDT OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
                                                ) IS

BEGIN

  OPEN OUTDT FOR
  --取得郵遞區號
    SELECT POST_CODE, CITY, AREA
      FROM FAS.POST_AREA
     GROUP BY POST_CODE, CITY, AREA
     ORDER BY POST_CODE;

END S_API_GET_ADDR_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_ADDR_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_BANK_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_BANK_DATA" 
-- =============================================
-- Author:    
-- Create date: 
-- Description: 取得銀行資訊(總行)
-- 2020.06.12 tingting 因應第二階段開戶調整
-- 2020.06.15 tingting 因應第二階段開戶調整，增加傳出IS_ONLINE是否可線上核印欄位
-- 2021.06.08 Chengyu 新增Table：ECS.OPEN_BANK(開戶銀行設定檔)限制銀行資料
-- =============================================
(
    OPEN_TYPE   VARCHAR2,           -- 查詢幣別
    OUTDT       OUT SYS_REFCURSOR,  -- 回傳的 TABLEDATA (財金扣款銀行總行資訊清單(台幣))
    OUTDT2      OUT SYS_REFCURSOR,  -- 回傳的 TABLEDATA (財金扣款銀行總行資訊清單(外幣))
    OUTDT3      OUT SYS_REFCURSOR,  -- 回傳的 TABLEDATA (集保扣款銀行總行資訊清單(台幣))
    OUTDT4      OUT SYS_REFCURSOR   -- 回傳的 TABLEDATA (集保扣款銀行總行資訊清單(外幣))
) IS
BEGIN

  OPEN OUTDT FOR
  --財金扣款銀行總行資訊清單(台幣)
    SELECT FIS_BANK.BANK_NO,
           NAME BANK_NAME,
           ENAME BANK_ENAME,
           AC_LENGTH,
           IS_TDCC,
           MMA_CHECKED IS_MMA,
           NVL(FCY_CHECKED,'N') IS_FCY,
           NVL(IS_ONLINE_NTD,'N') IS_ONLINE
      FROM FAS.FIS_BANK
      -- 2021.06.08 Chengyu 新增Table：ECS.OPEN_BANK(開戶銀行設定檔)限制銀行資料
      JOIN ECS.OPEN_BANK
        ON OPEN_BANK.BANK_NO = FIS_BANK.BANK_NO
       AND OPEN_BANK.IS_FIS_NTD = 'Y'
     WHERE PAYMENT_GATEWAY = 'Y'
       AND PAYEE_GATEWAY = 'Y';

  OPEN OUTDT2 FOR
  --財金扣款銀行總行資訊清單(外幣)
    SELECT FIS_BANK.BANK_NO,
           NAME BANK_NAME,
           ENAME BANK_ENAME,
           AC_LENGTH,
           IS_TDCC,
           MMA_CHECKED IS_MMA,
           NVL(FCY_CHECKED,'N') IS_FCY,
           NVL(IS_ONLINE_FCY,'N') IS_ONLINE
      FROM FAS.FIS_BANK
      -- 2021.06.08 Chengyu 新增Table：ECS.OPEN_BANK(開戶銀行設定檔)限制銀行資料
      JOIN ECS.OPEN_BANK
        ON OPEN_BANK.BANK_NO = FIS_BANK.BANK_NO
       AND OPEN_BANK.IS_FIS_FCY = 'Y'
     WHERE PAYMENT_GATEWAY = 'Y'
       AND PAYEE_GATEWAY = 'Y';

  --集保扣款銀行總行資訊清單(台幣)
  OPEN OUTDT3 FOR
    SELECT FIS_BANK.BANK_NO,
           NAME BANK_NAME,
           ENAME BANK_ENAME,
           AC_LENGTH,
           IS_TDCC,
           MMA_CHECKED IS_MMA,
           NVL(FCY_CHECKED,'N') IS_FCY,
           NVL(IS_ONLINE_NTD,'N') IS_ONLINE
      FROM FAS.FIS_BANK
      -- 2021.06.08 Chengyu 新增Table：ECS.OPEN_BANK(開戶銀行設定檔)限制銀行資料
      JOIN ECS.OPEN_BANK
        ON OPEN_BANK.BANK_NO = FIS_BANK.BANK_NO
       AND OPEN_BANK.IS_TDCC_NTD = 'Y'
     WHERE PAYMENT_GATEWAY = 'Y'
       AND PAYEE_GATEWAY = 'Y'
       AND IS_TDCC = 'Y';

  --集保扣款銀行總行資訊清單(外幣)
  OPEN OUTDT4 FOR
    SELECT FIS_BANK.BANK_NO,
           NAME BANK_NAME,
           ENAME BANK_ENAME,
           AC_LENGTH,
           IS_TDCC,
           MMA_CHECKED IS_MMA,
           NVL(FCY_CHECKED,'N') IS_FCY,
           NVL(IS_ONLINE_FCY,'N') IS_ONLINE
      FROM FAS.FIS_BANK
      -- 2021.06.08 Chengyu 新增Table：ECS.OPEN_BANK(開戶銀行設定檔)限制銀行資料
      JOIN ECS.OPEN_BANK
        ON OPEN_BANK.BANK_NO = FIS_BANK.BANK_NO
       AND OPEN_BANK.IS_TDCC_FCY = 'Y'
     WHERE PAYMENT_GATEWAY = 'Y'
       AND PAYEE_GATEWAY = 'Y'
       AND IS_TDCC = 'Y';

END S_API_GET_BANK_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_BANK_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_COUNTRY_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_COUNTRY_DATA" (OUTDT OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
                                                   ) IS

BEGIN

  OPEN OUTDT FOR
  --取得國別資料
    SELECT COUNTRY_CODE,
           NAME COUNTRY_NAME,
           ENGLISH_NAME,
           COUNTRY_CODE1,
           PHONE_CODE
      FROM FAS.COUNTRY
     WHERE COUNTRY_CODE1 IS NOT NULL
       AND PHONE_CODE IS NOT NULL
     ORDER BY COUNTRY_CODE;

END S_API_GET_COUNTRY_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_COUNTRY_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_KYC_QUESTION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_KYC_QUESTION" 
-- =============================================
-- Author:      Jason
-- Create date: 2018/07/26
-- Description: 取得KYC題庫
-- 2019.03.29 tingting 1.調整職業別、職務來源從Table來 2.修正B06選項錯誤
-- 2020.11.02 JIANXIN 調整KYC 題目由”全民健康保險重傷病證明”  改成”重傷病證明(符合全民健康保險重傷病證明)”
-- 2022.07.30 JIANXIN 新增KYC 題目與調整原KYC題目內容
-- 2022.08.10 JIANXIN 新增KYC 題目與調整原KYC題目內容
-- 2022.08.22 JIANXIN 調整KYC題目"目前身心狀態"的選項內容改為"患有重大疾病"
-- 2022.12.28 JIANXIN 調整KYC題目年齡級距
-- 2024.12.02 Richard 調整KYC題目重傷病證明-->重大傷病證明/服務單位名稱-->任職機構
-- =============================================
(
    OUTDT OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
    SELECT 'A01' KYC_CODE,'家庭狀況' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'單身' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A01' KYC_CODE,'家庭狀況' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'已婚' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A01' KYC_CODE,'家庭狀況' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'其他' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    UNION
    SELECT 'A02' KYC_CODE,'子女數' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'N' ANS_VALUE,'無' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A02' KYC_CODE,'子女數' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'Y' ANS_VALUE,'有' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    UNION
    -- 2019.03.29 tingting 1.調整職業別、職務來源從Table來 2.修正B06選項錯誤
    SELECT 'A03' AS KYC_CODE,
           '職業別' AS KYC_QUESTION,
           3 AS QSN_SEQNO,
           'N' AS IS_ALLOW_MULIT,
           TO_NUMBER(PROFESSION.PROFESSION) AS ANS_SEQNO,
           TO_NUMBER(PROFESSION.PROFESSION) AS ANS_ORDER,
           PROFESSION.PROFESSION AS ANS_VALUE,
           PROFESSION.NAME AS ANS_TEXT,
           0 ANS_SCORE,
           CASE WHEN PROFESSION.PROFESSION = '99' THEN 'Y' ELSE 'N' END AS IS_MEMO
      FROM FAS.PROFESSION   --職業別
     WHERE PROFESSION.IR_CODE = 'R'     --身分類別 I : 法人 R : 自然人
    UNION
    -- 2024.12.02 begin modified by Richard 調整KYC題目重傷病證明-->重大傷病證明/服務單位名稱-->任職機構
--    SELECT 'A04' KYC_CODE,'服務單位名稱' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    SELECT 'A04' KYC_CODE,'任職機構' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    -- 2024.12.02 end modified by Richard 調整KYC題目重傷病證明-->重大傷病證明/服務單位名稱-->任職機構
    UNION
    -- 2019.03.29 tingting 1.調整職業別、職務來源從Table來 2.修正B06選項錯誤
    SELECT 'A05' AS KYC_CODE,
           '職務' AS KYC_QUESTION,
           5 AS QSN_SEQNO,
           'N' AS IS_ALLOW_MULIT,
           TO_NUMBER(POSITION.POSITION) AS ANS_SEQNO,
           TO_NUMBER(POSITION.POSITION) AS ANS_ORDER,
           POSITION.POSITION AS ANS_VALUE,
           POSITION.NAME AS ANS_TEXT,
           0 ANS_SCORE,
           CASE WHEN POSITION.POSITION = '99' THEN 'Y' ELSE 'N' END AS IS_MEMO
      FROM FAS.POSITION     --職務
    UNION
    -- 2024.12.02 begin modified by Richard 調整KYC題目重傷病證明-->重大傷病證明/服務單位名稱-->任職機構
--    -- 2020.11.02 JIANXIN 調整KYC 題目由”全民健康保險重傷病證明”  改成”重傷病證明(符合全民健康保險重傷病證明)”
--    SELECT 'A06' KYC_CODE,'重傷病證明(符合全民健康保險重傷病證明)' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'N' ANS_VALUE,'無' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
--    UNION
--    SELECT 'A06' KYC_CODE,'重傷病證明(符合全民健康保險重傷病證明)' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'Y' ANS_VALUE,'有' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    SELECT 'A06' KYC_CODE,'重大傷病證明(符合全民健康保險重傷病證明)' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'N' ANS_VALUE,'無' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A06' KYC_CODE,'重大傷病證明(符合全民健康保險重傷病證明)' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'Y' ANS_VALUE,'有' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    -- 2024.12.02 end modified by Richard 調整KYC題目重傷病證明-->重大傷病證明/服務單位名稱-->任職機構
    UNION
    SELECT 'A07' KYC_CODE,'預估投資金額' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'100萬以下' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A07' KYC_CODE,'預估投資金額' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'100-500萬' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A07' KYC_CODE,'預估投資金額' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'500-1,000萬' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A07' KYC_CODE,'預估投資金額' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'1,000萬以上' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A08' KYC_CODE,'投資理財資訊來源' KYC_QUESTION,8 QSN_SEQNO,'Y' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'證券商或投顧公司等專業機構提供' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A08' KYC_CODE,'投資理財資訊來源' KYC_QUESTION,8 QSN_SEQNO,'Y' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'書報雜誌' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A08' KYC_CODE,'投資理財資訊來源' KYC_QUESTION,8 QSN_SEQNO,'Y' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'網際網路' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A08' KYC_CODE,'投資理財資訊來源' KYC_QUESTION,8 QSN_SEQNO,'Y' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'其他' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'薪水/執業所得或其他經常性收入' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'退休金/保險年金' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'租賃所得' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'遺產餽贈' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'投資所得(資本所得、利息收入)' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,6 ANS_SEQNO,6 ANS_ORDER,'6' ANS_VALUE,'閒置資金' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A09' KYC_CODE,'投資資金來源' KYC_QUESTION,9 QSN_SEQNO,'Y' IS_ALLOW_MULIT,7 ANS_SEQNO,7 ANS_ORDER,'7' ANS_VALUE,'其他' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    UNION
    SELECT 'A10' KYC_CODE,'目前居住及照護狀態' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'獨居' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A10' KYC_CODE,'目前居住及照護狀態' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'與親友同住' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A10' KYC_CODE,'目前居住及照護狀態' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'需由專人照護' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A10' KYC_CODE,'目前居住及照護狀態' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'其他' ANS_TEXT,0 ANS_SCORE,'Y' IS_MEMO FROM DUAL
    UNION
    SELECT 'A11' KYC_CODE,'目前身心狀態' KYC_QUESTION,11 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'身體健康' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A11' KYC_CODE,'目前身心狀態' KYC_QUESTION,11 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'僅有慢性病,但身體仍感覺健康' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A11' KYC_CODE,'目前身心狀態' KYC_QUESTION,11 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'患有重大疾病' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A11' KYC_CODE,'目前身心狀態' KYC_QUESTION,11 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'有身心障礙證明' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'A11' KYC_CODE,'目前身心狀態' KYC_QUESTION,11 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'需由監護人或輔助人代為行使權利' ANS_TEXT,0 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B01' KYC_CODE,'客戶年齡層' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'65歲(含)以上' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B01' KYC_CODE,'客戶年齡層' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'60~64歲' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B01' KYC_CODE,'客戶年齡層' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'50-59歲/未滿18歲' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B01' KYC_CODE,'客戶年齡層' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'18-29歲' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B01' KYC_CODE,'客戶年齡層' KYC_QUESTION,1 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'30-49歲' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B02' KYC_CODE,'學歷' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'a' ANS_VALUE,'國小以下' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B02' KYC_CODE,'學歷' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'A' ANS_VALUE,'國中' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B02' KYC_CODE,'學歷' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'B' ANS_VALUE,'高中' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B02' KYC_CODE,'學歷' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'C' ANS_VALUE,'大學/大專' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B02' KYC_CODE,'學歷' KYC_QUESTION,2 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'D' ANS_VALUE,'碩士以上' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B03' KYC_CODE,'常使用投資理財工具' KYC_QUESTION,3 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'定存' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B03' KYC_CODE,'常使用投資理財工具' KYC_QUESTION,3 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'債券' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B03' KYC_CODE,'常使用投資理財工具' KYC_QUESTION,3 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'基金' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B03' KYC_CODE,'常使用投資理財工具' KYC_QUESTION,3 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'股票' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B03' KYC_CODE,'常使用投資理財工具' KYC_QUESTION,3 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'期貨' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B04' KYC_CODE,'投資經驗' KYC_QUESTION,4 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'新手' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B04' KYC_CODE,'投資經驗' KYC_QUESTION,4 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'1年以下' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B04' KYC_CODE,'投資經驗' KYC_QUESTION,4 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'1-3年' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B04' KYC_CODE,'投資經驗' KYC_QUESTION,4 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'3-10年' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B04' KYC_CODE,'投資經驗' KYC_QUESTION,4 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'10年以上' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B05' KYC_CODE,'最主要投資目的' KYC_QUESTION,5 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'只願投資較保守的產品' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B05' KYC_CODE,'最主要投資目的' KYC_QUESTION,5 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'儲蓄退休金' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B05' KYC_CODE,'最主要投資目的' KYC_QUESTION,5 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'儲蓄子女教育基金' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B05' KYC_CODE,'最主要投資目的' KYC_QUESTION,5 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'短期投資計畫' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B05' KYC_CODE,'最主要投資目的' KYC_QUESTION,5 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'追求資產增值' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B06' KYC_CODE,'投資損益忍受度' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'全部/部分贖回，持有現金' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    -- 2019.03.29 tingting 1.調整職業別、職務來源從Table來 2.修正B06選項錯誤
    SELECT 'B06' KYC_CODE,'投資損益忍受度' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'全部/部分贖回並轉至風險較低的基金' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B06' KYC_CODE,'投資損益忍受度' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'暫時觀望，不採取行動' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B06' KYC_CODE,'投資損益忍受度' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'考慮加碼，攤低投資成本' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B06' KYC_CODE,'投資損益忍受度' KYC_QUESTION,7 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'積極逢低加碼' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B07' KYC_CODE,'個人或家庭平均年收入' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'A' ANS_VALUE,'50萬以下' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B07' KYC_CODE,'個人或家庭平均年收入' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'B' ANS_VALUE,'50-100萬' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B07' KYC_CODE,'個人或家庭平均年收入' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'C' ANS_VALUE,'100-300萬' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B07' KYC_CODE,'個人或家庭平均年收入' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'D' ANS_VALUE,'300-500萬' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B07' KYC_CODE,'個人或家庭平均年收入' KYC_QUESTION,6 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'E' ANS_VALUE,'500萬以上' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B08' KYC_CODE,'重大資金需求' KYC_QUESTION,8 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'1年內' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B08' KYC_CODE,'重大資金需求' KYC_QUESTION,8 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'1~2年' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B08' KYC_CODE,'重大資金需求' KYC_QUESTION,8 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'2~5年' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B08' KYC_CODE,'重大資金需求' KYC_QUESTION,8 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'5~10年' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B08' KYC_CODE,'重大資金需求' KYC_QUESTION,8 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'10年後' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B09' KYC_CODE,'流動性資金需求' KYC_QUESTION,9 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'1個月(含)以下' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B09' KYC_CODE,'流動性資金需求' KYC_QUESTION,9 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'1~3個月' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B09' KYC_CODE,'流動性資金需求' KYC_QUESTION,9 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'3~6個月' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B09' KYC_CODE,'流動性資金需求' KYC_QUESTION,9 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'6~12個月' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B09' KYC_CODE,'流動性資金需求' KYC_QUESTION,9 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'12個月以上' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B10' KYC_CODE,'價格波動承受度' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,1 ANS_SEQNO,1 ANS_ORDER,'1' ANS_VALUE,'無法承受波動' ANS_TEXT,1 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B10' KYC_CODE,'價格波動承受度' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,2 ANS_SEQNO,2 ANS_ORDER,'2' ANS_VALUE,'可承受最高5%的波動' ANS_TEXT,2 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B10' KYC_CODE,'價格波動承受度' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,3 ANS_SEQNO,3 ANS_ORDER,'3' ANS_VALUE,'可承受最高15%的波動' ANS_TEXT,3 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B10' KYC_CODE,'價格波動承受度' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,4 ANS_SEQNO,4 ANS_ORDER,'4' ANS_VALUE,'可承受最高30%的波動' ANS_TEXT,4 ANS_SCORE,'N' IS_MEMO FROM DUAL
    UNION
    SELECT 'B10' KYC_CODE,'價格波動承受度' KYC_QUESTION,10 QSN_SEQNO,'N' IS_ALLOW_MULIT,5 ANS_SEQNO,5 ANS_ORDER,'5' ANS_VALUE,'可承受30%以上的波動' ANS_TEXT,5 ANS_SCORE,'N' IS_MEMO FROM DUAL
    ORDER BY KYC_CODE,ANS_ORDER;

END S_API_GET_KYC_QUESTION;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_KYC_QUESTION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_MOBILE_FILES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_MOBILE_FILES" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得客戶開戶上傳檔案
  -- =============================================
(V_ID_NO      VARCHAR2, -- 身分證
 V_LOAD_FILES VARCHAR2, -- 載入檔案清單(以,號分隔)
 OUTDT        OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客戶開戶上傳檔案)
 ) IS

BEGIN

  OPEN OUTDT FOR
  --取得客戶開戶上傳檔案
    SELECT A.UPLOAD_TYPE,
           A.UPLOAD_FILE,
           A.UPLOAD_EXT,
           V_ID_NO || '_' || A.UPLOAD_TYPE AS UPLOAD_FILENAME
      FROM ECS.OPEN_MOBILE_UPLOAD_DATA A
      JOIN (SELECT VALUE1
              FROM table(ecs.f_formatstringlisttotable(V_LOAD_FILES))) T
        ON T.VALUE1 = A.UPLOAD_TYPE
     WHERE ID = V_ID_NO;

  --取完檔案後直接移除
  DELETE FROM ECS.OPEN_MOBILE_UPLOAD_DATA
   WHERE ID = V_ID_NO
     AND UPLOAD_TYPE IN
         (SELECT VALUE1
            FROM table(ecs.f_formatstringlisttotable(V_LOAD_FILES)));

END S_API_GET_MOBILE_FILES;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_MOBILE_FILES" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_MOBILE_MSG_PWD
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_MOBILE_MSG_PWD" 
(V_MOBILE VARCHAR2, 
 OUTDT   OUT SYS_REFCURSOR -- 回傳的 TABLEDATA 
) IS

BEGIN

  OPEN OUTDT FOR
    SELECT ID,MOBILE_PWD FROM (
    SELECT * FROM ECS.OTP_RECORD WHERE MOBILE = V_MOBILE AND CREATION_DATE > sysdate - 1/24 ORDER BY CREATION_DATE DESC
    ) T
    WHERE ROWNUM = 1;

END S_API_GET_MOBILE_MSG_PWD;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_MOBILE_MSG_PWD" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPENACCDOCMAIL_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPENACCDOCMAIL_DATA" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得客戶轉寄資料
  -- =============================================
(V_ID_NO VARCHAR2, -- 身分證
 OUTDT   OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客戶轉寄資料)
 ) IS
BEGIN 

  OPEN OUTDT FOR
    SELECT A.NAME,
           A.MOBILE,
           A.EMAIL,
           A.POST_CODE,
           A.CONTACT_ADDRESS,
           (A.APPLY_DTTM + B.OPEN_DATA_KEEP_DAY) AS OPEN_EXPIRE_DATE
      FROM ECS.HOLDER A
      JOIN ECS.SYSTEM_PARAMETER B
        ON 1 = 1
     WHERE A.ID = V_ID_NO;

END S_API_GET_OPENACCDOCMAIL_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPENACCDOCMAIL_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPEN_ACC_PDFDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPEN_ACC_PDFDATA" 
-- =============================================
-- Author:    Jason
-- Create date: 2018/07/25
-- Description: 取得預約開戶填PDF寫資料
-- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
-- 2019.04.15 tingting 調整TAX.PDF的居住地址和通訊地址要顯示完整地址
-- 2019.04.15 tingting 調整TAX.PDF的稅籍國家1直接回傳'中華民國'
-- 2021.03.05 Chengyu 新增回傳欄位線上核印日期
-- 2021.07.26 Chengyu 銀行清單 新增幣別名稱
-- 2022.03.02 Chengyu 調整PDF生日日期格式顯示
-- =============================================
(
    V_ID_NO          VARCHAR2, -- 身分證
    BankList         OUT SYS_REFCURSOR, -- 回傳的 銀行清單
    UploadFiles      OUT SYS_REFCURSOR, -- 回傳的 上傳清單
    CountryData      OUT SYS_REFCURSOR, -- 回傳的 取得出生地國籍
    -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
    TaxPdfData       OUT SYS_REFCURSOR  -- 回傳TAX.PDF用欄位
) IS
BEGIN

    --銀行清單
    OPEN BankList FOR
    SELECT 'AC1A' AS TYPE,
           A.FIS_AC_CODE_TWD AS ACCODE,
           A.FIS_CURRENCY_NO_TWD AS CURRENCY,
           -- 2021.07.26 Chengyu 銀行清單 新增幣別名稱
           D.NAME AS CURRENCYNAME,
           A.FIS_BANK_NO_TWD AS BANKNO,
           C.NAME AS BANKNAME,
           A.FIS_BRANCH_NO_TWD AS BRANCHNO,
           B.NAME AS BRANCHNAME,
           -- 2021.03.05 Chengyu 新增回傳欄位線上核印日期
           NVL(A.FIS_SEAL_DATE_TWD,TO_DATE('1900/01/01','YYYY/MM/DD')) AS SEAL_DATE --財金台幣線上核印日期
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BRANCH B
        on B.BANK_NO = A.FIS_BANK_NO_TWD
       AND B.BRANCH_NO = A.FIS_BRANCH_NO_TWD
      LEFT JOIN FAS.FIS_BANK C
        on C.BANK_NO = A.FIS_BANK_NO_TWD
      LEFT JOIN FAS.CURRENCY D
        ON D.CURRENCY_NO = A.FIS_CURRENCY_NO_TWD
     WHERE ID = V_ID_NO
    UNION
    SELECT 'AC1B' AS TYPE,
           A.FIS_AC_CODE_TWD_FCY AS ACCODE,
           A.FIS_CURRENCY_NO_FCY AS CURRENCY,
           -- 2021.07.26 Chengyu 銀行清單 新增幣別名稱
           D.NAME AS CURRENCYNAME,
           A.FIS_BANK_NO_TWD_FCY AS BANKNO,
           C.NAME AS BANKNAME,
           A.FIS_BRANCH_NO_TWD_FCY AS BRANCHNO,
           B.NAME AS BRANCHNAME,
           -- 2021.03.05 Chengyu 新增回傳欄位線上核印日期
           NVL(A.FIS_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) AS SEAL_DATE --財金外幣線上核印日期
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BRANCH B
        on B.BANK_NO = A.FIS_BANK_NO_TWD_FCY
       AND B.BRANCH_NO = A.FIS_BRANCH_NO_TWD_FCY
      LEFT JOIN FAS.FIS_BANK C
        on C.BANK_NO = A.FIS_BANK_NO_TWD_FCY
      LEFT JOIN FAS.CURRENCY D
        ON D.CURRENCY_NO = A.FIS_CURRENCY_NO_FCY
     WHERE ID = V_ID_NO
    UNION
    SELECT 'AC2A' AS TYPE,
           A.TDCC_AC_CODE AS ACCODE,
           A.TDCC_CURRENCY_NO AS CURRENCY,
           -- 2021.07.26 Chengyu 銀行清單 新增幣別名稱
           D.NAME AS CURRENCYNAME,
           A.TDCC_BANK_NO AS BANKNO,
           C.NAME AS BANKNAME,
           A.TDCC_BRANCH_NO AS BRANCHNO,
           B.NAME AS BRANCHNAME,
           -- 2021.03.05 Chengyu 新增回傳欄位線上核印日期
           NVL(A.TDCC_SEAL_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS SEAL_DATE --集保台幣線上核印日期
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BRANCH B
        on B.BANK_NO = A.TDCC_BANK_NO
       AND B.BRANCH_NO = A.TDCC_BRANCH_NO
      LEFT JOIN FAS.FIS_BANK C
        on C.BANK_NO = A.TDCC_BANK_NO
      LEFT JOIN FAS.CURRENCY D
        ON D.CURRENCY_NO = A.TDCC_CURRENCY_NO
     WHERE ID = V_ID_NO
    UNION
    SELECT 'AC2B' AS TYPE,
           A.TDCC_AC_CODE_TWD_FCY AS ACCODE,
           A.TDCC_CURRENCY_NO_FCY AS CURRENCY,
           -- 2021.07.26 Chengyu 銀行清單 新增幣別名稱
           D.NAME AS CURRENCYNAME,
           A.TDCC_BANK_NO_TWD_FCY AS BANKNO,
           C.NAME AS BANKNAME,
           A.TDCC_BRANCH_NO_TWD_FCY AS BRANCHNO,
           B.NAME AS BRANCHNAME,
           -- 2021.03.05 Chengyu 新增回傳欄位線上核印日期
           NVL(A.TDCC_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) AS SEAL_DATE --集保外幣線上核印日期
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BRANCH B
        on B.BANK_NO = A.TDCC_BANK_NO_TWD_FCY
       AND B.BRANCH_NO = A.TDCC_BRANCH_NO_TWD_FCY
      LEFT JOIN FAS.FIS_BANK C
        on C.BANK_NO = A.TDCC_BANK_NO_TWD_FCY
      LEFT JOIN FAS.CURRENCY D
        ON D.CURRENCY_NO = A.TDCC_CURRENCY_NO_FCY
     WHERE ID = V_ID_NO;

    --上傳清單
    OPEN UploadFiles FOR
    SELECT * FROM ECS.HOLDER_UPLOAD_DATA WHERE ID = V_ID_NO;

    --取得出生地國籍
    OPEN CountryData FOR
    SELECT B.NAME, NATIONALITY AS CODE, 'NATIONALITY' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE = NATIONALITY
     WHERE ID = V_ID_NO
    UNION ALL
    SELECT B.NAME, BIRTH_COUNTRY AS CODE, 'BIRTH_COUNTRY' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE1 = BIRTH_COUNTRY
     WHERE ID = V_ID_NO
    UNION ALL
    SELECT B.NAME,
           REP_NATIONALITY_CODE AS CODE,
           'REP_NATIONALITY_CODE' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE1 = REP_NATIONALITY_CODE
     WHERE ID = V_ID_NO
    UNION ALL
    SELECT B.NAME,
           REP_NATIONALITY_CODE1 AS CODE,
           'REP_NATIONALITY_CODE1' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE1 = REP_NATIONALITY_CODE1
     WHERE ID = V_ID_NO
    UNION ALL
    SELECT B.NAME, TAX_COUNTRY2 AS CODE, 'TAX_COUNTRY2' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE = TAX_COUNTRY2
     WHERE ID = V_ID_NO
    UNION ALL
    SELECT B.NAME, TAX_COUNTRY3 AS CODE, 'TAX_COUNTRY3' AS KIND
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY B
        ON B.COUNTRY_CODE = A.TAX_COUNTRY3
     WHERE A.ID = V_ID_NO;

    --回傳TAX.PDF用欄位
    -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
    OPEN TaxPdfData FOR
    SELECT A.US_TAX,                                --是否在美國地區報稅
           -- 2019.04.15 tingting 調整TAX.PDF的稅籍國家1直接回傳'中華民國'
           '中華民國' AS TAX_COUNTRY1,               --稅籍國家1
           A.TAX_NUM1,                              --稅籍編號1
           A.TAXNOREASON1,                          --無稅籍編號理由1
           A.TAXATION_REMARK1,                      --無稅籍編號原因1
           T2.NAME AS TAX_COUNTRY2,                 --稅籍國家2
           A.TAX_NUM2,                              --稅籍編號2
           A.TAXNOREASON2,                          --無稅籍編號理由2
           A.TAXATION_REMARK2,                      --無稅籍編號原因2
           T3.NAME AS TAX_COUNTRY3,                 --稅籍國家3
           A.TAX_NUM3,                              --稅籍編號3
           A.TAXNOREASON3,                          --無稅籍編號理由3
           A.TAXATION_REMARK3,                      --無稅籍編號原因3
           A.ID,                                    --身份證字號
           A.NAME,                                  --姓名
           -- 2019.04.15 tingting 調整TAX.PDF的居住地址和通訊地址要顯示完整地址
           A.CURRENT_CITY || A.CURRENT_AREA || A.CURRENT_ADDRESS AS CURRENT_ADDRESS,    --居住地址
           A.CURRENT_CITY,                          --居住地址(城市)
           B.NAME AS CURRENT_ADDRESS_COUNTRY,       --居住地址(國家)
           A.CURRENT_POST_CODE,                     --居住地址(郵遞區號)
           -- 2019.04.15 tingting 調整TAX.PDF的居住地址和通訊地址要顯示完整地址
           A.CONTACT_CITY || A.CONTACT_AREA || A.CONTACT_ADDRESS AS CONTACT_ADDRESS,    --通訊地址
           A.CONTACT_CITY,                          --通訊地址(城市)
           C.NAME AS CONTACT_ADDRESS_COUNTRY,       --通訊地址(國家)
           A.POST_CODE AS CONTACT_POST_CODE,        --通訊地址(郵遞區號)
           D.NAME AS BIRTH_COUNTRY,                 --出生地點(國家)
		   -- 2022.03.02 Chengyu 調整PDF生日日期格式顯示
           TO_CHAR(A.BIRTH_DATE, 'YYYY/MM/DD') AS BIRTH_DATE    --出生日期(西元日/月/年)
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.COUNTRY T1  --國別代碼檔(稅籍國家1)
        ON T1.COUNTRY_CODE = A.TAX_COUNTRY1
      LEFT JOIN FAS.COUNTRY T2  --國別代碼檔(稅籍國家2)
        ON T2.COUNTRY_CODE = A.TAX_COUNTRY2
      LEFT JOIN FAS.COUNTRY T3  --國別代碼檔(稅籍國家3)
        ON T3.COUNTRY_CODE = A.TAX_COUNTRY3
      LEFT JOIN FAS.COUNTRY B   --國別代碼檔(居住地址(國家))
        ON B.COUNTRY_CODE1 = A.CURRENT_ADDRESS_COUNTRY
      LEFT JOIN FAS.COUNTRY C   --國別代碼檔(通訊地址(國家))
        ON C.COUNTRY_CODE1 = A.CONTACT_ADDRESS_COUNTRY
      LEFT JOIN FAS.COUNTRY D   --國別代碼檔(出生地點(國家))
        ON D.COUNTRY_CODE1 = A.BIRTH_COUNTRY
     WHERE A.ID = V_ID_NO;

END S_API_GET_OPEN_ACC_PDFDATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPEN_ACC_PDFDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPEN_ACC_PROGRESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPEN_ACC_PROGRESS" 
-- =============================================
-- Author:      
-- Create date: 
-- Description: 開戶進度查詢
-- 2021.03.02 JIANXIN 因應線上核印進行調整
-- 2021.03.02 JIANXIN 新增傳出參數：開戶類別　1：預約開戶；2：無紙化開戶
-- =============================================
(V_ID VARCHAR2, -- 身分證
OUTMSG  OUT SYS_REFCURSOR,
OUTDT   OUT SYS_REFCURSOR
) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);                                                
  X_NAME VARCHAR2(100);
  X_MOBILE VARCHAR(20);
  X_PROCESS_CODE VARCHAR(2);
  X_OPEN_TYPE VARCHAR2(6);
  X_COUNT INT;               
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  BEGIN

    BEGIN
      SELECT NAME
             ,MOBILE
             -- 2021.03.02 JIANXIN 因應線上核印進行調整
             ,CASE WHEN OPEN_TYPE = '2' AND PROCESS_CODE = '0' AND 
                        (FIS_SEAL_DATE_TWD <> TO_DATE('19000101','YYYYMMDD') OR 
                         FIS_SEAL_DATE_FCY <> TO_DATE('19000101','YYYYMMDD') OR
                         TDCC_SEAL_DATE <> TO_DATE('19000101','YYYYMMDD') OR
                         TDCC_SEAL_DATE_FCY <> TO_DATE('19000101','YYYYMMDD')                          
                        )  THEN  '1'  
                   ELSE PROCESS_CODE END PROCESS_CODE        
             -- 2021.03.02 JIANXIN 新增傳出參數：開戶類別　1：預約開戶；2：無紙化開戶
             ,OPEN_TYPE
        INTO X_NAME,X_MOBILE,X_PROCESS_CODE,X_OPEN_TYPE
        FROM ECS.HOLDER 
       WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_Message := '受益人開戶資料不存在!';
        X_ResultCode := '1';
        X_IsSuccessful := '0';
        GOTO TO_END;
    END;

    BEGIN
      SELECT B.CNT INTO X_COUNT 
      FROM FAS.HOLDER A
      JOIN (SELECT ID,COUNT(*) CNT FROM FAS.HOLDER_AMC WHERE ID = V_ID GROUP BY ID) B ON B.ID = A.ID
      WHERE A.ID = V_ID AND A.EC_DATE IS NOT NULL AND B.CNT = 4;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_IsSuccessful := '1';
        GOTO TO_END;
    END;   

    X_PROCESS_CODE := '8';   
  END;


  <<TO_END>>
  OPEN OUTMSG FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

  OPEN OUTDT FOR
  --開戶進度狀態
    SELECT X_NAME AS "NAME", 
           X_MOBILE AS "MOBILE" ,
           X_PROCESS_CODE  AS "STATUS" ,
           -- 2021.03.02 JIANXIN 新增傳出參數：開戶類別　1：預約開戶；2：無紙化開戶
           X_OPEN_TYPE AS OPEN_TYPE
    FROM DUAL;


END S_API_GET_OPEN_ACC_PROGRESS;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPEN_ACC_PROGRESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPEN_ACC_TEMPDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPEN_ACC_TEMPDATA" 
-- =============================================
-- Author:    Jason
-- Create date: 2018/07/25
-- Description: 取得預約開戶填寫資料欄位
-- 2019.03.22 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
-- 2019.04.10 tingting 調整地址是否相同的判斷，也要判斷城市和地區
-- 2019.04.26 tingting 調整用必輸的某個欄位判斷是否填寫過此步驟資料，防止DB預設值造成前端網頁誤判
-- 2019.06.13 tingting 調整地址是否相同的判斷，也要判斷國家
-- 2019.06.14 tingting 因為網頁控制會有問題，Table增加地址是否相同的欄位，並改Table取
-- 2020.06.12 tingting 因應第二階段開戶調整：傳加傳出核印狀態欄位
-- 2020.07.07 JIANXIN 因應第二階段開戶調整：傳加傳出是否完整上傳證件欄位
-- 2020.07.17 tingting 因應第二階段開戶調整：傳加傳出AC_LENGTH帳號長度、IS_MMA是否為綜合帳戶、IS_FCY是否為FCY、IS_ONLINE是否可線上核印欄位
-- 2020.12.16 Chengyu 預約開戶與線上開戶確認頁步驟代碼為99
-- 2022.08.04 JIANXIN 新增KYC 題目取得
-- 2022.09.25 JIANXIN 修正KYC 題目之分數處理
-- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
-- =============================================
(
    V_ID_NO             VARCHAR2,           -- 身分證
    Main                OUT SYS_REFCURSOR,  -- 回傳的 Main
    CusInfo             OUT SYS_REFCURSOR,  -- 回傳的 基本資料
    CusAccount          OUT SYS_REFCURSOR,  -- 回傳的 銀行帳號清單
    CusKycInfo          OUT SYS_REFCURSOR,  -- 回傳的 KYC分數
    CusKycDetail        OUT SYS_REFCURSOR,  -- 回傳的 KYC明細資料
    CusTaxInfoTmp       OUT SYS_REFCURSOR,  -- 回傳的 稅務聲明資料
    OpenLoginInfoTmp    OUT SYS_REFCURSOR   -- 回傳的 預約開戶登入資料
) IS
BEGIN

    --Main
    OPEN Main FOR
    SELECT ID,                  --客戶ID
           OPEN_TYPE,           --開戶類別\1：預約開戶；2：無紙化開戶
           -- 2020.07.07 JIANXIN 因應第二階段開戶調整：傳加傳出是否完整上傳證件欄位
           IS_UPLOAD_PAPERWORK, --是否完整上傳證件\Y：已完整上傳；N：未完整上傳
           STEP_ID,             --資料填寫步驟代號
		   -- 2020.12.16 Chengyu 預約開戶與線上開戶確認頁步驟代碼為99
           CASE WHEN STEP_ID ='99' THEN '9'
                ELSE '1' 
                END AS OPEN_TEMP_STATUS     --開戶進度狀態
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO;

    --CusInfo 基本資料
    -- 2019.03.22 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
    OPEN CusInfo FOR
    SELECT HOLDER_TMP.*
           -- 2019.04.10 tingting 調整地址是否相同的判斷，也要判斷城市和地區
           -- 2019.06.13 tingting 調整地址是否相同的判斷，也要判斷國家
           -- 2019.06.14 tingting 因為網頁控制會有問題，Table增加地址是否相同的欄位，並改Table取
           --CASE WHEN CONTACT_ADDRESS_COUNTRY || CONTACT_CITY || CONTACT_AREA || CONTACT_ADDRESS = REG_ADDRESS_COUNTRY || REG_CITY || REG_AREA || REG_ADDRESS THEN 'Y' ELSE 'N' END AS IS_SAME_PERM_ADDR,                    --通訊地址是否等同戶籍地址
           --CASE WHEN CURRENT_ADDRESS_COUNTRY || CURRENT_CITY || CURRENT_AREA || CURRENT_ADDRESS = REG_ADDRESS_COUNTRY || REG_CITY || REG_AREA || REG_ADDRESS THEN 'Y' ELSE 'N' END AS IS_SAME_CURRENT_REG,                  --居住地址是否等同戶籍地址
           --CASE WHEN CURRENT_ADDRESS_COUNTRY || CURRENT_CITY || CURRENT_AREA || CURRENT_ADDRESS = CONTACT_ADDRESS_COUNTRY || CONTACT_CITY || CONTACT_AREA || CONTACT_ADDRESS THEN 'Y' ELSE 'N' END AS IS_SAME_CURRENT_PERM  --居住地址是否等同通訊地址
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
       -- 2019.04.26 tingting 調整用必輸的某個欄位判斷是否填寫過此步驟資料，防止DB預設值造成前端網頁誤判
       AND HOLDER_TMP.REG_ADDRESS IS NOT NULL;

    --CusAccount 銀行帳號清單
    OPEN CusAccount FOR
    --財金扣款帳號(台幣)
    SELECT 'AC1A' AS ACC_TYPE,
           A.FIS_CURRENCY_NO_TWD AS CURRENCY_NO,
           A.FIS_BANK_NO_TWD AS BANK_NO,
           A.FIS_BRANCH_NO_TWD AS BRANCH_NO,
           A.FIS_AC_CODE_TWD AS AC_CODE,
           -- 2020.06.12 tingting 因應第二階段開戶調整：傳加傳出核印狀態欄位
           CASE WHEN NVL(A.FIS_SEAL_DATE_TWD,TO_DATE('1900/01/01','YYYY/MM/DD')) <> TO_DATE('1900/01/01','YYYY/MM/DD') THEN 'S'
                WHEN NVL(A.FIS_SEAL_DATE_TWD,TO_DATE('1900/01/01','YYYY/MM/DD')) = TO_DATE('1900/01/01','YYYY/MM/DD') AND B.PAYMENT_GATEWAY = 'Y' AND B.PAYEE_GATEWAY = 'Y' AND B.IS_ONLINE_NTD = 'Y' THEN 'F'
                ELSE 'X' 
                END IS_SEAL,                --核印狀態 S：核印完成；F：尚未核印；X：不可核印
           -- 2020.07.17 tingting 因應第二階段開戶調整：傳加傳出AC_LENGTH帳號長度、IS_MMA是否為綜合帳戶、IS_FCY是否為FCY、IS_ONLINE是否可線上核印欄位
           B.AC_LENGTH,                     --帳號長度
           B.MMA_CHECKED AS IS_MMA,         --是否為綜合帳戶(一帳戶除了外幣也含台幣)
           B.FCY_CHECKED AS IS_FCY,         --是否為FCY(一帳戶只有外幣不含台幣)
           B.IS_ONLINE_NTD AS IS_ONLINE     --是否可線上核印
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BANK B
        ON B.BANK_NO = A.FIS_BANK_NO_TWD
     WHERE A.ID = V_ID_NO AND FIS_AC_CODE_TWD IS NOT NULL
    UNION ALL
    --財金扣款帳號(FCY)
    SELECT 'AC1B' AS ACC_TYPE,
           A.FIS_CURRENCY_NO_FCY AS CURRENCY_NO,
           A.FIS_BANK_NO_TWD_FCY AS BANK_NO,
           A.FIS_BRANCH_NO_TWD_FCY AS BRANCH_NO,
           A.FIS_AC_CODE_TWD_FCY AS AC_CODE,
           -- 2020.06.12 tingting 因應第二階段開戶調整：傳加傳出核印狀態欄位
           CASE WHEN NVL(A.FIS_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) <> TO_DATE('1900/01/01','YYYY/MM/DD') THEN 'S'
                WHEN NVL(A.FIS_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) = TO_DATE('1900/01/01','YYYY/MM/DD') AND B.PAYMENT_GATEWAY = 'Y' AND B.PAYEE_GATEWAY = 'Y' AND B.IS_ONLINE_FCY = 'Y' THEN 'F'
                ELSE 'X' 
                END IS_SEAL,                --核印狀態 S：核印完成；F：尚未核印；X：不可核印
           -- 2020.07.17 tingting 因應第二階段開戶調整：傳加傳出AC_LENGTH帳號長度、IS_MMA是否為綜合帳戶、IS_FCY是否為FCY、IS_ONLINE是否可線上核印欄位
           B.AC_LENGTH,                     --帳號長度
           B.MMA_CHECKED AS IS_MMA,         --是否為綜合帳戶(一帳戶除了外幣也含台幣)
           B.FCY_CHECKED AS IS_FCY,         --是否為FCY(一帳戶只有外幣不含台幣)
           B.IS_ONLINE_FCY AS IS_ONLINE     --是否可線上核印
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BANK B
        ON B.BANK_NO = A.FIS_BANK_NO_TWD_FCY
     WHERE A.ID = V_ID_NO AND FIS_AC_CODE_TWD_FCY IS NOT NULL
    UNION ALL
    --集保扣款帳號(台幣/MMA)
    SELECT 'AC2A' AS ACC_TYPE,
           A.TDCC_CURRENCY_NO AS CURRENCY_NO,
           A.TDCC_BANK_NO AS BANK_NO,
           A.TDCC_BRANCH_NO AS BRANCH_NO,
           A.TDCC_AC_CODE AS AC_CODE,
           -- 2020.06.12 tingting 因應第二階段開戶調整：傳加傳出核印狀態欄位
           CASE WHEN NVL(A.TDCC_SEAL_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) <> TO_DATE('1900/01/01','YYYY/MM/DD') THEN 'S'
                WHEN NVL(A.TDCC_SEAL_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) = TO_DATE('1900/01/01','YYYY/MM/DD') AND B.PAYMENT_GATEWAY = 'Y' AND B.PAYEE_GATEWAY = 'Y' AND B.IS_TDCC = 'Y' THEN 'F'
                ELSE 'X' 
                END IS_SEAL,                --核印狀態 S：核印完成；F：尚未核印；X：不可核印
           -- 2020.07.17 tingting 因應第二階段開戶調整：傳加傳出AC_LENGTH帳號長度、IS_MMA是否為綜合帳戶、IS_FCY是否為FCY、IS_ONLINE是否可線上核印欄位
           B.AC_LENGTH,                     --帳號長度
           B.MMA_CHECKED AS IS_MMA,         --是否為綜合帳戶(一帳戶除了外幣也含台幣)
           B.FCY_CHECKED AS IS_FCY,         --是否為FCY(一帳戶只有外幣不含台幣)
           B.IS_ONLINE_NTD AS IS_ONLINE     --是否可線上核印
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BANK B
        ON B.BANK_NO = A.TDCC_BANK_NO
     WHERE A.ID = V_ID_NO AND TDCC_AC_CODE IS NOT NULL
    UNION ALL
    --集保扣款帳號(FCY)
    SELECT 'AC2B' AS ACC_TYPE,
           A.TDCC_CURRENCY_NO_FCY AS CURRENCY_NO,
           A.TDCC_BANK_NO_TWD_FCY AS BANK_NO,
           A.TDCC_BRANCH_NO_TWD_FCY AS BRANCH_NO,
           A.TDCC_AC_CODE_TWD_FCY AS AC_CODE,
           -- 2020.06.12 tingting 因應第二階段開戶調整：傳加傳出核印狀態欄位
           CASE WHEN NVL(A.TDCC_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) <> TO_DATE('1900/01/01','YYYY/MM/DD') THEN 'S'
                WHEN NVL(A.TDCC_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) = TO_DATE('1900/01/01','YYYY/MM/DD') AND B.PAYMENT_GATEWAY = 'Y' AND B.PAYEE_GATEWAY = 'Y' AND B.IS_TDCC = 'Y' THEN 'F'
                ELSE 'X' 
                END IS_SEAL,                --核印狀態 S：核印完成；F：尚未核印；X：不可核印
           -- 2020.07.17 tingting 因應第二階段開戶調整：傳加傳出AC_LENGTH帳號長度、IS_MMA是否為綜合帳戶、IS_FCY是否為FCY、IS_ONLINE是否可線上核印欄位
           B.AC_LENGTH,                     --帳號長度
           B.MMA_CHECKED AS IS_MMA,         --是否為綜合帳戶(一帳戶除了外幣也含台幣)
           B.FCY_CHECKED AS IS_FCY,         --是否為FCY(一帳戶只有外幣不含台幣)
           B.IS_ONLINE_FCY AS IS_ONLINE     --是否可線上核印
      FROM ECS.HOLDER_TMP A
      LEFT JOIN FAS.FIS_BANK B
        ON B.BANK_NO = A.TDCC_BANK_NO_TWD_FCY
     WHERE A.ID = V_ID_NO AND TDCC_AC_CODE_TWD_FCY IS NOT NULL;

    --CusKycInfo KYC分數
    OPEN CusKycInfo FOR
    SELECT KYC_SCROE,           --KYC分數
           RISK_LEVEL,          --客戶風險屬性\1：保守型(7~14分)；2：穩健型(15~24分)；3：積極型(25~35分)
             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
           VULNERABLE_CLAIM,    --自主申購聲明\1：空值；2：同意；3：不同意
           EMPLOYER             --服務單位名稱
      FROM ECS.HOLDER_TMP
     WHERE ID = V_ID_NO
       -- 2019.04.26 tingting 調整用必輸的某個欄位判斷是否填寫過此步驟資料，防止DB預設值造成前端網頁誤判
       AND HOLDER_TMP.RISK_LEVEL IS NOT NULL;

    --CusKycDetail KYC明細資料
    OPEN CusKycDetail FOR
    --家庭狀況 - 婚姻
    SELECT 'CusKycDetail' TableName,
           'A01' KYC_CODE,
           MARRIED KYC_ITEM,
           MARRIED_OTHER KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --家庭狀況 - 子女數
    SELECT 'CusKycDetail' TableName,
           'A02' KYC_CODE,
           MS_NUM_CODE KYC_ITEM,
           TO_CHAR(MS_NUM) KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --職業別
    SELECT 'CusKycDetail' TableName,
           'A03' KYC_CODE,
           PROFESSION KYC_ITEM,
           PROFESSION_OTHERS_NEW KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --服務單位名稱
    SELECT 'CusKycDetail' TableName,
           'A04' KYC_CODE,
           EMPLOYER KYC_ITEM,
           EMPLOYER KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --職務
    SELECT 'CusKycDetail' TableName,
           'A05' KYC_CODE,
           POSITION KYC_ITEM,
           POSITION_OTHERS KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --重大傷病證明
    SELECT 'CusKycDetail' TableName,
           'A06' KYC_CODE,
           MAJOR_ILLNESS KYC_ITEM,
           '' KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --預估投資金額
    SELECT 'CusKycDetail' TableName,
           'A07' KYC_CODE,
           INVEST_CODE KYC_ITEM,
           '' KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --投資理財資訊來源(可複選)
    SELECT 'CusKycDetail' TableName,
           'A08' KYC_CODE,
           INV_KNOWLEDGE KYC_ITEM,
           INV_KNOWLEDGE_OTHER KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --投資資金來源(可複選)
    SELECT 'CusKycDetail' TableName,
           'A09' KYC_CODE,
           INV_ORI KYC_ITEM,
           INV_ORI_OTHER KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    -- 2022.08.04 JIANXIN 新增KYC 題目取得
    --目前居住及照護狀態(可複選)
    SELECT 'CusKycDetail' TableName,
           'A10' KYC_CODE,
           CUST_RESIDENCE_STATUS KYC_ITEM,
           CUST_RESIDENCE_STATUS_TXT KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --目前身心狀態
    SELECT 'CusKycDetail' TableName,
           'A11' KYC_CODE,
           CUST_MIND_STATUS KYC_ITEM,
           '' KYC_OTHER_MEMO,
           0 KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --客戶年齡層
    SELECT 'CusKycDetail' TableName,
           'B01' KYC_CODE,
           BF_AGE_CODE KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(BF_AGE_CODE) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --學歷
    SELECT 'CusKycDetail' TableName,
           'B02' KYC_CODE,
           EDUCATION KYC_ITEM,
           '' KYC_OTHER_MEMO,
           CASE EDUCATION
                WHEN 'a' THEN 1
                WHEN 'A' THEN 2
                WHEN 'B' THEN 3  
                WHEN 'C' THEN 4 
                WHEN 'D' THEN 5 
                ELSE 0
                END AS KYC_SCOREE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --投資理財工具
    SELECT 'CusKycDetail' TableName,
           'B03' KYC_CODE,
           INV_TOOL KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(INV_TOOL) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --投資經驗
    SELECT 'CusKycDetail' TableName,
           'B04' KYC_CODE,
           INV_EXPERIENCE KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(INV_EXPERIENCE) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --投資目的
    SELECT 'CusKycDetail' TableName,
           'B05' KYC_CODE,
           INV_GOAL KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(INV_GOAL) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --基金投資損失時採取的措施
    SELECT 'CusKycDetail' TableName,
           'B06' KYC_CODE,
           INV_FAIL_METHOD KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(INV_FAIL_METHOD) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --個人或家庭平均年收入
    SELECT 'CusKycDetail' TableName,
           'B07' KYC_CODE,
           FAMILY_INCOME KYC_ITEM,
           '' KYC_OTHER_MEMO,
           CASE FAMILY_INCOME
                WHEN 'A' THEN 1
                WHEN 'B' THEN 2
                WHEN 'C' THEN 3  
                WHEN 'D' THEN 4 
                WHEN 'E' THEN 5 
                ELSE 0
                END AS KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    -- 2022.08.04 JIANXIN 新增KYC 題目取得
    -- 2022.09.25 JIANXIN 修正KYC 題目之分數處理
    --重大資金需求
    SELECT 'CusKycDetail' TableName,
           'B08' KYC_CODE,
           SIGNIFICANT_NEEDS KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(SIGNIFICANT_NEEDS) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --流動性資金需求
    SELECT 'CusKycDetail' TableName,
           'B09' KYC_CODE,
           LIQUIDITY_NEEDS KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(LIQUIDITY_NEEDS) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO
    UNION ALL
    --價格波動承受度
    SELECT 'CusKycDetail' TableName,
           'B10' KYC_CODE,
           PRICE_VOLATILITY KYC_ITEM,
           '' KYC_OTHER_MEMO,
           TO_NUMBER(PRICE_VOLATILITY) KYC_SCORE
      FROM ECS.HOLDER_TMP
     WHERE HOLDER_TMP.ID = V_ID_NO;

    --CusTaxInfoTmp 稅務聲明資料
    -- 2019.03.22 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳出欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
    OPEN CusTaxInfoTmp FOR
    SELECT US_TAX,              --美國報稅\Y：需有報稅紀錄；N：不可有報稅紀錄
           FATCA_TYPE,          --FATCA分類\C：Non US Person
           TAX_COUNTRY1,        --稅籍國家1
           TAX_NUM1,            --稅籍編號1
           TAXNOREASON1,        --無法提供稅籍編號理由1
           TAXATION_REMARK1,    --無法取得稅籍編號原因1
           TAX_COUNTRY2,        --稅籍國家2
           TAX_NUM2,            --稅籍編號2
           TAXNOREASON2,        --無法提供稅籍編號理由2
           TAXATION_REMARK2,    --無法取得稅籍編號原因2
           TAX_COUNTRY3,        --稅籍國家3
           TAX_NUM3,            --稅籍編號3
           TAXNOREASON3,        --無法提供稅籍編號理由3
           TAXATION_REMARK3     --無法取得稅籍編號原因3
      FROM ECS.HOLDER_TMP
     WHERE ID = V_ID_NO;

    --OpenLoginInfoTmp 預約開戶登入資料
    OPEN OpenLoginInfoTmp FOR
    SELECT NAME,                --戶名
           MOBILE_COUNTRY,      --行動電話國別
           MOBILE               --行動電話
      FROM ECS.HOLDER_TMP
     WHERE ID = V_ID_NO;

END S_API_GET_OPEN_ACC_TEMPDATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPEN_ACC_TEMPDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPEN_PAPER_FINISH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPEN_PAPER_FINISH" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得預約開戶完成頁面需要的資料
  -- =============================================
(V_ID_NO VARCHAR2, -- 身分證
 OUTDT   OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得預約開戶完成頁面需要的資料)
 ) IS

BEGIN

  OPEN OUTDT FOR
  --取得預約開戶完成頁面需要的資料
    SELECT A.NAME,
           A.MOBILE,
           A.EMAIL,
           A.POST_CODE,
           A.CONTACT_ADDRESS,
           (B.APPLY_DTTM + C.OPEN_DATA_KEEP_DAY) AS OPEN_EXPIRE_DATE
      FROM ECS.HOLDER A
      JOIN ECS.HOLDER_TMP B
        ON A.ID = B.ID
      JOIN ECS.SYSTEM_PARAMETER C
        ON 1 = 1
     WHERE A.ID = V_ID_NO;

END S_API_GET_OPEN_PAPER_FINISH;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPEN_PAPER_FINISH" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_OPEN_UPLOAD_FILES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_OPEN_UPLOAD_FILES" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得客戶開戶上傳檔案
  -- =============================================
(V_ID_NO      VARCHAR2, -- 身分證
 V_LOAD_FILES VARCHAR2, -- 載入檔案清單(以,號分隔)
 OUTDT        OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客戶開戶上傳檔案)
 ) IS

BEGIN

  OPEN OUTDT FOR
  --取得客戶開戶上傳檔案
    SELECT A.UPLOAD_TYPE, A.UPLOAD_FILENAME
      FROM ECS.HOLDER_UPLOAD_DATA A
      JOIN (SELECT VALUE1
              FROM table(ecs.f_formatstringlisttotable(V_LOAD_FILES))) T
        ON T.VALUE1 = A.UPLOAD_TYPE
     WHERE ID = V_ID_NO;

END S_API_GET_OPEN_UPLOAD_FILES;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_OPEN_UPLOAD_FILES" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_PDF_NAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_PDF_NAME" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得PDF檔案名稱所需資訊
  -- =============================================
(V_ID_NO VARCHAR2, -- 身分證
 OUTDT   OUT SYS_REFCURSOR -- 取得PDF檔案名稱所需資訊
 ) IS

BEGIN

  OPEN OUTDT FOR
  --取得PDF檔案名稱所需資訊
    SELECT BIRTH_DATE,ID FROM ECS.HOLDER_TMP WHERE ID = V_ID_NO;

END S_API_GET_PDF_NAME;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_PDF_NAME" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_ROBO_SIGN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_ROBO_SIGN" 
-- =============================================
  -- Author:        王仁劭
  -- Create date:   20180810
  -- Description:   透過戶號取得受益人生日以及身分證
  -- =============================================
(V_ACCOUNT_NO   IN NUMBER, --戶號
 OUTDT  OUT SYS_REFCURSOR, --ResultModel
 OUTDT2 OUT SYS_REFCURSOR --輸出
 ) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);

  X_COUNT   NUMBER;

BEGIN

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  --取得戶號
  BEGIN
    SELECT COUNT(*) INTO X_COUNT FROM FAS.HOLDER WHERE ACCOUNT_NO =V_ACCOUNT_NO;

    IF X_COUNT = 0 THEN
      BEGIN
        X_Message      := '身份驗證失敗!!';
        X_IsSuccessful := '0';
        X_ResultCode   := '1';
        GOTO TO_END;
      END;      
    END IF;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

  OPEN OUTDT2 FOR
    SELECT ID,BIRTH_DATE FROM FAS.HOLDER WHERE ACCOUNT_NO =V_ACCOUNT_NO;

END S_API_GET_ROBO_SIGN;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_ROBO_SIGN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_SAVETOHELP_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_SAVETOHELP_DATA" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 取得客服幫我印資料
  -- =============================================
(V_ID_NO VARCHAR2, -- 身分證
 OUTDT   OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客服幫我印資料)
 ) IS
BEGIN 

  OPEN OUTDT FOR
    SELECT A.NAME,
           A.MOBILE,
           A.EMAIL,
           A.POST_CODE,
           A.CONTACT_ADDRESS,
           (A.APPLY_DTTM + B.OPEN_DATA_KEEP_DAY) AS OPEN_EXPIRE_DATE
      FROM ECS.HOLDER A
      JOIN ECS.SYSTEM_PARAMETER B
        ON 1 = 1
     WHERE A.ID = V_ID_NO;

END S_API_GET_SAVETOHELP_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_SAVETOHELP_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_SHORT_MESSAGE_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_SHORT_MESSAGE_DATA" 

(
V_SMS_CODE IN VARCHAR2,
OUTMSG OUT SYS_REFCURSOR, -- 回傳的 TABLEDATA
OUTDT OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
 ) IS

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_SMS_CODE         VARCHAR2(10);       --簡訊代號
  X_SMS_TEXT         VARCHAR2(500);      --簡訊內容
  X_PRIORITY     NUMBER(10,0);       --傳送優先權(0~9 )
  X_EXPIRE_TIME  NUMBER(10,0);       --簡訊到期時間(秒)
  X_SENDER_ID    VARCHAR2(15);       --處理人員 ID
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';  


 	 BEGIN
     SELECT SMS_CODE,SMS_TEXT,PRIORITY,EXPIRE_TIME,SENDER_ID INTO X_SMS_CODE,X_SMS_TEXT,X_PRIORITY,X_EXPIRE_TIME,X_SENDER_ID
             FROM ECS.SHORT_MESSAGE
            WHERE SMS_CODE = V_SMS_CODE;
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       X_Message      := REPLACE('簡訊代碼{CODE}不存在!','{CODE}',V_SMS_CODE);
       X_IsSuccessful := '0';
       X_ResultCode   := '1';
       GOTO TO_END;
   END;

  <<TO_END>>
  OPEN OUTMSG FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

  OPEN OUTDT FOR
    SELECT X_SMS_CODE      AS "SMS_CODE",
           X_SMS_TEXT      AS "SMS_TEXT",
           X_PRIORITY      AS "PRIORITY",
           X_EXPIRE_TIME   AS "EXPIRE_TIME",           
           X_SENDER_ID     AS "SENDER_ID"
      FROM DUAL;      

END S_API_GET_SHORT_MESSAGE_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_SHORT_MESSAGE_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_GET_SUBBANK_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_GET_SUBBANK_DATA" 
-- =============================================
-- Author:      
-- Create date: 
-- Description: 取得銀行分行資料
-- 2019.01.30 JIANXIN MOD BY 依據銀行簡稱排序
-- =============================================
(
    W_BANK_NO VARCHAR2, -- 銀行碼
    OUTDT   OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (財金扣款銀行總行資訊清單)
) IS

BEGIN

  OPEN OUTDT FOR
  --取得分行資料
    SELECT BANK_NO, BRANCH_NO, SNAME BRANCH_NAME, ENAME BRANCH_ENAME
      FROM FAS.FIS_BRANCH
     WHERE FAS.FIS_BRANCH.BANK_NO = W_BANK_NO
     -- 2019.01.30 JIANXIN MOD BY 依據銀行簡稱排序
     ORDER BY SNAME ;

END S_API_GET_SUBBANK_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_GET_SUBBANK_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_OPEN_CHECK_TOKEN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_OPEN_CHECK_TOKEN" (V_ID IN VARCHAR2, --使用者代號
                                          V_TOKEN_ID  IN VARCHAR2, --TokenId
                                          OUTDT       OUT SYS_REFCURSOR) IS
  X_SRNO            NUMBER;
  X_CREATE_TIME     DATE;
  X_REFRESH_TIME    DATE;
  X_TIMEOUT_MINUTES NUMBER;
  X_TOKEN_STATUS    VARCHAR2(10);

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);

BEGIN

  -- 指定變數
  X_SRNO            := 0;
  X_CREATE_TIME     := SYSDATE;
  X_REFRESH_TIME    := SYSDATE;
  X_TIMEOUT_MINUTES := 0;
  X_TOKEN_STATUS    := '';

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  --TOKEN為空
  BEGIN
    IF V_TOKEN_ID IS NULL THEN
      BEGIN
        X_Message      := '由於逾時過久或者版本更新，確保您資料安全與版本，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --取得Token資料
  BEGIN
    BEGIN
      SELECT SRNO, CREATION_DATE, REFRESH_TIME, TIMEOUT_MINUTES, TOKEN_STATUS
        INTO X_SRNO,
             X_CREATE_TIME,
             X_REFRESH_TIME,
             X_TIMEOUT_MINUTES,
             X_TOKEN_STATUS
        FROM ECS.OPEN_TOKEN_POOL --WITH(NOLOCK)
       WHERE ID = V_ID
         AND TOKEN_ID = V_TOKEN_ID;
    EXCEPTION WHEN NO_DATA_FOUND THEN
          X_Message      := '您所登入憑證資料不存在，煩請重新登入!';
          X_ResultCode   := '7';
          X_IsSuccessful := '0';
          GOTO TO_END;
    END;
  END;

  --換版，造成憑證失效
  BEGIN
    IF X_SRNO = 0 THEN
      BEGIN
        X_Message      := '您所登入憑證資料不存在，煩請重新登入!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;       
      END;
    END IF;
  END;

  --換版，造成憑證失效
  BEGIN
    IF X_TOKEN_STATUS = '1' THEN
      BEGIN
        X_Message      := '目前版本更換中或者已更換過版本，為確保版本的正確性及舊版本暫存資料清除，煩請關閉瀏覽器後再登入系統!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;       
      END;    
    END IF;
  END;

  --重覆登入，造成憑證失效
  BEGIN
    IF X_TOKEN_STATUS = '2' THEN
      BEGIN
        X_Message      := '您重複登入造成舊有憑證失效，煩請重新登入!';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --登出
  BEGIN
    IF X_TOKEN_STATUS = '3' THEN
      BEGIN
        X_Message      := '您已經登出造成舊有憑證失效，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  --過期，造成憑證失效
  BEGIN
    SELECT X_REFRESH_TIME + X_TIMEOUT_MINUTES / 60 / 24
      INTO X_REFRESH_TIME
      FROM DUAL;
    IF X_REFRESH_TIME < SYSDATE THEN
      BEGIN
        X_Message      := '由於逾時過久，確保您資料安全，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  BEGIN
    UPDATE ECS.OPEN_TOKEN_POOL
       SET REFRESH_TIME = SYSDATE
     WHERE ID = V_ID
       AND TOKEN_ID = V_TOKEN_ID;
    GOTO TO_END;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_OPEN_CHECK_TOKEN;

/

  GRANT EXECUTE ON "ECS"."S_API_OPEN_CHECK_TOKEN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_OPEN_CLOSE_TOKEN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_OPEN_CLOSE_TOKEN" 
-- =============================================
-- Author:      Joseph
-- Create date: 2018/11/14
-- Description: 關閉 token
-- =============================================
(
  V_ID          IN VARCHAR2, --使用者代號
  V_TOKEN_ID    IN VARCHAR2, --TokenId
  OUTDT         OUT SYS_REFCURSOR
) IS
  X_SRNO            NUMBER;
  X_CREATE_TIME     DATE;
  X_REFRESH_TIME    DATE;
  X_TIMEOUT_MINUTES NUMBER;
  X_TOKEN_STATUS    VARCHAR2(10);

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);

BEGIN

  -- 指定變數
  X_SRNO            := 0;
  X_CREATE_TIME     := SYSDATE;
  X_REFRESH_TIME    := SYSDATE;
  X_TIMEOUT_MINUTES := 0;
  X_TOKEN_STATUS    := '';

  X_Message         := ''; -- 錯誤訊息
  X_ResultCode      := '0'; -- 訊息代碼
  X_IsSuccessful    := '1';

  --TOKEN為空
  BEGIN
    IF V_TOKEN_ID IS NULL THEN
      BEGIN
        X_Message      := '由於逾時過久或者版本更新，確保您資料安全與版本，煩請重新登入';
        X_ResultCode   := '7';
        X_IsSuccessful := '0';
        GOTO TO_END;
      END;
    END IF;
  END;

  BEGIN
    UPDATE ECS.OPEN_TOKEN_POOL
--       SET REFRESH_TIME = SYSDATE
         SET TOKEN_STATUS = '3'
     WHERE ID = V_ID
       AND TOKEN_ID = V_TOKEN_ID;

    /* 預設是成功，所以不需要特別更新回傳值 */
    GOTO TO_END;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_OPEN_CLOSE_TOKEN;

/

  GRANT EXECUTE ON "ECS"."S_API_OPEN_CLOSE_TOKEN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_OPEN_CREATE_TOKEN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_OPEN_CREATE_TOKEN" (V_ID              VARCHAR2, -- 使用者代號
                                                        V_TOKEN_ID        VARCHAR2, -- TokenId
                                                        V_TIMEOUT_MINUTES NUMBER, -- 逾時時間
                                                        OUTDT             OUT SYS_REFCURSOR -- 輸出
                                                        ) IS
  -- =============================================
  -- Author:    Hugo
  -- Create date: 2018/07/13
  -- Description: 開戶產生Token
  -- =============================================
  X_IsSuccessful VARCHAR2(1); -- 是否成功
  X_Message      VARCHAR2(255); -- 錯誤訊息
  X_ResultCode   VARCHAR2(30); -- ResultCode

  X_CREATE_TIME  DATE; -- 產生時間
  X_REFRESH_TIME DATE; -- 更新時間

BEGIN

  -- 指定變數
  X_IsSuccessful := '1'; -- 受否成功
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := 0; -- 訊息代碼
  X_CREATE_TIME  := SYSDATE; -- 建立時間
  X_REFRESH_TIME := SYSDATE; -- 更新時間

  --檢查客戶(UserInfo)是否存在
  BEGIN
    --將舊的Token更新重複登入
    UPDATE ECS.OPEN_TOKEN_POOL
       SET TOKEN_STATUS = '2'
     WHERE ID = V_ID
       AND TOKEN_STATUS = '0';

    --產生Token
    INSERT INTO ECS.OPEN_TOKEN_POOL
      (ID,
       TOKEN_ID,
       CREATION_DATE,
       REFRESH_TIME,
       TIMEOUT_MINUTES,
       TOKEN_STATUS)
    VALUES
      (V_ID,
       V_TOKEN_ID,
       X_CREATE_TIME,
       X_REFRESH_TIME,
       V_TIMEOUT_MINUTES,
       '0');
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_OPEN_CREATE_TOKEN;

/

  GRANT EXECUTE ON "ECS"."S_API_OPEN_CREATE_TOKEN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_SAVE_HELP_PRINT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_SAVE_HELP_PRINT" 
-- =============================================
-- Author:      
-- Create date: 2018/08/08
-- Description: 客服幫我印
-- 2018.09.27 JIANXIN MOD BY 調整 客服幫我印 更新的欄位
-- =============================================
(
     V_ID  IN VARCHAR2
    ,OUTDT OUT SYS_REFCURSOR
) IS

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_ID           VARCHAR2(255);

BEGIN

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  BEGIN
    BEGIN
      SELECT ID INTO X_ID
        FROM ECS.HOLDER
       WHERE ID = V_ID;
    EXCEPTION WHEN NO_DATA_FOUND THEN
          X_Message      := '受益人開戶資料不存在!';
          X_ResultCode   := '1';
          X_IsSuccessful := '0';
          GOTO TO_END;
    END;
  END;

  BEGIN
    -- 2018.09.27 JIANXIN MOD BY 調整 客服幫我印 更新的欄位
    UPDATE  ECS.HOLDER 
       SET  DOC_CODE = 'Y'
           ,DOC_APPLY_DT = SYSDATE 
     WHERE ID = V_ID;
  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_SAVE_HELP_PRINT;

/

  GRANT EXECUTE ON "ECS"."S_API_SAVE_HELP_PRINT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_SAVE_OPEN_ACC_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_SAVE_OPEN_ACC_DATA" 
-- =============================================
-- Author:      Jason
-- Create date: 20180723
-- Description: 手機上傳檔案
-- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
-- 2019.04.10 tingting 調整取檔名、副檔名方式(因檔名是ID未四碼加生日+_....，若開戶證件上傳後再異動生日，會replace不掉檔名，造成副檔名過長INSERT錯誤)
-- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
-- 2020.08.26 tingting 因應線上開戶調整：增加判斷，線上開戶才儲存線上核印確認日期
-- 2020.08.28 by Chengyu 因線上開戶新增推薦人欄位
-- 2020.11.03 by Chengyu 調整戶號取得方式、新增欄位TDCC_ACCT_NO(集保戶號)
-- 2022.08.04 JIANXIN 新增KYC 題目儲存
-- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
-- =============================================
(
 V_ID_NO         VARCHAR2, -- 身分證
 V_ID_ADDR_A     VARCHAR2, --ID_ADDR
 V_ID_ADDR_B     VARCHAR2, --ID_ADDR
 V_ID_ADDR_C     VARCHAR2, --ID_ADDR
 V_ID_ADDR_D     VARCHAR2, --ID_ADDR
 V_DAYTIME       DATE,     -- 統一系統時間
 V_DOC_FILE_PATH VARCHAR2, --檔案路徑
 V_PDF_FILE      BLOB,     -- PDF檔案
 V_PDF_NAME      VARCHAR2, -- PDF名稱
 
 OUTDT OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
) IS
  X_Message       VARCHAR2(255);
  X_ResultCode    VARCHAR2(30);
  X_IsSuccessful  VARCHAR2(1);
BEGIN

  -- 指定變數
  X_Message       := ''; -- 錯誤訊息
  X_ResultCode    := '0'; -- 訊息代碼
  X_IsSuccessful  := '1';

  BEGIN

    DELETE FROM ECS.HOLDER WHERE ID = V_ID_NO;

    --ECS.HOLDER(預約開戶資料)
    INSERT INTO ECS.HOLDER
      (ID,
       OPEN_TYPE,
       IS_ES_ACCOUNT,
       ACCOUNT_NO,
       NAME,
       FIRST_NAME,
       MIDDLE_NAME,
       LAST_NAME,
       BIRTH_DATE,
       NATIONALITY,
       BIRTH_COUNTRY,
       TEL_H_COUNTRY,
       TEL_H_AREA,
       TEL_H_NO,
       TEL_H_EXT,
       TEL_O_COUNTRY,
       TEL_O_AREA,
       TEL_O_NO,
       TEL_O_EXT,
       MOBILE_COUNTRY,
       MOBILE,
       FAX_COUNTRY,
       FAX_AREA,
       FAX_NO,
       FAX_EXT,
       EMAIL,
       CONTACT_ADDRESS_COUNTRY,
       POST_CODE,
       CONTACT_ADDRESS,
       REG_ADDRESS_COUNTRY,
       REG_POST_CODE,
       REG_ADDRESS,
       -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
       CURRENT_ADDRESS_COUNTRY,
       CURRENT_POST_CODE,
       CURRENT_ADDRESS,
       REP_NATIONALITY_CODE,
       REPRESENTATIVE,
       REPRESENTATIVE_ID,
       REP_BIRTH_DATE,
       REP_ADDRESS,
       REP_NATIONALITY_CODE1,
       REPRESENTATIVE1,
       REPRESENTATIVE1_ID,
       REP_BIRTH_DATE1,
       REP_ADDRESS1,
       EDM_ACCEPTED,
       NAV_EPAPER,
       US_TAX,
       FATCA_TYPE,
       TAX_COUNTRY1,
       TAX_NUM1,
       TAXNOREASON1,
       -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
       TAXATION_REMARK1,
       TAX_COUNTRY2,
       TAX_NUM2,
       TAXNOREASON2,
       -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
       TAXATION_REMARK2,
       TAX_COUNTRY3,
       TAX_NUM3,
       TAXNOREASON3,
       -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
       TAXATION_REMARK3,
       FIS_CURRENCY_NO_TWD,
       FIS_BANK_NO_TWD,
       FIS_BRANCH_NO_TWD,
       FIS_AC_CODE_TWD,
       -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
       FIS_SEAL_DATE_TWD,
       FIS_CURRENCY_NO_FCY,
       FIS_BANK_NO_TWD_FCY,
       FIS_BRANCH_NO_TWD_FCY,
       FIS_AC_CODE_TWD_FCY,
       -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
       FIS_SEAL_DATE_FCY,
       -- 2020.11.03 by Chengyu 調整戶號取得方式、新增欄位TDCC_ACCT_NO(集保戶號)
       TDCC_ACCT_NO,
       TDCC_CURRENCY_NO,
       TDCC_BANK_NO,
       TDCC_BRANCH_NO,
       TDCC_AC_CODE,
       -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
       TDCC_SEAL_DATE,
       TDCC_CURRENCY_NO_FCY,
       TDCC_BANK_NO_TWD_FCY,
       TDCC_BRANCH_NO_TWD_FCY,
       TDCC_AC_CODE_TWD_FCY,
       -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
       TDCC_SEAL_DATE_FCY,
       MARRIED,
       MARRIED_OTHER,
       MS_NUM_CODE,
       MS_NUM,
       PROFESSION,
       PROFESSION_OTHERS_NEW,
       POSITION,
       POSITION_OTHERS,
       MAJOR_ILLNESS,
       INVEST_CODE,
       INV_KNOWLEDGE,
       INV_KNOWLEDGE_OTHER,
       INV_ORI,
       INV_ORI_OTHER,
       -- 2022.08.04 JIANXIN 新增KYC 題目儲存
       CUST_RESIDENCE_STATUS,
       CUST_RESIDENCE_STATUS_TXT,
       CUST_MIND_STATUS,
       BF_AGE_CODE,
       EDUCATION,
       INV_TOOL,
       INV_EXPERIENCE,
       INV_GOAL,
       INV_FAIL_METHOD,
       FAMILY_INCOME,
       -- 2022.08.04 JIANXIN 新增KYC 題目儲存
       SIGNIFICANT_NEEDS,
       LIQUIDITY_NEEDS,
       PRICE_VOLATILITY,
       GENDAR,
       KYC_SCROE,
       RISK_LEVEL,
       EMPLOYER,
       DOC_CODE,
       -- 2020.08.28 by Chengyu 因線上開戶新增推薦人欄位
       SPONSOR_ID,
       APPLY_DTTM,
       IP_A,
       IP_B,
       IP_C,
       IP_D,
       PROCESS_CODE,
       RECEIPT_DOC_EMAIL,
       STATUS,
       CREATEID,
       CREATEDATE,
       ENTRYID,
       ENTRYDATE,
       UPDATEID,
       UPDATEDATE,
       VERIFYID,
       VERIFYDATE,
       APPROVEID,
       APPROVEDATE,
       DATAFLAG,
       -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
       VULNERABLE_CLAIM
       )
      select ID,
             OPEN_TYPE,
             IS_ES_ACCOUNT,
             -- 2020.11.03 by Chengyu 調整戶號取得方式、新增欄位TDCC_ACCT_NO(集保戶號)
             ACCOUNT_NO,
             NAME,
             FIRST_NAME,
             MIDDLE_NAME,
             LAST_NAME,
             BIRTH_DATE,
             NATIONALITY,
             BIRTH_COUNTRY,
             TEL_H_COUNTRY,
             TEL_H_AREA,
             TEL_H_NO,
             TEL_H_EXT,
             TEL_O_COUNTRY,
             TEL_O_AREA,
             TEL_O_NO,
             TEL_O_EXT,
             MOBILE_COUNTRY,
             MOBILE,
             FAX_COUNTRY,
             FAX_AREA,
             FAX_NO,
             FAX_EXT,
             EMAIL,
             CONTACT_ADDRESS_COUNTRY,
             POST_CODE,
             CONTACT_CITY || CONTACT_AREA || CONTACT_ADDRESS,
             REG_ADDRESS_COUNTRY,
             REG_POST_CODE,
             REG_CITY || REG_AREA || REG_ADDRESS,
             -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
             CURRENT_ADDRESS_COUNTRY,
             CURRENT_POST_CODE,
             CURRENT_CITY || CURRENT_AREA || CURRENT_ADDRESS,
             REP_NATIONALITY_CODE,
             REPRESENTATIVE,
             REPRESENTATIVE_ID,
             REP_BIRTH_DATE,
             REP_ADDRESS,
             REP_NATIONALITY_CODE1,
             REPRESENTATIVE1,
             REPRESENTATIVE1_ID,
             REP_BIRTH_DATE1,
             REP_ADDRESS1,
             EDM_ACCEPTED,
             NAV_EPAPER,
             US_TAX,
             FATCA_TYPE,
             TAX_COUNTRY1,
             TAX_NUM1,
             TAXNOREASON1,
             -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
             TAXATION_REMARK1,
             TAX_COUNTRY2,
             TAX_NUM2,
             TAXNOREASON2,
             -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
             TAXATION_REMARK2,
             TAX_COUNTRY3,
             TAX_NUM3,
             TAXNOREASON3,
             -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
             TAXATION_REMARK3,
             FIS_CURRENCY_NO_TWD,
             FIS_BANK_NO_TWD,
             FIS_BRANCH_NO_TWD,
             FIS_AC_CODE_TWD,
             -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
             -- 2020.08.26 tingting 因應線上開戶調整：增加判斷，線上開戶才儲存線上核印確認日期
             CASE WHEN OPEN_TYPE = '2' THEN FIS_SEAL_DATE_TWD ELSE NULL END AS FIS_SEAL_DATE_TWD,
             FIS_CURRENCY_NO_FCY,
             FIS_BANK_NO_TWD_FCY,
             FIS_BRANCH_NO_TWD_FCY,
             FIS_AC_CODE_TWD_FCY,
             -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
             -- 2020.08.26 tingting 因應線上開戶調整：增加判斷，線上開戶才儲存線上核印確認日期
             CASE WHEN OPEN_TYPE = '2' THEN FIS_SEAL_DATE_FCY ELSE NULL END AS FIS_SEAL_DATE_FCY,
             -- 2020.11.03 by Chengyu 調整戶號取得方式、新增欄位TDCC_ACCT_NO(集保戶號)
             TDCC_ACCT_NO,
             TDCC_CURRENCY_NO,
             TDCC_BANK_NO,
             TDCC_BRANCH_NO,
             TDCC_AC_CODE,
             -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
             -- 2020.08.26 tingting 因應線上開戶調整：增加判斷，線上開戶才儲存線上核印確認日期
             CASE WHEN OPEN_TYPE = '2' THEN TDCC_SEAL_DATE ELSE NULL END AS TDCC_SEAL_DATE,
             TDCC_CURRENCY_NO_FCY,
             TDCC_BANK_NO_TWD_FCY,
             TDCC_BRANCH_NO_TWD_FCY,
             TDCC_AC_CODE_TWD_FCY,
             -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
             -- 2020.08.26 tingting 因應線上開戶調整：增加判斷，線上開戶才儲存線上核印確認日期
             CASE WHEN OPEN_TYPE = '2' THEN TDCC_SEAL_DATE_FCY ELSE NULL END AS TDCC_SEAL_DATE_FCY,
             MARRIED,
             MARRIED_OTHER,
             MS_NUM_CODE,
             MS_NUM,
             PROFESSION,
             PROFESSION_OTHERS_NEW,
             POSITION,
             POSITION_OTHERS,
             MAJOR_ILLNESS,
             INVEST_CODE,
             INV_KNOWLEDGE,
             INV_KNOWLEDGE_OTHER,
             INV_ORI,
             INV_ORI_OTHER,
             -- 2022.08.04 JIANXIN 新增KYC 題目儲存
             CUST_RESIDENCE_STATUS,
             CUST_RESIDENCE_STATUS_TXT,
             CUST_MIND_STATUS,
             BF_AGE_CODE,
             EDUCATION,
             INV_TOOL,
             INV_EXPERIENCE,
             INV_GOAL,
             INV_FAIL_METHOD,
             FAMILY_INCOME,
             -- 2022.08.04 JIANXIN 新增KYC 題目儲存
             SIGNIFICANT_NEEDS,
             LIQUIDITY_NEEDS,
             PRICE_VOLATILITY,
             GENDAR,
             KYC_SCROE,
             RISK_LEVEL,
             EMPLOYER,
             'N',
             -- 2020.08.28 by Chengyu 因線上開戶新增推薦人欄位
             SPONSOR_ID,
             V_DAYTIME,
             V_ID_ADDR_A,
             V_ID_ADDR_B,
             V_ID_ADDR_C,
             V_ID_ADDR_D,
             '0',
             'N',
             '301',
             'ECS',
             V_DAYTIME,
             'ECS',
             V_DAYTIME,
             'ECS',
             V_DAYTIME,
             'ECS',
             V_DAYTIME,
             'ECS',
             V_DAYTIME,
             UTL_RAW.CAST_TO_RAW(SYS_GUID()),
             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
             VULNERABLE_CLAIM
        from ECS.HOLDER_TMP
       WHERE ID = V_ID_NO;

   EXCEPTION
    WHEN OTHERS THEN
        X_Message      := '產生開戶資料失敗(寫入)';
        X_ResultCode   := '1';
        X_IsSuccessful := '0';
        GOTO TO_END;

  END;
  BEGIN

    DELETE FROM ECS.HOLDER_DOC WHERE ID = V_ID_NO;

    INSERT INTO ECS.HOLDER_DOC
      (ID,
       LIMIT_AMT,
       DOC_FILE_NAME,
       DOC_FILE_EXTEND,
       DOC_FILE_PATH,
       SOURCE_CD,
       STATUS,
       CREATEID,
       CREATEDATE,
       ENTRYID,
       ENTRYDATE,
       UPDATEID,
       UPDATEDATE,
       VERIFYID,
       VERIFYDATE,
       APPROVEID,
       APPROVEDATE,
       REJECTID,
       REJECTDATE,
       DATA_SEQ)
      select ID AS ID,
             (case
               when UPLOAD_TYPE = 'ID1A' then
                '1'
               when UPLOAD_TYPE = 'ID1B' then
                '2'
               when UPLOAD_TYPE = 'ID2A' then
                '3'
               when UPLOAD_TYPE = 'ID2B' then
                '4'
               when UPLOAD_TYPE = 'AC1A' then
                '5'
               when UPLOAD_TYPE = 'AC1B' then
                '6'
               when UPLOAD_TYPE = 'AC2A' then
                '7'
               when UPLOAD_TYPE = 'AC2B' then
                '8'
               when UPLOAD_TYPE = 'RP1A' then
                '9'
               when UPLOAD_TYPE = 'RP1B' then
                '10'
               when UPLOAD_TYPE = 'RP2A' then
                '11'
               when UPLOAD_TYPE = 'RP2B' then
                '12'
               when UPLOAD_TYPE = 'RP3A' then
                '13'
               when UPLOAD_TYPE = 'RP3B' then
                '14'
               when UPLOAD_TYPE = 'RP4A' then
                '15'
               when UPLOAD_TYPE = 'RP4B' then
                '16'
               when UPLOAD_TYPE = 'ERROR' then
                '31'
               when UPLOAD_TYPE = 'ERROR' then
                '32'
               else
                '99'
             end) AS LIMIT_AMT,
             -- 2019.04.10 tingting 調整取檔名、副檔名方式(因檔名是ID未四碼加生日+_....，若開戶證件上傳後再異動生日，會replace不掉檔名，造成副檔名過長INSERT錯誤)
             --V_PDF_NAME || '_' || UPLOAD_TYPE AS DOC_FILE_NAME,
             SUBSTR(UPLOAD_FILENAME, 1, INSTR(UPLOAD_FILENAME, '.') - 1) AS DOC_FILE_NAME,
             --replace(UPLOAD_FILENAME, V_PDF_NAME || '_' || UPLOAD_TYPE, '') AS DOC_FILE_EXTEND,
             SUBSTR(UPLOAD_FILENAME, INSTR(UPLOAD_FILENAME, '.')) AS DOC_FILE_EXTEND,
             V_DOC_FILE_PATH || UPLOAD_FILENAME AS DOC_FILE_PATH,
             'C' AS SOURCE_CD,
             '301' AS STATUS,
             'ECS' AS CREATEID,
             V_DAYTIME AS CREATEDATE,
             'ECS' AS ENTRYID,
             V_DAYTIME AS ENTRYDATE,
             'ECS' AS UPDATEID,
             V_DAYTIME AS UPDATEDATE,
             'ECS' AS VERIFYID,
             V_DAYTIME AS VERIFYDATE,
             'ECS' AS APPROVEID,
             V_DAYTIME AS APPROVEDATE,
             'ECS' AS REJECTID,
             V_DAYTIME AS REJECTDATE,
             ECS.HOLDER_DOC_SEQUENCE.NEXTVAL
        from ECS.HOLDER_UPLOAD_DATA
       WHERE ID = V_ID_NO;
  END;

  BEGIN

    DELETE FROM WPS.RISK_ASSESSMENT_PDF WHERE ID = V_ID_NO;

    INSERT INTO WPS.RISK_ASSESSMENT_PDF
      (ID, DATE_OF_FILLING, GROUP_TYPE, FUNC, PDF_FILE, SN)
    VALUES
      (V_ID_NO,
       V_DAYTIME,
       'E',
       'ECReg',
       V_PDF_FILE,
       WPS.sequence_risk_assessment_pdf.NEXTVAL);

  END;
  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_SAVE_OPEN_ACC_DATA;

/

  GRANT EXECUTE ON "ECS"."S_API_SAVE_OPEN_ACC_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_SAVE_OPEN_ACC_TEMPDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_SAVE_OPEN_ACC_TEMPDATA" 
-- =============================================
-- Author:        王仁劭
-- Create date:   20180724
-- Description:   儲存開戶暫存資料
-- 2018.10.25 JIANXIN 增加性別的判斷
-- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加傳入欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
-- 2019.06.14 tingting 因為網頁控制會有問題，Table增加地址是否相同的欄位，進行調整
-- 2020.07.08 tingting 因應線上開戶調整：最後一步調整成99(原06-1)
-- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
-- 2020.08.26 tingting 因應線上開戶調整：增加更新開戶類別
-- 2020.08.28 by Chengyu 因線上開戶新增推薦人欄位
-- 2020.09.16 by Chengyu 開戶步驟整理Update語法、新增集保扣款資料代碼(AC2A、AC2B)
-- 2020.11.03 by Chengyu ECS.HOLDER_TMP新增資料時，舊戶寫入Account_no(戶號)
-- 2022.08.04 JIANXIN 新增KYC 題目儲存
-- 2022.12.28 JIANXIN 民法調整成年人由20歲下修18歲，法定代理人檢查調整
-- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
-- =============================================
(
 --必要值
 V_ID_NO                               IN VARCHAR2, --身分證
 V_OPEN_TYPE                           IN VARCHAR2, --開戶類別\1：預約開戶；2：無紙化開戶
 V_IS_UPLOAD_PAPERWORK                 IN VARCHAR2, --是否已完整上傳證件\Y：已完整上傳；N：未完整上傳
 V_STEP_ID                             IN VARCHAR2, --步驟代號
 V_NEXT_STEP_ID                        IN VARCHAR2, --下一步之步驟代號

 --Update判斷式
 V_IS_OpenLoginInfo                    IN VARCHAR2,
 V_IS_CusInfo                          IN VARCHAR2,
 V_IS_CusTaxInfo                       IN VARCHAR2,
 V_IS_CusAccount                       IN VARCHAR2,
 V_IS_CusKycInfo                       IN VARCHAR2,

 --預約開戶第一步驟
 V_NAME                                IN VARCHAR2, --中文姓名
 V_MOBILE_COUNTRY                      IN VARCHAR2, --行動電話 –國碼
 V_MOBILE                              IN VARCHAR2, --行動電話

 --個人資訊
 V_FIRST_NAME                          IN VARCHAR2, --英文名
 V_MIDDLE_NAME                         IN VARCHAR2, --英文中間名
 V_LAST_NAME                           IN VARCHAR2, --英文姓氏

 V_BIRTH_DATE                          IN DATE, --出生日期
 V_NATIONALITY                         IN VARCHAR2, --國籍
 V_BIRTH_COUNTRY                       IN VARCHAR2, --出生地國碼

 V_TEL_H_COUNTRY                       IN VARCHAR2, --電話(宅) – 國碼
 V_TEL_H_AREA                          IN VARCHAR2, --電話(宅) – 區碼
 V_TEL_H_NO                            IN VARCHAR2, --電話(宅) – 電話
 V_TEL_H_EXT                           IN VARCHAR2, --電話(宅) – 分機
 V_TEL_O_COUNTRY                       IN VARCHAR2, --電話(公) – 國碼
 V_TEL_O_AREA                          IN VARCHAR2, --電話(公) – 區碼
 V_TEL_O_NO                            IN VARCHAR2, --電話(公) – 電話
 V_TEL_O_EXT                           IN VARCHAR2, --傳真1 – 國碼
 V_FAX_COUNTRY                         IN VARCHAR2, --傳真1 – 國碼
 V_FAX_AREA                            IN VARCHAR2, --傳真1 – 區碼
 V_FAX_NO                              IN VARCHAR2, --傳真1 – 電話
 V_FAX_EXT                             IN VARCHAR2, --傳真1 – 分機

 V_EMAIL                               IN VARCHAR2, --EMAIL
 V_CONTACT_ADDRESS_COUNTRY             IN VARCHAR2, --通訊地址國碼
 V_POST_CODE                           IN VARCHAR2, --通訊郵遞區號
 V_CONTACT_ADDRESS                     IN VARCHAR2, --通訊地址
 V_REG_ADDRESS_COUNTRY                 IN VARCHAR2, --戶籍地址國碼
 V_REG_POST_CODE                       IN VARCHAR2, --戶籍郵遞區號
 V_REG_ADDRESS                         IN VARCHAR2, --戶籍地址
 V_IS_SAME_PERM_ADDR                   IN VARCHAR2, --通訊地址是否等同戶籍地址\"Y":是, "N":否
 V_CURRENT_ADDRESS_COUNTRY             IN VARCHAR2, --居住地址國碼
 V_CURRENT_POST_CODE                   IN VARCHAR2, --居住郵遞區號
 V_CURRENT_ADDRESS                     IN VARCHAR2, --居住地址
 V_IS_SAME_CURRENT_REG                 IN VARCHAR2, --居住地址是否等同戶籍地址\"Y":是, "N":否
 V_IS_SAME_CURRENT_PERM                IN VARCHAR2, --居住地址是否等同通訊地址\"Y":是, "N":否

 V_REP_NATIONALITY_CODE                IN VARCHAR2, --法定代理人(父) 國籍
 V_REPRESENTATIVE                      IN VARCHAR2, --法定代理人(父) 姓名
 V_REPRESENTATIVE_ID                   IN VARCHAR2, --法定代理人(父) ID
 V_REP_NATIONALITY_CODE1               IN VARCHAR2, --法定代理人(母) 國籍
 V_REPRESENTATIVE1                     IN VARCHAR2, --法定代理人(母) 姓名
 V_REPRESENTATIVE1_ID                  IN VARCHAR2, --法定代理人(母) ID

 V_EDM_ACCEPTED                        IN VARCHAR2, --訂閱瀚亞電子報\N：否；Y：是
 V_NAV_EPAPER                          IN VARCHAR2, --訂閱淨值電子報\N：否；Y：是
 V_SPONSOR_ID                          IN VARCHAR2, --推薦人ID
 
 V_CONTACT_CITY                        IN VARCHAR2, --通訊地址城市
 V_CONTACT_AREA                        IN VARCHAR2, --通訊地址市區鄉鎮
 V_REG_CITY                            IN VARCHAR2, --戶籍地址城市
 V_REG_AREA                            IN VARCHAR2, --戶籍地址市區鄉鎮
 V_CURRENT_CITY                        IN VARCHAR2, --居住地址城市
 V_CURRENT_AREA                        IN VARCHAR2, --居住地址市區鄉鎮

 --CusTaxInfoTmp 稅務聲明資料
 V_US_TAX                              IN VARCHAR2, --美國報稅\Y：需有報稅紀錄；N：不可有報稅紀錄
 V_FATCA_TYPE                          IN VARCHAR2, --FATCA分類\C：Non US Person
 V_TAX_COUNTRY1                        IN VARCHAR2, --稅籍國家1\為2碼的國籍代碼
 V_TAX_NUM1                            IN VARCHAR2, --稅籍編號1
 V_TAXNOREASON1                        IN VARCHAR2, --無法提供稅籍編號理由1
 V_TAXATION_REMARK1                    IN VARCHAR2, --無法取得稅籍編號原因1
 V_TAX_COUNTRY2                        IN VARCHAR2, --稅籍國家2\為2碼的國籍代碼
 V_TAX_NUM2                            IN VARCHAR2, --稅籍編號2
 V_TAXNOREASON2                        IN VARCHAR2, --無法提供稅籍編號理由2
 V_TAXATION_REMARK2                    IN VARCHAR2, --無法取得稅籍編號原因2
 V_TAX_COUNTRY3                        IN VARCHAR2, --稅籍國家3\為2碼的國籍代碼
 V_TAX_NUM3                            IN VARCHAR2, --稅籍編號3
 V_TAXNOREASON3                        IN VARCHAR2, --無法提供稅籍編號理由3
 V_TAXATION_REMARK3                    IN VARCHAR2, --無法取得稅籍編號原因3

 --CusAccountTmp 銀行帳號清單
 V_FIS_CURRENCY_NO_TWD                 IN VARCHAR2, --財金 - 幣別(台幣)
 V_FIS_BANK_NO_TWD                     IN VARCHAR2, --財金 - 銀行代號(台幣)
 V_FIS_BRANCH_NO_TWD                   IN VARCHAR2, --財金 - 分行代號(台幣)
 V_AFIS_AC_CODE_TWD                    IN VARCHAR2, --財金 - 分行代號(台幣)

 V_FIS_CURRENCY_NO_FCY                 IN VARCHAR2, --財金 - 幣別(外幣)
 V_FIS_BANK_NO_TWD_FCY                 IN VARCHAR2, --財金 - 銀行代號(外幣)
 V_FIS_BRANCH_NO_TWD_FCY               IN VARCHAR2, --財金 - 分行代號(外幣)
 V_FIS_AC_CODE_TWD_FCY                 IN VARCHAR2, --財金 - 分行代號(外幣)

 V_TDCC_CURRENCY_NO                    IN VARCHAR2, --集保 - 幣別(台幣/MMA)
 V_TDCC_BANK_NO                        IN VARCHAR2, --集保 - 銀行代號(台幣/MMA)
 V_TDCC_BRANCH_NO                      IN VARCHAR2, --集保 - 分行代號(台幣/MMA)
 V_TDCC_AC_CODE                        IN VARCHAR2, --集保 - 約定帳號(台幣/MMA)

 V_TDCC_CURRENCY_NO_FCY                IN VARCHAR2, --集保 - 幣別(外幣)
 V_TDCC_BANK_NO_TWD_FCY                IN VARCHAR2, --集保 - 銀行代號(外幣)
 V_TDCC_BRANCH_NO_TWD_FCY              IN VARCHAR2, --集保 - 分行代號(外幣)
 V_TDCC_AC_CODE_TWD_FCY                IN VARCHAR2, --集保 - 約定帳號(外幣)

 --CusKycInfoTmp KYC分數
 V_KYC_SCROE  IN NUMBER, --KYC分數
 V_RISK_LEVEL IN VARCHAR2, --客戶風險屬性\1：保守型(7~14分)；2：穩健型(15~24分)；3：積極型(25~35分)
 -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
 V_VULNERABLE_CLAIM IN VARCHAR2, --自主申購聲明\1：空值；2：同意；3：不同意

 --CusKycDetail KYC明細資料
 V_MARRIED                             IN VARCHAR2, --家庭狀況
 V_MARRIED_OTHER                       IN VARCHAR2,
 V_MS_NUM_CODE                         IN VARCHAR2, --子女數
 V_MS_NUM                              IN VARCHAR2,
 V_PROFESSION                          IN VARCHAR2, --職業別
 V_PROFESSION_OTHERS_NEW               IN VARCHAR2,
 V_EMPLOYER                            IN VARCHAR2, --服務單位名稱
 V_POSITION                            IN VARCHAR2, --職務
 V_POSITION_OTHERS                     IN VARCHAR2,
 V_MAJOR_ILLNESS                       IN VARCHAR2, --全民健康保險重大傷病證明
 V_INVEST_CODE                         IN VARCHAR2, --預估投資金額
 V_INV_KNOWLEDGE                       IN VARCHAR2, --投資理財資訊來源(可複選)
 V_INV_KNOWLEDGE_OTHER                 IN VARCHAR2, --投資理財資訊來源(其他)
 V_INV_ORI                             IN VARCHAR2, --投資資金來源(可複選)
 V_INV_ORI_OTHER                       IN VARCHAR2,
 -- 2022.08.04 JIANXIN 新增KYC 題目儲存
 V_CUST_RESIDENCE_STATUS               IN VARCHAR2, --目前居住及照護狀態
 V_CUST_RESIDENCE_STATUS_TXT           IN VARCHAR2, --目前居住及照護狀態(說明)
 V_CUST_MIND_STATUS                    IN VARCHAR2, --目前身心狀態

 V_BF_AGE_CODE                         IN VARCHAR2, --客戶年齡層
 V_EDUCATION                           IN VARCHAR2, --學歷
 V_INV_TOOL                            IN VARCHAR2, --常用理財工具
 V_INV_EXPERIENCE                      IN VARCHAR2, --投資經驗
 V_INV_GOAL                            IN VARCHAR2, --最主要投資目的
 V_INV_FAIL_METHOD                     IN VARCHAR2, --若您有一大筆金額投資在基金 中，一年來基金淨值下滑，投資報 酬率為-15%，這時您/貴公司會採 取的措施為何？
 V_FAMILY_INCOME                       IN VARCHAR2, --個人或家庭平均收入
 -- 2022.08.04 JIANXIN 新增KYC 題目儲存
 V_SIGNIFICANT_NEEDS                   IN VARCHAR2, --重大資金需求
 V_LIQUIDITY_NEEDS                     IN VARCHAR2, --流動性資金需求
 V_PRICE_VOLATILITY                    IN VARCHAR2, --價格波動承受度

 --刪除上傳檔案
 V_UPLOAD_KIND                         IN VARCHAR2, --B表示銀行帳戶, I表示證件
 V_EXT_ID                              IN VARCHAR2, --不刪除的檔案
 V_IS_UPLOAD_DATAS                     IN VARCHAR2, --上傳證件是否有資料

 OUTDT OUT SYS_REFCURSOR
) IS

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_Count        NUMBER;
  X_NOW          DATE;
  V_EXT_NOTIN    VARCHAR2(4000); --不刪除的檔案
  V_BANKLIST     VARCHAR2(4000); --銀行清單
  V_IDLIST       VARCHAR2(4000); --證件清單

  X_BIRTHCHECK NUMBER; --判斷生日
  X_BANKLENGTH NUMBER; --銀行長度
  X_IS_ES_ACCOUNT VARCHAR2(1);
  X_BANK_NAME VARCHAR2(100);

  -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
  X_TAXATION_FLAG2  VARCHAR2(1);    --無稅籍編號理由2是否需輸入
  X_TAXATION_FLAG3  VARCHAR2(1);    --無稅籍編號理由3是否需輸入

  X_ACCOUNT_NO    NUMBER(7, 0); --舊戶戶號

BEGIN

  --初始化訊息
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';
  X_Count        := 0;
  X_NOW          := SYSDATE;
  -- 2020.09.16 by Chengyu 開戶步驟整理Update語法、新增集保扣款資料代碼(AC2A、AC2B)
  V_BANKLIST     := 'AC1A,AC1B,AC2A,AC2B,';
  V_IDLIST       := 'ID1A,ID1B,ID2A,ID2B,RP1A,RP1B,RP2A,RP2B,RP3A,RP3B,RP4A,RP4B,';
  X_IS_ES_ACCOUNT := 'N';

  --初始化資料
  BEGIN
    SELECT COUNT(*) INTO X_Count FROM ECS.HOLDER_TMP WHERE ID = V_ID_NO;

    IF X_Count = 0 THEN
      BEGIN
        IF V_NEXT_STEP_ID != '02_1' THEN
          BEGIN
            X_Message := REPLACE('傳入錯誤步驟代號{1},無法產生開戶暫存資料!',
                                 '{1}',
                                 V_NEXT_STEP_ID);
            GOTO FAIL;
          END;
        END IF;

        X_IS_ES_ACCOUNT := ECS.FN_GET_IS_ES_ACCOUNT(V_ID_NO);

        -- 2020.11.03 by Chengyu ECS.HOLDER_TMP新增資料時，舊戶寫入Account_no(戶號)
        BEGIN
          SELECT ACCOUNT_NO
            INTO X_ACCOUNT_NO
            FROM FAS.HOLDER
           WHERE ID = V_ID_NO;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            X_ACCOUNT_NO := NULL;
        END;

        -- 2018.10.25 JIANXIN 增加性別的判斷
        -- 2020.11.03 by Chengyu ECS.HOLDER_TMP新增資料時，舊戶寫入Account_no(戶號)
        INSERT INTO ECS.HOLDER_TMP
          (ID, GENDAR, OPEN_TYPE, IS_ES_ACCOUNT, STEP_ID, NAME, APPLY_DTTM, IS_UPLOAD_PAPERWORK,ACCOUNT_NO)
        VALUES
          (V_ID_NO, CASE WHEN SUBSTR(V_ID_NO,2,1) = '1' THEN 'M' WHEN SUBSTR(V_ID_NO,2,1) = '2' THEN 'F' ELSE 'C' END, V_OPEN_TYPE, X_IS_ES_ACCOUNT, V_NEXT_STEP_ID, V_ID_NO, X_NOW, V_IS_UPLOAD_PAPERWORK,X_ACCOUNT_NO);
      END;
    ELSE
      BEGIN

       -- 2020.08.26 tingting 因應線上開戶調整：增加更新開戶類別
       -- 2020.09.16 by Chengyu 開戶步驟整理Update語法、新增集保扣款資料代碼(AC2A、AC2B)
       UPDATE ECS.HOLDER_TMP
          SET STEP_ID = V_NEXT_STEP_ID,
              OPEN_TYPE = V_OPEN_TYPE              
        WHERE ID = V_ID_NO;   

        -- 2020.07.08 tingting 因應線上開戶調整：最後一步調整成99(原06-1)
        IF V_NEXT_STEP_ID = '99' THEN
          BEGIN
            UPDATE ECS.HOLDER_TMP
               SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
                   FINISH_DTTM = X_NOW
             WHERE ID = V_ID_NO;             
          END;
        END IF;

      END;
    END IF;
  END;

  --檢核
  BEGIN
    IF V_IS_CusInfo = '1' THEN
      BEGIN
        --英文名
        IF (V_FIRST_NAME IS NULL AND V_LAST_NAME IS NOT NULL) OR(V_FIRST_NAME IS NOT NULL AND V_LAST_NAME IS NULL)  THEN
          BEGIN
            X_Message := '英文名一定要同時填寫FIRST_NAME以及LAST_NAME';
            GOTO FAIL;
          END;
        END IF;
        --出生地
        IF V_NATIONALITY = 'US' THEN
          BEGIN
            X_Message := '出生地不允許美國';
            GOTO FAIL;
          END;
        END IF;
        --國籍
        IF V_BIRTH_COUNTRY = 'USA' THEN
          BEGIN
            X_Message := '國籍不允許美國';
            GOTO FAIL;
          END;
        END IF;

        /*
        --通訊地址國籍TWN時要為數字
        IF V_CONTACT_ADDRESS_COUNTRY = 'TWN' THEN
          SELECT LENGTH(TRIM(TRANSLATE(V_POST_CODE, ' +-.0123456789', ' '))) INTO X_Count FROM DUAL;
            IF X_Count > 0 THEN
              BEGIN
                X_Message := '通訊地址國籍TWN時通訊郵遞區號要為數字';
                GOTO FAIL;
              END;
            END IF;
        END IF;

        --戶籍地址地址國籍TWN時要為數字
        IF V_REG_ADDRESS_COUNTRY = 'TWN' THEN
          SELECT LENGTH(TRIM(TRANSLATE(V_REG_POST_CODE, ' +-.0123456789', ' '))) INTO X_Count FROM DUAL;
            IF X_Count > 0 THEN
              BEGIN
                X_Message := '戶籍地址國籍TWN時戶籍郵遞區號要為數字';
                GOTO FAIL;
              END;
            END IF;
        END IF;
        */

        --出生地
        SELECT COUNT(*)
          INTO X_Count
          FROM FAS.COUNTRY
         WHERE COUNTRY_CODE = V_NATIONALITY;
        IF X_Count = 0 THEN
          BEGIN
            X_Message := '請確認出生地是否正確';
            GOTO FAIL;
          END;
        END IF;

        --國籍
        SELECT COUNT(*)
          INTO X_Count
          FROM FAS.COUNTRY
         WHERE COUNTRY_CODE1 = V_BIRTH_COUNTRY;
        IF X_Count = 0 THEN
          BEGIN
            X_Message := '國籍代號' || V_BIRTH_COUNTRY || '錯誤，請確認國籍是否正確';
            GOTO FAIL;
          END;
        END IF;

        --法定代理人判斷
        SELECT months_between(TRUNC(sysdate),
                              to_date(to_char(V_BIRTH_DATE, 'YYYYMMDD'),
                                      'YYYYMMDD')) / 12
          INTO X_BIRTHCHECK
          from DUAL;

        -- 2022.12.28 JIANXIN 民法調整成年人由20歲下修18歲，法定代理人檢查調整
        IF X_BIRTHCHECK < 18 THEN
          BEGIN

            IF V_REPRESENTATIVE_ID IS NULL AND V_REPRESENTATIVE1_ID IS NULL THEN
              BEGIN
                -- 2022.12.28 JIANXIN 民法調整成年人由20歲下修18歲，法定代理人檢查調整
                X_Message := '18歲以下請填寫兩位代理人資料';
                GOTO FAIL;
              END;
            END IF;

            IF V_REPRESENTATIVE_ID IS NULL OR V_REPRESENTATIVE1_ID IS NULL THEN
              BEGIN
                -- 2022.12.28 JIANXIN 民法調整成年人由20歲下修18歲，法定代理人檢查調整
                X_Message := '18歲以下請填寫兩位代理人資料(缺一)';
                GOTO FAIL;
              END;
            END IF;

            IF V_REP_NATIONALITY_CODE = 'USA' THEN
              BEGIN
                X_Message := '法定代理人(父)國籍不允許美國';
                GOTO FAIL;
              END;
            END IF;

            IF V_REP_NATIONALITY_CODE1 = 'USA' THEN
              BEGIN
                X_Message := '法定代理人(母)國籍不允許美國';
                GOTO FAIL;
              END;
            END IF;

            --法定代理人(父)國籍
            SELECT COUNT(*)
              INTO X_Count
              FROM FAS.COUNTRY
             WHERE COUNTRY_CODE1 = V_REP_NATIONALITY_CODE;
            IF X_Count = 0 THEN
              BEGIN
                X_Message := '請確認法定代理人(父)國籍是否正確';
                GOTO FAIL;
              END;
            END IF;

            --法定代理人(母)國籍
            SELECT COUNT(*)
              INTO X_Count
              FROM FAS.COUNTRY
             WHERE COUNTRY_CODE1 = V_REP_NATIONALITY_CODE1;
            IF X_Count = 0 THEN
              BEGIN
                X_Message := '請確認法定代理人(母)國籍是否正確';
                GOTO FAIL;
              END;
            END IF;

          END;
        END IF;

      END;
    END IF;

    --檢查是否為外國人
    IF V_IS_CusTaxInfo = '1' THEN
      BEGIN

        IF V_US_TAX = 'Y' THEN
          BEGIN
            X_Message := '美國報稅不能為Y';
            GOTO FAIL;
          END;
        END IF;

        -- 2019.04.01 tingting 因應「稅務身份聲明暨個人資料使用同意書」版本異動，進行調整(增加欄位：「居住地址」相關欄位、「無法取得稅籍編號原因」)
        IF V_TAX_COUNTRY2 IS NOT NULL AND V_TAX_NUM2 IS NULL AND
           V_TAXNOREASON2 IS NULL THEN
          BEGIN
            X_Message := '無稅籍編號2，理由必須輸入';
            GOTO FAIL;
          END;
        END IF;

        SELECT COUNT(*)
          INTO X_Count
          FROM FAS.HOLDER_TAXATION_TYPE         --受益人無法取得稅籍原因
         WHERE HOLDER_TAXATION_TYPE.TYPE = V_TAXNOREASON2;

        IF V_TAX_COUNTRY2 IS NOT NULL AND V_TAX_NUM2 IS NULL AND
           V_TAXNOREASON2 IS NOT NULL AND X_Count = 0 THEN
          BEGIN
            X_Message := '無稅籍編號2，理由代碼錯誤';
            GOTO FAIL;
          END;
        END IF;

        IF X_Count > 0 THEN
            SELECT HOLDER_TAXATION_TYPE.FLAG AS TAXATION_FLAG                  --稅籍原因說明欄位是否打開 Y/N
              INTO X_TAXATION_FLAG2
              FROM FAS.HOLDER_TAXATION_TYPE         --受益人無法取得稅籍原因
             WHERE HOLDER_TAXATION_TYPE.TYPE = V_TAXNOREASON2;
        END IF;

        IF V_TAX_COUNTRY2 IS NOT NULL AND V_TAX_NUM2 IS NULL AND
           V_TAXATION_REMARK2 IS NULL AND X_TAXATION_FLAG2 = 'Y' THEN
          BEGIN
            X_Message := '無稅籍編號2，理由為' || V_TAXNOREASON2 || ', 原因必須輸入';
            GOTO FAIL;
          END;
        END IF;

        IF V_TAX_COUNTRY3 IS NOT NULL AND V_TAX_NUM3 IS NULL AND
           V_TAXNOREASON3 IS NULL THEN
          BEGIN
            X_Message := '無稅籍編號3，理由必須輸入';
            GOTO FAIL;
          END;
        END IF;

        SELECT COUNT(*)
          INTO X_Count
          FROM FAS.HOLDER_TAXATION_TYPE         --受益人無法取得稅籍原因
         WHERE HOLDER_TAXATION_TYPE.TYPE = V_TAXNOREASON3;

        IF V_TAX_COUNTRY3 IS NOT NULL AND V_TAX_NUM3 IS NULL AND
           V_TAXNOREASON3 IS NOT NULL AND X_Count = 0 THEN
          BEGIN
            X_Message := '無稅籍編號3，理由代碼錯誤';
            GOTO FAIL;
          END;
        END IF;

        IF X_Count > 0 THEN
            SELECT HOLDER_TAXATION_TYPE.FLAG AS TAXATION_FLAG                  --稅籍原因說明欄位是否打開 Y/N
              INTO X_TAXATION_FLAG3
              FROM FAS.HOLDER_TAXATION_TYPE         --受益人無法取得稅籍原因
             WHERE HOLDER_TAXATION_TYPE.TYPE = V_TAXNOREASON3;
        END IF;

        IF V_TAX_COUNTRY3 IS NOT NULL AND V_TAX_NUM3 IS NULL AND
           V_TAXATION_REMARK3 IS NULL AND X_TAXATION_FLAG3 = 'Y' THEN
          BEGIN
            X_Message := '無稅籍編號3，理由為' || V_TAXNOREASON3 || ', 原因必須輸入';
            GOTO FAIL;
          END;
        END IF;

        IF V_TAX_COUNTRY1 IS NULL AND V_TAX_COUNTRY2 IS NULL AND
           V_TAX_COUNTRY3 IS NULL THEN
          BEGIN
            X_Message := '稅籍國家必須填一組';
            GOTO FAIL;
          END;
        END IF;

      END;
    END IF;

    --檢查KYC資料 (職務別步判定由C#檢核)
    IF V_IS_CusKycInfo = '1' THEN
      BEGIN
        IF V_MARRIED IS NULL OR V_MS_NUM_CODE IS NULL OR
           V_PROFESSION IS NULL 
           OR 
           --V_POSITION IS NULL OR
           V_MAJOR_ILLNESS IS NULL OR V_INVEST_CODE IS NULL OR
           V_INV_KNOWLEDGE IS NULL OR V_INV_ORI IS NULL OR
           -- 2022.08.04 JIANXIN 新增KYC 題目儲存
           V_CUST_RESIDENCE_STATUS IS NULL OR V_CUST_MIND_STATUS IS NULL OR
           V_BF_AGE_CODE IS NULL OR V_EDUCATION IS NULL OR
           V_INV_TOOL IS NULL OR V_INV_EXPERIENCE IS NULL OR
           V_INV_GOAL IS NULL OR V_INV_FAIL_METHOD IS NULL OR
           -- 2022.08.04 JIANXIN 新增KYC 題目儲存
           V_FAMILY_INCOME IS NULL OR V_SIGNIFICANT_NEEDS IS NULL OR 
           V_LIQUIDITY_NEEDS IS NULL OR V_PRICE_VOLATILITY  IS NULL THEN
          BEGIN
            X_Message := 'KYC題目都必須有值';
            GOTO FAIL;
          END;
        END IF;
      END;
    END IF;

    --銀行長度
    IF V_IS_CusAccount = '1' THEN
      BEGIN
        X_BANK_NAME := '';
        IF V_FIS_BANK_NO_TWD IS NOT NULL THEN
          BEGIN
            SELECT AC_LENGTH,NAME
              INTO X_BANKLENGTH,X_BANK_NAME
              FROM FAS.FIS_BANK
             WHERE BANK_NO = V_FIS_BANK_NO_TWD;

            IF X_BANK_NAME = '' THEN
              BEGIN
                X_Message := '財金台幣銀行代號'|| V_FIS_BANK_NO_TWD ||'錯誤';
                GOTO FAIL;                
              END;
            END IF;

            IF X_BANKLENGTH != LENGTH(V_AFIS_AC_CODE_TWD) THEN
              BEGIN
                X_Message := X_BANK_NAME || '只允許長度(' || X_BANKLENGTH || ')碼';
                GOTO FAIL;
              END;
            END IF;
          END;
        END IF;

        X_BANK_NAME := '';
        IF V_FIS_BANK_NO_TWD_FCY IS NOT NULL THEN
          BEGIN
            SELECT AC_LENGTH,NAME
              INTO X_BANKLENGTH,X_BANK_NAME
              FROM FAS.FIS_BANK
             WHERE BANK_NO = V_FIS_BANK_NO_TWD_FCY;

            IF X_BANK_NAME = '' THEN
              BEGIN
                X_Message := '財金外幣銀行代號'|| V_FIS_BANK_NO_TWD_FCY ||'錯誤';
                GOTO FAIL;                
              END;
            END IF;

            IF X_BANKLENGTH != LENGTH(V_FIS_AC_CODE_TWD_FCY) THEN
              BEGIN
                X_Message := X_BANK_NAME || '只允許長度(' || X_BANKLENGTH || ')碼';
                GOTO FAIL;
              END;
            END IF;
          END;
        END IF;

        X_BANK_NAME := '';        
        IF V_TDCC_BANK_NO IS NOT NULL THEN
          BEGIN
            SELECT AC_LENGTH,NAME
              INTO X_BANKLENGTH,X_BANK_NAME
              FROM FAS.FIS_BANK
             WHERE BANK_NO = V_TDCC_BANK_NO;

            IF X_BANK_NAME = '' THEN
              BEGIN
                X_Message := '集保台幣銀行代號'|| V_TDCC_BANK_NO ||'錯誤';
                GOTO FAIL;                
              END;
            END IF;             

            IF X_BANKLENGTH != LENGTH(V_TDCC_AC_CODE) THEN
              BEGIN
                X_Message := X_BANK_NAME || '只允許長度(' || X_BANKLENGTH || ')碼';
                GOTO FAIL;
              END;
            END IF;
          END;
        END IF;

        X_BANK_NAME := ''; 
        IF V_TDCC_BANK_NO_TWD_FCY IS NOT NULL THEN
          BEGIN
            SELECT AC_LENGTH,NAME
              INTO X_BANKLENGTH,X_BANK_NAME
              FROM FAS.FIS_BANK
             WHERE BANK_NO = V_TDCC_BANK_NO_TWD_FCY;

            IF X_BANK_NAME = '' THEN
              BEGIN
                X_Message := '集保外幣銀行代號'|| V_TDCC_BANK_NO_TWD_FCY ||'錯誤';
                GOTO FAIL;                
              END;
            END IF; 

            IF X_BANKLENGTH != LENGTH(V_TDCC_AC_CODE_TWD_FCY) THEN
              BEGIN
                X_Message := X_BANK_NAME || '只允許長度(' || X_BANKLENGTH || ')碼';
                GOTO FAIL;
              END;
            END IF;
          END;
        END IF;

      END;

    END IF;

  END;

  --預約開戶第一步驟
  IF V_IS_OpenLoginInfo = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET NAME           = V_NAME,
             IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
             MOBILE_COUNTRY = V_MOBILE_COUNTRY,
             MOBILE         = V_MOBILE,
             UPDATE_DTTM    = X_NOW
       WHERE ID = V_ID_NO;
    END;
  END IF;

  --個人資訊
  IF V_IS_CusInfo = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
             FIRST_NAME    = V_FIRST_NAME,
             MIDDLE_NAME   = V_MIDDLE_NAME,
             LAST_NAME     = V_LAST_NAME,
             BIRTH_DATE    = V_BIRTH_DATE,
             NATIONALITY   = V_NATIONALITY,
             BIRTH_COUNTRY = V_BIRTH_COUNTRY,
             TEL_H_COUNTRY = V_TEL_H_COUNTRY,
             TEL_H_AREA    = V_TEL_H_AREA,
             TEL_H_NO      = V_TEL_H_NO,
             TEL_H_EXT     = V_TEL_H_EXT,
             TEL_O_COUNTRY = V_TEL_O_COUNTRY,
             TEL_O_AREA    = V_TEL_O_AREA,
             TEL_O_NO      = V_TEL_O_NO,
             TEL_O_EXT     = V_TEL_O_EXT,
             FAX_COUNTRY   = V_FAX_COUNTRY,
             FAX_AREA      = V_FAX_AREA,
             FAX_NO        = V_FAX_NO,
             FAX_EXT       = V_FAX_EXT,

             EMAIL                   = V_EMAIL,
             CONTACT_ADDRESS_COUNTRY = V_CONTACT_ADDRESS_COUNTRY,
             POST_CODE               = TO_MULTI_BYTE(V_POST_CODE),
             CONTACT_ADDRESS         = TO_MULTI_BYTE(V_CONTACT_ADDRESS),
             REG_ADDRESS_COUNTRY     = V_REG_ADDRESS_COUNTRY,
             REG_POST_CODE           = TO_MULTI_BYTE(V_REG_POST_CODE),
             REG_ADDRESS             = TO_MULTI_BYTE(V_REG_ADDRESS),
             CURRENT_ADDRESS_COUNTRY = V_CURRENT_ADDRESS_COUNTRY,
             CURRENT_POST_CODE       = TO_MULTI_BYTE(V_CURRENT_POST_CODE),
             CURRENT_ADDRESS         = TO_MULTI_BYTE(V_CURRENT_ADDRESS),
             -- 2019.06.14 tingting 因為網頁控制會有問題，Table增加地址是否相同的欄位，進行調整
             IS_SAME_PERM_ADDR       = V_IS_SAME_PERM_ADDR,
             IS_SAME_CURRENT_REG     = V_IS_SAME_CURRENT_REG,
             IS_SAME_CURRENT_PERM    = V_IS_SAME_CURRENT_PERM,

             REP_NATIONALITY_CODE  = V_REP_NATIONALITY_CODE,
             REPRESENTATIVE        = V_REPRESENTATIVE,
             REPRESENTATIVE_ID     = V_REPRESENTATIVE_ID,
             REP_NATIONALITY_CODE1 = V_REP_NATIONALITY_CODE1,
             REPRESENTATIVE1       = V_REPRESENTATIVE1,
             REPRESENTATIVE1_ID    = V_REPRESENTATIVE1_ID,

             EDM_ACCEPTED = V_EDM_ACCEPTED,
             NAV_EPAPER   = V_NAV_EPAPER,
             UPDATE_DTTM  = X_NOW,

             CONTACT_CITY = V_CONTACT_CITY,
             CONTACT_AREA = V_CONTACT_AREA,
             REG_CITY     = V_REG_CITY,
             REG_AREA     = V_REG_AREA,   
             CURRENT_CITY = V_CURRENT_CITY,
             CURRENT_AREA = V_CURRENT_AREA,   

             -- 2020.08.28 by Chengyu 因線上開戶新增推薦人欄位
             SPONSOR_ID   = V_SPONSOR_ID
       WHERE ID = V_ID_NO;
    END;
  END IF;

  --CusTaxInfoTmp 稅務聲明資料
  IF V_IS_CusTaxInfo = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
             US_TAX           = V_US_TAX,
             FATCA_TYPE       = V_FATCA_TYPE,
             TAX_COUNTRY1     = V_TAX_COUNTRY1,
             TAX_NUM1         = V_TAX_NUM1,
             TAXNOREASON1     = V_TAXNOREASON1,
             TAXATION_REMARK1 = V_TAXATION_REMARK1,
             TAX_COUNTRY2     = V_TAX_COUNTRY2,
             TAX_NUM2         = V_TAX_NUM2,
             TAXNOREASON2     = V_TAXNOREASON2,
             TAXATION_REMARK2 = V_TAXATION_REMARK2,
             TAX_COUNTRY3     = V_TAX_COUNTRY3,
             TAX_NUM3         = V_TAX_NUM3,
             TAXNOREASON3     = V_TAXNOREASON3,
             TAXATION_REMARK3 = V_TAXATION_REMARK3,
             UPDATE_DTTM  = X_NOW
       WHERE ID = V_ID_NO;
    END;
  END IF;

  --銀行帳號清單
  IF V_IS_CusAccount = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
             FIS_CURRENCY_NO_TWD = V_FIS_CURRENCY_NO_TWD,
             FIS_BANK_NO_TWD     = V_FIS_BANK_NO_TWD,
             FIS_BRANCH_NO_TWD   = V_FIS_BRANCH_NO_TWD,
             FIS_AC_CODE_TWD     = V_AFIS_AC_CODE_TWD,

             FIS_CURRENCY_NO_FCY   = V_FIS_CURRENCY_NO_FCY,
             FIS_BANK_NO_TWD_FCY   = V_FIS_BANK_NO_TWD_FCY,
             FIS_BRANCH_NO_TWD_FCY = V_FIS_BRANCH_NO_TWD_FCY,
             FIS_AC_CODE_TWD_FCY   = V_FIS_AC_CODE_TWD_FCY,

             TDCC_CURRENCY_NO = V_TDCC_CURRENCY_NO,
             TDCC_BANK_NO     = V_TDCC_BANK_NO,
             TDCC_BRANCH_NO   = V_TDCC_BRANCH_NO,
             TDCC_AC_CODE     = V_TDCC_AC_CODE,

             TDCC_CURRENCY_NO_FCY   = V_TDCC_CURRENCY_NO_FCY,
             TDCC_BANK_NO_TWD_FCY   = V_TDCC_BANK_NO_TWD_FCY,
             TDCC_BRANCH_NO_TWD_FCY = V_TDCC_BRANCH_NO_TWD_FCY,
             TDCC_AC_CODE_TWD_FCY   = V_TDCC_AC_CODE_TWD_FCY,
             UPDATE_DTTM            = X_NOW
       WHERE ID = V_ID_NO;
    END;

  END IF;

  --KYC資料
  IF V_IS_CusKycInfo = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK,
             KYC_SCROE  = V_KYC_SCROE,
             RISK_LEVEL = V_RISK_LEVEL,
             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
             VULNERABLE_CLAIM = V_VULNERABLE_CLAIM,

             MARRIED                     = V_MARRIED,
             MARRIED_OTHER               = V_MARRIED_OTHER,
             MS_NUM_CODE                 = V_MS_NUM_CODE,
             MS_NUM                      = TO_NUMBER(V_MS_NUM),
             PROFESSION                  = V_PROFESSION,
             PROFESSION_OTHERS_NEW       = V_PROFESSION_OTHERS_NEW,
             EMPLOYER                    = V_EMPLOYER,
             POSITION                    = V_POSITION,
             POSITION_OTHERS             = V_POSITION_OTHERS,
             MAJOR_ILLNESS               = V_MAJOR_ILLNESS,
             INVEST_CODE                 = V_INVEST_CODE,
             INV_KNOWLEDGE               = V_INV_KNOWLEDGE,
             INV_KNOWLEDGE_OTHER         = V_INV_KNOWLEDGE_OTHER,
             INV_ORI                     = V_INV_ORI,
             INV_ORI_OTHER               = V_INV_ORI_OTHER,
             -- 2022.08.04 JIANXIN 新增KYC 題目儲存
             CUST_RESIDENCE_STATUS       = V_CUST_RESIDENCE_STATUS,
             CUST_RESIDENCE_STATUS_TXT   = V_CUST_RESIDENCE_STATUS_TXT,
             CUST_MIND_STATUS            = V_CUST_MIND_STATUS,
             BF_AGE_CODE                 = V_BF_AGE_CODE,
             EDUCATION                   = V_EDUCATION,
             INV_TOOL                    = V_INV_TOOL,
             INV_EXPERIENCE              = V_INV_EXPERIENCE,
             INV_GOAL                    = V_INV_GOAL,
             INV_FAIL_METHOD             = V_INV_FAIL_METHOD,
             -- 2022.08.04 JIANXIN 新增KYC 題目儲存
             FAMILY_INCOME               = V_FAMILY_INCOME,
             SIGNIFICANT_NEEDS           = V_SIGNIFICANT_NEEDS,
             LIQUIDITY_NEEDS             = V_LIQUIDITY_NEEDS,
             PRICE_VOLATILITY            = V_PRICE_VOLATILITY,
             UPDATE_DTTM                 = X_NOW
       WHERE ID = V_ID_NO;
    END;
  END IF;

  IF V_IS_UPLOAD_DATAS = '1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET IS_UPLOAD_PAPERWORK = V_IS_UPLOAD_PAPERWORK
       WHERE ID = V_ID_NO;

      IF V_UPLOAD_KIND = 'B' THEN
        BEGIN
          --刪除銀行上傳檔案
          V_EXT_NOTIN := V_IDLIST || V_EXT_ID;
          DELETE FROM ECS.HOLDER_UPLOAD_DATA
           WHERE ID = V_ID_NO
             AND UPLOAD_TYPE NOT IN
                 (SELECT VALUE1
                    FROM table(ecs.f_formatstringlisttotable(V_EXT_NOTIN)));

        END;
        --刪除證件上傳檔案
      ELSIF V_UPLOAD_KIND = 'I' THEN
        BEGIN
          V_EXT_NOTIN := V_BANKLIST || V_EXT_ID;

          DELETE FROM ECS.HOLDER_UPLOAD_DATA
           WHERE ID = V_ID_NO
             AND UPLOAD_TYPE NOT IN
                 (SELECT VALUE1
                    FROM table(ecs.f_formatstringlisttotable(V_EXT_NOTIN)));
        END;
      END IF;
    END;
  END IF;

  -- 2020.07.09 tingting 因應線上開戶調整：增加儲存線上核印確認日期
  IF V_STEP_ID = '06_1' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET FIS_SEAL_DATE_TWD = X_NOW      --財金 - 線上核印日期(台幣)
       WHERE ID = V_ID_NO;
    END;
  END IF;

  IF V_STEP_ID = '06_2' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET FIS_SEAL_DATE_FCY = X_NOW      --財金 - 線上核印日期(外幣)
       WHERE ID = V_ID_NO;
    END;
  END IF;

  IF V_STEP_ID = '06_3' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET TDCC_SEAL_DATE = X_NOW         --集保 - 線上核印日期(台幣/MMA)
       WHERE ID = V_ID_NO;
    END;
  END IF;

  IF V_STEP_ID = '06_4' THEN
    BEGIN
      UPDATE ECS.HOLDER_TMP
         SET TDCC_SEAL_DATE_FCY = X_NOW     --集保 - 線上核印日期(外幣)
       WHERE ID = V_ID_NO;
    END;
  END IF;

  GOTO SUCCESS;

  <<FAIL>>
  X_IsSuccessful := '0';
  X_ResultCode   := '1';
  GOTO GO_END;

  <<SUCCESS>>
  X_IsSuccessful := '1';
  X_ResultCode   := '0';
  GOTO GO_END;

  <<GO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_SAVE_OPEN_ACC_TEMPDATA;

/

  GRANT EXECUTE ON "ECS"."S_API_SAVE_OPEN_ACC_TEMPDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_SAVE_OPEN_UPDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_SAVE_OPEN_UPDATA" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 儲存預約開戶上傳文件
  -- =============================================
(V_ID_NO           VARCHAR2, -- 身分證
 V_UPLOAD_TYPE     VARCHAR2, -- 上傳檔案類別
 V_UPLOAD_FILENAME VARCHAR2, -- 上傳檔案名稱
 OUTDT             OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客戶開戶上傳檔案)
 ) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_COUNT        INT;
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';
  X_COUNT        := 0;

  BEGIN

    --預約開戶第一步驟
    BEGIN
      SELECT COUNT(*)
        INTO X_COUNT
        FROM ECS.HOLDER_UPLOAD_DATA
       WHERE ID = V_ID_NO
         AND UPLOAD_TYPE = V_UPLOAD_TYPE;
    END;

    IF X_COUNT = 0 THEN
      BEGIN
        INSERT INTO ECS.HOLDER_UPLOAD_DATA
          (ID, UPLOAD_TYPE, UPLOAD_FILENAME, UPLOAD_TIME)
        VALUES
          (V_ID_NO, V_UPLOAD_TYPE, V_UPLOAD_FILENAME, SYSDATE);
      END;
    ELSE
      BEGIN
        UPDATE ECS.HOLDER_UPLOAD_DATA
           SET ID              = V_ID_NO,
               UPLOAD_TYPE     = V_UPLOAD_TYPE,
               UPLOAD_FILENAME = V_UPLOAD_FILENAME ,
               UPLOAD_TIME = SYSDATE
         WHERE ID = V_ID_NO
           AND UPLOAD_TYPE = V_UPLOAD_TYPE;
      END;
    END IF;

  END;

  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_SAVE_OPEN_UPDATA;

/

  GRANT EXECUTE ON "ECS"."S_API_SAVE_OPEN_UPDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_SEND_MOBILE_MSG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_SEND_MOBILE_MSG" 
-- =============================================
-- Author:      ChengYu
-- Create date: 
-- Description: 
-- 2020.11.12 by Chengyu 調整訊息(不區分預約開戶、線上開戶)
-- =============================================
(V_MOBILE            IN VARCHAR2,
 V_MOBILE_PWD            IN VARCHAR2,
 V_SEND_TYPE             IN VARCHAR2,
 V_RESEND_EFFECTIVE_TIME IN DATE,
 V_PWD_EFFECTIVE_TIME    IN DATE,
 V_CREATE_TIME           IN DATE,
 V_ID                    IN VARCHAR2,
 OUTDT                 OUT SYS_REFCURSOR
) IS
  X_MobileMsg    VARCHAR2(4000);
  X_MsgTmp       VARCHAR2(4000);
  X_PROGRESS     VARCHAR2(6);
  X_CELL_PHONE   VARCHAR2(20);
  X_NowDate      DATE;
  X_Count        NUMBER;
  X_SMS_CODE     VARCHAR2(10);
  X_SMS_TEXT     VARCHAR2(1000);

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_HOLDER_MOBILE VARCHAR(30);
  X_HOLDER_TMP_MOBILE VARCHAR(30);
BEGIN

  -- 指定變數
  X_SMS_CODE     := '';
  X_SMS_TEXT     := '';
  X_MobileMsg    := '';
  X_MsgTmp       := '';
  X_PROGRESS     := '';
  X_CELL_PHONE   := '';
  X_HOLDER_MOBILE := '';
  X_HOLDER_TMP_MOBILE := '';
  X_NowDate      := SYSDATE;

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';
  X_Count        := 0;


  --TOKEN為空
  BEGIN

    BEGIN
      SELECT MOBILE INTO X_HOLDER_MOBILE 
      FROM ECS.HOLDER 
      WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_HOLDER_MOBILE := '';
    END;

    BEGIN
      SELECT MOBILE INTO X_HOLDER_TMP_MOBILE 
      FROM ECS.HOLDER_TMP 
      WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_HOLDER_TMP_MOBILE := '';
    END;  

    IF V_SEND_TYPE = '2' OR V_SEND_TYPE = '3' THEN
      BEGIN
        IF X_HOLDER_MOBILE IS NOT NULL AND X_HOLDER_MOBILE != V_MOBILE  THEN
          BEGIN
            X_Message      := '請確認身分證字號及手機號碼與基本資料相同';
            GOTO FAIL;            
          END;
        END IF;

        IF X_HOLDER_TMP_MOBILE IS NOT NULL AND X_HOLDER_TMP_MOBILE != V_MOBILE  THEN
          BEGIN
            X_Message      := '請確認身分證字號及手機號碼與基本資料相同';
            GOTO FAIL;            
          END;
        END IF; 

        IF X_HOLDER_TMP_MOBILE IS NULL AND X_HOLDER_MOBILE IS NULL  THEN
          BEGIN
            -- 2020.11.12 by Chengyu 調整訊息(不區分預約開戶、線上開戶)
            X_Message      := '您尚未填寫開戶資料，請透過開戶功能進行開戶作業';
            GOTO FAIL;            
          END;
        END IF; 
      END;
    END IF;

    IF V_SEND_TYPE = '1' THEN
      BEGIN    
        IF X_HOLDER_TMP_MOBILE IS NOT NULL OR X_HOLDER_MOBILE IS NOT NULL  THEN
          BEGIN
            -- 2020.11.12 by Chengyu 調整訊息(不區分預約開戶、線上開戶)
            X_Message      := '您已填寫開戶資料，請透過繼續開戶或進度查詢功能進行後續作業';
            GOTO FAIL;            
          END;
        END IF;         
      END;
    END IF;  

   --假如可發送有效時間大於新訊息要傳送時間時, 則不允許
   BEGIN
      SELECT COUNT(*) INTO X_Count
      FROM (SELECT SRNO FROM (
           SELECT SRNO FROM ECS.OTP_RECORD 
            WHERE OTP_RECORD.MOBILE = V_MOBILE
              AND OTP_RECORD.ID = V_ID 
              AND OTP_RECORD.SEND_TYPE = V_SEND_TYPE
              AND OTP_RECORD.RESEND_EFFECTIVE_TIME > V_CREATE_TIME
              ORDER BY SRNO DESC )WHERE rownum=1);

      IF X_Count = 1 THEN
        BEGIN
            X_Message      := '上一次可重發驗證碼的有效時間尚未到期，不允許重新發送!';
            GOTO FAIL;
        END;
      END IF;
   END;  

    IF V_SEND_TYPE = '1' THEN
      BEGIN
        X_SMS_CODE := 'SMS00001';
      END;
    ELSIF V_SEND_TYPE = '2' THEN
      BEGIN
        X_SMS_CODE := 'SMS00002';
      END;
    ELSIF V_SEND_TYPE = '3' THEN
      BEGIN
        X_SMS_CODE := 'SMS00003';
      END;    
    ELSE
      BEGIN
        X_Message      := 'SEND_TYPE傳入錯誤，目前允許為1,2,3，您所傳入的數值為「' || V_SEND_TYPE || '」？';
        GOTO FAIL;
      END;
    END IF;

    BEGIN
     SELECT SMS_TEXT INTO X_SMS_TEXT
             FROM ECS.SHORT_MESSAGE
            WHERE SMS_CODE = X_SMS_CODE;
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       X_Message      := REPLACE('簡訊代碼{CODE}不存在!','{CODE}',X_SMS_CODE);
       GOTO FAIL;
   END;        


   X_MobileMsg := REPLACE(REPLACE(X_SMS_TEXT,'{PWD}',V_MOBILE_PWD),'{NOW}',TO_CHAR(X_NowDate, 'yyyy-MM-dd'));

  END;

   --若無錯誤時，將簡訊內容放置X_MobileMsg中  
    X_Message := X_MobileMsg; 

  BEGIN
    INSERT INTO ECS.OTP_RECORD
      (OTP_RECORD.MOBILE,
       OTP_RECORD.MOBILE_PWD,
       OTP_RECORD.SEND_TYPE,
       OTP_RECORD.RESEND_EFFECTIVE_TIME,
       OTP_RECORD.PWD_EFFECTIVE_TIME,
       OTP_RECORD.CREATION_DATE,
       OTP_RECORD.ID)
    VALUES
      (V_MOBILE,
       V_MOBILE_PWD,
       V_SEND_TYPE,
       V_RESEND_EFFECTIVE_TIME,
       V_PWD_EFFECTIVE_TIME,
       V_CREATE_TIME,
       V_ID);
  END;

  GOTO TO_END;

 <<FAIL>>
   X_IsSuccessful := '0';
   X_ResultCode   := '1'; 
   GOTO TO_END;

 <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_SEND_MOBILE_MSG;

/

  GRANT EXECUTE ON "ECS"."S_API_SEND_MOBILE_MSG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_UPLOAD_MOBILE_DELETE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_UPLOAD_MOBILE_DELETE" 
-- =============================================
  -- Author:        王仁劭
  -- Create date:   20180810
  -- Description:   刪除上傳檔案
  -- =============================================
(V_ID_NO   IN VARCHAR2, --身分證
 OUTDT  OUT SYS_REFCURSOR --ResultModel
 ) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);


BEGIN

  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  BEGIN
    DELETE FROM ECS.OPEN_MOBILE_UPLOAD_DATA WHERE ID = V_ID_NO;

    END;

  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;


END S_API_UPLOAD_MOBILE_DELETE;

/

  GRANT EXECUTE ON "ECS"."S_API_UPLOAD_MOBILE_DELETE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_UPLOAD_MOBILE_FILES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_UPLOAD_MOBILE_FILES" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180723
  -- Description: 手機上傳檔案
  -- =============================================
(V_ID_NO       VARCHAR2, -- 身分證
 V_UPLOAD_TYPE VARCHAR2, -- 上傳檔案類別
 V_UPLOAD_FILE BLOB, -- 上傳檔案
 V_UPLOAD_EXT  VARCHAR2, -- 上傳檔案副檔名
 OUTDT         OUT SYS_REFCURSOR -- 回傳的 TABLEDATA (取得客戶開戶上傳檔案)
 ) IS
  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  BEGIN 	

    INSERT INTO ECS.OPEN_MOBILE_UPLOAD_DATA
      (ID, UPLOAD_TYPE, UPLOAD_FILE, UPLOAD_EXT, UPLOAD_TIME)
    VALUES
      (V_ID_NO, V_UPLOAD_TYPE, V_UPLOAD_FILE, V_UPLOAD_EXT, SYSDATE);

  END;

  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_UPLOAD_MOBILE_FILES;

/

  GRANT EXECUTE ON "ECS"."S_API_UPLOAD_MOBILE_FILES" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_VERIFY_ROBO_SIGN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_VERIFY_ROBO_SIGN" 
-- =============================================
  -- Author:      Jason
  -- Create date: 20180810
  -- Description: 驗證ROBO簽署身分
  -- =============================================
(V_ACCOUNT_NO      IN NUMBER, --戶號
 V_BIRTH_DATE IN DATE, --生日
 OUTDT        OUT SYS_REFCURSOR) IS

  X_Message      VARCHAR2(255);
  X_ResultCode   VARCHAR2(30);
  X_IsSuccessful VARCHAR2(1);
  X_ID           VARCHAR2(10);
BEGIN

  -- 指定變數
  X_Message      := ''; -- 錯誤訊息
  X_ResultCode   := '0'; -- 訊息代碼
  X_IsSuccessful := '1';

  --判斷推薦碼是否存在於ECS.HOLDER!
  BEGIN

  	BEGIN
      SELECT ID INTO X_ID FROM FAS.HOLDER WHERE ACCOUNT_NO =V_ACCOUNT_NO AND BIRTH_DATE = V_BIRTH_DATE;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_Message      := '身份驗證失敗!!';
        X_IsSuccessful := '0';
        X_ResultCode   := '1';
        GOTO TO_END;        
    END;

  END;


  <<TO_END>>
  OPEN OUTDT FOR
    SELECT X_IsSuccessful AS "IsSuccessful",
           X_Message      AS "Message",
           X_ResultCode   AS "ResultCode"
      FROM DUAL;

END S_API_VERIFY_ROBO_SIGN;

/

  GRANT EXECUTE ON "ECS"."S_API_VERIFY_ROBO_SIGN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_API_WRITE_LOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_API_WRITE_LOG" 
(
    WLOG_TYPE          VARCHAR2,
    WAPI_NAME          VARCHAR2,
    WTRADE_ID          VARCHAR2,
    WLOG_PROCESS       VARCHAR2,
    WREQUEST_VALUE     VARCHAR2,
    WREQUEST_SIZE      NUMERIC,
    WUSER_CODE         VARCHAR2,
    WCLIENT_IP         VARCHAR2,
    WWEB_IP            VARCHAR2,
    WAP_IP             VARCHAR2,
    WLOCAL_TIME        TIMESTAMP,
    WTOKEN_ID          VARCHAR2,
    WSESSION_ID        VARCHAR2,
    WBROWSER_INFO      VARCHAR2,
    WMESSAGE           VARCHAR2,
    WSTACK_TRACE       VARCHAR2,
    WREMARK            VARCHAR2
) IS

BEGIN

      -- 指定變數
      INSERT INTO ECS.API_LOG
      (
            LOG_TIME
           ,API_NAME
           ,TRACE_ID
           ,LOG_TYPE
           ,LOG_PROCESS
           ,AP_IP
           ,REQUEST_VALUE
           ,REQUEST_SIZE
           ,USER_CODE
           ,CLIENT_IP
           ,WEB_IP
           ,LOCAL_TIME
           ,TOKEN_ID
           ,SESSION_ID
           ,BROWSER_INFO
           ,MESSAGE
           ,STACK_TRACE
           ,REMARKS
       )
       VALUES
       (
            SYSDATE
           ,WAPI_NAME
           ,WTRADE_ID
           ,WLOG_TYPE
           ,WLOG_PROCESS
           ,WAP_IP
           ,WREQUEST_VALUE
           ,WREQUEST_SIZE
           ,WUSER_CODE
           ,WCLIENT_IP
           ,WWEB_IP
           ,WLOCAL_TIME
           ,WTOKEN_ID
           ,WSESSION_ID
           ,WBROWSER_INFO
           ,WMESSAGE
           ,WSTACK_TRACE
           ,WREMARK
       );



END S_API_WRITE_LOG;

/

  GRANT EXECUTE ON "ECS"."S_API_WRITE_LOG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CANCELRESEAL_PROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CANCELRESEAL_PROCESS" 
-- =============================================
-- Author       : PhotoRGB
-- Create date  : 2009/08/20
-- Description  : 取消重送
-- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
-- 2019.09.06 tingting 調整為ORACLE版本
-- 2019.10.01 ChengYu 修正無資料時SQL錯誤
-- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
-- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- =============================================
(
    WSEAL_TYPE          VARCHAR2,       --核印方式 1：一般；2：ACH；3：財金
    WSOURCE_CD          VARCHAR2,       --資料來源 1：定期定額契約；2：定期定額契約變更；3：授權約定書；4：授權約定書變更 (CTL014：236)
    WSUB_BANK_CODE      VARCHAR2,       --扣款行
    WSUB_ACC_NO         VARCHAR2,       --扣款帳號
    WSUB_ID_NO          VARCHAR2,       --扣款人ID
    WVOUCH_NO           VARCHAR2,       --申請書號
    WVOUCH_SRNO         INT,            --申請書序號
    WRELATIVE_NO        VARCHAR2,       --相關書號
    WRELATIVE_SRNO      INT,            --申請書序號
    WBATCH_ID           VARCHAR2,       --送核批號
    WTRADE_NO           VARCHAR2,       --交易序號
    WSEAL_USER_NO       VARCHAR2,       --用戶號碼
    WACC_SUB_ID         VARCHAR2,       --帳號用途碼
    WSEAL_STATUS        VARCHAR2,       --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
    WUpdateID           VARCHAR2,       --更新人員
    WUpdateDate         DATE,           --更新日期時間
    MSG                 OUT VARCHAR2    --錯誤訊息
)
IS
    XIS_CHG_UPD         VARCHAR2(1);
    XRELATIVE_NO        VARCHAR2(20);
    XCount              INT;
    XNullDate           DATE;
    -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
    XRSP_SEAL_TYPE      VARCHAR2(6);
BEGIN

    XNullDate := TO_DATE('19000101','YYYYMMDD');
    XRELATIVE_NO := CASE WHEN WRELATIVE_NO IS NULL THEN 'ALL' ELSE WRELATIVE_NO END;
    XRSP_SEAL_TYPE := 'Y';
    --SELECT TOP 1 XRSP_SEAL_TYPE = RSP_SEAL_TYPE FROM CTL015;

    --一般
    IF (WSEAL_TYPE = '1') THEN
    BEGIN
        --更新核印檔
        MERGE INTO ECS.OFD701
        USING (
                SELECT *
                  FROM ECS.OFD707
                 WHERE OFD707.RELATIVE_NO = XRELATIVE_NO
                   AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
                   AND OFD707.VOUCH_NO = WVOUCH_NO
                   AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
                   AND OFD707.BATCH_ID = WBATCH_ID
              ) OFD707
          -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
           ON (OFD701.RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN OFD707.VOUCH_NO ELSE OFD707.RELATIVE_NO END) END)
          AND OFD701.RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN OFD707.VOUCH_SRNO ELSE OFD707.RELATIVE_SRNO END) END)
          AND OFD701.RSP_CHG_NO = CASE WHEN WSOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 'ALL' ELSE OFD707.VOUCH_NO END
          AND OFD701.RSP_CHG_SRNO = CASE WHEN WSOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 0 ELSE OFD707.VOUCH_SRNO END
          AND OFD701.SEAL_TYPE = OFD707.SEAL_TYPE
          AND OFD701.SUB_BANK_CODE = OFD707.SUB_BANK_CODE
          AND OFD701.SUB_ACC_NO = OFD707.SUB_ACC_NO
          AND OFD701.SUB_ID_NO = OFD707.SUB_ID_NO
          AND OFD701.SOURCE_CD = OFD707.SOURCE_CD)
        WHEN MATCHED THEN
            UPDATE
               SET OFD701.SEAL_STATUS = OFD707.SEAL_STATUS,
                   OFD701.SEAL_DATE = OFD707.SEAL_DATE,
                   OFD701.RETURN_DATE = OFD707.SEAL_RTN_DATE,
                   OFD701.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
                   OFD701.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
                   OFD701.BATCH_ID = OFD707.BATCH_ID,
                   OFD701.TRADE_NO = OFD707.TRADE_NO;

        /*翻成上列寫法
        --更新核印檔
        UPDATE ECS.OFD701
           SET OFD701.SEAL_STATUS = OFD707.SEAL_STATUS,
               OFD701.SEAL_DATE = OFD707.SEAL_DATE,
               OFD701.RETURN_DATE = OFD707.SEAL_RTN_DATE,
               OFD701.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
               OFD701.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
               OFD701.BATCH_ID = OFD707.BATCH_ID,
               OFD701.TRADE_NO = OFD707.TRADE_NO
          FROM ECS.OFD701
          JOIN ECS.OFD707
          -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
            ON OFD701.RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN OFD707.VOUCH_NO ELSE OFD707.RELATIVE_NO END) END)
           AND OFD701.RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN OFD707.VOUCH_SRNO ELSE OFD707.RELATIVE_SRNO END) END)
           AND OFD701.RSP_CHG_NO = CASE WHEN WSOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 'ALL' ELSE OFD707.VOUCH_NO END
           AND OFD701.RSP_CHG_SRNO = CASE WHEN WSOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 0 ELSE OFD707.VOUCH_SRNO END
           AND OFD701.SEAL_TYPE = OFD707.SEAL_TYPE
           AND OFD701.SUB_BANK_CODE = OFD707.SUB_BANK_CODE
           AND OFD701.SUB_ACC_NO = OFD707.SUB_ACC_NO
           AND OFD701.SUB_ID_NO = OFD707.SUB_ID_NO
           AND OFD701.SOURCE_CD = OFD707.SOURCE_CD
         WHERE OFD707.BATCH_ID = OFD707.BATCH_ID
           AND OFD707.RELATIVE_NO = XRELATIVE_NO
           AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
           AND OFD707.VOUCH_NO = WVOUCH_NO
           AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID;
        */
    END;
    ELSE
    --ACH/FIS
    BEGIN
        IF (WSEAL_TYPE IN ('2','3')) THEN
        BEGIN
            SELECT DATA_COUNT
              INTO XCount
              FROM ECS.OFD701
             WHERE SEAL_TYPE = WSEAL_TYPE
               AND SUB_BANK_CODE = WSUB_BANK_CODE
               AND SUB_ACC_NO = WSUB_ACC_NO
               AND SUB_ID_NO = WSUB_ID_NO
               AND RSP_NO = 'ALL'
               AND RSP_SRNO = 0
               AND RSP_CHG_NO = 'ALL'
               AND RSP_CHG_SRNO = 0
               AND ACC_SUB_ID = 'ALL'
               AND (SEAL_STATUS = WSEAL_STATUS OR WSEAL_STATUS IS NULL);
         -- 2019.10.01 ChengYu 修正無資料時SQL錯誤
         EXCEPTION WHEN NO_DATA_FOUND
                   THEN XCount := 0;
        END;
        ELSE
        BEGIN
            XCount := 0;
        END;
        END IF;

        IF (XCount = 2) THEN
        BEGIN
            MSG := '扣款行： ' || WSUB_BANK_CODE || '，扣款帳號： ' || WSUB_ACC_NO || '，
核印狀態為送核中且該帳號資料筆數僅為兩筆，
不可取消重送';
            RETURN;
        END;
        END IF;

        --重送時將筆數加一
        --若為失敗則更新核印狀態為未送
        UPDATE ECS.OFD701
           SET DATA_COUNT = DATA_COUNT - 1,
               SEAL_STATUS = CASE WHEN DATA_COUNT = 2 AND WSEAL_STATUS <> '2' THEN '3' ELSE SEAL_STATUS END,
               UpdateID = WUpdateID,
               UpdateDate = WUpdateDate
         WHERE ACC_SUB_ID = 'ALL'
           AND SUB_BANK_CODE = WSUB_BANK_CODE
           AND SUB_ACC_NO = WSUB_ACC_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE;
    END;
    END IF;

    /*
    --契約異動
    IF (WSOURCE_CD = '2') THEN
    BEGIN
        --SET XIS_CHG_UPD = 'N';

        UPDATE RSP013
           SET RSP013.SEAL_STATUS = OFD707.SEAL_STATUS,
               RSP013.SEAL_DATE = OFD707.SEAL_DATE,
               RSP013.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
               RSP013.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
               RSP013.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
               RSP013.BATCH_ID = OFD707.BATCH_ID,
               RSP013.TRADE_NO = OFD707.TRADE_NO,
               RSP013.SEAL_USER_NO = OFD707.SEAL_USER_NO
          FROM RSP013
          JOIN OFD020V ON OFD020V.BANK_BRH = [dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)
          JOIN OFD707
            ON RSP013.RSP_CHG_NO = OFD707.VOUCH_NO
           AND RSP013.RSP_CHG_SRNO = OFD707.VOUCH_SRNO
           AND RSP013.RSP_NO = OFD707.RELATIVE_NO
           AND RSP013.RSP_SRNO = OFD707.RELATIVE_SRNO
         WHERE OFD707.RELATIVE_NO = XRELATIVE_NO
           AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
           AND OFD707.VOUCH_NO = WVOUCH_NO
           AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID
           AND RSP013.IS_SEAL_YN = 'Y'
           AND ((WSEAL_TYPE <> '1' AND RSP013.CHG_UPD_DTTM = '1900/1/1') OR WSEAL_TYPE = '1');

        --IF (@@ROWCOUNT <> 0)
        --BEGIN
        --    SET XIS_CHG_UPD = 'Y';
        --END;
    END;
    END IF;
    */

    /*
    --契約書或異動轉入
    IF (WSOURCE_CD = '1' OR WSOURCE_CD = '2') THEN
    BEGIN
        UPDATE RSP006
           SET RSP006.SEAL_STATUS = OFD707.SEAL_STATUS,
               RSP006.SEAL_DATE = OFD707.SEAL_DATE,
               RSP006.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
               RSP006.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
               RSP006.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
               RSP006.BATCH_ID = OFD707.BATCH_ID,
               RSP006.TRADE_NO = OFD707.TRADE_NO,
               RSP006.DFT_BNG_SUB_DATE = CASE WHEN OFD707.SEAL_STATUS = '2'
                                              THEN cast(dbo.f_Nvl(DFT_BNG_SUB_DATE,dbo.f_GetBusinessDay(OFD707.SEAL_RTN_DATE,'1',(SELECT SEAL_DAY FROM CTL015))) as datetime)
                                              ELSE CASE WHEN FIRST_SUS_DATE = '1900/1/1' THEN '1900/1/1' ELSE DFT_BNG_SUB_DATE END
                                              END
          FROM RSP006
          JOIN OFD707
            ON RSP006.RSP_NO = CASE WHEN WSOURCE_CD = '1' THEN OFD707.VOUCH_NO ELSE OFD707.RELATIVE_NO END
           AND RSP006.RSP_SRNO = CASE WHEN WSOURCE_CD = '1' THEN OFD707.VOUCH_SRNO ELSE OFD707.RELATIVE_SRNO END
         WHERE OFD707.VOUCH_NO = WVOUCH_NO
           AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
           AND OFD707.RELATIVE_NO = XRELATIVE_NO
           AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID;

        IF (@@ROWCOUNT = 0 AND WSOURCE_CD = '1' AND WSEAL_TYPE <> '1')
        BEGIN
            UPDATE RSP006
               SET RSP006.SEAL_STATUS = OFD707.SEAL_STATUS,
                   RSP006.SEAL_DATE = OFD707.SEAL_DATE,
                   RSP006.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
                   RSP006.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
                   RSP006.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
                   RSP006.BATCH_ID = OFD707.BATCH_ID,
                   RSP006.TRADE_NO = OFD707.TRADE_NO,
                   RSP006.DFT_BNG_SUB_DATE = CASE WHEN OFD707.SEAL_STATUS = '2'
                                                  THEN cast(dbo.f_Nvl(DFT_BNG_SUB_DATE,dbo.f_GetBusinessDay(OFD707.SEAL_RTN_DATE,'1',(SELECT SEAL_DAY FROM CTL015))) as datetime)
                                                  ELSE CASE WHEN FIRST_SUS_DATE = '1900/1/1' THEN '1900/1/1' ELSE DFT_BNG_SUB_DATE END
                                             END
              FROM RSP006
              JOIN OFD707
                ON RSP006.RSP_NO = OFD707.RELATIVE_NO
               AND RSP006.RSP_SRNO = OFD707.RELATIVE_SRNO
             WHERE OFD707.RELATIVE_NO = WVOUCH_NO
               AND OFD707.RELATIVE_SRNO = WVOUCH_SRNO
               AND OFD707.BATCH_ID = WBATCH_ID
               AND OFD707.SUB_BANK_CODE = WSUB_BANK_CODE
               AND OFD707.SUB_ACC_NO = WSUB_ACC_NO
               AND OFD707.SUB_ID_NO = WSUB_ID_NO;
        END;
        END IF;
    END;
    END IF;
    */

    /*
    --授權書異動
    IF (WSOURCE_CD = '4') THEN
    BEGIN
        --SET XIS_CHG_UPD = 'N';

        UPDATE BMS005CHG
           SET BMS005CHG.SEAL_STATUS = OFD707.SEAL_STATUS,
               BMS005CHG.SEAL_DATE = OFD707.SEAL_DATE,
               BMS005CHG.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
               BMS005CHG.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
               BMS005CHG.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
               BMS005CHG.BATCH_ID = OFD707.BATCH_ID,
               BMS005CHG.TRADE_NO = OFD707.TRADE_NO
          FROM BMS005CHG
          JOIN BMS001CHG
            ON BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
          JOIN OFD707
            ON OFD707.VOUCH_NO = BMS005CHG.BF_CHG_NO
           AND OFD707.VOUCH_SRNO = BMS005CHG.DATA_SEQ
           AND OFD707.RELATIVE_NO = BMS005CHG.AFT_REMIT_CFM_NO
           AND OFD707.RELATIVE_SRNO = BMS005CHG.AFT_DATA_SEQ
         WHERE OFD707.RELATIVE_NO = XRELATIVE_NO
           AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
           AND OFD707.VOUCH_NO = WVOUCH_NO
           AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID
           AND BMS005CHG.IS_SEAL_YN = 'Y'
           AND ((WSEAL_TYPE <> '1' AND BMS001CHG.CHG_UPD_DTTM = '1900/1/1') OR WSEAL_TYPE = '1');

        --IF (@@ROWCOUNT <> 0)
        --BEGIN
        --    SET XIS_CHG_UPD = 'Y';
        --END;
    END;
    END IF ;
    */

    --授權書或異動轉入
    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
    IF (WSOURCE_CD = '3') THEN
    BEGIN
        MERGE INTO FAS.HOLDER_BANK_EC
        USING (
                SELECT HOLDER_BANK_EC.ID,
                       HOLDER_BANK_EC.AC_BANK,
                       HOLDER_BANK_EC.AC_CODE,
                       HOLDER_BANK_EC.DEPOSITORY_NO,
                       HOLDER_BANK_EC.CURRENCY_NO,
                       OFD707.*
                  FROM FAS.HOLDER_BANK_EC
                  JOIN FAS.HOLDER
                    ON HOLDER.ID = HOLDER_BANK_EC.ID
                  JOIN ECS.OFD707
                    --ON HOLDER_BANK_EC.REMIT_CFM_NO = CASE WHEN WSOURCE_CD = '3' THEN OFD707.VOUCH_NO ELSE OFD707.RELATIVE_NO END
                   --AND HOLDER_BANK_EC.DATA_SEQ = CASE WHEN WSOURCE_CD = '3' THEN OFD707.VOUCH_SRNO ELSE OFD707.RELATIVE_SRNO END
                    ON OFD707.SUB_ID_NO = HOLDER.ID
                   AND OFD707.SUB_BANK_CODE = HOLDER_BANK_EC.AC_BANK
                   AND OFD707.SUB_ACC_NO = HOLDER_BANK_EC.AC_CODE
                 WHERE OFD707.VOUCH_NO = WVOUCH_NO
                   AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
                   AND OFD707.RELATIVE_NO = XRELATIVE_NO
                   AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
                   AND OFD707.BATCH_ID = WBATCH_ID
                   AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
                   AND HOLDER_BANK_EC.CURRENCY_NO <> 'NTD'
              ) OFD707
           ON (HOLDER_BANK_EC.ID = OFD707.ID
          AND HOLDER_BANK_EC.AC_BANK = OFD707.AC_BANK
          AND HOLDER_BANK_EC.AC_CODE = OFD707.AC_CODE
          AND HOLDER_BANK_EC.DEPOSITORY_NO = OFD707.DEPOSITORY_NO
          AND HOLDER_BANK_EC.CURRENCY_NO = OFD707.CURRENCY_NO)
        WHEN MATCHED THEN
            UPDATE
               SET HOLDER_BANK_EC.SEAL_STATUS = OFD707.SEAL_STATUS,
                   HOLDER_BANK_EC.SEAL_DATE = OFD707.SEAL_DATE,
                   HOLDER_BANK_EC.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
                   HOLDER_BANK_EC.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
                   HOLDER_BANK_EC.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
                   HOLDER_BANK_EC.BATCH_ID = OFD707.BATCH_ID,
                   HOLDER_BANK_EC.TRADE_NO = OFD707.TRADE_NO,
                   -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號)
                   HOLDER_BANK_EC.VOUCH_NO = '',
                   HOLDER_BANK_EC.VOUCH_SRNO = '',
                   -- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
                   HOLDER_BANK_EC.REJECTED = OFD707.SEAL_RTN_DATE,
                   HOLDER_BANK_EC.REJECT_CODE = OFD707.SEAL_FAIL_ID_CO;
    END;
    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
    ELSIF WSOURCE_CD = '4' THEN
    BEGIN
        -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
        -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
        MERGE INTO FAS.HOLDER_BANK_EC_CHANGE
        USING (
                SELECT HOLDER_BANK_EC_CHANGE.ID,
                       NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) NEW_AC_BANK,
                       NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) NEW_AC_CODE,
                       NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) DEPOSITORY_NO,
                       NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) CURRENCY_NO,
                       OFD707.*
                  FROM FAS.HOLDER_BANK_EC_CHANGE
                  JOIN FAS.HOLDER
                    ON HOLDER.ID = HOLDER_BANK_EC_CHANGE.ID
                  JOIN ECS.OFD707
                    ON OFD707.SUB_ID_NO = HOLDER.ID
                   AND OFD707.SUB_BANK_CODE = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK)
                   AND OFD707.SUB_ACC_NO = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE)
                 WHERE OFD707.VOUCH_NO = WVOUCH_NO
                   AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
                   AND OFD707.RELATIVE_NO = XRELATIVE_NO
                   AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
                   AND OFD707.BATCH_ID = WBATCH_ID
                   AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
                   AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) <> 'NTD'
              ) OFD707
           ON (HOLDER_BANK_EC_CHANGE.ID = OFD707.ID
          AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = OFD707.NEW_AC_BANK
          AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = OFD707.NEW_AC_CODE
          AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = OFD707.DEPOSITORY_NO
          AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) = OFD707.CURRENCY_NO)
        WHEN MATCHED THEN
            UPDATE
               SET HOLDER_BANK_EC_CHANGE.SEAL_STATUS = OFD707.SEAL_STATUS,
                   HOLDER_BANK_EC_CHANGE.SEAL_DATE = OFD707.SEAL_DATE,
                   HOLDER_BANK_EC_CHANGE.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
                   HOLDER_BANK_EC_CHANGE.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
                   HOLDER_BANK_EC_CHANGE.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
                   HOLDER_BANK_EC_CHANGE.BATCH_ID = OFD707.BATCH_ID,
                   HOLDER_BANK_EC_CHANGE.TRADE_NO = OFD707.TRADE_NO,
                   HOLDER_BANK_EC_CHANGE.VOUCH_NO = '',
                   HOLDER_BANK_EC_CHANGE.VOUCH_SRNO = '',
                   HOLDER_BANK_EC_CHANGE.REJECTED = OFD707.SEAL_RTN_DATE,
                   HOLDER_BANK_EC_CHANGE.REJECT_CODE = OFD707.SEAL_FAIL_ID_CO;

        /*翻成上列寫法
        UPDATE BMS005
           SET BMS005.SEAL_STATUS = OFD707.SEAL_STATUS,
               BMS005.SEAL_DATE = OFD707.SEAL_DATE,
               BMS005.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
               BMS005.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
               BMS005.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
               BMS005.BATCH_ID = OFD707.BATCH_ID,
               BMS005.TRADE_NO = OFD707.TRADE_NO
          FROM BMS005
          JOIN BMS001
            ON BMS005.BF_NO = BMS001.BF_NO
          JOIN OFD707
            ON BMS005.REMIT_CFM_NO = CASE WHEN WSOURCE_CD = '3' THEN OFD707.VOUCH_NO ELSE OFD707.RELATIVE_NO END
           AND BMS005.DATA_SEQ = CASE WHEN WSOURCE_CD = '3' THEN OFD707.VOUCH_SRNO ELSE OFD707.RELATIVE_SRNO END
         WHERE OFD707.VOUCH_NO = WVOUCH_NO
           AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
           AND OFD707.RELATIVE_NO = XRELATIVE_NO
           AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID;

        IF (@@ROWCOUNT = 0 AND WSOURCE_CD = '3' AND WSEAL_TYPE <> '1') THEN
        BEGIN
            UPDATE BMS005
               SET BMS005.SEAL_STATUS = OFD707.SEAL_STATUS,
                   BMS005.SEAL_DATE = OFD707.SEAL_DATE,
                   BMS005.SEAL_RTN_DATE = OFD707.SEAL_RTN_DATE,
                   BMS005.SEAL_FAIL_ID_CO = OFD707.SEAL_FAIL_ID_CO,
                   BMS005.SEAL_FAIL_ID_BK = OFD707.SEAL_FAIL_ID_BK,
                   BMS005.BATCH_ID = OFD707.BATCH_ID,
                   BMS005.TRADE_NO = OFD707.TRADE_NO
              FROM BMS005
              JOIN BMS001
                ON BMS005.BF_NO = BMS001.BF_NO
              JOIN OFD707
                ON BMS005.REMIT_CFM_NO = OFD707.RELATIVE_NO
               AND BMS005.DATA_SEQ = OFD707.RELATIVE_SRNO
             WHERE OFD707.RELATIVE_NO = WVOUCH_NO
               AND OFD707.RELATIVE_SRNO = WVOUCH_SRNO
               AND OFD707.BATCH_ID = WBATCH_ID
               AND OFD707.SUB_BANK_CODE = WSUB_BANK_CODE
               AND OFD707.SUB_ACC_NO = WSUB_ACC_NO
               AND OFD707.SUB_ID_NO = WSUB_ID_NO;
        END;
        END IF;
        */
    END;
    END IF;

    --刪除重送記錄檔
    DELETE ECS.OFD707
     WHERE OFD707.VOUCH_NO = WVOUCH_NO
       AND OFD707.VOUCH_SRNO = WVOUCH_SRNO
       AND OFD707.RELATIVE_NO = XRELATIVE_NO
       AND OFD707.RELATIVE_SRNO = WRELATIVE_SRNO
       AND OFD707.BATCH_ID = WBATCH_ID;

    --重送後批次生效
    -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
    IF (SQL%ROWCOUNT = 0 AND WSOURCE_CD IN ('3','4')) THEN
    BEGIN
        DELETE ECS.OFD707
         WHERE OFD707.RELATIVE_NO = WVOUCH_NO
           AND OFD707.RELATIVE_SRNO = WVOUCH_SRNO
           AND OFD707.BATCH_ID = WBATCH_ID
           AND OFD707.SUB_BANK_CODE = WSUB_BANK_CODE
           AND OFD707.SUB_ACC_NO = WSUB_ACC_NO
           AND OFD707.SUB_ID_NO = WSUB_ID_NO;
    END;
    END IF;

END s_CancelReSeal_Process;

/

  GRANT EXECUTE ON "ECS"."S_CANCELRESEAL_PROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKALLOTFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKALLOTFUNDDATA" 
-- =============================================
-- Author     : pan
-- Create date: 2018/08/06
-- Description: API039 檢查申購交易資料(單筆申購、(不)定額新件)
-- 2018.09.05 ChengYu 新增單筆申購時 境內外申購總金額是否超過上限、同客戶同扣款日同銀行帳戶的 總單筆申購金額、總申購金額 上限
-- 2018.09.07 ChengYu 依交易步驟(WSTEP_TYPE) 分類需要的檢查
-- 2018.09.21 ChengYu 新增步驟4
-- 2018.09.27 ChengYu 修正單筆申購下限檢查
-- 2018.09.28 ChengYu 員工員眷排除 受益憑證檔(FAS.CERTIFICATE) 的 代銷單位分公司碼(BRANCH_NO) 為 8800 的資料
-- 2018.09.28 ChengYu 新增ROBO同意書檢查
-- 2018.10.01 ChengYu 當天重複轉申購加入檢查帳號
-- 2018.10.03 ChengYu 檢查申購手續費數值是否正確
-- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
-- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
-- 2018.10.04 JIANXIN 因 ECS.F_GET_RISK_LEVEL_MAPPING 無法將參數傳入，故拆成(轉)申購、(不)定額
-- 2018.10.04 JIANXIN 若員工員眷未申購過，則不檢查
-- 2018.10.05 ChengYu IS_ROBO 為Y時不檢查
-- 2018.10.05 ChengYu 員工員眷檢核 修正FAS.CERTIFICATE (受益憑證檔)取法
-- 2018.10.08 yunchu 調整弱勢族群只可申購RR1~RR4基金
-- 2018.10.08 ChengYu 調整弱勢族群錯誤訊息
-- 2018.10.11 ChengYu 檢查加減碼金額下限
-- 2018.10.19 ChengYu 修正境內外金額檢查 GroupBy交易日、同客戶同扣款日同銀行帳戶總申購金額上限的錯誤訊息
-- 2018.10.23 ChengYu 修正加減碼點指標區間錯誤
-- 2018.10.29 ChengYu 修正基金風險屬性檢查
-- 2018.11.08 tingting 調整紅利折抵，在取預扣點數的取法
-- 2018.11.13 ChengYu 檢查加減碼金額倍數檢查
-- 2018.11.13 ChengYu 加減碼金額不能與扣款金額相同
-- 2018.11.15 ChengYu 檢核金額上限要含手續費
-- 2018.11.16 ChengYu 調整金額上限取資料庫總金額判斷、定期(不)定額上限包含手續費
-- 2018.11.16 JIANXIN MOD
-- i.   美屬受益人所有基金都不可以買賣
-- ii.  英屬受益人不能買賣 基金公司=M&G，且註冊地= UK 的基金
-- iii. 大陸屬受益人所有基金都不可以買賣
-- 2018.11.20 ChengYu 修復重複轉申購減核
-- 2018.11.21 JIANXIN 員工員眷檢核 調整為贖回後，才會鎖定員工交易，申購不控管
-- 2018.11.26 ChengYu 調整紅利點數檢核效能
-- 2018.11.27 tingting 調整錯誤訊息描述
-- 2018.11.27 ChengYu 修正定期(不)定額金額上限檢查
-- 2018.11.28 ChengYu 轉申購員工控管檢查
-- 2018.12.05 ChengYu 員工員眷檢核 修正同一母基金的基金判斷、修正轉申購員工員眷交易控管檢核
-- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
-- 2018.12.20 JIANXIN 調整中信點對點帳號檢查問題
-- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
-- 2019.01.10 JIANXIN 新增檢查【目標到期投資風險預告書】(逆向檢查)
-- 2019.02.19 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限、移除單筆申購重覆交易檢核
-- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
-- 2019.03.11 JIANXIN MOD BY 幣別判斷調整
-- 2019.03.13 JIANXIN MOD BY 分階層需增加括號
-- 2019.03.14 JIANXIN MOD BY 瑞萬基金取得帳號必須增加條件
-- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
-- 2019.08.12 ChengYu 修正金額上限檢查時的匯率幣別抓取
-- 2020.03.12 yunchu 調整申購時步驟改為2檢查
-- 2020.03.13 ChengYu 調整投資人投資適性步驟
-- 2020.05.07 JIANXIN 新增檢查【目標到期投資風險預告書】新增 FUND_SET <> '10'
-- 2020.07.28 Chengyu 新增檢核境外轉申購時，同基金公司檢核
-- 2020.09.18 Chengyu 調整境外轉申購時同基金公司檢核錯誤訊息
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- 2021.06.04 JIANXIN 修正員工員眷的檢查
-- 2021.07.08 Chengyu 修正員工員眷是否在職條件
-- 2022.07.30 JIANXIN 調整弱勢族群由70歲調整為65歲
-- 2023.03.13 JIANXIN 新增針對弱勢族群評估，若是弱勢族群時，需判斷有簽屬過自主申購聲明且弱勢族群評估=Y，且弱勢族群評估到期日需大於系統日
-- 2023.03.24 JIANXIN 針對弱勢族群自主聲明同意與不同意進行不同情境處理
-- 2023.03.27 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
-- 2023.03.30 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
-- 2023.10.08 JIANXIN 針對弱勢族群Null 判斷
-- =============================================
(
    WSTEP_TYPE      ECS.SHOPCAR_TRADE_TEMP.STEP_TYPE%TYPE, ---交易步驟

    OUTDT           OUT SYS_REFCURSOR                      --回傳table
)
IS
  --變數

BEGIN

   --檢查受益人資料 : SPC005 / TRS003 : 查無此受益人
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,'0','',
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGCONTENT ELSE S.MSGCONTENT END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,FAS.HOLDER B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC005') C,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS003') S
   WHERE A.ACCOUNT_NO = B.ACCOUNT_NO(+)
     AND B.ID IS NULL;

   --檢查基金資料 : SPC006 / TRS004 : 查無此基金
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,'0',A.FUND_NO,
         CASE WHEN A.TX_TYPE = '4' THEN S.MSGID ELSE C.MSGID END MSGID,
         CASE WHEN A.TX_TYPE = '4' THEN S.MSGTYPE ELSE C.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE = '4' THEN S.MSGMEMO ELSE C.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE = '4' THEN REPLACE(S.MSGCONTENT,'{FUND_NO}',CASE WHEN D.FUND_NO IS NULL THEN A.REDEM_FUND ELSE A.FUND_NO END) ELSE REPLACE(C.MSGCONTENT,'{FUND_NO}',A.FUND_NO) END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,FAS.FUND B,FAS.FUND D,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC006') C,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS004') S
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.REDEM_FUND = D.FUND_NO(+)
     AND ((TX_TYPE != '4' AND B.FUND_NO IS NULL)
      OR (TX_TYPE = '4' AND WSTEP_TYPE != '1' AND (D.FUND_NO IS NULL OR B.FUND_NO IS NULL))
      OR (TX_TYPE = '4' AND WSTEP_TYPE = '1' AND (D.FUND_NO IS NULL)));

  --檢查基金交易方式 : SPC007 : 無開放單筆申購
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND IS_EC_PURCHASE = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC007') C
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.TX_TYPE = '1'
     AND B.FUND_NO IS NULL
     AND WSTEP_TYPE IN ('1','4');      --單筆申購步驟 1、4 檢查

  --檢查基金交易方式 : SPC008 : 無開放定期定額申購
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND IS_EC_PERIODIC = 'Y' AND EC_RSP_NEW = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC008') C
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.TX_TYPE = '2'
     AND B.FUND_NO IS NULL
     AND WSTEP_TYPE IN ('1','4');      --單筆申購步驟 1、4 檢查

  --檢查基金交易方式 : SPC009 : 無開放定期定額申購
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND IS_EC_DRSP = 'Y' AND EC_DRSP_NEW = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC009') C
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.TX_TYPE = '3'
     AND B.FUND_NO IS NULL
     AND WSTEP_TYPE IN ('1','4');      --單筆申購步驟 1、4 檢查

  --轉申購(STEP 1) 基金上架檢核 : TRS013 : 此基金不開放買回
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.REDEM_FUND,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND FUND.IS_EC_REDEMPTION = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS013') C
   WHERE A.REDEM_FUND = B.FUND_NO(+)
     AND A.TX_TYPE = '4'
     AND B.FUND_NO IS NULL
     AND WSTEP_TYPE = '1';      --轉申購時步驟 1 檢查

  --轉申購(STEP 2) 基金上架檢核 : TRS014 : 此基金不開放轉入
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND FUND.IS_EC_SWITCH_IN = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS014') C
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.TX_TYPE = '4'
     AND B.FUND_NO IS NULL
     AND WSTEP_TYPE = '2';      --轉申購時步驟 2 檢查

  --轉申購(STEP 3) 檢查基金交易方式 : TRS005 : 無開放轉申購
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND IS_EC_SWITCH_IN = 'Y') B,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS005') C,
         (SELECT * FROM FAS.FUND WHERE IS_EC = 'Y' AND IS_EC_REDEMPTION = 'Y') D
   WHERE A.FUND_NO = B.FUND_NO(+)
     AND A.REDEM_FUND = D.FUND_NO(+)
     AND A.TX_TYPE = '4'
     AND (B.FUND_NO IS NULL
      OR D.FUND_NO IS NULL)
     AND WSTEP_TYPE = '3';      --轉申購時步驟 3檢查

  --檢查申購基金風險屬性是否符合投資人投資適性 : SPC010 / TRS006 : 投資適性檢查
  -- 2018.10.04 JIANXIN 因 ECS.F_GET_RISK_LEVEL_MAPPING 無法將參數傳入，故拆成(轉)申購、(不)定額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         -- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGCONTENT ELSE S.MSGCONTENT END MSGCONTENT
    -- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B
      ON A.FUND_NO = B.FUND_NO
    LEFT JOIN TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('1',SYSDATE)) D
      ON B.RISK_CATEGORY = D.RISK_CATEGORY
     AND A.KYC_RISK_LEVEL = D.RISK_LEVEL
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC010') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS006') S
   WHERE A.FUND_NO = B.FUND_NO
     AND D.RISK_CATEGORY IS NULL
     -- 2018.10.29 ChengYu 修正基金風險屬性檢查
     -- 2020.03.13 ChengYu 調整投資人投資適性步驟
     AND (  (A.TX_TYPE = '1' AND WSTEP_TYPE IN ('2','4'))       --申購時步驟 1、4檢查
         OR (A.TX_TYPE = '4') AND WSTEP_TYPE IN ('2','3'));     --轉申購步驟 2、3檢查

  --檢查申購基金風險屬性是否符合投資人投資適性 : SPC010 / TRS006 : 投資適性檢查
  -- 2018.10.04 JIANXIN 因 ECS.F_GET_RISK_LEVEL_MAPPING 無法將參數傳入，故拆成(轉)申購、(不)定額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         -- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGCONTENT ELSE S.MSGCONTENT END MSGCONTENT
    -- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B
      ON A.FUND_NO = B.FUND_NO
    LEFT JOIN TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('2',SYSDATE)) D
      ON B.RISK_CATEGORY = D.RISK_CATEGORY
     AND A.KYC_RISK_LEVEL = D.RISK_LEVEL
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC010') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS006') S
   WHERE A.FUND_NO = B.FUND_NO
     AND D.RISK_CATEGORY IS NULL
     -- 2018.10.29 ChengYu 修正基金風險屬性檢查
     -- 2020.03.13 ChengYu 調整投資人投資適性步驟
     AND A.TX_TYPE IN ('2','3')
     AND WSTEP_TYPE IN ('2','4');       --定期(不)定額步驟 1、4檢查

  --檢查投資人扣款帳戶 : SPC011 : 扣款帳戶再次確認
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.AMC B    ON A.AMC_NO = B.AMC_NO
    JOIN FAS.HOLDER E ON A.ACCOUNT_NO = E.ACCOUNT_NO
    LEFT JOIN FAS.HOLDER_BANK_EC D
      ON E.ID = D.ID
     AND A.BANK_NO = D.AC_BANK
     AND A.AC_CODE = D.AC_CODE
     -- 2019.03.11 JIANXIN MOD BY 幣別判斷調整
     AND (A.TRADE_CRNCY = CASE WHEN D.CURRENCY_NO = 'MMA' THEN A.TRADE_CRNCY
                               WHEN D.CURRENCY_NO = 'FCY' AND A.TRADE_CRNCY <> 'NTD' THEN A.TRADE_CRNCY
                               ELSE D.CURRENCY_NO END )
     -- 2018.12.20 JIANXIN 調整中信點對點帳號檢查問題
     -- 2019.03.13 JIANXIN MOD BY 分階層需增加括號
     -- 2019.03.14 JIANXIN MOD BY 瑞萬基金取得帳號必須增加條件
     AND (   (D.DEPOSITORY_NO = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04')
          OR (D.DEPOSITORY_NO = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '1')
          OR (D.DEPOSITORY_NO = '04' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '2' )
         )
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC011') C
   WHERE (D.AC_BANK IS NULL OR D.VERIFIED IS NULL)
     AND A.TX_TYPE != '4'
     AND WSTEP_TYPE = '4';      --申購時步驟 4檢查

  --檢查金額不為正數 : SPC012 : 申購金額不為正數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC012') C
   WHERE A.AMOUNT < 0
     AND A.TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  --檢查金額不為正數 : SPC013 : 申購手續費不為正數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC013') C
   WHERE A.SERVICE_CHARGE < 0
     AND A.TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  --檢查金額不為正數 : SPC014 : 申購總金額不為正數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC014') C
   WHERE A.TOT_AMOUNT < 0
     AND A.TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  --檢查金額不為正數 : SPC015 : 加碼金額不為正數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC015') C
   WHERE A.RAISE_AMOUNT < 0
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟3、4檢查

  --檢查金額不為正數 : SPC016 : 減碼金額不為正數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC016') C
   WHERE A.REDUCE_AMOUNT < 0
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查申購總金額 : SPC017 : 申購金額加申購手續費 不等於 申購總金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC017') C
   WHERE A.TOT_AMOUNT <> (A.AMOUNT+A.SERVICE_CHARGE)
     AND TX_TYPE != '4';              --申購時檢查

  --檢查定期不定額加減碼金額: SPC018 : 加碼金額必須小於基準扣款金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC018') C
   -- 2018.11.13 ChengYu 加減碼金額不能與扣款金額相同
   WHERE A.AMOUNT >= A.RAISE_AMOUNT
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查定期不定額加減碼金額 : SPC019 : 減碼金額必須小於基準扣款金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A,
         (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC019') C
   -- 2018.11.13 ChengYu 加減碼金額不能與扣款金額相同
   WHERE A.AMOUNT <= A.REDUCE_AMOUNT
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查申購金額下限 : SPC020 : 單筆(首次)申購最低申購金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN TO_CHAR(B.MIN_INITIAL_PURCHASE, 'FM999,999,999,999,999') ELSE TO_CHAR(B.MIN_INITIAL_PURCHASE_NTD, 'FM999,999,999,999,999') END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B   ON A.FUND_NO = B.FUND_NO
    JOIN FAS.HOLDER D ON D.ACCOUNT_NO = A.ACCOUNT_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC020') C
   WHERE NOT EXISTS(SELECT * FROM FAS.V_ALL_PURCHASE X
                     WHERE X.FUND_NO = A.FUND_NO
                       AND X.ID = D.ID)
     AND A.AMOUNT < (CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.MIN_INITIAL_PURCHASE ELSE B.MIN_INITIAL_PURCHASE_NTD END)
     AND A.TX_TYPE = '1'
     -- 2018.09.27 ChengYu 修正單筆申購下限檢查
     AND WSTEP_TYPE IN ('2','4')      --單筆申購步驟2、4檢查，轉申購步驟 2 檢查
     -- 2018.10.05 ChengYu IS_ROBO 為Y時不檢查
     AND A.IS_ROBO != 'Y';

  --檢查申購金額下限 : SPC021 : 單筆(再次)申購最低申購金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN TO_CHAR(B.MIN_AMOUNT, 'FM999,999,999,999,999') ELSE TO_CHAR(B.MIN_AMOUNT_NTD, 'FM999,999,999,999,999') END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B   ON A.FUND_NO = B.FUND_NO
    JOIN FAS.HOLDER D ON D.ACCOUNT_NO = A.ACCOUNT_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC021') C
   WHERE EXISTS(SELECT * FROM FAS.V_ALL_PURCHASE X
                 WHERE X.FUND_NO = A.FUND_NO
                   AND X.ID = D.ID)
     AND A.AMOUNT < (CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.MIN_AMOUNT ELSE B.MIN_AMOUNT_NTD END)
     AND A.TX_TYPE = '1'
     -- 2018.09.27 ChengYu 修正單筆申購下限檢查
     AND WSTEP_TYPE IN ('2','4')       --單筆申購步驟 2檢查，轉申購步驟 2檢查
     -- 2018.10.05 ChengYu IS_ROBO 為Y時不檢查
     AND A.IS_ROBO != 'Y';

  --檢查申購金額下限 : SPC022 : 定期(不)定額最低申購金額
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN TO_CHAR(B.EC_PERIOD_MIN, 'FM999,999,999,999,999') ELSE TO_CHAR(B.EC_PERIOD_MIN_NTD, 'FM999,999,999,999,999') END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC022') C
   WHERE A.AMOUNT < (CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.EC_PERIOD_MIN ELSE B.EC_PERIOD_MIN_NTD END)
     AND A.TX_TYPE IN ('2','3')
     AND WSTEP_TYPE IN('2','4');      --定期定額、定期(不)定額步驟 2、4檢查

  --檢查申購倍數 : SPC023 : 定期(不)定額申購倍數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{RANGE}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC023') C
   WHERE MOD(A.AMOUNT ,(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END) ) != 0
     AND A.TX_TYPE IN ('2','3')
     AND WSTEP_TYPE IN('2','4');      --定期定額、定期(不)定額步驟 2、4檢查

  --檢查金額小數位數 : SPC024 : 申購金額小數位數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMT_DECIMAL}',B.AMT_DECIMAL) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC024') C
   WHERE CASE WHEN B.AMT_DECIMAL = 0 THEN INSTR(A.AMOUNT,'.',1,1)  -- 金額小數位數為0 時,取得"."的位置
              WHEN INSTR(A.AMOUNT,'.',1,1) = 0 THEN 0              -- 整數位時, 以位置 0 回傳
              ELSE LENGTH(SUBSTR(A.AMOUNT,INSTR(A.AMOUNT,'.',1,1)+1,LENGTH(A.AMOUNT)-INSTR(A.AMOUNT,'.',1,1))) END > B.AMT_DECIMAL
     AND TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  --檢查金額小數位數 : SPC025 : 申購手續費小數位數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMT_DECIMAL}',B.AMT_DECIMAL) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC025') C
   WHERE CASE WHEN B.AMT_DECIMAL = 0 THEN INSTR(A.SERVICE_CHARGE,'.',1,1)  -- 金額小數位數為0 時,取得"."的位置
              WHEN INSTR(A.SERVICE_CHARGE,'.',1,1) = 0 THEN 0              -- 整數位時, 以位置 0 回傳
              ELSE LENGTH(SUBSTR(A.SERVICE_CHARGE,INSTR(A.SERVICE_CHARGE,'.',1,1)+1,LENGTH(A.SERVICE_CHARGE)-INSTR(A.SERVICE_CHARGE,'.',1,1))) END > B.AMT_DECIMAL
     AND TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  --檢查金額小數位數 : SPC026 : 申購總金額小數位數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMT_DECIMAL}',B.AMT_DECIMAL) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC026') C
   WHERE CASE WHEN B.AMT_DECIMAL = 0 THEN INSTR(A.TOT_AMOUNT,'.',1,1)  -- 金額小數位數為0 時,取得"."的位置
              WHEN INSTR(A.TOT_AMOUNT,'.',1,1) = 0 THEN 0              -- 整數位時, 以位置 0 回傳
              ELSE LENGTH(SUBSTR(A.TOT_AMOUNT,INSTR(A.TOT_AMOUNT,'.',1,1)+1,LENGTH(A.TOT_AMOUNT)-INSTR(A.TOT_AMOUNT,'.',1,1))) END > B.AMT_DECIMAL
     AND TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');       --申購時步驟 2、4檢查

  --檢查金額小數位數 : SPC027 : 加碼金額小數位數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMT_DECIMAL}',B.AMT_DECIMAL) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC027') C
   WHERE CASE WHEN B.AMT_DECIMAL = 0 THEN INSTR(A.RAISE_AMOUNT,'.',1,1)  -- 金額小數位數為0 時,取得"."的位置
              WHEN INSTR(A.RAISE_AMOUNT,'.',1,1) = 0 THEN 0              -- 整數位時, 以位置 0 回傳
              ELSE LENGTH(SUBSTR(A.RAISE_AMOUNT,INSTR(A.RAISE_AMOUNT,'.',1,1)+1,LENGTH(A.RAISE_AMOUNT)-INSTR(A.RAISE_AMOUNT,'.',1,1))) END > B.AMT_DECIMAL
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查金額小數位數 : SPC028 : 減碼金額小數位數
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMT_DECIMAL}',B.AMT_DECIMAL) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC028') C
   WHERE CASE WHEN B.AMT_DECIMAL = 0 THEN INSTR(A.REDUCE_AMOUNT,'.',1,1)  -- 金額小數位數為0 時,取得"."的位置
              WHEN INSTR(A.REDUCE_AMOUNT,'.',1,1) = 0 THEN 0              -- 整數位時, 以位置 0 回傳
              ELSE LENGTH(SUBSTR(A.REDUCE_AMOUNT,INSTR(A.REDUCE_AMOUNT,'.',1,1)+1,LENGTH(A.REDUCE_AMOUNT)-INSTR(A.REDUCE_AMOUNT,'.',1,1))) END > B.AMT_DECIMAL
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查申購金額上限 : SPC029 : 定期(不)定額扣款金額上限
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',
                 (CASE WHEN A.TX_TYPE = '2' AND D.VERIFIED < B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_RSP_AMOUNT1, 'FM999,999,999,999,999')
                       WHEN A.TX_TYPE = '2' AND D.VERIFIED >= B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_RSP_AMOUNT2, 'FM999,999,999,999,999')
                       WHEN A.TX_TYPE = '3' AND D.VERIFIED < B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT1, 'FM999,999,999,999,999')
                       WHEN A.TX_TYPE = '3' AND D.VERIFIED >= B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT2, 'FM999,999,999,999,999')
                  END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.SYSTEM_PARAMETER B ON B.SYSTEM_ID = 'ECS'
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC029') C
    JOIN FAS.AMC F    ON A.AMC_NO = F.AMC_NO
    JOIN FAS.HOLDER E ON A.ACCOUNT_NO = E.ACCOUNT_NO
    JOIN FAS.HOLDER_BANK_EC D
      ON E.ID = D.ID
     AND A.BANK_NO = D.AC_BANK
     AND A.AC_CODE = D.AC_CODE
     AND A.TRADE_CRNCY = D.CURRENCY_NO
     -- 2018.12.20 JIANXIN 調整中信點對點帳號檢查問題
     AND (   D.DEPOSITORY_NO = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04'
          OR D.DEPOSITORY_NO = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '1'
          OR D.DEPOSITORY_NO = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '2'
         )
   -- 2018.11.27 ChengYu 修正定期(不)定額金額上限檢查
   -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
   WHERE NVL(A.TOT_AMOUNT * CASE WHEN A.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(A.FUND_NO, A.TX_DATE) END,0) > CASE WHEN A.TX_TYPE = '2' AND D.VERIFIED < B.FIS_SEAL_DATE THEN B.PER_RSP_AMOUNT1
                                                                                                                              WHEN A.TX_TYPE = '2' AND D.VERIFIED >= B.FIS_SEAL_DATE THEN B.PER_RSP_AMOUNT2
                                                                                                                              WHEN A.TX_TYPE = '3' AND D.VERIFIED < B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT1
                                                                                                                              WHEN A.TX_TYPE = '3' AND D.VERIFIED >= B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT2
                                                                                                                              END
     AND D.DEPOSITORY_NO = '01'  --限財金平台
     AND A.TX_TYPE IN ('2','3')
     AND WSTEP_TYPE IN('2','4'); --定期定額、定期(不)定額步驟 2、4檢查

  -- 2019.02.19 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限、移除單筆申購重覆交易檢核
  --檢查申購金額上限 : SPC058 : 定期(不)定額購金額不可超過扣款金額上限
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',TO_CHAR(B.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999')) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.SYSTEM_PARAMETER B ON B.SYSTEM_ID = 'ECS'
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC058') C
    JOIN FAS.AMC F    ON A.AMC_NO = F.AMC_NO
    JOIN FAS.HOLDER E ON A.ACCOUNT_NO = E.ACCOUNT_NO
    JOIN FAS.HOLDER_BANK_EC D
      ON E.ID = D.ID
     AND A.BANK_NO = D.AC_BANK
     AND A.AC_CODE = D.AC_CODE
     AND A.TRADE_CRNCY = D.CURRENCY_NO
     --調整中信點對點帳號檢查問題
     AND (   D.DEPOSITORY_NO = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04'
          OR D.DEPOSITORY_NO = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '1'
          OR D.DEPOSITORY_NO = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '2'
         )
   --定期(不)定額金額上限檢查
   -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
   WHERE NVL(A.TOT_AMOUNT * CASE WHEN A.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(A.FUND_NO, A.TX_DATE) END,0) > B.PUR_AMOUNT_LIMIT
     AND D.DEPOSITORY_NO = '01'  --限財金平台
     AND A.TX_TYPE IN ('2','3')
     AND WSTEP_TYPE IN('2','4'); --定期定額、定期(不)定額步驟 2、4檢查

  --檢查申購金額上限 : SPC030 : 定期(不)定額加碼金額上限
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',
                 (CASE WHEN D.VERIFIED < B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT1, 'FM999,999,999,999,999')
                       WHEN D.VERIFIED >= B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT2, 'FM999,999,999,999,999')
                  END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.SYSTEM_PARAMETER B ON B.SYSTEM_ID = 'ECS'
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC030') C
    JOIN FAS.AMC F    ON A.AMC_NO = F.AMC_NO
    JOIN FAS.HOLDER E ON A.ACCOUNT_NO = E.ACCOUNT_NO
    JOIN FAS.HOLDER_BANK_EC D
      ON E.ID = D.ID
     AND A.BANK_NO = D.AC_BANK
     AND A.AC_CODE = D.AC_CODE
     AND A.TRADE_CRNCY = D.CURRENCY_NO
     -- 2018.12.20 JIANXIN 調整中信點對點帳號檢查問題
     AND (   D.DEPOSITORY_NO = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04'
          OR D.DEPOSITORY_NO = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '1'
          OR D.DEPOSITORY_NO = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '2'
         )
         -- 2018.11.16 ChengYu 調整金額上限取資料庫總金額判斷、定期(不)定額上限包含手續費
         -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
   WHERE NVL((A.RAISE_AMOUNT + (A.RAISE_AMOUNT * NVL(A.SC_RATE,0) /100)) * CASE WHEN A.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(A.FUND_NO, A.TX_DATE) END,0) > CASE WHEN D.VERIFIED < B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT1
                                                                                                                                                                             WHEN D.VERIFIED >= B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT2
                                                                                                                                                                             END
     AND D.DEPOSITORY_NO = '01'  --限財金平台
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4'); --定期(不)定額步驟 3、4檢查

  --檢查申購金額上限 : SPC031 : 定期(不)定額減碼金額上限
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         REPLACE(C.MSGCONTENT,'{AMOUNT}',
                 (CASE WHEN D.VERIFIED < B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT1, 'FM999,999,999,999,999')
                       WHEN D.VERIFIED >= B.FIS_SEAL_DATE THEN TO_CHAR(B.PER_DRSP_AMOUNT2, 'FM999,999,999,999,999')
                  END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.SYSTEM_PARAMETER B ON B.SYSTEM_ID = 'ECS'
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC031') C
    JOIN FAS.AMC F    ON A.AMC_NO = F.AMC_NO
    JOIN FAS.HOLDER E ON A.ACCOUNT_NO = E.ACCOUNT_NO
    JOIN FAS.HOLDER_BANK_EC D
      ON E.ID = D.ID
     AND A.BANK_NO = D.AC_BANK
     AND A.AC_CODE = D.AC_CODE
     AND A.TRADE_CRNCY = D.CURRENCY_NO
     -- 2018.12.20 JIANXIN 調整中信點對點帳號檢查問題
     AND (   D.DEPOSITORY_NO = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04'
          OR D.DEPOSITORY_NO = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '1'
          OR D.DEPOSITORY_NO = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = A.FUND_NO) = '2'
         )
         -- 2018.11.16 ChengYu 調整金額上限取資料庫總金額判斷、定期(不)定額上限包含手續費
         -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
   WHERE NVL((A.REDUCE_AMOUNT + (A.REDUCE_AMOUNT * NVL(A.SC_RATE,0) /100)) * CASE WHEN A.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(A.FUND_NO, A.TX_DATE) END,0) > CASE WHEN D.VERIFIED < B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT1
                                                                                                                                                                               WHEN D.VERIFIED >= B.FIS_SEAL_DATE THEN B.PER_DRSP_AMOUNT2
                                                                                                                                                                               END
     AND D.DEPOSITORY_NO = '01'  --限財金平台
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4'); --定期(不)定額步驟3、4檢查

  --檢查加減碼指標區間 : SPC032 : 加碼指標區間錯誤
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC032') C
   -- 2018.10.23 ChengYu 修正加減碼點指標區間錯誤
   WHERE (A.RAISE_ROI <= - 100 OR A.RAISE_ROI >= 0)
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4'); --定期(不)定額步驟 3、4檢查

  --檢查加減碼指標區間 : SPC033 : 減碼指標區間錯誤
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,C.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC033') C
   -- 2018.10.23 ChengYu 修正加減碼點指標區間錯誤
   WHERE (A.REDUCE_ROI >= 100 OR A.REDUCE_ROI <= 0)
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4'); --定期(不)定額步驟 3、4檢查

  --檢查優惠/紅利 : SPC034 / TRS007 : 紅利點數
  -- 2018.11.26 ChengYu 調整紅利點數檢核效能
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN REPLACE(C.MSGCONTENT,'{REWARD_POINT}',D.REM_POINT) ELSE REPLACE(S.MSGCONTENT,'{REWARD_POINT}',D.REM_POINT - E.USED_POINT) END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC034') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS007') S
    JOIN (-- 2018.11.08 tingting 調整紅利折抵，在取預扣點數的取法
          SELECT  A.ACCOUNT_NO
                 ,B.ID
                 ,SUM(D.REWARD_POINT - D.USED_POINT) REM_POINT --剩餘點數(紅利點數 - 使用點數)
            FROM ECS.SHOPCAR_TRADE_TEMP A
            JOIN FAS.HOLDER B ON A.ACCOUNT_NO = B.ACCOUNT_NO
            JOIN FAS.REWARD_POINT D
              ON D.ID = B.ID
             AND A.TX_DATE BETWEEN D.VALID_FROM AND D.VALID_THRU
           WHERE D.REWARD_POINT - D.USED_POINT > 0
           GROUP BY A.ACCOUNT_NO,B.ID
         ) D
      ON A.ACCOUNT_NO = D.ACCOUNT_NO
    JOIN (-- 2018.11.08 tingting 調整紅利折抵，在取預扣點數的取法
          SELECT  A.ACCOUNT_NO
                 ,B.ID
                 ,SUM(NVL(W.USED_POINT,0)) USED_POINT    --預扣點數
            FROM ECS.SHOPCAR_TRADE_TEMP A
            JOIN FAS.HOLDER B ON A.ACCOUNT_NO = B.ACCOUNT_NO
            JOIN FAS.REWARD_POINT D
              ON D.ID = B.ID
             AND A.TX_DATE BETWEEN D.VALID_FROM AND D.VALID_THRU
            LEFT JOIN (
                 -- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
                 --還沒真正被使用的預扣點數
                 SELECT  REWARD_HISTORY.ID
                        ,REWARD_POINT.REWARD_NO
                        ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
                   FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
                   JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
                     ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
                    AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
                   JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
                     ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
                  WHERE REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
                  GROUP BY REWARD_HISTORY.ID, REWARD_POINT.REWARD_NO
                  ORDER BY REWARD_HISTORY.ID, REWARD_POINT.REWARD_NO
                 ) W         --紅利配發資料(預扣)
              ON W.ID = D.ID
             AND W.REWARD_NO = D.REWARD_NO
           GROUP BY A.ACCOUNT_NO,B.ID
         ) E
      ON A.ACCOUNT_NO = E.ACCOUNT_NO
   WHERE A.FEE_CHOICE = '3'
     AND A.USED_POINT > D.REM_POINT - E.USED_POINT   --可使用點數(剩餘點數 - 預扣點數)
     AND ((A.TX_TYPE != '4' AND WSTEP_TYPE IN('2','4'))
      OR (A.TX_TYPE = '4' AND WSTEP_TYPE = '3')); --申購步驟 2、4 檢查、轉申購步驟 3 檢查

  --檢查優惠/紅利 : SPC035 / TRS008 : 優惠券已被使用
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGCONTENT ELSE S.MSGCONTENT END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC035') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS008') S
    JOIN ECS.COUPON_DATA D ON D.COUPON_ID = A.COUPON_ID
   WHERE A.FEE_CHOICE = '2'
     AND D.IS_EFFECT = 'N'
     AND ((A.TX_TYPE != '4' AND WSTEP_TYPE IN('2','4'))
      OR (A.TX_TYPE = '4' AND WSTEP_TYPE = '3')); --申購步驟 2、4 檢查、轉申購步驟 3 檢查

  --檢查優惠/紅利 : SPC036 / TRS009 : 優惠券已逾期
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN REPLACE(C.MSGCONTENT,'{VALID_THRU}',TO_CHAR(D.VALID_THRU,'YYYY/MM/DD')) ELSE REPLACE(S.MSGCONTENT,'{VALID_THRU}',TO_CHAR(D.VALID_THRU,'YYYY/MM/DD')) END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC036') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS009') S
    JOIN ECS.COUPON_DATA D ON D.COUPON_ID = A.COUPON_ID
   WHERE A.FEE_CHOICE = '2'
     AND D.IS_EFFECT = 'Y'
     AND A.REDEM_TX_DATE >= D.VALID_THRU
     AND ((A.TX_TYPE != '4' AND WSTEP_TYPE IN('2','4'))
      OR (A.TX_TYPE = '4' AND WSTEP_TYPE = '3')); --申購步驟 2、4 檢查、轉申購步驟 3 檢查

  --檢查優惠/紅利 : SPC037 / TRS010 : 生日優惠
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGID ELSE S.MSGID END MSGID,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGTYPE ELSE S.MSGTYPE END MSGTYPE,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGMEMO ELSE S.MSGMEMO END MSGMEMO,
         CASE WHEN A.TX_TYPE <> '4' THEN C.MSGCONTENT ELSE S.MSGCONTENT END MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.HOLDER B ON A.ACCOUNT_NO = B.ACCOUNT_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC037') C
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS010') S
   WHERE A.FEE_CHOICE = '5'
     AND TO_CHAR(B.BIRTH_DATE, 'MM') <> CASE WHEN A.TX_TYPE <> '4' THEN TO_CHAR(A.TX_DATE, 'MM') ELSE TO_CHAR(A.REDEM_TX_DATE, 'MM') END
     AND ((A.TX_TYPE != '4' AND WSTEP_TYPE = '4')
      OR (A.TX_TYPE = '4' AND WSTEP_TYPE = '3')); --申購步驟 4檢查、轉申購步驟 3 檢查

  --檢查單筆申購 SPC042：同客戶同扣款日同銀行帳戶總申購金額上限
  -- 2018.09.05 ChengYu 新增單筆申購時 境內外申購總金額是否超過上限、同客戶同扣款日同銀行帳戶的 總單筆申購金額、總申購金額 上限 BEGIN
  -- 2019.02.19 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限、移除單筆申購重覆交易檢核
  -- 2018.11.27 tingting 調整錯誤訊息描述
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         CASE WHEN G.VERIFIED < D.FIS_SEAL_DATE
              THEN REPLACE(C.MSGCONTENT,'{LIMIT_AMOUNT}',TO_CHAR(D.SUM_PUR_AMOUNT_BYACT1, 'FM999,999,999,999,999'))
              WHEN G.VERIFIED >= D.FIS_SEAL_DATE
              THEN REPLACE(C.MSGCONTENT,'{LIMIT_AMOUNT}',TO_CHAR(D.SUM_PUR_AMOUNT_BYACT2, 'FM999,999,999,999,999'))
              ELSE ''
         END AS MSGCONTENT
         -- 2018.11.15 ChengYu 檢核金額上限要含手續費
    FROM (SELECT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.BANK_NO,SHOPCAR_TEMP.TX_DATE,SHOPCAR_TEMP.AC_CODE,
                 -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
                 SHOPCAR_TEMP.TRADE_CRNCY,
                 SUM(NVL(SHOPCAR_TEMP.TOT_AMOUNT * CASE WHEN SHOPCAR_TEMP.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(SHOPCAR_TEMP.FUND_NO, SHOPCAR_TEMP.TX_DATE) END,0)) AS SHOPCAR_AMOUNT
            FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
           WHERE SHOPCAR_TEMP.TX_TYPE = '1'
           GROUP BY SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.BANK_NO,SHOPCAR_TEMP.TX_DATE,SHOPCAR_TEMP.AC_CODE,SHOPCAR_TEMP.TRADE_CRNCY) A
   -- 2018.10.19 ChengYu 修正境內外金額檢查 GroupBy交易日、同客戶同扣款日同銀行帳戶總申購金額上限的錯誤訊息
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC042') C                --錯誤訊息
   CROSS JOIN (SELECT * FROM ECS.SYSTEM_PARAMETER) D                              --系統參數
    LEFT JOIN (SELECT  SHOPCAR_TRADE_TEMP.ACCOUNT_NO             --戶號
                      ,SHOPCAR_TRADE_TEMP.BANK_NO                --銀行代碼
                      ,SHOPCAR_TRADE_TEMP.TX_DATE                --交易日
                      ,SHOPCAR_TRADE_TEMP.AC_CODE                --扣款帳號
                      ,SHOPCAR_TRADE_TEMP.TX_TYPE                --交易類別\1.單筆申購 2.定額 3.不定額 4.轉申購
                      -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
                      ,SHOPCAR_TRADE_TEMP.TRADE_CRNCY            --交易幣別
                      -- 2019.08.12 ChengYu 修正金額上限檢查時的匯率幣別抓取
                      ,SUM(NVL(V_EC_PURCHASE.AMOUNT * CASE WHEN V_EC_PURCHASE.CURRENCY_NO = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(V_EC_PURCHASE.FUND_NO, V_EC_PURCHASE.TX_DATE) END,0)) AS SUM_AMOUNT   --總申購金額
                      ,SUM(NVL(V_EC_PURCHASE.SERVICE_CHARGE * CASE WHEN V_EC_PURCHASE.CURRENCY_NO = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(V_EC_PURCHASE.FUND_NO, V_EC_PURCHASE.TX_DATE) END,0)) AS SUM_SERVICE_CHARGE -- 總手續費
                 FROM ECS.SHOPCAR_TRADE_TEMP
                 LEFT JOIN FAS.HOLDER                                             --受益人基本資料
                   ON HOLDER.ACCOUNT_NO = SHOPCAR_TRADE_TEMP.ACCOUNT_NO
                 LEFT JOIN ECS.V_EC_PURCHASE                                      --購物車交易資料暫存檔
                   ON V_EC_PURCHASE.ID = HOLDER.ID
                  AND V_EC_PURCHASE.TX_DATE = SHOPCAR_TRADE_TEMP.TX_DATE
                  AND V_EC_PURCHASE.AC_BANK = SHOPCAR_TRADE_TEMP.BANK_NO
                  AND V_EC_PURCHASE.AC_CODE = SHOPCAR_TRADE_TEMP.AC_CODE
                GROUP BY SHOPCAR_TRADE_TEMP.ACCOUNT_NO,SHOPCAR_TRADE_TEMP.TX_TYPE,SHOPCAR_TRADE_TEMP.BANK_NO,SHOPCAR_TRADE_TEMP.TX_DATE,SHOPCAR_TRADE_TEMP.AC_CODE,SHOPCAR_TRADE_TEMP.TRADE_CRNCY
              ) E
      ON E.ACCOUNT_NO = A.ACCOUNT_NO
     AND E.TX_TYPE = A.TX_TYPE
     AND E.BANK_NO = A.BANK_NO
     AND E.TX_DATE = A.TX_DATE
     AND E.AC_CODE = A.AC_CODE
    LEFT JOIN FAS.HOLDER F                                           --受益人基本資料
      ON F.ACCOUNT_NO = A.ACCOUNT_NO
    LEFT JOIN FAS.HOLDER_BANK_EC G                                   --受益人扣款帳號
      ON G.ID = F.ID                 --受益人ID
     AND G.AC_BANK = A.BANK_NO       --往來銀行
     AND G.AC_CODE = A.AC_CODE       --往來帳號
     AND G.DEPOSITORY_NO = '01'      --帳戶保管平台代號(限財金 '01')
   WHERE (--(限財金)同客戶同扣款日同銀行帳戶總申購金額上限\核印完成日 小於 財金額度變更核印完成日期使用此組設定(SUM_PUR_AMOUNT_BYACT1)
          -- 2018.11.15 ChengYu 檢核金額上限要含手續費
          (NVL(E.SUM_AMOUNT,0) + NVL(E.SUM_SERVICE_CHARGE,0) + A.SHOPCAR_AMOUNT > D.SUM_PUR_AMOUNT_BYACT1 AND G.VERIFIED < D.FIS_SEAL_DATE)
          OR
          --同客戶同扣款日同銀行帳戶單筆申購金額上限\核印完成日 大於等於 財金額度變更核印完成日期使用此組設定(SUM_PUR_AMOUNT_BYACT2)
          -- 2018.11.15 ChengYu 檢核金額上限要含手續費
          (NVL(E.SUM_AMOUNT,0) + NVL(E.SUM_SERVICE_CHARGE,0) + A.SHOPCAR_AMOUNT > D.SUM_PUR_AMOUNT_BYACT2 AND G.VERIFIED >= D.FIS_SEAL_DATE)
         )
     AND A.TX_TYPE = '1'
     AND WSTEP_TYPE IN('2','4'); --單筆申購時步驟 2、4檢查

  --檢查單筆申購  SPC043：境內同客戶同交易日總申購金額上限;   SPC044：境外同客戶同交易日總申購金額上限
  -- 2018.11.27 tingting 調整錯誤訊息描述
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
         CASE WHEN A.FUND_CATEGORY = '1' THEN REPLACE(C.MSGCONTENT,'{LIMIT_AMOUNT}',TO_CHAR(D.ON_PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))
              WHEN A.FUND_CATEGORY = '2' THEN REPLACE(G.MSGCONTENT,'{LIMIT_AMOUNT}',TO_CHAR(D.OFF_PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))
              ELSE ''
         END AS MSGCONTENT
          -- 2018.11.15 ChengYu 檢核金額上限要含手續費
    FROM (SELECT FUND.FUND_CATEGORY,SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,
                 -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
                 SUM(NVL(SHOPCAR_TEMP.TOT_AMOUNT * CASE WHEN SHOPCAR_TEMP.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(SHOPCAR_TEMP.FUND_NO, SHOPCAR_TEMP.TX_DATE) END,0)) AS SHOPCAR_AMOUNT
            FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
            LEFT JOIN FAS.FUND
              ON FUND.FUND_NO = SHOPCAR_TEMP.FUND_NO
           GROUP BY FUND.FUND_CATEGORY,SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE) A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC043') C                --錯誤訊息(境內 SPC043)
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC044') G                --錯誤訊息(境外 SPC044)
   CROSS JOIN (SELECT * FROM ECS.SYSTEM_PARAMETER) D                              --系統參數
    LEFT JOIN (SELECT  SHOPCAR_TRADE_TEMP.ACCOUNT_NO             --戶號
                      ,FUND.FUND_CATEGORY                        --1.境內 2.境外
                      -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
                      -- 2019.08.12 ChengYu 修正金額上限檢查時的匯率幣別抓取
                      ,SUM(NVL(V_EC_PURCHASE.AMOUNT * CASE WHEN V_EC_PURCHASE.CURRENCY_NO = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(V_EC_PURCHASE.FUND_NO, V_EC_PURCHASE.TX_DATE) END,0)) AS SUM_AMOUNT   --總申購金額
                      ,SUM(NVL(V_EC_PURCHASE.SERVICE_CHARGE * CASE WHEN V_EC_PURCHASE.CURRENCY_NO = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(V_EC_PURCHASE.FUND_NO, V_EC_PURCHASE.TX_DATE) END,0)) AS SUM_SERVICE_CHARGE --總手續費
                 FROM ECS.SHOPCAR_TRADE_TEMP
                 LEFT JOIN FAS.FUND FUND
                   ON FUND.FUND_NO = SHOPCAR_TRADE_TEMP.FUND_NO
                 LEFT JOIN FAS.HOLDER                --受益人基本資料
                   ON HOLDER.ACCOUNT_NO = SHOPCAR_TRADE_TEMP.ACCOUNT_NO
                 LEFT JOIN ECS.V_EC_PURCHASE         --購物車交易資料暫存檔
                   ON V_EC_PURCHASE.ID = HOLDER.ID
                  AND V_EC_PURCHASE.TX_DATE = SHOPCAR_TRADE_TEMP.TX_DATE
                WHERE SHOPCAR_TRADE_TEMP.TX_TYPE = '1' -- 交易類別 為 1.單筆申購
                -- 2018.10.19 ChengYu 修正境內外金額檢查 GroupBy交易日、同客戶同扣款日同銀行帳戶總申購金額上限的錯誤訊息
                GROUP BY FUND.FUND_CATEGORY,SHOPCAR_TRADE_TEMP.ACCOUNT_NO,V_EC_PURCHASE.TX_DATE
              ) E  --找出境內申購總金額
      ON E.ACCOUNT_NO = A.ACCOUNT_NO
     AND E.FUND_CATEGORY = A.FUND_CATEGORY
   WHERE --檢查是否超過 境內外同客戶同交易日總申購金額上限
         -- 2018.11.15 ChengYu 檢核金額上限要含手續費
         NVL(E.SUM_AMOUNT,0) + NVL(E.SUM_SERVICE_CHARGE,0) + A.SHOPCAR_AMOUNT > CASE WHEN A.FUND_CATEGORY = '1' THEN  D.ON_PUR_AMOUNT_LIMIT  --境內同客戶同交易日總申購金額上限
                                                                                     WHEN A.FUND_CATEGORY = '2' THEN  D.OFF_PUR_AMOUNT_LIMIT --境外同客戶同交易日總申購金額上限
                                                                                     ELSE 0
                                                                                     END
     AND A.TX_TYPE = '1'
     AND WSTEP_TYPE IN('2','4'); --單筆申購步驟 2、4檢查
  -- 2018.09.05 ChengYu 新增單筆申購時 境內外申購總金額是否超過上限、同客戶同扣款日同銀行帳戶的 總單筆申購金額、總申購金額 上限 END

  --檢查扣款金額上限 SPC058：申購金額不可超過扣款金額上限
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  -- 2019.02.21 yunchu 調整檢核金額上限訊息(移除萬字，增加千分位)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,C.MSGID,C.MSGTYPE,C.MSGMEMO,REPLACE(C.MSGCONTENT,'{AMOUNT}',TO_CHAR(D.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999')) MSGCONTENT
    FROM (SELECT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.BANK_NO,SHOPCAR_TEMP.TX_DATE,SHOPCAR_TEMP.AC_CODE,
                 -- 2019.07.10 tingting 調整有跟ECS.SYSTEM_PARAMETER金額比較的檢核需要判斷幣別作匯率轉換
                 SUM(NVL(SHOPCAR_TEMP.TOT_AMOUNT * CASE WHEN SHOPCAR_TEMP.TRADE_CRNCY = 'NTD' THEN 1 ELSE ECS.F_GET_EX_RATE(SHOPCAR_TEMP.FUND_NO,SHOPCAR_TEMP.TX_DATE) END,0)) AS SHOPCAR_AMOUNT
            FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
           GROUP BY SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.BANK_NO,SHOPCAR_TEMP.TX_DATE,SHOPCAR_TEMP.AC_CODE) A
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC058') C                --錯誤訊息
   CROSS JOIN (SELECT * FROM ECS.SYSTEM_PARAMETER) D                              --系統參數
   WHERE (NVL(SHOPCAR_AMOUNT,0) > D.PUR_AMOUNT_LIMIT)
     AND A.TX_TYPE = '1'
     AND WSTEP_TYPE IN('2','4'); --單筆申購時步驟 2、4檢查

  --投資人是否為弱勢族群 SPC045 您選擇的『{FUND_NAME}』風險為『{RISK_CATEGORY}』，請於營業日9:00-17:30撥打客服專線(02)8758-6699按9轉接客服專員為您服務。**客服電話：{PHONE}
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.FUND_NO,MSGINFO.MSGID,MSGINFO.MSGTYPE,MSGINFO.MSGMEMO
                  -- 2018.10.08 ChengYu 調整弱勢族群錯誤訊息
                 ,REPLACE(REPLACE(REPLACE(MSGINFO.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{RISK_CATEGORY}',FUND.RISK_CATEGORY),'{PHONE}',COMPANY.SERVICE_TEL_NO)
    FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
    LEFT JOIN FAS.HOLDER
      ON HOLDER.ACCOUNT_NO = SHOPCAR_TEMP.ACCOUNT_NO
    LEFT JOIN FAS.FUND
      ON FUND.FUND_NO = SHOPCAR_TEMP.FUND_NO
    -- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
    LEFT JOIN TABLE(ECS.F_GET_RISK_LEVEL_MAPPING(CASE WHEN SHOPCAR_TEMP.TX_TYPE = '1' THEN '1' ELSE '2' END,CASE WHEN SHOPCAR_TEMP.TX_TYPE = '1' THEN SHOPCAR_TEMP.TX_DATE ELSE SYSDATE END)) RISK_CATEGORY
      ON RISK_CATEGORY.RISK_CATEGORY = FUND.RISK_CATEGORY
    LEFT JOIN ECS.MSGINFO MSGINFO
      ON MSGINFO.MSGID = 'SPC045'
    LEFT JOIN SMS.COMPANY
      ON COMPANY.COMPANY_NO = '01'
   WHERE (HOLDER.MAJOR_ILLNESS = 'Y'            --Ａ．有重大傷病
             --找出 系統年 與 出生年 的相差 + 是否 系統月份、日期是否過了今年生日， 如果還沒過生日 -1歲
          OR (TO_CHAR(SYSDATE,'YYYY') - TO_CHAR(HOLDER.BIRTH_DATE,'YYYY') + CASE WHEN TO_CHAR(SYSDATE,'MM') < TO_CHAR(HOLDER.BIRTH_DATE,'MM') THEN -1
                                                                             WHEN TO_CHAR(SYSDATE,'MM') = TO_CHAR(HOLDER.BIRTH_DATE,'MM') AND TO_CHAR(SYSDATE,'DD') < TO_CHAR(HOLDER.BIRTH_DATE,'DD') THEN -1
                                                                             ELSE 0
                                                                        END >=20
              AND HOLDER.EDUCATION IN ('A','a')
             )                                  --Ｂ．大於等於20歲 且學歷為國中小以下
             --找出 系統年 與 出生年 的相差 + 是否 系統月份、日期是否過了今年生日， 如果還沒過生日 -1歲
             -- 2022.07.30 JIANXIN 調整弱勢族群由70歲調整為65歲
          OR (TO_CHAR(SYSDATE,'YYYY') - TO_CHAR(HOLDER.BIRTH_DATE,'YYYY') + CASE WHEN TO_CHAR(SYSDATE,'MM') < TO_CHAR(HOLDER.BIRTH_DATE,'MM') THEN -1
                                                                             WHEN TO_CHAR(SYSDATE,'MM') = TO_CHAR(HOLDER.BIRTH_DATE,'MM') AND TO_CHAR(SYSDATE,'DD') < TO_CHAR(HOLDER.BIRTH_DATE,'DD') THEN -1
                                                                             ELSE 0
                                                                        END >=65
             )                                  --Ｃ．年齡大於等於65歲
         ) -- 1．弱勢族群
     -- 2023.03.13 JIANXIN 若是弱勢族群，則必須滿足以下條件，否則出現錯誤訊息
     -- 2023.03.24 JIANXIN 針對弱勢族群自主聲明同意與不同意進行不同情境處理
     -- 2023.03.27 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
     -- 2023.03.30 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
     -- 2023.10.08 JIANXIN 針對弱勢族群Null 判斷
     -- 自主申購聲明\1：空值；2：同意；3：不同意
     -- 自主申購聲明 = 2.同意
     -- 弱勢族群評估 vulnerable_group = Y.已交付
     -- 弱勢族群評估到期日 vulnerable_mat_date > today (到期日大於今日)
     -- 則只可申購RR1~RR4基金
     -- 自主申購聲明 = 1.不同意
     -- 則只可申購RR1~RR2基金
     AND (
           (
             (   HOLDER.VULNERABLE_CLAIM = '3'
             )
             AND RISK_CATEGORY.RISK_CATEGORY NOT IN ('RR1','RR2')
           )
           OR 
           (
             (    HOLDER.VULNERABLE_CLAIM = '2'
              AND (   HOLDER.VULNERABLE_GROUP = 'N'
                   OR (HOLDER.VULNERABLE_GROUP = 'Y' AND HOLDER.VULNERABLE_MAT_DATE <= SYSDATE)
                  )
             )
             AND RISK_CATEGORY.RISK_CATEGORY NOT IN ('RR1','RR2','RR3','RR4')

           )
           OR 
           (
             (     HOLDER.VULNERABLE_CLAIM IS NULL OR HOLDER.VULNERABLE_CLAIM = '' OR HOLDER.VULNERABLE_CLAIM = ' ' OR HOLDER.VULNERABLE_CLAIM = '1'               
             )
             AND RISK_CATEGORY.RISK_CATEGORY NOT IN ('RR1','RR2','RR3','RR4')

           )
         )
   -- 2020.03.12 yunchu 調整申購時步驟改為2檢查
   AND ((SHOPCAR_TEMP.TX_TYPE !='4' AND WSTEP_TYPE = '2')  --申購時步驟 2檢查
      OR (SHOPCAR_TEMP.TX_TYPE = '4' AND WSTEP_TYPE = '2')); --轉申購步驟 2檢查

  --投資人國籍檢核 SPC046 很抱歉，依境外基金公開說明書及投資人須知規範，本基金之受益人/聯名持有人不得為美國及英國居民，以及受益人/聯名持有人並不得為美國居民或英國居民持有本基金股份
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.FUND_NO,MSGINFO.MSGID,MSGINFO.MSGTYPE,MSGINFO.MSGMEMO,MSGINFO.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
    LEFT JOIN FAS.HOLDER
      ON HOLDER.ACCOUNT_NO = SHOPCAR_TEMP.ACCOUNT_NO
    LEFT JOIN FAS.COUNTRY
      ON HOLDER.NATIONALITY = COUNTRY.COUNTRY_CODE
    LEFT JOIN ECS.MSGINFO MSGINFO
      ON MSGINFO.MSGID = 'SPC046'
    LEFT JOIN FAS.FUND
      ON FUND.FUND_NO = SHOPCAR_TEMP.FUND_NO
   -- 2018.11.16 JIANXIN MOD
   -- i.   美屬受益人所有基金都不可以買賣
   -- ii.  英屬受益人不能買賣 基金公司=M&G，且註冊地= UK 的基金
   -- iii. 大陸屬受益人所有基金都不可以買賣
   WHERE (   (COUNTRY.NAME LIKE '美屬%' OR COUNTRY.NAME LIKE '中國大陸%')
          OR (COUNTRY.NAME LIKE '英屬%' AND SHOPCAR_TEMP.AMC_NO = '03' AND FUND.REGISTRATION = 'UK'))
     AND ((SHOPCAR_TEMP.TX_TYPE != '4' AND WSTEP_TYPE = '1')  --申購時步驟 1 檢查
      OR  (SHOPCAR_TEMP.TX_TYPE = '4' AND WSTEP_TYPE = '2')); --轉申購步驟 2 檢查

  --投資人開戶類別檢核  SPC048 投資人未完成申購基金的開戶
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.FUND_NO,MSGINFO.MSGID,MSGINFO.MSGTYPE,MSGINFO.MSGMEMO,MSGINFO.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
    JOIN FAS.HOLDER HOLDER
      ON HOLDER.ACCOUNT_NO = SHOPCAR_TEMP.ACCOUNT_NO
    JOIN FAS.AMC
      ON SHOPCAR_TEMP.AMC_NO = AMC.AMC_NO
    LEFT JOIN FAS.HOLDER_AMC HOLDER_AMC
      ON HOLDER_AMC.ID = HOLDER.ID
     AND HOLDER_AMC.AMC_NO = AMC.AMC_NO
    LEFT JOIN ECS.MSGINFO MSGINFO
      ON MSGINFO.MSGID = 'SPC048'
   WHERE ((SHOPCAR_TEMP.AMC_NO IN ('01','02','03') AND HOLDER_AMC.OPEN_DATE IS NULL )                         --A.為 01.瀚亞投信(境內) 或 02.瀚亞投資(新加坡) 或 03.M&G(新加坡) 時，開戶日期(FAS.HOLDER_AMC.OPEN_DATE)為空白
      OR (SHOPCAR_TEMP.AMC_NO = '04' AND (HOLDER_AMC.OPEN_DATE IS NULL OR HOLDER_AMC.TDCC_OPEN_DATE IS NULL)))-- 04.瑞萬通博(TDCC)，開戶日期(FAS.HOLDER_AMC.OPEN_DATE) 或 集保開戶日期(FAS.HOLDER_AMC.TDCC_OPEN_DATE) 為空白
     AND SHOPCAR_TEMP.TX_TYPE != '4'
     AND WSTEP_TYPE = '1'; --申購時步驟1 檢查

  --投資人為員工或員眷(交易管制) SPC049、TRS018  在職員工關係人(員工、配偶、子女)於N日內有【申購或買回】時，則不可再申購同一母基金
  -- 2018.12.05 ChengYu 員工員眷檢核 修正同一母基金的基金判斷、修正轉申購員工員眷交易控管檢核
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE
  ,CASE WHEN SHOPCAR_TEMP.TX_TYPE != '4' THEN SHOPCAR_TEMP.FUND_NO ELSE SHOPCAR_TEMP.REDEM_FUND END
  ,CASE WHEN SHOPCAR_TEMP.TX_TYPE != '4' THEN MSGINFO.MSGID ELSE MSGINFO_SW.MSGID END
  ,CASE WHEN SHOPCAR_TEMP.TX_TYPE != '4' THEN MSGINFO.MSGTYPE ELSE MSGINFO_SW.MSGTYPE END
  ,CASE WHEN SHOPCAR_TEMP.TX_TYPE != '4' THEN MSGINFO.MSGMEMO ELSE MSGINFO_SW.MSGMEMO END
  ,CASE WHEN SHOPCAR_TEMP.TX_TYPE != '4' THEN MSGINFO.MSGCONTENT ELSE MSGINFO_SW.MSGCONTENT END
    FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
    JOIN FAS.FUND
      ON FUND.FUND_NO = SHOPCAR_TEMP.FUND_NO
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
    JOIN FAS.HOLDER
      ON HOLDER.ACCOUNT_NO = SHOPCAR_TEMP.ACCOUNT_NO
    LEFT JOIN FAS.RELATIVE
      ON RELATIVE.ID = HOLDER.ID
    -- 2021.07.08 Chengyu 修正員工員眷是否在職條件
    LEFT JOIN FAS.EMP
      ON EMP.ID = RELATIVE.EMP_ID
    -- 2018.10.05 ChengYu 員工員眷檢核 修正FAS.CERTIFICATE (受益憑證檔)取法
    --LEFT JOIN (SELECT ID,FUND_NO,MAX(PUR_DATE) AS PUR_DATE
    --             FROM FAS.CERTIFICATE
    --            -- 2018.09.28 ChengYu 員工員眷排除 受益憑證檔(FAS.CERTIFICATE) 的 代銷單位分公司碼(BRANCH_NO) 為 8800 的資料
    --            WHERE CERTIFICATE.BRANCH_NO != '8800'
    --            GROUP BY ID,FUND_NO
    --          ) CERTIFICATE   --找出最近 原始申購日期 來檢查
    --  ON CERTIFICATE.FUND_NO = SHOPCAR_TEMP.FUND_NO
    -- AND CERTIFICATE.ID = HOLDER.ID
    -- 2018.11.21 JIANXIN 員工員眷檢核 調整為贖回後，才會鎖定員工交易，申購不控管
    LEFT JOIN (SELECT V_ALL_REDEMPTION.ID,FUND.FUND_MASTER_NO,MAX(V_ALL_REDEMPTION.TX_DATE) AS TX_DATE
                 FROM FAS.V_ALL_REDEMPTION
                 JOIN FAS.FUND
                   ON FUND.FUND_NO = V_ALL_REDEMPTION.FUND_NO
                -- 2018.09.28 ChengYu 員工員眷排除 受益憑證檔(FAS.CERTIFICATE) 的 代銷單位分公司碼(BRANCH_NO) 為 8800 的資料
                WHERE V_ALL_REDEMPTION.BRANCH_NO != '8800'
                GROUP BY V_ALL_REDEMPTION.ID,FUND.FUND_MASTER_NO
              ) V_ALL_REDEMPTION   --找出最近 原始申購日期 來檢查
      ON V_ALL_REDEMPTION.FUND_MASTER_NO = FUND.FUND_MASTER_NO
     AND V_ALL_REDEMPTION.ID = HOLDER.ID
    LEFT JOIN ECS.MSGINFO MSGINFO
      ON MSGINFO.MSGID = 'SPC049'
    LEFT JOIN ECS.MSGINFO MSGINFO_SW
      ON MSGINFO_SW.MSGID = 'TRS018'
   -- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
   -- 2021.06.04 JIANXIN 修正員工員眷的檢查
   -- 2021.07.08 Chengyu 修正員工員眷是否在職條件
   WHERE (RELATIVE.RELATIONSHIP IN ('S','P','C') AND EMP.STATUS = 'A')
     -- 2018.10.04 JIANXIN 若員工員眷未申購過，則不檢查
     -- 2018.11.21 JIANXIN 員工員眷檢核 調整為贖回後，才會鎖定員工交易，申購不控管
     AND V_ALL_REDEMPTION.TX_DATE IS NOT NULL
     AND AMC.EMP_CTL_CODE = 'Y'      --員工交易控管為'Y'
     AND TRUNC(SYSDATE) - TRUNC(V_ALL_REDEMPTION.TX_DATE) < CASE WHEN FUND.FUND_TYPE = 'B3' THEN 7  --貨幣型基金為7日
                                                                                            ELSE 60 --非貨幣型基金為60日
                                                                                       END
     AND ((SHOPCAR_TEMP.TX_TYPE != '4' AND WSTEP_TYPE = '1')        --申購時步驟 1檢查
      OR (SHOPCAR_TEMP.TX_TYPE = '4' AND WSTEP_TYPE IN ('2','3')))  --轉申購步驟 2檢查
     -- 2018.10.05 ChengYu IS_ROBO 為Y時不檢查
     AND SHOPCAR_TEMP.IS_ROBO != 'Y';

  -- 2018.09.28 ChengYu 新增ROBO同意書檢查
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT SHOPCAR_TEMP.ACCOUNT_NO,SHOPCAR_TEMP.TX_TYPE,SHOPCAR_TEMP.FUND_NO,MSGINFO.MSGID,MSGINFO.MSGTYPE,MSGINFO.MSGMEMO,MSGINFO.MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TEMP
    LEFT JOIN FAS.HOLDER
      ON HOLDER.ACCOUNT_NO = SHOPCAR_TEMP.ACCOUNT_NO
    LEFT JOIN ECS.MSGINFO MSGINFO
      ON MSGINFO.MSGID = 'SPC050'
   WHERE SHOPCAR_TEMP.IS_ROBO = 'Y'
     AND HOLDER.ROBO_AGREEMENT = 'N'
     AND SHOPCAR_TEMP.TX_TYPE != '4'
     AND WSTEP_TYPE = '4';

  -- 2018.10.03 ChengYu --檢查申購手續費數值是否正確
  --檢查申購手續費數值是否正確 : SPC051 : 申購金額與申購手續費率相乘 不等於 申購手續費
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         C.MSGCONTENT MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN ECS.V_FUND_CRNCY B ON A.TRADE_CRNCY = B.CURRENCY_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC051') C
   WHERE ROUND((A.AMOUNT * NVL(A.SC_RATE,0))/100,B.AMT_DECIMAL) != A.SERVICE_CHARGE
     AND (   A.FEE_CHOICE != '3'
          OR A.FEE_CHOICE IS NULL
         )
     AND TX_TYPE != '4'
     AND WSTEP_TYPE IN('2','4');      --申購時步驟 2、4檢查

  -- 2018.10.11 ChengYu 檢查加減碼金額下限 BEGIN

  --檢查加碼金額下限 : SPC052 : 加碼金額不可小於網路定額最低金額：{AMOUNT}
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMOUNT}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.EC_PERIOD_MIN ELSE B.EC_PERIOD_MIN_NTD END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC052') C
   WHERE A.RAISE_AMOUNT < (CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.EC_PERIOD_MIN ELSE B.EC_PERIOD_MIN_NTD END)
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查減碼金額下限 : SPC053 : 減碼金額不可小於網路定額最低金額：{AMOUNT}
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{AMOUNT}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.EC_PERIOD_MIN ELSE B.EC_PERIOD_MIN_NTD END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC053') C
   WHERE A.REDUCE_AMOUNT < (CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.EC_PERIOD_MIN ELSE B.EC_PERIOD_MIN_NTD END)
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  -- 2018.10.11 ChengYu 檢查加減碼金額下限 END

  -- 2018.11.13 ChengYu 檢查加減碼金額倍數檢查 BEGIN

  --檢查加碼金額倍數 :  SPC054 加碼金額不符合網路定額扣款金額倍數：{RANGE}
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{RANGE}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC054') C
   WHERE MOD(A.RAISE_AMOUNT ,(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END) ) != 0
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  --檢查減碼金額倍數 :  SPC055 減碼金額不符合網路定額扣款金額倍數：{RANGE}
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO,
         REPLACE(C.MSGCONTENT,'{RANGE}',(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END)) MSGCONTENT
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC055') C
   WHERE MOD(A.REDUCE_AMOUNT ,(CASE WHEN A.TRADE_CRNCY = B.CURRENCY_NO THEN B.ORG_RSP_RANGE ELSE B.NTD_RSP_RANGE END) ) != 0
     AND A.TX_TYPE = '3'
     AND WSTEP_TYPE IN('3','4');      --定期(不)定額步驟 3、4檢查

  -- 2018.11.13 ChengYu 檢查加減碼金額倍數檢查 END

  -- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
  --檢查基金交易方式 : SPC056 : 請確認目標到期投資風險預告書是否已閱讀完畢
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO
         ,REPLACE(REPLACE(C.MSGCONTENT,'{FUND_NAME}',B.NAME),'{PHONE}',D.SERVICE_TEL_NO)
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC056') C
   CROSS JOIN (SELECT * FROM SMS.COMPANY WHERE COMPANY_NO = '01') D
   WHERE A.TX_TYPE = '1'  -- 單筆申購
     AND B.FUND_SET = '17'        -- 依據需求討論只有 在單筆申購 FUND_SET = '17' 時，需做檢查
     AND A.IS_INVEST_RISK <> 'Y'
     AND WSTEP_TYPE IN ('4');      -- 單筆申購步驟 4 檢查

  -- 2019.01.10 JIANXIN 新增檢查【目標到期投資風險預告書】(逆向檢查)
  -- 2020.05.07 JIANXIN 新增檢查【目標到期投資風險預告書】新增 FUND_SET <> '10'
  --檢查基金交易方式 : SPC057 : 無須閱讀【目標到期投資風險預告書】
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,C.MSGID,C.MSGTYPE,C.MSGMEMO
         ,REPLACE(REPLACE(C.MSGCONTENT,'{FUND_NAME}',B.NAME),'{PHONE}',D.SERVICE_TEL_NO)
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B ON A.FUND_NO = B.FUND_NO
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'SPC057') C
   CROSS JOIN (SELECT * FROM SMS.COMPANY WHERE COMPANY_NO = '01') D
   WHERE A.TX_TYPE = '1'  -- 單筆申購
     AND B.FUND_SET NOT IN  ('10','17')        -- 依據需求討論只有 在單筆申購 FUND_SET <> '17' 時，需做檢查
     AND A.IS_INVEST_RISK = 'Y'
     AND WSTEP_TYPE IN ('4');      -- 單筆申購步驟 4 檢查

  -- 2020.07.28 Chengyu 新增檢核境外轉申購時，同基金公司檢核
  --檢查境外轉申購時，同基金公司需檢查贖回日是否為轉入基金營業日：TRS021：交易日{REDEM_TX_DATE}不為轉入基金『{FUND_IN_NAME}』的營業日
  INSERT INTO ECS.SHOPCAR_ERR_TEMP
    (ACCOUNT_NO,TX_TYPE,FUND_NO,MSG_ID,MSG_TYPE,MSG_MEMO,ERROR_MSG)
  SELECT DISTINCT A.ACCOUNT_NO,A.TX_TYPE,A.FUND_NO,E.MSGID,E.MSGTYPE,E.MSGMEMO
         -- 2020.09.18 Chengyu 調整境外轉申購時同基金公司檢核錯誤訊息
         ,REPLACE(REPLACE(REPLACE(E.MSGCONTENT,'{YEAR}',TO_CHAR(A.REDEM_TX_DATE, 'YYYY')),'{MONTH}',TO_CHAR(A.REDEM_TX_DATE, 'MM')),'{DAY}',TO_CHAR(A.REDEM_TX_DATE, 'DD'))
    FROM ECS.SHOPCAR_TRADE_TEMP A
    JOIN FAS.FUND B
      ON A.FUND_NO = B.FUND_NO
    JOIN FAS.FUND C
      ON A.REDEM_FUND = C.FUND_NO
    LEFT JOIN FAS.CALENDAR D
      ON D.CALENDAR_CODE = B.TX_CALENDAR_CODE --轉入基金交易日行事曆
     AND D.HOLIDAY = A.REDEM_TX_DATE  --贖回交易日去檢查轉入基金行事曆
   CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGID = 'TRS021') E
   WHERE A.TX_TYPE = '4'  -- 轉申購
     AND B.FUND_CATEGORY = '2'
     AND C.FUND_CATEGORY = '2'
     AND B.AMC_NO = C.AMC_NO
     AND D.HOLIDAY IS NOT NULL -- 該日為假日
     AND WSTEP_TYPE IN ('3');  -- 轉申購步驟 3 檢查

  OPEN OUTDT FOR
  SELECT 'Y' AS IS_SUCCESS
    FROM DUAL;

END s_CheckAllotFundData;

/

  GRANT EXECUTE ON "ECS"."S_CHECKALLOTFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKALLOTFUNDDATA_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKALLOTFUNDDATA_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/08/10
-- Description: 檢查購物車交易資料(取出TMP資料、清除TMP)
-- 2018.08.10 ChengYu 增加JOIN欄位
-- 2018.08.20 ChengYu 修正傳出欄位(ERROR_MSG)
-- 2018.09.11 ChengYu 是否重寫KYC改由C#處理
-- 2018.11.14 ChengYu 新增傳出參數IS_WRITE_KYC、交易型態用OPTION回傳
-- =============================================
(
    WSTEP_TYPE      ECS.SHOPCAR_TRADE_TEMP.STEP_TYPE%TYPE, ---交易步驟

    OUTDT                     OUT SYS_REFCURSOR,           -- 傳出TABLE ShopList1(STEP 1 購物車列表)
    OUTDT2                    OUT SYS_REFCURSOR            -- 傳出TABLE ShopList1(購物車錯誤列表)
)
IS
BEGIN

    OPEN OUTDT FOR
    SELECT DISTINCT
            -- 2018.11.14 ChengYu 新增傳出參數IS_WRITE_KYC、交易型態用OPTION回傳
            ECS_OPTION.DISPLAY_NAME AS SHOP_TYPE
           ,FUND.ISIN_CODE
           ,FUND.FUND_NO
            -- 2018.11.14 ChengYu 新增傳出參數IS_WRITE_KYC、交易型態用OPTION回傳
           ,SHOPCAR_TRADE_TEMP.IS_WRITE_KYC
      FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TRADE_TEMP
      LEFT JOIN FAS.FUND
        ON FUND.FUND_NO = SHOPCAR_TRADE_TEMP.FUND_NO
      LEFT JOIN ECS.ECS_OPTION
        ON ECS_OPTION.SOURCE_TYPE = '022'
       AND ECS_OPTION.TEXT_VALUE = SHOPCAR_TRADE_TEMP.TX_TYPE
     WHERE WSTEP_TYPE = '1';

    OPEN OUTDT2 FOR
    SELECT DISTINCT
            -- 2018.11.14 ChengYu 新增傳出參數IS_WRITE_KYC、交易型態用OPTION回傳
            ECS_OPTION.DISPLAY_NAME AS SHOP_TYPE
           ,FUND.FUND_NO AS FUND_NO
           ,FUND.ISIN_CODE AS ISIN_CODE
           ,SHOPCAR_ERR_TEMP.MSG_TYPE AS WARNS_TYPE
           -- 2018.08.20 ChengYu 修正傳出欄位(ERROR_MSG)
           ,SHOPCAR_ERR_TEMP.ERROR_MSG AS ERROR_MSG
      FROM ECS.SHOPCAR_ERR_TEMP
      LEFT JOIN FAS.FUND FUND
        ON FUND.FUND_NO = SHOPCAR_ERR_TEMP.FUND_NO
      LEFT JOIN ECS.ECS_OPTION
        ON ECS_OPTION.SOURCE_TYPE = '022'
       AND ECS_OPTION.TEXT_VALUE = SHOPCAR_ERR_TEMP.TX_TYPE;

    DELETE FROM ECS.SHOPCAR_TRADE_TEMP;
    DELETE FROM ECS.SHOPCAR_ERR_TEMP;


END ;

/

  GRANT EXECUTE ON "ECS"."S_CHECKALLOTFUNDDATA_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKALLOTFUNDDATA_INSERT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKALLOTFUNDDATA_INSERT" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/08/10
-- Description: 檢查購物車交易資料(新增進TMP)
-- 2018.09.05 ChengYu 增加傳入欄位 基金公司代碼、扣款分行代碼、扣款帳號、加碼金額、減碼金額
-- 2018.09.21 ChengYu 增加步驟4做檢查、步驟1拿掉傳入參數 交易幣別
-- 2018.09.28 ChengYu 增加ROBO判斷
-- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
-- 2018.10.05 ChengYu ROBO契約書號沒傳入時 IS_ROBO 為 N
-- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
-- 2018.11.14 ChegnYu 步驟1新增傳入參數 TX_DATE、調整受益人風險等級判斷
-- 2018.11.15 ChengYu 修正KYC檢核用的日期格式(只要日期)
-- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
-- 2020.03.13 ChengYu 調整投資人投資適性步驟
-- =============================================
(
    WACCOUNT_NO     INTEGER,            --受益人戶號
    WIP_ADR         VARCHAR2,           --IP位址
    WSTEP_TYPE      VARCHAR2,           --交易步驟
    WSHPOLAIT1      VARCHAR2,           --ShopList1 STEP 1 購物車列表
    WSHPOLAIT2      VARCHAR2,           --ShopList2 STEP 2 購物車列表
    WSHPOLAIT3      VARCHAR2,           --ShopList3 STEP 3 購物車列表
    WSHPOLAIT4      VARCHAR2,           --ShopList4 STEP 4 購物車列表

    OUTDT           OUT SYS_REFCURSOR   --回傳table
)
IS
BEGIN

    IF WSTEP_TYPE = '1' THEN
      BEGIN

        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                ACCOUNT_NO
               ,TX_TYPE
               ,KYC_RISK_LEVEL
               ,IS_WRITE_KYC
               ,AMC_NO
               ,FUND_NO
               ,STEP_TYPE
               -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
               ,IS_ROBO
               -- 2018.11.14 ChegnYu 步驟1新增傳入參數 TX_DATE、調整受益人風險等級判斷
               ,TX_DATE
             )
        SELECT  WACCOUNT_NO          AS ACCOUNT_NO
               ,TB_DATA.SHOP_TYPE    AS TX_TYPE
               -- 2018.11.14 ChegnYu 步驟1新增傳入參數 TX_DATE、調整受益人風險等級判斷
               -- 2018.11.15 ChengYu 修正KYC檢核用的日期格式(只要日期)
               -- 2020.03.13 ChengYu 調整投資人投資適性步驟
               ,''
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '2' THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     ELSE ''
                END AS IS_WRITE_KYC
               ,TB_DATA.AMC_NO       AS AMC_NO
               ,TB_DATA.FUND_NO      AS FUND_NO
               ,'1'                  AS STEP_TYPE
               -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
               ,'N'                  AS IS_ROBO
               -- 2018.11.14 ChegnYu 步驟1新增傳入參數 TX_DATE、調整受益人風險等級判斷
               ,TB_DATA.TX_DATE      AS TX_DATE
          FROM (SELECT  TB_TEMP.VALUE1 AS SHOP_TYPE
                       ,TB_TEMP.VALUE2 AS FUND_CATEGORY
                       ,TB_TEMP.VALUE3 AS AMC_NO
                       ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             WHEN TB_TEMP.VALUE5 IS NOT NULL THEN TB_TEMP.VALUE5
                             WHEN TB_TEMP.VALUE4 IS NOT NULL THEN TB_TEMP.VALUE4
                             ELSE ''
                        END AS FUND_NO
                       ,TO_DATE(TB_TEMP.VALUE6,'YYYYMMDD') AS TX_DATE
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSHPOLAIT1))) TB_TEMP
                  LEFT JOIN FAS.FUND FUND_FUND_NO
                    ON FUND_FUND_NO.FUND_NO = TB_TEMP.VALUE5
                  LEFT JOIN FAS.FUND FUND_ISIN_CODE
                    ON FUND_ISIN_CODE.FUND_NO = TB_TEMP.VALUE4
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    ELSIF WSTEP_TYPE = '2' THEN
      BEGIN
        -- 2018.09.05 ChengYu 增加傳入欄位 基金公司代碼、扣款分行代碼、扣款帳號、加碼金額、減碼金額
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                 ACCOUNT_NO
                ,TX_TYPE
                ,AMC_NO
                ,KYC_RISK_LEVEL
                ,IS_WRITE_KYC
                ,FUND_NO
                ,TRADE_CRNCY
                ,TX_DATE
                ,AMOUNT
                ,SC_RATE
                ,SERVICE_CHARGE
                ,TOT_AMOUNT
                ,BANK_NO
                ,AC_CODE
                ,STEP_TYPE
                -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                ,FEE_CHOICE
                ,PROJECT_CODE
                ,COUPON_ID
                ,USED_POINT
                -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
                ,IS_ROBO
             )
        SELECT  WACCOUNT_NO                  AS ACCOUNT_NO
               ,TB_DATA.SHOP_TYPE            AS TX_TYPE
               ,TB_DATA.AMC_NO               AS AMC_NO
               -- 2020.03.13 ChengYu 調整投資人投資適性步驟
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     WHEN HOLDER.RISK_STATUS = '2' THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     ELSE HOLDER.RISK_LEVEL
                END                          AS KYC_RISK_LEVEL
               ,''                           AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO              AS FUND_NO
               ,TB_DATA.TRADE_CRNCY          AS TRADE_CRNCY
               ,TB_DATA.TX_DATE              AS TX_DATE
               ,TB_DATA.AMOUNT               AS AMOUNT
               ,TB_DATA.SC_RATE              AS SC_RATE
               ,TB_DATA.SERVICE_CHARGE       AS SERVICE_CHARGE
               ,TB_DATA.TOT_AMOUNT           AS TOT_AMOUNT
               ,TB_DATA.BANK_NO              AS BANK_NO
               ,TB_DATA.AC_CODE              AS AC_CODE
               ,'2'                          AS STEP_TYPE
               -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
               ,TB_DATA.FEE_CHOICE           AS FEE_CHOICE
               ,TB_DATA.PROJECT_CODE         AS PROJECT_CODE
               ,TB_DATA.COUPON_ID            AS COUPON_ID
               ,TB_DATA.USED_POINT           AS USED_POINT
               -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
               ,'N'                          AS IS_ROBO
          FROM (SELECT  TB_TEMP.VALUE1                      AS SHOP_TYPE
                       ,TB_TEMP.VALUE2                      AS AMC_NO
                       ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             WHEN TB_TEMP.VALUE4 IS NOT NULL THEN TB_TEMP.VALUE4
                             WHEN TB_TEMP.VALUE3 IS NOT NULL THEN TB_TEMP.VALUE3
                             ELSE ''
                        END                                 AS FUND_NO
                       ,TO_DATE(TB_TEMP.VALUE5,'YYYYMMDD')  AS TX_DATE
                       ,TB_TEMP.VALUE6                      AS TRADE_CRNCY
                       ,TB_TEMP.VALUE7                      AS AMOUNT
                       ,TB_TEMP.VALUE8                      AS SC_RATE
                       ,TB_TEMP.VALUE9                      AS SERVICE_CHARGE
                       ,TB_TEMP.VALUE10                     AS TOT_AMOUNT
                       ,TB_TEMP.VALUE11                     AS BANK_NO
                       ,TB_TEMP.VALUE12                     AS AC_BRANCH
                       ,TB_TEMP.VALUE13                     AS AC_CODE
                       ,TB_TEMP.VALUE14                     AS AC_DAY
                       -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                       ,TB_TEMP.VALUE15                     AS FEE_CHOICE
                       ,TB_TEMP.VALUE16                     AS PROJECT_CODE
                       ,TB_TEMP.VALUE17                     AS COUPON_ID
                       ,TB_TEMP.VALUE18                     AS USED_POINT
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSHPOLAIT2))) TB_TEMP
                  LEFT JOIN FAS.FUND FUND_FUND_NO
                    ON FUND_FUND_NO.FUND_NO = TB_TEMP.VALUE4
                  LEFT JOIN FAS.FUND FUND_ISIN_CODE
                    ON FUND_ISIN_CODE.FUND_NO = TB_TEMP.VALUE3
               )TB_DATA
          -- 2020.03.13 ChengYu 調整投資人投資適性步驟
          JOIN FAS.HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    ELSIF WSTEP_TYPE = '3' THEN
      BEGIN
        -- 2018.09.05 ChengYu 增加傳入欄位 基金公司代碼、扣款分行代碼、扣款帳號、加碼金額、減碼金額
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                 ACCOUNT_NO
                ,TX_TYPE
                ,AMC_NO
                ,KYC_RISK_LEVEL
                ,IS_WRITE_KYC
                ,FUND_NO
                ,TRADE_CRNCY
                ,TX_DATE
                ,AMOUNT
                ,SC_RATE
                ,SERVICE_CHARGE
                ,TOT_AMOUNT
                ,BANK_NO
                ,AC_CODE
                ,RAISE_ROI
                ,RAISE_AMOUNT
                ,REDUCE_ROI
                ,REDUCE_AMOUNT
                ,STEP_TYPE
                -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
                ,IS_ROBO
             )
        SELECT  WACCOUNT_NO                  AS ACCOUNT_NO
               ,TB_DATA.SHOP_TYPE            AS TX_TYPE
               ,TB_DATA.AMC_NO               AS AMC_NO
               ,''                           AS KYC_RISK_LEVEL
               ,''                           AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO              AS FUND_NO
               ,TB_DATA.TRADE_CRNCY          AS TRADE_CRNCY
               ,TB_DATA.TX_DATE              AS TX_DATE
               ,TB_DATA.AMOUNT               AS AMOUNT
               ,TB_DATA.SC_RATE              AS SC_RATE
               ,TB_DATA.SERVICE_CHARGE       AS SERVICE_CHARGE
               ,TB_DATA.TOT_AMOUNT           AS TOT_AMOUNT
               ,TB_DATA.BANK_NO              AS BANK_NO
               ,TB_DATA.AC_CODE              AS AC_CODE
               ,TB_DATA.RAISE_ROI            AS RAISE_ROI
               ,TB_DATA.RAISE_AMOUNT         AS RAISE_AMOUNT
               ,TB_DATA.REDUCE_ROI           AS REDUCE_ROI
               ,TB_DATA.REDUCE_AMOUNT        AS REDUCE_AMOUNT
               ,'3'                          AS STEP_TYPE
               -- 2018.10.08 ChengYu 無欄位判斷 IS_ROBO，則給N
               ,'N'                          AS IS_ROBO
          FROM (SELECT  TB_TEMP.VALUE1                      AS SHOP_TYPE
                       ,TB_TEMP.VALUE2                      AS AMC_NO
                       ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             WHEN TB_TEMP.VALUE4 IS NOT NULL THEN TB_TEMP.VALUE4
                             WHEN TB_TEMP.VALUE3 IS NOT NULL THEN TB_TEMP.VALUE3
                             ELSE ''
                        END AS FUND_NO
                       ,TO_DATE(TB_TEMP.VALUE5,'YYYYMMDD')  AS TX_DATE
                       ,TB_TEMP.VALUE6                      AS TRADE_CRNCY
                       ,TB_TEMP.VALUE7                      AS AMOUNT
                       ,TB_TEMP.VALUE8                      AS SC_RATE
                       ,TB_TEMP.VALUE9                      AS SERVICE_CHARGE
                       ,TB_TEMP.VALUE10                      AS TOT_AMOUNT
                       ,TB_TEMP.VALUE11                     AS BANK_NO
                       ,TB_TEMP.VALUE12                     AS AC_BRANCH
                       ,TB_TEMP.VALUE13                     AS AC_CODE
                       ,TB_TEMP.VALUE14                     AS AC_DAY
                       ,TB_TEMP.VALUE15                     AS RAISE_ROI
                       ,TB_TEMP.VALUE16                     AS RAISE_AMOUNT
                       ,TB_TEMP.VALUE17                     AS REDUCE_ROI
                       ,TB_TEMP.VALUE18                     AS REDUCE_AMOUNT
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSHPOLAIT3))) TB_TEMP
                  LEFT JOIN FAS.FUND FUND_FUND_NO
                    ON FUND_FUND_NO.FUND_NO = TB_TEMP.VALUE4
                  LEFT JOIN FAS.FUND FUND_ISIN_CODE
                    ON FUND_ISIN_CODE.FUND_NO = TB_TEMP.VALUE3
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    -- 2018.09.21 ChengYu 增加步驟4做檢查、步驟1拿掉傳入參數 交易幣別
    ELSIF WSTEP_TYPE = '4' THEN
      BEGIN
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                 ACCOUNT_NO
                ,TX_TYPE
                ,AMC_NO
                ,KYC_RISK_LEVEL
                ,IS_WRITE_KYC
                ,FUND_NO
                ,TRADE_CRNCY
                ,TX_DATE
                ,AMOUNT
                ,SC_RATE
                ,SERVICE_CHARGE
                ,TOT_AMOUNT
                ,BANK_NO
                ,AC_CODE
                ,RAISE_ROI
                ,RAISE_AMOUNT
                ,REDUCE_ROI
                ,REDUCE_AMOUNT
                ,STEP_TYPE
                ,IS_ROBO
                -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                ,FEE_CHOICE
                ,PROJECT_CODE
                ,COUPON_ID
                ,USED_POINT
                -- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
                ,IS_INVEST_RISK
             )
        SELECT  WACCOUNT_NO                  AS ACCOUNT_NO
               ,TB_DATA.SHOP_TYPE            AS TX_TYPE
               ,TB_DATA.AMC_NO               AS AMC_NO
               -- 2018.11.14 ChegnYu 步驟1新增傳入參數 TX_DATE、調整受益人風險等級判斷
               -- 2018.11.15 ChengYu 修正KYC檢核用的日期格式(只要日期)
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     WHEN HOLDER.RISK_STATUS = '2' THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     ELSE HOLDER.RISK_LEVEL
                END AS KYC_RISK_LEVEL
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '2' THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     ELSE ''
                END AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO              AS FUND_NO
               ,TB_DATA.TRADE_CRNCY          AS TRADE_CRNCY
               ,TB_DATA.TX_DATE              AS TX_DATE
               ,TB_DATA.AMOUNT               AS AMOUNT
               ,TB_DATA.SC_RATE              AS SC_RATE
               ,TB_DATA.SERVICE_CHARGE       AS SERVICE_CHARGE
               ,TB_DATA.TOT_AMOUNT           AS TOT_AMOUNT
               ,TB_DATA.BANK_NO              AS BANK_NO
               ,TB_DATA.AC_CODE              AS AC_CODE
               ,TB_DATA.RAISE_ROI            AS RAISE_ROI
               ,TB_DATA.RAISE_AMOUNT         AS RAISE_AMOUNT
               ,TB_DATA.REDUCE_ROI           AS REDUCE_ROI
               ,TB_DATA.REDUCE_AMOUNT        AS REDUCE_AMOUNT
               ,'4'                          AS STEP_TYPE
               -- 2018.09.28 ChengYu 增加ROBO判斷
               -- 2018.10.05 ChengYu ROBO契約書號沒傳入時 IS_ROBO 為 N
               ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NOT NULL THEN 'Y'
                     ELSE 'N'
                END                          AS IS_ROBO
               -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
               ,TB_DATA.FEE_CHOICE           AS FEE_CHOICE
               ,TB_DATA.PROJECT_CODE         AS PROJECT_CODE
               ,TB_DATA.COUPON_ID            AS COUPON_ID
               ,TB_DATA.USED_POINT           AS USED_POINT
               -- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
               ,TB_DATA.IS_INVEST_RISK       AS IS_INVEST_RISK
          FROM (SELECT  TB_TEMP.VALUE1                      AS SHOP_TYPE
                       ,TB_TEMP.VALUE2                      AS AMC_NO
                       ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                             WHEN FUND_ISIN_CODE.FUND_NO IS NOT NULL THEN FUND_ISIN_CODE.FUND_NO
                             WHEN TB_TEMP.VALUE4 IS NOT NULL THEN TB_TEMP.VALUE4
                             WHEN TB_TEMP.VALUE3 IS NOT NULL THEN TB_TEMP.VALUE3
                             ELSE ''
                        END AS FUND_NO
                       ,TO_DATE(TB_TEMP.VALUE5,'YYYYMMDD')  AS TX_DATE
                       ,TB_TEMP.VALUE6                      AS TRADE_CRNCY
                       ,TB_TEMP.VALUE7                      AS AMOUNT
                       ,TB_TEMP.VALUE8                      AS SC_RATE
                       ,TB_TEMP.VALUE9                      AS SERVICE_CHARGE
                       ,TB_TEMP.VALUE10                      AS TOT_AMOUNT
                       ,TB_TEMP.VALUE11                     AS BANK_NO
                       ,TB_TEMP.VALUE12                     AS AC_BRANCH
                       ,TB_TEMP.VALUE13                     AS AC_CODE
                       ,TB_TEMP.VALUE14                     AS AC_DAY
                       ,TB_TEMP.VALUE15                     AS RAISE_ROI
                       ,TB_TEMP.VALUE16                     AS RAISE_AMOUNT
                       ,TB_TEMP.VALUE17                     AS REDUCE_ROI
                       ,TB_TEMP.VALUE18                     AS REDUCE_AMOUNT
                       ,TB_TEMP.VALUE19                     AS ROBO_CONTRACT_NO
                       -- 2018.10.04 ChengYu 步驟2、4 增加傳入參數 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                       ,TB_TEMP.VALUE20                     AS FEE_CHOICE
                       ,TB_TEMP.VALUE21                     AS PROJECT_CODE
                       ,TB_TEMP.VALUE22                     AS COUPON_ID
                       ,TB_TEMP.VALUE23                     AS USED_POINT
                       -- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
                       ,TB_TEMP.VALUE24                     AS IS_INVEST_RISK
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSHPOLAIT4))) TB_TEMP
                  LEFT JOIN FAS.FUND FUND_FUND_NO
                    ON FUND_FUND_NO.FUND_NO = TB_TEMP.VALUE4
                  LEFT JOIN FAS.FUND FUND_ISIN_CODE
                    ON FUND_ISIN_CODE.FUND_NO = TB_TEMP.VALUE3
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    END IF;

    OPEN OUTDT FOR
    SELECT 'Y' AS IS_SUCCESS
      FROM DUAL;

END ;

/

  GRANT EXECUTE ON "ECS"."S_CHECKALLOTFUNDDATA_INSERT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKBANKLENGTH
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKBANKLENGTH" 
(
    WBANK_NO       VARCHAR2,                        -- 銀行總行代碼
    WAC_CODE       VARCHAR2,                        -- 約定帳號
    WAC_TYPE       VARCHAR2,                        -- 帳號類別
    OUTDT          OUT SYS_REFCURSOR                -- 回傳的 TABLEDATA
) IS

--傳出變數
XIS_SUCCESS VARCHAR2(1);
XWARNS_TYPE VARCHAR2(1);
XERROR_MSG  VARCHAR2(250);

--變數
XAC_LENGTH  INTEGER;

BEGIN

  BEGIN
  SELECT FIS_BANK.AC_LENGTH                         -- 帳號長度
    INTO XAC_LENGTH
    FROM FAS.FIS_BANK FIS_BANK
   WHERE FIS_BANK.BANK_NO = WBANK_NO;

   -- 2018.05.08 ChengYu 新增找不到 帳號長度 錯誤訊息
   EXCEPTION
      WHEN NO_DATA_FOUND THEN
         XIS_SUCCESS := 'N';
         XWARNS_TYPE := '3';
         XERROR_MSG :=  '無法取得帳號長度，請檢查！';
  END;

  -- 2018.05.08 ChengYu 新增找不到 帳號長度 錯誤訊息
  IF XIS_SUCCESS IS NULL THEN 

    IF XAC_LENGTH = LENGTH(WAC_CODE) THEN

      XIS_SUCCESS := 'Y';
      XWARNS_TYPE := '';
      XERROR_MSG  := '';

    ELSE

      XIS_SUCCESS := 'N';
      IF WAC_TYPE = '1' THEN

        SELECT MSGTYPE, MSGCONTENT
          INTO XWARNS_TYPE, XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'A001';

        XERROR_MSG := REPLACE(XERROR_MSG,'{AC_LENGTH}',XAC_LENGTH);

      ELSIF WAC_TYPE = '2' THEN

        SELECT MSGTYPE, MSGCONTENT
          INTO XWARNS_TYPE, XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'A002';

        XERROR_MSG := REPLACE(XERROR_MSG,'{AC_LENGTH}',XAC_LENGTH);

      ELSIF WAC_TYPE = '3' THEN

        SELECT MSGTYPE, MSGCONTENT
          INTO XWARNS_TYPE, XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'A003';

        XERROR_MSG := REPLACE(XERROR_MSG,'{AC_LENGTH}',XAC_LENGTH);

      END IF;
    END IF;
  END IF ;

OPEN OUTDT FOR
    SELECT XIS_SUCCESS AS IS_SUCCESS
           ,XWARNS_TYPE AS WARNS_TYPE
           ,XERROR_MSG AS ERROR_MSG
           FROM DUAL;

END s_CheckBankLength;

/

  GRANT EXECUTE ON "ECS"."S_CHECKBANKLENGTH" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKBFDIVIDENDBANK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKBFDIVIDENDBANK" 
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WAMC_CRNCY             VARCHAR2,          -- 基金經理公司及申購幣別
     OUTDT                  OUT SYS_REFCURSOR  -- 配息帳號列表
) IS

XID VARCHAR2(10);          -- 受益人ID

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');
  END;

  OPEN OUTDT FOR
      -- 傳入幣別不為MMA、FCY 抓出符合傳入幣別的資料
      SELECT 	CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN 'Y'
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN 'Y'
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN 'Y'
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN 'Y'
                   ELSE 'N'
              END AS IS_DIVIDEND_PAY                  -- 有無約定配息付款方式
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   -- 2018.05.25 ChengYu 調整訊息種類、錯誤訊息 轉換成VARCHAR2的大小、更正程式邏輯
                   ELSE CAST(MSGINFO.MSGTYPE AS VARCHAR2(1))
              END AS WARNS_TYPE                       -- 警示方式
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   -- 2018.05.25 ChengYu 調整訊息種類、錯誤訊息 轉換成VARCHAR2的大小、更正程式邏輯
                   ELSE CAST(MSGINFO.MSGCONTENT AS VARCHAR2(500))
              END AS ERROR_MSG                        -- 錯誤訊息
              -- 2018.04.20 ChengYu 調整回傳值 IS_DIVIDEND_PAY(有無約定配息付款方式) 為Y時其他回傳值""、幣別條件位置 BEGIN
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   ELSE HOLDER_DIVIDEND_AMC.AMC_NO
              END AS AMC_NO                           -- 基金公司代碼
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   ELSE AMC.NAME
              END AS AMC_NAME                         -- 基金公司名稱
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   ELSE AMC_CRNCY.TRADE_CRNCY
              END AS CURRENCY_NO                      -- 申購幣別
             ,CASE WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 1 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 2 THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 3 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   WHEN HOLDER_DIVIDEND.ID IS NOT NULL AND HOLDER_DIVIDEND_AMC.PAY_TYPE = 4 AND HOLDER_DIVIDEND_BANK.ID IS NOT NULL THEN ''
                   ELSE AMC.DEPOSITORY_NO
              END AS DEPOSITORY_NO                    -- 帳戶保管平台代號
              -- 2018.04.20 ChengYu 調整回傳值 IS_DIVIDEND_PAY(有無約定配息付款方式) 為Y時其他回傳值""、幣別條件位置 END
        FROM FAS.HOLDER_DIVIDEND_AMC HOLDER_DIVIDEND_AMC
        -- 2018.04.18 ChengYu 調整傳入參數JOIN方式
        JOIN (SELECT  SUBSTR(LINE.STR,0,INSTR(LINE.STR,';',1,1)-1) AS AMC_NO                                             -- 基金公司代碼
                     ,SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,1)+1,LENGTH(LINE.STR)-INSTR(LINE.STR,';',1,1)) AS TRADE_CRNCY -- 申購幣別
                FROM (SELECT REGEXP_SUBSTR(WAMC_CRNCY,'[^,]+', 1, LEVEL) AS STR
                        FROM DUAL
                     CONNECT BY REGEXP_SUBSTR(WAMC_CRNCY, '[^,]+', 1, LEVEL) IS NOT NULL
                     )LINE
             )AMC_CRNCY                                         -- 字串切成Table
          ON HOLDER_DIVIDEND_AMC.AMC_NO = AMC_CRNCY.AMC_NO
        LEFT JOIN FAS.HOLDER_DIVIDEND HOLDER_DIVIDEND           -- 受益人配息設定
          ON HOLDER_DIVIDEND.ID = HOLDER_DIVIDEND_AMC.ID
        LEFT JOIN FAS.HOLDER_DIVIDEND_BANK HOLDER_DIVIDEND_BANK -- 受益人配息帳號
          ON HOLDER_DIVIDEND_BANK.ID = HOLDER_DIVIDEND_AMC.ID
         AND HOLDER_DIVIDEND_BANK.AMC_NO = HOLDER_DIVIDEND_AMC.AMC_NO
         -- 2018.04.20 ChengYu 調整回傳值 IS_DIVIDEND_PAY(有無約定配息付款方式) 為Y時其他回傳值""、幣別條件位置
         -- 2018.05.25 ChengYu 調整訊息種類、錯誤訊息 轉換成VARCHAR2的大小、更正程式邏輯
         AND (HOLDER_DIVIDEND_BANK.CURRENCY_NO = AMC_CRNCY.TRADE_CRNCY
          OR HOLDER_DIVIDEND_BANK.CURRENCY_NO = CASE WHEN AMC_CRNCY.TRADE_CRNCY = 'NTD' OR AMC_CRNCY.TRADE_CRNCY = 'MMA' THEN 'MMA'
                                                     WHEN AMC_CRNCY.TRADE_CRNCY != 'NTD' AND AMC_CRNCY.TRADE_CRNCY != 'MMA' THEN 'FCY'
                                                     ELSE ''
                                                END)
        LEFT JOIN FAS.AMC AMC         -- 基金公司名稱
          ON AMC.AMC_NO = HOLDER_DIVIDEND_AMC.AMC_NO
        LEFT JOIN ECS.MSGINFO MSGINFO -- 系統訊息資料檔
          ON MSGINFO.MSGID = 'SPC003'
       WHERE HOLDER_DIVIDEND_AMC.ID = XID;

END s_CheckBfDividendBank;

/

  GRANT EXECUTE ON "ECS"."S_CHECKBFDIVIDENDBANK" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKEMAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKEMAIL" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/09/04
-- Description: API023 Email驗證
-- =============================================
(
    WACCOUNT_NO     INTEGER,            --戶號
    WEMAIL          VARCHAR2,           --電子郵件信箱
    WIP_ADR         VARCHAR2,           --IP位址
    WSTEP_TYPE      VARCHAR2,           --交易步驟
    OUTDT           OUT SYS_REFCURSOR   --回傳資料
)
IS
    --變數
    XID             VARCHAR2(10);       --受益人ID
    XSYS_DTTM       DATE := SYSDATE;    --系統日期時間
    XCHECK          INTEGER;            --檢查EMAIL是否相同
    --傳出變數
    XIS_SUCCESS     VARCHAR2(1);
    XWARNS_TYPE     VARCHAR2(1);
    XERROR_MSG      VARCHAR2(250);
BEGIN

    BEGIN
        SELECT ID           --受益人ID
          INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    BEGIN

        SELECT COUNT(*)
               INTO
               XCHECK
          FROM FAS.HOLDER
         WHERE ID = XID
           AND EMAIL = WEMAIL;

        IF XCHECK = 0 THEN

            XIS_SUCCESS := 'N';
            --由於目前沒有這錯誤訊息，所以先寫死
            XWARNS_TYPE := '3';
            XERROR_MSG  := '輸入的電子郵件信箱不正確';

            /*
            SELECT MSGTYPE, MSGCONTENT
                  INTO XWARNS_TYPE, XERROR_MSG
                  FROM ECS.MSGINFO
                 WHERE MSGID = 'ROBO000';
            */

            GOTO TO_END;

        END IF;

    END;

    --更新受益人檔
    UPDATE FAS.HOLDER
       SET EMAIL_VALID = 'Y',
           LAST_MODIFIED = XSYS_DTTM
     WHERE ID = XID;

    --將舊資料?寫入受益人變更資料
    INSERT INTO FAS.HOLDER_CHANGE
    (
         ID
        ,TX_TYPE
        ,EMAIL
        ,NEW_EMAIL
        ,EMAIL_VALID
        ,NEW_EMAIL_VALID
        ,CREATED_BY
        ,CREATION_DATE
        ,REVISED_BY
        ,REVISION_DATE
        ,REVIEWED_BY
        ,REVIEW_DATE
        ,EMP_NO
        ,LAST_MODIFIED
        ,STATUS
    )
    SELECT HOLDER.ID
          ,'7' AS TX_TYPE
          ,HOLDER.EMAIL
          ,HOLDER.EMAIL AS NEW_EMAIL
          ,HOLDER.EMAIL_VALID
          ,'Y' AS NEW_EMAIL_VALID
          ,'ECS' AS CREATED_BY
          ,XSYS_DTTM AS CREATION_DATE
          ,'ECS' AS REVISED_BY
          ,XSYS_DTTM AS REVISION_DATE
          ,'ECS' AS REVIEWED_BY
          ,XSYS_DTTM AS REVIEW_DATE
          ,'ECS' AS EMP_NO
          ,XSYS_DTTM AS LAST_MODIFIED
          ,'R' AS STATUS
      FROM FAS.HOLDER
     WHERE ID = XID;

    XIS_SUCCESS := 'Y';
    XWARNS_TYPE := NULL;
    XERROR_MSG  := NULL;

    GOTO TO_END;

    <<TO_END>>
    OPEN OUTDT FOR
    SELECT XIS_SUCCESS AS IS_SUCCESS
          ,XWARNS_TYPE AS WARNS_TYPE
          ,XERROR_MSG AS ERROR_MSG
      FROM DUAL;

END s_CheckEmail;

/

  GRANT EXECUTE ON "ECS"."S_CHECKEMAIL" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKFORGETACCKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKFORGETACCKEY" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/08/28
-- Description: 驗證密碼有效性
-- 2018.09.04 JIANXIN MOD 驗證受益人是否正確
-- =============================================
(
     WID                    VARCHAR2              -- 登入帳號
    ,WBIRTH_DATE            Date                  -- 生日
    ,WSEND_FORGET_DATE      Date                  -- 寄發忘記密碼日期時間
    ,OUTDT                  OUT SYS_REFCURSOR     -- MASTER
) IS

XCNT INT; 

BEGIN

    -- 2018.09.04 JIANXIN MOD 驗證受益人是否正確
    SELECT COUNT(1)
      INTO XCNT
      FROM FAS.HOLDER
     WHERE ID = WID;


    OPEN OUTDT FOR
    SELECT CASE WHEN XCNT <> 1 THEN 'N' ELSE 'Y' END AS IS_SUCCESS                      -- 取得資料成功否
          ,CASE WHEN XCNT <> 1 THEN '3' ELSE '' END AS WARNS_TYPE                       -- 警示方式
          ,CASE WHEN XCNT <> 1 THEN '查無此受益人' ELSE '' END AS ERROR_MSG             -- 錯誤訊息
        FROM DUAL;


END s_CheckForgetAccKey;

/

  GRANT EXECUTE ON "ECS"."S_CHECKFORGETACCKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKFORGETUSERALIAS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKFORGETUSERALIAS" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2023/12/02
-- Description: 驗證使用者代碼有效性
-- =============================================
(
     WID                    VARCHAR2              -- 登入帳號
    ,WBIRTH_DATE            Date                  -- 生日
    ,WSEND_FORGET_DATE      Date                  -- 寄發忘記密碼日期時間
    ,OUTDT                  OUT SYS_REFCURSOR     -- MASTER
) IS

XCNT INT; 

BEGIN

    SELECT COUNT(1)
      INTO XCNT
      FROM FAS.HOLDER
     WHERE ID = WID;


    OPEN OUTDT FOR
    SELECT CASE WHEN XCNT <> 1 THEN 'N' ELSE 'Y' END AS IS_SUCCESS                      -- 取得資料成功否
          ,CASE WHEN XCNT <> 1 THEN '3' ELSE '' END AS WARNS_TYPE                       -- 警示方式
          ,CASE WHEN XCNT <> 1 THEN '查無此受益人' ELSE '' END AS ERROR_MSG             -- 錯誤訊息
        FROM DUAL;


END s_CheckForgetUserAlias;

/

  GRANT EXECUTE ON "ECS"."S_CHECKFORGETUSERALIAS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKLUMPEMPCHECK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKLUMPEMPCHECK" 
-- ============================================
-- Author:      YungLong
-- Create date: 2018/09/26
-- Description: 員工申購檢查
-- =============================================
(
    WACCOUNT_NO         INTEGER,        -- 受益人戶號
    WFUND_NO            VARCHAR2,       -- 基金代碼
    WISIN_CODE          VARCHAR2,       -- 國際證券代碼
    WROBO_CONTRACT_NO   VARCHAR2,       -- ROBO契約書號
    OUTDT           OUT SYS_REFCURSOR
) IS

BEGIN
    OPEN OUTDT FOR
        SELECT 'Y' AS IS_EMP_LUMP
            FROM DUAL;


END s_CheckLumpEmpCheck;

/

  GRANT EXECUTE ON "ECS"."S_CHECKLUMPEMPCHECK" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKREDEMDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKREDEMDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/07/02
-- Description: 檢查贖回交易資料
-- 2018.07.16 ChengYu 交易截止時限檢核 增加條件 EC 買回關帳時間(EC_RED_CUT_OFF) 大於 2000/1/1
-- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
-- 2018.09.03 ChegnYu 拿掉交易時限，改由C#做
-- 2018.09.13 ChengYu 回傳交易日其做檢核
-- 2018.09.27 ChengYu 全贖(可買回單位數 - 單位數 = 0)時，不檢查最低剩餘單位數
-- 2018.09.28 ChengYu 新增ROBO同意書檢核
-- 2018.10.01 ChengYu 增加ROBO可買回單位數檢核
-- 2018.10.03 JIANXIN Robo 單不檢查【投資人剩餘單位數不可小於最低剩餘單位數】與【該筆買回交易，已存在】
-- 2018.10.03 ChengYu 最低剩餘單位數、最低買回單位數 全贖時不檢查
-- 2018.10.03 JIANXIN Robo 不檢查 投資人買回單位數小於最低買回單位數
-- 2018.10.10 JIANXIN 調整ROBO 買回單位數檢核判斷
-- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核
-- 2018.11.19 ChengYu 修正最低贖回金額檢核效能
-- 2018.11.20 ChengYu 修正最低贖回金額檢核判斷
-- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
-- 2019.03.22 tingting 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
-- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
-- 2021.01.15 by Chengyu 修正當日贖回金額上限語法
-- =============================================
(
    WACCOUNT_NO     INTEGER,            --受益人戶號
    WIS_ROBO        VARCHAR2,           --IP是否為Robo單
    WIP_ADR         VARCHAR2,           --IP位址
    WSTEP_TYPE      VARCHAR2,           --交易步驟
    WREDEMLIST1     VARCHAR2,           --RedemList1 STEP 1 贖回列表
    WREDEMLIST2     VARCHAR2,           --RedemList2 STEP 2 贖回列表
    WREDEMLIST3     VARCHAR2,           --RedemList3 STEP 3 贖回列表
    OUTDT1          OUT SYS_REFCURSOR,  --錯誤列表(STEP 1)
    OUTDT2          OUT SYS_REFCURSOR,  --錯誤列表(STEP 2)
    OUTDT3          OUT SYS_REFCURSOR,  --錯誤列表(STEP 3)
    OUTDT4          OUT SYS_REFCURSOR   --總贖回單位數列表(STEP 2、STEP 3)
)
IS
    --變數
    XID               VARCHAR2(10);              --受益人ID
    -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
    XSYS_DTTM         DATE:= TRUNC(SYSDATE);     --系統日期時間
    XDATA_NUM         INTEGER;                   --資料筆數

    XSTR_FUND_NULL    VARCHAR2(4000);            --不存在基金主檔中的 基金代碼、國際證券代碼 的字串
BEGIN

    BEGIN
        SELECT ID           --受益人ID
          INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    --取資料筆數
    SELECT COUNT(1)
      INTO XDATA_NUM
      FROM (SELECT  REDEMLIST1.VALUE1 AS ISIN_CODE   -- 國際證券代碼
                   ,REDEMLIST1.VALUE2 AS FUND_NO     -- 基金代碼
             FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST1))
                  )REDEMLIST1
            WHERE WSTEP_TYPE = '1'
            UNION ALL
            SELECT  REDEMLIST2.VALUE2 AS ISIN_CODE          -- 國際證券代碼
                   ,REDEMLIST2.VALUE3 AS FUND_NO            -- 基金代碼
             FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                  )REDEMLIST2
            WHERE WSTEP_TYPE = '2'
            UNION ALL
            SELECT  REDEMLIST3.VALUE2 AS ISIN_CODE          -- 國際證券代碼
                   ,REDEMLIST3.VALUE3 AS FUND_NO            -- 基金代碼
             FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                  )REDEMLIST3
            WHERE WSTEP_TYPE = '3'
           )TB_DATA;

    --找出不存在基金主檔中的傳入參數
    FOR I IN 1..XDATA_NUM LOOP
    SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NULL AND FUND_ISIN_CODE.FUND_NO IS NULL THEN XSTR_FUND_NULL||TB_FUND.ISIN_CODE||';'||TB_FUND.FUND_NO||','
                ELSE XSTR_FUND_NULL
           END AS XSTR_FUND_NULL
      INTO XSTR_FUND_NULL
      FROM (SELECT  TB_DATA.FUND_NO
                   ,TB_DATA.ISIN_CODE
                   ,ROWNUM AS NUM
              FROM (SELECT  REDEMLIST1.VALUE1 AS ISIN_CODE   -- 國際證券代碼
                           ,REDEMLIST1.VALUE2 AS FUND_NO     -- 基金代碼
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST1))
                          )REDEMLIST1
                    -- 2019.03.22 tingting 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                    WHERE WSTEP_TYPE = '1'
                    UNION ALL
                    SELECT  REDEMLIST2.VALUE2 AS ISIN_CODE          -- 國際證券代碼
                           ,REDEMLIST2.VALUE3 AS FUND_NO            -- 基金代碼
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                          )REDEMLIST2
                    -- 2019.03.22 tingting 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                    WHERE WSTEP_TYPE = '2'
                    UNION ALL
                    SELECT  REDEMLIST3.VALUE2 AS ISIN_CODE          -- 國際證券代碼
                           ,REDEMLIST3.VALUE3 AS FUND_NO            -- 基金代碼
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                          )REDEMLIST3
                    -- 2019.03.22 tingting 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                    WHERE WSTEP_TYPE = '3'
                   )TB_DATA
           )TB_FUND
      LEFT JOIN FAS.FUND FUND_FUND_NO
        ON FUND_FUND_NO.FUND_NO = TB_FUND.FUND_NO
      LEFT JOIN FAS.FUND FUND_ISIN_CODE
        ON FUND_ISIN_CODE.ISIN_CODE = TB_FUND.ISIN_CODE
     WHERE TB_FUND.NUM = I;

    END LOOP;

    --如果有值回傳錯誤訊息
    IF XSTR_FUND_NULL IS NOT NULL THEN
      BEGIN
        RAISE_APPLICATION_ERROR(-20000, '基金代碼;國際證券代碼'|| SUBSTR(XSTR_FUND_NULL,1,LENGTH(XSTR_FUND_NULL)-1)||'不存在於基金主檔中');
      END;
    END IF;

    --回傳基金資料、錯誤列表(STEP 1)
    OPEN OUTDT1 FOR
    SELECT FUND.FUND_NO
           ,CASE WHEN FUND.IS_EC_REDEMPTION != 'Y' THEN CAST(MSGINFO_RED014.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS IS_EC_REDEMPTION_TYPE --基金上架檢核(TYPE)
           ,CASE WHEN FUND.IS_EC_REDEMPTION != 'Y' THEN CAST(REPLACE(MSGINFO_RED014.MSGCONTENT,'{FUND_NO}',FUND.FUND_NO) AS VARCHAR2(500))
                ELSE ''
            END AS IS_EC_REDEMPTION_MSG --基金上架檢核(MSG)
      FROM (SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                        ELSE FUND_ISIN_CODE.FUND_NO
                   END AS FUND_NO                                       -- 基金代碼
                   ,TO_NUMBER(REDEMLIST1.VALUE3) AS R_SHARES            -- 可買回單位數
              FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST1))
                   )REDEMLIST1
              LEFT JOIN FAS.FUND FUND_FUND_NO
                ON FUND_FUND_NO.FUND_NO = REDEMLIST1.VALUE2
              LEFT JOIN FAS.FUND FUND_ISIN_CODE
                ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST1.VALUE1
                -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '1'
           )TB_DATA
      LEFT JOIN FAS.FUND FUND                -- 基金主檔
        ON FUND.FUND_NO = TB_DATA.FUND_NO
      LEFT JOIN ECS.MSGINFO MSGINFO_RED014
        ON MSGINFO_RED014.MSGID = 'RED014';

    --錯誤列表(STEP 2)
    OPEN OUTDT2 FOR
    SELECT  TB_DATA.FUND_NO                                           -- 基金代碼
            -- 2018.09.13 ChengYu 回傳交易日其做檢核
           ,TB_DATA.TX_DATE                                           -- 交易日期
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGTYPE AS VARCHAR2(1))
                ELSE ''
            END AS APPLICATION_SHARE_0_TYPE   -- 買回單位數的小於等於零檢核(YTPE)
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGCONTENT AS VARCHAR2(500))
                ELSE ''
            END AS APPLICATION_SHARE_0_MSG   -- 買回單位數的小於等於零檢核(MSG)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 THEN CAST(MSGINFO_RED007.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_TYPE -- 買回單位數小數位數檢核(TYPE)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
                 THEN CAST(REPLACE(MSGINFO_RED007.MSGCONTENT,'{SHARE_DECIMAL}',FUND.SHARE_DECIMAL) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_MSG  -- 買回單位數小數位數檢核(MSG)
            -- 2018.10.03 ChengYu 最低剩餘單位數、最低買回單位數 全贖時不檢查 BEGIN
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(MSGINFO_RED008.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_TYPE    -- 最低買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(REPLACE(MSGINFO_RED008.MSGCONTENT,'{MIN_RED_SHARE}',FUND.MIN_RED_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_MSG     -- 最低買回單位數檢核(MSG)
           -- 2018.09.27 ChengYu 全贖(可買回單位數 - 單位數 = 0)時，不檢查最低剩餘單位數
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE
                 THEN CAST(MSGINFO_RED009.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS REMAIN_SHARES_TYPE            --  最低剩餘單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           -- 2018.09.27 ChengYu 全贖(可買回單位數 - 單位數 = 0)時，不檢查最低剩餘單位數
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE
                 THEN CAST(REPLACE(MSGINFO_RED009.MSGCONTENT,'{MIN_BAL_SHARE}',FUND.MIN_BAL_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS REMAIN_SHARES_MSG             --  最低剩餘單位數檢核(MSG)
           -- 2018.10.03 ChengYu 最低剩餘單位數、最低買回單位數 全贖時不檢查 END
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(MSGINFO_RED011.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_R_SHARES_TYPE     -- 不可大於可買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(REPLACE(MSGINFO_RED011.MSGCONTENT,'{R_SHARES}',TB_DATA.R_SHARES) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_R_SHARES_MSG      -- 不可大於可買回單位數檢核(MSG)
           ,CASE WHEN TB_DATA.R_SHARES <= 0 THEN CAST(MSGINFO_RED004.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS R_SHARES_0_TYPE               -- 可買回單位數的小於等於零檢核
           ,CASE WHEN TB_DATA.R_SHARES <= 0 THEN CAST(MSGINFO_RED004.MSGCONTENT AS VARCHAR2(500))
                ELSE ''
            END AS R_SHARES_0_MSG                -- 可買回單位數的小於等於零檢核
           -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核 BEGIN
           -- 2018.11.20 ChengYu 修正最低贖回金額檢核判斷
           ,CASE WHEN WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(MSGINFO_RED017.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_RED_AMOUNT_TYPE    --最低贖回金額檢核(TYPE)
           ,CASE WHEN  WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_RED017.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',TB_DATA.APPLICATION_SHARE),'{AMOUNT}',ROUND(TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0),FUND.AMT_DECIMAL)),'{MIN_RED_AMOUNT}',FUND.MIN_RED_AMOUNT) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_RED_AMOUNT_MSG     --最低贖回金額檢核(MSG)
           -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核 END
      FROM (SELECT  REDEMLIST2.VALUE1 AS FUND_CATEGORY      -- 境內外識別碼
                   ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                         ELSE FUND_ISIN_CODE.FUND_NO
                    END AS FUND_NO                                     -- 基金代碼
                   ,TO_DATE(REDEMLIST2.VALUE4,'YYYYMMDD') AS TX_DATE   -- 買回交易日期
                   ,TO_DATE(REDEMLIST2.VALUE5,'YYYYMMDD') AS AC_DATE   -- 買回計算淨值日期
                   ,TO_NUMBER(REDEMLIST2.VALUE6) AS APPLICATION_SHARE  -- 買回單位數
                   ,TO_NUMBER(REDEMLIST2.VALUE7) AS R_SHARES           -- 可買回單位數
                   ,REDEMLIST2.VALUE12 AS TX_CURRENCY_NO               -- 交易幣別
              FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                   )REDEMLIST2
              LEFT JOIN FAS.FUND FUND_FUND_NO     --以傳入基金代碼抓取基金代碼
                ON FUND_FUND_NO.FUND_NO = REDEMLIST2.VALUE3
              LEFT JOIN FAS.FUND FUND_ISIN_CODE   --以傳入國際證券代碼抓取基金代碼
                ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST2.VALUE2
                -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '2'
           )TB_DATA                   -- 對應 基金代碼 的傳入資料
      LEFT JOIN FAS.FUND FUND
        ON FUND.FUND_NO = TB_DATA.FUND_NO
      LEFT JOIN ECS.SYSTEM_PARAMETER
        ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS'
     -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核
     -- 2018.11.19 ChengYu 修正最低贖回金額檢核效能
     LEFT JOIN (SELECT A.FUND_NO,MAX(B.NAV_DATE) NAV_DATE
                  FROM (SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                                    ELSE FUND_ISIN_CODE.FUND_NO
                               END AS FUND_NO                                    -- 基金代碼
                              ,TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                        FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                             )REDEMLIST3
                        LEFT JOIN FAS.FUND FUND_FUND_NO    --以傳入基金代碼抓取基金代碼
                          ON FUND_FUND_NO.FUND_NO = REDEMLIST3.VALUE3
                        LEFT JOIN FAS.FUND FUND_ISIN_CODE  --以傳入國際證券代碼抓取基金代碼
                          ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST3.VALUE2
                          -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                       WHERE WSTEP_TYPE = '2')A
                  JOIN NAV.NAV B
                    ON B.FUND_NO = A.FUND_NO
                 WHERE B.TX_DATE <= A.TX_DATE
                 GROUP BY A.FUND_NO
               ) TB_NAV_DATE   -- 取淨值檔最大日期
       ON TB_NAV_DATE.FUND_NO = FUND.FUND_NO
     LEFT JOIN NAV.NAV TB_NAV
       ON TB_NAV.FUND_NO = FUND.FUND_NO
      AND TB_NAV.NAV_DATE = TB_NAV_DATE.NAV_DATE
      LEFT JOIN ECS.MSGINFO MSGINFO_RED004
        ON MSGINFO_RED004.MSGID = 'RED004'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED006
        ON MSGINFO_RED006.MSGID = 'RED006'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED007
        ON MSGINFO_RED007.MSGID = 'RED007'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED008
        ON MSGINFO_RED008.MSGID = 'RED008'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED009
        ON MSGINFO_RED009.MSGID = 'RED009'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED011
        ON MSGINFO_RED011.MSGID = 'RED011'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED017
       ON MSGINFO_RED017.MSGID = 'RED017';

     --錯誤列表(STEP 3)
    OPEN OUTDT3 FOR
    SELECT  TB_DATA.FUND_NO                                           -- 基金代碼
            -- 2018.09.13 ChengYu 回傳交易日其做檢核
           ,TB_DATA.TX_DATE                                           -- 交易日期
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGTYPE AS VARCHAR2(1))
                ELSE ''
            END AS APPLICATION_SHARE_0_TYPE   -- 買回單位數的小於等於零檢核(YTPE)
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGCONTENT AS VARCHAR2(500))
                ELSE ''
            END AS APPLICATION_SHARE_0_MSG   -- 買回單位數的小於等於零檢核(MSG)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 THEN CAST(MSGINFO_RED007.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_TYPE -- 買回單位數小數位數檢核(TYPE)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
                 THEN CAST(REPLACE(MSGINFO_RED007.MSGCONTENT,'{SHARE_DECIMAL}',FUND.SHARE_DECIMAL) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_MSG  -- 買回單位數小數位數檢核(MSG)
            -- 2018.10.03 ChengYu 最低剩餘單位數、最低買回單位數 全贖時不檢查 BEGIN
            -- 2018.10.03 JIANXIN Robo 不檢查 投資人買回單位數小於最低買回單位數
           ,CASE WHEN ROBO_CONTRACT_NO IS NULL AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(MSGINFO_RED008.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_TYPE    -- 最低買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           -- 2018.10.03 JIANXIN Robo 不檢查 投資人買回單位數小於最低買回單位數
           ,CASE WHEN ROBO_CONTRACT_NO IS NULL AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(REPLACE(MSGINFO_RED008.MSGCONTENT,'{MIN_RED_SHARE}',FUND.MIN_RED_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_MSG     -- 最低買回單位數檢核(MSG)
           -- 2018.10.03 JIANXIN Robo 單不檢查【投資人剩餘單位數不可小於最低剩餘單位數】
           ,CASE WHEN ROBO_CONTRACT_NO IS NULL AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE THEN CAST(MSGINFO_RED009.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS REMAIN_SHARES_TYPE            --  最低剩餘單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           -- 2018.10.03 JIANXIN Robo 單不檢查【投資人剩餘單位數不可小於最低剩餘單位數】
           ,CASE WHEN ROBO_CONTRACT_NO IS NULL AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND  TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE THEN CAST(REPLACE(MSGINFO_RED009.MSGCONTENT,'{MIN_BAL_SHARE}',FUND.MIN_BAL_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS REMAIN_SHARES_MSG             --  最低剩餘單位數檢核(MSG)
           -- 2018.10.03 ChengYu 最低剩餘單位數、最低買回單位數 全贖時不檢查
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(MSGINFO_RED011.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_R_SHARES_TYPE     -- 不可大於可買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(REPLACE(MSGINFO_RED011.MSGCONTENT,'{R_SHARES}',TB_DATA.R_SHARES) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_R_SHARES_MSG      -- 不可大於可買回單位數檢核(MSG)
           ,CASE WHEN FUND.IS_EC_REDEMPTION != 'Y' THEN CAST(MSGINFO_RED014.MSGTYPE AS VARCHAR2(1))
                  ELSE ''
            END AS IS_EC_REDEMPTION_TYPE --基金上架檢核(TYPE)
           ,CASE WHEN FUND.IS_EC_REDEMPTION != 'Y' THEN CAST(REPLACE(MSGINFO_RED014.MSGCONTENT,'{FUND_NAME}',FUND.NAME) AS VARCHAR2(500))
                ELSE ''
            END AS IS_EC_REDEMPTION_MSG  --基金上架檢核(MSG)
            -- 2018.10.03 JIANXIN Robo 單不檢查【該筆買回交易，已存在】
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NULL AND REDEMPTION.FUND_NO IS NOT NULL THEN CAST(MSGINFO_RED013.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS REDEMPTION_EXIST_TYPE -- 是否存在於 EC買回 資料表中的檢核(TYPE)
            -- 2018.10.03 JIANXIN Robo 單不檢查【該筆買回交易，已存在】
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NULL AND REDEMPTION.FUND_NO IS NOT NULL THEN CAST(MSGINFO_RED013.MSGCONTENT AS VARCHAR2(500))
                 ELSE ''
            END AS REDEMPTION_EXIST_MSG  -- 是否存在於 EC買回 資料表中的檢核(MSG)
           -- 2018.09.28 ChengYu 新增ROBO同意書檢核 BEGIN
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NOT NULL AND HOLDER.ROBO_AGREEMENT = 'N' THEN CAST(MSGINFO_RED015.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS ROBO_AGREEMENT_TYPE   -- ROBO同意書 檢核(TYPE)
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NOT NULL AND HOLDER.ROBO_AGREEMENT = 'N' THEN CAST(MSGINFO_RED015.MSGCONTENT AS VARCHAR2(500))
                 ELSE ''
            END AS ROBO_AGREEMENT_MSG    -- ROBO同意書 檢核(MSG)
           -- 2018.09.28 ChengYu 新增ROBO同意書檢核 END
           -- 2018.10.01 ChengYu 增加ROBO可買回單位數檢核 BEGIN
           -- 2018.10.10 JIANXIN 調整ROBO 買回單位數檢核判斷
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NOT NULL AND TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES
                 THEN CAST(MSGINFO_RED016.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS ROBO_R_SHARES_TYPE    --ROBO可買回單位數檢核(TYPE)
           -- 2018.10.10 JIANXIN 調整ROBO 買回單位數檢核判斷
           ,CASE WHEN TB_DATA.ROBO_CONTRACT_NO IS NOT NULL AND TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES
                 THEN CAST(MSGINFO_RED016.MSGCONTENT AS VARCHAR2(500))
                 ELSE ''
            END AS ROBO_R_SHARES_MSG     --ROBO可買回單位數檢核(MSG)
           -- 2018.10.01 ChengYu 增加ROBO可買回單位數檢核 END
           -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核 BEGIN
           -- 2018.11.20 ChengYu 修正最低贖回金額檢核判斷
           ,CASE WHEN WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(MSGINFO_RED017.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_RED_AMOUNT_TYPE    --最低贖回金額檢核(TYPE)
           ,CASE WHEN WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_RED017.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',TB_DATA.APPLICATION_SHARE),'{AMOUNT}',ROUND(TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0),FUND.AMT_DECIMAL)),'{MIN_RED_AMOUNT}',FUND.MIN_RED_AMOUNT) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_RED_AMOUNT_MSG     --最低贖回金額檢核(MSG)
           -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核 END
           -- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
		         ,CASE WHEN WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND (TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) * NVL(TB_NAV.NAV,0) < FUND.MIN_BAL_AMOUNT
                 THEN CAST(MSGINFO_RED018.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_RED_BAL_AMOUNT_TYPE    --最低轉出剩餘金額檢核(TYPE)
		         ,CASE WHEN WIS_ROBO != 'Y' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND (TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) * NVL(TB_NAV.NAV,0) < FUND.MIN_BAL_AMOUNT
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_RED018.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',(TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) ),'{AMOUNT}',ROUND((TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE)  * NVL(TB_NAV.NAV,0),FUND.AMT_DECIMAL)),'{MIN_RED_AMOUNT}',FUND.MIN_BAL_AMOUNT) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_RED_BAL_AMOUNT_MSG     --最低轉出剩餘金額檢核(MSG)
     FROM (SELECT  REDEMLIST3.VALUE1 AS FUND_CATEGORY      -- 境內外識別碼
                  ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                        ELSE FUND_ISIN_CODE.FUND_NO
                   END AS FUND_NO                                     -- 基金代碼
                  ,TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                  ,TO_DATE(REDEMLIST3.VALUE5,'YYYYMMDD') AS AC_DATE  -- 買回計算淨值日期
                  ,TO_NUMBER(REDEMLIST3.VALUE6) AS APPLICATION_SHARE -- 買回單位數
                  ,TO_NUMBER(REDEMLIST3.VALUE7) AS R_SHARES          -- 可買回單位數
                  ,REDEMLIST3.VALUE8 AS BANK_NO                      -- 往來總行代碼
                  ,REDEMLIST3.VALUE9 AS BRANCH_NO                    -- 往來分行代碼
                  ,REDEMLIST3.VALUE10 AS AC_CODE                     -- 往來帳號
                  ,REDEMLIST3.VALUE11 AS CURRENCY_NO                 -- 往來帳戶幣別
                  ,REDEMLIST3.VALUE12 AS ROBO_CONTRACT_NO            -- ROBO契約書號
                  ,REDEMLIST3.VALUE13 AS TX_CURRENCY_NO              -- 交易幣別
            FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                 )REDEMLIST3
            LEFT JOIN FAS.FUND FUND_FUND_NO    --以傳入基金代碼抓取基金代碼
              ON FUND_FUND_NO.FUND_NO = REDEMLIST3.VALUE3
            LEFT JOIN FAS.FUND FUND_ISIN_CODE  --以傳入國際證券代碼抓取基金代碼
              ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST3.VALUE2
              -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
           WHERE WSTEP_TYPE = '3'
          )TB_DATA              -- 對應 基金代碼 的傳入資料
     LEFT JOIN FAS.FUND FUND
       ON FUND.FUND_NO = TB_DATA.FUND_NO
     LEFT JOIN FAS.HOLDER
       ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
     LEFT JOIN (SELECT DISTINCT REDEMPTION.FUND_NO
                  FROM ECS.REDEMPTION REDEMPTION
                  JOIN (SELECT  REDEMLIST3.VALUE1 AS FUND_CATEGORY      -- 境內外識別碼
                               ,CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                                     ELSE FUND_ISIN_CODE.FUND_NO
                                END AS FUND_NO                                    -- 基金代碼
                               ,TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                               ,TO_DATE(REDEMLIST3.VALUE5,'YYYYMMDD') AS AC_DATE  -- 買回計算淨值日期
                               ,TO_NUMBER(REDEMLIST3.VALUE6) AS APPLICATION_SHARE -- 買回單位數
                               ,TO_NUMBER(REDEMLIST3.VALUE7) AS R_SHARES          -- 可買回單位數
                               ,REDEMLIST3.VALUE8 AS BANK_NO                      -- 往來總行代碼
                               ,REDEMLIST3.VALUE9 AS BRANCH_NO                    -- 往來分行代碼
                               ,REDEMLIST3.VALUE10 AS AC_CODE                     -- 往來帳號
                               ,REDEMLIST3.VALUE11 AS CURRENCY_NO                 -- 往來帳戶幣別
                               ,REDEMLIST3.VALUE13 AS TX_CURRENCY_NO              -- 交易幣別
                         FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                              )REDEMLIST3
                         LEFT JOIN FAS.FUND FUND_FUND_NO    --以傳入基金代碼抓取基金代碼
                           ON FUND_FUND_NO.FUND_NO = REDEMLIST3.VALUE3
                         LEFT JOIN FAS.FUND FUND_ISIN_CODE  --以傳入國際證券代碼抓取基金代碼
                           ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST3.VALUE2
                           -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                        WHERE WSTEP_TYPE = '3'
                       )TB_DATA2
                    ON REDEMPTION.ID = XID
                   AND REDEMPTION.TX_DATE = TB_DATA2.TX_DATE
                   AND REDEMPTION.FUND_NO = TB_DATA2.FUND_NO
                   AND REDEMPTION.AC_BANK = TB_DATA2.BANK_NO
                   AND REDEMPTION.AC_BRANCH = TB_DATA2.BRANCH_NO
                   AND REDEMPTION.AC_CODE = TB_DATA2.AC_CODE
                   AND REDEMPTION.CURRENCY_NO = TB_DATA2.CURRENCY_NO
               ) REDEMPTION
       ON REDEMPTION.FUND_NO = TB_DATA.FUND_NO
     -- 2018.11.19 ChengYu 檢查是否低於最低贖回金額檢核
     -- 2018.11.19 ChengYu 修正最低贖回金額檢核效能
     LEFT JOIN (SELECT A.FUND_NO,MAX(B.NAV_DATE) NAV_DATE
                  FROM (SELECT CASE WHEN FUND_FUND_NO.FUND_NO IS NOT NULL THEN FUND_FUND_NO.FUND_NO
                                    ELSE FUND_ISIN_CODE.FUND_NO
                               END AS FUND_NO                                    -- 基金代碼
                              ,TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                        FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                             )REDEMLIST3
                        LEFT JOIN FAS.FUND FUND_FUND_NO    --以傳入基金代碼抓取基金代碼
                          ON FUND_FUND_NO.FUND_NO = REDEMLIST3.VALUE3
                        LEFT JOIN FAS.FUND FUND_ISIN_CODE  --以傳入國際證券代碼抓取基金代碼
                          ON FUND_ISIN_CODE.ISIN_CODE = REDEMLIST3.VALUE2
                          -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                       WHERE WSTEP_TYPE = '3')A
                  JOIN NAV.NAV B
                    ON B.FUND_NO = A.FUND_NO
                 WHERE B.TX_DATE <= A.TX_DATE
                 GROUP BY A.FUND_NO
               ) TB_NAV_DATE   -- 取淨值檔最大日期
       ON TB_NAV_DATE.FUND_NO = FUND.FUND_NO
     LEFT JOIN NAV.NAV TB_NAV
       ON TB_NAV.FUND_NO = FUND.FUND_NO
      AND TB_NAV.NAV_DATE = TB_NAV_DATE.NAV_DATE
     LEFT JOIN ECS.MSGINFO MSGINFO_RED006
       ON MSGINFO_RED006.MSGID = 'RED006'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED007
       ON MSGINFO_RED007.MSGID = 'RED007'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED008
       ON MSGINFO_RED008.MSGID = 'RED008'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED009
       ON MSGINFO_RED009.MSGID = 'RED009'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED011
       ON MSGINFO_RED011.MSGID = 'RED011'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED012
       ON MSGINFO_RED012.MSGID = 'RED012'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED013
       ON MSGINFO_RED013.MSGID = 'RED013'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED014
       ON MSGINFO_RED014.MSGID = 'RED014'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED015
       ON MSGINFO_RED015.MSGID = 'RED015'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED016
       ON MSGINFO_RED016.MSGID = 'RED016'
     LEFT JOIN ECS.MSGINFO MSGINFO_RED017
       ON MSGINFO_RED017.MSGID = 'RED017'
    -- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
     LEFT JOIN ECS.MSGINFO MSGINFO_RED018
       ON MSGINFO_RED018.MSGID = 'RED018'
     LEFT JOIN ECS.SYSTEM_PARAMETER
       ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS';

   -- 2021.01.15 by Chengyu 修正當日贖回金額上限語法
   OPEN OUTDT4 FOR
   SELECT  TB_DATA.ID
          ,FUND.FUND_CATEGORY
          ,TB_DATA.FUND_NO
          ,TB_DATA.TX_DATE
          ,SUM(TB_DATA.APPLICATION_SHARE) AS SUM_APPLICATION_SHARE
          ,SYSTEM_PARAMETER.ON_RED_AMOUNT_LIMIT         --境內同客戶同交易日總轉出金額上限
          ,SYSTEM_PARAMETER.OFF_RED_AMOUNT_LIMIT        --境外同客戶同交易日總轉出金額上限
     FROM (
           SELECT  REDEMPTION.ID
                  ,REDEMPTION.FUND_NO
                  ,REDEMPTION.TX_DATE
                  ,APPLICATION_SHARE
             FROM ECS.REDEMPTION
             LEFT JOIN FAS.HOLDER
               ON HOLDER.ID = REDEMPTION.ID
             JOIN (
                   SELECT  TO_DATE(REDEMLIST2.VALUE4,'YYYYMMDD') AS TX_DATE   -- 買回交易日期
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                          )REDEMLIST2
                    WHERE WSTEP_TYPE = '2'
                   UNION
                   SELECT TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                    FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                         )REDEMLIST3
                   WHERE WSTEP_TYPE = '3'
                  ) FUND_OUT_DATA
               ON REDEMPTION.TX_DATE = TRUNC(FUND_OUT_DATA.TX_DATE)             
            WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO
              AND REDEMPTION.BROKER_NO = '999'
              AND REDEMPTION.BRANCH_NO = '8000'
              AND WSTEP_TYPE IN ('2','3')
            UNION ALL
           SELECT HOLDER.ID
                  ,TB_DATA.FUND_NO
                  ,TB_DATA.TX_DATE
                  ,APPLICATION_SHARE AS APPLICATION_SHARE
             FROM (SELECT  REDEMLIST2.VALUE1 AS FUND_CATEGORY      -- 境內外識別碼
                           ,FUND.FUND_NO                           -- 基金代碼
                           ,TO_DATE(REDEMLIST2.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                           ,TO_NUMBER(REDEMLIST2.VALUE6) AS APPLICATION_SHARE -- 買回單位數
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST2))
                          )REDEMLIST2
                     LEFT JOIN FAS.FUND FUND    --以傳入基金代碼抓取基金代碼
                       ON (FUND.FUND_NO = REDEMLIST2.VALUE3 OR FUND.ISIN_CODE = REDEMLIST2.VALUE2)
                    WHERE WSTEP_TYPE = '2'
                    UNION
                   SELECT  REDEMLIST3.VALUE1 AS FUND_CATEGORY      -- 境內外識別碼
                           ,FUND.FUND_NO                           -- 基金代碼
                           ,TO_DATE(REDEMLIST3.VALUE4,'YYYYMMDD') AS TX_DATE  -- 交易日期
                           ,TO_NUMBER(REDEMLIST3.VALUE6) AS APPLICATION_SHARE -- 買回單位數
                     FROM (TABLE(ECS.F_FormatStringListToTable(WREDEMLIST3))
                          )REDEMLIST3
                     LEFT JOIN FAS.FUND FUND    --以傳入基金代碼抓取基金代碼
                       ON (FUND.FUND_NO = REDEMLIST3.VALUE3 OR FUND.ISIN_CODE = REDEMLIST3.VALUE2)
                    WHERE WSTEP_TYPE = '3'
                   )TB_DATA
              LEFT JOIN FAS.HOLDER
                ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
          ) TB_DATA   
     JOIN FAS.FUND 
       ON FUND.FUND_NO = TB_DATA.FUND_NO
     JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER
       ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS'
    GROUP BY TB_DATA.ID,FUND.FUND_CATEGORY,TB_DATA.FUND_NO,TB_DATA.TX_DATE
          ,SYSTEM_PARAMETER.ON_RED_AMOUNT_LIMIT
          ,SYSTEM_PARAMETER.OFF_RED_AMOUNT_LIMIT;

END s_CheckRedemData;

/

  GRANT EXECUTE ON "ECS"."S_CHECKREDEMDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKREDEMEMPCHECK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKREDEMEMPCHECK" 
-- ============================================
-- Author:      YungLong
-- Create date: 2018/09/26
-- Description: 取得當天網路贖回總金額/總單位數
-- ============================================
(
    WACCOUNT_NO         INTEGER,        -- 受益人戶號
    WFUND_NO            VARCHAR2,       -- 基金代碼
    WISIN_CODE          VARCHAR2,       -- 國際證券代碼
    WTX_CURRENCY_NO     VARCHAR2,       -- 申購幣別
    WROBO_CONTRACT_NO   VARCHAR2,       -- ROBO契約書號
    OUTDT           OUT SYS_REFCURSOR
) IS
BEGIN
    OPEN OUTDT FOR
        SELECT 'Y' AS IS_EMP_REDEM
            FROM DUAL;

END s_CheckRedemEmpCheck;

/

  GRANT EXECUTE ON "ECS"."S_CHECKREDEMEMPCHECK" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKROBOTXVERKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKROBOTXVERKEY" 
(
    WROBO_CONTRACT_NO         VARCHAR2,                    -- Robo契約書號
    WTOKEN_ID                 VARCHAR2,                    -- Token Id
    OUTDT                     OUT SYS_REFCURSOR            -- 回傳的 TABLEDATA
) IS

XIS_SUCCESS   VARCHAR2(1);    --取得資料成功否
XWARNS_TYPE   VARCHAR2(1);    --警示方式
-- 2019.11.18 ChengYu 不接受ROBO交易單、調整錯誤訊息長度
XERROR_MSG    VARCHAR2(500);  --錯誤訊息
XCHECK        INTEGER;        --檢查是否有資料存在

BEGIN

  --將傳入參數『Robo契約書號(@ROBO_CONTRACT_NO)』、『Token Id (@TOKEN_ID)』傳入至【Robo 密碼驗證檔(ECS.ROBO_PWD)】進行密碼驗證
  SELECT COUNT(*)
   INTO XCHECK
   FROM ECS.ROBO_PWD
  WHERE ROBO_CONTRACT_NO = WROBO_CONTRACT_NO
    AND TOKEN_ID = WTOKEN_ID;


  -- 2019.11.18 ChengYu 不接受ROBO交易單、調整錯誤訊息長度
    XIS_SUCCESS := 'N';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'ROB010';

  /*
  --驗證成功  
  IF XCHECK > 0 THEN    

    XIS_SUCCESS := 'Y';
    XWARNS_TYPE := '';
    XERROR_MSG  := ''; 

  --驗證失敗
  ELSE

    XIS_SUCCESS := 'N';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'ROB003';

  END IF;
  */

  OPEN OUTDT FOR
       SELECT XIS_SUCCESS   AS IS_SUCCESS
              ,XWARNS_TYPE  AS WARNS_TYPE
              ,XERROR_MSG   AS ERROR_MSG 
         FROM DUAL;

END s_CheckRoboTxVerKey;

/

  GRANT EXECUTE ON "ECS"."S_CHECKROBOTXVERKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKRSPCHGDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKRSPCHGDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/07/02
-- Description: 檢查定額異動交易資料
-- 2018.07.13 ChengYu 新增檢核 傳入參數[基金代碼] 是否存在於基金主檔
-- 2018.07.18 ChengYu 調整客戶風險屬性檢核(客戶 < 基金 出現訊息)
-- 2018.08.09 ChengYu 調整小數位數檢核 原本以基金抓取更正為交易幣別抓取小數位數
-- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
-- 2018.08.23 ChengYu 拿掉加碼點、減碼點檢核(已在Request檢核)
-- 2018.08.24 ChengYu 錯誤訊息補上比較值
-- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
-- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
-- 2018.10.17 tingting 增加書面定額異動檢核(原本只有網路定額異動檢核)
-- 2018.11.01 tingting 修正網路定額 JOIN FAS.HOLDER_BANK_EC 少條件的錯誤
-- 2018.11.14 tingting 1.調整書面定額上限檢核，不用看印核日期，直接判斷是否超過SYSTEM_PARAMETER的AMOUNT1
--                     2.調整暫停扣款不做錯誤檢核
-- 2018.11.15 ChengYu 檢查上限時要含手續費
-- 2018.11.16 tingting 增加加碼金額、減碼金額檢核
-- 2018.11.21 tingting 調整定期不定額才做加減碼金額與基準扣款金額的檢核
-- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
-- 2018.11.29 tingting 書面定額增加帳務處理中檢核
-- 2018.12.06 tingting 調整書面定額帳務處理中檢核
-- 2018.12.10 tingting 增加停止扣款警告訊息
-- 2018.12.11 JIANXIN 增加弱勢族群的判斷
-- 2018.12.18 JIANXIN 移除扣款銀行帳號是否存在的檢查
-- 2019.01.04 JIANXIN 移除書面定額舊契約帳務處理中的判別
-- 2019.01.04 tingting 調整停止扣款若不等於指定活動專案代碼才出警告訊息
-- 2019.01.18 JIANXIN MOD BY 專案代碼移除訊息，書面定額無須檢查
-- 2019.02.21 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限 
-- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
-- 2019.04.08 JIANXIN 新增針對特殊基金，不可復扣與提升扣款金額
-- 2019.04.25 JIANXIN 因應弱勢族群調整串接判斷
-- 2019.05.17 JIANXIN 增加AML狀態=Read Only，則不得提高扣款金額、恢復扣款
-- 2020.05.12 Chengyu 新增書面定額暫停扣款帳務處理中檢核
-- 2020.05.27 Chengyu 修正書面定額暫停扣款帳務處理中檢核
-- 2022.05.13 JIANXIN 移除AML錯誤判斷
-- 2022.05.17 JIANXIN 新增AML 狀態 = D，皆不可進行異動
-- 2022.07.30 JIANXIN 調整弱勢族群由70歲調整為65歲
-- 2022.09.14 JIANXIN 調整訊息文字內容
-- 2022.11.29 JIANXIN 若為弱勢投資人時，，則不得提高扣款金額、恢復扣款
-- 2022.11.30 JIANXIN 移除弱勢投資人的判斷
-- 2022.11.30 JIANXIN 若為弱勢投資人時，且該基金為RR5時，只能降低扣款金額，且不可以復扣，RR1-RR4 都可以執行不做檢查
-- 2022.12.02 JIANXIN KYC Level 需對應
-- 2023.03.13 JIANXIN 若是弱勢族群，則必須滿足以下條件，否則出現錯誤訊息
-- 2023.03.24 JIANXIN 針對弱勢族群自主聲明同意與不同意進行不同情境處理
-- 2023.03.27 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
-- 2025.02.05 RICHARD 針對暫調銷售基金(FAS.FUND.SALES_TYPE = '1') , 須於客戶停扣前提醒客戶
-- =============================================
(
    WACCOUNT_NO         INTEGER,            --受益人戶號
    WID_SEQ             VARCHAR2,           --契約序號
    WIP_ADR             VARCHAR2,           --IP位址
    WCHECK_TYPE         VARCHAR2,           --檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
    WSTEP_TYPE          VARCHAR2,           --交易步驟  0：STEP 0；1：STEP 1；2：STEP 2
    WIS_WRITE_KYC       VARCHAR2,           --是否需重填投資適性分析表(Y/N)(呼叫API068：GetBFKYC取得傳入)
    WKYC_RISK_LEVEL     INTEGER,            --KYC風險等級
    WRSPLIST0           VARCHAR2,           --RspList0 STEP 0 RSP契約列表 (契約型態;基金代碼)
    WRSPLIST1           VARCHAR2,           --RspList1 STEP 1 RSP契約列表 (契約來源;契約序號;基金代碼;申購幣別;每月扣款日;扣款金額;加碼點(%);加碼金額;減碼點(%);減碼金額;優惠方案;促銷活動代碼;優惠券代碼)
    WRSPLIST2           VARCHAR2,           --RspList2 STEP 2 RSP契約列表 (契約來源;契約序號;基金代碼;申購幣別;每月扣款日;扣款金額;加碼點(%);加碼金額;減碼點(%);減碼金額;優惠方案;促銷活動代碼;優惠券代碼)
    -- 2019.01.04 tingting 調整停止扣款若不等於指定活動專案代碼才出警告訊息
    WPROJECT_CODE_LIST  VARCHAR2,           --指定促銷活動代碼(讀config設定)
    OUTDT0              OUT SYS_REFCURSOR,  --STEP 0 RSP契約列表
    OUTDT1              OUT SYS_REFCURSOR,  --STEP 1 RSP契約列表
    OUTDT2              OUT SYS_REFCURSOR,  --STEP 2 RSP契約列表
    OUTDT3              OUT SYS_REFCURSOR   --RSP 錯誤列表
)
IS
    --變數
    XID                 VARCHAR2(10);           --受益人ID
    XFUND_COUNT         INTEGER;                --基金筆數
    XSYS_DTTM           DATE := TRUNC(SYSDATE); --系統日(不含時分秒)
    --檢核用
    XSTR_FUND_NULL      VARCHAR2(4000);         --不存在於 基金主檔 的傳入參數[基金代碼] 字串
    XVULNERABLE_GROUP   VARCHAR2(1):='N';            --是否為弱勢族群
    -- 2019.05.17 JIANXIN 增加AML狀態=Read Only，則不得提高扣款金額、恢復扣款
    XAML_STATUS         VARCHAR2(1);            --AML 帳戶狀態\D:Dormant：無法進行所有交易、R:Redeem Only：客戶僅能買回，無法進行新申購、A:Active：正常交易
BEGIN

    BEGIN
        SELECT ID           --受益人ID
               -- 2019.05.17 JIANXIN 增加AML狀態=Read Only，則不得提高扣款金額、恢復扣款
               ,AML_STATUS
          INTO XID 
               -- 2019.05.17 JIANXIN 增加AML狀態=Read Only，則不得提高扣款金額、恢復扣款
               ,XAML_STATUS
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    -- 2018.07.13 ChengYu 新增檢核 傳入參數[基金代碼] 是否存在於基金主檔 BEGIN
    --取資料筆數
    SELECT COUNT(1)
      INTO XFUND_COUNT
      FROM (SELECT WRSPLIST0.VALUE2 AS FUND_NO     -- 基金代碼
              FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST0)) WRSPLIST0
              -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '0'
            UNION
            SELECT WRSPLIST1.VALUE3 AS FUND_NO     -- 基金代碼
              FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) WRSPLIST1
              -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '1'
            UNION
            SELECT WRSPLIST2.VALUE3 AS FUND_NO     -- 基金代碼
              FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) WRSPLIST2
              -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '2'
           ) TB_DATA;

    --找出不存在基金主檔中的 傳入參數[基金代碼]
    FOR I IN 1..XFUND_COUNT LOOP

    SELECT CASE WHEN FUND.FUND_NO IS NULL THEN XSTR_FUND_NULL || TB_FUND.FUND_NO || ','
                ELSE XSTR_FUND_NULL
                END AS XSTR_FUND_NULL
      INTO XSTR_FUND_NULL
      FROM (SELECT  TB_DATA.FUND_NO
                   ,ROWNUM AS NUM
              FROM (SELECT WRSPLIST0.VALUE2 AS FUND_NO     -- 基金代碼
                      FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST0)) WRSPLIST0
                      -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                     WHERE WSTEP_TYPE = '0'					                
                    UNION
                    SELECT WRSPLIST1.VALUE3 AS FUND_NO     -- 基金代碼
                      FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) WRSPLIST1
                      -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                     WHERE WSTEP_TYPE = '1'					  
                    UNION
                    SELECT WRSPLIST2.VALUE3 AS FUND_NO     -- 基金代碼
                      FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) WRSPLIST2
                      -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                     WHERE WSTEP_TYPE = '2'					  
                   ) TB_DATA
           ) TB_FUND
      LEFT JOIN FAS.FUND FUND
        ON FUND.FUND_NO = TB_FUND.FUND_NO
     WHERE TB_FUND.NUM = I;

    END LOOP;

    --如果有值回傳錯誤訊息
    IF XSTR_FUND_NULL IS NOT NULL THEN
    BEGIN
        RAISE_APPLICATION_ERROR(-20000, '基金代碼' || SUBSTR(XSTR_FUND_NULL,1,LENGTH(XSTR_FUND_NULL)-1) || '不存在於基金主檔中');
    END;
    END IF;
    -- 2018.07.13 ChengYu 新增檢核 傳入參數[基金代碼] 是否存在於基金主檔 END

   --STEP 0 RSP契約列表
   OPEN OUTDT0 FOR
   SELECT  TB_DATA.RSP_TYPE                 -- 契約型態
          ,FUND.FUND_NO                     -- 基金代碼
          ,CASE WHEN TB_DATA.RSP_TYPE = '1' THEN FUND.EC_RSP_UPDATE ELSE FUND.EC_DRSP_UPDATE END AS IS_UPDATE   --是否開放(不)定額變更
     FROM (SELECT  TB_WRSPLIST0.VALUE1 AS RSP_TYPE              -- 契約型態
                  ,TB_WRSPLIST0.VALUE2 AS FUND_NO               -- 基金代碼
             FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST0)) TB_WRSPLIST0
             -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
            WHERE WSTEP_TYPE = '0'
          ) TB_DATA
     LEFT JOIN FAS.FUND FUND
       ON FUND.FUND_NO = TB_DATA.FUND_NO;

   --STEP 1 RSP契約列表
   OPEN OUTDT1 FOR
   SELECT  TB_DATA.RSP_SOURCE AS RSP_SOURCE                     -- 契約來源
          ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN '臨櫃' 
                                   WHEN '2' THEN '網路' 
                                   ELSE ''
                                   END AS RSP_SOURCE_NAME       -- 契約來源名稱
          ,TB_DATA.ID_SEQ                                       -- 契約序號
          ,WIS_WRITE_KYC AS IS_WRITE_KYC                        -- 需重填投資適性分析表
     FROM (SELECT  TB_WRSPLIST1.VALUE1 AS RSP_SOURCE            -- 契約來源
                  ,TO_NUMBER(TB_WRSPLIST1.VALUE1) AS ID_SEQ     -- 契約序號
                  ,TB_WRSPLIST1.VALUE2 AS FUND_NO               -- 基金代碼
             FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) TB_WRSPLIST1
            WHERE WCHECK_TYPE IN ('1','3')                     -- 檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
            -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
              AND WSTEP_TYPE = '1'
          ) TB_DATA;

   --STEP 2 RSP契約列表
   OPEN OUTDT2 FOR
   SELECT  TB_DATA.RSP_SOURCE AS RSP_SOURCE                     -- 契約來源
          ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN '臨櫃' 
                                   WHEN '2' THEN '網路' 
                                   ELSE ''
                                   END AS RSP_SOURCE_NAME       -- 契約來源名稱
          ,TB_DATA.ID_SEQ                                       -- 契約序號
          ,WIS_WRITE_KYC AS IS_WRITE_KYC                        -- 需重填投資適性分析表
     FROM (SELECT  TB_WRSPLIST2.VALUE1 AS RSP_SOURCE            -- 契約來源
                  ,TO_NUMBER(TB_WRSPLIST2.VALUE1) AS ID_SEQ     -- 契約序號
                  ,TB_WRSPLIST2.VALUE2 AS FUND_NO               -- 基金代碼
             FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) TB_WRSPLIST2
            WHERE WCHECK_TYPE IN ('1','3')                      -- 檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
            -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
              AND WSTEP_TYPE = '2'			
          ) TB_DATA;

    -- 2020.05.12 Chengyu 新增書面定額暫停扣款帳務處理中檢核
    IF WCHECK_TYPE = '2' AND WSTEP_TYPE IN ('1','2') THEN
    BEGIN

        --RSP 錯誤列表
        -- 2018.12.10 tingting 增加停止扣款警告訊息
        -- 2019.01.04 tingting 調整停止扣款若不等於指定活動專案代碼才出警告訊息
        OPEN OUTDT3 FOR
        SELECT -- RSP026：您的契約暫停扣款後，若要恢復，則現行優惠將會喪失。
               -- 2019.01.18 JIANXIN MOD BY 專案代碼移除訊息，書面定額無須檢查
                CASE WHEN WSTEP_TYPE = '1' AND TB_DATA.RSP_SOURCE = '2' AND TB_DATA.PROJECT_CODE IS NOT NULL AND PROJECT_CODE_LIST.PROJECT_CODE IS NULL THEN CAST(MSGINFO_RSP026.MSGTYPE AS VARCHAR2(1))
                     /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                     WHEN WSTEP_TYPE = '1' AND TB_DATA.RSP_SOURCE = '2' AND FUND.SALES_TYPE = '1' THEN CAST(MSGINFO_RSP030.MSGTYPE AS VARCHAR2(1))
                     /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                     ELSE '' 
                     END AS STOP_SUB_TYPE                       -- 訊息種類
               ,CASE WHEN WSTEP_TYPE = '1' AND TB_DATA.RSP_SOURCE = '2' AND TB_DATA.PROJECT_CODE IS NOT NULL AND PROJECT_CODE_LIST.PROJECT_CODE IS NULL THEN CAST(MSGINFO_RSP026.MSGCONTENT AS VARCHAR2(500)) 
                     /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                     WHEN WSTEP_TYPE = '1' AND TB_DATA.RSP_SOURCE = '2' AND FUND.SALES_TYPE = '1' THEN CAST(MSGINFO_RSP030.MSGCONTENT AS VARCHAR2(500))
                     /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                     ELSE '' 
                     END AS STOP_SUB_MSG                        -- 錯誤訊息
               -- 說明：用系統日期與RSP1.AC_DAY組出的下次交易日期判斷，若為T-4個營業日內，則不能異動契約
               -- 　　　用系統日期與傳入的AC_DAY組出的下次交易日期判斷，若為T-4個營業日內，也不能異動契約
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND RSP1.AC_DAY IS NOT NULL AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN RSP1.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(RSP1.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.RSP_SOURCE = '1' AND (TB_DATA.AC_DAY BETWEEN 1 AND 28) AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN TB_DATA.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(TB_DATA.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AC_DAY_TYPE                 --訊息種類
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND RSP1.AC_DAY IS NOT NULL AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN RSP1.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(RSP1.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGCONTENT AS VARCHAR2(500))
                     WHEN TB_DATA.RSP_SOURCE = '1' AND (TB_DATA.AC_DAY BETWEEN 1 AND 28) AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN TB_DATA.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(TB_DATA.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS AC_DAY_MSG                  --錯誤訊息
          FROM (SELECT  TB_WRSPLIST1.VALUE1 AS RSP_SOURCE        -- 契約來源
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE2) AS ID_SEQ -- 契約序號
                       -- 2020.05.27 Chengyu 修正書面定額暫停扣款帳務處理中檢核
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE5) AS AC_DAY -- 每月扣款日
                       ,TB_WRSPLIST1.VALUE12 AS PROJECT_CODE     -- 促銷活動代碼
                       /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                       ,TB_WRSPLIST1.VALUE3 AS FUND_NO           -- 基金代碼
                       /*---- 2025.02.05 end modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                  FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) TB_WRSPLIST1
                  -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                 WHERE WSTEP_TYPE = '1'			
                 UNION
                SELECT  TB_WRSPLIST2.VALUE1 AS RSP_SOURCE         -- 契約來源
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE2) AS ID_SEQ  -- 契約序號
                       -- 2020.05.27 Chengyu 修正書面定額暫停扣款帳務處理中檢核
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE5) AS AC_DAY  -- 每月扣款日
                       ,TB_WRSPLIST2.VALUE12 AS PROJECT_CODE      -- 促銷活動代碼
                       /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                       ,TB_WRSPLIST2.VALUE3 AS FUND_NO           -- 基金代碼
                       /*---- 2025.02.05 end modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
                  FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) TB_WRSPLIST2
                 WHERE WSTEP_TYPE = '2'					 	  
               ) TB_DATA
          LEFT JOIN (
                SELECT VALUE1 AS PROJECT_CODE
                  FROM TABLE(ECS.F_FormatStringListToTable(WPROJECT_CODE_LIST))
               ) PROJECT_CODE_LIST
            ON PROJECT_CODE_LIST.PROJECT_CODE = TB_DATA.PROJECT_CODE
          LEFT JOIN FAS.PERIODIC RSP1                           -- 書面定額資料
            ON RSP1.ID = XID
           AND RSP1.ID_SEQ = TB_DATA.ID_SEQ
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP025                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP025.MSGID = 'RSP025'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP026               -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP026.MSGID = 'RSP026'
          /*---- 2025.02.05 begin modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/
          left join fas.fund fund on fund.fund_no = TB_DATA.FUND_NO
          left join ecs.msginfo msginfo_rsp030 
            on msginfo_rsp030.msgid = 'RSP030';
          /*---- 2025.02.05 end modified by RICHARD 針對暫調銷售基金 , 須於客戶停扣前提醒客戶 ----*/

    END;
    ELSE
    BEGIN

        BEGIN

            -- 2018.12.11 JIANXIN 增加弱勢族群的判斷
            SELECT DISTINCT 'Y' 
              INTO XVULNERABLE_GROUP
              FROM FAS.HOLDER 
             CROSS JOIN (SELECT  TB_WRSPLIST1.VALUE1 AS RSP_SOURCE                    -- 契約來源
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE2) AS ID_SEQ             -- 契約序號
                                ,TB_WRSPLIST1.VALUE3 AS FUND_NO                       -- 基金代碼
                                ,TB_WRSPLIST1.VALUE4 AS TRADE_CRNCY                   -- 申購幣別
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE5) AS AC_DAY             -- 每月扣款日
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE6) AS AMOUNT             -- 扣款金額
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE7) AS RAISE_ROI          -- 加碼點(%)
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE8) AS RAISE_AMOUNT       -- 加碼金額
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE9) AS REDUCE_ROI         -- 減碼點(%)
                                ,TO_NUMBER(TB_WRSPLIST1.VALUE10) AS REDUCE_AMOUNT     -- 減碼金額
                                ,TB_WRSPLIST1.VALUE11 AS FEE_CHOICE                   -- 優惠方案
                                ,TB_WRSPLIST1.VALUE12 AS PROJECT_CODE                 -- 促銷活動代碼
                                ,TB_WRSPLIST1.VALUE13 AS COUPON_ID                    -- 優惠券代碼
                           FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) TB_WRSPLIST1
                           -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                          WHERE WSTEP_TYPE = '1'	
                          UNION
                         SELECT  TB_WRSPLIST2.VALUE1 AS RSP_SOURCE                    -- 契約來源
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE2) AS ID_SEQ             -- 契約序號
                                ,TB_WRSPLIST2.VALUE3 AS FUND_NO                       -- 基金代碼
                                ,TB_WRSPLIST2.VALUE4 AS TRADE_CRNCY                   -- 申購幣別
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE5) AS AC_DAY             -- 每月扣款日
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE6) AS AMOUNT             -- 扣款金額
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE7) AS RAISE_ROI          -- 加碼點(%)
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE8) AS RAISE_AMOUNT       -- 加碼金額
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE9) AS REDUCE_ROI         -- 減碼點(%)
                                ,TO_NUMBER(TB_WRSPLIST2.VALUE10) AS REDUCE_AMOUNT     -- 減碼金額
                                ,TB_WRSPLIST2.VALUE11 AS FEE_CHOICE                   -- 優惠方案
                                ,TB_WRSPLIST2.VALUE12 AS PROJECT_CODE                 -- 促銷活動代碼
                                ,TB_WRSPLIST2.VALUE13 AS COUPON_ID                    -- 優惠券代碼
                           FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) TB_WRSPLIST2
                           -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                          WHERE WSTEP_TYPE = '2'							   
                      ) TB_DATA
              JOIN FAS.FUND ON TB_DATA.FUND_NO = FUND.FUND_NO 
             WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO
               AND WCHECK_TYPE IN ('1','3')       -- 檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
               AND ( HOLDER.MAJOR_ILLNESS = 'Y'            --Ａ．有重大傷病
                     --找出 系統年 與 出生年 的相差 + 是否 系統月份、日期是否過了今年生日， 如果還沒過生日 -1歲
                     OR (TO_CHAR(XSYS_DTTM,'YYYY') - TO_CHAR(HOLDER.BIRTH_DATE,'YYYY') + CASE WHEN TO_CHAR(XSYS_DTTM,'MM') < TO_CHAR(HOLDER.BIRTH_DATE,'MM') THEN -1
                                                                                              WHEN TO_CHAR(XSYS_DTTM,'MM') = TO_CHAR(HOLDER.BIRTH_DATE,'MM') AND TO_CHAR(XSYS_DTTM,'DD') < TO_CHAR(HOLDER.BIRTH_DATE,'DD') THEN -1
                                                                                              ELSE 0
                                                                                         END >=20
                             AND HOLDER.EDUCATION IN ('A','a')
                            )                                  --Ｂ．大於等於20歲 且學歷為國中小以下
                      --找出 系統年 與 出生年 的相差 + 是否 系統月份、日期是否過了今年生日， 如果還沒過生日 -1歲
                      -- 2022.07.30 JIANXIN 調整弱勢族群由70歲調整為65歲
                      OR (TO_CHAR(XSYS_DTTM,'YYYY') - TO_CHAR(HOLDER.BIRTH_DATE,'YYYY') + CASE WHEN TO_CHAR(XSYS_DTTM,'MM') < TO_CHAR(HOLDER.BIRTH_DATE,'MM') THEN -1
                                                                                               WHEN TO_CHAR(XSYS_DTTM,'MM') = TO_CHAR(HOLDER.BIRTH_DATE,'MM') AND TO_CHAR(XSYS_DTTM,'DD') < TO_CHAR(HOLDER.BIRTH_DATE,'DD') THEN -1
                                                                                               ELSE 0
                                                                                          END >=65
                         )                                  --Ｃ．年齡大於等於65歲
                    ) -- 1．弱勢族群
                -- 2023.03.13 JIANXIN 若是弱勢族群，則必須滿足以下條件，否則出現錯誤訊息
                -- 2023.03.24 JIANXIN 針對弱勢族群自主聲明同意與不同意進行不同情境處理
                -- 2023.03.27 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
                -- 2023.03.30 JIANXIN 針對弱勢族群未填寫自主聲明同意進行不同情境處理
                -- 自主申購聲明\1：空值；2：同意；3：不同意
                -- 自主申購聲明 = 2.同意
                -- 弱勢族群評估 vulnerable_group = Y.已交付
                -- 弱勢族群評估到期日 vulnerable_mat_date > today (到期日大於今日)
                -- 則只可申購RR1~RR4基金
                -- 自主申購聲明 = 1.不同意
                -- 則只可申購RR1~RR2基金
                AND (
                      (
                        (    HOLDER.VULNERABLE_CLAIM = '3'
                        )
                        AND FUND.RISK_CATEGORY NOT IN ('RR1','RR2')
                      )
                      OR 
                      (
                        (    HOLDER.VULNERABLE_CLAIM = '2'
                         AND (   HOLDER.VULNERABLE_GROUP = 'N'
                              OR (HOLDER.VULNERABLE_GROUP = 'Y' AND HOLDER.VULNERABLE_MAT_DATE <= SYSDATE)
                             )
                        )
                        AND FUND.RISK_CATEGORY NOT IN ('RR1','RR2','RR3','RR4')

                      )                      
                      OR 
                      (
                        (    HOLDER.VULNERABLE_CLAIM = '' OR HOLDER.VULNERABLE_CLAIM = ' ' OR HOLDER.VULNERABLE_CLAIM = '1'               
                        )
                        AND FUND.RISK_CATEGORY NOT IN ('RR1','RR2','RR3','RR4')

                      )
                    );

            EXCEPTION
                WHEN NO_DATA_FOUND THEN  XVULNERABLE_GROUP := 'N';

        END;


        --RSP 錯誤列表
        -- 2018.08.24 ChengYu 錯誤訊息補上比較值
        OPEN OUTDT3 FOR
        SELECT  -- 2018.07.18 ChengYu 調整客戶風險屬性檢核(客戶 < 基金 出現訊息)
                -- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
                -- RSP004：投資人風險屬性與基金風險屬性不吻合
                -- 2018.12.11 JIANXIN 增加弱勢族群的判斷
                -- 2022.09.14 JIANXIN 調整訊息文字內容
                CASE WHEN RISK_CATEGORY.RISK_LEVEL IS NULL THEN CAST(MSGINFO_RSP004.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS RISK_TYPE                   --訊息種類
               ,CASE WHEN RISK_CATEGORY.RISK_LEVEL IS NULL THEN CAST(REPLACE(REPLACE(MSGINFO_RSP004.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{RISK_CATEGORY}',FUND.RISK_CATEGORY) AS VARCHAR2(500))
                     ELSE ''
                     END AS RISK_MSG                    --錯誤訊息

               -- SP005：扣款金額必須大於０
               ,CASE WHEN TB_DATA.AMOUNT < 0 THEN CAST(MSGINFO_RSP005.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AMOUNT_0_TYPE               --訊息種類
               ,CASE WHEN TB_DATA.AMOUNT < 0 THEN CAST(MSGINFO_RSP005.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS AMOUNT_0_MSG                --錯誤訊息

               -- RSP006：投資人扣款金額不符合網路定額扣款金額倍數：{RANGE}
               ,CASE WHEN TB_DATA.TRADE_CRNCY  = 'NTD' AND MOD(TB_DATA.AMOUNT , FUND.NTD_RSP_RANGE) != 0 THEN CAST(MSGINFO_RSP006.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.TRADE_CRNCY != 'NTD' AND MOD(TB_DATA.AMOUNT , FUND.ORG_RSP_RANGE) != 0 THEN CAST(MSGINFO_RSP006.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AMOUNT_MODE_RSP_RANGE_TYPE  --訊息種類
               ,CASE WHEN TB_DATA.TRADE_CRNCY  = 'NTD' AND MOD(TB_DATA.AMOUNT , FUND.NTD_RSP_RANGE) != 0 THEN CAST(REPLACE(MSGINFO_RSP006.MSGCONTENT,'{RANGE}',FUND.NTD_RSP_RANGE) AS VARCHAR2(500))
                     WHEN TB_DATA.TRADE_CRNCY != 'NTD' AND MOD(TB_DATA.AMOUNT , FUND.ORG_RSP_RANGE) != 0 THEN CAST(REPLACE(MSGINFO_RSP006.MSGCONTENT,'{RANGE}',FUND.ORG_RSP_RANGE) AS VARCHAR2(500))
                     ELSE ''
                     END AS AMOUNT_MODE_RSP_RANGE_MSG   --錯誤訊息

               -- RSP007：投資人扣款金額小於網路定額最低金額 {AMOUNT}
               ,CASE WHEN TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(MSGINFO_RSP007.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(MSGINFO_RSP007.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AMOUNT_MIN_TYPE             --訊息種類
               ,CASE WHEN TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(REPLACE(MSGINFO_RSP007.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN_NTD) AS VARCHAR2(500))
                     WHEN TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(REPLACE(MSGINFO_RSP007.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN) AS VARCHAR2(500))
                     ELSE ''
                     END AS AMOUNT_MIN_MSG              --錯誤訊息

               -- RSP008：投資人扣款金額超過扣款金額上限：{MAX_AMOUNT}
               -- 2018.10.17 tingting 增加書面定額異動檢核(原本只有網路定額異動檢核)
               -- 2018.11.14 tingting 1.調整書面定額上限檢核，不用看印核日期，直接判斷是否超過SYSTEM_PARAMETER的AMOUNT1
               --                     2.調整暫停扣款不做錯誤檢核
               -- 2018.11.15 ChengYu 檢查上限時要含手續費
               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核                
               -- 2019.02.21 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限 
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P1' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT  THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                            WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        WHEN '2' THEN (CASE WHEN HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P8' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT  THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P8' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT  THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(MSGINFO_SPC058.MSGTYPE AS VARCHAR2(1))
                                                             ELSE '' 
                                                            END)
                                        ELSE '' 
                                        END AS AMOUNT_MAX_TYPE      --訊息種類
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P1' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT  THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT  THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        WHEN '2' THEN (CASE WHEN HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P8' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P8' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.AMOUNT + (TB_DATA.AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT THEN CAST(REPLACE(MSGINFO_SPC058.MSGCONTENT,'{AMOUNT}',TO_CHAR(SYSTEM_PARAMETER.PUR_AMOUNT_LIMIT, 'FM999,999,999,999,999'))  AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        ELSE '' 
                                        END AS AMOUNT_MAX_MSG       --錯誤訊息
               -- RSP009：投資人扣款金額不符合金額小數位數：{AMT_DECIMAL}
               -- 2018.08.09 ChengYu 調整小數位數檢核 原本以基金抓取更正為交易幣別抓取小數位數
               ,CASE WHEN INSTR(TB_DATA.AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.AMOUNT,INSTR(TB_DATA.AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.AMOUNT)-INSTR(TB_DATA.AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(MSGINFO_RSP009.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AMOUNT_DECLEN_TYPE          --訊息種類
               -- 2018.08.09 ChengYu 調整小數位數檢核 原本以基金抓取更正為交易幣別抓取小數位數
               ,CASE WHEN INSTR(TB_DATA.AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.AMOUNT,INSTR(TB_DATA.AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.AMOUNT)-INSTR(TB_DATA.AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(REPLACE(MSGINFO_RSP009.MSGCONTENT,'{AMT_DECIMAL}',V_FUND_CRNCY.AMT_DECIMAL) AS VARCHAR2(500))
                     ELSE ''
                     END AS AMOUNT_DECLEN_MSG           --錯誤訊息

               -- RSP014：RSP契約資料不存在
               -- RSP015：扣款帳號不存在：{BANK_NAME} {AC_CODE}
               -- RSP016：扣款帳號尚未核印：{BANK_NAME} {AC_CODE}
               -- 備註：RSP008、RSP021、RSP022 上限檢核的前置條件檢查，若為NULL，上限檢核會檢核不出來
               -- 　　　RSP025 帳務處理中的前置條件檢查，若為NULL，AC_DAY組日期會發生錯誤
               -- 2018.10.17 tingting 增加書面定額異動檢核(原本只有網路定額異動檢核)
               -- 2018.11.14 tingting 1.調整書面定額上限檢核，不用看印核日期，直接判斷是否超過SYSTEM_PARAMETER的AMOUNT1
               --                     2.調整暫停扣款不做錯誤檢核
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.ID_SEQ IS NULL THEN CAST(MSGINFO_RSP014.MSGTYPE AS VARCHAR2(1))
                                                            --WHEN HOLDER_BANK_EC1.AC_CODE IS NULL THEN CAST(MSGINFO_RSP015.MSGTYPE AS VARCHAR2(1))
                                                            --WHEN HOLDER_BANK_EC1.VERIFIED IS NULL THEN CAST(MSGINFO_RSP016.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        WHEN '2' THEN (CASE WHEN RSP2.ID_SEQ IS NULL THEN CAST(MSGINFO_RSP014.MSGTYPE AS VARCHAR2(1))
                                                            -- 2018.12.18 JIANXIN 移除扣款銀行帳號是否存在的檢查
                                                            --WHEN HOLDER_BANK_EC2.AC_CODE IS NULL THEN CAST(MSGINFO_RSP015.MSGTYPE AS VARCHAR2(1))
                                                            --WHEN HOLDER_BANK_EC2.VERIFIED IS NULL THEN CAST(MSGINFO_RSP016.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        ELSE '' 
                                        END AS VERIFIED_TYPE      --訊息種類
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.ID_SEQ IS NULL THEN CAST(MSGINFO_RSP014.MSGCONTENT AS VARCHAR2(500))
                                                            --WHEN HOLDER_BANK_EC1.AC_CODE IS NULL THEN CAST(REPLACE(REPLACE(MSGINFO_RSP015.MSGCONTENT,'{BANK_NAME}',FIS_BANK1.NAME),'{AC_CODE}',HOLDER_BANK_EC1.AC_CODE) AS VARCHAR2(500))
                                                            --WHEN HOLDER_BANK_EC1.VERIFIED IS NULL THEN CAST(REPLACE(REPLACE(MSGINFO_RSP016.MSGCONTENT,'{BANK_NAME}',FIS_BANK1.NAME),'{AC_CODE}',HOLDER_BANK_EC1.AC_CODE) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        WHEN '2' THEN (CASE WHEN RSP2.ID_SEQ IS NULL THEN CAST(MSGINFO_RSP014.MSGCONTENT AS VARCHAR2(500))
                                                            -- 2018.12.18 JIANXIN 移除扣款銀行帳號是否存在的檢查
                                                            --WHEN HOLDER_BANK_EC2.AC_CODE IS NULL THEN CAST(REPLACE(REPLACE(MSGINFO_RSP015.MSGCONTENT,'{BANK_NAME}',FIS_BANK2.NAME),'{AC_CODE}',HOLDER_BANK_EC2.AC_CODE) AS VARCHAR2(500))
                                                            --WHEN HOLDER_BANK_EC2.VERIFIED IS NULL THEN CAST(REPLACE(REPLACE(MSGINFO_RSP016.MSGCONTENT,'{BANK_NAME}',FIS_BANK2.NAME),'{AC_CODE}',HOLDER_BANK_EC2.AC_CODE) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        ELSE '' 
                                        END AS VERIFIED_MSG       --錯誤訊息

               -- 2018.11.16 tingting 增加加碼金額、減碼金額檢核
               -- 2018.11.21 tingting 調整定期不定額才做加減碼金額與基準扣款金額的檢核
               -- RSP010：加碼金額必須大於基準扣款金額
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.RAISE_AMOUNT <= TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP010.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS RAISE_AMOUNT_TYPE           --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.RAISE_AMOUNT <= TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP010.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS RAISE_AMOUNT_MSG            --錯誤訊息

               -- 2018.11.16 tingting 增加加碼金額、減碼金額必須小於基準扣款金額
               -- 2018.11.21 tingting 調整定期不定額才做加減碼金額與基準扣款金額的檢核
               -- RSP011：減碼金額必須小於基準扣款金額
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.REDUCE_AMOUNT >= TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP011.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS REDUCE_AMOUNT_TYPE          --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.REDUCE_AMOUNT >= TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP011.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS REDUCE_AMOUNT_MSG           --錯誤訊息

               -- 2018.11.16 tingting 增加加碼金額、減碼金額檢核
               -- RSP017：加碼金額不符合網路定額扣款金額倍數：{RANGE}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND MOD(TB_DATA.RAISE_AMOUNT, CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) != 0 
                     THEN CAST(MSGINFO_RSP017.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS RAISE_AMOUNT_RANGE_TYPE     --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND MOD(TB_DATA.RAISE_AMOUNT, CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) != 0 
                     THEN CAST(REPLACE(MSGINFO_RSP017.MSGCONTENT, '{RANGE}', CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) AS VARCHAR2(500))
                     ELSE ''
                     END AS RAISE_AMOUNT_RANGE_MSG      --錯誤訊息

               -- 2018.11.16 tingting 增加加碼金額、減碼金額必須小於基準扣款金額
               -- RSP018：減碼金額不符合網路定額扣款金額倍數：{RANGE}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND MOD(TB_DATA.REDUCE_AMOUNT, CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) != 0 
                     THEN CAST(MSGINFO_RSP018.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS REDUCE_AMOUNT_RANGE_TYPE    --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND MOD(TB_DATA.REDUCE_AMOUNT, CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) != 0 
                     THEN CAST(REPLACE(MSGINFO_RSP018.MSGCONTENT, '{RANGE}', CASE WHEN TB_DATA.TRADE_CRNCY = FUND.CURRENCY_NO THEN FUND.ORG_RSP_RANGE ELSE FUND.NTD_RSP_RANGE END) AS VARCHAR2(500))
                     ELSE ''
                     END AS REDUCE_AMOUNT_RANGE_MSG     --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP019：加碼金額不可小於網路定額最低金額：{AMOUNT}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.RAISE_AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(MSGINFO_RSP019.MSGTYPE AS VARCHAR2(1))
                     WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.RAISE_AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(MSGINFO_RSP019.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS RAISE_AMOUNT_MIN_TYPE       --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.RAISE_AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(REPLACE(MSGINFO_RSP019.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN_NTD) AS VARCHAR2(500))
                     WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.RAISE_AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(REPLACE(MSGINFO_RSP019.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN) AS VARCHAR2(500))
                     ELSE ''
                     END AS RAISE_AMOUNT_MIN_MSG        --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP020：減碼金額不可小於網路定額最低金額：{AMOUNT}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.REDUCE_AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(MSGINFO_RSP020.MSGTYPE AS VARCHAR2(1))
                     WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.REDUCE_AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(MSGINFO_RSP020.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS REDUCE_AMOUNT_MIN_TYPE      --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY  = 'NTD' AND TB_DATA.REDUCE_AMOUNT < FUND.EC_PERIOD_MIN_NTD THEN CAST(REPLACE(MSGINFO_RSP020.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN_NTD) AS VARCHAR2(500))
                     WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND TB_DATA.TRADE_CRNCY != 'NTD' AND TB_DATA.REDUCE_AMOUNT < FUND.EC_PERIOD_MIN     THEN CAST(REPLACE(MSGINFO_RSP020.MSGCONTENT,'{AMOUNT}',FUND.EC_PERIOD_MIN) AS VARCHAR2(500))
                     ELSE ''
                     END AS REDUCE_AMOUNT_MIN_MSG       --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP021：加碼金額超過扣款金額上限：{MAX_AMOUNT}
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.RAISE_AMOUNT + (TB_DATA.RAISE_AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(MSGINFO_RSP021.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        WHEN '2' THEN (CASE WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.RAISE_AMOUNT  + (TB_DATA.RAISE_AMOUNT  * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(MSGINFO_RSP021.MSGTYPE AS VARCHAR2(1))
                                                            WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.RAISE_AMOUNT  + (TB_DATA.RAISE_AMOUNT  * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(MSGINFO_RSP021.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        ELSE '' 
                                        END AS RAISE_AMOUNT_MAX_TYPE        --訊息種類
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.RAISE_AMOUNT + (TB_DATA.RAISE_AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(REPLACE(MSGINFO_RSP021.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT2) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        WHEN '2' THEN (CASE WHEN HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.RAISE_AMOUNT  + (TB_DATA.RAISE_AMOUNT  * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(REPLACE(MSGINFO_RSP021.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT1) AS VARCHAR2(500))
                                                            WHEN HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND RSP2.PRODUCT_TYPE = 'P9' AND TB_DATA.RAISE_AMOUNT  + (TB_DATA.RAISE_AMOUNT  * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(REPLACE(MSGINFO_RSP021.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT2) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        ELSE '' 
                                        END AS RAISE_AMOUNT_MAX_MSG         --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP022：減碼金額超過扣款金額上限：{MAX_AMOUNT}
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(MSGINFO_RSP022.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        WHEN '2' THEN (CASE WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(MSGINFO_RSP022.MSGTYPE AS VARCHAR2(1))
                                                            WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(MSGINFO_RSP022.MSGTYPE AS VARCHAR2(1))
                                                            ELSE '' 
                                                            END)
                                        ELSE '' 
                                        END AS REDUCE_AMOUNT_MAX_TYPE       --訊息種類
               ,CASE TB_DATA.RSP_SOURCE WHEN '1' THEN (CASE WHEN RSP1.PRODUCT_TYPE = 'P3' AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP1.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(REPLACE(MSGINFO_RSP022.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT2) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        WHEN '2' THEN (CASE WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT1 THEN CAST(REPLACE(MSGINFO_RSP022.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT1) AS VARCHAR2(500))
                                                            WHEN RSP2.PRODUCT_TYPE = 'P9' AND HOLDER_BANK_EC2.VERIFIED > SYSTEM_PARAMETER.FIS_SEAL_DATE AND TB_DATA.REDUCE_AMOUNT + (TB_DATA.REDUCE_AMOUNT * NVL(RSP2.SC_RATE,0) /100) > SYSTEM_PARAMETER.PER_DRSP_AMOUNT2 THEN CAST(REPLACE(MSGINFO_RSP022.MSGCONTENT,'{MAX_AMOUNT}',SYSTEM_PARAMETER.PER_DRSP_AMOUNT2) AS VARCHAR2(500))
                                                            ELSE ''
                                                            END)
                                        ELSE '' 
                                        END AS REDUCE_AMOUNT_MAX_MSG        --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP023：加碼金額不符合金額小數位數：{AMT_DECIMAL}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.RAISE_AMOUNT,INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.RAISE_AMOUNT)-INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(MSGINFO_RSP023.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS RAISE_AMOUNT_DECLEN_TYPE            --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.RAISE_AMOUNT,INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.RAISE_AMOUNT)-INSTR(TB_DATA.RAISE_AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(REPLACE(MSGINFO_RSP023.MSGCONTENT,'{AMT_DECIMAL}',V_FUND_CRNCY.AMT_DECIMAL) AS VARCHAR2(500))
                     ELSE ''
                     END AS RAISE_AMOUNT_DECLEN_MSG             --錯誤訊息

               -- 2018.11.28 tingting 增加加碼金額、減碼金額檢核
               -- RSP024：減碼金額不符合金額小數位數：{AMT_DECIMAL}
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.REDUCE_AMOUNT,INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.REDUCE_AMOUNT)-INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(MSGINFO_RSP024.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS REDUCE_AMOUNT_DECLEN_TYPE           --訊息種類
               ,CASE WHEN ((TB_DATA.RSP_SOURCE = '1' AND RSP1.PRODUCT_TYPE = 'P3') OR (TB_DATA.RSP_SOURCE = '2' AND RSP2.PRODUCT_TYPE = 'P9')) AND INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1) != 0 AND LENGTH(SUBSTR(TB_DATA.REDUCE_AMOUNT,INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1)+1,LENGTH(TB_DATA.REDUCE_AMOUNT)-INSTR(TB_DATA.REDUCE_AMOUNT,'.',1,1))) > V_FUND_CRNCY.AMT_DECIMAL THEN CAST(REPLACE(MSGINFO_RSP024.MSGCONTENT,'{AMT_DECIMAL}',V_FUND_CRNCY.AMT_DECIMAL) AS VARCHAR2(500))
                     ELSE ''
                     END AS REDUCE_AMOUNT_DECLEN_MSG            --錯誤訊息

               -- RSP012：優惠券已被使用)
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,CASE WHEN TB_DATA.FEE_CHOICE = '2' AND COUPON_DATA.IS_EFFECT = 'N' THEN CAST(MSGINFO_RSP012.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS COUPON_EFFECT_TYPE          --訊息種類
               ,CASE WHEN TB_DATA.FEE_CHOICE = '2' AND COUPON_DATA.IS_EFFECT = 'N' THEN CAST(MSGINFO_RSP012.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS COUPON_EFFECT_MSG           --錯誤訊息

               -- RSP013：優惠券已逾期： {VALID_THRU}
               ,CASE WHEN TB_DATA.FEE_CHOICE = '2' AND COUPON_DATA.IS_EFFECT = 'Y' AND (XSYS_DTTM < COUPON_DATA.VALID_FROM OR XSYS_DTTM > COUPON_DATA.VALID_THRU )
                     THEN CAST(MSGINFO_RSP013.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS COUPON_TIME_OUT_TYPE        --訊息種類
               ,CASE WHEN TB_DATA.FEE_CHOICE = '2' AND COUPON_DATA.IS_EFFECT = 'Y' AND (XSYS_DTTM < COUPON_DATA.VALID_FROM OR XSYS_DTTM > COUPON_DATA.VALID_THRU )
                     THEN CAST(REPLACE(MSGINFO_RSP013.MSGCONTENT,' {VALID_THRU}',COUPON_DATA.VALID_THRU) AS VARCHAR2(500))
                     ELSE ''
                     END AS COUPON_TIME_OUT_MSG         --錯誤訊息

               -- 2018.11.29 tingting 書面定額增加帳務處理中檢核
               -- 參考來源：TFS\EastSpring\EIB 相關文件\客戶提供的資料\其它\20180723 官網書面定額列表邏輯 文件
               -- 2019.01.04 JIANXIN 移除書面定額舊契約帳務處理中的判別
               --,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND PERIODIC_LOG.STARTED >= 1 THEN CAST(MSGINFO_RSP025.MSGTYPE AS VARCHAR2(1))
               --      ELSE ''
               --      END AS STARTED_TYPE                --訊息種類
               --,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND PERIODIC_LOG.STARTED >= 1 THEN CAST(MSGINFO_RSP025.MSGCONTENT AS VARCHAR2(500))
               --      ELSE ''
               --      END AS STARTED_MSG                 --錯誤訊息

               -- 2018.11.29 tingting 書面定額增加帳務處理中檢核
               -- 2018.12.06 tingting 調整書面定額帳務處理中檢核
               -- 說明：用系統日期與RSP1.AC_DAY組出的下次交易日期判斷，若為T-4個營業日內，則不能異動契約
               -- 　　　用系統日期與傳入的AC_DAY組出的下次交易日期判斷，若為T-4個營業日內，也不能異動契約
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND RSP1.AC_DAY IS NOT NULL AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN RSP1.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(RSP1.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.RSP_SOURCE = '1' AND (TB_DATA.AC_DAY BETWEEN 1 AND 28) AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN TB_DATA.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(TB_DATA.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS AC_DAY_TYPE                 --訊息種類
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND RSP1.AC_DAY IS NOT NULL AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN RSP1.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(RSP1.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGCONTENT AS VARCHAR2(500))
                     WHEN TB_DATA.RSP_SOURCE = '1' AND (TB_DATA.AC_DAY BETWEEN 1 AND 28) AND XSYS_DTTM >= ECS.F_GETBEFAFTDATE(RSP1.FUND_NO, '1', TO_DATE(TO_CHAR(ADD_MONTHS(XSYS_DTTM,CASE WHEN TB_DATA.AC_DAY >= TO_CHAR(XSYS_DTTM,'DD') THEN 0 ELSE 1 END),'YYYYMM') || LPAD(TB_DATA.AC_DAY,2,'0'),'YYYYMMDD'), -4) THEN CAST(MSGINFO_RSP025.MSGCONTENT AS VARCHAR2(500))
                     ELSE ''
                     END AS AC_DAY_MSG                  --錯誤訊息
               -- 2019.04.08 JIANXIN 新增針對特殊基金，不可復扣與提升扣款金額
               -- 2019.05.17 JIANXIN 增加AML狀態=Read Only，則不得提高扣款金額、恢復扣款
               -- 2022.05.13 JIANXIN 移除AML錯誤判斷
               -- 2022.11.29 JIANXIN 若為弱勢投資人時，則不得提高扣款金額、恢復扣款
               -- 2022.11.30 JIANXIN 若為弱勢投資人時，且該基金為RR5時，只能降低扣款金額，且不可以復扣，RR1-RR4 都可以執行不做檢查
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND WCHECK_TYPE = '1'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) AND (SELECT AMOUNT FROM FAS.PERIODIC RSP WHERE RSP.ID = XID AND RSP.ID_SEQ = TB_DATA.ID_SEQ) < TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP027.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.RSP_SOURCE = '2' AND WCHECK_TYPE = '1'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) AND (SELECT AMOUNT FROM ECS.RSP WHERE RSP.ID = XID AND RSP.ID_SEQ = TB_DATA.ID_SEQ) < TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP027.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS NOT_AMOUNT_UP_TYPE 
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND WCHECK_TYPE = '1'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) AND (SELECT AMOUNT FROM FAS.PERIODIC RSP WHERE RSP.ID = XID AND RSP.ID_SEQ = TB_DATA.ID_SEQ) < TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP027.MSGCONTENT AS VARCHAR2(500)) 
                     WHEN TB_DATA.RSP_SOURCE = '2' AND WCHECK_TYPE = '1'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) AND (SELECT AMOUNT FROM ECS.RSP WHERE RSP.ID = XID AND RSP.ID_SEQ = TB_DATA.ID_SEQ) < TB_DATA.AMOUNT THEN CAST(MSGINFO_RSP027.MSGCONTENT AS VARCHAR2(500)) 
                     ELSE ''
                     END AS NOT_AMOUNT_UP_MSG 
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND WCHECK_TYPE = '3'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) THEN CAST(MSGINFO_RSP028.MSGTYPE AS VARCHAR2(1))
                     WHEN TB_DATA.RSP_SOURCE = '2' AND WCHECK_TYPE = '3'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) THEN CAST(MSGINFO_RSP028.MSGTYPE AS VARCHAR2(1))
                     ELSE ''
                     END AS NOT_RESTORE_TYPE 
               ,CASE WHEN TB_DATA.RSP_SOURCE = '1' AND WCHECK_TYPE = '3'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) THEN CAST(MSGINFO_RSP028.MSGCONTENT AS VARCHAR2(500)) 
                     WHEN TB_DATA.RSP_SOURCE = '2' AND WCHECK_TYPE = '3'  AND ((FUND.SALES_TYPE IN ('1','3') AND FUND.CLEAR_DATE IS NULL ) OR XAML_STATUS = 'R' OR (XVULNERABLE_GROUP = 'Y' AND RISK_CATEGORY.RISK_CATEGORY = 'RR5')) THEN CAST(MSGINFO_RSP028.MSGCONTENT AS VARCHAR2(500)) 
                     ELSE ''
                     END AS NOT_RESTORE_MSG
                -- 2022.05.17 JIANXIN 新增AML 狀態 = D，皆不可進行異動
               ,CASE WHEN XAML_STATUS = 'D' THEN CAST(MSGINFO_RSP029.MSGTYPE AS VARCHAR2(1)) 
                     ELSE '' 
                     END AS AML_STATUS_TYPE                       
               ,CASE WHEN XAML_STATUS = 'D' THEN CAST(MSGINFO_RSP029.MSGCONTENT AS VARCHAR2(500)) 
                     ELSE '' 
                     END AS AML_STATUS_MSG 
          FROM (
                SELECT  TB_WRSPLIST1.VALUE1 AS RSP_SOURCE                    -- 契約來源
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE2) AS ID_SEQ             -- 契約序號
                       ,TB_WRSPLIST1.VALUE3 AS FUND_NO                       -- 基金代碼
                       ,TB_WRSPLIST1.VALUE4 AS TRADE_CRNCY                   -- 申購幣別
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE5) AS AC_DAY             -- 每月扣款日
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE6) AS AMOUNT             -- 扣款金額
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE7) AS RAISE_ROI          -- 加碼點(%)
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE8) AS RAISE_AMOUNT       -- 加碼金額
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE9) AS REDUCE_ROI         -- 減碼點(%)
                       ,TO_NUMBER(TB_WRSPLIST1.VALUE10) AS REDUCE_AMOUNT     -- 減碼金額
                       -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
                       ,TB_WRSPLIST1.VALUE11 AS FEE_CHOICE                   -- 優惠方案
                       ,TB_WRSPLIST1.VALUE12 AS PROJECT_CODE                 -- 促銷活動代碼
                       ,TB_WRSPLIST1.VALUE13 AS COUPON_ID                    -- 優惠券代碼
                  FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST1)) TB_WRSPLIST1
                 WHERE WCHECK_TYPE IN ('1','3') -- 檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
                 -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                   AND WSTEP_TYPE = '1'						 
                 UNION
                SELECT  TB_WRSPLIST2.VALUE1 AS RSP_SOURCE                    -- 契約來源
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE2) AS ID_SEQ             -- 契約序號
                       ,TB_WRSPLIST2.VALUE3 AS FUND_NO                       -- 基金代碼
                       ,TB_WRSPLIST2.VALUE4 AS TRADE_CRNCY                   -- 申購幣別
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE5) AS AC_DAY             -- 每月扣款日
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE6) AS AMOUNT             -- 扣款金額
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE7) AS RAISE_ROI          -- 加碼點(%)
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE8) AS RAISE_AMOUNT       -- 加碼金額
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE9) AS REDUCE_ROI         -- 減碼點(%)
                       ,TO_NUMBER(TB_WRSPLIST2.VALUE10) AS REDUCE_AMOUNT     -- 減碼金額
                       -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
                       ,TB_WRSPLIST2.VALUE11 AS FEE_CHOICE                   -- 優惠方案
                       ,TB_WRSPLIST2.VALUE12 AS PROJECT_CODE                 -- 促銷活動代碼
                       ,TB_WRSPLIST2.VALUE13 AS COUPON_ID                    -- 優惠券代碼
                  FROM TABLE(ECS.F_FormatStringListToTable(WRSPLIST2)) TB_WRSPLIST2
                 WHERE WCHECK_TYPE IN ('1','3') -- 檢查種類  1：一般異動；2：暫停扣款；3：恢復扣款
                 -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                   AND WSTEP_TYPE = '2'					 
               ) TB_DATA
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = TB_DATA.FUND_NO
          -- 2018.10.03 JIANXIN 風險屬性檢查改在FAS.RISK_LEVEL_MAPPING
          -- 2018.10.04 JIANXIN 風險屬性檢查邏輯調整
          LEFT JOIN TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('2',XSYS_DTTM)) RISK_CATEGORY    -- 取得風險屬性等級
            ON RISK_CATEGORY.RISK_CATEGORY = FUND.RISK_CATEGORY
           -- 2019.04.25 JIANXIN MOD 因應弱勢族群調整串接判斷
           -- 2022.11.30 JIANXIN MOD 移除弱勢投資人的判斷
           -- 2022.12.02 JIANXIN MOD KYC Level 需對應
           -- AND RISK_CATEGORY.RISK_LEVEL = (CASE WHEN XVULNERABLE_GROUP = 'Y' AND WKYC_RISK_LEVEL = 3 THEN 2 ELSE WKYC_RISK_LEVEL END)
           AND RISK_CATEGORY.RISK_LEVEL =  WKYC_RISK_LEVEL  
          LEFT JOIN FAS.AMC AMC                                 -- 基金公司名稱
            ON AMC.AMC_NO = FUND.AMC_NO
          LEFT JOIN FAS.PERIODIC RSP1                           -- 書面定額資料
            ON RSP1.ID = XID
           AND RSP1.ID_SEQ = TB_DATA.ID_SEQ
          /*
          LEFT JOIN FAS.HOLDER_BANK_EC HOLDER_BANK_EC1          -- 受益人扣款帳號(書面定額)
            ON HOLDER_BANK_EC1.ID = RSP1.ID
           AND HOLDER_BANK_EC1.AC_BANK = RSP1.AC_BANK
           AND HOLDER_BANK_EC1.AC_CODE = RSP1.AC_CODE
           AND HOLDER_BANK_EC1.CURRENCY_NO = TB_DATA.TRADE_CRNCY
           AND HOLDER_BANK_EC1.DEPOSITORY_NO = AMC.DEPOSITORY_NO
          */
          LEFT JOIN FAS.FIS_BANK FIS_BANK1                      -- 銀行總行(書面定額)
            ON FIS_BANK1.BANK_NO = RSP1.AC_BANK
          LEFT JOIN ECS.RSP RSP2                                -- EC定額
            ON RSP2.ID = XID
           AND RSP2.ID_SEQ = TB_DATA.ID_SEQ
          LEFT JOIN FAS.HOLDER_BANK_EC HOLDER_BANK_EC2          -- 受益人扣款帳號(EC定額)
            ON HOLDER_BANK_EC2.ID = RSP2.ID
           AND HOLDER_BANK_EC2.AC_BANK = RSP2.BANK_NO
           AND HOLDER_BANK_EC2.AC_CODE = RSP2.AC_CODE
           AND HOLDER_BANK_EC2.CURRENCY_NO = TB_DATA.TRADE_CRNCY
           -- 2018.11.02 tingting 修正JOIN FAS.HOLDER_BANK_EC 少條件的錯誤
           AND HOLDER_BANK_EC2.DEPOSITORY_NO = AMC.DEPOSITORY_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK2                      -- 銀行總行(EC定額)
            ON FIS_BANK2.BANK_NO = RSP2.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY               -- 幣別檔(View)
            ON V_FUND_CRNCY.CURRENCY_NO = TB_DATA.TRADE_CRNCY
          -- 2018.11.29 tingting 書面定額增加帳務處理中檢核
          LEFT JOIN (SELECT  PERIODIC_LOG.FUND_NO
                            ,COUNT(*) AS STARTED 
                       FROM FAS.PERIODIC_LOG PERIODIC_LOG
                       LEFT JOIN FAS.FUND FUND
                         ON FUND.FUND_NO = PERIODIC_LOG.FUND_NO
                      WHERE FAS.FUND.SUBTA_NO <> '04'           -- 登錄代理人代號 01.瀚亞投信 02.瀚亞投資(新加坡) 04.RBC
                        AND PERIODIC_LOG.AC_MONTH = TO_CHAR(SYSDATE,'YYYY/MM')
                        AND PERIODIC_LOG.STATUS = 'I'
                      GROUP BY PERIODIC_LOG.FUND_NO
               ) PERIODIC_LOG
            ON PERIODIC_LOG.FUND_NO = TB_DATA.FUND_NO               
          LEFT JOIN ECS.COUPON_DATA COUPON_DATA                 -- 優惠券配發資料\博暉科技
            ON COUPON_DATA.COUPON_ID = TB_DATA.COUPON_ID
          LEFT JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER       -- 參數設定資料\博暉科技
            ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP004                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP004.MSGID = 'RSP004'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP005                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP005.MSGID = 'RSP005'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP006                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP006.MSGID = 'RSP006'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP007                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP007.MSGID = 'RSP007'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP008                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP008.MSGID = 'RSP008'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP009                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP009.MSGID = 'RSP009'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP010                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP010.MSGID = 'RSP010'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP011                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP011.MSGID = 'RSP011'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP012                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP012.MSGID = 'RSP012'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP013                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP013.MSGID = 'RSP013'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP014                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP014.MSGID = 'RSP014'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP015                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP015.MSGID = 'RSP015'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP016                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP016.MSGID = 'RSP016'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP017                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP017.MSGID = 'RSP017'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP018                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP018.MSGID = 'RSP018'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP019                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP019.MSGID = 'RSP019'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP020                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP020.MSGID = 'RSP020'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP021                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP021.MSGID = 'RSP021'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP022                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP022.MSGID = 'RSP022'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP023                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP023.MSGID = 'RSP023'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP024                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP024.MSGID = 'RSP024'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP025                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP025.MSGID = 'RSP025'
          -- 2019.02.21 yunchu 新增檢查一筆申購金額不可超過單筆申購扣款金額上限 
          LEFT JOIN ECS.MSGINFO MSGINFO_SPC058                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_SPC058.MSGID = 'SPC058'
          -- 2019.04.08 JIANXIN 新增針對特殊基金，不可復扣與提升扣款金額
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP027                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP027.MSGID = 'RSP027'
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP028                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP028.MSGID = 'RSP028'
          -- 2022.05.17 JIANXIN 新增AML 狀態 = D，皆不可進行異動
          LEFT JOIN ECS.MSGINFO MSGINFO_RSP029                  -- 系統訊息資料檔\博暉科技
            ON MSGINFO_RSP029.MSGID = 'RSP029';

    END;
    END IF;

END s_CheckRSPChgData;

/

  GRANT EXECUTE ON "ECS"."S_CHECKRSPCHGDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKSWITCHDATA_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKSWITCHDATA_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/08/10
-- Description: 檢查轉換交易資料(取出TMP資料、清空TMP)
-- 2018.08.28 ChengYu 修正取得的欄位MEMO改為ERROR_MSG
-- 2018.09.14 ChengYu 轉申購步驟1給贖回基金代碼
-- 2018.09.26 ChengYu 增加轉申購單位數檢查
-- 2018.10.03 ChengYu 全部贖回時不檢查 最低剩餘單位數
-- 2018.10.04 ChengYu 轉申購給贖回基金代碼
-- 2018.10.23 ChengYu 檢查轉申購最低金額
-- 2018.11.14 ChengYu 新增傳出參數IS_WRITE_KYC
-- 2018.11.19 ChengYu 修正轉申購最低金額檢查
-- 2018.11.26 ChengYu 最低轉入金額檢查
-- 2018.11.26 ChengYu 最低轉入金額檢核新增判斷交易幣別
-- 2018.11.28 JIANXIN 最低轉入金額檢核新增判斷交易幣別與匯率
-- 2018.11.29 JIANXIN 增加調整訊息
-- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
-- 2018.12.03 JIANXIN 匯率要取得轉出基金的匯率
-- 2018.12.12 ChengYu 最低轉入金額檢核新增判斷是否為首次(轉)申購基金
-- 2018.12.12 ChengYu 調整最低轉入金額檢核效能
-- 2018.12.26 JIANXIN 無論是全部贖回或者是部分贖回，都要檢查轉入金額檢查
-- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
-- 2019.05.24 tingting 增加員工員眷不能轉申購同一母基金級別的基金檢查
-- 2020.09.16 JIANXIN 因應轉申購限制金額由轉出基金處理，故而回傳轉出基金
-- 2021.01.14 Chengyu修正為當日轉申購金額上限語法
-- =============================================
(
    WACCOUNT_NO     INTEGER,             --戶號
    WSTEP_TYPE      ECS.SHOPCAR_TRADE_TEMP.STEP_TYPE%TYPE, ---交易步驟
    WSWITCHLIST2    VARCHAR2,            --轉申購列表2(境內外識別碼;基金代碼;交易日期;買回計算淨值日期;買回單位數;可買回單位數;轉入基金境內外識別碼;轉入基金代碼;轉入基金計價幣別;轉申購日期)
    WSWITCHLIST3    VARCHAR2,            --轉申購列表3(境內外識別碼;基金代碼;交易日期;買回計算淨值日期;買回單位數;可買回單位數;轉入基金境內外識別碼;轉入基金代碼;轉入基金計價幣別;轉申購日期;買回基金申購幣別;優惠方案;促銷活動代碼;優惠券代碼;使用紅利點數)

    OUTDT           OUT SYS_REFCURSOR,   --回傳SwitchList1
    OUTDT2          OUT SYS_REFCURSOR,   --回傳SwitchErrList
    OUTDT3          OUT SYS_REFCURSOR,   --單位數檢核列表
    OUTDT4          OUT SYS_REFCURSOR    --當日轉申購總金額列表
)
IS
    XIS_EMP         VARCHAR2(1);         --員工否
BEGIN

    --取得員工否
    SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END IS_EMP
      INTO XIS_EMP
      FROM FAS.HOLDER
      JOIN FAS.RELATIVE     --員眷資料
        ON RELATIVE.ID = HOLDER.ID
       AND (RELATIVE.RELATIONSHIP = 'S' OR  --S 員工本人 P 配偶 C 未成年子女 F 免手續費 D 眷屬
            RELATIVE.RELATIONSHIP = 'P' OR
            RELATIVE.RELATIONSHIP = 'C')
      JOIN FAS.EMP          --員工資料
        ON EMP.ID = RELATIVE.EMP_ID
       AND EMP.STATUS = 'A' --狀態 A在職 T離職
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

    OPEN OUTDT FOR
    -- 2018.09.14 ChengYu轉申購步驟1給贖回基金代碼
    -- 2018.10.04 ChengYu轉申購給贖回基金代碼
    SELECT DISTINCT
            SHOPCAR_TRADE_TEMP.REDEM_FUND AS FUND_NO
            -- 2018.11.14 ChengYu新增傳出參數IS_WRITE_KYC
           ,SHOPCAR_TRADE_TEMP.IS_WRITE_KYC AS IS_WRITE_KYC
      FROM ECS.SHOPCAR_TRADE_TEMP SHOPCAR_TRADE_TEMP;

    OPEN OUTDT2 FOR
    SELECT DISTINCT
            SHOPCAR_ERR_TEMP.MSG_TYPE AS WARNS_TYPE
           ,SHOPCAR_ERR_TEMP.ERROR_MSG AS ERROR_MSG
      FROM ECS.SHOPCAR_ERR_TEMP;

    -- 2018.09.26 ChengYu增加轉申購單位數檢查
    -- 單位數檢核列表
    OPEN OUTDT3 FOR
    SELECT  TB_DATA.FUND_NO                                           -- 基金代碼
           ,TB_DATA.TX_DATE                                           -- 交易日期
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGTYPE AS VARCHAR2(1))
                ELSE ''
            END AS APPLICATION_SHARE_0_TYPE   -- 買回單位數的小於等於零檢核(YTPE)
           ,CASE WHEN TB_DATA.APPLICATION_SHARE <= 0 THEN CAST(MSGINFO_RED006.MSGCONTENT AS VARCHAR2(500))
                ELSE ''
            END AS APPLICATION_SHARE_0_MSG   -- 買回單位數的小於等於零檢核(MSG)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 THEN CAST(MSGINFO_RED007.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_TYPE -- 買回單位數小數位數檢核(TYPE)
           ,CASE WHEN INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)!= 0
                  AND LENGTH(SUBSTR(TB_DATA.APPLICATION_SHARE,INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1)+1,LENGTH(TB_DATA.APPLICATION_SHARE)-INSTR(TB_DATA.APPLICATION_SHARE,'.',1,1))) > FUND.SHARE_DECIMAL
                 -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
                 THEN CAST(REPLACE(MSGINFO_RED007.MSGCONTENT,'{SHARE_DECIMAL}',FUND.SHARE_DECIMAL) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_DECLEN_MSG  -- 買回單位數小數位數檢核(MSG)
           -- 2018.10.03 ChengYu全部贖回時不檢查 最低剩餘單位數 BEGIN
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(MSGINFO_RED008.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_TYPE    -- 最低買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.APPLICATION_SHARE < FUND.MIN_RED_SHARE THEN CAST(REPLACE(MSGINFO_RED008.MSGCONTENT,'{MIN_RED_SHARE}',FUND.MIN_RED_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_SHARE_MIN_MSG     -- 最低買回單位數檢核(MSG)
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE THEN CAST(MSGINFO_RED009.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS REMAIN_SHARES_TYPE            --  最低剩餘單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE != 0 AND TB_DATA.R_SHARES - TB_DATA.APPLICATION_SHARE < FUND.MIN_BAL_SHARE THEN CAST(REPLACE(MSGINFO_RED009.MSGCONTENT,'{MIN_BAL_SHARE}',FUND.MIN_BAL_SHARE) AS VARCHAR2(500))
                 ELSE ''
            END AS REMAIN_SHARES_MSG             --  最低剩餘單位數檢核(MSG)
            -- 2018.10.03 ChengYu全部贖回時不檢查 最低剩餘單位數 END
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(MSGINFO_RED011.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS APPLICATION_R_SHARES_TYPE     -- 不可大於可買回單位數檢核(TYPE)
           -- 2018.08.21 ChengYu 系統日期改成不含時間、錯誤訊息補上條件
           ,CASE WHEN TB_DATA.APPLICATION_SHARE > TB_DATA.R_SHARES THEN CAST(REPLACE(MSGINFO_RED011.MSGCONTENT,'{R_SHARES}',TB_DATA.R_SHARES) AS VARCHAR2(500))
                 ELSE ''
            END AS APPLICATION_R_SHARES_MSG      -- 不可大於可買回單位數檢核(MSG)
           ,CASE WHEN TB_DATA.R_SHARES <= 0 THEN CAST(MSGINFO_RED004.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS R_SHARES_0_TYPE               -- 可買回單位數的小於等於零檢核
           ,CASE WHEN TB_DATA.R_SHARES <= 0 THEN CAST(MSGINFO_RED004.MSGCONTENT AS VARCHAR2(500))
                ELSE ''
            END AS R_SHARES_0_MSG                                   -- 可買回單位數的小於等於零檢核
           -- 2018.11.19 ChengYu修正轉申購最低金額檢查
           -- 2018.11.19 ChengYu 檢查是否低於最低轉申購金額檢核 BEGIN
           ,CASE WHEN TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(MSGINFO_TRS016.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_RED_AMOUNT_TYPE    --最低轉申購金額檢核(TYPE)
           ,CASE WHEN TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) < FUND.MIN_RED_AMOUNT
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_TRS016.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',TB_DATA.APPLICATION_SHARE),'{AMOUNT}',ROUND(TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0),FUND.AMT_DECIMAL)),'{MIN_RED_AMOUNT}',FUND.MIN_RED_AMOUNT) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_RED_AMOUNT_MSG     --最低轉申購金額檢核(MSG)
           -- 2018.11.19 ChengYu 檢查是否低於最低轉申購金額檢核 END
           -- 2018.11.26 ChengYu 最低轉入金額檢查
           -- 2018.11.26 ChengYu 最低轉入金額檢核新增判斷交易幣別
           -- 2018.11.28 JIANXIN 最低轉入金額檢核新增判斷交易幣別與匯率
           -- 2018.12.12 ChengYu 最低轉入金額檢核新增判斷是否為首次(轉)申購基金
           -- 2018.12.26 JIANXIN MOD BY 無論是全部贖回或者是部分贖回，都要檢查轉入金額檢查
           ,CASE WHEN WSTEP_TYPE = '3' AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) * CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN 1 ELSE TB_EX.EX_RATE END  < CASE WHEN PURCHASE.ID IS NULL THEN (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_INITIAL_PURCHASE ELSE FUND_IN.MIN_INITIAL_PURCHASE_NTD END)
                                                                                                                                                                                                                                       ELSE (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_AMOUNT ELSE FUND_IN.MIN_AMOUNT_NTD END)
                                                                                                                                                                                                                                  END
                 THEN CAST(MSGINFO_TRS017.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_PUR_AMOUNT_TYPE    --最低轉入金額檢核(TYPE)
           -- 2018.12.26 JIANXIN MOD BY 無論是全部贖回或者是部分贖回，都要檢查轉入金額檢查
           ,CASE WHEN WSTEP_TYPE = '3' AND TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) * CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN 1 ELSE TB_EX.EX_RATE END  < CASE WHEN PURCHASE.ID IS NULL THEN (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_INITIAL_PURCHASE ELSE FUND_IN.MIN_INITIAL_PURCHASE_NTD END)
                                                                                                                                                                                                                                       ELSE (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_AMOUNT ELSE FUND_IN.MIN_AMOUNT_NTD END)
                                                                                                                                                                                                                                  END
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_TRS017.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',TB_DATA.APPLICATION_SHARE),'{AMOUNT}',ROUND(TB_DATA.APPLICATION_SHARE * NVL(TB_NAV.NAV,0) * CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN 1 ELSE TB_EX.EX_RATE END ,0)),'{MIN_PUR_AMOUNT}',CASE WHEN PURCHASE.ID IS NULL THEN (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_INITIAL_PURCHASE ELSE FUND_IN.MIN_INITIAL_PURCHASE_NTD END)
                                                                                                                                                                                                                                                                                                                                                       ELSE (CASE WHEN TB_DATA.TRADE_CRNCY = FUND_IN.CURRENCY_NO THEN FUND_IN.MIN_AMOUNT ELSE FUND_IN.MIN_AMOUNT_NTD END)
                                                                                                                                                                                                                                                                                                                                                  END),'{CURRENCY_NAME}',V_FUND_CRNCY.NAME) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_PUR_AMOUNT_MSG     --最低轉入金額檢核(MSG)
           -- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
             ,CASE WHEN WSTEP_TYPE = '3' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND (TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) * NVL(TB_NAV.NAV,0) < FUND.MIN_BAL_AMOUNT
                 THEN CAST(MSGINFO_TRS019.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
            END AS MIN_RED_BAL_AMOUNT_TYPE    --最低轉出剩餘金額檢核(TYPE)
             ,CASE WHEN WSTEP_TYPE = '3' AND TB_DATA.APPLICATION_SHARE != TB_DATA.R_SHARES AND (TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) * NVL(TB_NAV.NAV,0) < FUND.MIN_BAL_AMOUNT
                 THEN CAST(REPLACE(REPLACE(REPLACE(REPLACE(MSGINFO_TRS019.MSGCONTENT,'{NAV}',NVL(TB_NAV.NAV,0)),'{APPLICATIONUNIT}',(TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE) ),'{AMOUNT}',ROUND((TB_DATA.R_SHARES-TB_DATA.APPLICATION_SHARE)  * NVL(TB_NAV.NAV,0),FUND.AMT_DECIMAL)),'{MIN_RED_AMOUNT}',FUND.MIN_BAL_AMOUNT) AS VARCHAR2(500))
                 ELSE ''
            END AS MIN_RED_BAL_AMOUNT_MSG     --最低轉出剩餘金額檢核(MSG)
           -- 2019.05.24 tingting 增加員工員眷不能轉申購同一母基金級別的基金檢查
           ,CASE WHEN XIS_EMP = 'Y' AND
                      AMC.EMP_CTL_CODE = 'Y' AND AMC_IN.EMP_CTL_CODE = 'Y' AND
                      FUND.FUND_MASTER_NO IS NOT NULL AND FUND_IN.FUND_MASTER_NO IS NOT NULL AND
                      FUND.FUND_MASTER_NO = FUND_IN.FUND_MASTER_NO
                 THEN CAST(MSGINFO_TRS020.MSGTYPE AS VARCHAR2(1))
                 ELSE ''
                 END AS EMP_TYPE     --員工員眷不能轉申購同一母基金級別的基金(TYPE)
           ,CASE WHEN XIS_EMP = 'Y' AND
                      AMC.EMP_CTL_CODE = 'Y' AND AMC_IN.EMP_CTL_CODE = 'Y' AND
                      FUND.FUND_MASTER_NO IS NOT NULL AND FUND_IN.FUND_MASTER_NO IS NOT NULL AND
                      FUND.FUND_MASTER_NO = FUND_IN.FUND_MASTER_NO
                 THEN CAST(REPLACE(REPLACE(MSGINFO_TRS020.MSGCONTENT,'{FUND_NO}',FUND.NAME),'{FUND_NO_IN}',FUND_IN.NAME) AS VARCHAR2(500))
                 ELSE ''
                 END AS EMP_MSG     --員工員眷不能轉申購同一母基金級別的基金(MSG)
      FROM (SELECT TB_TEMP2.VALUE1 AS FUND_CATEGORY                 -- 境內外識別碼
                   ,FUND_FUND_NO.FUND_NO AS FUND_NO                 -- 基金代碼
                   ,TO_DATE(TB_TEMP2.VALUE3,'YYYYMMDD') AS TX_DATE  -- 交易日期
                   ,TO_DATE(TB_TEMP2.VALUE4,'YYYYMMDD') AS AC_DATE  -- 淨值日日期
                   ,TO_NUMBER(TB_TEMP2.VALUE5) AS APPLICATION_SHARE -- 買回單位數
                   ,TO_NUMBER(TB_TEMP2.VALUE6) AS R_SHARES          -- 可買回單位數
                   ,'' AS TRADE_CRNCY                               -- 交易幣別
                   ,FUND_FUND_NO_IN.FUND_NO AS FUND_NO_IN           -- 轉入基金代碼
              FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))
                   )TB_TEMP2
              LEFT JOIN FAS.FUND FUND_FUND_NO     --以傳入基金代碼抓取基金代碼
                ON FUND_FUND_NO.FUND_NO = TB_TEMP2.VALUE2
              LEFT JOIN FAS.FUND FUND_FUND_NO_IN
                ON FUND_FUND_NO_IN.FUND_NO = TB_TEMP2.VALUE8
                -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '2'
             UNION
            SELECT  TB_TEMP3.VALUE1 AS FUND_CATEGORY                -- 境內外識別碼
                   ,FUND_FUND_NO.FUND_NO AS FUND_NO                 -- 基金代碼
                   ,TO_DATE(TB_TEMP3.VALUE3,'YYYYMMDD') AS TX_DATE  -- 交易日期
                   ,TO_DATE(TB_TEMP3.VALUE4,'YYYYMMDD') AS AC_DATE  -- 淨值日日期
                   ,TO_NUMBER(TB_TEMP3.VALUE5) AS APPLICATION_SHARE -- 買回單位數
                   ,TO_NUMBER(TB_TEMP3.VALUE6) AS R_SHARES          -- 可買回單位數
                   ,TB_TEMP3.VALUE11 AS TRADE_CRNCY                 -- 交易幣別
                   ,FUND_FUND_NO_IN.FUND_NO AS FUND_NO_IN           -- 轉入基金代碼
              FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))
                   )TB_TEMP3
              LEFT JOIN FAS.FUND FUND_FUND_NO     --以傳入基金代碼抓取基金代碼
                ON FUND_FUND_NO.FUND_NO = TB_TEMP3.VALUE2
              LEFT JOIN FAS.FUND FUND_FUND_NO_IN
                ON FUND_FUND_NO_IN.FUND_NO = TB_TEMP3.VALUE8
                -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
             WHERE WSTEP_TYPE = '3'
           )TB_DATA                   -- 對應 基金代碼 的傳入資料
      LEFT JOIN FAS.FUND FUND
        ON FUND.FUND_NO = TB_DATA.FUND_NO
      LEFT JOIN FAS.FUND FUND_IN
        ON FUND_IN.FUND_NO = TB_DATA.FUND_NO_IN
      -- 2018.11.19 ChengYu 檢查是否低於最低轉申購金額檢核
      LEFT JOIN (SELECT A.FUND_NO,MAX(B.NAV_DATE) NAV_DATE
                   FROM (SELECT FUND.FUND_NO AS FUND_NO       -- 基金代碼
                               ,REDEMLIST.TX_DATE AS TX_DATE  -- 交易日期
                         FROM (SELECT TB_TEMP.VALUE2 AS FUND_NO,TO_DATE(TB_TEMP.VALUE3,'YYYYMMDD') AS TX_DATE
                                 FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))) TB_TEMP
                                 -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                                WHERE WSTEP_TYPE = '2'
                               UNION
                               SELECT TB_TEMP.VALUE2 AS FUND_NO,TO_DATE(TB_TEMP.VALUE3,'YYYYMMDD') AS TX_DATE
                                 FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))) TB_TEMP
                                 -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                                WHERE WSTEP_TYPE = '3'
                              )REDEMLIST
                         LEFT JOIN FAS.FUND FUND    --以傳入基金代碼抓取基金代碼
                           ON FUND.FUND_NO = REDEMLIST.FUND_NO)A
                   JOIN NAV.NAV B
                     ON B.FUND_NO = A.FUND_NO
                  WHERE B.TX_DATE <= A.TX_DATE
                  GROUP BY A.FUND_NO
                ) TB_DATE   -- 取淨值檔檔最大日期
        ON TB_DATE.FUND_NO = FUND.FUND_NO
      LEFT JOIN NAV.NAV TB_NAV
        ON TB_NAV.FUND_NO = FUND.FUND_NO
       AND TB_NAV.NAV_DATE = TB_DATE.NAV_DATE
     -- 2018.11.28 JIANXIN 最低轉入金額檢核新增判斷交易幣別與匯率
     -- 2018.12.03 JIANXIN 匯率要取得轉出基金的匯率
      LEFT JOIN (SELECT V_CURRENCY_RATE.*
                   FROM FAS.V_CURRENCY_RATE
                   JOIN (  SELECT FUND_NO,MAX(TX_DATE) TX_DATE
                             FROM FAS.V_CURRENCY_RATE
                            GROUP BY FUND_NO
                         ) MAX_EX_RATE
                     ON V_CURRENCY_RATE.FUND_NO = MAX_EX_RATE.FUND_NO
                    AND V_CURRENCY_RATE.TX_DATE = MAX_EX_RATE.TX_DATE
                 ) TB_EX
        ON TB_EX.FUND_NO = TB_DATA.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = TB_DATA.TRADE_CRNCY
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
      -- 2018.12.12 ChengYu 調整最低轉入金額檢核效能
      LEFT JOIN (SELECT X.ID
                   FROM FAS.V_ALL_PURCHASE X
                   JOIN (SELECT FUND_FUND_NO_IN.FUND_NO AS FUND_NO_IN           -- 轉入基金代碼
                           FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))
                                )TB_TEMP2
                           LEFT JOIN FAS.FUND FUND_FUND_NO_IN
                             ON FUND_FUND_NO_IN.FUND_NO = TB_TEMP2.VALUE8
                             -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                          WHERE WSTEP_TYPE = '2'
                          UNION
                         SELECT FUND_FUND_NO_IN.FUND_NO AS FUND_NO_IN           -- 轉入基金代碼
                           FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))
                                )TB_TEMP3
                           LEFT JOIN FAS.FUND FUND_FUND_NO_IN
                             ON FUND_FUND_NO_IN.FUND_NO = TB_TEMP3.VALUE8
                             -- 2019.04.01 yunchu 修正基金不存在基金主檔檢核，因其他步驟列表為空字串造成的誤判
                          WHERE WSTEP_TYPE = '3'
                        )TB_DATA                   -- 對應 基金代碼 的傳入資料
                     ON TB_DATA.FUND_NO_IN = X.FUND_NO
                   JOIN FAS.HOLDER HOLDER
                     ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
                  WHERE X.ID = HOLDER.ID
                    AND ROWNUM = 1) PURCHASE
        ON PURCHASE.ID = HOLDER.ID
      LEFT JOIN FAS.AMC
        ON AMC.AMC_NO = FUND.AMC_NO
      LEFT JOIN FAS.AMC AMC_IN
        ON AMC_IN.AMC_NO = FUND_IN.AMC_NO
      LEFT JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER
        ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED004
        ON MSGINFO_RED004.MSGID = 'RED004'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED006
        ON MSGINFO_RED006.MSGID = 'RED006'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED007
        ON MSGINFO_RED007.MSGID = 'RED007'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED008
        ON MSGINFO_RED008.MSGID = 'RED008'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED009
        ON MSGINFO_RED009.MSGID = 'RED009'
      LEFT JOIN ECS.MSGINFO MSGINFO_RED011
        ON MSGINFO_RED011.MSGID = 'RED011'
      LEFT JOIN ECS.MSGINFO MSGINFO_TRS016
        ON MSGINFO_TRS016.MSGID = 'TRS016'
      LEFT JOIN ECS.MSGINFO MSGINFO_TRS017
        ON MSGINFO_TRS017.MSGID = 'TRS017'
      -- 2018.11.30 JIANXIN 新增贖回庫存最低金額檢查
      LEFT JOIN ECS.MSGINFO MSGINFO_TRS019
        ON MSGINFO_TRS019.MSGID = 'TRS019'
      LEFT JOIN ECS.MSGINFO MSGINFO_TRS020
        ON MSGINFO_TRS020.MSGID = 'TRS020'
     WHERE WSTEP_TYPE IN ('2','3');

   -- 2018.09.26 ChengYu增加轉申購單位數檢查
   -- 2021.01.14 Chengyu修正為當日轉申購金額上限語法
   --回傳當日轉申購單位數
   OPEN OUTDT4 FOR
   SELECT  TB_DATA.ID
          ,FUND.FUND_CATEGORY FUND_CATEGORY_OUT
          ,TB_DATA.FUND_NO_OUT
          ,TB_DATA.TX_DATE
          ,SUM(TB_DATA.APPLICATION_SHARE) AS SUM_APPLICATION_SHARE
          ,SYSTEM_PARAMETER.ON_SWITCH_AMOUNT_LIMIT         --境內同客戶同交易日總轉申購金額上限
          ,SYSTEM_PARAMETER.OFF_SWITCH_AMOUNT_LIMIT        --境外同客戶同交易日總轉申購金額上限
     FROM (
           SELECT  REDEMPTION.ID
                  ,REDEMPTION.FUND_NO FUND_NO_OUT
                  ,REDEMPTION.TX_DATE
                  ,APPLICATION_SHARE
             FROM ECS.REDEMPTION
             LEFT JOIN FAS.HOLDER
               ON HOLDER.ID = REDEMPTION.ID
             JOIN (
                   SELECT TO_DATE(TB_TEMP2.VALUE3,'YYYYMMDD') AS TX_DATE        -- 贖回交易日
                     FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))
                          )TB_TEMP2
                    WHERE WSTEP_TYPE = '2'
                    UNION
                   SELECT TO_DATE(TB_TEMP3.VALUE3,'YYYYMMDD') AS TX_DATE        -- 贖回交易日
                     FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))
                          )TB_TEMP3
                    WHERE WSTEP_TYPE = '3'
                  ) FUND_OUT_DATA
               ON REDEMPTION.TX_DATE = TRUNC(FUND_OUT_DATA.TX_DATE)             
            WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO
              AND REDEMPTION.BROKER_NO = '999'
              AND REDEMPTION.BRANCH_NO = '8300'
              AND WSTEP_TYPE IN ('2','3')
            UNION ALL
           SELECT HOLDER.ID
                  ,TB_DATA.FUND_NO FUND_NO_OUT
                  ,TB_DATA.TX_DATE
                  ,APPLICATION_SHARE AS APPLICATION_SHARE
             FROM (SELECT TB_TEMP2.VALUE1 AS FUND_CATEGORY                 -- 境內外識別碼
                          ,FUND.FUND_NO AS FUND_NO                         -- 基金代碼
                          ,TO_DATE(TB_TEMP2.VALUE3,'YYYYMMDD') AS TX_DATE  -- 交易日期
                          ,TO_NUMBER(TB_TEMP2.VALUE5) AS APPLICATION_SHARE -- 買回單位數
                     FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))
                          )TB_TEMP2
                     LEFT JOIN FAS.FUND FUND     --以傳入基金代碼抓取基金代碼
                       ON FUND.FUND_NO = TB_TEMP2.VALUE2
                    WHERE WSTEP_TYPE = '2'
                    UNION
                   SELECT  TB_TEMP3.VALUE1 AS FUND_CATEGORY                -- 境內外識別碼
                          ,FUND.FUND_NO AS FUND_NO                         -- 基金代碼
                          ,TO_DATE(TB_TEMP3.VALUE3,'YYYYMMDD') AS TX_DATE  -- 交易日期
                          ,TO_NUMBER(TB_TEMP3.VALUE5) AS APPLICATION_SHARE -- 買回單位數
                     FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))
                          )TB_TEMP3
                     LEFT JOIN FAS.FUND FUND             --以傳入基金代碼抓取基金代碼
                       ON FUND.FUND_NO = TB_TEMP3.VALUE2
                    WHERE WSTEP_TYPE = '3'
                   )TB_DATA
              LEFT JOIN FAS.HOLDER
                ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
          ) TB_DATA   
     JOIN FAS.FUND
       ON FUND.FUND_NO = TB_DATA.FUND_NO_OUT
     JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER
       ON SYSTEM_PARAMETER.SYSTEM_ID = 'ECS'
    GROUP BY TB_DATA.ID,TB_DATA.FUND_NO_OUT,TB_DATA.TX_DATE
          ,SYSTEM_PARAMETER.ON_SWITCH_AMOUNT_LIMIT
          ,SYSTEM_PARAMETER.OFF_SWITCH_AMOUNT_LIMIT
          ,FUND.FUND_CATEGORY;

    DELETE FROM ECS.SHOPCAR_TRADE_TEMP;
    DELETE FROM ECS.SHOPCAR_ERR_TEMP;

END ;

/

  GRANT EXECUTE ON "ECS"."S_CHECKSWITCHDATA_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECKSWITCHDATA_INSERT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECKSWITCHDATA_INSERT" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/08/10
-- Description: 檢查轉換交易資料(新增進TMP)
-- 2018.11.14 ChengYu 新增傳入參數IS_WRITE_KYC、KYC_RISK_LEVEL條件判斷
-- 2018.11.15 ChengYu 修正KYC檢核的日期格式、修正步驟1傳入參數TX_DATE格式
-- 2018.11.26 ChengYu STEP3  新增傳入參數 優惠方案(FEE_CHOICE)、 促銷活動代碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
-- =============================================
(
    WACCOUNT_NO     INTEGER,            --受益人戶號
    WIS_ROBO        VARCHAR2,           --是否為Robo單
    WIP_ADR         VARCHAR2,           --IP位址
    WSTEP_TYPE      VARCHAR2,           --交易步驟
    WSWITCHLIST1    VARCHAR2,           --SWITCHLIST1 STEP 1 購物車列表
    WSWITCHLIST2    VARCHAR2,           --SWITCHLIST2 STEP 2 購物車列表
    WSWITCHLIST3    VARCHAR2,           --SWITCHLIST3 STEP 3 購物車列表

    OUTDT           OUT SYS_REFCURSOR   --回傳table            
)
IS
BEGIN    

    IF WSTEP_TYPE = '1' THEN
      BEGIN        
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                ACCOUNT_NO
               ,TX_TYPE
               ,KYC_RISK_LEVEL
               -- 2018.11.14 ChengYu 新增傳入參數IS_WRITE_KYC、KYC_RISK_LEVEL條件判斷
               ,IS_WRITE_KYC
               ,REDEM_FUND
               ,STEP_TYPE
               ,IS_ROBO
             )
        SELECT  WACCOUNT_NO          AS ACCOUNT_NO
               ,'4'                  AS TX_TYPE
               -- 2018.11.14 ChengYu 新增傳入參數IS_WRITE_KYC、KYC_RISK_LEVEL條件判斷
               ,''                   AS KYC_RISK_LEVEL
               -- 2018.11.15 ChengYu 修正KYC檢核的日期格式、修正步驟1傳入參數TX_DATE格式
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     WHEN HOLDER.RISK_STATUS = '2' THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN 'N'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN 'Y'
                     ELSE ''
                END AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO      AS FUND_NO
               ,'1'                  AS STEP_TYPE
               ,WIS_ROBO             AS IS_ROBO
          FROM (SELECT  TB_TEMP.VALUE1 AS FUND_NO
                       --,TB_TEMP.VALUE2 AS R_SHARES
                       -- 2018.11.15 ChengYu 修正KYC檢核的日期格式、修正步驟1傳入參數TX_DATE格式
                       ,TO_DATE(TB_TEMP.VALUE3,'YYYYMMDD') AS TX_DATE
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST1))) TB_TEMP
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;      
      END;
    END IF;

    IF WSTEP_TYPE = '2' THEN
      BEGIN
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                 ACCOUNT_NO
                ,TX_TYPE
                ,KYC_RISK_LEVEL
                ,IS_WRITE_KYC
                ,REDEM_FUND
                ,FUND_NO      
                ,TX_DATE          
                ,STEP_TYPE
                ,IS_ROBO
             )
        SELECT  WACCOUNT_NO                  AS ACCOUNT_NO
               ,'4'                          AS TX_TYPE
               -- 2018.11.14 ChengYu 新增傳入參數IS_WRITE_KYC、KYC_RISK_LEVEL條件判斷
               -- 2018.11.15 ChengYu 修正KYC檢核的日期格式、修正步驟1傳入參數TX_DATE格式
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     WHEN HOLDER.RISK_STATUS = '2' THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     ELSE HOLDER.RISK_LEVEL
                END                          AS KYC_RISK_LEVEL              
               ,''                           AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO              AS REDEM_FUND
               ,TB_DATA.FUND_NO_IN           AS FUND_NO
               ,TB_DATA.SWITCH_DATE          AS TX_DATE
               ,'2'                          AS STEP_TYPE
               ,WIS_ROBO                     AS IS_ROBO
          FROM (SELECT  TB_TEMP.VALUE2 AS FUND_NO
                       ,TB_TEMP.VALUE8 AS FUND_NO_IN
                       ,TO_DATE(TB_TEMP.VALUE3,'YYYYMMDD') AS TX_DATE
                       ,TO_DATE(TB_TEMP.VALUE10,'YYYYMMDD') AS SWITCH_DATE
                       --TB_TEMP.VALUE1 AS FUND_CATEGORY
                       --,TO_DATE(TB_TEMP.VALUE4,'YYYYMMDD') AS AC_DATE
                       --,TB_TEMP.VALUE5 AS APPLICATION_SHARE
                       --,TB_TEMP.VALUE6 AS R_SHARES
                       --,TB_TEMP.VALUE7 AS FUND_CATEGORY_IN
                       --,TB_TEMP.VALUE9 AS CURRENCY_NO
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST2))) TB_TEMP
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    END IF;

    IF WSTEP_TYPE = '3' THEN
      BEGIN
        INSERT INTO ECS.SHOPCAR_TRADE_TEMP
             (
                 ACCOUNT_NO
                ,TX_TYPE
                ,KYC_RISK_LEVEL
                ,IS_WRITE_KYC
                ,REDEM_FUND
                ,REDEM_TX_DATE
                ,FUND_NO       
                ,TX_DATE
                ,STEP_TYPE
                ,IS_ROBO
                -- 2018.11.26 ChengYu STEP3  新增傳入參數 優惠方案(FEE_CHOICE)、 促銷活動代碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                ,TRADE_CRNCY
                ,FEE_CHOICE
                ,PROJECT_CODE
                ,COUPON_ID
                ,USED_POINT
             )
        SELECT  WACCOUNT_NO                  AS ACCOUNT_NO
               ,'4'                          AS TX_TYPE
               -- 2018.11.14 ChengYu 新增傳入參數IS_WRITE_KYC、KYC_RISK_LEVEL條件判斷
               -- 2018.11.15 ChengYu 修正KYC檢核的日期格式、修正步驟1傳入參數TX_DATE格式
               ,CASE WHEN HOLDER.RISK_STATUS = '0' THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TRUNC(HOLDER.RISK_WRITE_DATE) > TB_DATA.TX_DATE THEN '0'
                     WHEN HOLDER.RISK_STATUS = '1' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     WHEN HOLDER.RISK_STATUS = '2' THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE <= TRUNC(HOLDER.RISK_MAT_DATE) THEN '3'
                     WHEN HOLDER.RISK_STATUS = '3' AND TB_DATA.TX_DATE > TRUNC(HOLDER.RISK_MAT_DATE) THEN '1'
                     ELSE HOLDER.RISK_LEVEL
                END                          AS KYC_RISK_LEVEL 
               ,''                           AS IS_WRITE_KYC
               ,TB_DATA.FUND_NO              AS REDEM_FUND
               ,TB_DATA.TX_DATE              AS REDEM_TX_DATE
               ,TB_DATA.FUND_NO_IN           AS FUND_NO
               ,TB_DATA.SWITCH_DATE          AS TX_DATE
               ,'3'                          AS STEP_TYPE
               ,WIS_ROBO                     AS IS_ROBO
               -- 2018.11.26 ChengYu STEP3  新增傳入參數 交易幣別(TRADE_CRNCY)、優惠方案(FEE_CHOICE)、 促銷活動代碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
               ,TB_DATA.TRADE_CRNCY          AS TRADE_CRNCY
               ,TB_DATA.FEE_CHOICE           AS FEE_CHOICE
               ,TB_DATA.PROJECT_CODE         AS PROJECT_CODE
               ,TB_DATA.COUPON_ID            AS COUPON_ID
               ,TB_DATA.USED_POINT           AS USED_POINT
          FROM (SELECT  TB_TEMP.VALUE2 AS FUND_NO                    
                       ,TO_DATE(TB_TEMP.VALUE3,'YYYYMMDD') AS TX_DATE
                       ,TB_TEMP.VALUE8 AS FUND_NO_IN
                       ,TO_DATE(TB_TEMP.VALUE10,'YYYYMMDD') AS SWITCH_DATE
                       -- 2018.11.26 ChengYu STEP3  新增傳入參數 交易幣別(TRADE_CRNCY)、優惠方案(FEE_CHOICE)、 促銷活動代碼(PROJECT_CODE)、優惠券代碼(COUPON_ID)、使用紅利點數(USED_POINT)
                       ,TB_TEMP.VALUE11 AS TRADE_CRNCY
                       ,TB_TEMP.VALUE12 AS FEE_CHOICE
                       ,TB_TEMP.VALUE13 AS PROJECT_CODE
                       ,TB_TEMP.VALUE14 AS COUPON_ID
                       ,TO_NUMBER(TB_TEMP.VALUE15) AS USED_POINT
                       --,TB_TEMP.VALUE1 AS FUND_CATEGORY
                       --,TO_DATE(TB_TEMP.VALUE4,'YYYYMMDD') AS AC_DATE
                       --,TB_TEMP.VALUE5 AS APPLICATION_SHARE
                       --,TB_TEMP.VALUE6 AS R_SHARES
                       --,TB_TEMP.VALUE7 AS FUND_CATEGORY_IN
                       --,TB_TEMP.VALUE9 AS CURRENCY_NO                       
                  FROM (TABLE(ECS.F_FormatStringListToTable(WSWITCHLIST3))) TB_TEMP
               )TB_DATA
          LEFT JOIN FAS.HOLDER HOLDER
            ON HOLDER.ACCOUNT_NO = WACCOUNT_NO;
      END;
    END IF;    

    OPEN OUTDT FOR
    SELECT 'Y' AS IS_SUCCESS
      FROM DUAL;

END ;

/

  GRANT EXECUTE ON "ECS"."S_CHECKSWITCHDATA_INSERT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CHECK_ANNOUNCE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CHECK_ANNOUNCE" 
-- =============================================
-- Author:      Jianxin
-- Create date: 2019/04/01
-- Description: 三億警示檢查
-- 2024.06.03 ESTWCORE-607 Richard 將母基金最低限制金額統一換為台幣
-- 2025.08.19 JIANXIN 寫入TEMP TABLE 前要先刪除資料
-- =============================================
(
     WFUND_NO     VARCHAR2             -- 基金代碼
    ,WTX_DATE     DATE
    ,OUTDT        OUT SYS_REFCURSOR    -- 回傳table
    ,OUTDT2       OUT SYS_REFCURSOR    -- 回傳的 TABLEDATA

) IS

XFUND_MASTER_NO VARCHAR2(10);
XNET_ASSET NUMBER(15,2);
XCNT INTEGER ;

BEGIN


  -- 1. 找到母基金  
  SELECT FUND_MASTER_NO
    INTO XFUND_MASTER_NO
    FROM FAS.FUND 
   WHERE FUND_NO = WFUND_NO;

  -- 2. 母基金底下的所有子基金
  -- 2025.08.19 JIANXIN 寫入TEMP TABLE 前要先刪除資料
  DELETE FROM ECS.FUNDLIST;              --清除TABLE所有資料
  INSERT INTO ECS.FUNDLIST
    (FUND_NO , REC_TYPE ,TX_DATE ,NAV_DATE)
   SELECT FUND.FUND_NO
          ,'' REC_TYPE
          ,FUND.AC_DATE  TX_DATE  -- 下一結帳日
          ,FUND.AC_DATE  NAV_DATE -- 下一結帳日
     FROM FAS.FUND 
    WHERE FUND.FUND_MASTER_NO = XFUND_MASTER_NO;


  --3. 取得淨值
  -- 2025.08.19 JIANXIN 寫入TEMP TABLE 前要先刪除資料
  DELETE FROM ECS.NAV_DATE_TEMP;              --清除TABLE所有資料
  INSERT INTO ECS.NAV_DATE_TEMP
       (
          FUND_NO
         ,NAV_DATE
         ,TX_DATE
         ,NAV
         ,CHANGE
         ,BAL_SHARE
         ,NET_ASSET
       )
  SELECT B.FUND_NO
         ,B.NAV_DATE
         ,B.TX_DATE
         ,B.NAV
         ,B.CHANGE
         ,B.BAL_SHARE
         ,B.NET_ASSET
    FROM NAV.NAV B
    JOIN (SELECT NAV.FUND_NO, MAX(NAV.NAV_DATE) AS NAV_DATE
            FROM NAV.NAV
            JOIN ECS.FUNDLIST FUND
              ON NAV.FUND_NO = FUND.FUND_NO
             AND NAV.NAV_DATE <= WTX_DATE  
           GROUP BY NAV.FUND_NO) A
      ON A.FUND_NO = B.FUND_NO
     AND A.NAV_DATE = B.NAV_DATE;

  -- 4. 母基金底下的所有子基金的淨資產
  SELECT SUM(NET_ASSET) AS NET_ASSET
    INTO XNET_ASSET
    FROM ( SELECT NAV_DATE_TEMP.FUND_NO 
                 ,NAV_DATE_TEMP.NAV_DATE
                 ,ROUND(NAV_DATE_TEMP.NET_ASSET * NVL(V_CURRENCY_RATE.EX_RATE,1),2) AS NET_ASSET 
            FROM (SELECT  A.FUND_NO 
                         ,MAX(V_CURRENCY_RATE.TX_DATE) AS TX_DATE
                    FROM FAS.V_CURRENCY_RATE V_CURRENCY_RATE
                    JOIN ECS.NAV_DATE_TEMP A
                      ON A.FUND_NO = V_CURRENCY_RATE.FUND_NO
                     AND V_CURRENCY_RATE.TX_DATE <= WTX_DATE
                   GROUP BY A.FUND_NO ) MAX_CURRENCY_RATE
            JOIN FAS.V_CURRENCY_RATE
              ON MAX_CURRENCY_RATE.FUND_NO = V_CURRENCY_RATE.FUND_NO
             AND MAX_CURRENCY_RATE.TX_DATE = V_CURRENCY_RATE.TX_DATE
            JOIN ECS.NAV_DATE_TEMP
              ON V_CURRENCY_RATE.FUND_NO = NAV_DATE_TEMP.FUND_NO
         ) A;


  -- 5. 庫存人數
  SELECT COUNT(1) AS NUM          -- 有庫存的人數
    INTO XCNT
    FROM (SELECT DISTINCT CERTIFICATE.ID 
            FROM ECS.FUNDLIST
            JOIN FAS.CERTIFICATE CERTIFICATE
              ON CERTIFICATE.FUND_NO = FUNDLIST.FUND_NO 
            JOIN FAS.FUND
              ON FUND.FUND_NO = FUNDLIST.FUND_NO 
           WHERE CERTIFICATE.STATUS = 1
             AND CERTIFICATE.SHARES > 0
             AND FUND.INCEPTION_DATE IS NOT NULL
             AND FUND.INCEPTION_DATE < FUNDLIST.NAV_DATE
             AND (FUND.CLEAR_DATE IS NULL OR FUND.CLEAR_DATE >= WTX_DATE)
         ) CERTIFICATE;


   OPEN OUTDT FOR
   SELECT  XCNT AS CNT
          ,XNET_ASSET AS NET_ASSET
          /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣
          ,CASE WHEN FUND_MASTER.ANNOUNCE_LEVEL > XNET_ASSET */
          ,CASE WHEN (FUND_MASTER.ANNOUNCE_LEVEL * FAS.F_V_CRNCY_RATE(FUND_MASTER.FUND_MASTER_NO,WTX_DATE)) > XNET_ASSET
          /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                THEN 'N' 
                ELSE 'Y' 
            END AS IS_SUCCESS
          /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣
          ,CASE WHEN FUND_MASTER.ANNOUNCE_LEVEL > XNET_ASSET */
          ,CASE WHEN (FUND_MASTER.ANNOUNCE_LEVEL * FAS.F_V_CRNCY_RATE(FUND_MASTER.FUND_MASTER_NO,WTX_DATE)) > XNET_ASSET
          /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                THEN MSGTYPE 
                ELSE '' 
            END AS WARNS_TYPE
          /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣
          ,CASE WHEN FUND_MASTER.ANNOUNCE_LEVEL > XNET_ASSET */
          ,CASE WHEN (FUND_MASTER.ANNOUNCE_LEVEL * FAS.F_V_CRNCY_RATE(FUND_MASTER.FUND_MASTER_NO,WTX_DATE)) > XNET_ASSET
          /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                THEN 
                     /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣*/
                     REPLACE(
                     /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                         REPLACE(
                             REPLACE(
                                     REPLACE(
                                             REPLACE(
                                                     REPLACE(MSGINFO.MSGCONTENT,'{FUND_NAME}',FUND.NAME)
                                                     ,'{ANNOUNCE_LEVEL}',TO_CHAR(FUND_MASTER.ANNOUNCE_LEVEL,'FM999,999,999,990')
                                                    )
                                              ,'{NAV_DATE}',TO_CHAR(NAV_DATE_TEMP.NAV_DATE,'YYYY/MM/DD')
                                             )
                                      /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣
                                      ,'{NET_ASSET}',TO_CHAR(NVL(XNET_ASSET,0),'FM999,999,999,999,990')*/
                                      ,'{NET_ASSET}',TO_CHAR(NVL(XNET_ASSET,0)/FAS.F_V_CRNCY_RATE(FUND_MASTER.FUND_MASTER_NO,WTX_DATE),'FM999,999,999,999,990')
                                      /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                                     )
                              ,'{COUNT}',NVL(XCNT,0)
                             )
                        /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣*/
                        ,'{CURRENCY_NAME}',CURR.NAME)
                        /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
                ELSE '' 
            END AS ERROR_MSG
     FROM FAS.FUND
     JOIN FAS.FUND_MASTER
       ON FUND_MASTER.FUND_MASTER_NO = FUND.FUND_MASTER_NO
     JOIN ECS.NAV_DATE_TEMP 
       ON NAV_DATE_TEMP.FUND_NO = FUND.FUND_NO
    CROSS JOIN (SELECT MSGTYPE,MSGCONTENT FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'SPC047') MSGINFO
    /*2024.06.03 ESTWCORE-607 begin Richard 將母基金最低限制金額統一換為台幣*/
    INNER JOIN FAS.CURRENCY CURR ON CURR.CURRENCY_NO = (SELECT FUND.CURRENCY_NO FROM FAS.FUND FUND WHERE FUND.FUND_NO = FAS.FUND_MASTER.FUND_MASTER_NO)
    /*2024.06.03 ESTWCORE-607 end Richard 將母基金最低限制金額統一換為台幣*/
    WHERE FUND.FUND_NO = WFUND_NO ;

    OPEN OUTDT2 FOR
    SELECT * FROM ECS.NAV_DATE_TEMP;


END S_CHECK_ANNOUNCE;

/

  GRANT EXECUTE ON "ECS"."S_CHECK_ANNOUNCE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CREATEBATCHJOBLOG
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CREATEBATCHJOBLOG" (
  BATCHNO IN NUMBER,
  PROCESSSTATUS IN CHAR,
  PROCESSCONTENT IN VARCHAR2,
  ERRORMSG NCLOB 
) 
IS
BEGIN

INSERT INTO BATCHJOBLOG (
  BATCHNO,LOGTIME,PROCESSSTATUS,PROCESSCONTENT,ERRORMSG 
) VALUES (
  BATCHNO,SYSDATE,PROCESSSTATUS,PROCESSCONTENT,ERRORMSG 
);

END S_CREATEBATCHJOBLOG;

/

  GRANT EXECUTE ON "ECS"."S_CREATEBATCHJOBLOG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CREATEBATCHJOBPROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CREATEBATCHJOBPROCESS" (
V_BATCHDATE IN DATE,
V_BATCHJOBCODE IN NVARCHAR2,
V_BATCHJOBNAME IN NVARCHAR2,
V_JOBSTARTTIME IN DATE,
V_JOBPRERECORDS IN NUMBER,
V_JOBMSG IN NCLOB,
V_IDENTITY IN OUT NUMBER
) 
IS

V_ID NUMBER;

BEGIN
  INSERT INTO BATCHJOBPROCESS (
    BATCHDATE,BATCHJOBCODE,BATCHJOBNAME,JOBSTARTTIME,JOBENDTIME
   ,JOBSTATUS,JOBPRERECORDS,JOBACTRECORDS,JOBRUNTIME,JOBMSG
  )VALUES(
    V_BATCHDATE,V_BATCHJOBCODE,V_BATCHJOBNAME,V_JOBSTARTTIME,NULL
   ,1,V_JOBPRERECORDS,0,NULL,V_JOBMSG
  )
  RETURNING BATCHNO INTO V_ID; 
  SELECT V_ID INTO V_IDENTITY FROM DUAL;
END S_CREATEBATCHJOBPROCESS;

/

  GRANT EXECUTE ON "ECS"."S_CREATEBATCHJOBPROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CREATE_MEDIA_FILENAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CREATE_MEDIA_FILENAME" 
-- =============================================
-- Author:stu
-- Create date: 2008/08/12
-- Description:編制媒體檔案名稱	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
-- =============================================
(
         WTRP_TYPE    VARCHAR2   --連外介面平台種類代碼
        ,WMEDIA_NO    VARCHAR2   --傳檔媒體編號
        ,WBATCH_ID    VARCHAR2   --批次識別碼(每批不可重覆)
        ,WBATCH_SRNO  NUMBER     --次批號
        ,WSEAL_TYPE   VARCHAR2   --扣款途徑 1.一般 2.ACH  3.財金
        ,WAGENT_BANK  VARCHAR2   --代理銀行(總行)
        ,WSOURCE_CD   VARCHAR2   --來源 (1:台幣核印  2:台幣扣款  3:外幣核印  4:外幣扣款)
)
IS

XFILE_EXT_ID      VARCHAR2(10);   --副檔名
XTEXT_SUB_PATH    VARCHAR2(40);    --子目錄
XPARA_ID          VARCHAR2(10);

BEGIN

  XFILE_EXT_ID := '';
  XTEXT_SUB_PATH := '';

  SELECT FILE_EXT_ID 
    INTO XFILE_EXT_ID
    FROM TRP001
   WHERE TRP_TYPE = WTRP_TYPE 
     AND MEDIA_NO = WMEDIA_NO;

  IF WSEAL_TYPE = '1' THEN 
    XPARA_ID := WAGENT_BANK;
  ELSIF WSEAL_TYPE = '2' THEN
    XPARA_ID := 'ACH';
  ELSE
    XPARA_ID := 'FIS';    
  END IF;

  SELECT PARAMETER1 
    INTO XTEXT_SUB_PATH
    FROM OFD700
   WHERE BANK_HQ = WAGENT_BANK 
     AND SEAL_TYPE = WSEAL_TYPE 
     -- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
     AND FUND_ID = 'ALL' 
     AND PARA_ID = XPARA_ID || 'M' || WSOURCE_CD;

  IF XFILE_EXT_ID IS NOT NULL  THEN 
    XFILE_EXT_ID := '.' || XFILE_EXT_ID;    
  END IF;

  INSERT INTO ECS.TRP00A 
         (BATCH_ID,BATCH_SRNO,TEXT_FILENAME, TEXT_SUB_PATH)
  VALUES (WBATCH_ID,WBATCH_SRNO,WBATCH_ID || ECS.PADLeft(TO_CHAR(WBATCH_SRNO),4,'0') ||  XFILE_EXT_ID , XTEXT_SUB_PATH);

END s_Create_Media_FileName;

/

  GRANT EXECUTE ON "ECS"."S_CREATE_MEDIA_FILENAME" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CREATE_MEDIA_FILENAME_CRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CREATE_MEDIA_FILENAME_CRY" 
-- =============================================
-- Author:stu
-- Create date: 2008/08/12
-- Description:編制媒體檔案名稱	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
-- =============================================
(
         WTRP_TYPE      VARCHAR2   --連外介面平台種類代碼
        ,WMEDIA_NO      VARCHAR2   --傳檔媒體編號
        ,WBATCH_ID      VARCHAR2   --批次識別碼(每批不可重覆)
        ,WBATCH_SRNO    NUMBER     --次批號
        ,WSEAL_TYPE     VARCHAR2   --扣款途徑 1.一般 2.ACH  3.財金
        ,WAGENT_BANK    VARCHAR2   --代理銀行(總行)
        ,WSOURCE_CD     VARCHAR2   --來源 (1:台幣核印  2:台幣扣款  3:外幣核印  4:外幣扣款)
        ,WTX_CURRENCY   VARCHAR2   --交易幣別
)
IS

XFILE_EXT_ID      VARCHAR2(10);   --副檔名
XTEXT_SUB_PATH    VARCHAR2(40);    --子目錄
XPARA_ID          VARCHAR2(10);

BEGIN

  XFILE_EXT_ID := '';
  XTEXT_SUB_PATH := '';

  SELECT FILE_EXT_ID 
    INTO XFILE_EXT_ID
    FROM TRP001
   WHERE TRP_TYPE = WTRP_TYPE 
     AND MEDIA_NO = WMEDIA_NO;

  IF WSEAL_TYPE = '1' THEN 
    XPARA_ID := WAGENT_BANK;
  ELSIF WSEAL_TYPE = '2' THEN
    XPARA_ID := 'ACH';
  ELSE
    XPARA_ID := 'FIS';    
  END IF;

  SELECT PARAMETER1 
    INTO XTEXT_SUB_PATH
    FROM OFD700
   WHERE BANK_HQ = WAGENT_BANK 
     AND SEAL_TYPE = WSEAL_TYPE 
     -- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
     AND FUND_ID = 'ALL' 
     AND PARA_ID = XPARA_ID || 'M' || WSOURCE_CD;

  IF XFILE_EXT_ID IS NOT NULL  THEN 
    XFILE_EXT_ID := '.' || XFILE_EXT_ID;    
  END IF;

  INSERT INTO ECS.TRP00A 
         (BATCH_ID,BATCH_SRNO,TEXT_FILENAME, TEXT_SUB_PATH)
  VALUES (WBATCH_ID,WBATCH_SRNO,WBATCH_ID || TO_CHAR(WBATCH_SRNO)||'_' || WTX_CURRENCY || XFILE_EXT_ID , XTEXT_SUB_PATH);

END s_Create_Media_FileName_Cry;

/

  GRANT EXECUTE ON "ECS"."S_CREATE_MEDIA_FILENAME_CRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_CREATE_MEDIA_FILENAME_FNDCRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_CREATE_MEDIA_FILENAME_FNDCRY" 
-- =============================================
-- Author:JIANXIN
-- Create date: 2019/08/13
-- Description:扣款處理	
-- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
-- =============================================
(
         WTRP_TYPE      VARCHAR2   --連外介面平台種類代碼
        ,WMEDIA_NO      VARCHAR2   --傳檔媒體編號
        ,WBATCH_ID      VARCHAR2   --批次識別碼(每批不可重覆)
        ,WBATCH_SRNO    NUMBER     --次批號
        ,WSEAL_TYPE     VARCHAR2   --扣款途徑 1.一般 2.ACH  3.財金
        ,WAGENT_BANK    VARCHAR2   --代理銀行(總行)
        ,WSOURCE_CD     VARCHAR2   --來源 (1:台幣核印  2:台幣扣款  3:外幣核印  4:外幣扣款)
        ,WTX_CURRENCY   VARCHAR2   --交易幣別
)
IS

XFILE_EXT_ID      VARCHAR2(10);   --副檔名
XTEXT_SUB_PATH    VARCHAR2(40);    --子目錄
XPARA_ID          VARCHAR2(10);

BEGIN

  XFILE_EXT_ID := '';
  XTEXT_SUB_PATH := '';

  SELECT FILE_EXT_ID 
    INTO XFILE_EXT_ID
    FROM TRP001
   WHERE TRP_TYPE = WTRP_TYPE 
     AND MEDIA_NO = WMEDIA_NO;

  IF WSEAL_TYPE = '1' THEN 
    XPARA_ID := WAGENT_BANK;
  ELSIF WSEAL_TYPE = '2' THEN
    XPARA_ID := 'ACH';
  ELSE
    XPARA_ID := 'FIS';    
  END IF;

  SELECT PARAMETER1 
    INTO XTEXT_SUB_PATH
    FROM OFD700
   WHERE BANK_HQ = WAGENT_BANK 
     AND SEAL_TYPE = WSEAL_TYPE 
     -- 2019.08.15 ChengYu 基金代碼 ALL FUNDS 調整為 ALL
     AND FUND_ID = 'ALL' 
     AND PARA_ID = XPARA_ID || 'M' || WSOURCE_CD;

  IF XFILE_EXT_ID IS NOT NULL  THEN 
    XFILE_EXT_ID := '.' || XFILE_EXT_ID;    
  END IF;

  INSERT INTO ECS.TRP00A 
         (BATCH_ID,BATCH_SRNO,TEXT_FILENAME, TEXT_SUB_PATH)
  VALUES (WBATCH_ID,WBATCH_SRNO,WBATCH_ID || TO_CHAR(WBATCH_SRNO)||'_' || WTX_CURRENCY || XFILE_EXT_ID , XTEXT_SUB_PATH);

END s_Create_Media_FileName_FndCry;

/

  GRANT EXECUTE ON "ECS"."S_CREATE_MEDIA_FILENAME_FNDCRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS" 
-- =============================================
-- Author:stu
-- Create date: 2008/09/11
-- Description:扣款處理	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- =============================================
(
         WEXEC_USERID     VARCHAR2              --執行人員
        ,WBATCH_ID        VARCHAR2              --批次識別碼(每批不可重覆)
        ,WJOB_ID          VARCHAR2              --工作別 2.扣款  4.重出扣款文字檔  6.取消該批扣款
        ,WSEAL_TYPE       VARCHAR2              --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2              --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   VARCHAR2              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2              --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2              --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2              --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2              --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2              --是否含扣款失敗資料  Y.含  N.不含 O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER                --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2              --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2              --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2              --檔名命名方式\1.由前端指定  2.
        ,WFAIL_CODE       VARCHAR2              --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2              --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2             --訊息：存放錯誤訊息
)
IS 

XACT_DDCT_DATE DATE := TO_DATE(WACT_DDCT_DATE,'YYYYMMDD');

BEGIN

   IF WJOB_ID = '2'  THEN --扣款

     ECS.s_DeductAmt_Process_2 ( WEXEC_USERID        --執行人員
                                ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                ,WBUSS_ID            --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
                                ,XACT_DDCT_DATE      --實際扣款日期
                                ,WAGENT_BANK         --代理銀行(總行)
                                ,WISAGENTBANK        --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
                                ,WISFUND             --指定基金 0.全部  9.指定
                                ,WFUND_ID            --指定基金代碼
                                ,WISINCLUDEFAIL      --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
                                ,WMAX_FILE_COUNT     --文字檔筆數限制 (0 表示無限制)
                                ,WTRP_TYPE           --連外介面平台種類代碼
			                             ,WMEDIA_NO           --傳檔媒體編號
			                             ,WFILE_NAMING_WAY    --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
                                ,WFAIL_CODE          --扣款錯誤代碼LIST
                                ,WIsSuccess          --成功否：Y.成功  N.失敗
                                ,WMSG                --訊息：存放錯誤訊息
                               );

   ELSIF WJOB_ID = '4' THEN--重出扣款文字檔

       WIsSuccess := 'Y';
       WMSG := '';

   ELSIF WJOB_ID = '6' THEN  --取消該批扣款(該批扣款中不可有扣款狀態不為"扣款中"的資料)

     ECS.s_DeductAmt_Process_6 ( WEXEC_USERID        --執行人員
                                ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                ,WIsSuccess          --成功否：Y.成功  N.失敗
                                ,WMSG                --訊息：存放錯誤訊息
                               );
   END IF ; 

END s_DeductAmt_Process;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_2" 
-- =============================================
-- Author:stu
-- Create date: 2008/09/11
-- Description:扣款	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- 2019.09.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
-- 2019.08.13 JIANXIN 移除沒有必要的參數
-- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
-- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
-- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
-- =============================================
(
         WEXEC_USERID     VARCHAR2          --執行人員
        ,WBATCH_ID        VARCHAR2          --批次識別碼(每批不可重覆)
        ,WSEAL_TYPE       VARCHAR2          --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2          --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   DATE              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2          --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2          --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2          --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2          --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2          --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER            --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2          --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2          --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2          --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
        ,WFAIL_CODE       VARCHAR2          --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2          --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2         --訊息：存放錯誤訊息
)
IS
XSOURCE_ID      VARCHAR2(1);   --資料來源 1.定額  2.申購  3.EC  4.IVR
XVOUCH_NO       VARCHAR2(20);
XVOUCH_SRNO     INT;
XTRADE_NO       VARCHAR2(16);
XBATCH_SRNO     NUMBER(18,0);  --次批號
XCRNT_REC_COUNT NUMBER(18,0);  --目前處理資料的筆數
XTTL_REC_COUNT  NUMBER(18,0);  --合乎條件的送核資料總筆數
XErr_Temp       NVARCHAR2(80);
XREC_COUNT      NUMBER(9,0);
XSYS_DTTM       DATE := SYSDATE;

IS_CHK_ERROR    EXCEPTION;

--偵錯使用
XCNT             INT;

BEGIN

  WIsSuccess := 'N';
  WMSG := '';
  IF WSEAL_TYPE <> '1' AND WSEAL_TYPE <> '2' AND WSEAL_TYPE <> '3' THEN

    WMSG := '扣款途徑不是1.一般 2.ACH  3.財金';
    RETURN;

  END IF ;

  --找出合乎的扣款銀行,寫入OFD704中
  IF WISAGENTBANK = '1' THEN  --代理行

    INSERT INTO ECS.OFD704 
           (BATCH_ID,SUB_BANK_HQ)
    SELECT WBATCH_ID,BANK_NO
      FROM FAS.FIS_BANK
     WHERE PAYMENT_GATEWAY = 'Y';

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD704;
    dbms_output.put_line(' OFD704 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  --ELSE
  --  BEGIN
  --    IF @ISAGENTBANK = '2'   --非代理行
  --    BEGIN
  --        INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)          
  --        SELECT DISTINCT @BATCH_ID,   
  --               OFD020V.BANK_BRH
  --          FROM OFD020V INNER JOIN OFD074 
  --            ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --         WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --           AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --           AND OFD074.DATA_CENTER = @AGENT_BANK
  --           AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --           AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )    
  --          AND OFD020V.BANK_BRH <> @AGENT_BANK
  --    END
  --    ELSE
  --    BEGIN
  --        IF @ISAGENTBANK = '0'   --全部
  --        BEGIN
  --            INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)
  --            SELECT DISTINCT @BATCH_ID,   
  --                   OFD020V.BANK_BRH
  --              FROM OFD020V INNER JOIN OFD074 
  --                ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --             WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --               AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --               AND OFD074.DATA_CENTER = @AGENT_BANK
  --               AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                    (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --               AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )  
  --        END
  --    END
  --  END

  --找出合乎的基金,寫入OFD705中
  IF WISFUND = '0' THEN  --全部 

    INSERT INTO ECS.OFD705 (BATCH_ID,FUND_ID)
    SELECT WBATCH_ID,FUND_NO 
      FROM FAS.FUND 
     -- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
     WHERE AMC_NO IN ('01','02','03')  -- AMC_NO = 01
       AND EC_DEDUCTION = 'Y' --可以銀行扣款
       AND CURRENCY_NO <> 'NTD';  -- 計價幣別 <> NTD


      -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  IF WISFUND = '9'  THEN --指定
      INSERT INTO OFD705 (BATCH_ID,FUND_ID)
      SELECT WBATCH_ID,FUND_NO
        FROM FAS.FUND
       WHERE FUND_NO IN (SELECT VALUE1 FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ID))) ;

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;

  --IF substring(@BUSS_ID,1,1) = '1'  --定期定額
  --  BEGIN
  --    --將RSP008中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
		--	  FROM RSP008,OFD704,OFD705
		--	 WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
		--	   AND RSP008.SUB_STATUS = '0' 
		--	   AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID=@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE
		--	   AND RSP008.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND RSP008.FUND_ID = OFD705.FUND_ID

  --    END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
  --        FROM RSP008,OFD704,OFD705,RSP000
  --       WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
  --         AND (
  --               RSP008.SUB_STATUS = '3' AND
  --               RSP008.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE))
  --              )
  --         AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID=@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE 
  --         AND RSP008.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND RSP008.FUND_ID = OFD705.FUND_ID
  --           --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND RSP008.FUND_ID = RSP000.FUND_ID
  --         AND dbo.f_GetBankHQ(RSP008.SUB_BANK_CODE) = RSP000.BANK_HQ
  --         AND RSP008.SEAL_TYPE = RSP000.SEAL_TYPE    
  --         AND RSP008.DEF_SUB_DATE = RSP000.DEF_SUB_DATE       
  --         AND RSP008.REAL_SUB_DATE = RSP000.REAL_SUB_DATE
  --         AND RSP000.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END
  --IF substring(@BUSS_ID,2,1) = '1'  --指定扣款
  --  BEGIN
  --    --將OFD221A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
		--	  FROM OFD221A,OFD220A,OFD704,OFD705
		--	 WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
		--	   AND OFD220A.SEAL_TYPE = @SEAL_TYPE
		--	   AND OFD220A.TRAN_PAY_WAY = '2'
		--	   AND OFD221A.SUB_STATUS = '0'                
		--	   AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
		--	   AND OFD221A.ALLOT_CODE = '1'
		--	   AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID =@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE     
		--	   AND OFD220A.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND OFD221A.FUND_ID = OFD705.FUND_ID
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
  --        FROM OFD221A,OFD220A,OFD704,OFD705,OFD233
  --       WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
  --         AND OFD220A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD220A.TRAN_PAY_WAY = '2'
  --         AND (OFD221A.SUB_STATUS = '3' AND OFD221A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
  --         AND OFD221A.ALLOT_CODE = '1'
  --         AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE
  --         AND OFD220A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD221A.FUND_ID = OFD705.FUND_ID
  --         --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND OFD221A.FUND_ID = OFD233.FUND_ID
  --         AND dbo.f_GetBankHQ(OFD220A.SUB_BANK_CODE) = OFD233.BANK_HQ
  --         AND OFD220A.SEAL_TYPE = OFD233.SEAL_TYPE           
  --         AND OFD221A.ALLOT_DATE = OFD233.ALLOT_DATE
  --         AND OFD233.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END

  IF SUBSTR(WBUSS_ID,3,1) = '1' THEN  --EC扣款(抓 ECS.PURCHASE)
    --將 ECS.PURCHASE 中合乎條件的未扣款且確認的資料寫入RSP036中
    --未送
    IF (WISINCLUDEFAIL <> 'O') THEN 

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '0' --未扣款
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE     
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS = 'O'    --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD';  

      -- 驗證是否有寫入資料
      SELECT COUNT(1) INTO XCNT FROM ECS.RSP036;
      dbms_output.put_line(' RSP036 CNT  = ' || TO_CHAR(XCNT));

    END IF ;
    --扣款失敗資料
    IF (WISINCLUDEFAIL = 'Y' OR WISINCLUDEFAIL = 'O') THEN

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '3' --扣款失敗
         AND PURCHASE.NONSUCS_CODE IS NOT NULL --扣款失敗原因不為空白
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE        
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS IN ('O','C')    --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD'; 

     END IF ;
  END IF ;

  --IF substring(@BUSS_ID,4,1) = '1'  --IVR扣款(抓OFD621A)
  --  BEGIN
  --    --將OFD621A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
  --    INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V 
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND OFD621A.SUB_STATUS = '0' 
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND (OFD621A.SUB_STATUS = '3'  AND OFD621A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中               
  --    END
  --  END

  --SELECT @REC_COUNT = COUNT(*) FROM RSP036
  -- WHERE BATCH_ID = @BATCH_ID
  --IF @REC_COUNT = 0 --無扣款資料
  --  BEGIN
  --    SET @MSG = 'NODATA'
  --    DEALLOCATE DeductAmt_cur
  --    DELETE FROM OFD704 WHERE BATCH_ID = @BATCH_ID  --刪除此次的扣款銀行暫存資料
  --    DELETE FROM OFD705 WHERE BATCH_ID = @BATCH_ID  --刪除此次的基金暫存資料
  --    RETURN
  --  END

  --設定次批號、交易序號及將來源資料設定為扣款中
  XTTL_REC_COUNT := 0;
  XCRNT_REC_COUNT := 0;
  XBATCH_SRNO := 1;

  IF (WMAX_FILE_COUNT <> 0) OR  --有筆數限制
     (WFILE_NAMING_WAY = '3')   --變動檔名
     THEN     
      -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
      ECS.s_Create_Media_FileName (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4');  --編制媒體檔案名稱
  END IF ;


  DECLARE Cursor DeductAmt_cur IS
      SELECT SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO
        FROM ECS.RSP036
       WHERE BATCH_ID = WBATCH_ID;
  BEGIN 
    FOR DeductAmt_REC IN DeductAmt_cur LOOP

      XTTL_REC_COUNT := XTTL_REC_COUNT + 1;
      XCRNT_REC_COUNT := XCRNT_REC_COUNT + 1;
      IF WMAX_FILE_COUNT <> 0 THEN  --文字檔有最大筆數限制      
        IF XCRNT_REC_COUNT > WMAX_FILE_COUNT THEN           
            XBATCH_SRNO := XBATCH_SRNO + 1;   --由1編起，待滿足筆數限制時，再由2編起，以此類推……
            XCRNT_REC_COUNT := 1;
            -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
            ECS.s_Create_Media_FileName (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4');  --編制媒體檔案名稱
        END IF;
      END IF ;

  --    IF @SOURCE_ID = '1'  --定期定額扣款檔(RSP008)
  --      BEGIN
  --        UPDATE RSP008
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE RSP_NO = @VOUCH_NO AND RSP_SRNO = @VOUCH_SRNO
  --           AND REAL_SUB_DATE = @ACT_DDCT_DATE
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到定期定額資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':定期定額設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

  --    IF @SOURCE_ID = '2' --申購明細檔(OFD221A)
  --      BEGIN
  --        UPDATE OFD221A
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE ALLOT_NO = @VOUCH_NO AND ALLOT_SRNO = @VOUCH_SRNO
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到申購資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':申購設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

        IF DeductAmt_REC.SOURCE_ID = '3' THEN --網路交易申購明細檔(ECS.PURCHASE)

          UPDATE ECS.PURCHASE
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = CASE WSEAL_TYPE WHEN '3' THEN ECS.PADLeft(XTTL_REC_COUNT,7,'0') ELSE ECS.PADLeft(XTTL_REC_COUNT,6,'0') END,
                 SUB_STATUS = '1',  --扣款中
                 NONSUCS_CODE = '',
                 BANK_MEDIA_CODE = '',
                 STATUS = 'C',
                 DEDUCT_DATE = WACT_DDCT_DATE
           WHERE FUND_NO = DeductAmt_REC.FUND_NO 
             AND TX_DATE = DeductAmt_REC.TX_DATE
             AND BROKER_NO = DeductAmt_REC.BROKER_NO
             AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
             AND SER_NO = DeductAmt_REC.SER_NO;

          IF (SQL%ROWCOUNT = 0) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：找不到網路交易申購資料';
            RAISE IS_CHK_ERROR; 
          -- 2019.09.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
          ELSE 
            INSERT INTO ECS.PURCHASE_LOG
            (
                   FUND_NO
                  ,ID
                  ,TX_DATE
                  ,BROKER_NO
                  ,BRANCH_NO

                  ,SER_NO
                  ,AMOUNT
                  ,SERVICE_CHARGE
                  ,PAY_TYPE
                  ,REMARK

                  ,BANK_NO
                  ,AC_CODE
                  ,PROJECT_CODE
                  ,ACTION_TYPE
                  ,REVISION_DATE

                  ,AC_DATE
                  ,AC_BRANCH
                  ,CURRENCY_NO
                  ,PROSPECTUS
                  ,TRANSACTION_NO

                  ,USED_POINT
                  ,IP_A
                  ,IP_B
                  ,IP_C
                  ,IP_D

                  ,INVESTMENT_RISK
                  ,CHANNEL_EXPOSE
                  ,ONSHORE_SHORT_TRADE
                  ,ROBO_CONTRACT_NO
                  ,ROBO_SER_NO

                  ,FEE_CHOICE                   
                  ,COUPON_ID
                  ,SC_RATE 
                  ,ROBO_BATCH_NO                   
                  ,AC_CNT
                  ,IS_INVEST_RISK
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
            )
            SELECT FUND_NO                   --基金別
                  ,ID                       --ID
                  ,TX_DATE                  --交易日期
                  ,BROKER_NO                --代銷單位
                  ,BRANCH_NO                --代銷分公司碼

                  ,SER_NO                   --交易序號
                  ,AMOUNT                   --申購價金
                  ,SERVICE_CHARGE           --手續費
                  ,PAY_TYPE                 --付款方式
                  ,REMARK                   --備註

                  ,BANK_NO                  --銀行代號
                  ,AC_CODE                  --銀行帳號
                  ,PROJECT_CODE             --專案碼
                  ,'M'                      --交易動作(A:新增/M:修改/D:刪除)
                  ,XSYS_DTTM                --最後修改日期

                  ,AC_DATE                  --淨值日
                  ,AC_BRANCH                --扣款分行代碼
                  ,CURRENCY_NO              --幣別
                  ,PROSPECTUS               --公開說明書
                  ,USED_POINT               --使用紅利

                  ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
                  ,IP_A                     --IP A
                  ,IP_B                     --IP B
                  ,IP_C                     --IP C
                  ,IP_D                     --IP D

                  ,INVESTMENT_RISK          --投資風險評估
                  ,CHANNEL_EXPOSE           --通路報酬揭露
                  ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
                  ,ROBO_CONTRACT_NO         --ROBO契約書號
                  ,ROBO_SER_NO              --ROBO交易書號

                  ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
                  ,COUPON_ID                --優惠券號碼
                  ,SC_RATE                  --申購手續費率
                  ,ROBO_BATCH_NO            --ROBO再平衡批次編號
                  ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
                  ,IS_INVEST_RISK           --目標到期投資風險預告書
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
              FROM ECS.PURCHASE PURCHASE
             WHERE FUND_NO = DeductAmt_REC.FUND_NO 
               AND TX_DATE = DeductAmt_REC.TX_DATE
               AND BROKER_NO = DeductAmt_REC.BROKER_NO
               AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
               AND SER_NO = DeductAmt_REC.SER_NO;

          END IF;

          IF (SQL%ROWCOUNT > 1) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：網路交易申購設定扣款中超過1筆';
            RAISE IS_CHK_ERROR; 
          END IF;
      END IF ; 

    END LOOP;
  END;

  WIsSuccess := 'Y';

  EXCEPTION
  WHEN IS_CHK_ERROR THEN
    WMSG := XErr_Temp;
    DBMS_OUTPUT.put_line(XErr_Temp || SQLERRM);

END s_DeductAmt_Process_2;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_2" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_2_BYCRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_2_BYCRY" 
-- =============================================
-- Author:stu
-- Create date: 2008/09/11
-- Description:扣款	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- 2019.07.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
-- 2019.08.02 JIANXIN 因應ES 規則，不更新狀態
-- 2019.08.13 JIANXIN 移除沒有必要的參數
-- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_Cry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
-- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
-- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
-- =============================================
(
         WEXEC_USERID     VARCHAR2          --執行人員
        ,WBATCH_ID        VARCHAR2          --批次識別碼(每批不可重覆)
        ,WSEAL_TYPE       VARCHAR2          --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2          --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   DATE              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2          --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2          --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2          --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2          --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2          --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER            --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2          --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2          --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2          --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
        ,WFAIL_CODE       VARCHAR2          --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2          --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2         --訊息：存放錯誤訊息
)
IS
XSOURCE_ID      VARCHAR2(1);   --資料來源 1.定額  2.申購  3.EC  4.IVR
XVOUCH_NO       VARCHAR2(20);
XVOUCH_SRNO     INT;
XTRADE_NO       VARCHAR2(16);
XBATCH_SRNO     NUMBER(18,0);  --次批號
XCRNT_REC_COUNT NUMBER(18,0);  --目前處理資料的筆數
XTTL_REC_COUNT  NUMBER(18,0);  --合乎條件的送核資料總筆數
XErr_Temp       NVARCHAR2(80);
XREC_COUNT      NUMBER(9,0);
XSYS_DTTM       DATE := SYSDATE;

IS_CHK_ERROR    EXCEPTION;
-- 因應ES 新增欄位
XTX_CURRENCY    VARCHAR2(3);

--偵錯使用
XCNT             INT;

BEGIN

  WIsSuccess := 'N';
  WMSG := '';
  IF WSEAL_TYPE <> '1' AND WSEAL_TYPE <> '2' AND WSEAL_TYPE <> '3' THEN

    WMSG := '扣款途徑不是1.一般 2.ACH  3.財金';
    RETURN;

  END IF ;

  --找出合乎的扣款銀行,寫入OFD704中
  IF WISAGENTBANK = '1' THEN  --代理行

    INSERT INTO ECS.OFD704 
           (BATCH_ID,SUB_BANK_HQ)
    SELECT WBATCH_ID,BANK_NO
      FROM FAS.FIS_BANK
     WHERE PAYMENT_GATEWAY = 'Y';

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD704 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD704 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  --ELSE
  --  BEGIN
  --    IF @ISAGENTBANK = '2'   --非代理行
  --    BEGIN
  --        INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)          
  --        SELECT DISTINCT @BATCH_ID,   
  --               OFD020V.BANK_BRH
  --          FROM OFD020V INNER JOIN OFD074 
  --            ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --         WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --           AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --           AND OFD074.DATA_CENTER = @AGENT_BANK
  --           AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --           AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )    
  --          AND OFD020V.BANK_BRH <> @AGENT_BANK
  --    END
  --    ELSE
  --    BEGIN
  --        IF @ISAGENTBANK = '0'   --全部
  --        BEGIN
  --            INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)
  --            SELECT DISTINCT @BATCH_ID,   
  --                   OFD020V.BANK_BRH
  --              FROM OFD020V INNER JOIN OFD074 
  --                ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --             WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --               AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --               AND OFD074.DATA_CENTER = @AGENT_BANK
  --               AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                    (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --               AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )  
  --        END
  --    END
  --  END

  --找出合乎的基金,寫入OFD705中
  IF WISFUND = '0' THEN  --全部 

    INSERT INTO ECS.OFD705 (BATCH_ID,FUND_ID)
    SELECT WBATCH_ID,FUND_NO 
      FROM FAS.FUND 
     -- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
     WHERE AMC_NO IN ('01','02','03')  -- AMC_NO = 01
       AND EC_DEDUCTION = 'Y' --可以銀行扣款
       AND CURRENCY_NO <> 'NTD';  -- 計價幣別 <> NTD

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  IF WISFUND = '9'  THEN --指定
      INSERT INTO OFD705 (BATCH_ID,FUND_ID)
      SELECT WBATCH_ID,FUND_NO
        FROM FAS.FUND
       WHERE FUND_NO IN (SELECT VALUE1 FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ID))) ;

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;

  --IF substring(@BUSS_ID,1,1) = '1'  --定期定額
  --  BEGIN
  --    --將RSP008中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
		--	  FROM RSP008,OFD704,OFD705
		--	 WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
		--	   AND RSP008.SUB_STATUS = '0' 
		--	   AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID=@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE
		--	   AND RSP008.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND RSP008.FUND_ID = OFD705.FUND_ID

  --    END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
  --        FROM RSP008,OFD704,OFD705,RSP000
  --       WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
  --         AND (
  --               RSP008.SUB_STATUS = '3' AND
  --               RSP008.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE))
  --              )
  --         AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID=@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE 
  --         AND RSP008.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND RSP008.FUND_ID = OFD705.FUND_ID
  --           --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND RSP008.FUND_ID = RSP000.FUND_ID
  --         AND dbo.f_GetBankHQ(RSP008.SUB_BANK_CODE) = RSP000.BANK_HQ
  --         AND RSP008.SEAL_TYPE = RSP000.SEAL_TYPE    
  --         AND RSP008.DEF_SUB_DATE = RSP000.DEF_SUB_DATE       
  --         AND RSP008.REAL_SUB_DATE = RSP000.REAL_SUB_DATE
  --         AND RSP000.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END
  --IF substring(@BUSS_ID,2,1) = '1'  --指定扣款
  --  BEGIN
  --    --將OFD221A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
		--	  FROM OFD221A,OFD220A,OFD704,OFD705
		--	 WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
		--	   AND OFD220A.SEAL_TYPE = @SEAL_TYPE
		--	   AND OFD220A.TRAN_PAY_WAY = '2'
		--	   AND OFD221A.SUB_STATUS = '0'                
		--	   AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
		--	   AND OFD221A.ALLOT_CODE = '1'
		--	   AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID =@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE     
		--	   AND OFD220A.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND OFD221A.FUND_ID = OFD705.FUND_ID
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
  --        FROM OFD221A,OFD220A,OFD704,OFD705,OFD233
  --       WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
  --         AND OFD220A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD220A.TRAN_PAY_WAY = '2'
  --         AND (OFD221A.SUB_STATUS = '3' AND OFD221A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
  --         AND OFD221A.ALLOT_CODE = '1'
  --         AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE
  --         AND OFD220A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD221A.FUND_ID = OFD705.FUND_ID
  --         --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND OFD221A.FUND_ID = OFD233.FUND_ID
  --         AND dbo.f_GetBankHQ(OFD220A.SUB_BANK_CODE) = OFD233.BANK_HQ
  --         AND OFD220A.SEAL_TYPE = OFD233.SEAL_TYPE           
  --         AND OFD221A.ALLOT_DATE = OFD233.ALLOT_DATE
  --         AND OFD233.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END

  IF SUBSTR(WBUSS_ID,3,1) = '1' THEN  --EC扣款(抓 ECS.PURCHASE)
    --將 ECS.PURCHASE 中合乎條件的未扣款且確認的資料寫入RSP036中
    --未送
    IF (WISINCLUDEFAIL <> 'O') THEN 

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '0' --未扣款
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE     
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS = 'O'  --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD';  

      -- 驗證是否有寫入資料
      SELECT COUNT(1) INTO XCNT FROM ECS.RSP036 WHERE BATCH_ID = WBATCH_ID;
      dbms_output.put_line(' RSP036 CNT  = ' || TO_CHAR(XCNT));

    END IF ;
    --扣款失敗資料
    IF (WISINCLUDEFAIL = 'Y' OR WISINCLUDEFAIL = 'O') THEN

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '3' --扣款失敗
         AND PURCHASE.NONSUCS_CODE IS NOT NULL --扣款失敗原因不為空白
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE        
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS IN ('O','C') --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD';  

     END IF ;
  END IF ;

  --IF substring(@BUSS_ID,4,1) = '1'  --IVR扣款(抓OFD621A)
  --  BEGIN
  --    --將OFD621A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
  --    INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V 
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND OFD621A.SUB_STATUS = '0' 
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND (OFD621A.SUB_STATUS = '3'  AND OFD621A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中               
  --    END
  --  END

  --SELECT @REC_COUNT = COUNT(*) FROM RSP036
  -- WHERE BATCH_ID = @BATCH_ID
  --IF @REC_COUNT = 0 --無扣款資料
  --  BEGIN
  --    SET @MSG = 'NODATA'
  --    DEALLOCATE DeductAmt_cur
  --    DELETE FROM OFD704 WHERE BATCH_ID = @BATCH_ID  --刪除此次的扣款銀行暫存資料
  --    DELETE FROM OFD705 WHERE BATCH_ID = @BATCH_ID  --刪除此次的基金暫存資料
  --    RETURN
  --  END

  --設定次批號、交易序號及將來源資料設定為扣款中
  XTTL_REC_COUNT := 0;
  XCRNT_REC_COUNT := 0;
  XBATCH_SRNO := 0;

  --IF (WMAX_FILE_COUNT <> 0) OR  --有筆數限制
  --   (WFILE_NAMING_WAY = '3')   --變動檔名
  --   THEN     
  --    -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_Cry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
  --    ECS.s_Create_Media_FileName_Cry (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4');  --編制媒體檔案名稱
  --END IF ;

  XTX_CURRENCY :=' ';

  DECLARE Cursor DeductAmt_cur IS
      SELECT SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY
        FROM ECS.RSP036
       WHERE BATCH_ID = WBATCH_ID
       ORDER BY TX_CURRENCY ;
  BEGIN
    FOR DeductAmt_REC IN DeductAmt_cur LOOP

      XTTL_REC_COUNT := XTTL_REC_COUNT + 1;
      XCRNT_REC_COUNT := XCRNT_REC_COUNT + 1;
      dbms_output.put_line(' WMAX_FILE_COUNT  = ' || TO_CHAR(WMAX_FILE_COUNT));
      dbms_output.put_line(' XCRNT_REC_COUNT  = ' || TO_CHAR(XCRNT_REC_COUNT));
      dbms_output.put_line(' WMAX_FILE_COUNT  = ' || TO_CHAR(WMAX_FILE_COUNT));
      dbms_output.put_line(' DeductAmt_REC.TX_CURRENCY  = ' || TO_CHAR(DeductAmt_REC.TX_CURRENCY));
      dbms_output.put_line(' XTX_CURRENCY  = ' || TO_CHAR(XTX_CURRENCY));

      IF (WMAX_FILE_COUNT <> 0 AND XCRNT_REC_COUNT > WMAX_FILE_COUNT) OR DeductAmt_REC.TX_CURRENCY <> XTX_CURRENCY THEN  --文字檔有最大筆數限制

            XBATCH_SRNO := XBATCH_SRNO + 1;   --由1編起，待滿足筆數限制時，再由2編起，以此類推……
            XCRNT_REC_COUNT := 1;
            XTX_CURRENCY := DeductAmt_REC.TX_CURRENCY ;
            -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_Cry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
            ECS.s_Create_Media_FileName_Cry (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4',DeductAmt_REC.TX_CURRENCY);  --編制媒體檔案名稱

      END IF ;

  --    IF @SOURCE_ID = '1'  --定期定額扣款檔(RSP008)
  --      BEGIN
  --        UPDATE RSP008
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE RSP_NO = @VOUCH_NO AND RSP_SRNO = @VOUCH_SRNO
  --           AND REAL_SUB_DATE = @ACT_DDCT_DATE
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到定期定額資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':定期定額設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

  --    IF @SOURCE_ID = '2' --申購明細檔(OFD221A)
  --      BEGIN
  --        UPDATE OFD221A
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE ALLOT_NO = @VOUCH_NO AND ALLOT_SRNO = @VOUCH_SRNO
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到申購資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':申購設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

        IF DeductAmt_REC.SOURCE_ID = '3' THEN --網路交易申購明細檔(ECS.PURCHASE)

          UPDATE ECS.PURCHASE
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = CASE WSEAL_TYPE WHEN '3' THEN ECS.PADLeft(XTTL_REC_COUNT,7,'0') ELSE ECS.PADLeft(XTTL_REC_COUNT,6,'0') END,
                 SUB_STATUS = '1',  --扣款中
                 NONSUCS_CODE = '',
                 BANK_MEDIA_CODE = '',
                 -- 2019.08.02 JIANXIN 因應ES 規則，不更新狀態
                 --STATUS = 'C',
                 DEDUCT_DATE = WACT_DDCT_DATE
           WHERE FUND_NO = DeductAmt_REC.FUND_NO
             AND TX_DATE = DeductAmt_REC.TX_DATE
             AND BROKER_NO = DeductAmt_REC.BROKER_NO
             AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
             AND SER_NO = DeductAmt_REC.SER_NO;

          IF (SQL%ROWCOUNT = 0) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：找不到網路交易申購資料';
            RAISE IS_CHK_ERROR;
          -- 2019.07.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
          ELSE 
            INSERT INTO ECS.PURCHASE_LOG
            (
                   FUND_NO
                  ,ID
                  ,TX_DATE
                  ,BROKER_NO
                  ,BRANCH_NO

                  ,SER_NO
                  ,AMOUNT
                  ,SERVICE_CHARGE
                  ,PAY_TYPE
                  ,REMARK

                  ,BANK_NO
                  ,AC_CODE
                  ,PROJECT_CODE
                  ,ACTION_TYPE
                  ,REVISION_DATE

                  ,AC_DATE
                  ,AC_BRANCH
                  ,CURRENCY_NO
                  ,PROSPECTUS
                  ,TRANSACTION_NO

                  ,USED_POINT
                  ,IP_A
                  ,IP_B
                  ,IP_C
                  ,IP_D

                  ,INVESTMENT_RISK
                  ,CHANNEL_EXPOSE
                  ,ONSHORE_SHORT_TRADE
                  ,ROBO_CONTRACT_NO
                  ,ROBO_SER_NO

                  ,FEE_CHOICE                   
                  ,COUPON_ID
                  ,SC_RATE 
                  ,ROBO_BATCH_NO                   
                  ,AC_CNT
                  ,IS_INVEST_RISK
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
            )
            SELECT FUND_NO                   --基金別
                  ,ID                       --ID
                  ,TX_DATE                  --交易日期
                  ,BROKER_NO                --代銷單位
                  ,BRANCH_NO                --代銷分公司碼

                  ,SER_NO                   --交易序號
                  ,AMOUNT                   --申購價金
                  ,SERVICE_CHARGE           --手續費
                  ,PAY_TYPE                 --付款方式
                  ,REMARK                   --備註

                  ,BANK_NO                  --銀行代號
                  ,AC_CODE                  --銀行帳號
                  ,PROJECT_CODE             --專案碼
                  ,'M'                      --交易動作(A:新增/M:修改/D:刪除)
                  ,XSYS_DTTM                --最後修改日期

                  ,AC_DATE                  --淨值日
                  ,AC_BRANCH                --扣款分行代碼
                  ,CURRENCY_NO              --幣別
                  ,PROSPECTUS               --公開說明書
                  ,USED_POINT               --使用紅利

                  ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
                  ,IP_A                     --IP A
                  ,IP_B                     --IP B
                  ,IP_C                     --IP C
                  ,IP_D                     --IP D

                  ,INVESTMENT_RISK          --投資風險評估
                  ,CHANNEL_EXPOSE           --通路報酬揭露
                  ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
                  ,ROBO_CONTRACT_NO         --ROBO契約書號
                  ,ROBO_SER_NO              --ROBO交易書號

                  ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
                  ,COUPON_ID                --優惠券號碼
                  ,SC_RATE                  --申購手續費率
                  ,ROBO_BATCH_NO            --ROBO再平衡批次編號
                  ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
                  ,IS_INVEST_RISK           --目標到期投資風險預告書
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
              FROM ECS.PURCHASE PURCHASE
             WHERE FUND_NO = DeductAmt_REC.FUND_NO 
               AND TX_DATE = DeductAmt_REC.TX_DATE
               AND BROKER_NO = DeductAmt_REC.BROKER_NO
               AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
               AND SER_NO = DeductAmt_REC.SER_NO;

          END IF;

          IF (SQL%ROWCOUNT > 1) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：網路交易申購設定扣款中超過1筆';
            RAISE IS_CHK_ERROR;
          END IF;
      END IF ;

    END LOOP;
  END;

  WIsSuccess := 'Y';

  EXCEPTION
  WHEN IS_CHK_ERROR THEN
    WMSG := XErr_Temp;
    DBMS_OUTPUT.put_line(XErr_Temp || SQLERRM);

END s_DeductAmt_Process_2_ByCry;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_2_BYCRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_2_BYFNDCRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_2_BYFNDCRY" 
-- =============================================
-- Author:JIANXIN
-- Create date: 2019/08/13
-- Description:扣款處理	
-- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
-- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
-- 2020.07.17 Chengyu 修正產檔時，基金沒有排序造成多筆檔案問題
-- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
-- =============================================
(
         WEXEC_USERID     VARCHAR2          --執行人員
        ,WBATCH_ID        VARCHAR2          --批次識別碼(每批不可重覆)
        ,WSEAL_TYPE       VARCHAR2          --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2          --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   DATE              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2          --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2          --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2          --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2          --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2          --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER            --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2          --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2          --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2          --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
        ,WFAIL_CODE       VARCHAR2          --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2          --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2         --訊息：存放錯誤訊息
)
IS
XSOURCE_ID      VARCHAR2(1);   --資料來源 1.定額  2.申購  3.EC  4.IVR
XVOUCH_NO       VARCHAR2(20);
XVOUCH_SRNO     INT;
XTRADE_NO       VARCHAR2(16);
XBATCH_SRNO     NUMBER(18,0);  --次批號
XCRNT_REC_COUNT NUMBER(18,0);  --目前處理資料的筆數
XTTL_REC_COUNT  NUMBER(18,0);  --合乎條件的送核資料總筆數
XErr_Temp       NVARCHAR2(80);
XREC_COUNT      NUMBER(9,0);
XSYS_DTTM       DATE := SYSDATE;

IS_CHK_ERROR    EXCEPTION;
-- 因應ES 新增欄位
XFUND_NO        VARCHAR2(5);
XTX_CURRENCY    VARCHAR2(3);

--偵錯使用
XCNT             INT;

BEGIN

  WIsSuccess := 'N';
  WMSG := '';
  IF WSEAL_TYPE <> '1' AND WSEAL_TYPE <> '2' AND WSEAL_TYPE <> '3' THEN

    WMSG := '扣款途徑不是1.一般 2.ACH  3.財金';
    RETURN;

  END IF ;

  --找出合乎的扣款銀行,寫入OFD704中
  IF WISAGENTBANK = '1' THEN  --代理行

    INSERT INTO ECS.OFD704 
           (BATCH_ID,SUB_BANK_HQ)
    SELECT WBATCH_ID,BANK_NO
      FROM FAS.FIS_BANK
     WHERE PAYMENT_GATEWAY = 'Y';

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD704 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD704 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  --ELSE
  --  BEGIN
  --    IF @ISAGENTBANK = '2'   --非代理行
  --    BEGIN
  --        INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)          
  --        SELECT DISTINCT @BATCH_ID,   
  --               OFD020V.BANK_BRH
  --          FROM OFD020V INNER JOIN OFD074 
  --            ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --         WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --           AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --           AND OFD074.DATA_CENTER = @AGENT_BANK
  --           AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --           AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )    
  --          AND OFD020V.BANK_BRH <> @AGENT_BANK
  --    END
  --    ELSE
  --    BEGIN
  --        IF @ISAGENTBANK = '0'   --全部
  --        BEGIN
  --            INSERT INTO OFD704 (BATCH_ID,SUB_BANK_HQ)
  --            SELECT DISTINCT @BATCH_ID,   
  --                   OFD020V.BANK_BRH
  --              FROM OFD020V INNER JOIN OFD074 
  --                ON OFD020V.BANK_HQ=OFD074.BANK_HQ	
  --             WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5') 
  --               AND OFD074.SEAL_TYPE = @SEAL_TYPE  
  --               AND OFD074.DATA_CENTER = @AGENT_BANK
  --               AND ((OFD020V.BANK_TYPE IN ('04','05') AND IS_SUB_HQ = 'N') OR
  --                    (OFD020V.BANK_TYPE NOT IN ('04','05') AND IS_SUB_HQ = 'Y')) 
  --               AND 
  --                  (
  --                     (OFD020V.BANK_TYPE NOT IN ('04','05')  AND   ((@SEAL_TYPE = '2' AND OFD020V.SEAL_CHK_CODE2 = 'Y') OR (@SEAL_TYPE = '3' AND OFD020V.SEAL_CHK_CODE3 = 'Y')))
  --                      OR  
  --                     (OFD020V.BANK_TYPE  IN ('04','05'))
  --                   )  
  --        END
  --    END
  --  END

  --找出合乎的基金,寫入OFD705中
  IF WISFUND = '0' THEN  --全部 

    INSERT INTO ECS.OFD705 (BATCH_ID,FUND_ID)
    SELECT WBATCH_ID,FUND_NO 
      FROM FAS.FUND 
     -- 2021.08.04 Chengyu 開放基金公司"瀚亞投資"、"M&G"基金
     WHERE AMC_NO IN ('01','02','03')  -- AMC_NO = 01
       AND EC_DEDUCTION = 'Y' --可以銀行扣款
       AND CURRENCY_NO <> 'NTD';  -- 計價幣別 <> NTD

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;
  IF WISFUND = '9'  THEN --指定
      INSERT INTO OFD705 (BATCH_ID,FUND_ID)
      SELECT WBATCH_ID,FUND_NO
        FROM FAS.FUND
       WHERE FUND_NO IN (SELECT VALUE1 FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ID))) ;

    -- 驗證是否有寫入資料
    SELECT COUNT(1) INTO XCNT FROM ECS.OFD705 WHERE BATCH_ID = WBATCH_ID;
    dbms_output.put_line(' OFD705 CNT  = ' || TO_CHAR(XCNT));

  END IF ;

  --IF substring(@BUSS_ID,1,1) = '1'  --定期定額
  --  BEGIN
  --    --將RSP008中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
		--	  FROM RSP008,OFD704,OFD705
		--	 WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
		--	   AND RSP008.SUB_STATUS = '0' 
		--	   AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID=@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE
		--	   AND RSP008.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND RSP008.FUND_ID = OFD705.FUND_ID

  --    END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'1',RSP008.RSP_NO,RSP008.RSP_SRNO
  --        FROM RSP008,OFD704,OFD705,RSP000
  --       WHERE RSP008.SEAL_TYPE = @SEAL_TYPE
  --         AND (
  --               RSP008.SUB_STATUS = '3' AND
  --               RSP008.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE))
  --              )
  --         AND RSP008.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID=@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=RSP008.SUB_BANK_CODE 
  --         AND RSP008.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND RSP008.FUND_ID = OFD705.FUND_ID
  --           --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND RSP008.FUND_ID = RSP000.FUND_ID
  --         AND dbo.f_GetBankHQ(RSP008.SUB_BANK_CODE) = RSP000.BANK_HQ
  --         AND RSP008.SEAL_TYPE = RSP000.SEAL_TYPE    
  --         AND RSP008.DEF_SUB_DATE = RSP000.DEF_SUB_DATE       
  --         AND RSP008.REAL_SUB_DATE = RSP000.REAL_SUB_DATE
  --         AND RSP000.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END
  --IF substring(@BUSS_ID,2,1) = '1'  --指定扣款
  --  BEGIN
  --    --將OFD221A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
		--  INSERT INTO RSP036
		--		(BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
		--	SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
		--	  FROM OFD221A,OFD220A,OFD704,OFD705
		--	 WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
		--	   AND OFD220A.SEAL_TYPE = @SEAL_TYPE
		--	   AND OFD220A.TRAN_PAY_WAY = '2'
		--	   AND OFD221A.SUB_STATUS = '0'                
		--	   AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
		--	   AND OFD221A.ALLOT_CODE = '1'
		--	   AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
		--	   AND OFD704.BATCH_ID =@BATCH_ID
  --             AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE     
		--	   AND OFD220A.DATA_CENTER = @AGENT_BANK
		--	   AND OFD705.BATCH_ID=@BATCH_ID
  --             AND OFD221A.FUND_ID = OFD705.FUND_ID
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'2',OFD221A.ALLOT_NO,OFD221A.ALLOT_SRNO
  --        FROM OFD221A,OFD220A,OFD704,OFD705,OFD233
  --       WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
  --         AND OFD220A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD220A.TRAN_PAY_WAY = '2'
  --         AND (OFD221A.SUB_STATUS = '3' AND OFD221A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD221A.ALLOT_PROC_CODE IN ('0','1')
  --         AND OFD221A.ALLOT_CODE = '1'
  --         AND OFD221A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD704.SUB_BANK_HQ=OFD220A.SUB_BANK_CODE
  --         AND OFD220A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD221A.FUND_ID = OFD705.FUND_ID
  --         --增加判斷需扣款行尚未回覆確認的扣款失敗資料才可
  --         AND OFD221A.FUND_ID = OFD233.FUND_ID
  --         AND dbo.f_GetBankHQ(OFD220A.SUB_BANK_CODE) = OFD233.BANK_HQ
  --         AND OFD220A.SEAL_TYPE = OFD233.SEAL_TYPE           
  --         AND OFD221A.ALLOT_DATE = OFD233.ALLOT_DATE
  --         AND OFD233.BANK_CFM_CD<>'Y'--已確認
  --     END
  --  END

  IF SUBSTR(WBUSS_ID,3,1) = '1' THEN  --EC扣款(抓 ECS.PURCHASE)
    --將 ECS.PURCHASE 中合乎條件的未扣款且確認的資料寫入RSP036中
    --未送
    IF (WISINCLUDEFAIL <> 'O') THEN 

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '0' --未扣款
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE     
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS = 'O'    --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD';  

      -- 驗證是否有寫入資料
      SELECT COUNT(1) INTO XCNT FROM ECS.RSP036 WHERE BATCH_ID = WBATCH_ID;
      dbms_output.put_line(' RSP036 CNT  = ' || TO_CHAR(XCNT));

    END IF ;
    --扣款失敗資料
    IF (WISINCLUDEFAIL = 'Y' OR WISINCLUDEFAIL = 'O') THEN

      INSERT INTO ECS.RSP036
          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY)
      SELECT WBATCH_ID,1,'3','',NULL,PURCHASE.FUND_NO,PURCHASE.TX_DATE,PURCHASE.BROKER_NO,PURCHASE.BRANCH_NO,PURCHASE.SER_NO,PURCHASE.CURRENCY_NO
        FROM ECS.PURCHASE 
        JOIN ECS.OFD704
          ON OFD704.SUB_BANK_HQ = PURCHASE.BANK_NO
        JOIN ECS.OFD705
          ON OFD705.BATCH_ID = OFD704.BATCH_ID
       WHERE PURCHASE.SUB_STATUS = '3' --扣款失敗
         AND PURCHASE.NONSUCS_CODE IS NOT NULL --扣款失敗原因不為空白
         AND PURCHASE.TX_DATE = WACT_DDCT_DATE        
         AND OFD704.BATCH_ID = WBATCH_ID
         AND PURCHASE.PAY_TYPE = '4' 
         AND PURCHASE.FUND_NO = OFD705.FUND_ID
         AND PURCHASE.STATUS IN ('O','C')      --委託中
         -- 2020.05.13 ChengYu 【ECS.RSP036(境內扣款申請檔)】新增外幣扣款資料時，排除台幣資料
         AND PURCHASE.CURRENCY_NO != 'NTD';    

     END IF ;
  END IF ;

  --IF substring(@BUSS_ID,4,1) = '1'  --IVR扣款(抓OFD621A)
  --  BEGIN
  --    --將OFD621A中合乎條件的未扣款且確認的資料寫入RSP036中
  --    --未送
  --    IF (@ISINCLUDEFAIL<>'O')
  --    BEGIN
  --    INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V 
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND OFD621A.SUB_STATUS = '0' 
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中
  --     END
  --    --扣款失敗資料
  --    IF (@ISINCLUDEFAIL='Y' OR @ISINCLUDEFAIL='O')
  --    BEGIN
  --      INSERT INTO RSP036
  --          (BATCH_ID,BATCH_SRNO,SOURCE_ID,VOUCH_NO,VOUCH_SRNO)
  --      SELECT @BATCH_ID,1,'4',OFD621A.EC_ALLOT_NO,OFD621A.EC_ALLOT_SRNO
  --        FROM OFD621A,OFD620A,OFD704,OFD705,OFD020V
  --       WHERE OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO
  --         AND OFD620A.SEAL_TYPE = @SEAL_TYPE
  --         AND OFD620A.TRAN_PAY_WAY = '2'
  --         AND (OFD621A.SUB_STATUS = '3'  AND OFD621A.NONSUCS_CODE IN (SELECT WORDS FROM [dbo].[f_SplitWords](@FAIL_CODE)))
  --         AND OFD621A.REAL_SUB_DATE = @ACT_DDCT_DATE
  --         AND OFD704.BATCH_ID =@BATCH_ID
  --         AND OFD020V.BANK_BRH = OFD620A.SUB_BANK_CODE
  --         AND OFD704.SUB_BANK_HQ=CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN OFD620A.SUB_BANK_CODE ELSE dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE) END
  --         AND OFD620A.DATA_CENTER = @AGENT_BANK
  --         AND OFD705.BATCH_ID=@BATCH_ID
  --         AND OFD621A.FUND_ID = OFD705.FUND_ID
  --         AND OFD620A.SYSTEM_ID = '2'  --語音交易
  --         AND OFD621A.EC_ALLOT_PCODE = '1'  --處理中               
  --    END
  --  END

  --SELECT @REC_COUNT = COUNT(*) FROM RSP036
  -- WHERE BATCH_ID = @BATCH_ID
  --IF @REC_COUNT = 0 --無扣款資料
  --  BEGIN
  --    SET @MSG = 'NODATA'
  --    DEALLOCATE DeductAmt_cur
  --    DELETE FROM OFD704 WHERE BATCH_ID = @BATCH_ID  --刪除此次的扣款銀行暫存資料
  --    DELETE FROM OFD705 WHERE BATCH_ID = @BATCH_ID  --刪除此次的基金暫存資料
  --    RETURN
  --  END

  --設定次批號、交易序號及將來源資料設定為扣款中
  XTTL_REC_COUNT := 0;
  XCRNT_REC_COUNT := 0;
  XBATCH_SRNO := 0;

  --IF (WMAX_FILE_COUNT <> 0) OR  --有筆數限制
  --   (WFILE_NAMING_WAY = '3')   --變動檔名
  --   THEN     
  --    -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
  --    ECS.s_Create_Media_FileName_Cry (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4');  --編制媒體檔案名稱
  --END IF ;

  XTX_CURRENCY :=' ';
  XFUND_NO :=' ';

  DECLARE Cursor DeductAmt_cur IS
      SELECT SOURCE_ID,VOUCH_NO,VOUCH_SRNO,FUND_NO,TX_DATE,BROKER_NO,BRANCH_NO,SER_NO,TX_CURRENCY
        FROM ECS.RSP036
       WHERE BATCH_ID = WBATCH_ID
       -- 2020.07.17 Chengyu 修正產檔時，基金沒有排序造成多筆檔案問題
       ORDER BY TX_CURRENCY,FUND_NO ;
  BEGIN
    FOR DeductAmt_REC IN DeductAmt_cur LOOP

      XTTL_REC_COUNT := XTTL_REC_COUNT + 1;
      XCRNT_REC_COUNT := XCRNT_REC_COUNT + 1;
      dbms_output.put_line(' WMAX_FILE_COUNT  = ' || TO_CHAR(WMAX_FILE_COUNT));
      dbms_output.put_line(' XCRNT_REC_COUNT  = ' || TO_CHAR(XCRNT_REC_COUNT));
      dbms_output.put_line(' WMAX_FILE_COUNT  = ' || TO_CHAR(WMAX_FILE_COUNT));
      dbms_output.put_line(' DeductAmt_REC.TX_CURRENCY  = ' || TO_CHAR(DeductAmt_REC.TX_CURRENCY));
      dbms_output.put_line(' XTX_CURRENCY  = ' || TO_CHAR(XTX_CURRENCY));

      IF    (WMAX_FILE_COUNT <> 0 AND XCRNT_REC_COUNT > WMAX_FILE_COUNT) 
         OR DeductAmt_REC.TX_CURRENCY <> XTX_CURRENCY 
         OR DeductAmt_REC.FUND_NO <> XFUND_NO THEN  --文字檔有最大筆數限制

            XBATCH_SRNO := XBATCH_SRNO + 1;   --由1編起，待滿足筆數限制時，再由2編起，以此類推……
            XFUND_NO := DeductAmt_REC.FUND_NO;   
            XCRNT_REC_COUNT := 1;
            XTX_CURRENCY := DeductAmt_REC.TX_CURRENCY ;
            -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為4(外幣扣款)
            ECS.s_Create_Media_FileName_FndCry (WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'4',DeductAmt_REC.TX_CURRENCY);  --編制媒體檔案名稱

      END IF ;

  --    IF @SOURCE_ID = '1'  --定期定額扣款檔(RSP008)
  --      BEGIN
  --        UPDATE RSP008
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE RSP_NO = @VOUCH_NO AND RSP_SRNO = @VOUCH_SRNO
  --           AND REAL_SUB_DATE = @ACT_DDCT_DATE
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到定期定額資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':定期定額設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

  --    IF @SOURCE_ID = '2' --申購明細檔(OFD221A)
  --      BEGIN
  --        UPDATE OFD221A
  --           SET BATCH_ID = @BATCH_ID,
  --               BATCH_SRNO = @BATCH_SRNO,
  --               TRADE_NO = CASE @SEAL_TYPE WHEN '3' THEN dbo.PADLeft(@TTL_REC_COUNT,7,'0') ELSE dbo.PADLeft(@TTL_REC_COUNT,6,'0') END,
  --               SUB_STATUS = '1',  --扣款中
  --               NONSUCS_CODE = '',
  --               BANK_MEDIA_CODE = ''
  --         WHERE ALLOT_NO = @VOUCH_NO AND ALLOT_SRNO = @VOUCH_SRNO
  --        IF @@ROWCOUNT = 0
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':找不到申購資料'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --        IF @@ROWCOUNT > 1
  --          BEGIN
  --            SET @Err_Temp = @VOUCH_NO+'-'+convert(nvarchar,@VOUCH_SRNO)+':申購設定扣款中超過1筆'
  --            raiserror(@Err_Temp,16,-1)
  --            CLOSE DeductAmt_cur
  --            DEALLOCATE DeductAmt_cur
  --            RETURN
  --          END
  --      END

        IF DeductAmt_REC.SOURCE_ID = '3' THEN --網路交易申購明細檔(ECS.PURCHASE)

          UPDATE ECS.PURCHASE
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = CASE WSEAL_TYPE WHEN '3' THEN ECS.PADLeft(XTTL_REC_COUNT,7,'0') ELSE ECS.PADLeft(XTTL_REC_COUNT,6,'0') END,
                 SUB_STATUS = '1',  --扣款中
                 NONSUCS_CODE = '',
                 BANK_MEDIA_CODE = '',
                 -- 2019.08.02 JIANXIN 因應ES 規則，不更新狀態
                 --STATUS = 'C',
                 DEDUCT_DATE = WACT_DDCT_DATE
           WHERE FUND_NO = DeductAmt_REC.FUND_NO
             AND TX_DATE = DeductAmt_REC.TX_DATE
             AND BROKER_NO = DeductAmt_REC.BROKER_NO
             AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
             AND SER_NO = DeductAmt_REC.SER_NO;

          IF (SQL%ROWCOUNT = 0) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：找不到網路交易申購資料';
            RAISE IS_CHK_ERROR;
          -- 2019.07.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
          ELSE 
            INSERT INTO ECS.PURCHASE_LOG
            (
                   FUND_NO
                  ,ID
                  ,TX_DATE
                  ,BROKER_NO
                  ,BRANCH_NO

                  ,SER_NO
                  ,AMOUNT
                  ,SERVICE_CHARGE
                  ,PAY_TYPE
                  ,REMARK

                  ,BANK_NO
                  ,AC_CODE
                  ,PROJECT_CODE
                  ,ACTION_TYPE
                  ,REVISION_DATE

                  ,AC_DATE
                  ,AC_BRANCH
                  ,CURRENCY_NO
                  ,PROSPECTUS
                  ,TRANSACTION_NO

                  ,USED_POINT
                  ,IP_A
                  ,IP_B
                  ,IP_C
                  ,IP_D

                  ,INVESTMENT_RISK
                  ,CHANNEL_EXPOSE
                  ,ONSHORE_SHORT_TRADE
                  ,ROBO_CONTRACT_NO
                  ,ROBO_SER_NO

                  ,FEE_CHOICE                   
                  ,COUPON_ID
                  ,SC_RATE 
                  ,ROBO_BATCH_NO                   
                  ,AC_CNT
                  ,IS_INVEST_RISK
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
            )
            SELECT FUND_NO                   --基金別
                  ,ID                       --ID
                  ,TX_DATE                  --交易日期
                  ,BROKER_NO                --代銷單位
                  ,BRANCH_NO                --代銷分公司碼

                  ,SER_NO                   --交易序號
                  ,AMOUNT                   --申購價金
                  ,SERVICE_CHARGE           --手續費
                  ,PAY_TYPE                 --付款方式
                  ,REMARK                   --備註

                  ,BANK_NO                  --銀行代號
                  ,AC_CODE                  --銀行帳號
                  ,PROJECT_CODE             --專案碼
                  ,'M'                      --交易動作(A:新增/M:修改/D:刪除)
                  ,XSYS_DTTM                --最後修改日期

                  ,AC_DATE                  --淨值日
                  ,AC_BRANCH                --扣款分行代碼
                  ,CURRENCY_NO              --幣別
                  ,PROSPECTUS               --公開說明書
                  ,USED_POINT               --使用紅利

                  ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
                  ,IP_A                     --IP A
                  ,IP_B                     --IP B
                  ,IP_C                     --IP C
                  ,IP_D                     --IP D

                  ,INVESTMENT_RISK          --投資風險評估
                  ,CHANNEL_EXPOSE           --通路報酬揭露
                  ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
                  ,ROBO_CONTRACT_NO         --ROBO契約書號
                  ,ROBO_SER_NO              --ROBO交易書號

                  ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
                  ,COUPON_ID                --優惠券號碼
                  ,SC_RATE                  --申購手續費率
                  ,ROBO_BATCH_NO            --ROBO再平衡批次編號
                  ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
                  ,IS_INVEST_RISK           --目標到期投資風險預告書
                  ,BATCH_ID 
                  ,BATCH_SRNO 
                  ,TRADE_NO 
                  ,SUB_STATUS 
                  ,NONSUCS_CODE 
                  ,BANK_MEDIA_CODE 
              FROM ECS.PURCHASE PURCHASE
             WHERE FUND_NO = DeductAmt_REC.FUND_NO 
               AND TX_DATE = DeductAmt_REC.TX_DATE
               AND BROKER_NO = DeductAmt_REC.BROKER_NO
               AND BRANCH_NO = DeductAmt_REC.BRANCH_NO
               AND SER_NO = DeductAmt_REC.SER_NO;

          END IF;

          IF (SQL%ROWCOUNT > 1) THEN
            XErr_Temp := '基金代碼：' || DeductAmt_REC.FUND_NO || '；' ||
                         '交易日期：' || DeductAmt_REC.TX_DATE || '；' ||
                         '代銷單位：' || DeductAmt_REC.BROKER_NO || '；' ||
                         '代銷分公司碼：' || DeductAmt_REC.BRANCH_NO || '；' ||
                         '交易序號：' || DeductAmt_REC.SER_NO || '；' ||
                         '：網路交易申購設定扣款中超過1筆';
            RAISE IS_CHK_ERROR;
          END IF;
      END IF ;

    END LOOP;
  END;

  WIsSuccess := 'Y';

  EXCEPTION
  WHEN IS_CHK_ERROR THEN
    WMSG := XErr_Temp;
    DBMS_OUTPUT.put_line(XErr_Temp || SQLERRM);

END s_DeductAmt_Process_2_ByFndCry;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_2_BYFNDCRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_6
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_6" 
-- =============================================
-- Author:stu
-- Create date: 2008/09/11
-- Description:取消該批扣款	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- 2019.09.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
-- =============================================
(
         WEXEC_USERID     VARCHAR2         --執行人員
        ,WBATCH_ID        VARCHAR2         --批次識別碼(每批不可重覆)
        ,WSEAL_TYPE       VARCHAR2         --扣款途徑 1.一般 2.ACH  3.財金
        ,WIsSuccess   OUT VARCHAR2         --成功否：Y.成功  N.失敗
        ,WMSG         OUT NVARCHAR2        --訊息：存放錯誤訊息
) 
IS

XTTL_REC_COUNT NUMBER(5,0); --不為扣款中的總筆數
XSYS_DTTM      DATE := SYSDATE;

BEGIN

  WIsSuccess := 'N';
  WMSG := '';

  --SELECT @TTL_REC_COUNT = COUNT(*) 
  --  FROM RSP008
  -- WHERE BATCH_ID = @BATCH_ID
  --   AND SEAL_TYPE = @SEAL_TYPE
  --   AND SUB_STATUS <> '1'
  --IF @TTL_REC_COUNT > 0
  --  BEGIN
  --    SET @MSG = '在契約扣款檔中有不是扣款中的資料'
  --    RETURN
  --  END

  --SELECT @TTL_REC_COUNT = COUNT(*) 
  --  FROM OFD221A,OFD220A
  -- WHERE OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
  --   AND OFD221A.BATCH_ID = @BATCH_ID
  --   AND OFD220A.SEAL_TYPE = @SEAL_TYPE
  --   AND OFD221A.SUB_STATUS <> '1'
  --IF @TTL_REC_COUNT > 0
  --  BEGIN
  --    SET @MSG = '在申購檔有不是扣款中的資料'
  --    RETURN
  --  END

  SELECT COUNT(*) INTO XTTL_REC_COUNT 
    FROM ECS.PURCHASE 
   WHERE PURCHASE.BATCH_ID = WBATCH_ID
     AND PURCHASE.SUB_STATUS <> '1';

  IF XTTL_REC_COUNT > 0 THEN
    WMSG := '在網路/語音申購檔中有不是扣款中的資料';
    RETURN;
  END IF ;

  ----將定額契約扣款檔中該批的批次識別碼及交易清空,扣款狀態改成未扣款  
  --UPDATE RSP008
  --   SET BATCH_ID = '',
  --       BATCH_SRNO = 0,
  --       SUB_STATUS = '0',
  --       TRADE_NO = ''
  -- WHERE BATCH_ID = @BATCH_ID
  --   AND SUB_STATUS = '1'

  ----將申購檔中該批的批次識別碼及交易清空清空,扣款狀態改成未扣款  
  --UPDATE OFD221A
  --   SET BATCH_ID = '',
  --       BATCH_SRNO = 0,
  --       SUB_STATUS = '0',
  --       TRADE_NO = ''
  -- WHERE BATCH_ID = @BATCH_ID
  --   AND SUB_STATUS = '1'

  -- 2019.09.17 tingting 增加資料異動，寫入ECS.PURCHASE_LOG
  INSERT INTO ECS.PURCHASE_LOG
  (
         FUND_NO
        ,ID
        ,TX_DATE
        ,BROKER_NO
        ,BRANCH_NO

        ,SER_NO
        ,AMOUNT
        ,SERVICE_CHARGE
        ,PAY_TYPE
        ,REMARK

        ,BANK_NO
        ,AC_CODE
        ,PROJECT_CODE
        ,ACTION_TYPE
        ,REVISION_DATE

        ,AC_DATE
        ,AC_BRANCH
        ,CURRENCY_NO
        ,PROSPECTUS
        ,TRANSACTION_NO

        ,USED_POINT
        ,IP_A
        ,IP_B
        ,IP_C
        ,IP_D

        ,INVESTMENT_RISK
        ,CHANNEL_EXPOSE
        ,ONSHORE_SHORT_TRADE
        ,ROBO_CONTRACT_NO
        ,ROBO_SER_NO

        ,FEE_CHOICE                   
        ,COUPON_ID
        ,SC_RATE 
        ,ROBO_BATCH_NO                   
        ,AC_CNT
        ,IS_INVEST_RISK
        ,BATCH_ID 
        ,BATCH_SRNO 
        ,TRADE_NO 
        ,SUB_STATUS 
        ,NONSUCS_CODE 
        ,BANK_MEDIA_CODE 
  )
  SELECT FUND_NO                   --基金別
        ,ID                       --ID
        ,TX_DATE                  --交易日期
        ,BROKER_NO                --代銷單位
        ,BRANCH_NO                --代銷分公司碼

        ,SER_NO                   --交易序號
        ,AMOUNT                   --申購價金
        ,SERVICE_CHARGE           --手續費
        ,PAY_TYPE                 --付款方式
        ,REMARK                   --備註

        ,BANK_NO                  --銀行代號
        ,AC_CODE                  --銀行帳號
        ,PROJECT_CODE             --專案碼
        ,'M'                      --交易動作(A:新增/M:修改/D:刪除)
        ,XSYS_DTTM                --最後修改日期

        ,AC_DATE                  --淨值日
        ,AC_BRANCH                --扣款分行代碼
        ,CURRENCY_NO              --幣別
        ,PROSPECTUS               --公開說明書
        ,USED_POINT               --使用紅利

        ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
        ,IP_A                     --IP A
        ,IP_B                     --IP B
        ,IP_C                     --IP C
        ,IP_D                     --IP D

        ,INVESTMENT_RISK          --投資風險評估
        ,CHANNEL_EXPOSE           --通路報酬揭露
        ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
        ,ROBO_CONTRACT_NO         --ROBO契約書號
        ,ROBO_SER_NO              --ROBO交易書號

        ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
        ,COUPON_ID                --優惠券號碼
        ,SC_RATE                  --申購手續費率
        ,ROBO_BATCH_NO            --ROBO再平衡批次編號
        ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
        ,IS_INVEST_RISK           --目標到期投資風險預告書
        ,'' BATCH_ID 
        ,NULL BATCH_SRNO 
        ,'' TRADE_NO 
        ,'0' SUB_STATUS 
        ,NONSUCS_CODE 
        ,BANK_MEDIA_CODE 
    FROM ECS.PURCHASE PURCHASE
   WHERE BATCH_ID = WBATCH_ID
     AND SUB_STATUS = '1';

  --將網路/語音申購檔中該批的批次識別碼及交易清空清空,扣款狀態改成未扣款  
  UPDATE ECS.PURCHASE
     SET BATCH_ID = '',
         BATCH_SRNO = NULL,
         SUB_STATUS = '0',
         TRADE_NO = '',
         DEDUCT_DATE = NULL,
         STATUS = 'O',
         RESULT_CODE = '00'
   WHERE BATCH_ID = WBATCH_ID
     AND SUB_STATUS = '1';

  WIsSuccess := 'Y';

END s_DeductAmt_Process_6;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_6" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_BYCRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_BYCRY" 
-- =============================================
-- Author:stu
-- Create date: 2008/09/11
-- Description:扣款處理	
-- 2019.06.06 JIANXIN 由sql 版本調整為Oracle 版本
-- =============================================
(
         WEXEC_USERID     VARCHAR2              --執行人員
        ,WBATCH_ID        VARCHAR2              --批次識別碼(每批不可重覆)
        ,WJOB_ID          VARCHAR2              --工作別 2.扣款  4.重出扣款文字檔  6.取消該批扣款
        ,WSEAL_TYPE       VARCHAR2              --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2              --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   VARCHAR2              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2              --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2              --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2              --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2              --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2              --是否含扣款失敗資料  Y.含  N.不含 O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER                --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2              --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2              --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2              --檔名命名方式\1.由前端指定  2.
        ,WFAIL_CODE       VARCHAR2              --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2              --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2             --訊息：存放錯誤訊息
)
IS 

XACT_DDCT_DATE DATE := TO_DATE(WACT_DDCT_DATE,'YYYYMMDD');

BEGIN

   IF WJOB_ID = '2'  THEN --扣款

     ECS.s_DeductAmt_Process_2_ByCry ( WEXEC_USERID        --執行人員
                                      ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                      ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                      ,WBUSS_ID            --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
                                      ,XACT_DDCT_DATE      --實際扣款日期
                                      ,WAGENT_BANK         --代理銀行(總行)
                                      ,WISAGENTBANK        --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
                                      ,WISFUND             --指定基金 0.全部  9.指定
                                      ,WFUND_ID            --指定基金代碼
                                      ,WISINCLUDEFAIL      --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
                                      ,WMAX_FILE_COUNT     --文字檔筆數限制 (0 表示無限制)
                                      ,WTRP_TYPE           --連外介面平台種類代碼
			                                   ,WMEDIA_NO           --傳檔媒體編號
			                                   ,WFILE_NAMING_WAY    --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
                                      ,WFAIL_CODE          --扣款錯誤代碼LIST
                                      ,WIsSuccess          --成功否：Y.成功  N.失敗
                                      ,WMSG                --訊息：存放錯誤訊息
                                     );

   ELSIF WJOB_ID = '4' THEN--重出扣款文字檔

       WIsSuccess := 'Y';
       WMSG := '';

   ELSIF WJOB_ID = '6' THEN  --取消該批扣款(該批扣款中不可有扣款狀態不為"扣款中"的資料)

     ECS.s_DeductAmt_Process_6 ( WEXEC_USERID        --執行人員
                                ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                ,WIsSuccess          --成功否：Y.成功  N.失敗
                                ,WMSG                --訊息：存放錯誤訊息
                               );
   END IF ; 

END s_DeductAmt_Process_ByCry;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_BYCRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DEDUCTAMT_PROCESS_BYFNDCRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DEDUCTAMT_PROCESS_BYFNDCRY" 
-- =============================================
-- Author:JIANXIN
-- Create date: 2019/08/13
-- Description:扣款處理	
-- =============================================
(
         WEXEC_USERID     VARCHAR2              --執行人員
        ,WBATCH_ID        VARCHAR2              --批次識別碼(每批不可重覆)
        ,WJOB_ID          VARCHAR2              --工作別 2.扣款  4.重出扣款文字檔  6.取消該批扣款
        ,WSEAL_TYPE       VARCHAR2              --扣款途徑 1.一般 2.ACH  3.財金
        ,WBUSS_ID         VARCHAR2              --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
        ,WACT_DDCT_DATE   VARCHAR2              --實際扣款日期
        ,WAGENT_BANK      VARCHAR2              --代理銀行(總行)
        ,WISAGENTBANK     VARCHAR2              --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
        ,WISFUND          VARCHAR2              --指定基金 0.全部  9.指定
        ,WFUND_ID         VARCHAR2              --指定基金代碼
        ,WISINCLUDEFAIL   VARCHAR2              --是否含扣款失敗資料  Y.含  N.不含 O.只有扣款失敗資料
        ,WMAX_FILE_COUNT  NUMBER                --文字檔筆數限制 (0 表示無限制)
        ,WTRP_TYPE        VARCHAR2              --連外介面平台種類代碼
        ,WMEDIA_NO        VARCHAR2              --傳檔媒體編號
        ,WFILE_NAMING_WAY VARCHAR2              --檔名命名方式\1.由前端指定  2.
        ,WFAIL_CODE       VARCHAR2              --扣款錯誤代碼LIST
        ,WIsSuccess OUT   VARCHAR2              --成功否：Y.成功  N.失敗
        ,WMSG OUT         NVARCHAR2             --訊息：存放錯誤訊息
)
IS 

XACT_DDCT_DATE DATE := TO_DATE(WACT_DDCT_DATE,'YYYYMMDD');

BEGIN

   IF WJOB_ID = '2'  THEN --扣款

     ECS.s_DeductAmt_Process_2_ByFndCry ( WEXEC_USERID        --執行人員
                                         ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                         ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                         ,WBUSS_ID            --業務別 字元1.定期定額  字元2.指定扣款  字元3.EC扣款  字元4.IVR扣款
                                         ,XACT_DDCT_DATE      --實際扣款日期
                                         ,WAGENT_BANK         --代理銀行(總行)
                                         ,WISAGENTBANK        --扣款銀行 1.是代理行  2.非代理行  0.全部  9.指定
                                         ,WISFUND             --指定基金 0.全部  9.指定
                                         ,WFUND_ID            --指定基金代碼
                                         ,WISINCLUDEFAIL      --是否含扣款失敗資料  Y.含  N.不含  O.只有扣款失敗資料
                                         ,WMAX_FILE_COUNT     --文字檔筆數限制 (0 表示無限制)
                                         ,WTRP_TYPE           --連外介面平台種類代碼
			                                      ,WMEDIA_NO           --傳檔媒體編號
			                                      ,WFILE_NAMING_WAY    --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
                                         ,WFAIL_CODE          --扣款錯誤代碼LIST
                                         ,WIsSuccess          --成功否：Y.成功  N.失敗
                                         ,WMSG                --訊息：存放錯誤訊息
                                        );

   ELSIF WJOB_ID = '4' THEN--重出扣款文字檔

       WIsSuccess := 'Y';
       WMSG := '';

   ELSIF WJOB_ID = '6' THEN  --取消該批扣款(該批扣款中不可有扣款狀態不為"扣款中"的資料)

     ECS.s_DeductAmt_Process_6 ( WEXEC_USERID        --執行人員
                                ,WBATCH_ID           --批次識別碼(每批不可重覆)
                                ,WSEAL_TYPE          --扣款途徑 1.一般 2.ACH  3.財金
                                ,WIsSuccess          --成功否：Y.成功  N.失敗
                                ,WMSG                --訊息：存放錯誤訊息
                               );
   END IF ; 

END s_DeductAmt_Process_ByFndCry;

/

  GRANT EXECUTE ON "ECS"."S_DEDUCTAMT_PROCESS_BYFNDCRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DELOBSERVATIONFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DELOBSERVATIONFUNDDATA" 
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WFUND_NO               VARCHAR2,          -- 基金代碼
     WISIN_CODE             VARCHAR2,          -- 國際證券代碼
     OUTDT                  OUT SYS_REFCURSOR  -- DelObservationErrList
) IS

XID VARCHAR2(10);          -- 受益人ID
XFUND_NO VARCHAR2(5);      -- 基金代碼
XWARNS_TYPE VARCHAR2(1);   -- 警示方式
XERROR_MSG VARCHAR2(100);  -- 錯誤訊息
BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        XWARNS_TYPE := '3';
        XERROR_MSG := '無法取得受益人ID，請檢查！';
        GOTO TO_ERR;
  END;

  -- 2018.05.30 ChengYu 傳入的 基金代碼、國際證券代碼，都找不到資料庫的基金代碼才出錯誤訊息 BEGIN
  BEGIN
    SELECT FUND.FUND_NO
      INTO XFUND_NO
      FROM FAS.FUND FUND
     WHERE FUND.FUND_NO = WFUND_NO;

    EXCEPTION
    WHEN NO_DATA_FOUND THEN
    BEGIN          
    SELECT FUND.FUND_NO
      INTO XFUND_NO
      FROM FAS.FUND FUND
     WHERE FUND.ISIN_CODE = WISIN_CODE;

    EXCEPTION
         WHEN NO_DATA_FOUND THEN
         BEGIN
           XWARNS_TYPE := '3';
           XERROR_MSG := 'FUND_NO：'||WFUND_NO||',ISIN_CODE：'||WISIN_CODE|| ' 無法取得基金代碼，請檢查！';
           GOTO TO_ERR;
         END;
    END;
  END;
  -- 2018.05.30 ChengYu 傳入的 基金代碼、國際證券代碼，都找不到資料庫的基金代碼才出錯誤訊息 END

  DELETE FROM WPS.FUND_ALERT FUND_ALERT
   WHERE FUND_ALERT.ID = XID
     AND FUND_ALERT.FUND_NO = XFUND_NO
     AND FUND_ALERT.TYPE ='1';

  DELETE FROM WPS.FUND_ALERT_TYPE FUND_ALERT_TYPE
   WHERE FUND_ALERT_TYPE.ID = XID
     AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
     AND FUND_ALERT_TYPE.TYPE = '1';

    <<TO_ERR>>
    -- DelObservationErrList
    OPEN OUTDT FOR
  SELECT  XWARNS_TYPE AS WARNS_TYPE
         ,XERROR_MSG AS ERROR_MSG
    FROM DUAL;

END s_DelObservationFundData;

/

  GRANT EXECUTE ON "ECS"."S_DELOBSERVATIONFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_DELSHOPPINGCARTMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_DELSHOPPINGCARTMP" 
(
     WACCOUNT_NO            INTEGER   -- 受益人戶號
) IS

XID VARCHAR2(10);          -- 受益人ID

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  BEGIN

    DELETE FROM ECS.SHOP_CART SHOP_CART
     WHERE SHOP_CART.ID = XID;

/*    IF SQL%NOTFOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '購物車紀錄檔無此人資料！');
    END IF;*/
  END;

END s_DelShoppingCarTmp;

/

  GRANT EXECUTE ON "ECS"."S_DELSHOPPINGCARTMP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB001_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB001_EXECUTE" 
-- =============================================
-- Author:      STU
-- Create date: 2018/06/29
-- Description: 紅利點數折抵入帳作業
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WREWARD_COUNT           OUT NUMBER,       --紅利交易資料筆數
    CMSGLIST                OUT SYS_REFCURSOR --回傳的 TABLEDATA(若有資料表示資料檢核有錯)
) IS
  --變數宣告
  XCONDITION_DATE DATE;
  XCONDITION_TIME VARCHAR2(4);
  XSYS_DTTM DATE;

BEGIN
  --給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期

 SELECT CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
             THEN '1200'
             WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
             THEN '1600'
         END
   INTO XCONDITION_TIME
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR 
         TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI');--取得傳入參數中的時分
  XSYS_DTTM := sysdate;--取得系統日期時間

  --取得基金表(FundList)
  INSERT INTO ECS.FundList
        (FUND_NO,REC_TYPE)
  --自基金主檔中取得EC 單筆申購及RSP申購關帳時間等於傳入參數中的時分的基金列(FundList)
  SELECT A.FUND_NO,
         '1' REC_TYPE --申購
    FROM FAS.FUND A
   WHERE TO_CHAR(A.EC_PUR_CUT_OFF,'HH24MI') = XCONDITION_TIME
  UNION ALL
  --自基金主檔中取得EC 買回關帳時間等於傳入參數中的時分的基金列
  SELECT A.FUND_NO,
         '2' REC_TYPE --轉出
    FROM FAS.FUND A
   WHERE TO_CHAR(A.EC_RED_CUT_OFF,'HH24MI') = XCONDITION_TIME;

  --取得紅利交易資料表(ECSB001_REWARDTRADE)
  INSERT INTO ECSB001_REWARDTRADE
        (TRANSACTION_NO,ID,USE_TYPE,REWARD_NO,USED_POINT)
  SELECT Trade.TRANSACTION_NO, --交易編號()FOR 紅利及優惠券使用
         Trade.ID,
         Trade.USE_TYPE,       --使用類別
         B.REWARD_NO,          --紅利編號
         B.USED_POINT          --使用點數(本次使用的點數)
    FROM (
          --自EC申購中取得交易日期為傳入參數中的日期且基金存在基金列中的紅利交易資料列
          SELECT A.TRANSACTION_NO,A.ID,'1' USE_TYPE
            FROM ECS.PURCHASE A
            JOIN ECS.FundList B ON B.FUND_NO = A.FUND_NO AND B.REC_TYPE = '1'
           WHERE A.TX_DATE = XCONDITION_DATE
          UNION ALL
          --自EC買回中取得交易日期為傳入參數中的日期且基金存在基金列中的紅利交易資料列
          SELECT A.TRANSACTION_NO,A.ID,'2' USE_TYPE
            FROM ECS.REDEMPTION A
            JOIN ECS.FundList B ON B.FUND_NO = A.FUND_NO AND B.REC_TYPE = '2'
           WHERE A.TX_DATE = XCONDITION_DATE
         ) Trade
    JOIN FAS.REWARD_DETAILS B ON B.TRANSACTION_NO = Trade.TRANSACTION_NO AND B.USE_TYPE = Trade.USE_TYPE;

  --將紅利歷史使用明細(FAS.REWARD_HISTORY)檔中有與紅利交易資料表相同的交易編號及使用類別的交易類別設為'U'(使用)及
  --                                          的使用點數累加至紅利配發資料檔中
  DECLARE Cursor UPD_CUR IS
     SELECT *
       FROM ECS.ECSB001_REWARDTRADE;  --紅利交易資料表
  BEGIN
    FOR UPD_REC IN UPD_CUR LOOP
      --將紅利歷史使用明細中的交易類別為'W'(預扣)者設為'U'(使用)
      UPDATE FAS.REWARD_HISTORY
         SET TX_TYPE = 'U'
       WHERE TRANSACTION_NO = UPD_REC.TRANSACTION_NO
         AND USE_TYPE = UPD_REC.USE_TYPE
         AND TX_TYPE = 'W'; --預扣

      --將紅利交易資料表中的使用點數累加至紅利配發資料檔中
      UPDATE FAS.REWARD_POINT
         SET USED_POINT = USED_POINT + UPD_REC.USED_POINT,
             REVISED_BY = WEXEC_UERID,
             REVISION_DATE = XSYS_DTTM,
             UPDATEID = WEXEC_UERID,
             UPDATEDATE = XSYS_DTTM
       WHERE REWARD_NO = UPD_REC.REWARD_NO
         AND ID = UPD_REC.ID;
    END LOOP;
  END;

  --取得紅利交易資料表中的筆數,並傳回前端
  SELECT COUNT(*) INTO WREWARD_COUNT
    FROM ECS.ECSB001_REWARDTRADE;

  --檢核更新後的紅利點數帳務是否正確
  OPEN CMSGLIST FOR
  SELECT '查詢'||X.ID||'紅利編號:'||TO_CHAR(X.REWARD_NO)||'已使用點數'||TO_CHAR(X.USED_POINT_B)||'點與交易使用點數'||TO_CHAR(X.USED_POINT_A)||'點不合!' AS MSG
    FROM (
          SELECT Z.ID,Z.REWARD_NO,
                 SUM(Z.USED_POINT_A) USED_POINT_A,
                 SUM(Z.USED_POINT_B) USED_POINT_B
            FROM (
                  SELECT A.ID,                           --ID
                         B.REWARD_NO,                    --紅利編號
                         SUM(B.USED_POINT) USED_POINT_A, --紅利交易使用點數資料表的使用點數合計
                         0 USED_POINT_B
                    FROM FAS.REWARD_HISTORY A
                    JOIN FAS.REWARD_DETAILS B ON B.TRANSACTION_NO = A.TRANSACTION_NO AND B.USE_TYPE = A.USE_TYPE
                   WHERE A.TX_TYPE = 'U' --已使用
                   GROUP BY A.ID,B.REWARD_NO
                  UNION ALL
                  SELECT A.ID,                           --ID
                         A.REWARD_NO,                    --紅利編號
                         0 USED_POINT_A,
                         SUM(A.USED_POINT) USED_POINT_B  --紅利配發資料的使用點數合計
                    FROM FAS.REWARD_POINT A
                   GROUP BY A.ID,A.REWARD_NO
                 ) Z
           GROUP BY Z.ID,Z.REWARD_NO
         ) X
   WHERE X.USED_POINT_A <> X.USED_POINT_B;

END S_ECSB001_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB001_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/29
-- Description: RSP & DRSP 後續交易處理入口點
-- 2018.10.29 ChengYu 補上Table來源
-- 2018.11.07 PAN MOD 調整判斷是否執行過此功能，增加時間點的判斷
-- 2018.12.26 yunchu MOD 增加判斷是否為台灣銀行公會營業日
-- 2019.01.02 yunchu MOD 調整假日執行程式時，訊息為空
-- 2019.07.18 JIANXIN MOD 1. 新增申購交易種類，僅申購與RSP使用
--                        2. 調整資料取得問題
-- =============================================
(
    WEXEC_DATE              IN DATE,           --執行條件日期時分
    WEXEC_TYPE              IN VARCHAR2,       --執行(A:全部功能(含契約異動生效,更新忠實戶專案碼,產生應扣款資料), B:僅重新產生扣款資料(先刪除再新增), C.僅刪除扣款資料)
    WEXEC_UERID             IN VARCHAR2,       --執行者代碼
  	WChkCALENDAR            IN VARCHAR2,       --判斷日曆日
    WFINSISH_CODE           OUT VARCHAR2,      --完成狀能(S:執行成功, F:執行失敗, X:全部功能重複執行)
    WTOT_DDCT_COUNT         OUT NUMBER,        --扣款總筆數
    CMSGLIST                OUT SYS_REFCURSOR  --回傳有問題的基金資料表或成功的基金表列
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XCONDITION_TIME VARCHAR2(4); --執行時間
  XERRMSG VARCHAR2(100);       --錯誤訊息
  ------------------------------------------------------
  XTX_DATE DATE;               --交易日期
  XNAV_DATE DATE;              --淨值日期
  XCOUNT NUMBER(9);            --筆數
  --2018.11.07 PAN MOD
  XCONDITION_TIME2 VARCHAR2(8); --執行時間


BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期

 SELECT  CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '1200'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '1600'
          END
        --2018.11.07 PAN MOD
        ,CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '12:00:00'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '16:00:00'
          END
   INTO  XCONDITION_TIME
        ,XCONDITION_TIME2
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR 
		 TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI'); --取得傳入參數中的時分
  WFINSISH_CODE := 'S';
  WTOT_DDCT_COUNT := 0;

  --1.1 同一執行條件日期時分,不可重複執行全部功能
  IF WEXEC_TYPE = 'A' THEN
    SELECT COUNT(*) INTO XCOUNT
      FROM FAS.EC_RSP_TRANSFER_LOG A
     WHERE A.TX_DATE = XCONDITION_DATE
	   --2018.11.07 PAN MOD
       --AND A.SET_TIME = XCONDITION_TIME
       AND A.SET_TIME = XCONDITION_TIME2
       AND A.TYPE IN ('P','N','M');
    IF XCOUNT > 0 THEN
      WFINSISH_CODE := 'X';
      OPEN CMSGLIST FOR
        SELECT '該執行條件的全部功能已執行過,不可再執行' AS MSG FROM DUAL;

      RETURN;
    END IF;
  END IF;

  --2.取得申購基金列表
  DECLARE Cursor FUND_CUR IS
    SELECT A.FUND_NO,
           '1' REC_TYPE --申購
      FROM FAS.FUND A
     WHERE TO_CHAR(A.EC_PUR_CUT_OFF,'HH24MI') = XCONDITION_TIME;
  BEGIN
    FOR FUND_REC IN FUND_CUR LOOP
      --2.1 計算交易日期
      -- 2019.07.18 JIANXIN MOD 新增申購交易種類，僅申購與RSP使用
      XTX_DATE := ECS.F_GetAnyCalendarDate(FUND_REC.FUND_NO,'TA',XCONDITION_DATE,'2');
      IF XTX_DATE IS NULL THEN
        XTX_DATE := TO_DATE('2000/01/01','YYYY/MM/DD');
      END IF;

      --2.2 計算淨值日期
      IF XTX_DATE = TO_DATE('2000/01/01','YYYY/MM/DD') THEN
        XNAV_DATE := TO_DATE('2000/01/01','YYYY/MM/DD');
      ELSE
        -- 2019.07.18 JIANXIN MOD 新增申購交易種類，僅申購與RSP使用
        XNAV_DATE := ECS.F_GetAnyCalendarDate(FUND_REC.FUND_NO,'NA',XTX_DATE,'2');
      END IF;

      --2.3 將上述資料寫入申購基金列表暫存檔
      -- 2018.10.29 ChengYu 補上Table來源
      INSERT INTO ECS.Fundlist (FUND_NO,TX_DATE,NAV_DATE)
        VALUES (FUND_REC.FUND_NO,XTX_DATE,XNAV_DATE);

    END LOOP;
  END;

  --3.取得可交易基金列表：即申購基金列表中交易日期為執行日期(XCONDITION_DATE)的基金
  --  將Fundlist中交易日期不為執行日期的基金刪除,留下的即是可交易基金)
  DELETE
    -- 2018.10.29 ChengYu 補上Table來源
    FROM ECS.Fundlist
   WHERE TX_DATE <> XCONDITION_DATE;

  --3.1 若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則結束本作業，並回傳錯誤訊息
  SELECT COUNT(*) INTO XCOUNT
    -- 2018.10.29 ChengYu 補上Table來源
    FROM ECS.Fundlist
   WHERE XTX_DATE = TO_DATE('2000/01/01','YYYY/MM/DD')
      OR XNAV_DATE = TO_DATE('2000/01/01','YYYY/MM/DD');

  IF XCOUNT > 0 THEN
    WFINSISH_CODE := 'F';
    OPEN CMSGLIST FOR
      SELECT FUND_NO||'基金，交易日行事曆無法取得資料' AS MSG
        -- 2018.10.29 ChengYu 補上Table來源
        FROM ECS.Fundlist
       WHERE TX_DATE = TO_DATE('2000/01/01','YYYY/MM/DD')
      UNION
      SELECT FUND_NO||'基金，淨值日行事曆無法取得資料' AS MSG
        -- 2018.10.29 ChengYu 補上Table來源
        FROM ECS.Fundlist
        -- 2019.07.18 JIANXIN MOD 調整資料取得問題
       WHERE NAV_DATE = TO_DATE('2000/01/01','YYYY/MM/DD');

    RETURN;
  END IF;

  --4.執行指定的功能
  -- 2018.12.26 yunchu MOD 增加判斷是否為台灣銀行公會營業日
  IF WChkCALENDAR != '0' THEN
    ECS.S_ECSB002_Execute_NEW(WEXEC_DATE,WEXEC_UERID);              --RSP&DRSP契約新件
    ECS.S_ECSB002_Execute_VALID(WEXEC_DATE,WEXEC_UERID);            --RSP&DRSP契約異動資料生效
    -- 2019.01.02 yunchu MOD 調整假日執行程式時，訊息為空
    OPEN CMSGLIST FOR SELECT '' AS MSG FROM DUAL;

  ELSE	
	IF WEXEC_TYPE = 'A' THEN --全部功能(含契約異動生效,更新忠實戶專案碼,產生應扣款資料)
		ECS.S_ECSB002_Execute_NEW(WEXEC_DATE,WEXEC_UERID);              --RSP&DRSP契約新件
		ECS.S_ECSB002_Execute_VALID(WEXEC_DATE,WEXEC_UERID);            --RSP&DRSP契約異動資料生效
		ECS.S_ECSB002_Execute_LOYAL(WEXEC_DATE,WEXEC_UERID);            --RSP&DRSP契約更新忠實戶專案碼
		ECS.S_ECSB002_Execute_PROMO(WEXEC_DATE,WEXEC_UERID);            --RSP&DRSP契約更新RT.(不)定額特定次數促銷活動專案的契約費率
		ECS.S_ECSB002_Execute_DEDUCT(WEXEC_DATE,WEXEC_UERID,WTOT_DDCT_COUNT,CMSGLIST);  --RSP&DRSP契約產生應扣款資料
	ELSE
	IF WEXEC_TYPE = 'B' THEN --僅重新產生扣款資料(先刪除再新增)
		ECS.S_ECSB002_Execute_UNDODDCT(WEXEC_DATE,WEXEC_UERID,XERRMSG); --僅刪除扣款資料
		IF XERRMSG IS NOT NULL THEN
		WFINSISH_CODE := 'F';
		OPEN CMSGLIST FOR SELECT XERRMSG AS MSG FROM DUAL;
		RETURN;
		END IF;
		ECS.S_ECSB002_Execute_DEDUCT(WEXEC_DATE,WEXEC_UERID,WTOT_DDCT_COUNT,CMSGLIST);  --RSP&DRSP契約產生應扣款資料
	ELSE
	IF WEXEC_TYPE = 'C' THEN --僅刪除扣款資料
		ECS.S_ECSB002_Execute_UNDODDCT(WEXEC_DATE,WEXEC_UERID,XERRMSG); --僅刪除扣款資料
		IF XERRMSG IS NOT NULL THEN
		WFINSISH_CODE := 'F';
		OPEN CMSGLIST FOR SELECT XERRMSG AS MSG FROM DUAL;
		ELSE
		OPEN CMSGLIST FOR SELECT XERRMSG AS MSG FROM DUAL WHERE DUMMY IS NULL;
		END IF;
	END IF;
	END IF;
	END IF;
  END IF;

END S_ECSB002_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_DEDUCT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_DEDUCT" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/31
-- Description: RSP&DRSP契約產生應扣款資料
-- 2018.10.31 ChengYu 修正因f_GetTxNo新增傳入參數而造成的錯誤
-- 2018.11.06 PAN MOD 修正日期拆組造成的格式錯誤
-- 2018.11.09 tingting 寫入FAS.EC_RSP_PURCHASE 增加寫入AC_DAY欄位
-- 2018.11.13 yunchu MOD 調整扣款總筆數為明細加總
-- 2018.11.20 JIANXIN MOD 調整扣款手續費計算
-- 2018.11.29 JIANXIN MOD 移除刪除紀錄
-- 2018.11.29 JIANXIN MOD 調整報酬率公式、調整減碼註記
-- 2018.11.30 JIANXIN MOD IS_EMAIL 預設為 N
-- 2019.01.25 yunchu 增加判斷異動後首次扣款日
-- 2019.03.04 JIANXIN 1. 因應跨月產生扣款資料處理
--                    2. 生日優惠扣款處理調整(因緊急上版正式區尚未有備註)
-- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
-- 2022.01.11 JIANXIN 調整報酬率處理計算
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WTOT_DDCT_COUNT         OUT NUMBER,       --扣款總筆數
    CMSGLIST                OUT SYS_REFCURSOR --回傳有問題的基金資料表或成功的基金表列
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XCONDITION_TIME VARCHAR2(4); --執行時間
  XCONDITION_YM VARCHAR2(6);   --執行年月
  XSYS_DTTM DATE;              --系統日期時間
  XCOUNT NUMBER(9);            --資料筆數
  ----------------------------------------------------------
  XRETURN_RATE NUMBER(6,4);    --投資報酬率
  XROI_TAG VARCHAR2(1);        --到達加(減)碼否
  XSUB_AMT NUMBER(12,3);       --扣款金額
  XCAL_DATE DATE;              --庫存計算日
  -- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
  XTOT_SHARES NUMBER(18,6);    --總庫存單位數
  XTOT_COST NUMBER(14,2);      --總投資成本
  XMARKET_PRICE NUMBER(14,4);  --市價總值
  XFEE_CHOICE VARCHAR2(1);     --手續費方案
  XFEE_PROJECT_CODE VARCHAR2(6); --手續費專案碼
  XSERVICE_CHARGE NUMBER(12,3);  --手續費
  XFEE_RATE NUMBER(7,4);       --手續費率
  XSER_NO VARCHAR2(4);         --交易序號
  --2018.11.06 PAN MOD
  XLastDate varchar2(8);        --上次交易日期
  XCONDITION_TIME2 VARCHAR2(8); --執行時間

BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期

 SELECT  CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '1200'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '1600'
          END
        --2018.11.06 PAN MOD
        ,CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '12:00:00'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '16:00:00'
          END
   INTO  XCONDITION_TIME
        ,XCONDITION_TIME2
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR
     TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI'); --取得傳入參數中的時分
  XCONDITION_YM := TO_CHAR(WEXEC_DATE,'YYYYMM');
  XSYS_DTTM := sysdate; --取得系統日期時間

  --2.抓取符合的網路RSP&DRSP契約新件資料，新增至【後台EC RSP契約資料(FAS.EC_RSP)】檔
  --2.1 以『執行時間』至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔，取得「交易類別(TYPE)」='P' 最新一次的處理記錄資料
  FOR DDCT_REC IN
    ( SELECT Z.FUND_NO,MAX(LastDateTime) LastDateTime
        FROM (
              SELECT A.FUND_NO,   --契約基金代碼
                     CASE WHEN B.FUND_NO IS NULL THEN TO_DATE('20000101'||' '||XCONDITION_TIME,'YYYYMMDD  HH24MI') --無資料時,為2000/01/01+執行時間(XCONDITION_TIME)
                          --2018.11.06 PAN MOD
                          --ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'YYYYMMDD HH24MI') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                          ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'yyyymmdd hh24:mi:ss') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                      END AS LastDateTime   --上次交易日期時間
                FROM ECS.FundList A
                LEFT JOIN FAS.EC_RSP_TRANSFER_LOG B
                  ON B.FUND_NO = A.FUND_NO
                 AND B.TYPE = 'P' --產生應扣款資料
                 --2018.11.06 PAN MOD
                 --AND B.SET_TIME = XCONDITION_TIME
                 AND B.SET_TIME = XCONDITION_TIME2

             ) Z
       --WHERE Z.FUND_NO = 'D46'
       GROUP BY Z.FUND_NO
       ORDER BY Z.FUND_NO
    ) LOOP

      --2018.11.06 PAN MOD
      XLastDate := TO_CHAR(DDCT_REC.LastDateTime,'YYYYMMDD'); --TO_DATE(DDCT_REC.LastDateTime, 'YYYY/MM/DD');

      XCOUNT := 0;
      --2.2 以上述的「契約基金代碼」至【後台EC RSP契約資料(FAS.EC_RSP)】取得「契約狀態(STATUS)」='4.有效'且
      --    且『執行年月』加上「扣款日(AC_DAY)」大於「上次交易日期時間」且小於等於傳入的執行條件日期時分
      --    的契約資料
      FOR RSP_REC IN
        (SELECT A.*,
               TO_CHAR(B.BIRTH_DATE,'MM') BIRTH_MM, --出生月份
               NVL(E.AMT_DECIMAL,0) TRADE_AMT_DECIMAL, --扣款幣別小數位數
               CASE WHEN A.PRODUCT_TYPE = 'P8' THEN '8200' ELSE '8400' END BRANCH_NO_DDCT, --代銷分公司碼
               F.TX_DATE, --交易日期
               F.NAV_DATE, --淨值日期
               ABS((C.BEHIND_DAYS*-1) - 4) CAL_DAYS, --庫存計算天數(=[記帳日落差天數*-1] - 4取絕對值)
               CASE WHEN G.FUND_NO IS NOT NULL THEN G.NAV --淨值
                    ELSE (SELECT NAV FROM NAV.NAV --若指定淨值日當天無淨值,則找最近一天的淨值
                           WHERE FUND_NO = A.FUND_NO
                             AND NAV_DATE = (SELECT MAX(NAV_DATE) FROM NAV.NAV
                                              WHERE FUND_NO = A.FUND_NO AND NAV_DATE <= F.NAV_DATE))
                END NAV --淨值
          FROM FAS.EC_RSP A
          LEFT JOIN FAS.HOLDER B ON B.ID = A.ID
          JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
          --LEFT JOIN FAS.FIS_BANK D ON D.BANK_NO = A.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY E ON E.CURRENCY_NO = A.CURRENCY_NO
          JOIN ECS.FundList F ON F.FUND_NO = A.FUND_NO
          LEFT JOIN NAV.NAV G ON G.FUND_NO = A.FUND_NO AND G.NAV_DATE = F.NAV_DATE
         WHERE A.FUND_NO = DDCT_REC.FUND_NO  --契約基金代碼
           AND A.STATUS = '4' --有效
           --2018.11.06 PAN MOD
           --AND TO_DATE(SUBSTRB(XCONDITION_YM,1,4)||'/'||SUBSTRB(XCONDITION_YM,5,2)||'/'||A.AC_DAY,'YYYY/MM/DD') > DDCT_REC.LastDateTime
           --AND TO_DATE(SUBSTRB(XCONDITION_YM,1,4)||'/'||SUBSTRB(XCONDITION_YM,5,2)||'/'||A.AC_DAY,'YYYY/MM/DD') <= WEXEC_DATE
           -- 2019.03.04 JIANXIN 因應跨月產生扣款資料處理
           AND (
                 (
                   SUBSTRB(XLastDate,0,6)  <> XCONDITION_YM
                   AND 
                   (
                         ( SUBSTRB(XLastDate,0,6)  || TO_CHAR(LPAD(A.AC_DAY,2,'0')) ) > XLastDate
                     OR  (XCONDITION_YM || LPAD(A.AC_DAY,2,'0')) <= TO_CHAR(WEXEC_DATE,'YYYYMMDD')
                   )

                )
                 OR 
                (
                       SUBSTRB(XLastDate,0,6)   =  XCONDITION_YM
                   AND (XCONDITION_YM || LPAD(A.AC_DAY,2,'0')) > XLastDate
                   AND (XCONDITION_YM || LPAD(A.AC_DAY,2,'0')) <= TO_CHAR(WEXEC_DATE,'YYYYMMDD')
                )
             )
           -- 2019.01.25 yunchu 增加判斷異動後首次扣款日
           AND NVL(A.EXPECTED_TX_DATE_CHG,TO_DATE('19000101','YYYYMMDD')) <= TRUNC(XSYS_DTTM)       
        ) LOOP

          XCOUNT := XCOUNT + 1;

          --2.2.1 決定本次應扣款金額(XSUB_AMT)
          IF RSP_REC.PRODUCT_TYPE = 'P8' THEN --定額的算法
            XRETURN_RATE := NULL;       --投資報酬率
            XROI_TAG := NULL;           --到達加(減)碼否
            XSUB_AMT := RSP_REC.AMOUNT; --扣款金額
          ELSE --不定額(P9)的算法
            --庫存計算日
            XCAL_DATE := ECS.F_GetBefAftDate(RSP_REC.FUND_NO,'2',RSP_REC.TX_DATE,RSP_REC.CAL_DAYS);
            --至【憑證檔(FAS.Certificate)】，取得各受益人各契約加總的庫存單位數及庫存成本
            -- 2022.01.11 JIANXIN 調整報酬率處理計算
            SELECT NVL(SUM(A.SHARES),0),NVL(SUM(A.AMOUNT),0)
              INTO XTOT_SHARES,XTOT_COST
              FROM FAS.Certificate A
             WHERE A.FUND_NO = RSP_REC.FUND_NO
               AND A.ID = RSP_REC.ID
               AND A.ID_SEQ = RSP_REC.ID_SEQ
               AND A.PRODUCT_TYPE = RSP_REC.PRODUCT_TYPE
               AND A.BROKER_NO = '999'
               AND A.BRANCH_NO = RSP_REC.BRANCH_NO_DDCT
               AND A.ISSUE_DATE <= XCAL_DATE
               AND (A.CANCEL_DATE IS NULL OR A.CANCEL_DATE > XCAL_DATE)
               -- 2022.01.11 JIANXIN 調整報酬率處理計算
               AND A.SHARES >= 0;
            --市價總值 = 「總庫存單位數」乘以「最新淨值」再以「價金小數位數」四捨五入
            XMARKET_PRICE := ROUND(XTOT_SHARES * RSP_REC.NAV,RSP_REC.TRADE_AMT_DECIMAL);
            --投資報酬率 = 「市價總值」除以「總投資成本」，四捨五入至小數位數第四位
            -- 2018.11.29 JIANXIN MOD 調整報酬率公式
            -- 2022.01.11 JIANXIN 調整報酬率處理計算
            IF XTOT_COST <> 0 AND  XMARKET_PRICE <> 0 THEN 
                XRETURN_RATE := ROUND((XMARKET_PRICE - XTOT_COST)/ XTOT_COST,4);
            ELSE 
                XRETURN_RATE := 0;
            END IF;
            --本次應扣款金額:以「投資報酬率」與加減碼指標比較決定
            IF XRETURN_RATE <= RSP_REC.RAISE_ROI THEN    --若「投資報酬率」小於等於「加碼點」,表示到達加碼點,則
              XROI_TAG := '+';                              --到達加(減)碼否為固定字元'+' 及
              XSUB_AMT := RSP_REC.RAISE_AMOUNT;             --扣款金額即為加碼金額
            ELSE
            IF XRETURN_RATE >= RSP_REC.REDUCE_ROI THEN  --若「投資報酬率」大於等於「減碼點」,表示到達減碼點,則
              -- 2018.11.29 JIANXIN MOD 調整減碼註記
        XROI_TAG := '-';                              --到達加(減)碼否為固定字元'-' 及
              XSUB_AMT := RSP_REC.REDUCE_AMOUNT;            --扣款金額即為減碼金額
            ELSE --非上述二者，表示未到達加(減)碼點
              XROI_TAG := ' ';
              XSUB_AMT := RSP_REC.AMOUNT;
            END IF;
            END IF;
          END IF;

          --2.2.2 決定本次扣款手續費(XSERVICE_CHARGE)
          -- 2019.03.04 JIANXIN 生日優惠扣款處理調整
          IF TO_CHAR(XSYS_DTTM,'YYYY') || RSP_REC.BIRTH_MM = XCONDITION_YM THEN --該月壽星:手續費為0
            XFEE_CHOICE := '2'; --生日優惠
            XFEE_PROJECT_CODE := 'P00077';
            XFEE_RATE := 0;
            XSERVICE_CHARGE := 0;
          ELSE --非該月壽星:
            XFEE_CHOICE := '1'; --契約費率
            XFEE_PROJECT_CODE := RSP_REC.PROJECT_CODE;
            XFEE_RATE := RSP_REC.SC_RATE;
            -- 2018.11.20 JIANXIN MOD 調整扣款手續費計算
            XSERVICE_CHARGE := ROUND(XSUB_AMT * RSP_REC.SC_RATE * 0.01,RSP_REC.TRADE_AMT_DECIMAL); -- = 扣款金額 乘以「契約手續費率」再以『扣款幣別小數位數』四捨五入
          END IF;

          --2.2.3 取得交易序號(XSER_NO)
          -- 2018.10.31 ChengYu 修正因f_GetTxNo新增傳入參數而造成的錯誤
          XSER_NO := ECS.f_GetTxNo(TO_CHAR(RSP_REC.TX_DATE,'YYYY'),'999',RSP_REC.BRANCH_NO_DDCT,RSP_REC.FUND_NO,'1');

          --2.3 將上述取得的資料新增至【EC(不)定額申購資料(FAS.EC_RSP_PURCHASE)】檔
          -- 2018.11.09 tingting 寫入FAS.EC_RSP_PURCHASE 增加寫入AC_DAY欄位
          INSERT INTO FAS.EC_RSP_PURCHASE
                    (ID,ID_SEQ,TX_DATE,SER_NO,FUND_NO,AMOUNT,SERVICE_CHARGE,
                     PROJECT_CODE,STATUS,CONT_DISHONOR,ACCU_DISHONOR,IS_EMAIL,
                     RESULT_CODE,AC_BANK,AC_CODE,AC_DATE,REVISION_DATE,REVISED_BY,
                     RSP_STATUS,REFERENCE_NO,CURRENCY_NO,AC_BRANCH,PRODUCT_TYPE,
                     PUR_ROI,ROI_TAG,BROKER_NO,BRANCH_NO,CERTIFICATE_NO,
                     DEDUCT_DATE,SALES_NO,FEE_CHOICE,SC_RATE,AC_DAY)
             VALUES (RSP_REC.ID,             --受益人 ID
                     RSP_REC.ID_SEQ,         --受益人定額計畫流水號
                     RSP_REC.TX_DATE,        --交易日
                     XSER_NO,                --流水號
                     RSP_REC.FUND_NO,        --基金別
                     XSUB_AMT,               --申購價金(即扣款金額)
                     XSERVICE_CHARGE,        --手續費
                     XFEE_PROJECT_CODE,      --專案碼
                     'O',                    --狀態(固定為委託中)
                     RSP_REC.CONT_DISHONOR,  --連續失敗次數
                     RSP_REC.ACCU_DISHONOR,  --累計失敗次數
                     -- 2018.11.30 JIANXIN MOD IS_EMAIL 預設為 N
                     'N',                    --固定為'Y'
                     '00',                   --扣款結果(固定為'00':成功)
                     RSP_REC.BANK_NO,        --扣款銀行
                     RSP_REC.AC_CODE,        --扣款帳號
                     RSP_REC.NAV_DATE,       --淨值日
                     XSYS_DTTM,              --修改日期(含時分秒)
                     WEXEC_UERID,            --修改人員
                     RSP_REC.STATUS,         --契約狀態
                     NULL,                   --參考編號
                     RSP_REC.CURRENCY_NO,    --幣別
                     RSP_REC.BRANCH_NO,      --扣款分行
                     RSP_REC.PRODUCT_TYPE,   --產品類別
                     XRETURN_RATE,           --達到加減碼的報酬率
                     XROI_TAG,               --達到加碼點：『+』；達到減碼點：『-』
                     '999',                  --代銷單位碼(固定為'999')
                     RSP_REC.BRANCH_NO_DDCT, --代銷分行碼
                     NULL,                   --憑證編號
                     NULL,                   --銀行扣款日期
                     RSP_REC.SALES_NO,       --業務員代號
                     XFEE_CHOICE,            --優惠方案
                     XFEE_RATE,              --手續費率
                     RSP_REC.AC_DAY          --約定扣款日
                    );

          --2.4 若EC(不)定額(ECS.RSP)為第一次扣款,則須將第一次交易日期(FIRST_TX_DATE)設為本次交易日期
          UPDATE ECS.RSP
             SET FIRST_TX_DATE = RSP_REC.TX_DATE, --第一次交易日期
                 REVISION_DATE = XSYS_DTTM        --修改日期(含時分秒)
           WHERE ID = RSP_REC.ID
             AND ID_SEQ = RSP_REC.ID_SEQ
             AND FIRST_TX_DATE IS NULL;

      END LOOP;

    -- 2018.11.29 JIANXIN MOD 移除刪除紀錄
    DELETE FAS.EC_RSP_TRANSFER_LOG
     WHERE FUND_NO = DDCT_REC.FUND_NO
       AND TX_DATE = XCONDITION_DATE
     AND SET_TIME = XCONDITION_DATE
     AND TYPE = 'P';

      --3.扣款資料更新後，新增一筆資料至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔
      INSERT INTO FAS.EC_RSP_TRANSFER_LOG
                (FUND_NO,TX_DATE,TRANS_DATE,EMP_NO,LOG_TIME,COUNT,TYPE,SET_TIME,IMPORT_TYPE)
         VALUES (DDCT_REC.FUND_NO, --基金別
                 XCONDITION_DATE, --交易日
                 XCONDITION_DATE, --產生日期
                 WEXEC_UERID,     --最後修改人員
                 XSYS_DTTM,       --log time
                 XCOUNT,          --筆數
                 'P',             --交易類別(產生應扣款資料)
                 --2018.11.06 PAN MOD
                 --XCONDITION_TIME, --轉檔時間
                 XCONDITION_TIME2, --轉檔時間
                 CASE WHEN XCONDITION_TIME = '1200' THEN 'F'
                      WHEN XCONDITION_TIME = '1600' THEN 'O'
                      ELSE 'O'
                  END             --匯入型態
                );

  END LOOP;

  --4.將本次扣款的基金筆數傳回
  --4.1 傳回扣款總筆數
  -- 2018.11.13 yunchu MOD 調整扣款總筆數為明細加總
  -- 2022.01.22 Chengyu 修復無資料時DBNull錯誤問題
  SELECT NVL(SUM(COUNT),0) INTO WTOT_DDCT_COUNT
    FROM FAS.EC_RSP_TRANSFER_LOG
   WHERE TX_DATE = XCONDITION_DATE
     --2018.11.06 PAN MOD
     --AND SET_TIME = XCONDITION_TIME
     AND SET_TIME = XCONDITION_TIME2
     AND TYPE = 'P'; --產生應扣款資料

  --4.2 傳回各基金扣款筆數
  OPEN CMSGLIST FOR
  SELECT FUND_NO||':'||COUNT AS MSG
    FROM FAS.EC_RSP_TRANSFER_LOG
   WHERE TX_DATE = XCONDITION_DATE
     --2018.11.06 PAN MOD
     --AND SET_TIME = XCONDITION_TIME
     AND SET_TIME = XCONDITION_TIME2
     AND TYPE = 'P'; --產生應扣款資料

END S_ECSB002_Execute_DEDUCT;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_DEDUCT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_LOYAL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_LOYAL" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/31
-- Description: RSP&DRSP契約更新忠實戶專案碼
--              抓取符合的網路RSP&DRSP契約資料，計算累積扣款成功次數，若已達24次(含)，
--              則更新「專案碼」為'MRSP24'及「契約手續費」為0
-- 2023.03.13 JIANXIN MOD SR02207022-調整忠實戶移除SC_RATE <> 0 的條件
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2       --執行者代碼
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XSYS_DTTM DATE;              --系統日期時間

BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期
  XSYS_DTTM := sysdate; --取得系統日期時間

  --2.抓取符合的網路RSP&DRSP契約資料，計算累積扣款成功次數，若已達24次(含)，則更新「專案碼」為'MRSP24'及「契約手續費」為0
  --2.1 依受益人ID的RSP分別累計定額申購扣款成功次數
  INSERT INTO ECS.RSPList (ID,ID_SEQ,SUS_CNT)
  SELECT C.ID,C.ID_SEQ,
         COUNT(*) SUS_CNT --累計扣款成功次數
    FROM ECS.FundList A                        --由後台EC RSP契約資料檔中取得
    JOIN FAS.EC_RSP B ON B.FUND_NO = A.FUND_NO     --存在可交易基金列表的基金 且
                     AND B.STATUS = '4'             --契約狀態為'4'(有效) 且
                     -- 2021.12.14 JIANXIN MOD 調整Project Code 無法判斷Null問題
                     AND NVL(B.PROJECT_CODE,' ') <> 'MRSP24' --專案碼不為'MRSP24' 且
                     -- 2023.03.13 JIANXIN MOD SR02207022-調整忠實戶移除SC_RATE <> 0 的條件
                     --AND B.SC_RATE <> 0             --契約手續費率不為 0 的EC RSP契約
    JOIN FAS.EC_RSP_PURCHASE C 
      ON C.ID = B.ID AND C.ID_SEQ = B.ID_SEQ   --再由EC(不)定額申購資料檔中 統計
     AND C.STATUS = 'P'                        --狀態為'P'(已結帳) 且
     AND C.RESULT_CODE = '00'                  --扣款結果為'00'(成功) 的定額申購成功次數
   GROUP BY C.ID,C.ID_SEQ
   HAVING COUNT(*) >= 24;

  --2.2 逐筆將EC(不)定額(ECS.RSP)檔中符合上述扣款成功次數已達24次的RSP之「專案碼」設為'MRSP24'及「契約手續費」設為0
  UPDATE ECS.RSP
     SET PROJECT_CODE = 'MRSP24',
         SC_RATE = 0,
         REVISION_DATE = XSYS_DTTM
   WHERE ID||ID_SEQ IN (SELECT ID||ID_SEQ FROM ECS.RSPList);

  --2.3 逐筆將後台EC RSP契約資料(FAS.EC_RSP)檔中符合上述扣款成功次數已達24次的RSP之「專案碼」設為'MRSP24'及「契約手續費」設為0  
  UPDATE FAS.EC_RSP
     SET PROJECT_CODE = 'MRSP24',
         SC_RATE = 0
   WHERE ID||ID_SEQ IN (SELECT ID||ID_SEQ FROM ECS.RSPList);

  --2.4 逐筆將扣款成功次數已達24次的RSP新增資料至【EC(不)定額異動紀錄(ECS.RSP_LOG)】檔
  INSERT INTO ECS.RSP_LOG
        (ID,ID_SEQ,FUND_NO,AMOUNT,AC_DAY,BANK_NO,BRANCH_NO,AC_CODE,STATUS,
         REVISION_DATE,REMARK,ACTION_TYPE,EXPECTED_TX_DATE,CURRENCY_NO,AC_NAME,PROSPECTUS,
         IP_A,IP_B,IP_C,IP_D,INVESTMENT_RISK,CHANNEL_EXPOSE,PROJECT_CODE,PRODUCT_TYPE,
         RAISE_ROI,RAISE_AMOUNT,REDUCE_ROI,REDUCE_AMOUNT,ONSHORE_SHORT_TRADE,
         FEE_CHOICE,SC_RATE,TRANSACTION_NO,COUPON_ID)
  SELECT B.ID,
         B.ID_SEQ,
         B.FUND_NO,
         B.AMOUNT,
         B.AC_DAY,
         B.BANK_NO,
         B.BRANCH_NO,
         B.AC_CODE,
         B.STATUS,
         --------------------------------------------------------------
         XSYS_DTTM REVISION_DATE,
         '此契約已成功扣滿24次，更新其專案碼為：MRSP24' REMARK,
         'C' ACTION_TYPE,
         XCONDITION_DATE EXPECTED_TX_DATE,
         B.CURRENCY_NO,
         B.AC_NAME,
         B.PROSPECTUS,
         --------------------------------------------------------------
         B.IP_A,
         B.IP_B,
         B.IP_C,
         B.IP_D,
         B.INVESTMENT_RISK,
         B.CHANNEL_EXPOSE,
         B.PROJECT_CODE,
         B.PRODUCT_TYPE,
         --------------------------------------------------------------
         B.RAISE_ROI,
         B.RAISE_AMOUNT,
         B.REDUCE_ROI,
         B.REDUCE_AMOUNT,
         B.ONSHORE_SHORT_TRADE,
         --------------------------------------------------------------
         B.FEE_CHOICE,
         B.SC_RATE,
         B.TRANSACTION_NO,
         B.COUPON_ID
    FROM ECS.RSPList A
    JOIN ECS.RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ;

END S_ECSB002_Execute_LOYAL;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_LOYAL" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_NEW
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_NEW" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/31
-- Description: RSP&DRSP契約新件
-- 2018.11.06 PAN MOD 修正日期拆組造成的格式錯誤
-- 2018.11.23 JIANXIN MOD 修正加減碼金額寫入備註錯誤問題
-- 2018.12.21 yunchu MOD 調整取得基金資料條件
-- 2018.12.24 yunchu MOD 調整判斷基金關帳時間是否符合執行時間
-- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2       --執行者代碼
    --WERRMSG                 OUT VARCHAR2      --回傳錯誤訊息(若為null,則表示無錯誤)
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XCONDITION_TIME VARCHAR2(4); --執行時間
  XSYS_DTTM DATE;              --系統日期時間
  XCOUNT NUMBER(5);            --資料筆數
  XREMARK VARCHAR2(500);       --備註
  --2018.11.06 PAN MOD
  XCONDITION_TIME2 VARCHAR2(8); --執行時間

BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期

 SELECT  CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '1200'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '1600'
          END
        --2018.11.06 PAN MOD
        ,CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '12:00:00'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '16:00:00'
          END
   INTO  XCONDITION_TIME
        ,XCONDITION_TIME2
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR
     TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI'); --取得傳入參數中的時分
  XSYS_DTTM := sysdate; --取得系統日期時間
  --WERRMSG := NULL;
  XCOUNT := 0;

  --2.抓取符合的網路RSP&DRSP契約新件資料，新增至【後台EC RSP契約資料(FAS.EC_RSP)】檔
  --2.1 以『執行時間』至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔，取得「交易類別(TYPE)」='N” 最新一次的處理記錄資料
  -- 2018.12.21 yunchu MOD 調整取得基金資料條件
  -- 2018.12.24 yunchu MOD 調整判斷基金關帳時間是否符合執行時間
  FOR NEW_REC IN
    ( SELECT Z.FUND_NO,MAX(LastDateTime) LastDateTime
        FROM (
              SELECT A.FUND_NO,   --新基金代碼
                     CASE WHEN B.FUND_NO IS NULL THEN TO_DATE('20000101'||' '||XCONDITION_TIME,'YYYYMMDD  HH24MI') --無資料時,為2000/01/01+執行時間(XCONDITION_TIME)
                          --2018.11.06 PAN MOD
                          --ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'YYYYMMDD HH24MI') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                          ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'yyyymmdd hh24:mi:ss') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                      END AS LastDateTime   --上次交易日期時間
                FROM FAS.FUND A
                LEFT JOIN FAS.EC_RSP_TRANSFER_LOG B
                  --2018.11.06 PAN MOD
                  --ON B.FUND_NO = A.FUND_NO
                  ON B.FUND_NO = 'NEW'
                 AND B.TYPE = 'N' --新委託
                 --AND B.SET_TIME = XCONDITION_TIME
                 AND B.SET_TIME = XCONDITION_TIME2
               WHERE TO_CHAR(A.EC_PUR_CUT_OFF, 'HH24MI') = XCONDITION_TIME
             ) Z
       GROUP BY Z.FUND_NO
       ORDER BY Z.FUND_NO
    ) LOOP
      --2.2 以上述的「新基金代碼」至【EC(不)定額(ECS.RSP)】取得「契約狀態(STATUS)」='1.收件'且
      --    建檔日期(含時分秒)(CREATION_DATE)」大於「上次交易日期時間(LastDateTime)」且小於等於傳入的執行條件日期時分
      --    的契約新件資料
      FOR RSP_REC IN
        (SELECT A.*,B.SALES_NO,C.NAME,D.SNAME,NVL(E.AMT_DECIMAL,0) DEC_LEN
          FROM ECS.RSP A
          LEFT JOIN FAS.HOLDER B ON B.ID = A.ID
          JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
          LEFT JOIN FAS.FIS_BANK D ON D.BANK_NO = A.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY E ON E.CURRENCY_NO = A.CURRENCY_NO
         WHERE A.FUND_NO = NEW_REC.FUND_NO  --異動基金代碼
           AND A.STATUS = '1' --收件
           AND A.CREATION_DATE > NEW_REC.LastDateTime AND A.CREATION_DATE <= WEXEC_DATE
         ORDER BY A.CREATION_DATE
        ) LOOP

          XCOUNT := XCOUNT + 1;
          --2.3 將上述取得的資料新增至【後台EC RSP契約資料(FAS.EC_RSP)】檔
          -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
          INSERT INTO FAS.EC_RSP
                    (ID,ID_SEQ,FUND_NO,AMOUNT,AC_DAY,BANK_NO,BRANCH_NO,AC_CODE,STATUS,PROJECT_CODE,
                     CONT_DISHONOR,ACCU_DISHONOR,SER_NO,PAUSED,CURRENCY_NO,AC_NAME,PROSPECTUS,
                     PRODUCT_TYPE,RAISE_ROI,RAISE_AMOUNT,REDUCE_ROI,REDUCE_AMOUNT,SALES_NO,SC_RATE,EXPECTED_TX_DATE_CHG)
             VALUES (RSP_REC.ID,
                     RSP_REC.ID_SEQ,        --契約序號
                     RSP_REC.FUND_NO,       --基金別
                     RSP_REC.AMOUNT,        --申購價金
                     RSP_REC.AC_DAY,        --扣款日
                     RSP_REC.BANK_NO,       --扣款銀行
                     RSP_REC.BRANCH_NO,     --扣款分行
                     RSP_REC.AC_CODE,       --扣款帳號
                     '4',                   --契約狀態
                     RSP_REC.PROJECT_CODE,  --專案碼
                     ----------------------------------------------
                     0,                     --連續失敗次數
                     0,                     --累計失敗次數
                     RSP_REC.ID_SEQ,        --交易序號(同ID_SEQ)
                     NULL,                  --暫停扣款日
                     RSP_REC.CURRENCY_NO,   --幣別
                     RSP_REC.AC_NAME,       --戶名
                     RSP_REC.PROSPECTUS,    --公開說明書
                     ----------------------------------------------
                     RSP_REC.PRODUCT_TYPE,  --產品類別
                     RSP_REC.RAISE_ROI,     --加碼點(%)
                     RSP_REC.RAISE_AMOUNT,  --加碼金額
                     RSP_REC.REDUCE_ROI,    --減碼點(%)
                     RSP_REC.REDUCE_AMOUNT, --減碼金額
                     RSP_REC.SALES_NO,      --業務員代號
                     RSP_REC.SC_RATE,       --契約手續費率
                     NVL(RSP_REC.EXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD')));  --異動後首次扣款日

          --2.4 將【EC(不)定額(ECS.RSP)】檔中的契約狀態更新為4.有效
          UPDATE ECS.RSP
             SET STATUS = '4', --有效
                 REVISION_DATE = XSYS_DTTM --系統日期時間
           WHERE ID = RSP_REC.ID
             AND ID_SEQ = RSP_REC.ID_SEQ;

          --2.5	將上述取得的資料新增資料至【EC(不)定額異動紀錄(ECS.RSP_LOG)】檔
          --備註欄組成規則:
          XREMARK := '契約轉入;'|| --產品類別：固定為'契約轉入'
                     RSP_REC.FUND_NO||RSP_REC.NAME||   --基金別：「基金別(FUND_NO)」+「基金名稱 (NAME)」
                     ';每月'||TO_CHAR(RSP_REC.AC_DAY)||'號交易日'|| --扣款日：以前置文字'每月'加上「約定交易日(AC_DAY)」再加上接續文字'號交易日'，如'每月22號交易日'
                     ';扣款帳號'||RSP_REC.SNAME||RSP_REC.AC_CODE||  --扣款帳號：以前置文字'扣款帳號'加上「銀行簡稱(SNAME)」加上「銀行帳號(AC_CODE)」，如'扣款帳號一銀大安12345678999'
                     CASE WHEN RSP_REC.PRODUCT_TYPE='P8' THEN --扣款金額：
                               ';金額'||ROUND(RSP_REC.AMOUNT,RSP_REC.DEC_LEN)||'元' --若「產品類別」為'P8'時，以前置文字'金額'加上「申購價金」再加上接續文字'元'，如'金額1000.00元'
                          ELSE ';基準扣款金額'||ROUND(RSP_REC.AMOUNT,RSP_REC.DEC_LEN)||'元' --若「產品類別」為'P9'時，以前置文字'基準扣款金額'加上「申購價金」再加上接續文字'元'，如'基準扣款金額6000.00元'
                      END||
                     CASE WHEN RSP_REC.PRODUCT_TYPE='P8' THEN '' --加碼點：若「產品類別」為'P8'時，則為空值
                          ELSE ';加碼'||TO_CHAR(RSP_REC.RAISE_ROI)||'%' --若「產品類別」為'P9'時，以前置文字'加碼'加上「加碼點(%)(RAISE_ROI)」再加上接續文字'%'，如'加碼8.0%'
                      END||
                     CASE WHEN RSP_REC.PRODUCT_TYPE='P8' THEN '' --加碼金額：若「產品類別」為”P8”時，則為空值
                          ELSE ';加碼金額'||ROUND(RSP_REC.RAISE_AMOUNT,RSP_REC.DEC_LEN)||'元' --若「產品類別」為'P9'時，以前置文字'加碼金額'加上「加碼金額」再加上接續文字'元'，如'加碼金額8000.00元'
                      END||
                     CASE WHEN RSP_REC.PRODUCT_TYPE='P8' THEN '' --減碼點：若「產品類別」為'P8'時，則為空值
                          ELSE ';減碼'||TO_CHAR(RSP_REC.REDUCE_ROI)||'%' --若「產品類別」為'P9'時，以前置文字'加碼'加上「減碼點(%)(REDUCE_ROI)」再加上接續文字'%'，如'減碼-15.0%'
                      END||
                     -- 2018.11.23 JIANXIN MOD 修正加減碼金額寫入備註錯誤問題
                     CASE WHEN RSP_REC.PRODUCT_TYPE='P8' THEN '' --減碼金額：若「產品類別」為”P8”時，則為空值
                          ELSE ';減碼金額'||ROUND(RSP_REC.REDUCE_AMOUNT,RSP_REC.DEC_LEN)||'元' --若「產品類別」為'P9'時，以前置文字'減碼金額'加上「減碼金額」再加上接續文字'元'，如'減碼金額8000.00元'
                      END;

          -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
          INSERT INTO ECS.RSP_LOG
                    (ID,ID_SEQ,FUND_NO,AMOUNT,AC_DAY,BANK_NO,BRANCH_NO,AC_CODE,STATUS,REVISION_DATE,
                     REMARK,ACTION_TYPE,EXPECTED_TX_DATE,CURRENCY_NO,AC_NAME,PROSPECTUS,
                     IP_A,IP_B,IP_C,IP_D,INVESTMENT_RISK,CHANNEL_EXPOSE,PROJECT_CODE,PRODUCT_TYPE,
                     RAISE_ROI,RAISE_AMOUNT,REDUCE_ROI,REDUCE_AMOUNT,ONSHORE_SHORT_TRADE,FEE_CHOICE,SC_RATE,
                     TRANSACTION_NO,COUPON_ID,EXPECTED_TX_DATE_CHG)
             VALUES (RSP_REC.ID,
                     RSP_REC.ID_SEQ,        --契約序號
                     RSP_REC.FUND_NO,       --基金別
                     RSP_REC.AMOUNT,        --申購價金
                     RSP_REC.AC_DAY,        --約定交易日
                     RSP_REC.BANK_NO,       --扣款銀行
                     RSP_REC.BRANCH_NO,     --扣款分行
                     RSP_REC.AC_CODE,       --扣款帳號
                     RSP_REC.STATUS,        --契約狀態
                     XSYS_DTTM,             --系統日期時間
                     ----------------------------------------------
                     XREMARK,               --備註
                     'T',                   --交易動作(轉入契約)
                     RSP_REC.EXPECTED_TX_DATE, --預計交易日期
                     RSP_REC.CURRENCY_NO,   --幣別
                     RSP_REC.AC_NAME,       --戶名
                     RSP_REC.PROSPECTUS,    --公開說明書
                     ----------------------------------------------
                     RSP_REC.IP_A,          --IP A
                     RSP_REC.IP_B,          --IP B
                     RSP_REC.IP_C,          --IP C
                     RSP_REC.IP_D,          --IP D
                     RSP_REC.INVESTMENT_RISK, --投資風險評估
                     RSP_REC.CHANNEL_EXPOSE,  --通路報酬揭露
                     RSP_REC.PROJECT_CODE,    --專案碼
                     RSP_REC.PRODUCT_TYPE,    --產品類別
                     ----------------------------------------------
                     RSP_REC.RAISE_ROI,     --加碼點(%)
                     RSP_REC.RAISE_AMOUNT,  --加碼金額
                     RSP_REC.REDUCE_ROI,    --加碼點(%)
                     RSP_REC.REDUCE_AMOUNT, --加碼金額
                     RSP_REC.ONSHORE_SHORT_TRADE, --境內短線交易
                     RSP_REC.FEE_CHOICE,    --優惠方案
                     RSP_REC.SC_RATE,       --契約手續費率
                     ----------------------------------------------
                     RSP_REC.TRANSACTION_NO,  --交易編號(FOR 優惠券使用)
                     RSP_REC.COUPON_ID,       --優惠券號碼
                     NVL(RSP_REC.EXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD')));  --異動後首次扣款日
      END LOOP;
  END LOOP;

  --3.所有的契約新件資料新增後，新增一筆資料至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔
  INSERT INTO FAS.EC_RSP_TRANSFER_LOG
            (FUND_NO,TX_DATE,TRANS_DATE,EMP_NO,LOG_TIME,COUNT,TYPE,SET_TIME,IMPORT_TYPE)
     VALUES ('NEW', --基金別
             XCONDITION_DATE, --交易日
             XCONDITION_DATE, --產生日期
             WEXEC_UERID,     --最後修改人員
             XSYS_DTTM,       --log time
             XCOUNT,          --筆數
             'N',             --交易類別
             --2018.11.06 PAN MOD
             --XCONDITION_TIME, --轉檔時間
             XCONDITION_TIME2, --轉檔時間
             CASE WHEN XCONDITION_TIME = '1200' THEN 'F'
                  WHEN XCONDITION_TIME = '1600' THEN 'O'
                  ELSE 'O'
              END             --匯入型態
            );

END S_ECSB002_Execute_NEW;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_NEW" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_PROMO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_PROMO" --RSP&DRSP契約更新RT.(不)定額特定次數促銷活動專案的契約費率
--抓取符合的網路RSP&DRSP契約資料，計算累積扣款成功次數，若已達調降次數，
--  則更新「契約手續費」為調降後的優惠費率
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2       --執行者代碼
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XSYS_DTTM DATE;              --系統日期時間

BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期
  XSYS_DTTM := sysdate; --取得系統日期時間

  --2.抓取符合的網路RSP&DRSP契約資料，計算累積扣款成功次數，若已達調降次數，則更新「契約手續費」為調降後的優惠費率
  --2.1 依受益人ID的RSP分別累計定額申購扣款成功次數
  INSERT INTO ECS.RSPList (ID,ID_SEQ,PROJECT_CODE,SUS_CNT)
  SELECT B.ID,B.ID_SEQ,B.PROJECT_CODE,
         COUNT(*) SUS_CNT --累計扣款成功次數
    FROM ECS.FundList A                        --由後台EC RSP契約資料檔中取得
    JOIN FAS.EC_RSP B ON B.FUND_NO = A.FUND_NO     --存在可交易基金列表的基金 且
                     AND B.STATUS = '4'             --契約狀態為'4'(有效) 且
                     AND B.PROJECT_CODE <> 'MRSP24' --專案碼不為'MRSP24' 且
                     AND B.SC_RATE <> 0             --契約手續費率不為 0(即排除忠實戶) 且
    JOIN ECS.CAMPAIGN D 
      ON D.CAMPAIGN_CODE = B.PROJECT_CODE           --以專案碼取得的
     AND D.CAMPAIGN_TYPE = 'RT'                     --促銷類別為'RT' 的EC RSP契約
    JOIN FAS.EC_RSP_PURCHASE C 
      ON C.ID = B.ID AND C.ID_SEQ = B.ID_SEQ   --再由EC(不)定額申購資料檔中 統計
     AND C.STATUS = 'P'                        --狀態為'P'(已結帳) 且
     AND C.RESULT_CODE = '00'                  --扣款結果為'00'(成功) 的定額申購成功次數
   GROUP BY B.ID,B.ID_SEQ,B.PROJECT_CODE;

  --2.2 找出上述的RSP專案碼在促銷活動相關檔中符合優惠次數的優惠手續費率
  FOR RT_REC IN
    (SELECT B.ID,B.ID_SEQ,
            A.SUS_CNT,   --累計扣款成功次數
            E.FIXED_RATE --優惠手續費率
       FROM ECS.RSPList A
       JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ
       --JOIN ECS.CAMPAIGN D ON D.CAMPAIGN_CODE = A.PROJECT_CODE
       JOIN ECS.CAMPAIGN_RSP_TIME E ON E.CAMPAIGN_CODE = A.PROJECT_CODE
      WHERE A.SUS_CNT BETWEEN E.DISC_TIMES_BNG AND E.DISC_TIMES_END
        AND B.SC_RATE <> E.FIXED_RATE
    ) LOOP

      --2.2.1 將【EC(不)定額(ECS.RSP)】檔中符合2.2點的RSP契約手續費率更新為優惠手續費率
      UPDATE ECS.RSP
         SET SC_RATE = RT_REC.FIXED_RATE
       WHERE ID = RT_REC.ID
         AND ID_SEQ = RT_REC.ID_SEQ;

      --2.2.2 將【後台EC RSP契約資料(FAS.EC_RSP)】檔中符合2.2點的RSP契約手續費率更新為優惠手續費率
      UPDATE FAS.EC_RSP
         SET SC_RATE = RT_REC.FIXED_RATE
       WHERE ID = RT_REC.ID
         AND ID_SEQ = RT_REC.ID_SEQ;

      --2.2.3	將上述2.2點取得的資料新增資料至【EC(不)定額異動紀錄(ECS.RSP_LOG)】檔
      INSERT INTO ECS.RSP_LOG
            (ID,ID_SEQ,FUND_NO,AMOUNT,AC_DAY,BANK_NO,BRANCH_NO,AC_CODE,STATUS,
             REVISION_DATE,REMARK,ACTION_TYPE,EXPECTED_TX_DATE,CURRENCY_NO,AC_NAME,PROSPECTUS,
             IP_A,IP_B,IP_C,IP_D,INVESTMENT_RISK,CHANNEL_EXPOSE,PROJECT_CODE,PRODUCT_TYPE,
             RAISE_ROI,RAISE_AMOUNT,REDUCE_ROI,REDUCE_AMOUNT,ONSHORE_SHORT_TRADE,
             FEE_CHOICE,SC_RATE,TRANSACTION_NO,COUPON_ID)
      SELECT B.ID,
             B.ID_SEQ,
             B.FUND_NO,
             B.AMOUNT,
             B.AC_DAY,
             B.BANK_NO,
             B.BRANCH_NO,
             B.AC_CODE,
             B.STATUS,
             --------------------------------------------------------------
             XSYS_DTTM REVISION_DATE,
             '此契約已成功扣滿『累計扣款成功次數'||RT_REC.SUS_CNT||'次，更新其契約手續費率為：『優惠費率'||RT_REC.FIXED_RATE||'%'  REMARK,
             'C' ACTION_TYPE,
             XCONDITION_DATE EXPECTED_TX_DATE,
             B.CURRENCY_NO,
             B.AC_NAME,
             B.PROSPECTUS,
             --------------------------------------------------------------
             B.IP_A,
             B.IP_B,
             B.IP_C,
             B.IP_D,
             B.INVESTMENT_RISK,
             B.CHANNEL_EXPOSE,
             B.PROJECT_CODE,
             B.PRODUCT_TYPE,
             --------------------------------------------------------------
             B.RAISE_ROI,
             B.RAISE_AMOUNT,
             B.REDUCE_ROI,
             B.REDUCE_AMOUNT,
             B.ONSHORE_SHORT_TRADE,
             --------------------------------------------------------------
             B.FEE_CHOICE,
             B.SC_RATE,
             B.TRANSACTION_NO,
             B.COUPON_ID
        FROM ECS.RSP B 
       WHERE B.ID = RT_REC.ID
         AND B.ID_SEQ = RT_REC.ID_SEQ;      

  END LOOP;

END S_ECSB002_Execute_PROMO;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_PROMO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_UNDODDCT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_UNDODDCT" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/29
-- Description: 刪除扣款資料
-- 2018.12.05 JIANXIN MOD BY 刪除資料必須看設定時間
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WERRMSG                 OUT VARCHAR2      --回傳錯誤訊息(若為null,則表示無錯誤)
) IS
  --變數宣告
  XCONDITION_TIME VARCHAR2(4); --執行時間
  -- 2018.12.05 JIANXIN MOD BY 刪除資料必須看設定時間
  XCONDITION_TIME2 VARCHAR2(8); --執行時間
  XSYS_DTTM DATE;              --系統日期時間
  XCOUNT NUMBER(9);            --資料筆數

BEGIN
  --1.給變數值
 SELECT CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
             THEN '1200'
             WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
             THEN '1600'
         END
        -- 2018.12.05 JIANXIN MOD BY 刪除資料必須看設定時間
        ,CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '12:00:00'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '16:00:00'
          END
   INTO XCONDITION_TIME
        ,XCONDITION_TIME2
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR 
         TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI'); --取得傳入參數中的時分
  XSYS_DTTM := sysdate; --取得系統日期時間
  WERRMSG := NULL;

  --2/若任一基金已有「狀態(STATUS)」<>”O.委託中”的資料，則結束本作業，並回傳錯誤訊息：部份基金，已有狀態不為”委託中”的扣款資料，故不可刪除
  SELECT COUNT(*) INTO XCOUNT
    FROM ECS.FundList A
    JOIN FAS.EC_RSP_TRANSFER_LOG B ON B.FUND_NO = A.FUND_NO 
                                  AND B.TYPE = 'P' --產生應扣款資料
                                  -- 2018.12.05 JIANXIN MOD BY 刪除資料必須看設定時間
                                  AND B.SET_TIME = XCONDITION_TIME2
                                  AND B.TX_DATE = A.TX_DATE
    JOIN FAS.EC_RSP_PURCHASE C ON C.FUND_NO = B.FUND_NO AND C.TX_DATE = B.TX_DATE AND C.STATUS <> 'O'; --不是委託中

  IF XCOUNT > 0 THEN
    WERRMSG := '部份基金，已有狀態不為"委託中"的扣款資料，故不可刪除';
    RETURN;
  END IF;

  --3.若無上述的情形出現,則依序處理下列動作
  DECLARE Cursor DEL_CUR IS
    SELECT B.FUND_NO,   --回帳基金代碼
           B.TX_DATE,   --最近交易日期
           B.SET_TIME   --最近轉檔時間
      FROM ECS.FundList A
      JOIN FAS.EC_RSP_TRANSFER_LOG B ON B.FUND_NO = A.FUND_NO 
                                    AND B.TYPE = 'P' --產生應扣款資料
                                    -- 2018.12.05 JIANXIN MOD BY 刪除資料必須看設定時間
                                    AND B.SET_TIME = XCONDITION_TIME2
                                    AND B.TX_DATE = A.TX_DATE;
  BEGIN
    FOR DEL_REC IN DEL_CUR LOOP

  --dbms_output.put_line('FUND_NO：'|| DEL_REC.FUND_NO);
  --dbms_output.put_line('TX_DATE：'|| DEL_REC.TX_DATE);
  --dbms_output.put_line('SET_TIME：'|| DEL_REC.SET_TIME);

      --3.1 將【EC(不)定額(ECS.RSP)】檔中的第一次交易日期(FIRST_TX_DATE)等於符合上述基金的『最近交易日期』的第一次交易日期清空
      UPDATE ECS.RSP
         SET FIRST_TX_DATE = NULL, --第一次交易日期
             REVISION_DATE = XSYS_DTTM
       WHERE ID||ID_SEQ IN (SELECT ID||ID_SEQ 
                              FROM FAS.EC_RSP_PURCHASE
                             WHERE FUND_NO = DEL_REC.FUND_NO  --回帳基金代碼
                               AND TX_DATE = DEL_REC.TX_DATE  --最近交易日期
                               AND STATUS = 'O'); --委託中

      --3.2 以上述Cursor的『回帳基金代碼』及『最近交易日期』至【EC(不)定額申購資料(FAS.EC_RSP_PURCHASE)】檔中刪除符合條件的資料
      DELETE
        FROM FAS.EC_RSP_PURCHASE
       WHERE FUND_NO = DEL_REC.FUND_NO  --回帳基金代碼
         AND TX_DATE = DEL_REC.TX_DATE  --最近交易日期
         AND STATUS = 'O'; --委託中

      --3.3 以上述Cursor的『回帳基金代碼』、『最近交易日期』及『最近轉檔時間』至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔中刪除交易類別為'P'的資料
       DELETE
        FROM FAS.EC_RSP_TRANSFER_LOG
       WHERE FUND_NO = DEL_REC.FUND_NO --回帳基金代碼
         AND TX_DATE = DEL_REC.TX_DATE --最近交易日期 
         AND SET_TIME = DEL_REC.SET_TIME
         AND TYPE = 'P'; --產生應扣款資料   

    END LOOP;
  END;

END S_ECSB002_Execute_UNDODDCT;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_UNDODDCT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB002_EXECUTE_VALID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB002_EXECUTE_VALID" 
-- =============================================
-- Author:      STU
-- Create date: 2018/10/31
-- Description: RSP&DRSP契約異動資料生效
-- 2018.11.06 PAN MOD 修正日期拆組造成的格式錯誤
-- 2018.12.14 JIANXIN MOD BY 新增拋轉欄位 專案碼、手續費率
-- 2018.12.21 yunchu MOD 調整取得基金資料條件
-- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2       --執行者代碼
) IS
  --變數宣告
  XCONDITION_DATE DATE;        --執行日期
  XCONDITION_TIME VARCHAR2(4); --執行時間
  XSYS_DTTM DATE;              --系統日期時間
  XCOUNT NUMBER(5);            --資料筆數
  --2018.11.06 PAN MOD
  XCONDITION_TIME2 VARCHAR2(8); --執行時間

BEGIN
  --1.給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期

 SELECT  CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '1200'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '1600'
          END
        --2018.11.06 PAN MOD
        ,CASE WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '12'
              THEN '12:00:00'
              WHEN TO_CHAR(WEXEC_DATE, 'HH24') = '16'
              THEN '16:00:00'
          END
   INTO  XCONDITION_TIME
        ,XCONDITION_TIME2
   FROM DUAL
  WHERE (TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1200' AND '1210'
         OR
         TO_CHAR(WEXEC_DATE, 'HH24MISS') BETWEEN '1600' AND '1610');

  --XCONDITION_TIME := TO_CHAR(WEXEC_DATE,'HH24MI'); --取得傳入參數中的時分
  XSYS_DTTM := sysdate;--取得系統日期時間
  XCOUNT := 0;

  --2.取得符合的網路RSP&DRSP契約變更資料,更新回RSP&DRSP契約中
  --2.1 以『執行時間』至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔，取得「交易類別(TYPE)」='M' 的最新一次的處理記錄資料
  -- 2018.12.21 yunchu MOD 調整取得基金資料條件
  -- 2018.12.24 yunchu MOD 調整判斷基金關帳時間是否符合執行時間
  FOR RSP_REC IN
    ( SELECT Z.FUND_NO,MAX(LastDateTime) LastDateTime
        FROM (
              SELECT A.FUND_NO,   --異動基金代碼
                   CASE WHEN B.FUND_NO IS NULL THEN TO_DATE('20000101'||' '||XCONDITION_TIME,'YYYYMMDD  HH24MI') --無資料時,為2000/01/01+執行時間(XCONDITION_TIME)
                        --2018.11.06 PAN MOD
                        --ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'YYYYMMDD HH24MI') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                        ELSE TO_DATE(TO_CHAR(B.TX_DATE,'YYYYMMDD')||' '||B.SET_TIME,'yyyymmdd hh24:mi:ss') --有資料時,為交易日(TX_DATE)+轉檔時間(SET_TIME)
                    END AS LastDateTime   --上次交易日期時間
              FROM FAS.FUND A
              LEFT JOIN FAS.EC_RSP_TRANSFER_LOG B
                --2018.11.06 PAN MOD
                --ON B.FUND_NO = A.FUND_NO
                ON B.FUND_NO = 'MOD'
               AND B.TYPE = 'M' --MOD資料
               --AND B.SET_TIME = XCONDITION_TIME
               AND B.SET_TIME = XCONDITION_TIME2
             WHERE TO_CHAR(A.EC_PUR_CUT_OFF, 'HH24MI') = XCONDITION_TIME
             ) Z
       GROUP BY Z.FUND_NO
       ORDER BY Z.FUND_NO
    ) LOOP
      --2.2 以上述的「異動基金代碼」至【EC(不)定額異動紀錄(ECS.RSP_LOG)】取得「備註(REMARK)」不包含'%合併%'且
      --   「契約狀態(STATUS)」<>'1.收件'且
      --   「修改日期(含時分秒) (REVISION_DATE)」大於「上次交易日期時間(@LastDateTime)」且小於等於傳入的執行條件日期時分
      --   的契約變更資料
      FOR RSPLOG_REC IN
        (SELECT *
          FROM ECS.RSP_LOG
         WHERE FUND_NO = RSP_REC.FUND_NO  --異動基金代碼
           AND STATUS <> '1' --不是收件
           AND REMARK NOT LIKE '%合併%'  --不包含合併
           AND REVISION_DATE > RSP_REC.LastDateTime AND REVISION_DATE <= WEXEC_DATE
         ORDER BY REVISION_DATE
        ) LOOP

          XCOUNT := XCOUNT + 1;
          --2.3 將上述取得的資料更新【後台EC RSP契約資料(FAS.EC_RSP)】檔
          -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
          UPDATE FAS.EC_RSP
            SET AMOUNT = RSPLOG_REC.AMOUNT, --申購價金
                AC_DAY = RSPLOG_REC.AC_DAY, --扣款日
                STATUS = RSPLOG_REC.STATUS, --契約狀態
                -- 2018.12.14 JIANXIN MOD BY 新增拋轉欄位 專案碼、手續費率
                PROJECT_CODE = RSPLOG_REC.PROJECT_CODE, --專案碼
                SC_RATE = RSPLOG_REC.SC_RATE, --手續費率
                RAISE_ROI = RSPLOG_REC.RAISE_ROI,        --加碼點(%)
                RAISE_AMOUNT = RSPLOG_REC.RAISE_AMOUNT,  --加碼金額
                REDUCE_ROI = RSPLOG_REC.REDUCE_ROI,      --減碼點(%)
                REDUCE_AMOUNT = RSPLOG_REC.REDUCE_AMOUNT,--減碼金額
                EXPECTED_TX_DATE_CHG = NVL(RSPLOG_REC.EXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD'))  --異動後首次扣款日
          WHERE ID = RSPLOG_REC.ID
            AND ID_SEQ = RSPLOG_REC.ID_SEQ;

      END LOOP;
  END LOOP;

  --2.4 所有的異動契約資料更新後，新增一筆資料至【EC(不)定額轉檔紀錄(FAS.EC_RSP_TRANSFER_LOG)】檔
  INSERT INTO FAS.EC_RSP_TRANSFER_LOG
            (FUND_NO,TX_DATE,TRANS_DATE,EMP_NO,LOG_TIME,COUNT,TYPE,SET_TIME,IMPORT_TYPE)
     VALUES ('MOD', --基金別
             XCONDITION_DATE, --交易日
             XCONDITION_DATE, --產生日期
             WEXEC_UERID,     --最後修改人員
             XSYS_DTTM,       --log time
             XCOUNT,          --筆數
             'M',             --交易類別
             --2018.11.06 PAN MOD
             --XCONDITION_TIME, --轉檔時間
             XCONDITION_TIME2, --轉檔時間
             CASE WHEN XCONDITION_TIME = '1200' THEN 'F'
                  WHEN XCONDITION_TIME = '1600' THEN 'O'
                  ELSE 'O'
              END             --匯入型態
            );

END S_ECSB002_Execute_VALID;

/

  GRANT EXECUTE ON "ECS"."S_ECSB002_EXECUTE_VALID" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB003_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB003_EXECUTE" --紅利點數入帳通知作業
-- =============================================
-- 2019.12.05 Yuanlong 移除「系統日期後5日」變數
--                     移除「僅針對既有受益人寄發通知信」
--                     調整「受益人姓名」、「寄發EMAIL」取得邏輯
--                     增加「是否開戶」欄位
-- =============================================
(
    WEXEC_DATE              IN DATE,          --資料處理日期
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE           OUT VARCHAR2,     --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    CMSGLIST                OUT SYS_REFCURSOR --回傳的 TABLEDATA
) IS
  --變數宣告
  XCONDITION_DATE DATE; --執行日期
  XSYS_DTTM DATE;       --系統日期時間
  XCOUNT NUMBER(9);     --筆數
BEGIN
  --給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入資料處理日期中的日期
  XSYS_DTTM := SYSDATE;--取得系統日期時間
  WFINSISH_CODE := 'S';

  --1.自【紅利配發資料(FAS.REWARD_POINT)】及【受益人(FAS.HOLDER)】檔，抓取符合
  --  生效日(含)小於等於執行條件『資料處理日期』,大於系統日期後5日 且
  --  未寄發 且 已開戶、未銷戶、有效電子郵件帳號之受益人的紅利配發資料
  INSERT INTO ECS.REWARDLIST
        (ID,BF_NAME,BF_EMAIL,REWARD_NO,REWARD_POINT,VALID_FROM,VALID_THRU,REWARD_NAME)
  --2019.12.05 Yuanlong 調整「受益人姓名」、「寄發EMAIL」取得邏輯、移除「僅針對既有受益人寄發通知信」
  SELECT A.ID,                  --受益人ID
         B.NAME AS BF_NAME,     --受益人姓名
         B.EMAIL,               --寄發EMAIL
         A.REWARD_NO,           --紅利編號
         A.REWARD_POINT,        --紅利點數
         A.VALID_FROM,          --生效日(含)
         A.VALID_THRU,          --點數有效截止日期
         C.NAME REWARD_NAME     --紅利活動名稱
    FROM FAS.REWARD_POINT A
    JOIN FAS.HOLDER B ON B.ID = A.ID
    LEFT JOIN FAS.REWARD_PROGRAM C ON C.PROGRAM_NO = A.PROGRAM_NO
   WHERE A.VALID_FROM <= XCONDITION_DATE
     AND A.VALID_THRU > XSYS_DTTM
     AND A.IS_EMAIL = 'N'         --未寄發
     AND B.EC_DATE IS NOT NULL    --已開戶
     AND B.CLOSE_DATE IS NULL     --未銷戶
     AND (B.EMAIL IS NOT NULL AND B.EMAIL_VALID = 'Y')  --有效電子郵件帳號
   UNION
  SELECT A.ID,                  --受益人ID
         A.NAME AS BF_NAME,     --受益人姓名
         A.EMAIL,               --寄發EMAIL
         A.REWARD_NO,           --紅利編號
         A.REWARD_POINT,        --紅利點數
         A.VALID_FROM,          --生效日(含)
         A.VALID_THRU,          --點數有效截止日期
         C.NAME REWARD_NAME     --紅利活動名稱
    FROM FAS.REWARD_POINT A
    LEFT JOIN FAS.HOLDER B ON B.ID = A.ID
    LEFT JOIN FAS.REWARD_PROGRAM C ON C.PROGRAM_NO = A.PROGRAM_NO
   WHERE A.VALID_FROM <= XCONDITION_DATE
     AND A.VALID_THRU > XSYS_DTTM
     AND A.IS_EMAIL = 'N'         --未寄發
     AND B.ID IS NULL             --未開戶
     AND TRIM(A.EMAIL) IS NOT NULL;     --EMAIL

  --2.將上述的紅利配發資料設定為'已寄發
  UPDATE FAS.REWARD_POINT
     SET IS_EMAIL = 'Y',
         REVISION_DATE = XSYS_DTTM,
         UPDATEID = WEXEC_UERID,
         UPDATEDATE = XSYS_DTTM
   WHERE REWARD_NO IN (SELECT REWARD_NO FROM ECS.REWARDLIST);

  --3.若無任何符合的資料,須通知前端
  SELECT COUNT(*) INTO XCOUNT
    FROM ECS.REWARDLIST;

  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
  END IF;

  --4.將第1點的資料傳回前端
  OPEN CMSGLIST FOR
    --2019.12.05 Yuanlong 增加欄位「是否開戶」
    SELECT A.*
          ,CASE WHEN B.EC_DATE IS NULL THEN 'N' 
              ELSE 'Y' 
              END IS_EC         --是否開戶
      FROM ECS.REWARDLIST A
      LEFT JOIN FAS.HOLDER B 
      ON B.ID = A.ID
     ORDER BY A.ID,A.REWARD_NO;

END S_ECSB003_EXECUTE;

/

  GRANT EXECUTE ON "ECS"."S_ECSB003_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB004_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB004_EXECUTE" --紅利點數即將到期提醒通知作業
-- =============================================
-- 2019.12.05 Yuanlong 增加寄信給非既有受益人
--                     增加欄位活動名稱、是否開戶
-- =============================================
(
    WEXEC_DATE              IN DATE,          --資料處理日期
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE           OUT VARCHAR2,     --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    CMSGLIST                OUT SYS_REFCURSOR --回傳的 TABLEDATA
) IS
  --變數宣告
  XCONDITION_DATE DATE; --執行日期
  XCAL_SDT DATE;        --計算起日
  XCAL_EDT DATE;        --計算迄日
  XCOUNT NUMBER(9);     --筆數
BEGIN
  --給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入資料處理日期中的日期
  XCAL_SDT := TO_DATE(TO_CHAR(XCONDITION_DATE,'YYYYMM')||'01','YYYYMMDD'); --取得計算起日
  XCAL_EDT := TO_DATE(TO_CHAR(ADD_MONTHS(XCONDITION_DATE,1),'YYYYMM')||'01','YYYYMMDD') - 1; --取得計算迄日
  WFINSISH_CODE := 'S';

  --1.自【紅利配發資料(FAS.REWARD_POINT)】及【受益人(FAS.HOLDER)】檔，抓取符合
  --  生效日(含)大於計算起日 且 截止日(含)小於等於計算迄日 且
  --  已開戶、未銷戶、有效電子郵件帳號之受益人的紅利配發資料
  INSERT INTO ECS.REWARDLIST
        (ID,BF_NAME,BF_EMAIL,REWARD_POINT)
  SELECT A.ID,           --受益人ID
         B.NAME BF_NAME, --受益人姓名
         B.EMAIL BF_EMAIL,  --寄發EMAIL
         SUM(A.REWARD_POINT - A.USED_POINT) REWARD_POINT --剩餘紅利點數
    FROM FAS.REWARD_POINT A
    JOIN FAS.HOLDER B ON B.ID = A.ID
    LEFT JOIN FAS.REWARD_PROGRAM C ON C.PROGRAM_NO = A.PROGRAM_NO
   WHERE A.VALID_THRU > XCAL_SDT
     AND A.VALID_THRU <= XCAL_EDT
     AND B.EC_DATE IS NOT NULL    --已開戶
     AND B.CLOSE_DATE IS NULL     --未銷戶
     AND (B.EMAIL IS NOT NULL AND B.EMAIL_VALID = 'Y') --有效電子郵件帳號
     AND A.REWARD_POINT <> A.USED_POINT --未使用完
   GROUP BY A.ID,B.NAME,B.EMAIL;

  --2.若無任何符合的資料,須通知前端
  SELECT COUNT(*) INTO XCOUNT
    FROM ECS.REWARDLIST;

  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
  END IF;

  --3.將第1點的資料傳回前端
  OPEN CMSGLIST FOR
    -- 2019.12.05 Yuanlong 增加寄信給非既有受益人
    --                     增加欄位活動名稱、是否開戶
    SELECT A.ID,                --受益人ID
           A.BF_NAME,           --受益人姓名
           A.BF_EMAIL,          --寄發EMAIL
           A.REWARD_POINT,      --紅利點數
           '' REWARD_NAME,      --活動名稱
           'Y' IS_EC            --是否開戶
      FROM ECS.REWARDLIST A
     UNION
    SELECT A.ID,                  --受益人ID
           A.NAME BF_NAME,        --受益人姓名
           A.EMAIL BF_EMAIL,      --寄發EMAIL
           A.REWARD_POINT,        --紅利點數
           C.NAME REWARD_NAME,    --活動名稱
           'N' IS_EC              --是否開戶
      FROM FAS.REWARD_POINT A
      LEFT JOIN FAS.HOLDER B ON B.ID = A.ID
      LEFT JOIN FAS.REWARD_PROGRAM C ON C.PROGRAM_NO = A.PROGRAM_NO
     WHERE A.VALID_THRU > XCAL_SDT
       AND A.VALID_THRU <= XCAL_EDT
       AND B.ID IS NULL           --未開戶
       AND TRIM(A.EMAIL) IS NOT NULL    --有效電子郵件帳號
     GROUP BY A.ID,A.NAME,A.EMAIL,A.REWARD_POINT,C.NAME
     ORDER BY ID;

END S_ECSB004_EXECUTE;

/

  GRANT EXECUTE ON "ECS"."S_ECSB004_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB007_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB007_EXECUTE" 
-- =============================================
-- Author:      CTS
-- Create date: 2018.07.20
-- Description: 投資人開戶資料批次開戶作業
-- 2018.10.21 JIANXIN 新增弱勢族群增加判斷
-- 2018.10.26 JIANXIN 移除弱勢族群增加判斷
-- 2018.11.13 tingting 寫入FAS.HOLDER 增加寫入 EMPLOYER 服務單位名稱 欄位
-- 2018.11.21 JIANXIN 調整寫入欄位規則
--                    1. 新增 寫入 OCCUPATION、FATCA_TAG、FATCA_TAG_COMP_DATE、OPEN_TYPE、TDCC_OPEN_DATE 欄位
--                    2. 調整 OCCUPATION1、ECS、INTERMEDIARY_SWIFT_CODE 寫入規則
--                    3. 若財金-台幣與集保-台幣相同，則財金-台幣不新增，只新增集保-台幣
-- 2018.11.28 JIANXIN MOD BY 調整寫入欄位規則
--                    1. 新增 寫入 IS_KYC、FATCA_AGREEMENT、PERSONAL_INFO_AGREEMENT 欄位
--                    2. 調整至分行簡稱
-- 2018.11.28 JIANXIN MOD BY 1. 若是集保台外幣帳號，銀行帳號、總行、分行代碼皆相同時，以MMA新增至系統
--                           2. 傳真同意書預設 'N'
--                           3. FATCA 同意書預設為'Y'
--                           4. 郵寄投資生活月刊預設為'2'
--                           5. 若是集保外幣，適用網路交易預設為N
-- 2018.11.29 JIANXIN MOD BY 1. NAME、ENAME、FIRST_NAME、MIDDLE_NAME、LAST_NAME、EMAIL、EMAIL_VALID、OFFSHORE_ACCOUNT、IS_KYC、FATCA_TAG、FATCA_TAG_COMP_DATE、FATCA_AGREEMENT、OPEN_TYPE、TDCC_OPEN_DATE 欄位調整
--                           2. 調整至分行簡稱
--                           3. 若是集保台幣與財金台幣相同時，則新增時帳戶保管平台 = '04'、集保開戶資料 = 'Y'，並更新受益人集保帳號生效日
--                           4. 調整財金外幣判斷
--                           5. 調整送交核印日期
-- 2018.11.30 JIANXIN MOD BY 1. 財金外幣帳號，不適用於EC
--                           2. 寫入服務單位名稱、員工代碼
-- 2018.12.04 JIANXIN MOD BY 1. 受益人資料中的收件者，若有法定代理人，則需寫入法定代理人的姓名
-- 2018.12.05 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
-- 2018.12.07 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
-- 2018.12.14 JIANXIN MOD BY 調整舊戶加開內容
-- 2018.12.27 JIANXIN MOD BY 若舊戶加開EC業務員寫入原本的業務員內容
-- 2019.01.16 JIANXIN MOD BY 因資料庫有預設值問題，故而新增 INCORPORATION_COUNTRY,LOCATION_COUNTRY 欄位
-- 2019.01.17 JIANXIN MOD BY 1. 因資料庫有預設值問題，故而新增 FAX1_COUNTRY,FAX1_AREA,FAX1_NO,FAX1_EXT,FAX1_VALID,FAX1 欄位
--                           2. 調整ENAME 欄位內容
-- 2019.01.21 yunchu 調整欄位去除空白
-- 2019.01.22 yunchu 調整變更稅籍編號3的判斷
-- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
-- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
-- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
-- 2019.05.10 JIANXIN MOD BY 若買回帳號兩者相同，則要共用同一帳號，故而調整
-- 2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
-- 2019.05.21 JIANXIN MOD 移除錯誤處理方式
-- 2019.05.28 JIANXIN MOD 修正'04'平台寫入幣別錯誤
-- 2019.06.04 JIANXIN 調整幣別
-- 2019.06.04 tingting 1.修正UPDATE不到資料就INSERT的條件不一致問題
--                     2.調整FAS.HOLDER_BANK_EC_CHANGE最後修改日，含有時分秒
--                     3.調整加開"04.瑞萬"寫入平台代碼錯誤(01→04)
--                     4.還原2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
--                     5.埋LOG
-- 2019.06.10 JIANXIN 1.調整財金-外幣帳戶的判斷
--                    2.調整帳戶幣別的判斷
-- 2019.06.13 JIANXIN 調整帳戶幣別的判斷
-- 2019.06.13 tingting 1.調整變更財金-台幣相關資料的帳戶保管平台判斷
--                     2.調整變更財金-台幣相關資料的幣別判斷
-- 2019.06.14 tingting 因加開"04.瑞萬"或實體戶升級EC戶的部份，已經在其他地方處理過了，故註解掉
-- 2019.06.17 tingting 新增判斷，財金-台幣若核印完成日期在2016/12/1前，需新增一筆”提高扣款額度”之異動資料
-- 2019.06.18 tingting 新增判斷，若客戶原有"其他銀行"平台之扣款帳號，應新增一筆"變更扣款帳號"之異動資料，變更扣款帳號為財金帳號，不是二者同時存在
-- 2019.06.19 tingting 調整 TDCC_UPLOAD 資料
-- 2019.11.31 tingting 調整若有集保外幣，收益分配帳戶只新增'04'基金公司
-- 2019.09.03 ChengYu 新戶開戶時，寫入受益人基本資料(FAS.HOLDER)的電子郵件帳號有效註(EMAIL_VALID) 調整為N
-- 2019.12.16 ChengYu 調整 ROBO同意書(ROBO_AGREEMENT)、ROBO同意書簽署日期(ROBO_DATE)預設值
-- 2020.04.24 ChengYu 調整銀行分行簡稱變數大小
-- 2020.05.19 Chengyu 修正寫入【FAS.HOLDER_RELATIVE(受益人法代資料檔)】時資料重複問題
-- 2002.05.26 Chengyu 用RowNum排除【FAS.HOLDER_RELATIVE(受益人法代資料檔)】新增時的重複資料
-- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
-- 2020.10.13 Chengyu 如為新戶且有推薦人，新增優惠眷至新戶與推薦人
-- 2020.10.30 tingting 修正寫LOG造成流水號跳號問題
-- 2020.11.03 by Chengyu 調整取戶號取得方式、新增寫入集保戶號
-- 2021.03.12 by Chengyu 修正取戶號時FAS.SEQ_ACCOUNT_NO錯誤(SP中必須先用Sequence.NEXTVAL後才能用Sequence.CURRVAL)
-- 2021.03.16 by Chengyu 1.修正推薦人優惠券新增語法;2.修正呼叫ECS.s_GetSrNo3錯誤
-- 2021.03.30 Chengyu 線上開戶時TDCC_UPLOAD 更新為Y
-- 2021.07.12 Chengyu 調整優惠券代碼取法
-- 2021.07.20 JIANXIN 新增 CRS_DATE、CRS_TYPE、CRS_STATUS 欄位
-- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
-- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
-- 2021.09.01 Chengyu 修正舊戶做線上開戶時，沒有押核印完成日問題
-- 2021.12.23 Chengyu 若舊戶RSP契約已存在扣款帳號資料，則寫入送核時間與完成核印日期 
-- 2022.07.30 JIANXIN 新增KYC 題目與調整原KYC題目內容
-- 2022.11.29 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
-- 2023.02.03 JIANXIN 調整瀚亞投資與M&G的基金公司，境內與境外寫反調整
-- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
-- 2023.04.19 JIANXIN 調整傳統定額取得多筆資料，造成後續錯誤，故而調整同帳號，只取得最後核印狀況
-- 2023.05.31 JIANXIN 後台新增發證日期相關欄位
-- 2024.03.01 JIANXIN 在新開戶的時候，新增開戶後新增使用者代碼；舊戶加開則不確定是否有使用者代碼，故而不處理
-- 2024.03.07 JIANXIN 在新開戶的時候，新增開戶後新增使用者代碼；規則改為身份証末4碼+出生月日4碼
-- =============================================
(
    WEXEC_DATE              IN DATE,          --資料處理日期
    WID                     IN VARCHAR2,      --客戶ID
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE           OUT VARCHAR2      --完成狀能(S:執行成功, F:執行失敗, X:無資料)
) IS
  --變數宣告
  XSYS_DATE DATE;   --執行日期
  XSYS_DTTM DATE;   --執行時間
  XCOUNT NUMBER(9); --筆數
  XCOUNT_AMC04 NUMBER(9); --加開瑞萬筆數(判斷是否有加開瑞萬,若為0表示有加開)
  XTDCC_VALID_FROM DATE; --受益人集保帳號生效日
  XSN NUMBER(6);
  XID_AMC VARCHAR2(10);
  -- 2020.04.24 ChengYu 調整銀行分行簡稱變數大小
  XSNAME VARCHAR2(15);
  XSWIFT_CODE VARCHAR2(30);
  XIS_NEW_TDCC_MMA VARCHAR2(1);  --Y:新開立MMA帳號
  XIS_01 VARCHAR2(1); --Y:將其他的帳號改成'01'保管平台
  XIS_TO_EC NUMBER(9); --若不為0表示實體戶升級 EC 戶
  HOLDER_BANK_EC_REC FAS.HOLDER_BANK_EC%ROWTYPE;
  HOLDER_DIVIDEND_AMC_REC FAS.HOLDER_DIVIDEND_AMC%ROWTYPE;
  HOLDER_DIVIDEND_BANK_REC FAS.HOLDER_DIVIDEND_BANK%ROWTYPE;
  HOLDER_DIVIDEND_BANK_NTD_REC FAS.HOLDER_DIVIDEND_BANK%ROWTYPE;
  XREWARD_NO NUMBER(10);
  -- 2018.12.14 JIANXIN MOD BY 調整舊戶加開內容
  XFIS_BANK_NO_TWD_FCY VARCHAR2(1) :='Y';
  -- 2020.11.03 by Chengyu 調整取戶號取得方式、新增寫入集保戶號
  XACCOUNT_NO NUMBER(7,0);
  -- 2021.07.12 Chengyu 調整優惠券代碼取法
  XCOUPON_ID_CUS     NVARCHAR2(7);  --客戶優惠券
  XCOUPON_ID_SPONSOR NVARCHAR2(7);  --推薦人優惠券
  XCOUPON_ID_STR NVARCHAR2(4000);   --已取號優惠券代碼(確認是否重複)
  XDATA_CNT INT;                    --資料筆數
  /*
  ------------------------------------------------------------------------
  --OUTPUT LOG 用變數
  XLOG_AC_BANK              FAS.HOLDER_BANK_EC_CHANGE.AC_BANK%TYPE;
  XLOG_AC_BRANCH            FAS.HOLDER_BANK_EC_CHANGE.AC_BRANCH%TYPE;
  XLOG_AC_CODE              FAS.HOLDER_BANK_EC_CHANGE.AC_CODE%TYPE;
  XLOG_DEPOSITORY_NO_OLD    FAS.HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD%TYPE;
  ------------------------------------------------------------------------
  */
BEGIN
  --給變數值
  XSYS_DTTM := sysdate; --取得系統日期時間
  XSYS_DATE := TO_DATE(TO_CHAR(XSYS_DTTM,'YYYYMMDD'),'YYYYMMDD');
  WFINSISH_CODE := 'S';

  dbms_output.put_line('XSYS_DTTM：' || XSYS_DTTM);

  --1.準備事項
  --1.1 取得合乎條件的新戶或舊戶
  DELETE FROM ECS.ECSB007_IDList;
  FOR HOLDER_REC IN
      (SELECT A.ID,A.IS_ES_ACCOUNT,A.ACCOUNT_NO
         FROM ECS.HOLDER A
        WHERE TRIM(A.PROCESS_CODE) = '6'  --股務審核完成，待開戶 之
          AND (WID IS NULL OR A.ID = WID) FOR UPDATE
      ) LOOP

  dbms_output.put_line(' ');
  dbms_output.put_line('INSERT INTO ECS.ECSB007_IDList BEGIN  戶號：新戶 會用FAS.SEQ_ACCOUNT_NO.NEXTVAL取得戶號，舊戶 回傳NULL');

      -- 2020.11.03 by Chengyu 調整取戶號取得方式、新增寫入集保戶號
      XACCOUNT_NO := CASE WHEN NVL(HOLDER_REC.ACCOUNT_NO,0) = 0 THEN FAS.SEQ_ACCOUNT_NO.NEXTVAL ELSE HOLDER_REC.ACCOUNT_NO END;
      --寫入暫存檔
      IF HOLDER_REC.IS_ES_ACCOUNT = 'N' THEN --若為新戶,則取得戶號
        INSERT INTO ECS.ECSB007_IDList (ID,IS_ES_ACCOUNT,ACCOUNT_NO)
            VALUES (HOLDER_REC.ID,HOLDER_REC.IS_ES_ACCOUNT,XACCOUNT_NO);

        -- 2020.10.30 tingting 修正寫LOG造成流水號跳號問題(NEXTVAL→CURRVAL)(PS.CURRVAL需在NEXTVAL調用後才能使用)
        -- 2021.03.12 by Chengyu 修正取戶號時FAS.SEQ_ACCOUNT_NO錯誤(SP中必須先用Sequence.NEXTVAL後才能用Sequence.CURRVAL)
        dbms_output.put_line('  ID, IS_ES_ACCOUNT, ACCOUNT_NO：' || HOLDER_REC.ID || ',' || HOLDER_REC.IS_ES_ACCOUNT || ',' || XACCOUNT_NO);
      ELSE
        dbms_output.put_line('  ID, IS_ES_ACCOUNT, ACCOUNT_NO：' || HOLDER_REC.ID || ',' || HOLDER_REC.IS_ES_ACCOUNT || ',' || NULL);

        INSERT INTO ECS.ECSB007_IDList (ID,IS_ES_ACCOUNT,ACCOUNT_NO)
            VALUES (HOLDER_REC.ID,HOLDER_REC.IS_ES_ACCOUNT,NULL);
      END IF;
  END LOOP;

  dbms_output.put_line('INSERT INTO ECS.ECSB007_IDList END');

  SELECT COUNT(*) INTO XCOUNT FROM ECS.ECSB007_IDList;
  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
    RETURN;
  END IF;

  --1.2 取得轉入FAS.HOLDER的日期,以"B.營業日"的下一營業日
  SELECT MIN(CALENDAR_DATE) INTO XTDCC_VALID_FROM
    FROM (
          SELECT A.CALENDAR_DATE, --日期
                 A.YEAR_DAY,      --當年度的第幾天
                 A.QUARTER_ID,    --當年度的第幾季
                 A.WEEK_ID,       --第幾週
                 A.WEEK_DAY,      --星期幾(0表示星期日)
                 CASE WHEN B.CALENDAR_CODE IS NULL THEN 'W' ELSE 'H' END BUSS_ID, --是否為營業日(W:營業日, H:假日)
                 B.NAME REMARK    --備註
            FROM Table( cast(ECS.F_SWS_GETDATELIST(XSYS_DATE-30,XSYS_DATE+30) as ECS.CalendarTypes)) A
            LEFT JOIN FAS.CALENDAR B ON B.CALENDAR_CODE = 'B' AND B.HOLIDAY = A.CALENDAR_DATE
         ) Z
   WHERE Z.CALENDAR_DATE > XSYS_DATE
     AND Z.BUSS_ID = 'W';

  dbms_output.put_line(' ');
  dbms_output.put_line('處理新戶 BEGIN');
  dbms_output.put_line('ECS.ECSB007_IDList.IS_ES_ACCOUNT = Y 的才會INSERT INTO FAS.HOLDER');
  dbms_output.put_line('INSERT INTO FAS.HOLDER BEGIN');

  --2.處理新戶
  --2.1 將新戶開戶已審核完成的資料寫入受益人基本資料檔(FAS.HOLDER)
  INSERT INTO FAS.HOLDER
        (--基本資料
         ID,NAME,ENAME,FIRST_NAME,MIDDLE_NAME,LAST_NAME,OPEN_DATE,ACCOUNT_NO,BIRTH_DATE,NATIONALITY,BIRTH_COUNTRY,
         TEL_H_COUNTRY,TEL_H_AREA,TEL_H_NO,TEL_H_EXT,TEL_H_VALID,TEL_H,
         TEL_O_COUNTRY,TEL_O_AREA,TEL_O_NO,TEL_O_EXT,TEL_O_VALID,TEL_O,MOBILE_COUNTRY,MOBILE,MOBILE_VALID,
         FAX_COUNTRY,FAX_AREA,FAX_NO,FAX_EXT,FAX_VALID,FAX,
         -- 2019.01.17 JIANXIN MOD BY 因資料庫有預設值問題，故而新增 FAX1_COUNTRY,FAX1_AREA,FAX1_NO,FAX1_EXT,FAX1_VALID,FAX1 欄位
         FAX1_COUNTRY,FAX1_AREA,FAX1_NO,FAX1_EXT,FAX1_VALID,FAX1,
         EMAIL,EMAIL_VALID,
         CONTACT_ADDRESS_COUNTRY,POST_CODE,CONTACT_ADDRESS,CONTACT_ADDRESS_VALID,
         REG_ADDRESS_COUNTRY,REG_POST_CODE,REG_ADDRESS,
         -- 2018.12.04 JIANXIN MOD BY 1. 受益人資料中的收件者，若有法定代理人，則需寫入法定代理人的姓名
         RECIPIENT,
         --法代
         REPRESENTATIVE,REPRESENTATIVE_ID,REPRESENTATIVE1,REPRESENTATIVE1_ID,
         --申報
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OCCUPATION 欄位
         C_TYPE,TAX_TYPE,OCCUPATION,OCCUPATION1,OBU_VALID,OSU_VALID,
         --境外
         OFFSHORE_ACCOUNT,OPEN_TYPE,OFFSHORE_DATE,JOINT_ACCOUNT,TDCC_TYPE,TDCC_UPLOAD,
         --FAX
         FAX_DATE,
         --EC
         EC_DATE,ECS_STATUS,PASSWD_CHANGED,
         --交易限制
         FAX_AGREEMENT,ROBO_AGREEMENT,ROBO_DATE,
         --客戶服務
         PRIORITY_FAX,CS_SMS,
         --業績
         SALES_NO,EC_SALES_NO,CLASS_NO,CLASS_NO_STATUS,
         --FATCA
         -- 2018.11.21 JIANXIN MOD 新增 寫入 FATCA_TAG、FATCA_TAG_COMP_DATE 欄位
         -- 2018.11.28 JIANXIN MOD 新增 寫入 FATCA_AGREEMENT 欄位
         -- 2019.01.16 JIANXIN MOD BY 因資料庫有預設值問題，故而新增 INCORPORATION_COUNTRY,LOCATION_COUNTRY 欄位
         US_TAX,FATCA_TYPE,FATCA_TAG,FATCA_TAG_COMP_DATE,FATCA_AGREEMENT,INCORPORATION_COUNTRY,LOCATION_COUNTRY,
         --CRS
         TAX_MODIFIED,
         --AML
         AML_STATUS,
         --通知書
         CONFIRMATION_NOTICE,DAILY_STATEMENT,MONTHLY_STATEMENT,SEMIANNUAL_STATEMENT,CS_MAIL,CS_FAX,CS_FAX1,CS_EMAIL,
         --文宣
         -- 2018.11.28 JIANXIN MOD 新增 寫入 PERSONAL_INFO_AGREEMENT 欄位
         EDM_ACCEPTED,NAV_EPAPER,DM_ACCEPTED,ML_TYPE,GROUP_DM,PERSONAL_INFO_AGREEMENT,
         --缺件
         OMIT_A,OMIT_B,OMIT_C,OMIT_D,OMIT_E,OMIT_F,OMIT_G,OMIT_H,OMIT_I,OMIT_J,OMIT_K,OMIT_L,OMIT_M,
         --輸入註記
         OPEN_EMP_NO,COMPLETE_DATE,REVIEWED_BY,REVIEW_DATE,EMP_NO,LAST_MODIFIED,STATUS,
         --無歸類
         MAIN_RELATED_COUNT,
         -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
         --居住地
         CURRENT_ADDRESS,CURRENT_ADDRESS_COUNTRY,CURRENT_POST_CODE,
         -- 2021.07.20 JIANXIN 新增 CRS_DATE、CRS_TYPE、CRS_STATUS 欄位
         --CRS 相關審查
         CRS_ADDRESS_EQUAL,CRS_DATE,CRS_STATUS,CRS_TYPE
         -- =================KYC 題目異動=========================
         -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
         ,EMPLOYER                                          -- 服務單位名稱 
         ,CUST_FAMILY_STATUS                                -- 家庭狀況1:單身 2:已婚 3:其他
         ,CUST_FAMILY_STATUS_TXT                            -- 家庭狀況_其他(說明)
         ,CUST_CHILD_STATUS                                 -- 家庭狀況1:無(小孩) 2:有(小孩)
         ,CUST_CHILD_STATUS_TXT                             -- 家庭狀況_小孩人數 
         ,PROFESSION                                        -- 職業別(KYC)
         ,PROFESSION_OTHERS_NEW                             -- 職業別_其他_新(KYC)
         ,POSITION                                          -- 職務(KYC)
         ,POSITION_OTHERS                                   -- 職務_其他(KYC)
         ,CUST_INV_FUNDS_1               　　               -- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
         ,CUST_INV_FUNDS_2               　　               -- 投資資金來源(複選)(退休金/保險年金)
         ,CUST_INV_FUNDS_3               　　               -- 投資資金來源(複選)(租賃所得)
         ,CUST_INV_FUNDS_4               　　               -- 投資資金來源(複選)(遺產餽贈)
         ,CUST_INV_FUNDS_5               　　               -- 投資資金來源(複選)(投資所得(資本所得、利息收入))
         ,CUST_INV_FUNDS_6               　　               -- 投資資金來源(複選)(閒置資金)
         ,CUST_INV_FUNDS_7               　　               -- 投資資金來源(複選)(其他)
         ,CUST_INV_FUNDS_7_TXT                              -- 投資資金來源_其他(說明)
         ,CUST_INV_FINSOURCE_1                              -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
         ,CUST_INV_FINSOURCE_2                              -- 投資理財資訊來源(可複選)書報雜誌
         ,CUST_INV_FINSOURCE_3                              -- 投資理財資訊來源(可複選)網際網路
         ,CUST_INV_FINSOURCE_4                              -- 投資理財資訊來源(可複選)其他
         ,CUST_INV_FINSOURCE_4_TXT                          -- 投資理財資訊來源(可複選)其他(說明)
         ,CUST_INV_ESTAMT                                   -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
         ,CUST_RESIDENCE_STATUS                             -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
         ,CUST_RESIDENCE_STATUS_TXT                         -- 目前居住及照護狀態(說明)
         ,CUST_MIND_STATUS                 　　             -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
         ,MAJOR_ILLNESS                                     -- 重大傷病證明 Y:有 N:無 D:無勾選

         ,CUST_RISK_AGE                                     -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
         ,EDUCATION                                         -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
         ,CUST_RISK_INVTOOL                                 -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
         ,CUST_RISK_INVEXP                                  -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
         ,CUST_RISK_INVPURPOSE                              -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
         ,FAMILY_INCOME                                     -- 個人或家庭平均年收入
         ,CUST_RISK_INVPROFIT                               -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
         ,CUST_RISK_FUNDING                                 -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
         ,CUST_RISK_FLUIDITY                                -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
         ,CUST_RISK_PRICEVOL                                -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

         -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
         ,VULNERABLE_CLAIM                                  -- 自主申購聲明\1：空值；2：同意；3：不同意
         ,RISK_LEVEL                                        -- 新客戶風險屬性 1:保守 2:穩健 3:積極
         ,KYC_SCROE                                         -- KYC 分數

         ,RISK_STATUS                                       -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
         ,RISK_WRITE_DATE                                   -- 適合度分析表最後一次填寫日
         ,RISK_MAT_DATE                                     -- 適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)

         ,GENDAR                                            --性別(F:女生 M:男生 C:公司)
         ,IS_KYC 
         -- 2024.03.01 JIANXIN 在新開戶的時候，新增開戶後新增使用者代碼；舊戶加開則不確定是否有使用者代碼，故而不處理
         ,USER_ALIAS
         ,USER_ALIAS_CHG_DATE
        )
  SELECT A.ID,
         --基本資料
         TRIM(A.NAME) AS NAME,
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME) ||' '|| TRIM(A.MIDDLE_NAME) AS ENAME, --英文姓名,由下列3欄位組合
         TRIM(A.FIRST_NAME) AS FIRST_NAME,  --英文名
         TRIM(A.MIDDLE_NAME) AS MIDDLE_NAME, --英文中間名
         TRIM(A.LAST_NAME) AS LAST_NAME,   --英文姓氏
         XSYS_DATE OPEN_DATE, --開戶日期(即轉入FAS.HOLDER的日期)
         Z.ACCOUNT_NO, --戶號
         A.BIRTH_DATE, --出生日期
         TRIM(A.NATIONALITY) AS NATIONALITY, --國籍
         TRIM(A.BIRTH_COUNTRY) AS BIRTH_COUNTRY, --出生地國碼
         TRIM(A.TEL_H_COUNTRY) AS TEL_H_COUNTRY, --電話(宅)–國碼
         TRIM(A.TEL_H_AREA) AS TEL_H_AREA, --電話(宅)–區碼
         TRIM(A.TEL_H_NO) AS TEL_H_NO, --電話(宅)–電話
         TRIM(A.TEL_H_EXT) AS TEL_H_EXT, --電話(宅)–分機
         'Y' TEL_H_VALID, --電話(宅)–有效註記
         TRIM(A.TEL_H_AREA) ||'-'|| TRIM(A.TEL_H_NO) || CASE WHEN TRIM(A.TEL_H_EXT) IS NOT NULL THEN '#'||TRIM(A.TEL_H_EXT) ELSE NULL END TEL_H, --電話(宅)
         TRIM(A.TEL_O_COUNTRY) AS TEL_O_COUNTRY, --電話(公)–國碼
         TRIM(A.TEL_O_AREA) AS TEL_O_AREA, --電話(公)–區碼
         TRIM(A.TEL_O_NO) AS TEL_O_NO, --電話(公)–電話
         TRIM(A.TEL_O_EXT) AS TEL_O_EXT, --電話(公)–分機
         'Y' TEL_O_VALID, --電話(公)–有效註記
         TRIM(A.TEL_O_AREA) ||'-'|| TRIM(A.TEL_O_NO) ||CASE WHEN TRIM(A.TEL_O_EXT) IS NOT NULL THEN '#'|| TRIM(A.TEL_O_EXT) ELSE NULL END TEL_O, --電話(公)
         TRIM(A.MOBILE_COUNTRY) AS MOBILE_COUNTRY, --行動電話–國碼
         TRIM(A.MOBILE) AS MOBILE, --行動電話
         'Y' MOBILE_VALID, --行動電話–有效註記
         TRIM(A.FAX_COUNTRY) AS FAX_COUNTRY, --傳真1–國碼
         TRIM(A.FAX_AREA) AS FAX_AREA, --傳真1–區碼
         TRIM(A.FAX_NO) AS FAX_NO, --傳真1–電話
         TRIM(A.FAX_EXT) AS FAX_EXT, --傳真1–分機
         'Y' FAX_VALID, --傳真1–有效註記
         TRIM(A.FAX_AREA) ||'-'|| TRIM(A.FAX_NO) || CASE WHEN TRIM(A.FAX_EXT) IS NOT NULL THEN '#'|| TRIM(A.FAX_EXT) ELSE NULL END FAX, --傳真1
         -- 2019.01.17 JIANXIN MOD BY 因資料庫有預設值問題，故而新增 FAX1_COUNTRY,FAX1_AREA,FAX1_NO,FAX1_EXT,FAX1_VALID,FAX1 欄位
         '' FAX1_COUNTRY, --傳真2–國碼
         '' FAX1_AREA, --傳真2–區碼
         '' FAX1_NO, --傳真2–電話
         '' FAX1_EXT, --傳真2–分機
         'N' FAX1_VALID, --傳真2–有效註記
         '' FAX1, --傳真2
         TRIM(A.EMAIL) AS EMAIL, --電子郵件帳號
         -- 2019.09.03 ChengYu 新戶開戶時，寫入受益人基本資料(FAS.HOLDER)的電子郵件帳號有效註(EMAIL_VALID) 調整為N
         'N' EMAIL_VALID, --電子郵件帳號有效註記
         TRIM(A.CONTACT_ADDRESS_COUNTRY) AS CONTACT_ADDRESS_COUNTRY, --通訊地址國碼
         TRIM(A.POST_CODE) AS POST_CODE, --通訊郵遞區號
         TRIM(A.CONTACT_ADDRESS) AS CONTACT_ADDRESS, --通訊地址
         'Y' CONTACT_ADDRESS_VALID, --通訊地址檢核
         TRIM(A.REG_ADDRESS_COUNTRY) AS REG_ADDRESS_COUNTRY, --戶籍地址國碼
         TRIM(A.REG_POST_CODE) AS REG_POST_CODE, --戶籍郵遞區號
         TRIM(A.REG_ADDRESS) AS REG_ADDRESS, --戶籍地址
         -- 2018.12.04 JIANXIN MOD BY 受益人資料中的收件者，若有法定代理人，則需寫入法定代理人的姓名
         TRIM(A.REPRESENTATIVE) || ' ' || TRIM(A.REPRESENTATIVE1),
         --法代
         TRIM(A.REPRESENTATIVE) AS REPRESENTATIVE, --法定代理人
         LTRIM(A.REPRESENTATIVE_ID) AS REPRESENTATIVE_ID, --法代ID
         TRIM(A.REPRESENTATIVE1) AS REPRESENTATIVE1, --法定代理人1
         LTRIM(A.REPRESENTATIVE1_ID) AS REPRESENTATIVE1_ID, --法代1ID
         --CASE WHEN A.REPRESENTATIVE IS NOT NULL THEN A.REPRESENTATIVE ELSE A.REPRESENTATIVE1 END REPRESENTATIVE, --法定代理人
         --CASE WHEN A.REPRESENTATIVE IS NOT NULL THEN A.REPRESENTATIVE_ID ELSE A.REPRESENTATIVE1_ID END REPRESENTATIVE_ID, --法代ID
         --CASE WHEN A.REPRESENTATIVE IS NULL THEN NULL ELSE A.REPRESENTATIVE1 END REPRESENTATIVE1, --法定代理人1
         --CASE WHEN A.REPRESENTATIVE IS NULL THEN NULL ELSE A.REPRESENTATIVE1_ID END REPRESENTATIVE1_ID, --法代1ID
         --申報
         CASE WHEN LENGTH(A.ID) = 8 THEN '2'
              WHEN SUBSTRB(A.ID,2,1) BETWEEN 'A' AND 'Z' THEN '3'
              ELSE '1'
          END C_TYPE, --身份別(1 本國自然人 2 本國法人 3 境內外國自然人 4 境內外國法人 5 境外外國自然人 6 境外外國法人 7 法人分戶)
         'A' TAX_TYPE, --身份稅別(A:居住者 B:非居住者 C:QFII)
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OCCUPATION 欄位、調整 OCCUPATION1 寫入規則
         '140' OCCUPATION,
         '1400' OCCUPATION1, --行業別-央行申報使用
         'N' OBU_VALID, --OBU註記
         'N' OSU_VALID, --OSU註記
         --境外
         'Y' OFFSHORE_ACCOUNT, --境外基金戶
         '1' OPEN_TYPE, --開戶類別(1:國內開戶 2:國外直接開戶)
         XSYS_DATE OFFSHORE_DATE, --境外基金開戶日(即轉入FAS.HOLDER的日期)
         'N' JOINT_ACCOUNT, --共同持有帳戶
         '01' TDCC_TYPE,  --TDCC 客戶身分別
         -- 2018.12.05 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
         -- 2018.12.07 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
         -- 2021.03.30 Chengyu 線上開戶時TDCC_UPLOAD 更新為Y
         CASE WHEN A.OPEN_TYPE = '2' THEN 'Y'
              ELSE 'A' END TDCC_UPLOAD, --TDCC 回傳註記
         --FAX
         XSYS_DATE FAX_DATE, --fax開戶日(即轉入FAS.HOLDER的日期)
         --EC
         XSYS_DATE EC_DATE, --EC開戶日(即轉入FAS.HOLDER的日期)
         '1' ECS_STATUS, --EC狀態
         'N' PASSWD_CHANGED, --EC密碼變更
         --交易限制
         -- 2018.11.28 JIANXIN MOD BY 傳真同意書預設 'N'
         'N' FAX_AGREEMENT, --傳真同意書
         -- 2019.12.16 ChengYu 調整 ROBO同意書(ROBO_AGREEMENT)、ROBO同意書簽署日期(ROBO_DATE)預設值
         'N' ROBO_AGREEMENT, --ROBO同意書
         TO_DATE('19000101','YYYYMMDD') ROBO_DATE, --ROBO同意書簽署日期(即轉入FAS.HOLDER的日期)        
         --客戶服務
         'N' PRIORITY_FAX, --優先傳真
         'D' CS_SMS, --簡訊服務(Y:是 N:否 D:未申請)
         --業績
         'A66666' SALES_NO, --業務員碼
         'A66666' EC_SALES_NO, --EC 業務員
         'X' CLASS_NO, --DS關係戶分類
         'N' CLASS_NO_STATUS, --DS關係戶分類確認狀態
         --FATCA
         'N' US_TAX, --美國報稅
         'C' FATCA_TYPE, --FATCA分類
         -- 2018.11.21 JIANXIN MOD 新增 寫入 FATCA_TAG、FATCA_TAG_COMP_DATE 欄位
         'Y' FATCA_TAG,
         XSYS_DATE FATCA_TAG_COMP_DATE,
         -- 2018.11.28 JIANXIN MOD 新增 寫入 FATCA_AGREEMENT 欄位
         -- 2018.11.28 JIANXIN MOD FATCA 同意書預設為'Y'
         'Y' FATCA_AGREEMENT,
         -- 2019.01.16 JIANXIN MOD BY 因資料庫有預設值問題，故而新增 INCORPORATION_COUNTRY,LOCATION_COUNTRY 欄位
         '' INCORPORATION_COUNTRY,
         '' LOCATION_COUNTRY,
         --CRS
         XSYS_DATE TAX_MODIFIED, --稅籍更新日(即轉入FAS.HOLDER的日期)
         --AML
         'A' AML_STATUS, --帳戶狀態(D:Dormant:無法進行所有交易、R:Redeem Only:客戶僅能買回，無法進行新申購、A:Active:正常交易)
         --通知書
         'N' CONFIRMATION_NOTICE,  --交易確認書
         'N' DAILY_STATEMENT,      --交易對帳單
         'N' MONTHLY_STATEMENT,    --月對帳單
         'N' SEMIANNUAL_STATEMENT, --半年對帳單
         'G' CS_MAIL,  --對帳單郵寄(G:普通 H:限時 I:掛號 J: 限時掛號 Z:不列印)
         '0' CS_FAX,   --對帳單傳真(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
         '0' CS_FAX1,  --對帳單傳真2(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
         'Y' CS_EMAIL, --對帳單Email(Y:是 N:否 D:未申請)
         --文宣
         A.EDM_ACCEPTED, --EDM ACCEPTED(Y:是 N:否)
         'N' NAV_EPAPER, --訂閱淨值電子報
         CASE WHEN A.EDM_ACCEPTED = 'Y' THEN 'Y' ELSE 'N' END DM_ACCEPTED, --郵寄宣傳資料(Y:同意 N.不同意)
         -- 2018.11.28 JIANXIN MOD 郵寄投資生活月刊預設為'2'
         '2' ML_TYPE,    --郵寄投資生活月刊(1:同意 2.不同意)
         CASE WHEN A.EDM_ACCEPTED = 'Y' THEN '1' ELSE '2' END GROUP_DM,    --願意收到集團行銷資料(1:同意 2.不同意)
         -- 2018.11.28 JIANXIN MOD 新增 寫入 PERSONAL_INFO_AGREEMENT 欄位
         'Y' PERSONAL_INFO_AGREEMENT, --個資同意書(Y:同意 N.不同意)
         --缺件
         'N' OMIT_A, --缺印鑑卡(Y:缺件 N:OK)
         'N' OMIT_B, --缺身份證影本(Y:缺件 N:OK)
         'N' OMIT_C, --缺營利事業登記證(Y:缺件 N:OK)
         'N' OMIT_D, --缺傳真約定書(Y:缺件 N:OK)
         'N' OMIT_E, --缺印鑑變更掛失申請書(Y:缺件 N:OK)
         'N' OMIT_F, --缺資料變更申請書(Y:缺件 N:OK)
         'N' OMIT_G, --缺資料變更申請書(Y:缺件 N:OK)
         'N' OMIT_H, --缺法定代理人或負責人身份證影本項目(Y:缺件 N:OK)
         'N' OMIT_I, --缺未成年子女戶口名簿影本(Y:缺件 N:OK)
         'N' OMIT_J, --缺公司使用執照(Y:缺件 N:OK)
         'N' OMIT_K, --缺開戶基本資料(Y:缺件 N:OK)
         'N' OMIT_L, --缺網路/語音交易同意書(Y:缺件 N:OK)
         'N' OMIT_M, --缺銀行授權書(Y:缺件 N:OK)
         --輸入註記
         A.CREATEID OPEN_EMP_NO,  --建檔人員
         A.CREATEDATE COMPLETE_DATE,  --建檔完成日
         A.APPROVEID REVIEWED_BY,  --覆核人員
         A.APPROVEDATE REVIEW_DATE,  --覆核日期
         A.UPDATEID EMP_NO, --員工代碼(修改人員)
         A.UPDATEDATE LAST_MODIFIED,  --最後修改日期
         'R' STATUS,  --狀態('R'覆核確認)
         --無歸類
         0 MAIN_RELATED_COUNT, --主帳戶-關係戶筆數
         -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
         --居住地
         TRIM(A.CURRENT_ADDRESS) CURRENT_ADDRESS,
         TRIM(A.CURRENT_ADDRESS_COUNTRY) CURRENT_ADDRESS_COUNTRY,
         TRIM(A.CURRENT_POST_CODE) CURRENT_POST_CODE,
         CASE WHEN TRIM(A.CURRENT_ADDRESS) = TRIM(A.CONTACT_ADDRESS) THEN 'Y' ELSE 'N' END CRS_ADDRESS_EQUAL,
         -- 2021.07.20 JIANXIN 新增 CRS_DATE、CRS_TYPE、CRS_STATUS 欄位
         XSYS_DATE CRS_DATE,  --CRS 審查完成日期
         '' CRS_STATUS,  --CRS
         'A' CRS_TYPE  --CRS 帳戶類別: A. 低資產客戶 B. 高資產客戶 C. 高資產法人客戶
         -- =================KYC 題目異動=========================
         -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
         ,TRIM(A.EMPLOYER)                                          -- 服務單位名稱 
         ,TRIM(A.MARRIED)                                -- 家庭狀況1:單身 2:已婚 3:其他
         ,TRIM(A.MARRIED_OTHER)                            -- 家庭狀況_其他(說明)
         -- 2022.11.29 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
         ,CASE WHEN TRIM(A.MS_NUM_CODE) = 'N' THEN '1' ELSE '2' END                                 -- 家庭狀況1:無(小孩) 2:有(小孩)
         ,TRIM(A.MS_NUM)                             -- 家庭狀況_小孩人數 
         ,TRIM(A.PROFESSION)                                        -- 職業別(KYC)
         ,TRIM(A.PROFESSION_OTHERS_NEW)                             -- 職業別_其他_新(KYC)
         ,TRIM(A.POSITION)                                          -- 職務(KYC)
         ,TRIM(A.POSITION_OTHERS)                                   -- 職務_其他(KYC)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(退休金/保險年金)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(租賃所得)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(遺產餽贈)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '5' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '6' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(閒置資金)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_ORI,',')) WHERE COLUMN_VALUE  = '7' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(其他)
         ,TRIM(A.INV_ORI_OTHER)                                     -- 投資資金來源_其他(說明)
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END              -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END              -- 投資理財資訊來源(可複選)書報雜誌
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END              -- 投資理財資訊來源(可複選)網際網路
         ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END              -- 投資理財資訊來源(可複選)其他
         ,TRIM(A.INV_KNOWLEDGE_OTHER)                               -- 投資理財資訊來源(可複選)其他(說明)
         ,TRIM(A.INVEST_CODE)                                       -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
         ,TRIM(A.CUST_RESIDENCE_STATUS)                             -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
         ,TRIM(A.CUST_RESIDENCE_STATUS_TXT)                         -- 目前居住及照護狀態(說明)
         ,TRIM(A.CUST_MIND_STATUS)                 　　             -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
         ,TRIM(A.MAJOR_ILLNESS)                                     -- 重大傷病證明 Y:有 N:無 D:無勾選

         ,TRIM(A.BF_AGE_CODE)                                       -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
         ,TRIM(A.EDUCATION)                                         -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
         ,TRIM(A.INV_TOOL)                                          -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
         ,TRIM(A.INV_EXPERIENCE)                                    -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
         ,TRIM(A.INV_GOAL)                                          -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
         ,TRIM(A.FAMILY_INCOME)                                     -- 個人或家庭平均年收入
         ,TRIM(A.INV_FAIL_METHOD)                                   -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
         ,TRIM(A.SIGNIFICANT_NEEDS)                                 -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
         ,TRIM(A.LIQUIDITY_NEEDS)                                   -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
         ,TRIM(A.PRICE_VOLATILITY)                                  -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

         -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
         ,TRIM(A.VULNERABLE_CLAIM)                                  -- 自主申購聲明\1：空值；2：同意；3：不同意
         ,TRIM(A.RISK_LEVEL)                                        -- 新客戶風險屬性 1:保守 2:穩健 3:積極
         ,TRIM(A.KYC_SCROE)                                         -- KYC 分數

         ,'1' AS RISK_STATUS                                  -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
         ,XSYS_DATE AS RISK_WRITE_DATE                        -- 適合度分析表最後一次填寫日
         ,Add_months(XSYS_DATE,12) - 1 AS RISK_MAT_DATE       -- 適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)

         ,CASE WHEN LENGTH(A.ID) = 8 THEN 'C'
              WHEN SUBSTRB(A.ID,2,1) BETWEEN 'A' AND 'Z' THEN NULL
              WHEN SUBSTRB(A.ID,2,1) = '1' THEN 'M'
              WHEN SUBSTRB(A.ID,2,1) = '2' THEN 'F'
              ELSE NULL
          END GENDAR                                            --性別(F:女生 M:男生 C:公司)
         ,'N' AS IS_KYC 
         -- 2024.03.01 JIANXIN 在新開戶的時候，新增開戶後新增使用者代碼；舊戶加開則不確定是否有使用者代碼，故而不處理
         -- 2024.03.07 JIANXIN 在新開戶的時候，新增開戶後新增使用者代碼；規則改為身份証末4碼+出生月日4碼
         ,ECS.CRYPT(SUBSTR(A.ID,LENGTH(A.ID)-3,4) || SUBSTR(TO_CHAR(A.BIRTH_DATE,'YYYYMMDD'),LENGTH(TO_CHAR(A.BIRTH_DATE,'YYYYMMDD'))-3,4) ) AS USER_ALIAS
         ,TO_DATE('19000101','YYYYMMDD') AS USER_ALIAS_CHG_DATE
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER END');

  dbms_output.put_line('ECS.ECSB007_IDList.IS_ES_ACCOUNT = N 的才會INSERT INTO 下列 TABLE');
  dbms_output.put_line('UPDATE OR INSERT INTO FAS.HOLDER_RELATIVE BEGIN');

  --2.2 將新戶開戶已審核完成的法代資料寫入受益人法代資料檔(FAS.HOLDER_RELATIVE)
  --2.2.1 將法定代理人(父) 姓名等相關資料寫入
    MERGE INTO FAS.HOLDER_RELATIVE X
    USING (
          -- 2020.05.19 Chengyu 修正寫入【FAS.HOLDER_RELATIVE(受益人法代資料檔)】時資料重複問題
          -- 2002.05.26 Chengyu 用RowNum排除【FAS.HOLDER_RELATIVE(受益人法代資料檔)】新增時的重複資料
          SELECT DATA.*
            FROM (
                  SELECT LTRIM(A.REPRESENTATIVE_ID) AS REPRESENTATIVE_ID,
                         LTRIM(A.REPRESENTATIVE) AS REPRESENTATIVE, --姓名
                         TRIM(A.REP_NATIONALITY_CODE) AS REP_NATIONALITY_CODE, --國籍
                         A.REP_BIRTH_DATE, --生日
                         TRIM(A.REP_ADDRESS) AS REP_ADDRESS, --通訊地址
                         ROW_NUMBER() OVER (PARTITION BY A.REPRESENTATIVE_ID ORDER BY A.REPRESENTATIVE) AS Num
                    FROM ECS.ECSB007_IDList Z
                    JOIN ECS.HOLDER A ON A.ID = Z.ID
                   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
                     AND LTRIM(A.REPRESENTATIVE) IS NOT NULL --有填寫法定代理人(父)相關資料
                 ) DATA
           WHERE DATA.Num = 1
          ) Y
    ON (X.ID = Y.REPRESENTATIVE_ID)
    --若存在則更新
    WHEN MATCHED THEN
      UPDATE
         SET X.NAME = Y.REPRESENTATIVE, --姓名
             X.RELATIVE_TYPE = 'D', --關係別(D:父親 M:母親)
             X.GENDAR = 'M', --性別(F/M)
             X.NATIONALITY = Y.REP_NATIONALITY_CODE, --國籍
             X.BIRTH_DATE = Y.REP_BIRTH_DATE, --生日
             X.CONTACT_ADDRESS = Y.REP_ADDRESS, --通訊地址
             X.REVISION_DATE = XSYS_DTTM, --最後修改日期
             X.REVISED_BY = 'ECS'  --最後修改人員
    --若不存在則新增
    WHEN NOT MATCHED THEN
      -- 2023.05.31 JIANXIN 後台新增發證日期相關欄位
      INSERT VALUES
        (LTRIM(Y.REPRESENTATIVE_ID),
         'D',                          --關係別(D:父親 M:母親)
         'M',                          --性別(F/M)
         TRIM(Y.REP_NATIONALITY_CODE), --國籍
         Y.REP_BIRTH_DATE,             --生日
         TRIM(Y.REP_ADDRESS),          --通訊地址
         XSYS_DTTM,                    --最後修改日期
         'ECS',                        --最後修改人員
         TRIM(Y.REPRESENTATIVE),       --姓名
         NULL ,                        --發證日期-年
         NULL ,                        --發證日期-月
         NULL ,                        --發證日期-日
         NULL ,                        --發證地點
         NULL                          --發證類別: 初發:I 補發:S 換發:C
         );   

/*  --存在更新
  UPDATE (
          SELECT \*+BYPASS_UJVC*\
                 --更改前的資料
                 B.NAME, --姓名
                 B.RELATIVE_TYPE, --關係別(D:父親 M:母親)
                 B.GENDAR, --性別(F/M)
                 B.NATIONALITY, --國籍
                 B.BIRTH_DATE, --生日
                 B.CONTACT_ADDRESS, --通訊地址
                 B.REVISION_DATE, --最後修改日期
                 B.REVISED_BY, --最後修改人員
                 --更改後的資料
                 A.REPRESENTATIVE, --姓名
                 A.REP_NATIONALITY_CODE, --國籍
                 A.REP_BIRTH_DATE, --生日
                 A.REP_ADDRESS, --通訊地址
                 A.UPDATEDATE, --最後修改日期
                 A.UPDATEID --最後修改人員
            FROM ECS.ECSB007_IDList Z
            JOIN ECS.HOLDER A ON A.ID = Z.ID
            JOIN FAS.HOLDER_RELATIVE B ON B.ID = A.REPRESENTATIVE_ID
           WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
             AND A.REPRESENTATIVE IS NOT NULL --有填寫法定代理人(父)相關資料
          )
     SET NAME = REPRESENTATIVE, --姓名
         RELATIVE_TYPE = 'D', --關係別(D:父親 M:母親)
         GENDAR = 'M', --性別(F/M)
         NATIONALITY = REP_NATIONALITY_CODE, --國籍
         BIRTH_DATE = REP_BIRTH_DATE, --生日
         CONTACT_ADDRESS = REP_ADDRESS, --通訊地址
         REVISION_DATE = UPDATEDATE, --最後修改日期
         REVISED_BY = UPDATEID; --最後修改人員

  --不存在新增
  INSERT INTO FAS.HOLDER_RELATIVE
        (ID,NAME,RELATIVE_TYPE,GENDAR,NATIONALITY,BIRTH_DATE,CONTACT_ADDRESS,REVISION_DATE,REVISED_BY)
  SELECT A.REPRESENTATIVE_ID ID,
         A.REPRESENTATIVE NAME, --姓名
         'D' RELATIVE_TYPE, --關係別(D:父親 M:母親)
         'M' GENDAR, --性別(F/M)
         A.REP_NATIONALITY_CODE NATIONALITY, --國籍
         A.REP_BIRTH_DATE BIRTH_DATE, --生日
         A.REP_ADDRESS CONTACT_ADDRESS, --通訊地址
         A.UPDATEDATE REVISION_DATE, --最後修改日期
         A.UPDATEID REVISED_BY --最後修改人員
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    LEFT JOIN FAS.HOLDER_RELATIVE B ON B.ID = A.REPRESENTATIVE_ID
   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
     AND A.REPRESENTATIVE IS NOT NULL --有填寫法定代理人(父)相關資料
     AND B.ID IS NULL; --不存在受益人法代資料檔
*/
  --2.2.2 將法定代理人(母) 姓名等相關資料寫入
  MERGE INTO FAS.HOLDER_RELATIVE X
    USING (
          -- 2020.05.19 Chengyu 修正寫入【FAS.HOLDER_RELATIVE(受益人法代資料檔)】時資料重複問題
          -- 2002.05.26 Chengyu 用RowNum排除【FAS.HOLDER_RELATIVE(受益人法代資料檔)】新增時的重複資料
          SELECT DATA.*
            FROM (
                  SELECT LTRIM(A.REPRESENTATIVE1_ID) AS REPRESENTATIVE1_ID,
                         TRIM(A.REPRESENTATIVE1) AS REPRESENTATIVE1, --姓名
                         TRIM(A.REP_NATIONALITY_CODE1) AS REP_NATIONALITY_CODE1, --國籍
                         A.REP_BIRTH_DATE1, --生日
                         TRIM(A.REP_ADDRESS1) AS REP_ADDRESS1, --通訊地址
                         A.UPDATEDATE, --最後修改日期
                         A.UPDATEID, --最後修改人員
                         ROW_NUMBER() OVER (PARTITION BY A.REPRESENTATIVE1_ID ORDER BY A.REPRESENTATIVE1) AS Num
                    FROM ECS.ECSB007_IDList Z
                    JOIN ECS.HOLDER A ON A.ID = Z.ID
                   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
                     AND LTRIM(A.REPRESENTATIVE1) IS NOT NULL --有填寫法定代理人(母)相關資料
                 ) DATA
           WHERE DATA.Num = 1
          ) Y
    ON (X.ID = Y.REPRESENTATIVE1_ID)
    --若存在則更新
    WHEN MATCHED THEN
      UPDATE
         SET X.NAME = TRIM(Y.REPRESENTATIVE1), --姓名
             X.RELATIVE_TYPE = 'M', --關係別(D:父親 M:母親)
             X.GENDAR = 'F', --性別(F/M)
             X.NATIONALITY = TRIM(Y.REP_NATIONALITY_CODE1), --國籍
             X.BIRTH_DATE = Y.REP_BIRTH_DATE1, --生日
             X.CONTACT_ADDRESS = TRIM(Y.REP_ADDRESS1), --通訊地址
             X.REVISION_DATE = XSYS_DTTM, --最後修改日期
             X.REVISED_BY = 'ECS'  --最後修改人員
    --若不存在則新增
    WHEN NOT MATCHED THEN
      -- 2023.05.31 JIANXIN 後台新增發證日期相關欄位
      INSERT VALUES
        (LTRIM(Y.REPRESENTATIVE1_ID),
         'M',                           --關係別(D:父親 M:母親)
         'F',                           --性別(F/M)
         TRIM(Y.REP_NATIONALITY_CODE1), --國籍
         Y.REP_BIRTH_DATE1,             --生日
         TRIM(Y.REP_ADDRESS1),          --通訊地址
         XSYS_DTTM,                     --最後修改日期
         'ECS',                         --最後修改人員
         TRIM(Y.REPRESENTATIVE1),       --姓名
         NULL ,                        --發證日期-年
         NULL ,                        --發證日期-月
         NULL ,                        --發證日期-日
         NULL ,                        --發證地點
         NULL                          --發證類別: 初發:I 補發:S 換發:C
         );   

/*  --存在更新
  UPDATE (
          SELECT \*+BYPASS_UJVC*\
                 --更改前的資料
                 B.NAME, --姓名
                 B.RELATIVE_TYPE, --關係別(D:父親 M:母親)
                 B.GENDAR, --性別(F/M)
                 B.NATIONALITY, --國籍
                 B.BIRTH_DATE, --生日
                 B.CONTACT_ADDRESS, --通訊地址
                 B.REVISION_DATE, --最後修改日期
                 B.REVISED_BY, --最後修改人員
                 --更改後的資料
                 A.REPRESENTATIVE1, --姓名
                 A.REP_NATIONALITY_CODE1, --國籍
                 A.REP_BIRTH_DATE1, --生日
                 A.REP_ADDRESS1, --通訊地址
                 A.UPDATEDATE, --最後修改日期
                 A.UPDATEID --最後修改人員
            FROM ECS.ECSB007_IDList Z
            JOIN ECS.HOLDER A ON A.ID = Z.ID
            JOIN FAS.HOLDER_RELATIVE B ON B.ID = A.REPRESENTATIVE1_ID
           WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
             AND A.REPRESENTATIVE1 IS NOT NULL --有填寫法定代理人(母)相關資料
          )
     SET NAME = REPRESENTATIVE1, --姓名
         RELATIVE_TYPE = 'M', --關係別(D:父親 M:母親)
         GENDAR = 'F', --性別(F/M)
         NATIONALITY = REP_NATIONALITY_CODE1, --國籍
         BIRTH_DATE = REP_BIRTH_DATE1, --生日
         CONTACT_ADDRESS = REP_ADDRESS1, --通訊地址
         REVISION_DATE = UPDATEDATE, --最後修改日期
         REVISED_BY = UPDATEID; --最後修改人員

  --不存在新增
  INSERT INTO FAS.HOLDER_RELATIVE
        (ID,NAME,RELATIVE_TYPE,GENDAR,NATIONALITY,BIRTH_DATE,CONTACT_ADDRESS,REVISION_DATE,REVISED_BY)
  SELECT A.REPRESENTATIVE1_ID ID,
         A.REPRESENTATIVE1 NAME, --姓名
         'M' RELATIVE_TYPE, --關係別(D:父親 M:母親)
         'F' GENDAR, --性別(F/M)
         A.REP_NATIONALITY_CODE1 NATIONALITY, --國籍
         A.REP_BIRTH_DATE1 BIRTH_DATE, --生日
         A.REP_ADDRESS1 CONTACT_ADDRESS, --通訊地址
         A.UPDATEDATE REVISION_DATE, --最後修改日期
         A.UPDATEID REVISED_BY --最後修改人員
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    LEFT JOIN FAS.HOLDER_RELATIVE B ON B.ID = A.REPRESENTATIVE1_ID
   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
     AND A.REPRESENTATIVE1 IS NOT NULL --有填寫法定代理人(母)相關資料
     AND B.ID IS NULL; --不存在受益人法代資料檔
*/

  dbms_output.put_line('UPDATE OR INSERT INTO FAS.HOLDER_RELATIVE END');

  dbms_output.put_line('INSERT INTO FAS.S_HOLDER_TAX_INF BEGIN');

  --2.3 將新戶開戶已審核完成的受益人稅籍資料寫入受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)
  --2.3.1 有填寫稅籍國家1相關資料
  INSERT INTO FAS.S_HOLDER_TAX_INF
        -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
        (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
  SELECT A.ID, --主ID
         A.ID AS S_ID, --次ID
         LTRIM(A.TAX_COUNTRY1) AS TAX_COUNTRY, --稅籍國家
         TRIM(A.TAX_NUM1) AS TAX_NUM, --稅籍編號
         'R' STATUS, --狀態
         A.CREATEID CREATED_BY, --建檔人
         A.CREATEDATE CREATION_DATE, --建檔日期
         A.UPDATEID REVISED_BY, --修改人
         A.UPDATEDATE UPDATE_DATE, --更新日期
         -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
         TRIM(A.TAXNOREASON1) TAXATION_TYPE,  -- 無稅籍編號理由
         TRIM(A.TAXATION_REMARK1) TAXATION_REMARK  --稅籍備註
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
     AND LTRIM(A.TAX_COUNTRY1) IS NOT NULL; --有填寫稅籍國家1相關資料

  --2.3.2 有填寫稅籍國家2相關資料
  INSERT INTO FAS.S_HOLDER_TAX_INF
        -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
        (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
  SELECT A.ID, --主ID
         A.ID AS S_ID, --次ID
         LTRIM(A.TAX_COUNTRY2) AS TAX_COUNTRY, --稅籍國家
         TRIM(A.TAX_NUM2) AS TAX_NUM, --稅籍編號
         'R' STATUS, --狀態
         A.CREATEID CREATED_BY, --建檔人
         A.CREATEDATE CREATION_DATE, --建檔日期
         A.UPDATEID REVISED_BY, --修改人
         A.UPDATEDATE UPDATE_DATE, --更新日期
         -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
         TRIM(A.TAXNOREASON2) TAXATION_TYPE,  -- 無稅籍編號理由
         TRIM(A.TAXATION_REMARK2) TAXATION_REMARK  --稅籍備註
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
     AND LTRIM(A.TAX_COUNTRY2) IS NOT NULL; --有填寫稅籍國家2相關資料

  --2.3.3 有填寫稅籍國家3相關資料
  INSERT INTO FAS.S_HOLDER_TAX_INF
        -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
        (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
  SELECT A.ID, --主ID
         A.ID AS S_ID, --次ID
         LTRIM(A.TAX_COUNTRY3) AS TAX_COUNTRY, --稅籍國家
         TRIM(A.TAX_NUM3) AS TAX_NUM, --稅籍編號
         'R' STATUS, --狀態
         A.CREATEID CREATED_BY, --建檔人
         A.CREATEDATE CREATION_DATE, --建檔日期
         A.UPDATEID REVISED_BY, --修改人
         A.UPDATEDATE UPDATE_DATE, --更新日期
         -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
         TRIM(A.TAXNOREASON3) TAXATION_TYPE,  -- 無稅籍編號理由
         TRIM(A.TAXATION_REMARK3) TAXATION_REMARK  --稅籍備註
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
     AND LTRIM(A.TAX_COUNTRY3) IS NOT NULL; --有填寫稅籍國家3相關資料

  dbms_output.put_line('INSERT INTO FAS.S_HOLDER_TAX_INF END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC BEGIN  AMC_NO = 01');

  --2.4 將新戶開戶已審核完成的受益人開戶別資料寫入受益人開戶別資料檔(FAS.HOLDER_AMC)
  --2.4.1 加入瀚亞投信(境內)
  INSERT INTO FAS.HOLDER_AMC
        -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
        (ID,AMC_NO,OPEN_DATE,ACCOUNT_NO,OPEN_TYPE)
  SELECT A.ID,
         '01' AMC_NO, --基金經理公司
         -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
         XSYS_DTTM OPEN_DATE, --開戶日期(即轉入FAS.HOLDER的日期)
         Z.ACCOUNT_NO ACCOUNT_NO, --戶號
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
         'N' OPEN_TYPE  -- 國外直接開戶
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC BEGIN  AMC_NO = 02');

  --2.4.2 加入瀚亞投資(新加坡)
  INSERT INTO FAS.HOLDER_AMC
        -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
        (ID,AMC_NO,OPEN_DATE,OPEN_TYPE)
  SELECT A.ID,
         '02' AMC_NO, --基金經理公司
         -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
         XSYS_DTTM OPEN_DATE, --開戶日期(即轉入FAS.HOLDER的日期)
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
         '1' OPEN_TYPE
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC BEGIN  AMC_NO = 03');

  --2.4.3 加入M&G(新加坡)
  INSERT INTO FAS.HOLDER_AMC
        -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
        (ID,AMC_NO,OPEN_DATE,OPEN_TYPE)
  SELECT A.ID,
         '03' AMC_NO, --基金經理公司
         -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
         XSYS_DTTM OPEN_DATE, --開戶日期(即轉入FAS.HOLDER的日期)
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE 欄位
         '1' OPEN_TYPE
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC BEGIN  AMC_NO = 03');

  -- 2020.11.03 by Chengyu 調整取戶號取得方式、新增寫入集保戶號
  --2.4.4 加入瑞萬通博(TDCC)
  INSERT INTO FAS.HOLDER_AMC
        -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE、TDCC_OPEN_DATE 欄位
        (ID,AMC_NO,OPEN_DATE,OPEN_TYPE,TDCC_OPEN_DATE,TDCC_ACCT_NO)
  SELECT A.ID,
         '04' AMC_NO, --基金經理公司
         -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
         XSYS_DTTM OPEN_DATE, --開戶日期(即轉入FAS.HOLDER的日期)
         -- 2018.11.21 JIANXIN MOD 新增 寫入 OPEN_TYPE、TDCC_OPEN_DATE 欄位
         '1' OPEN_TYPE,
         -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
         XSYS_DTTM TDCC_OPEN_DATE,
         A.TDCC_ACCT_NO
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  將有輸入財金-台幣相關資料寫入買回帳號資料檔');

  --整理買回帳號、扣款帳號、分配帳號
  INSERT INTO ECS.ECSB007_BANKLIST
         (TYPE,ACCOUNT_TYPE,ID,BANK_NO,BRANCH_NO,AC_CODE,CURRENCY_NO,AMC_NO)
  SELECT BankR.TYPE,BankR.ACCOUNT_TYPE,BankR.ID,BankR.BANK_NO,BankR.BRANCH_NO,BankR.AC_CODE,BankR.CURRENCY_NO,BankR.AMC_NO
    FROM ECS.ECSB007_IDList Z
    LEFT JOIN TABLE(ECS.F_ECSB007_GetBankR(Z.ID)) BankR
      ON Z.ID = BankR.ID
     AND BankR.TYPE = 'R'
   UNION ALL
  SELECT BankA.TYPE,BankA.ACCOUNT_TYPE,BankA.ID,BankA.BANK_NO,BankA.BRANCH_NO,BankA.AC_CODE,BankA.CURRENCY_NO,BankA.AMC_NO
    FROM ECS.ECSB007_IDList Z
    LEFT JOIN TABLE(ECS.F_ECSB007_GetBankA(Z.ID)) BankA
      ON Z.ID = BankA.ID
     AND BankA.TYPE = 'A'
   UNION ALL
  SELECT BankD.TYPE,BankD.ACCOUNT_TYPE,BankD.ID,BankD.BANK_NO,BankD.BRANCH_NO,BankD.AC_CODE,BankD.CURRENCY_NO,BankD.AMC_NO
    FROM ECS.ECSB007_IDList Z
    LEFT JOIN TABLE(ECS.F_ECSB007_GetBankD(Z.ID)) BankD
      ON Z.ID = BankD.ID
     AND BankD.TYPE = 'D';


  --2.5 將新戶開戶已審核完成的受益人買回帳號資料寫入受益人買回帳號資料檔(FAS.HOLDER_BANK)
  --2.5.1 財金
  --2.5.1.1 將有輸入財金-台幣相關資料寫入買回帳號資料檔
  INSERT INTO FAS.HOLDER_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
         LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
         ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
  SELECT A.ID, --受益人ID
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱(即受益人姓名)
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         XSYS_DATE VALID_FROM, --生效日(即轉入FAS.HOLDER的日期)
         'A' FUND_TYPE, --基金種類(B:債券型 E:股票型 A:全部)
         -- 2018.11.21 JIANXIN MOD 調整 ECS 寫入規則
         CASE WHEN LTRIM(BANKLIST.CURRENCY_NO) = 'NTD' THEN 'Y' ELSE 'N' END  ECS, --適用網路交易(Y:是 N:否)
         A.CREATEID EMP_NO, --最後修改人員
         A.CREATEDATE LAST_MODIFIED, --最後修改時間
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
         '0' FUND_CATEGORY, --基金類別(0:全部 1:境內 2:境外)
         --B.SWIFT_CODE INTERMEDIARY_SWIFT_CODE, --swift code
         -- 2018.11.21 JIANXIN MOD 調整 INTERMEDIARY_SWIFT_CODE 寫入規則
         '' INTERMEDIARY_SWIFT_CODE,--swift code
         'TWN' COUNTRY_CODE, --FATCA國籍代號
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名(受益人英文戶名)
         '01' DEPOSITORY_NO, --帳戶保管平台代號(01.空白 04.集保)
         'N' TDCC_BANK_UPLOAD, --受益人集保開戶資料上傳註記
         NULL TDCC_VALID_FROM --受益人集保帳號生效日
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'R'  --新增型態；R:FAS.HOLDE_BANK
     AND BANKLIST.ACCOUNT_TYPE = '1' --帳號型態；1:財金台幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  將有輸入財金-外幣相關資料寫入買回帳號資料檔');

  --2.5.1.2 將有輸入財金-外幣相關資料寫入買回帳號資料檔
  INSERT INTO FAS.HOLDER_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
         LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
         ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
  SELECT A.ID, --受益人ID
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱(即受益人姓名)
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         XSYS_DATE VALID_FROM, --生效日(即轉入FAS.HOLDER的日期)
         'A' FUND_TYPE, --基金種類(B:債券型 E:股票型 A:全部)
         'Y' ECS, --適用網路交易(Y:是 N:否)
         A.CREATEID EMP_NO, --最後修改人員
         A.CREATEDATE LAST_MODIFIED, --最後修改時間
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
         '0' FUND_CATEGORY, --基金類別(0:全部 1:境內 2:境外)
         --B.SWIFT_CODE INTERMEDIARY_SWIFT_CODE, --swift code
         -- 2018.11.21 JIANXIN MOD 調整 INTERMEDIARY_SWIFT_CODE 寫入規則
         '' INTERMEDIARY_SWIFT_CODE,--swift code
         'TWN' COUNTRY_CODE, --FATCA國籍代號
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名(受益人英文戶名)
         '01' DEPOSITORY_NO, --帳戶保管平台代號(01.空白 04.集保)
         'N' TDCC_BANK_UPLOAD, --受益人集保開戶資料上傳註記
         NULL TDCC_VALID_FROM --受益人集保帳號生效日
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'R'  --新增型態；R:FAS.HOLDE_BANK
     AND BANKLIST.ACCOUNT_TYPE = '2' --帳號型態；2:財金外幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  將有輸入集保-台幣/MMA相關資料寫入買回帳號資料檔');

  --2.5.2 集保
  --2.5.2.1 將有輸入集保-台幣/MMA相關資料寫入買回帳號資料檔
  INSERT INTO FAS.HOLDER_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
         LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
         ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
  SELECT A.ID, --受益人ID
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱(即受益人姓名)
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
         CASE WHEN (   NVL(LTRIM(A.FIS_BANK_NO_TWD),' ') <> NVL(LTRIM(A.TDCC_BANK_NO),' ')
                    OR NVL(LTRIM(A.FIS_BRANCH_NO_TWD),' ') <> NVL(LTRIM(A.TDCC_BRANCH_NO),' ')
                    OR NVL(LTRIM(A.FIS_AC_CODE_TWD),' ') <> NVL(LTRIM(A.TDCC_AC_CODE),' ')
                   ) THEN NULL
              ELSE XSYS_DATE
         END VALID_FROM, --生效日(即轉入FAS.HOLDER的日期)
         'A' FUND_TYPE, --基金種類(B:債券型 E:股票型 A:全部)
         'Y' ECS, --適用網路交易(Y:是 N:否)
         A.CREATEID EMP_NO, --最後修改人員
         A.CREATEDATE LAST_MODIFIED, --最後修改時間
         -- 2018.11.28 JIANXIN MOD BY 若是集保台外幣帳號，銀行帳號、總行、分行代碼皆相同時，以MMA新增至系統
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         '0' FUND_CATEGORY, --基金類別(0:全部 1:境內 2:境外)
         --B.SWIFT_CODE INTERMEDIARY_SWIFT_CODE, --swift code
         -- 2018.11.21 JIANXIN MOD 調整 ECS、INTERMEDIARY_SWIFT_CODE 寫入規則
         '' INTERMEDIARY_SWIFT_CODE, --swift code
         'TWN' COUNTRY_CODE, --FATCA國籍代號
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名(受益人英文戶名)
         '04' DEPOSITORY_NO, --帳戶保管平台代號(01.空白 04.集保)
         'A' TDCC_BANK_UPLOAD, --受益人集保開戶資料上傳註記
         -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
         CASE WHEN NVL(LTRIM(A.TDCC_CURRENCY_NO),' ') <> ' ' THEN XTDCC_VALID_FROM
              ELSE NULL END TDCC_VALID_FROM --受益人集保帳號生效日
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'R'  --新增型態；R:FAS.HOLDE_BANK
     AND BANKLIST.ACCOUNT_TYPE = '3' --帳號型態；3:集保台幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  將有輸入集保-外幣相關資料寫入買回帳號資料檔');

  --2.5.2.2 將有輸入集保-外幣相關資料寫入買回帳號資料檔
  INSERT INTO FAS.HOLDER_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
         LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
         ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
  SELECT A.ID, --受益人ID
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱(即受益人姓名)
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
         CASE WHEN ((    NVL(LTRIM(A.FIS_BANK_NO_TWD_FCY),' ') = NVL(LTRIM(A.TDCC_BANK_NO_TWD_FCY),' ')
                     AND NVL(LTRIM(A.FIS_BRANCH_NO_TWD_FCY),' ') = NVL(LTRIM(A.TDCC_BRANCH_NO_TWD_FCY),' ')
                     AND NVL(LTRIM(A.FIS_AC_CODE_TWD_FCY),' ') = NVL(LTRIM(A.TDCC_AC_CODE_TWD_FCY),' ')
                    )
                    OR
                    NVL(LTRIM(A.TDCC_CURRENCY_NO_FCY),' ') = ' '
                   ) THEN XSYS_DATE
              ELSE NULL
         END VALID_FROM, --生效日(即轉入FAS.HOLDER的日期)
         'A' FUND_TYPE, --基金種類(B:債券型 E:股票型 A:全部)
         -- 2018.11.28 JIANXIN MOD BY 若是集保外幣，適用網路交易預設為N
         'N' ECS, --適用網路交易(Y:是 N:否)
         A.CREATEID EMP_NO, --最後修改人員
         A.CREATEDATE LAST_MODIFIED, --最後修改時間
         --LTRIM(A.TDCC_CURRENCY_NO_FCY) AS CURRENCY_NO, --幣別
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         '0' FUND_CATEGORY, --基金類別(0:全部 1:境內 2:境外)
         --B.SWIFT_CODE INTERMEDIARY_SWIFT_CODE, --swift code
         -- 2018.11.21 JIANXIN MOD 調整 ECS、INTERMEDIARY_SWIFT_CODE 寫入規則
         '' INTERMEDIARY_SWIFT_CODE, --swift code
         'TWN' COUNTRY_CODE, --FATCA國籍代號
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名(受益人英文戶名)
         '04' DEPOSITORY_NO, --帳戶保管平台代號(01.空白 04.集保)
         'A' TDCC_BANK_UPLOAD, --受益人集保開戶資料上傳註記
         -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
         CASE WHEN NVL(LTRIM(A.TDCC_CURRENCY_NO_FCY),' ') <> ' ' THEN XTDCC_VALID_FROM
              ELSE NULL END TDCC_VALID_FROM --受益人集保帳號生效日
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'R'  --新增型態；R:FAS.HOLDE_BANK
     AND BANKLIST.ACCOUNT_TYPE = '4' --帳號型態；4:集保外幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC BEGIN  將有輸入財金-台幣相關資料寫入扣款帳號資料檔');

  --2.6 將新戶開戶已審核完成的受益人扣款帳號資料寫入受益人扣款帳號資料檔(FAS.HOLDER_BANK_EC)
  --2.6.1 財金
  --2.6.1.1 將有輸入財金-台幣相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_BANK_EC
        (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,VERIFIED,CURRENCY_NO,DEPOSITORY_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS AC_BANK, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS AC_BRANCH, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
         XSYS_DTTM DELIVERED, --送交核印日期(即轉入FAS.HOLDER的日期)
         CASE WHEN NVL(A.FIS_SEAL_DATE_TWD,TO_DATE('1900/01/01','YYYY/MM/DD')) != TO_DATE('1900/01/01','YYYY/MM/DD') THEN XSYS_DTTM ELSE NULL END AS VERIFIED, --核印完成日期
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
         '01' DEPOSITORY_NO --帳戶保管平台代號
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'A'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '1' --帳號型態；1:財金台幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC BEGIN  將有輸入財金-外幣相關資料寫入扣款帳號資料檔');

  --2.6.1.2 將有輸入財金-外幣相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_BANK_EC
        (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,VERIFIED,CURRENCY_NO,DEPOSITORY_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS AC_BANK, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS AC_BRANCH, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
         XSYS_DTTM DELIVERED, --送交核印日期(即轉入FAS.HOLDER的日期)
         CASE WHEN NVL(A.FIS_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) != TO_DATE('1900/01/01','YYYY/MM/DD') THEN XSYS_DTTM ELSE NULL END AS VERIFIED, --核印完成日期
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
         '01' DEPOSITORY_NO --帳戶保管平台代號
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'A'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '2' --帳號型態；2:財金外幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC BEGIN  將有輸入集保-台幣/MMA相關資料寫入扣款帳號資料檔');

  --2.6.2 集保
  --2.6.2.1 將有輸入集保-台幣/MMA相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_BANK_EC
        (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,VERIFIED,CURRENCY_NO,DEPOSITORY_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS AC_BANK, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS AC_BRANCH, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
         XSYS_DTTM DELIVERED, --送交核印日期(即轉入FAS.HOLDER的日期)
         CASE WHEN NVL(A.TDCC_SEAL_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) != TO_DATE('1900/01/01','YYYY/MM/DD') THEN XSYS_DTTM ELSE NULL END AS VERIFIED, --核印完成日期
         --LTRIM(A.TDCC_CURRENCY_NO) AS CURRENCY_NO, --幣別
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         '04' DEPOSITORY_NO --帳戶保管平台代號
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'A'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '3' --帳號型態；3:集保台幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶


  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC BEGIN  將有輸入集保-外幣相關資料寫入扣款帳號資料檔');

  --2.6.2.2 將有輸入集保-外幣相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_BANK_EC
        (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,VERIFIED,CURRENCY_NO,DEPOSITORY_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS AC_BANK, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS AC_BRANCH, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
         XSYS_DTTM DELIVERED, --送交核印日期(即轉入FAS.HOLDER的日期)
         CASE WHEN NVL(A.TDCC_SEAL_DATE_FCY,TO_DATE('1900/01/01','YYYY/MM/DD')) != TO_DATE('1900/01/01','YYYY/MM/DD') THEN XSYS_DTTM ELSE NULL END AS VERIFIED, --核印完成日期
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
         '04' DEPOSITORY_NO --帳戶保管平台代號
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'A'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '4' --帳號型態；4:集保外幣；
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND BEGIN');

  --2.7 將新戶開戶已審核完成的受益人配息設定資料寫入受益人配息設定檔(FAS.HOLDER_DIVIDEND)
  INSERT INTO FAS.HOLDER_DIVIDEND
        (ID,CREATED_BY,CREATION_DATE,REVISED_BY,REVISION_DATE,REVIEWED_BY,REVIEW_DATE,STATUS)
  SELECT A.ID,
         A.CREATEID CREATED_BY, --建立人員
         A.CREATEDATE CREATION_DATE, --建立日期
         A.UPDATEID REVISED_BY, --修改人員
         A.UPDATEDATE REVISION_DATE, --修改日期
         A.APPROVEID REVIEWED_BY, --覆核人員
         A.APPROVEDATE REVIEW_DATE, --覆核日期
         'R' STATUS --狀態('R'覆核確認)
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND BEGIN  AMC_NO = 01');

  --2.8 將新戶開戶已審核完成的受益人配息設定資料寫入基金公司配息設定檔(FAS.HOLDER_DIVIDEND_AMC),須同時寫入4筆
  --2.8.1 01.瀚亞投信(境內)
  INSERT INTO FAS.HOLDER_DIVIDEND_AMC
        (ID,AMC_NO,PAY_TYPE,OMIT)
  SELECT A.ID,
         '01' AMC_NO, --基金經理公司
         '3' PAY_TYPE, --付款方式(1:郵寄支票 2:轉申購 3:匯款 4:匯款(不受最低金額限制))
         'N' OMIT --缺件註記 (Y,N)
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND BEGIN  AMC_NO = 02');

  --2.8.2 02.瀚亞投資(新加坡)
  INSERT INTO FAS.HOLDER_DIVIDEND_AMC
        (ID,AMC_NO,PAY_TYPE,OMIT)
  SELECT A.ID,
         '02' AMC_NO, --基金經理公司
         '3' PAY_TYPE, --付款方式(1:郵寄支票 2:轉申購 3:匯款 4:匯款(不受最低金額限制))
         'N' OMIT --缺件註記 (Y,N)
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND BEGIN  AMC_NO = 03');

  --2.8.3 03.M&G(新加坡)
  INSERT INTO FAS.HOLDER_DIVIDEND_AMC
        (ID,AMC_NO,PAY_TYPE,OMIT)
  SELECT A.ID,
         '03' AMC_NO, --基金經理公司
         '4' PAY_TYPE, --付款方式(1:郵寄支票 2:轉申購 3:匯款 4:匯款(不受最低金額限制))
         'N' OMIT --缺件註記 (Y,N)
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND BEGIN  AMC_NO = 04');

  --2.8.4 04.瑞萬通博(TDCC)
  INSERT INTO FAS.HOLDER_DIVIDEND_AMC
        (ID,AMC_NO,PAY_TYPE,OMIT)
  SELECT A.ID,
         '04' AMC_NO, --基金經理公司
         '4' PAY_TYPE, --付款方式(1:郵寄支票 2:轉申購 3:匯款 4:匯款(不受最低金額限制))
         'N' OMIT --缺件註記 (Y,N)
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND END');

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣 AMC_NO = 01');

  --2.9 將新戶開戶已審核完成的受益人配息帳號資料寫入受益人配息帳號檔(FAS.HOLDER_DIVIDEND_BANK)
  --2.9.1 財金
  --2.9.1.1 將有輸入財金-台幣相關資料寫入配息帳號資料檔
  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'Y' ONSHORE, --境內基金適用(Y,N)
         'N' OFFSHORE, --境外基金適用(Y,N)
         --LTRIM(A.FIS_CURRENCY_NO_TWD) AS CURRENCY_NO,
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '01' AMC_NO --基金經理公司(瀚亞投信(境內))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '1' --帳號型態；1:財金台幣；
     AND BANKLIST.AMC_NO = '01'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣 AMC_NO = 02');

  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'N' ONSHORE, --境內基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         --LTRIM(A.FIS_CURRENCY_NO_TWD) AS CURRENCY_NO,
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '02' AMC_NO --基金經理公司(瀚亞投資(新加坡))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '1' --帳號型態；1:財金台幣；
     AND BANKLIST.AMC_NO = '02'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣 AMC_NO = 03');

  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'N' ONSHORE, --境內基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         --LTRIM(A.FIS_CURRENCY_NO_TWD) AS CURRENCY_NO,
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '03' AMC_NO --基金經理公司(M&G(新加坡))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '1' --帳號型態；1:財金台幣；
     AND BANKLIST.AMC_NO = '03'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;  --財金-台幣

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣 AMC_NO = 01');

  --2.9.1.2 將有輸入財金-外幣相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'Y' ONSHORE, --境內基金適用(Y,N)
         'N' OFFSHORE, --境外基金適用(Y,N)
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO,
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '01' AMC_NO --基金經理公司(瀚亞投信(境內))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '2' --帳號型態；2:財金外幣；
     AND BANKLIST.AMC_NO = '01'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣 AMC_NO = 02');

  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'N' ONSHORE, --境內基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO,
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '02' AMC_NO --基金經理公司(瀚亞投資(新加坡))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '2' --帳號型態；2:財金外幣；
     AND BANKLIST.AMC_NO = '02'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣 AMC_NO = 03');

  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'N' ONSHORE, --境內基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO,
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '03' AMC_NO --基金經理公司(M&G(新加坡))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '2' --帳號型態；2:財金外幣；
     AND BANKLIST.AMC_NO = '03'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  集保-台幣/MMA AMC_NO = 04');

  --2.9.2 集保
  --2.9.2.1 將有輸入集保-台幣/MMA相關資料寫入配息帳號資料檔
  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         'N' ONSHORE, --境內基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         --LTRIM(A.TDCC_CURRENCY_NO) AS CURRENCY_NO,
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) CURRENCY_NO, --幣別
         -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '04' AMC_NO --基金經理公司(瑞萬通博(TDCC))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '3' --帳號型態；3:集保台幣；
     AND BANKLIST.AMC_NO = '04'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶

  --dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  集保-外幣 AMC_NO = FAS.AMC.AMC_NO');
  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK BEGIN  集保-外幣 AMC_NO = 04');

  --2.9.2.2 將有輸入集保-外幣相關資料寫入扣款帳號資料檔
  INSERT INTO FAS.HOLDER_DIVIDEND_BANK
        (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
  SELECT A.ID,
         LTRIM(BANKLIST.BANK_NO) AS BANK_NO, --往來銀行
         LTRIM(BANKLIST.BRANCH_NO) AS BRANCH_NO, --往來分行
         LTRIM(BANKLIST.AC_CODE) AS AC_CODE, --往來帳號
         TRIM(A.NAME) AS AC_NAME, --帳號名稱
         B.SNAME AS FIS_SNAME, --往來銀行簡稱
         -- 2018.11.28 JIANXIN MOD BY 若是集保外幣，收益分配帳戶需新增至各基金公司
         -- 2019.11.31 tingting 調整若有集保外幣，收益分配帳戶只新增'04'基金公司
         --CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'Y' ELSE 'N' END ONSHORE, --境內基金適用(Y,N)
         'N' ONSHORE, --境內基金適用(Y,N)
         --CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'N' ELSE 'Y' END OFFSHORE, --境外基金適用(Y,N)
         'Y' OFFSHORE, --境外基金適用(Y,N)
         -- 2021.07.23 Chengyu 調整買回帳號、扣款帳號、分配帳號寫入語法
         LTRIM(BANKLIST.CURRENCY_NO) AS CURRENCY_NO, --幣別
          -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
         TRIM(A.LAST_NAME) ||' ' || TRIM(A.FIRST_NAME)||' '||TRIM(A.MIDDLE_NAME) AS ENAME, --英文戶名
         '04' AMC_NO --基金經理公司(瑞萬通博(TDCC))
    FROM ECS.ECSB007_IDList Z
    JOIN ECS.HOLDER A ON A.ID = Z.ID
    JOIN ECS.ECSB007_BANKLIST BANKLIST
      ON BANKLIST.ID = Z.ID
     AND BANKLIST.TYPE = 'D'  --新增型態；A:FAS.HOLDE_BANK_EC
     AND BANKLIST.ACCOUNT_TYPE = '4' --帳號型態；4:集保外幣；
     AND BANKLIST.AMC_NO = '04'
    -- 2018.11.28 JIANXIN MOD BY 調整至分行簡稱
    -- 2021.08.10 Chengyu 調整買回帳號、分配帳號寫入邏輯
    LEFT JOIN FAS.FIS_BRANCH B
      ON B.BANK_NO = LTRIM(BANKLIST.BANK_NO)
     AND B.BRANCH_NO = LTRIM(BANKLIST.BRANCH_NO)
   WHERE Z.IS_ES_ACCOUNT = 'N'; --新戶;

   -- 2020.10.13 Chengyu 如為新戶且有推薦人，新增優惠眷至新戶與推薦人 BEGIN
   FOR NEW_REC IN
     (SELECT  A.ID         AS NEW_ID
             ,A.NAME       AS NEW_NAME
             ,A.MOBILE     AS NEW_MOBILE
             ,B.NEW_COUPON AS NEW_COUPON
             ,C.VALID_FROM AS NEW_VALID_FROM
             ,C.VALID_THRU AS NEW_VALID_THRU
             ,C.TX_TYPE    AS NEW_TX_TYPE
             ,A.EMAIL      AS NEW_EMAIL
             ,D.ID         AS OLD_ID
             ,D.NAME       AS OLD_NAME
             ,D.MOBILE     AS OLD_MOBILE
             ,B.OLD_COUPON AS OLD_COUPON
             ,E.VALID_FROM AS OLD_VALID_FROM
             ,E.VALID_THRU AS OLD_VALID_THRU
             ,E.TX_TYPE    AS OLD_TX_TYPE
             ,D.EMAIL      AS OLD_EMAIL
        FROM ECS.ECSB007_IDList Z
        JOIN ECS.HOLDER A ON A.ID = Z.ID
        LEFT JOIN (SELECT  CASE WHEN XSYS_DATE BETWEEN SPEC_DATE_FROM AND SPEC_DATE_TO THEN REFEREE_COUPON_SPEC
                                ELSE REFEREE_COUPON END AS NEW_COUPON
                          ,CASE WHEN XSYS_DATE BETWEEN SPEC_DATE_FROM AND SPEC_DATE_TO THEN SPONSOR_COUPON_SPEC
                                ELSE SPONSOR_COUPON END AS OLD_COUPON
                     FROM ECS.OPENACC_DEF_COUPON
                    WHERE ROWNUM = 1) B
          ON 1 = 1
        LEFT JOIN ECS.COUPON_PROGRAM C
          ON C.PROGRAM_NO = B.NEW_COUPON
        LEFT JOIN FAS.HOLDER D
          ON D.ACCOUNT_NO = A.SPONSOR_ID
        LEFT JOIN ECS.COUPON_PROGRAM E
          ON E.PROGRAM_NO = B.OLD_COUPON
       WHERE Z.IS_ES_ACCOUNT = 'N' --新戶
         -- 2021.03.16 by Chengyu 1.修正推薦人優惠券新增語法;2.修正呼叫ECS.s_GetSrNo3錯誤
         AND D.ID IS NOT NULL) LOOP

     -- 2021.07.12 Chengyu 調整優惠券代碼取法
     XCOUPON_ID_CUS := ECS.F_GET_COUPON_ID(XCOUPON_ID_STR);
     XCOUPON_ID_SPONSOR := ECS.F_GET_COUPON_ID(XCOUPON_ID_STR);

     XCOUPON_ID_STR := XCOUPON_ID_STR || CASE WHEN TRIM(XCOUPON_ID_STR) IS NOT NULL THEN ','
                                              ELSE '' END || XCOUPON_ID_CUS || ',' || XCOUPON_ID_SPONSOR;

     --3.3.2.  新戶的優惠券資料，新增至【優惠券配發資料(ECS.COUPON_DATA)】檔
     INSERT INTO ECS.COUPON_DATA
            (
              COUPON_ID
             ,ID
             ,ISSUE_DATE
             ,PROGRAM_NO
             ,VALID_FROM
             ,VALID_THRU
             ,TX_TYPE
             ,NAME
             ,MOBILE
             ,EMAIL
             ,IS_EMAIL
             ,IS_EFFECT
             ,USED_DATE
             ,USE_TYPE
             ,SOURCE_CD
             ,DATAID
             ,STATUS
             ,CREATEID
             ,CREATEDATE
             ,ENTRYID
             ,ENTRYDATE
             ,UPDATEID
             ,UPDATEDATE
             ,VERIFYID
             ,VERIFYDATE
             ,APPROVEID
             ,APPROVEDATE
             ,REJECTID
             ,REJECTDATE
            )
             -- 2021.07.12 Chengyu 調整優惠券代碼取法
     SELECT  XCOUPON_ID_CUS AS COUPON_ID
            ,NEW_REC.NEW_ID AS ID
            ,XSYS_DATE AS ISSUE_DATE
            ,NEW_REC.NEW_COUPON AS PROGRAM_NO
            ,NEW_REC.NEW_VALID_FROM AS VALID_FROM
            ,NEW_REC.NEW_VALID_THRU AS VALID_THRU
            ,NEW_REC.NEW_TX_TYPE AS TX_TYPE
            ,NEW_REC.NEW_NAME AS NAME
            ,NEW_REC.NEW_MOBILE AS MOBILE
            ,NEW_REC.NEW_EMAIL AS EMAIL
            ,'N' AS IS_EMAIL
            ,'Y' AS IS_EFFECT
            ,TO_DATE('1900/01/01','YYYY/MM/DD') AS USED_DATE
            ,' ' AS USE_TYPE
            ,'C' AS SOURCE_CD
            ,SYS_GUID() AS DATAID
            ,'301' AS STATUS
            ,'ECS' AS CREATEID
            ,XSYS_DATE AS CREATEDATE
            ,'ECS' AS ENTRYID
            ,XSYS_DATE AS ENTRYDATE
            ,'ECS' AS UPDATEID
            ,XSYS_DATE AS UPDATEDATE
            ,'ECS' AS VERIFYID
            ,XSYS_DATE AS VERIFYDATE
            ,'ECS' AS APPROVEID
            ,XSYS_DATE AS APPROVEDATE
            ,' ' AS REJECTID
            ,TO_DATE('1900/01/01','YYYY/MM/DD') AS REJECTDATE
       FROM DUAL;

     --3.3.3.  推薦人的優惠券資料，新增至【優惠券配發資料(ECS.COUPON_DATA)】檔
     INSERT INTO ECS.COUPON_DATA
            (
              COUPON_ID
             ,ID
             ,ISSUE_DATE
             ,PROGRAM_NO
             ,VALID_FROM
             ,VALID_THRU
             ,TX_TYPE
             ,NAME
             ,MOBILE
             ,EMAIL
             ,IS_EMAIL
             ,IS_EFFECT
             ,USED_DATE
             ,USE_TYPE
             ,SOURCE_CD
             ,DATAID
             ,STATUS
             ,CREATEID
             ,CREATEDATE
             ,ENTRYID
             ,ENTRYDATE
             ,UPDATEID
             ,UPDATEDATE
             ,VERIFYID
             ,VERIFYDATE
             ,APPROVEID
             ,APPROVEDATE
             ,REJECTID
             ,REJECTDATE
            )
             -- 2021.07.12 Chengyu 調整優惠券代碼取法
     SELECT  XCOUPON_ID_SPONSOR AS COUPON_ID
            ,NEW_REC.OLD_ID AS ID
            ,XSYS_DATE AS ISSUE_DATE
            ,NEW_REC.OLD_COUPON AS PROGRAM_NO
            ,NEW_REC.OLD_VALID_FROM AS VALID_FROM
            ,NEW_REC.OLD_VALID_THRU AS VALID_THRU
            ,NEW_REC.OLD_TX_TYPE AS TX_TYPE
            ,NEW_REC.OLD_NAME AS NAME
            ,NEW_REC.OLD_MOBILE AS MOBILE
            ,NEW_REC.OLD_EMAIL AS EMAIL
            ,'N' AS IS_EMAIL
            ,'Y' AS IS_EFFECT
            ,TO_DATE('1900/01/01','YYYY/MM/DD') AS USED_DATE
            ,' ' AS USE_TYPE
            ,'C' AS SOURCE_CD
            ,SYS_GUID() AS DATAID
            ,'301' AS STATUS
            ,'ECS' AS CREATEID
            ,XSYS_DATE AS CREATEDATE
            ,'ECS' AS ENTRYID
            ,XSYS_DATE AS ENTRYDATE
            ,'ECS' AS UPDATEID
            ,XSYS_DATE AS UPDATEDATE
            ,'ECS' AS VERIFYID
            ,XSYS_DATE AS VERIFYDATE
            ,'ECS' AS APPROVEID
            ,XSYS_DATE AS APPROVEDATE
            ,' ' AS REJECTID
            ,TO_DATE('1900/01/01','YYYY/MM/DD') AS REJECTDATE
       FROM DUAL;

   END LOOP;

   -- 2020.10.13 Chengyu 如為新戶且有推薦人，新增優惠眷至新戶與推薦人 END

-------------------------------------------------------------------------------------------------------------------------

  dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_BANK END');
  dbms_output.put_line('處理新戶 END');
  dbms_output.put_line(' ');
  dbms_output.put_line('處理舊戶 BEGIN');

  --3.處理舊戶
  FOR OLD_REC IN
  -- 2018.12.14 JIANXIN MOD BY 調整舊戶加開內容
      (SELECT  A.ID
              ,TRIM(A.OPEN_TYPE) AS OPEN_TYPE
              ,TRIM(A.IS_ES_ACCOUNT) AS IS_ES_ACCOUNT
              ,A.ACCOUNT_NO
              ,TRIM(A.TDCC_ACCT_NO) AS TDCC_ACCT_NO
              ,TRIM(A.NAME) AS NAME
              ,TRIM(A.FIRST_NAME) AS FIRST_NAME
              ,TRIM(A.MIDDLE_NAME) AS MIDDLE_NAME
              ,TRIM(A.LAST_NAME) AS LAST_NAME
              ,A.BIRTH_DATE
              ,TRIM(A.NATIONALITY) AS NATIONALITY
              ,TRIM(A.BIRTH_COUNTRY) AS BIRTH_COUNTRY
              ,TRIM(A.TEL_H_COUNTRY) AS TEL_H_COUNTRY
              ,TRIM(A.TEL_H_AREA) AS TEL_H_AREA
              ,TRIM(A.TEL_H_NO) AS TEL_H_NO
              ,TRIM(A.TEL_H_EXT) AS TEL_H_EXT
              ,TRIM(A.TEL_O_COUNTRY) AS TEL_O_COUNTRY
              ,TRIM(A.TEL_O_AREA) AS TEL_O_AREA
              ,TRIM(A.TEL_O_NO) AS TEL_O_NO
              ,TRIM(A.TEL_O_EXT) AS TEL_O_EXT
              ,TRIM(A.MOBILE_COUNTRY) AS MOBILE_COUNTRY
              ,TRIM(A.MOBILE) AS MOBILE
              ,TRIM(A.FAX_COUNTRY) AS FAX_COUNTRY
              ,TRIM(A.FAX_AREA) AS FAX_AREA
              ,TRIM(A.FAX_NO) AS FAX_NO
              ,TRIM(A.FAX_EXT) AS FAX_EXT
              ,TRIM(A.EMAIL) AS EMAIL
              ,TRIM(A.CONTACT_ADDRESS_COUNTRY) AS CONTACT_ADDRESS_COUNTRY
              ,TRIM(A.POST_CODE) AS POST_CODE
              ,TRIM(A.CONTACT_ADDRESS) AS CONTACT_ADDRESS
              ,TRIM(A.REG_ADDRESS_COUNTRY) AS REG_ADDRESS_COUNTRY
              ,TRIM(A.REG_POST_CODE) AS REG_POST_CODE
              ,TRIM(A.REG_ADDRESS) AS REG_ADDRESS
              ,TRIM(A.REP_NATIONALITY_CODE) AS REP_NATIONALITY_CODE
              ,TRIM(A.REPRESENTATIVE) AS REPRESENTATIVE
              ,LTRIM(A.REPRESENTATIVE_ID) AS REPRESENTATIVE_ID
              ,TRIM(A.REP_BIRTH_DATE) AS REP_BIRTH_DATE
              ,TRIM(A.REP_ADDRESS) AS REP_ADDRESS
              ,TRIM(A.REP_NATIONALITY_CODE1) AS REP_NATIONALITY_CODE1
              ,TRIM(A.REPRESENTATIVE1) AS REPRESENTATIVE1
              ,LTRIM(A.REPRESENTATIVE1_ID) AS REPRESENTATIVE1_ID
              ,A.REP_BIRTH_DATE1
              ,TRIM(A.REP_ADDRESS1) AS REP_ADDRESS1
              ,TRIM(A.EDM_ACCEPTED) AS EDM_ACCEPTED
              ,TRIM(A.NAV_EPAPER) AS NAV_EPAPER
              ,TRIM(A.US_TAX) AS US_TAX
              ,TRIM(A.FATCA_TYPE) AS FATCA_TYPE
              ,LTRIM(A.TAX_COUNTRY1) AS TAX_COUNTRY1
              ,TRIM(A.TAX_NUM1) AS TAX_NUM1
              ,TRIM(A.TAXNOREASON1) AS TAXNOREASON1
              -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
              ,TRIM(A.TAXATION_REMARK1) AS TAXATION_REMARK1
              ,LTRIM(A.TAX_COUNTRY2) AS TAX_COUNTRY2
              ,TRIM(A.TAX_NUM2) AS TAX_NUM2
              ,TRIM(A.TAXNOREASON2) AS TAXNOREASON2
              -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
              ,TRIM(A.TAXATION_REMARK2) AS TAXATION_REMARK2
              ,LTRIM(A.TAX_COUNTRY3) AS TAX_COUNTRY3
              ,TRIM(A.TAX_NUM3) AS TAX_NUM3
              ,TRIM(A.TAXNOREASON3) AS TAXNOREASON3
              -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
              ,TRIM(A.TAXATION_REMARK3) AS TAXATION_REMARK3
              ,LTRIM(A.FIS_CURRENCY_NO_TWD) AS FIS_CURRENCY_NO_TWD
              ,LTRIM(A.FIS_BANK_NO_TWD) AS FIS_BANK_NO_TWD
              ,LTRIM(A.FIS_BRANCH_NO_TWD) AS FIS_BRANCH_NO_TWD
              ,LTRIM(A.FIS_AC_CODE_TWD) AS FIS_AC_CODE_TWD
              ,A.FIS_SEAL_DATE_TWD
              -- 2019.06.10 JIANXIN 調整財金-外幣帳戶的判斷
              --,CASE WHEN NVL(A.FIS_BANK_NO_TWD_FCY,' ') <> ' ' THEN LTRIM(A.FIS_CURRENCY_NO_FCY) ELSE LTRIM(A.TDCC_CURRENCY_NO_FCY) END AS FIS_CURRENCY_NO_FCY
              --,CASE WHEN NVL(A.FIS_BANK_NO_TWD_FCY,' ') <> ' ' THEN LTRIM(A.FIS_BANK_NO_TWD_FCY) ELSE LTRIM(A.TDCC_BANK_NO_TWD_FCY) END AS FIS_BANK_NO_TWD_FCY
              --,CASE WHEN NVL(A.FIS_BANK_NO_TWD_FCY,' ') <> ' ' THEN LTRIM(A.FIS_BRANCH_NO_TWD_FCY) ELSE LTRIM(A.TDCC_BRANCH_NO_TWD_FCY) END AS FIS_BRANCH_NO_TWD_FCY
              --,CASE WHEN NVL(A.FIS_BANK_NO_TWD_FCY,' ') <> ' ' THEN LTRIM(A.FIS_AC_CODE_TWD_FCY) ELSE LTRIM(A.TDCC_AC_CODE_TWD_FCY) END AS FIS_AC_CODE_TWD_FCY
              --,CASE WHEN NVL(A.FIS_BANK_NO_TWD_FCY,' ') <> ' ' THEN LTRIM(A.FIS_SEAL_DATE_FCY) ELSE LTRIM(A.TDCC_SEAL_DATE_FCY) END AS FIS_SEAL_DATE_FCY
              ,LTRIM(A.FIS_CURRENCY_NO_FCY) AS FIS_CURRENCY_NO_FCY
              ,LTRIM(A.FIS_BANK_NO_TWD_FCY) AS FIS_BANK_NO_TWD_FCY
              ,LTRIM(A.FIS_BRANCH_NO_TWD_FCY) AS FIS_BRANCH_NO_TWD_FCY
              ,LTRIM(A.FIS_AC_CODE_TWD_FCY) AS FIS_AC_CODE_TWD_FCY
              ,A.FIS_SEAL_DATE_FCY
              ,LTRIM(A.TDCC_CURRENCY_NO) AS TDCC_CURRENCY_NO
              ,LTRIM(A.TDCC_BANK_NO) AS TDCC_BANK_NO
              ,LTRIM(A.TDCC_BRANCH_NO) AS TDCC_BRANCH_NO
              ,LTRIM(A.TDCC_AC_CODE) AS TDCC_AC_CODE
              ,A.TDCC_SEAL_DATE
              ,LTRIM(A.TDCC_CURRENCY_NO_FCY) AS TDCC_CURRENCY_NO_FCY
              ,LTRIM(A.TDCC_BANK_NO_TWD_FCY) AS TDCC_BANK_NO_TWD_FCY
              ,LTRIM(A.TDCC_BRANCH_NO_TWD_FCY) AS TDCC_BRANCH_NO_TWD_FCY
              ,LTRIM(A.TDCC_AC_CODE_TWD_FCY) AS TDCC_AC_CODE_TWD_FCY
              ,A.TDCC_SEAL_DATE_FCY
              ,TRIM(A.MARRIED) AS MARRIED
              ,TRIM(A.MARRIED_OTHER) AS MARRIED_OTHER
              ,TRIM(A.MS_NUM_CODE) AS MS_NUM_CODE
              ,A.MS_NUM
              ,TRIM(A.GENDAR) AS GENDAR
              ,TRIM(A.DOC_CODE) AS DOC_CODE
              ,A.DOC_APPLY_DT
              ,A.DOC_PRINT_DT
              ,TRIM(A.DOC_PRINT_UID) AS DOC_PRINT_UID
              ,TRIM(A.ON_REWARD_PROGRAM) AS ON_REWARD_PROGRAM
              ,TRIM(A.OFF_REWARD_PROGRAM) AS OFF_REWARD_PROGRAM
              ,A.SPONSOR_ID
              ,A.APPLY_DTTM
              ,A.IP_A
              ,A.IP_B
              ,A.IP_C
              ,A.IP_D
              ,TRIM(A.CS_CHECK_STATUS) AS CS_CHECK_STATUS
              ,TRIM(A.CS_CFM_UID) AS CS_CFM_UID
              ,A.CS_CFM_DATE
              ,TRIM(A.CS_CFM_APP_UID) AS CS_CFM_APP_UID
              ,A.CS_CFM_APP_DATE
              ,TRIM(A.OP_IS_REJECT) AS OP_IS_REJECT
              ,TRIM(A.OP_CFM_UID) AS OP_CFM_UID
              ,A.OP_CFM_DATE
              ,TRIM(A.OP_CFM_APP_UID) AS OP_CFM_APP_UID
              ,A.OP_CFM_APP_DATE
              ,TRIM(A.OP_CFM_REMARK) AS OP_CFM_REMARK
              ,TRIM(A.REJECT_REASON) AS REJECT_REASON
              ,TRIM(A.PROCESS_CODE) AS PROCESS_CODE
              ,TRIM(A.RECEIPT_DOC_EMAIL) AS RECEIPT_DOC_EMAIL
              ,A.DATAID
              ,A.STATUS
              ,A.CREATEID
              ,A.CREATEDATE
              ,A.ENTRYID
              ,A.ENTRYDATE
              ,A.UPDATEID
              ,A.UPDATEDATE
              ,A.VERIFYID
              ,A.VERIFYDATE
              ,A.APPROVEID
              ,A.APPROVEDATE
              ,A.REJECTID
              ,A.REJECTDATE
              ,A.DATAFLAG
              ,A.RECEIPT_DOC_OPEN
              -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
              --居住地
              ,TRIM(A.CURRENT_ADDRESS) AS CURRENT_ADDRESS
              ,TRIM(A.CURRENT_ADDRESS_COUNTRY) AS CURRENT_ADDRESS_COUNTRY
              ,TRIM(A.CURRENT_POST_CODE) CURRENT_POST_CODE
              ,CASE WHEN TRIM(A.CURRENT_ADDRESS) = TRIM(A.CONTACT_ADDRESS) THEN 'Y' ELSE 'N' END CRS_ADDRESS_EQUAL
              -- =================KYC 題目=========================
              -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
              ,TRIM(A.EMPLOYER) AS EMPLOYER                                                    -- 服務單位名稱 
              ,TRIM(A.MARRIED) AS CUST_FAMILY_STATUS                                           -- 家庭狀況1:單身 2:已婚 3:其他
              ,TRIM(A.MARRIED_OTHER) AS CUST_FAMILY_STATUS_TXT                                 -- 家庭狀況_其他(說明)
              -- 2022.11.29 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
              ,CASE WHEN TRIM(A.MS_NUM_CODE) = 'N' THEN '1' ELSE '2' END AS CUST_CHILD_STATUS  -- 家庭狀況1:無(小孩) 2:有(小孩)
              ,TRIM(A.MS_NUM) AS CUST_CHILD_STATUS_TXT                                         -- 家庭狀況_小孩人數 
              ,TRIM(A.PROFESSION) AS PROFESSION                                                -- 職業別(KYC)
              ,TRIM(A.PROFESSION_OTHERS_NEW) AS PROFESSION_OTHERS_NEW                          -- 職業別_其他(KYC)
              ,TRIM(A.POSITION) AS POSITION                                                    -- 職務(KYC)
              ,TRIM(A.POSITION_OTHERS) AS POSITION_OTHERS                                      -- 職務_其他(KYC)
              ,TRIM(A.INV_ORI) AS INV_ORI                 　　                                 -- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
              ,TRIM(A.INV_ORI_OTHER) AS INV_ORI_OTHER                                          -- 投資資金來源_其他(說明)
              ,TRIM(A.INV_KNOWLEDGE) AS INV_KNOWLEDGE                                          -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
              ,TRIM(A.INV_KNOWLEDGE_OTHER) AS INV_KNOWLEDGE_OTHER                              -- 投資理財資訊來源(可複選)其他(說明)
              ,TRIM(A.INVEST_CODE) AS CUST_INV_ESTAMT                                          -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
              ,TRIM(A.CUST_RESIDENCE_STATUS) AS CUST_RESIDENCE_STATUS                          -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
              ,TRIM(A.CUST_RESIDENCE_STATUS_TXT) AS CUST_RESIDENCE_STATUS_TXT                  -- 目前居住及照護狀態(說明)
              ,TRIM(A.CUST_MIND_STATUS) AS CUST_MIND_STATUS                　　                -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
              ,TRIM(A.MAJOR_ILLNESS) AS MAJOR_ILLNESS                                          -- 重大傷病證明 Y:有 N:無 D:無勾選

              ,TRIM(A.BF_AGE_CODE) AS BF_AGE_CODE                                              -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
              ,TRIM(A.EDUCATION) AS EDUCATION                                                  -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
              ,TRIM(A.INV_TOOL) AS CUST_RISK_INVTOOL                                           -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
              ,TRIM(A.INV_EXPERIENCE) AS CUST_RISK_INVEXP                                      -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
              ,TRIM(A.INV_GOAL) AS CUST_RISK_INVPURPOSE                                        -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
              ,TRIM(A.FAMILY_INCOME) AS FAMILY_INCOME                                          -- 個人或家庭平均年收入
              ,TRIM(A.INV_FAIL_METHOD) AS CUST_RISK_INVPROFIT                                  -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
              ,TRIM(A.SIGNIFICANT_NEEDS) AS CUST_RISK_FUNDING                                  -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
              ,TRIM(A.LIQUIDITY_NEEDS) AS CUST_RISK_FLUIDITY                                   -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
              ,TRIM(A.PRICE_VOLATILITY) AS CUST_RISK_PRICEVOL                                  -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

              -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
              ,TRIM(A.VULNERABLE_CLAIM) AS VULNERABLE_CLAIM                                    -- 自主申購聲明\1：空值；2：同意；3：不同意
              ,TRIM(A.RISK_LEVEL) AS RISK_LEVEL                                                -- 新客戶風險屬性 1:保守 2:穩健 3:積極
              ,TRIM(A.KYC_SCROE) AS KYC_SCROE                                                  -- KYC 分數
         FROM ECS.ECSB007_IDList Z
         JOIN ECS.HOLDER A ON A.ID = Z.ID
        WHERE Z.IS_ES_ACCOUNT = 'Y' --舊戶
      ) LOOP

      dbms_output.put_line('FOR OLD_REC IN LOOP BEGIN');
      dbms_output.put_line('OLD_REC.ID：' || OLD_REC.ID);

      --判斷是否有加開瑞萬通博(若XCOUNT_AMC04=0,表示有加開瑞萬通博)
      SELECT COUNT(*) INTO XCOUNT_AMC04
        FROM FAS.HOLDER_AMC
       WHERE ID = OLD_REC.ID
         AND AMC_NO = '04';

      dbms_output.put_line('XCOUNT_AMC04：' || XCOUNT_AMC04 || '   判斷是否有加開瑞萬通博(若XCOUNT_AMC04=0,表示有加開瑞萬通博)');

      --判斷是否為實體戶升級 EC 戶
      SELECT COUNT(*) INTO XIS_TO_EC
        FROM FAS.HOLDER
       WHERE ID = OLD_REC.ID
         AND ECS_STATUS = '0';

      dbms_output.put_line('XIS_TO_EC：' || XIS_TO_EC || '   判斷是否為實體戶升級 EC 戶(若不為0表示實體戶升級 EC 戶)');

      --取得交易序號,原則如下:
      --(a)至【受益人變更序號檔(FAS.SN_HOLDER_CHANGE)】取得 AP_CODE = ECS 的流水號
      --(b)採年編，每年流水號從 1號重新編立
      --(c)取得的流水號(SN) + 1 後，以0補碼至６位數．如取得 37 ，先加１為 38 後，回傳 000038
      --(d)+1後的流水號，再更新回【受益人變更序號檔(FAS.SN_HOLDER_CHANGE)】
      BEGIN
        SELECT SN INTO XSN
          FROM FAS.SN_HOLDER_CHANGE
         WHERE AP_CODE = 'ECS'
           AND YEAR = to_char(XSYS_DATE,'YYYY') FOR UPDATE;
        XSN := XSN + 1;
        UPDATE FAS.SN_HOLDER_CHANGE
           SET SN = XSN
         WHERE AP_CODE = 'ECS'
           AND YEAR = to_char(XSYS_DATE,'YYYY');
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XSN := 1;
          INSERT INTO FAS.SN_HOLDER_CHANGE (AP_CODE,YEAR,SN)
             VALUES ('ECS',to_char(XSYS_DATE,'YYYY'),1);
      END;

      dbms_output.put_line('XSN：' || XSN || '   取得交易序號');

      dbms_output.put_line('INSERT INTO FAS.HOLDER_CHANGE BEGIN');

      --3.1 將舊戶變更已審核完成的資料及變更前的資料寫入受益人變更資料(FAS.HOLDER_CHANGE)
      INSERT INTO FAS.HOLDER_CHANGE
            (ID,TX_TYPE,
             --基本資料
             NAME,NEW_NAME,FIRST_NAME,NEW_FIRST_NAME,MIDDLE_NAME,NEW_MIDDLE_NAME,LAST_NAME,NEW_LAST_NAME,
             NATIONALITY,NEW_NATIONALITY,BIRTH_COUNTRY,NEW_BIRTH_COUNTRY,
             TEL_H_COUNTRY,NEW_TEL_H_COUNTRY,TEL_H_AREA,NEW_TEL_H_AREA,TEL_H_NO,NEW_TEL_H_NO,TEL_H_EXT,NEW_TEL_H_EXT,TEL_H_VALID,NEW_TEL_H_VALID,TEL_H,NEW_TEL_H,
             TEL_O_COUNTRY,NEW_TEL_O_COUNTRY,TEL_O_AREA,NEW_TEL_O_AREA,TEL_O_NO,NEW_TEL_O_NO,TEL_O_EXT,NEW_TEL_O_EXT,TEL_O_VALID,NEW_TEL_O_VALID,TEL_O,NEW_TEL_O,
             MOBILE_COUNTRY,NEW_MOBILE_COUNTRY,MOBILE,NEW_MOBILE,MOBILE_VALID,NEW_MOBILE_VALID,
             FAX_COUNTRY,NEW_FAX_COUNTRY,FAX_AREA,NEW_FAX_AREA,FAX_NO,NEW_FAX_NO,FAX_EXT,NEW_FAX_EXT,FAX_VALID,NEW_FAX_VALID,FAX,NEW_FAX,
             EMAIL,NEW_EMAIL,EMAIL_VALID,NEW_EMAIL_VALID,
             CONTACT_ADDRESS_COUNTRY,NEW_CONTACT_ADDRESS_COUNTRY,POST_CODE,NEW_POST_CODE,CONTACT_ADDRESS,NEW_CONTACT_ADDRESS,CONTACT_ADDRESS_VALID,NEW_CONTACT_ADDRESS_VALID,
             REG_ADDRESS_COUNTRY,NEW_REG_ADDRESS_COUNTRY,REG_POST_CODE,NEW_REG_POST_CODE,REG_ADDRESS,NEW_REG_ADDRESS,
             --法代
             REPRESENTATIVE,NEW_REPRESENTATIVE,REPRESENTATIVE_ID,NEW_REPRESENTATIVE_ID,REPRESENTATIVE1,NEW_REPRESENTATIVE1,REPRESENTATIVE1_ID,NEW_REPRESENTATIVE1_ID,
             --交易限制
             FAX_AGREEMENT,NEW_FAX_AGREEMENT,ROBO_AGREEMENT,NEW_ROBO_AGREEMENT,ROBO_DATE,NEW_ROBO_DATE,
             -- 2018.12.27 JIANXIN MOD BY 若舊戶加開EC業務員寫入原本的業務員內容
             --業績
             EC_SALES_NO,NEW_EC_SALES_NO,
             --FATCA
             US_TAX,NEW_US_TAX,FATCA_TYPE,NEW_FATCA_TYPE,
             --通知書
             CONFIRMATION_NOTICE,NEW_CONFIRMATION_NOTICE,DAILY_STATEMENT,NEW_DAILY_STATEMENT,MONTHLY_STATEMENT,NEW_MONTHLY_STATEMENT,
             SEMIANNUAL_STATEMENT,NEW_SEMIANNUAL_STATEMENT,CS_MAIL,NEW_CS_MAIL,CS_FAX,NEW_CS_FAX,CS_EMAIL,NEW_CS_EMAIL,
             --文宣
             VIP_ML_TYPE,NEW_VIP_ML_TYPE,EDM_ACCEPTED,NEW_EDM_ACCEPTED,DM_ACCEPTED,NEW_DM_ACCEPTED,ML_TYPE,NEW_ML_TYPE,GROUP_DM,NEW_GROUP_DM,
             -- 2018.11.28 JIANXIN MOD BY 新增個資同意書
             PERSONAL_INFO_AGREEMENT,NEW_PERSONAL_INFO_AGREEMENT,
             --輸入註記
             CREATED_BY,CREATION_DATE,REVISED_BY,REVISION_DATE,REVIEWED_BY,REVIEW_DATE,EMP_NO,LAST_MODIFIED,
             --其他
             APPLY_TYPE,SER_NO,STAMP_CHANGE,FAX_CHANGE,IS_POSTED,SEND_TYPE,SEND_MOBILE,
             -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
             --居住地
             CURRENT_ADDRESS,NEW_CURRENT_ADDRESS,CURRENT_ADDRESS_COUNTRY,NEW_CURRENT_ADDRESS_COUNTRY,CURRENT_POST_CODE,NEW_CURRENT_POST_CODE,CRS_ADDRESS_EQUAL,NEW_CRS_ADDRESS_EQUAL
             -- =================KYC 題目異動=========================
             -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
             ,EMPLOYER                            -- 服務單位名稱
             ,NEW_EMPLOYER                        -- (新)服務單位名稱
             ,CUST_FAMILY_STATUS                  -- 家庭狀況1:單身 2:已婚 3:其他
             ,NEW_CUST_FAMILY_STATUS              -- (新)家庭狀況1:單身 2:已婚 3:其他
             ,CUST_FAMILY_STATUS_TXT              -- 家庭狀況_其他(說明)
             ,NEW_CUST_FAMILY_STATUS_TXT          -- (新)家庭狀況_其他(說明)
             ,CUST_CHILD_STATUS                   -- 家庭狀況1:無(小孩) 2:有(小孩)
             ,NEW_CUST_CHILD_STATUS               -- (新)家庭狀況1:無(小孩) 2:有(小孩)
             ,CUST_CHILD_STATUS_TXT               -- 家庭狀況_小孩人數
             ,NEW_CUST_CHILD_STATUS_TXT           -- (新)家庭狀況_小孩人數
             ,PROFESSION                          -- 職業別(KYC) 目前分類，請參閱FAS.PROFESSION
             ,NEW_PROFESSION                      -- (新)職業別(KYC)
             ,PROFESSION_OTHERS_NEW               -- 職業別_其他_新(KYC)
             ,NEW_PROFESSION_OTHERS_NEW           -- (新)職業別_其他_新(KYC)
             ,POSITION                            -- 職務(KYC) 01:企業負責人 02:中/高階主管 03:基層主管 04:專業人員 05:一般職員 06:業務 07:其他
             ,NEW_POSITION                        -- (新)職務(KYC)
             ,POSITION_OTHERS                     -- 職務_其他(KYC)
             ,NEW_POSITION_OTHERS                 -- (新)職務_其他(KYC)
             ,CUST_INV_FUNDS_1                　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,NEW_CUST_INV_FUNDS_1                -- 新投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_2                　　-- 投資資金來源(複選)(退休金/保險年金)
             ,NEW_CUST_INV_FUNDS_2                -- 新投資資金來源(複選)(退休金/保險年金)
             ,CUST_INV_FUNDS_3                　　-- 投資資金來源(複選)(租賃所得)
             ,NEW_CUST_INV_FUNDS_3                -- 新投資資金來源(複選)(租賃所得)
             ,CUST_INV_FUNDS_4                　　-- 投資資金來源(複選)(遺產餽贈)
             ,NEW_CUST_INV_FUNDS_4                -- 新投資資金來源(複選)(遺產餽贈)
             ,CUST_INV_FUNDS_5                　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
             ,NEW_CUST_INV_FUNDS_5                -- 新投資資金來源(複選)(投資所得(資本所得、利息收入))
             ,CUST_INV_FUNDS_6                　　-- 投資資金來源(複選)(閒置資金)
             ,NEW_CUST_INV_FUNDS_6                -- 新投資資金來源(複選)(閒置資金)
             ,CUST_INV_FUNDS_7                　　-- 投資資金來源(複選)(其他)
             ,NEW_CUST_INV_FUNDS_7                -- 新投資資金來源(複選)(其他)
             ,CUST_INV_FUNDS_7_TXT                -- 投資資金來源_其他(說明)
             ,NEW_CUST_INV_FUNDS_7_TXT            -- 新投資資金來源_其他(說明)
             ,CUST_INV_FINSOURCE_1                -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,NEW_CUST_INV_FINSOURCE_1            -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_2                -- 投資理財資訊來源(可複選)書報雜誌
             ,NEW_CUST_INV_FINSOURCE_2            -- (新)投資理財資訊來源(可複選)書報雜誌
             ,CUST_INV_FINSOURCE_3                -- 投資理財資訊來源(可複選)網際網路
             ,NEW_CUST_INV_FINSOURCE_3            -- (新)投資理財資訊來源(可複選)網際網路
             ,CUST_INV_FINSOURCE_4                -- 投資理財資訊來源(可複選)其他
             ,NEW_CUST_INV_FINSOURCE_4            -- (新)投資理財資訊來源(可複選)其他
             ,CUST_INV_FINSOURCE_4_TXT            -- 投資理財資訊來源(可複選)其他(說明)
             ,NEW_CUST_INV_FINSOURCE_4_TXT        -- (新)投資理財資訊來源(可複選)其他(說明)
             ,CUST_INV_ESTAMT                     -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
             ,NEW_CUST_INV_ESTAMT                 -- (新)預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
             ,CUST_RESIDENCE_STATUS               -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
             ,NEW_CUST_RESIDENCE_STATUS           -- 新目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
             ,CUST_RESIDENCE_STATUS_TXT           -- 目前居住及照護狀態(說明)
             ,NEW_CUST_RESIDENCE_STATUS_TXT       -- 新目前居住及照護狀態(說明)
             ,CUST_MIND_STATUS                　　-- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
             ,NEW_CUST_MIND_STATUS                -- 新目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
             ,MAJOR_ILLNESS                       -- 重大傷病證明 Y:有 N:無 D:無勾選
             ,NEW_MAJOR_ILLNESS                   -- (新)重大傷病證明 Y:有 N:無 D:無勾選

             ,CUST_RISK_AGE                       -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
             ,NEW_CUST_RISK_AGE                   -- (新)客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
             ,EDUCATION                           -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
             ,NEW_EDUCATION                       -- (新)學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
             ,CUST_RISK_INVTOOL                   -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
             ,NEW_CUST_RISK_INVTOOL               -- (新)常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
             ,CUST_RISK_INVEXP                    -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
             ,NEW_CUST_RISK_INVEXP                -- (新)投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
             ,CUST_RISK_INVPURPOSE                -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值
             ,NEW_CUST_RISK_INVPURPOSE            -- (新)最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值           
             ,FAMILY_INCOME                       -- 個人或家庭平均年收入
             ,NEW_FAMILY_INCOME                   -- (新)個人或家庭平均年收入
             ,CUST_RISK_INVPROFIT                 -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
             ,NEW_CUST_RISK_INVPROFIT             -- (新)投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
             ,CUST_RISK_FUNDING                   -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
             ,NEW_CUST_RISK_FUNDING               -- (新)重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
             ,CUST_RISK_FLUIDITY                  -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
             ,NEW_CUST_RISK_FLUIDITY              -- (新)流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
             ,CUST_RISK_PRICEVOL                  -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動
             ,NEW_CUST_RISK_PRICEVOL              -- (新)價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
             ,VULNERABLE_CLAIM                    -- 自主申購聲明\1：空值；2：同意；3：不同意
             ,NEW_VULNERABLE_CLAIM                -- (新)自主申購聲明\1：空值；2：同意；3：不同意
             ,RISK_LEVEL                          -- 客戶風險屬性 1:保守 2:穩健 3:積極
             ,NEW_RISK_LEVEL                      -- (新)客戶風險屬性 1:保守 2:穩健 3:積極
             ,KYC_SCROE                           -- KYC 分數
             ,NEW_KYC_SCROE                       -- (新)KYC 分數

             ,RISK_STATUS                         -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
             ,NEW_RISK_STATUS                     -- (新)適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
             ,RISK_WRITE_DATE                     -- 適合度分析表最後一次填寫日(即轉入FAS.HOLDER的日期)
             ,NEW_RISK_WRITE_DATE                 -- (新)適合度分析表最後一次填寫日(即轉入FAS.HOLDER的日期)
             ,RISK_MAT_DATE                       -- 適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)
             ,NEW_RISK_MAT_DATE                   -- (新)適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)

            )
      SELECT ID,
             'G' TX_TYPE, --異動別
             --基本資料
             NAME,  --戶名
             OLD_REC.NAME NEW_NAME,  --(新)戶名
             FIRST_NAME,  --英文名
             OLD_REC.FIRST_NAME NEW_FIRST_NAME,  --(新)英文名
             MIDDLE_NAME,  --英文中間名
             OLD_REC.MIDDLE_NAME NEW_MIDDLE_NAME,  --(新)英文中間名
             LAST_NAME,  --英文姓氏
             OLD_REC.LAST_NAME NEW_LAST_NAME,  --(新)英文姓氏
             NATIONALITY,  --國籍
             CASE WHEN NATIONALITY IS NULL THEN OLD_REC.NATIONALITY ELSE NATIONALITY END NEW_NATIONALITY,  --(新)國籍
             BIRTH_COUNTRY,  --出生地國碼
             CASE WHEN BIRTH_COUNTRY IS NULL THEN OLD_REC.BIRTH_COUNTRY ELSE BIRTH_COUNTRY END NEW_BIRTH_COUNTRY,  --(新)出生地國碼
             TEL_H_COUNTRY,  --電話(宅)–國碼
             OLD_REC.TEL_H_COUNTRY NEW_TEL_H_COUNTRY,  --(新)電話(宅)–國碼
             TEL_H_AREA,  --電話(宅)–區碼
             OLD_REC.TEL_H_AREA NEW_TEL_H_AREA,  --(新)電話(宅)–區碼
             TEL_H_NO,  --電話(宅)– 話
             OLD_REC.TEL_H_NO NEW_TEL_H_NO,  --(新)電話(宅)–電話
             TEL_H_EXT,  --電話(宅)–分機
             OLD_REC.TEL_H_EXT NEW_TEL_H_EXT,  --(新)電話(宅)–分機
             TEL_H_VALID,  --電話(宅)–有效註記(Y:有效 N:無效)
             'Y' NEW_TEL_H_VALID,  --(新)電話(宅)–有效註記(Y:有效 N:無效)
             TEL_H,  --電話(宅)
             OLD_REC.TEL_H_AREA||'-'||OLD_REC.TEL_H_NO||CASE WHEN OLD_REC.TEL_H_EXT IS NOT NULL THEN '#'||OLD_REC.TEL_H_EXT ELSE NULL END NEW_TEL_H,  --(新)電話(宅)
             TEL_O_COUNTRY,  --電話(公)–國碼
             OLD_REC.TEL_O_COUNTRY NEW_TEL_O_COUNTRY,  --(新)電話(公)–國碼
             TEL_O_AREA,  --電話(公)–區碼
             OLD_REC.TEL_O_AREA NEW_TEL_O_AREA,  --(新)電話(公)–區碼
             TEL_O_NO,  --電話(公)–電話
             OLD_REC.TEL_O_NO NEW_TEL_O_NO,  --(新)電話(公)–電話
             TEL_O_EXT,  --電話(公)–分機
             OLD_REC.TEL_O_EXT NEW_TEL_O_EXT,  --(新)電話(公)–分機
             TEL_O_VALID,  --電話(公)–有效註記(Y:有效 N:無效)
             'Y' NEW_TEL_O_VALI,  --(新)電話(公)–有效註記(Y:有效 N:無效)
             TEL_O,  --電話(公)
             OLD_REC.TEL_O_AREA||'-'||OLD_REC.TEL_O_NO||CASE WHEN OLD_REC.TEL_O_EXT IS NOT NULL THEN '#'||OLD_REC.TEL_O_EXT ELSE NULL END NEW_TEL_O,  --(新)電話(公)
             MOBILE_COUNTRY,  --行動電話 –國碼
             OLD_REC.MOBILE_COUNTRY NEW_MOBILE_COUNTRY,  --(新)行動電話 –國碼
             MOBILE,  --行動電話
             OLD_REC.MOBILE NEW_MOBILE,  --(新)行動電話
             MOBILE_VALID,  --行動電話–有效註記(Y:有效 N:無效)
             'Y' NEW_MOBILE_VALID,  --(新)行動電話–有效註記(Y:有效 N:無效)
             FAX_COUNTRY,  --傳真1–國碼
             OLD_REC.FAX_COUNTRY NEW_FAX_COUNTRY,  --(新)傳真電話–國碼
             FAX_AREA,  --傳真1–區碼
             OLD_REC.FAX_AREA NEW_FAX_AREA,  --(新)傳真1–區碼
             FAX_NO,  --傳真1–電話
             OLD_REC.FAX_NO NEW_FAX_NO,  --(新)傳真1–電話
             FAX_EXT,  --傳真1–分機
             OLD_REC.FAX_EXT NEW_FAX_EXT,  --(新)傳真1–分機
             FAX_VALID,  --傳真 1–有效註記(Y:有效 N:無效)
             'Y' NEW_FAX_VALID,  --(新)傳真1–有效註記(Y:有效 N:無效)
             FAX,  --傳真1
             OLD_REC.FAX_AREA||'-'||OLD_REC.FAX_NO||CASE WHEN OLD_REC.FAX_EXT IS NOT NULL THEN '#'||OLD_REC.FAX_EXT ELSE NULL END NEW_FAX,  --(新)傳真1
             EMAIL,  --EMAIL
             CASE WHEN EMAIL <> OLD_REC.EMAIL THEN OLD_REC.EMAIL ELSE EMAIL END NEW_EMAIL,  --(新)EMAIL
             EMAIL_VALID,  --電子郵件帳號有效註記(Y:有效 N:無效)
             CASE WHEN EMAIL <> OLD_REC.EMAIL THEN 'N' ELSE EMAIL_VALID END NEW_EMAIL_VALID,  --(新)電子郵件帳號有效註記(Y:有效 N:無效)
             CONTACT_ADDRESS_COUNTRY,  --通訊地址國碼
             OLD_REC.CONTACT_ADDRESS_COUNTRY NEW_CONTACT_ADDRESS_COUNTRY,  --(新)通訊地址國碼
             POST_CODE,  --郵遞區號
             OLD_REC.POST_CODE NEW_POST_CODE,  --(新)郵遞區號
             CONTACT_ADDRESS,  --通訊地址
             OLD_REC.CONTACT_ADDRESS  NEW_CONTACT_ADDRESS,  --(新)通訊地址
             CONTACT_ADDRESS_VALID,  --通訊地址檢核
             'Y' NEW_CONTACT_ADDRESS_VALID,  --(新)通訊地址檢核
             REG_ADDRESS_COUNTRY,  --戶籍地址國碼
             OLD_REC.REG_ADDRESS_COUNTRY NEW_REG_ADDRESS_COUNTRY,  --(新)戶籍地址國碼
             REG_POST_CODE,  --戶籍郵遞區號
             OLD_REC.REG_POST_CODE NEW_REG_POST_CODE,  --(新)戶籍郵遞區號
             REG_ADDRESS,  --戶籍地址
             OLD_REC.REG_ADDRESS NEW_REG_ADDRESS,  --(新)戶籍地址
             --法代
             REPRESENTATIVE,  --法定代理人
             OLD_REC.REPRESENTATIVE NEW_REPRESENTATIVE,  --(新)法定代理人
             REPRESENTATIVE_ID,  --法代ID
             OLD_REC.REPRESENTATIVE_ID NEW_REPRESENTATIVE_ID,  --(新)法代ID
             REPRESENTATIVE1,  --法定代理人1
             OLD_REC.REPRESENTATIVE1 NEW_REPRESENTATIVE1,  --(新)法定代理人1
             REPRESENTATIVE1_ID,  --法代1ID
             OLD_REC.REPRESENTATIVE1_ID NEW_REPRESENTATIVE1_ID,  --(新)法代1ID
             --交易限制
             FAX_AGREEMENT,  --傳真同意書(Y:是  N:否)
             -- 2018.11.28 JIANXIN MOD BY 傳真同意書預設 'N'
             'N' NEW_FAX_AGREEMENT,  --(新)傳真同意書(Y:是  N:否)
             ROBO_AGREEMENT,  --ROBO同意書(Y:是  N:否)
             -- 2019.12.16 ChengYu 調整 ROBO同意書(ROBO_AGREEMENT)、ROBO同意書簽署日期(ROBO_DATE)預設值
             'N' NEW_ROBO_AGREEMENT,  --(新)ROBO同意書(Y:是  N:否)
             ROBO_DATE,  --ROBO同意書簽署日期
             -- 2019.12.16 ChengYu 調整 ROBO同意書(ROBO_AGREEMENT)、ROBO同意書簽署日期(ROBO_DATE)預設值
             TO_DATE('19000101','YYYYMMDD') NEW_ROBO_DATE,  --(新)ROBO同意書簽署日期
             -- 2018.12.27 JIANXIN MOD BY 若舊戶加開EC業務員寫入原本的業務員內容
             --業績
             EC_SALES_NO,SALES_NO NEW_EC_SALES_NO,             
             --FATCA
             US_TAX,  --美國報稅
             'N' NEW_US_TAX,  --(新)美國報稅
             FATCA_TYPE,  --FATCA分類
             'C' NEW_FATCA_TYPE,  --(新)FATCA分類
             --通知書
             CONFIRMATION_NOTICE,  --交易確認書(Y:領取 N:不領取)
             'N' NEW_CONFIRMATION_NOTICE,  --(新)交易確認書(Y:領取 N:不領取)
             DAILY_STATEMENT,  --交易對帳單(Y:領取 N:不領取)
             'N' NEW_DAILY_STATEMENT,  --(新)交易對帳單(Y:領取 N:不領取)
             MONTHLY_STATEMENT,  --月對帳單(Y:領取 N:不領取)
             'N' NEW_MONTHLY_STATEMENT,  --(新)月對帳單(Y:領取 N:不領取)
             SEMIANNUAL_STATEMENT,  --半年對帳單(Y:領取 N:不領取)
             'N' NEW_SEMIANNUAL_STATEMENT,  --(新)半年對帳單(Y:領取 N:不領取)
             CS_MAIL,  --對帳單郵寄(G:普通 H:限時 I:掛號 J: 限時掛號 Z:不列印)
             'G' NEW_CS_MAIL,  --(新)對帳單郵寄(G:普通 H:限時 I:掛號 J: 限時掛號 Z:不列印)
             CS_FAX,  --對帳單傳真(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
             '0' NEW_CS_FAX,  --(新)對帳單傳真(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
             CS_EMAIL,  --對帳單Email(Y:是 N:否 D:未申請)
             'Y' NEW_CS_EMAIL,  --(新)對帳單Email(Y:是  N:否  D:未申請)
             --文宣
             VIP_ML_TYPE,  --VIP刊物(1:是 2:否)
             '2' NEW_VIP_ML_TYPE,  --(新)VIP刊物(1:是 2:否)
             EDM_ACCEPTED,  --EDM ACCEPTED(Y:是 N:否)
             OLD_REC.EDM_ACCEPTED NEW_EDM_ACCEPTED,  --(新)EDM ACCEPTED(Y:是  N:否)
             DM_ACCEPTED,  --郵寄宣傳資料(1:同意 2.不同意)
             CASE WHEN OLD_REC.EDM_ACCEPTED = 'Y' THEN 'Y' ELSE 'N' END NEW_DM_ACCEPTED, --(新)郵寄宣傳資料(1:同意 2.不同意)
             ML_TYPE,  --郵寄投資生活月刊(1:同意 2.不同意)
             -- 2018.11.28 JIANXIN MOD BY 郵寄投資生活月刊預設為'2'
             '2' NEW_ML_TYPE,  --(新)投資生活月刊(1:同意 2.不同意)
             GROUP_DM,  --願意收到集團行銷資料(1:同意 2.不同意)
             CASE WHEN OLD_REC.EDM_ACCEPTED = 'Y' THEN '1' ELSE '2' END NEW_GROUP_DM,  --(新)願意收到集團行銷資料(1:同意 2.不同意)
             -- 2018.11.28 JIANXIN MOD BY 新增個資同意書
             PERSONAL_INFO_AGREEMENT,  --個資同意書(Y:是  N:否)
             'Y' NEW_PERSONAL_INFO_AGREEMENT,  --(新)個資同意書(Y:是  N:否)
             --輸入註記
             'ECS' CREATED_BY,  --建檔人員
             XSYS_DTTM CREATION_DATE,  --建檔日期
             'ECS' REVISED_BY,  --修改人員
             XSYS_DTTM REVISION_DATE,  --修改日期
             'ECS' REVIEWED_BY,  --覆核人員
             XSYS_DTTM REVIEW_DATE,  --覆核日期
             'ECS' EMP_NO,  --員工代碼
             XSYS_DTTM LAST_MODIFIED,  --最後修改日期
             --其他
             '2' APPLY_TYPE, --申請變更方式(1:填寫申請書 2:網路申請)

             XSN SER_NO, --交易序號
             '0' STAMP_CHANGE,  --印鑑變更(1:是 0:否)
             '0' FAX_CHANGE,  --傳真約定帳號變更(1:是 0:否)
             NULL IS_POSTED,  --登帳註記
             NULL SEND_TYPE,  --補發EC密碼方式\1.Email;2.SMS
             NULL SEND_MOBILE,  --補發EC密碼行動電話\補發EC密碼方式為2.SMS時，該次的行動電話
             -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
             --居住地
             CURRENT_ADDRESS,
             OLD_REC.CURRENT_ADDRESS NEW_CURRENT_ADDRESS,
             CURRENT_ADDRESS_COUNTRY,
             OLD_REC.CURRENT_ADDRESS_COUNTRY NEW_CURRENT_ADDRESS_COUNTRY,
             CURRENT_POST_CODE,
             OLD_REC.CURRENT_POST_CODE NEW_CURRENT_POST_CODE,
             CRS_ADDRESS_EQUAL,
             OLD_REC.CRS_ADDRESS_EQUAL NEW_CRS_ADDRESS_EQUAL
             -- =================KYC 題目=========================
             -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
             ,EMPLOYER                                                                       -- 服務單位名稱 
             ,OLD_REC.EMPLOYER AS NEW_EMPLOYER                                               -- (新)服務單位名稱 
             ,CUST_FAMILY_STATUS                                                             -- 家庭狀況1:單身 2:已婚 3:其他
             ,OLD_REC.CUST_FAMILY_STATUS AS NEW_CUST_FAMILY_STATUS                           -- (新)家庭狀況1:單身 2:已婚 3:其他
             ,CUST_FAMILY_STATUS_TXT                                                         -- 家庭狀況_其他(說明)
             ,OLD_REC.CUST_FAMILY_STATUS_TXT AS NEW_CUST_FAMILY_STATUS_TXT                   -- (新)家庭狀況_其他(說明)
             ,CUST_CHILD_STATUS                                                              -- 家庭狀況1:無(小孩) 2:有(小孩)
             ,OLD_REC.CUST_CHILD_STATUS AS NEW_CUST_CHILD_STATUS                             -- (新)家庭狀況1:無(小孩) 2:有(小孩)
             ,CUST_CHILD_STATUS_TXT                              　                          -- 家庭狀況_小孩人數 
             ,OLD_REC.CUST_CHILD_STATUS_TXT AS NEW_CUST_CHILD_STATUS_TXT                     -- (新)家庭狀況_小孩人數 
             ,PROFESSION                                                                     -- 職業別(KYC)
             ,OLD_REC.PROFESSION AS NEW_PROFESSION                                           -- (新)職業別(KYC)
             ,PROFESSION_OTHERS_NEW                                                          -- 職業別_其他(KYC)
             ,OLD_REC.PROFESSION_OTHERS_NEW AS NEW_PROFESSION_OTHERS_NEW                     -- (新)職業別_其他(KYC)
             ,POSITION                                                                       -- 職務(KYC)
             ,OLD_REC.POSITION AS NEW_POSITION                                               -- (新)職務(KYC)
             ,POSITION_OTHERS                                                                -- 職務_其他(KYC)
             ,OLD_REC.POSITION_OTHERS AS NEW_POSITION_OTHERS                                 -- (新)職務_其他(KYC)
             ,CUST_INV_FUNDS_1                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_1                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_2                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_2                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_3                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_3                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_4                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_4                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_5                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '5' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_5                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_6                                                                                                                                                  　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '6' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_6                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_7                  　　                                                                                                                                -- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '7' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FUNDS_7                -- (新)投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_7_TXT                                                                                                                                                  -- 投資資金來源_其他(說明)
             ,OLD_REC.INV_ORI_OTHER AS NEW_CUST_INV_FUNDS_7_TXT                                                                                                                     -- (新)投資資金來源_其他(說明)
             ,CUST_INV_FINSOURCE_1                                                                                                                                                  -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FINSOURCE_1      -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_2                                                                                                                                                  -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FINSOURCE_2      -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_3                                                                                                                                                  -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FINSOURCE_3      -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_4                                                                                                                                                  -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END AS NEW_CUST_INV_FINSOURCE_4      -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_4_TXT                                                         -- 投資理財資訊來源(可複選)其他(說明)
             ,OLD_REC.INV_KNOWLEDGE_OTHER AS NEW_CUST_INV_FINSOURCE_4_TXT                      -- (新)投資理財資訊來源(可複選)其他(說明)
             ,CUST_INV_ESTAMT                  　                                              -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
             ,OLD_REC.CUST_INV_ESTAMT AS NEW_CUST_INV_ESTAMT                  　               -- (新)預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
             ,CUST_RESIDENCE_STATUS                                                            -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
             ,OLD_REC.CUST_RESIDENCE_STATUS AS NEW_CUST_RESIDENCE_STATUS                       -- (新)目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
             ,CUST_RESIDENCE_STATUS_TXT                                                        -- 目前居住及照護狀態(說明)
             ,OLD_REC.CUST_RESIDENCE_STATUS_TXT AS NEW_CUST_RESIDENCE_STATUS_TXT               -- (新)目前居住及照護狀態(說明)
             ,CUST_MIND_STATUS                 　　                                            -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
             ,OLD_REC.CUST_MIND_STATUS AS NEW_CUST_MIND_STATUS                　　             -- (新)目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
             ,MAJOR_ILLNESS                                                                    -- 重大傷病證明 Y:有 N:無 D:無勾選
             ,OLD_REC.MAJOR_ILLNESS AS NEW_MAJOR_ILLNESS                                       -- (新)重大傷病證明 Y:有 N:無 D:無勾選

             ,CUST_RISK_AGE                                                                    -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
             ,OLD_REC.BF_AGE_CODE AS NEW_CUST_RISK_AGE                                         -- (新)客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
             ,EDUCATION                                                                        -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
             ,OLD_REC.EDUCATION AS NEW_EDUCATION                                               -- (新)學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
             ,CUST_RISK_INVTOOL                                                                -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
             ,OLD_REC.CUST_RISK_INVTOOL AS NEW_CUST_RISK_INVTOOL                               -- (新)常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
             ,CUST_RISK_INVEXP                                                                 -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
             ,OLD_REC.CUST_RISK_INVEXP AS NEW_CUST_RISK_INVEXP                                 -- (新)投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
             ,CUST_RISK_INVPURPOSE                                                             -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
             ,OLD_REC.CUST_RISK_INVPURPOSE AS NEW_CUST_RISK_INVPURPOSE                         -- (新)最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
             ,FAMILY_INCOME                                                                    -- 個人或家庭平均年收入
             ,OLD_REC.FAMILY_INCOME AS NEW_FAMILY_INCOME                                       -- (新)個人或家庭平均年收入
             ,CUST_RISK_INVPROFIT                                                              -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
             ,OLD_REC.CUST_RISK_INVPROFIT AS NEW_CUST_RISK_INVPROFIT                           -- (新)投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
             ,CUST_RISK_FUNDING                                                                -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
             ,OLD_REC.CUST_RISK_FUNDING AS NEW_CUST_RISK_FUNDING                               -- (新)重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
             ,CUST_RISK_FLUIDITY                                                               -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
             ,OLD_REC.CUST_RISK_FLUIDITY AS NEW_CUST_RISK_FLUIDITY                             -- (新)流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
             ,CUST_RISK_PRICEVOL                                                               -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動
             ,OLD_REC.CUST_RISK_PRICEVOL AS NEW_CUST_RISK_PRICEVOL                             -- (新)價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
             ,VULNERABLE_CLAIM                                                                 -- 自主申購聲明\1：空值；2：同意；3：不同意
             ,OLD_REC.VULNERABLE_CLAIM AS NEW_VULNERABLE_CLAIM                                 -- (新)自主申購聲明\1：空值；2：同意；3：不同意
             ,RISK_LEVEL                                                                       -- 客戶風險屬性 1:保守 2:穩健 3:積極
             ,OLD_REC.RISK_LEVEL AS NEW_RISK_LEVEL                                             -- (新)客戶風險屬性 1:保守 2:穩健 3:積極
             ,KYC_SCROE                                                                        -- KYC 分數
             ,OLD_REC.KYC_SCROE AS NEW_KYC_SCROE                                               -- (新)KYC 分數

             ,RISK_STATUS                                                                      -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
             ,'1' AS NEW_RISK_STATUS                                                           -- (新)適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
             ,RISK_WRITE_DATE                                                                  -- 適合度分析表最後一次填寫日(即轉入FAS.HOLDER的日期)
             ,XSYS_DATE AS NEW_RISK_WRITE_DATE                                                 -- (新)適合度分析表最後一次填寫日(即轉入FAS.HOLDER的日期)
             ,RISK_MAT_DATE                                                                    -- 適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)
             ,Add_months(XSYS_DATE,12) - 1 AS NEW_RISK_MAT_DATE                                -- (新)適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)

        FROM FAS.HOLDER
       WHERE ID = OLD_REC.ID;

      dbms_output.put_line('INSERT INTO FAS.HOLDER_CHANGE END');

      dbms_output.put_line('UPDATE FAS.HOLDER BEGIN');

      --3.2 將舊戶變更已審核完成的資料更新受益人基本資料檔(FAS.HOLDER)
      UPDATE FAS.HOLDER
         SET --基本資料
             -- 2018.11.29 JIANXIN MOD BY 1. NAME、ENAME、FIRST_NAME、MIDDLE_NAME、LAST_NAME欄位調整
               NAME = OLD_REC.NAME,
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             ENAME =  OLD_REC.LAST_NAME ||' ' || OLD_REC.FIRST_NAME||' '||OLD_REC.MIDDLE_NAME , --英文姓名,由下列3欄位組合
             FIRST_NAME = OLD_REC.FIRST_NAME,  --英文名
             MIDDLE_NAME = OLD_REC.MIDDLE_NAME, --英文中間名
             LAST_NAME = OLD_REC.LAST_NAME,   --英文姓氏
             NATIONALITY = CASE WHEN NATIONALITY IS NULL THEN OLD_REC.NATIONALITY ELSE NATIONALITY END,
             BIRTH_COUNTRY = CASE WHEN BIRTH_COUNTRY IS NULL THEN OLD_REC.BIRTH_COUNTRY ELSE BIRTH_COUNTRY END,
             TEL_H_COUNTRY = OLD_REC.TEL_H_COUNTRY, --電話(宅)–國碼
             TEL_H_AREA = OLD_REC.TEL_H_AREA, --電話(宅)–區碼
             TEL_H_NO = OLD_REC.TEL_H_NO, --電話(宅)–電話
             TEL_H_EXT = OLD_REC.TEL_H_EXT, --電話(宅)–分機
             TEL_H_VALID = 'Y', --電話(宅)–有效註記
             TEL_H = OLD_REC.TEL_H_AREA||'-'||OLD_REC.TEL_H_NO||CASE WHEN OLD_REC.TEL_H_EXT IS NOT NULL THEN '#'||OLD_REC.TEL_H_EXT ELSE NULL END, --電話(宅)
             TEL_O_COUNTRY = OLD_REC.TEL_O_COUNTRY, --電話(公)–國碼
             TEL_O_AREA = OLD_REC.TEL_O_AREA, --電話(公)–區碼
             TEL_O_NO = OLD_REC.TEL_O_NO, --電話(公)–電話
             TEL_O_EXT = OLD_REC.TEL_O_EXT, --電話(公)–分機
             TEL_O_VALID = 'Y', --電話(公)–有效註記
             TEL_O = OLD_REC.TEL_O_AREA||'-'||OLD_REC.TEL_O_NO||CASE WHEN OLD_REC.TEL_O_EXT IS NOT NULL THEN '#'||OLD_REC.TEL_O_EXT ELSE NULL END, --電話(公)
             MOBILE_COUNTRY = OLD_REC.MOBILE_COUNTRY, --行動電話–國碼
             MOBILE = OLD_REC.MOBILE, --行動電話
             MOBILE_VALID = 'Y', --行動電話–有效註記
             FAX_COUNTRY = OLD_REC.FAX_COUNTRY, --傳真1–國碼
             FAX_AREA = OLD_REC.FAX_AREA, --傳真1–區碼
             FAX_NO = OLD_REC.FAX_NO, --傳真1–電話
             FAX_EXT = OLD_REC.FAX_EXT, --傳真1–分機
             FAX_VALID = 'Y', --傳真1–有效註記
             FAX = OLD_REC.FAX_AREA||'-'||OLD_REC.FAX_NO||CASE WHEN OLD_REC.FAX_EXT IS NOT NULL THEN '#'||OLD_REC.FAX_EXT ELSE NULL END, --傳真1
             -- 2018.11.29 JIANXIN MOD BY EMAIL、EMAIL_VALID 欄位調整
             EMAIL = CASE WHEN NVL(EMAIL ,' ')<> OLD_REC.EMAIL THEN OLD_REC.EMAIL ELSE EMAIL END,
             EMAIL_VALID = CASE WHEN NVL(EMAIL ,' ') <> OLD_REC.EMAIL THEN 'N' ELSE EMAIL_VALID END,
             CONTACT_ADDRESS_COUNTRY = OLD_REC.CONTACT_ADDRESS_COUNTRY, --通訊地址國碼
             POST_CODE = OLD_REC.POST_CODE, --通訊郵遞區號
             CONTACT_ADDRESS = OLD_REC.CONTACT_ADDRESS, --通訊地址
             CONTACT_ADDRESS_VALID = 'Y', --通訊地址檢核
             REG_ADDRESS_COUNTRY = OLD_REC.REG_ADDRESS_COUNTRY, --戶籍地址國碼
             REG_POST_CODE = OLD_REC.REG_POST_CODE, --戶籍郵遞區號
             REG_ADDRESS = OLD_REC.REG_ADDRESS, --戶籍地址
             -- 2018.12.04 JIANXIN MOD BY 受益人資料中的收件者，若有法定代理人，則需寫入法定代理人的姓名
             RECIPIENT = OLD_REC.REPRESENTATIVE || ' ' || OLD_REC.REPRESENTATIVE1, -- 收件人
             --法代
             REPRESENTATIVE = CASE WHEN OLD_REC.REPRESENTATIVE IS NOT NULL THEN OLD_REC.REPRESENTATIVE ELSE OLD_REC.REPRESENTATIVE1 END, --法定代理人
             REPRESENTATIVE_ID = CASE WHEN OLD_REC.REPRESENTATIVE IS NOT NULL THEN OLD_REC.REPRESENTATIVE_ID ELSE OLD_REC.REPRESENTATIVE1_ID END, --法代ID
             REPRESENTATIVE1 = CASE WHEN OLD_REC.REPRESENTATIVE IS NULL THEN NULL ELSE OLD_REC.REPRESENTATIVE1 END, --法定代理人1
             REPRESENTATIVE1_ID = CASE WHEN OLD_REC.REPRESENTATIVE IS NULL THEN NULL ELSE OLD_REC.REPRESENTATIVE1_ID END, --法代1ID
             --境外
             OFFSHORE_ACCOUNT = CASE WHEN OFFSHORE_DATE IS NULL THEN 'Y' ELSE OFFSHORE_ACCOUNT END, --境外基金戶   Y:是 N:否(若為空白時,則帶入轉入日期,反之不異動)
             OFFSHORE_DATE = CASE WHEN OFFSHORE_DATE IS NULL THEN XSYS_DATE ELSE OFFSHORE_DATE END, --境外基金開戶日(若為空白時,則帶入轉入日期,反之不異動)
             TDCC_TYPE = CASE WHEN XCOUNT_AMC04 = 0 THEN '01' ELSE TDCC_TYPE END, --TDCC 客戶身分別(加開瑞萬時,才更新 01,反之不異動)
             -- 2018.12.05 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
             -- 2018.12.07 JIANXIN MOD BY 調整 TDCC_UPLOAD 資料
             -- 2019.06.19 tingting 調整 TDCC_UPLOAD 資料
             -- 2021.03.30 Chengyu 線上開戶時TDCC_UPLOAD 更新為Y
             TDCC_UPLOAD = CASE WHEN XCOUNT_AMC04 = 0 THEN CASE WHEN OLD_REC.OPEN_TYPE = '2' THEN 'Y'
                                                                ELSE 'A' END
                                ELSE TDCC_UPLOAD END, --TDCC 回傳註記(加開瑞萬時,才更新N,反之不異動)
             --FAX
             FAX_DATE = CASE WHEN FAX_DATE IS NULL THEN XSYS_DATE ELSE FAX_DATE END, --FAX開戶日(若為空白時,則帶入轉入日期,反之不異動)
             --EC
             EC_DATE = CASE WHEN EC_DATE IS NULL THEN XSYS_DATE ELSE EC_DATE END, --EC開戶日(若為空白時,則帶入轉入日期,反之不異動)
             ECS_STATUS = CASE WHEN ECS_STATUS = '0' THEN '1' ELSE ECS_STATUS END , --EC狀態
             PASSWD_CHANGED = CASE WHEN ECS_STATUS = '0' THEN 'N' ELSE PASSWD_CHANGED END, --EC密碼變更(Y,N)
             --交易限制
             -- 2018.11.28 JIANXIN MOD BY 傳真同意書預設 'N'
             FAX_AGREEMENT = 'N',   --傳真同意書(Y:是 N:否)
             -- 2019.12.16 ChengYu 調整 ROBO同意書(ROBO_AGREEMENT)、ROBO同意書簽署日期(ROBO_DATE)預設值
             ROBO_AGREEMENT = 'N',  --ROBO同意書(Y:是 N:否)
             ROBO_DATE = TO_DATE('19000101','YYYYMMDD'), --ROBO同意書簽署日期
             -- 2018.12.27 JIANXIN MOD BY 若舊戶加開EC業務員寫入原本的業務員內容
             --業績
             EC_SALES_NO = SALES_NO, --EC 業務員(若舊戶加開寫入原本的業務員)

             --FATCA
             US_TAX = 'N',
             FATCA_TYPE = 'C',
             FATCA_TAG = 'Y',
                FATCA_TAG_COMP_DATE = XSYS_DATE,
                FATCA_AGREEMENT = 'Y',
             --CRS
             TAX_MODIFIED = XSYS_DATE, --稅籍更新日
             --通知書
             CONFIRMATION_NOTICE = 'N',  --交易確認書
             DAILY_STATEMENT = 'N',      --交易對帳單
             MONTHLY_STATEMENT = 'N',    --月對帳單
             SEMIANNUAL_STATEMENT = 'N', --半年對帳單
             CS_MAIL = 'G',  --對帳單郵寄(G:普通 H:限時 I:掛號 J: 限時掛號 Z:不列印)
             CS_FAX = '0',   --對帳單傳真(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
             CS_FAX1 = '0',  --對帳單傳真2(0:否 1:是(傳真任一號碼) 2:是(傳真全部號碼))
             CS_EMAIL = 'Y', --對帳單Email(Y:是 N:否 D:未申請)
             --文宣
             EDM_ACCEPTED = OLD_REC.EDM_ACCEPTED, --EDM ACCEPTED(Y:是 N:否)
             NAV_EPAPER = 'N', --訂閱淨值電子報
             DM_ACCEPTED = CASE WHEN OLD_REC.EDM_ACCEPTED = 'Y' THEN 'Y' ELSE 'N' END, --郵寄宣傳資料(Y:同意 N.不同意)
             -- 2018.11.28 JIANXIN MOD BY 郵寄投資生活月刊預設為'2'
             ML_TYPE = '2',    --郵寄投資生活月刊(1:同意 2.不同意)
             GROUP_DM = CASE WHEN OLD_REC.EDM_ACCEPTED = 'Y' THEN '1' ELSE '2' END,    --願意收到集團行銷資料(1:同意 2.不同意)
             -- 2018.11.28 JIANXIN MOD BY 新增個資同意書
             PERSONAL_INFO_AGREEMENT = 'Y', --個資同意書(Y:同意 N.不同意)
             --缺件
             OMIT_A = 'N', --缺印鑑卡(Y:缺件 N:OK)
             OMIT_B = 'N', --缺身份證影本(Y:缺件 N:OK)
             OMIT_C = 'N', --缺營利事業登記證(Y:缺件 N:OK)
             OMIT_D = 'N', --缺傳真約定書(Y:缺件 N:OK)
             OMIT_E = 'N', --缺印鑑變更掛失申請書(Y:缺件 N:OK)
             OMIT_F = 'N', --缺資料變更申請書(Y:缺件 N:OK)
             OMIT_G = 'N', --缺資料變更申請書(Y:缺件 N:OK)
             OMIT_H = 'N', --缺法定代理人或負責人身份證影本項目(Y:缺件 N:OK)
             OMIT_I = 'N', --缺未成年子女戶口名簿影本(Y:缺件 N:OK)
             OMIT_J = 'N', --缺公司使用執照(Y:缺件 N:OK)
             OMIT_K = 'N', --缺開戶基本資料(Y:缺件 N:OK)
             OMIT_L = 'N', --缺網路/語音交易同意書(Y:缺件 N:OK)
             OMIT_M = 'N', --缺銀行授權書(Y:缺件 N:OK)
             --輸入註記
             REVIEWED_BY = OLD_REC.APPROVEID,  --覆核人員
             REVIEW_DATE = OLD_REC.APPROVEDATE,  --覆核日期
             -- 2018.11.30 JIANXIN MOD BY 寫入員工代碼
             EMP_NO = 'ECS', --員工代碼(修改人員)
             LAST_MODIFIED = OLD_REC.UPDATEDATE,  --最後修改日期
             STATUS = 'R',  --狀態('R'覆核確認)
             -- 2019.03.26 JIANXIN MOD BY 新增居住地址與稅籍原因
             --居住地
             CURRENT_ADDRESS = OLD_REC.CURRENT_ADDRESS,
             CURRENT_ADDRESS_COUNTRY = OLD_REC.CURRENT_ADDRESS_COUNTRY,
             CURRENT_POST_CODE = OLD_REC.CURRENT_POST_CODE,
             CRS_ADDRESS_EQUAL = CASE WHEN OLD_REC.CURRENT_ADDRESS = OLD_REC.CONTACT_ADDRESS THEN 'Y' ELSE 'N' END,
             -- 2021.07.20 JIANXIN 新增 CRS_DATE、CRS_TYPE、CRS_STATUS 欄位
             CRS_DATE = XSYS_DATE,
             CRS_STATUS = '',
             CRS_TYPE = 'A'
             -- =================KYC 題目=========================
             -- 2022.10.25 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
             ,EMPLOYER =  OLD_REC.EMPLOYER                                                   -- 服務單位名稱 
             ,CUST_FAMILY_STATUS = OLD_REC.CUST_FAMILY_STATUS                                -- 家庭狀況1:單身 2:已婚 3:其他
             ,CUST_FAMILY_STATUS_TXT = OLD_REC.CUST_FAMILY_STATUS_TXT                        -- 家庭狀況_其他(說明)
             ,CUST_CHILD_STATUS = OLD_REC.CUST_CHILD_STATUS                                  -- 家庭狀況1:無(小孩) 2:有(小孩)
             ,CUST_CHILD_STATUS_TXT = OLD_REC.CUST_CHILD_STATUS_TXT                          -- 家庭狀況_小孩人數 
             ,PROFESSION = OLD_REC.PROFESSION                                                -- 職業別(KYC)
             ,PROFESSION_OTHERS_NEW = OLD_REC.PROFESSION_OTHERS_NEW                          -- 職業別_其他(KYC)
             ,POSITION = OLD_REC.POSITION                                                    -- 職務(KYC)
             ,POSITION_OTHERS = OLD_REC.POSITION_OTHERS                                      -- 職務_其他(KYC)
             ,CUST_INV_FUNDS_1 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
             ,CUST_INV_FUNDS_2 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(退休金/保險年金)
             ,CUST_INV_FUNDS_3 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(租賃所得)
             ,CUST_INV_FUNDS_4 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(遺產餽贈)
             ,CUST_INV_FUNDS_5 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '5' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
             ,CUST_INV_FUNDS_6 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '6' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(閒置資金)
             ,CUST_INV_FUNDS_7 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_ORI,',')) WHERE COLUMN_VALUE  = '7' ) > 0 THEN 'Y' ELSE 'N' END                 　　-- 投資資金來源(複選)(其他)
             ,CUST_INV_FUNDS_7_TXT = OLD_REC.INV_ORI_OTHER                                -- 投資資金來源_其他(說明)
             ,CUST_INV_FINSOURCE_1 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END              -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
             ,CUST_INV_FINSOURCE_2 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END              -- (新)投資理財資訊來源(可複選)書報雜誌
             ,CUST_INV_FINSOURCE_3 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END              -- (新)投資理財資訊來源(可複選)網際網路
             ,CUST_INV_FINSOURCE_4 = CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(OLD_REC.INV_KNOWLEDGE,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END              -- (新)投資理財資訊來源(可複選)其他
             ,CUST_INV_FINSOURCE_4_TXT = OLD_REC.INV_KNOWLEDGE_OTHER                      -- 投資理財資訊來源(可複選)其他(說明)
             ,CUST_INV_ESTAMT = OLD_REC.CUST_INV_ESTAMT                  　               -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
             ,CUST_RESIDENCE_STATUS = OLD_REC.CUST_RESIDENCE_STATUS                       -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
             ,CUST_RESIDENCE_STATUS_TXT = OLD_REC.CUST_RESIDENCE_STATUS_TXT               -- 目前居住及照護狀態(說明)
             ,CUST_MIND_STATUS = OLD_REC.CUST_MIND_STATUS                　　             -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
             ,MAJOR_ILLNESS = OLD_REC.MAJOR_ILLNESS                                       -- 重大傷病證明 Y:有 N:無 D:無勾選

             ,CUST_RISK_AGE = OLD_REC.BF_AGE_CODE                                         -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
             ,EDUCATION = OLD_REC.EDUCATION                                               -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
             ,CUST_RISK_INVTOOL = OLD_REC.CUST_RISK_INVTOOL                               -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
             ,CUST_RISK_INVEXP = OLD_REC.CUST_RISK_INVEXP                                 -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
             ,CUST_RISK_INVPURPOSE = OLD_REC.CUST_RISK_INVPURPOSE                         -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
             ,FAMILY_INCOME = OLD_REC.FAMILY_INCOME                                       -- 個人或家庭平均年收入
             ,CUST_RISK_INVPROFIT = OLD_REC.CUST_RISK_INVPROFIT                           -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
             ,CUST_RISK_FUNDING = OLD_REC.CUST_RISK_FUNDING                               -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
             ,CUST_RISK_FLUIDITY = OLD_REC.CUST_RISK_FLUIDITY                             -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
             ,CUST_RISK_PRICEVOL = OLD_REC.CUST_RISK_PRICEVOL                             -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

             -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
             ,VULNERABLE_CLAIM = OLD_REC.VULNERABLE_CLAIM                                 -- 自主申購聲明\1：空值；2：同意；3：不同意
             ,RISK_LEVEL = OLD_REC.RISK_LEVEL                                             -- 新客戶風險屬性 1:保守 2:穩健 3:積極
             ,KYC_SCROE = OLD_REC.KYC_SCROE                                               -- KYC 分數

             ,RISK_STATUS = '1'                                                           -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
             ,RISK_WRITE_DATE = XSYS_DATE                                                 -- 適合度分析表最後一次填寫日(即轉入FAS.HOLDER的日期)
             ,RISK_MAT_DATE = Add_months(XSYS_DATE,12) - 1                                -- 適合度分析表最後一次填寫到期日(即轉入FAS.HOLDER的日期加一年減一天)

             ,GENDAR = CASE WHEN LENGTH(OLD_REC.ID) = 8 THEN 'C'
                            WHEN SUBSTRB(OLD_REC.ID,2,1) BETWEEN 'A' AND 'Z' THEN NULL
                            WHEN SUBSTRB(OLD_REC.ID,2,1) = '1' THEN 'M'
                            WHEN SUBSTRB(OLD_REC.ID,2,1) = '2' THEN 'F'
                            ELSE NULL
                        END --性別(F:女生 M:男生 C:公司)
             ,IS_KYC = 'N'
       WHERE ID = OLD_REC.ID;

      dbms_output.put_line('UPDATE FAS.HOLDER END');

      dbms_output.put_line('UPDATE OR INSERT INTO FAS.HOLDER_RELATIVE BEGIN');

      --3.3 將舊戶變更已審核完成的法代資料更新受益人法代資料檔(FAS.HOLDER_RELATIVE)
      IF LTRIM(OLD_REC.REPRESENTATIVE_ID) IS NOT NULL THEN
        --3.3.1 變更父法代
        UPDATE FAS.HOLDER_RELATIVE
           SET NAME = OLD_REC.REPRESENTATIVE,
               RELATIVE_TYPE = 'D',
               GENDAR = 'M',
               NATIONALITY = OLD_REC.REP_NATIONALITY_CODE,
               BIRTH_DATE = OLD_REC.REP_BIRTH_DATE,
               CONTACT_ADDRESS = OLD_REC.REP_ADDRESS,
               REVISION_DATE = OLD_REC.UPDATEDATE,
               REVISED_BY = OLD_REC.UPDATEID
         WHERE ID = OLD_REC.REPRESENTATIVE_ID;
        IF SQL%NOTFOUND THEN
           INSERT INTO FAS.HOLDER_RELATIVE
                 (ID,NAME,RELATIVE_TYPE,GENDAR,NATIONALITY,
                  BIRTH_DATE,CONTACT_ADDRESS,REVISION_DATE,REVISED_BY)
             VALUES
                 (OLD_REC.REPRESENTATIVE_ID,OLD_REC.REPRESENTATIVE,'D','M',OLD_REC.REP_NATIONALITY_CODE,
                  OLD_REC.REP_BIRTH_DATE,OLD_REC.REP_ADDRESS,OLD_REC.UPDATEDATE,OLD_REC.UPDATEID);
        END IF;
      END IF;

      IF LTRIM(OLD_REC.REPRESENTATIVE1_ID) IS NOT NULL THEN
        --3.3.2 變更母法代
        UPDATE FAS.HOLDER_RELATIVE
           SET NAME = OLD_REC.REPRESENTATIVE1,
               RELATIVE_TYPE = 'M',
               GENDAR = 'F',
               NATIONALITY = OLD_REC.REP_NATIONALITY_CODE1,
               BIRTH_DATE = OLD_REC.REP_BIRTH_DATE1,
               CONTACT_ADDRESS = OLD_REC.REP_ADDRESS1,
               REVISION_DATE = OLD_REC.UPDATEDATE,
               REVISED_BY = OLD_REC.UPDATEID
         WHERE ID = OLD_REC.REPRESENTATIVE1_ID;
        IF SQL%NOTFOUND THEN
           INSERT INTO FAS.HOLDER_RELATIVE
                 (ID,NAME,RELATIVE_TYPE,GENDAR,NATIONALITY,
                  BIRTH_DATE,CONTACT_ADDRESS,REVISION_DATE,REVISED_BY)
             VALUES
                 (OLD_REC.REPRESENTATIVE1_ID,OLD_REC.REPRESENTATIVE1,'M','F',OLD_REC.REP_NATIONALITY_CODE1,
                  OLD_REC.REP_BIRTH_DATE1,OLD_REC.REP_ADDRESS1,OLD_REC.UPDATEDATE,OLD_REC.UPDATEID);
        END IF;
      END IF;

      dbms_output.put_line('UPDATE OR INSERT INTO FAS.HOLDER_RELATIVE END');

      dbms_output.put_line('UPDATE OR INSERT INTO FAS.S_HOLDER_TAX_INF BEGIN');

      --3.4 將舊戶變更已審核完成的稅籍資料更新受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)
      IF LTRIM(OLD_REC.TAX_COUNTRY1) IS NOT NULL THEN
        --3.4.1 變更稅籍編號1
        UPDATE FAS.S_HOLDER_TAX_INF
           SET TAX_NUM = OLD_REC.TAX_NUM1,
               STATUS = 'R',
               REVISED_BY = OLD_REC.UPDATEID,
               UPDATE_DATE = OLD_REC.UPDATEDATE,
               -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
               TAXATION_TYPE = OLD_REC.TAXNOREASON1,
               TAXATION_REMARK = OLD_REC.TAXATION_REMARK1
         WHERE ID = OLD_REC.ID
           AND S_ID = OLD_REC.ID
           AND TAX_COUNTRY = OLD_REC.TAX_COUNTRY1;
        IF SQL%NOTFOUND THEN
           INSERT INTO FAS.S_HOLDER_TAX_INF
                 (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
             VALUES
                 (OLD_REC.ID,OLD_REC.ID,OLD_REC.TAX_COUNTRY1,OLD_REC.TAX_NUM1,'R',
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  OLD_REC.CREATEID,OLD_REC.CREATEDATE,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE,OLD_REC.TAXNOREASON1,OLD_REC.TAXATION_REMARK1);
        END IF;
      END IF;

      IF LTRIM(OLD_REC.TAX_COUNTRY2) IS NOT NULL THEN
        --3.4.2 變更稅籍編號2
        UPDATE FAS.S_HOLDER_TAX_INF
           SET TAX_NUM = OLD_REC.TAX_NUM2,
               STATUS = 'R',
               REVISED_BY = OLD_REC.UPDATEID,
               UPDATE_DATE = OLD_REC.UPDATEDATE,
               -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
               TAXATION_TYPE = OLD_REC.TAXNOREASON2,
               TAXATION_REMARK = OLD_REC.TAXATION_REMARK2
         WHERE ID = OLD_REC.ID
           AND S_ID = OLD_REC.ID
           AND TAX_COUNTRY = OLD_REC.TAX_COUNTRY2;
        IF SQL%NOTFOUND THEN
           INSERT INTO FAS.S_HOLDER_TAX_INF
                 (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
             VALUES
                 (OLD_REC.ID,OLD_REC.ID,OLD_REC.TAX_COUNTRY2,OLD_REC.TAX_NUM2,'R',
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  OLD_REC.CREATEID,OLD_REC.CREATEDATE,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE,OLD_REC.TAXNOREASON2,OLD_REC.TAXATION_REMARK2);
        END IF;
      END IF;
      -- 2019.01.22 yunchu 調整變更稅籍編號3的判斷
      IF LTRIM(OLD_REC.TAX_COUNTRY3) IS NOT NULL THEN
        --3.4.3 變更稅籍編號3
        UPDATE FAS.S_HOLDER_TAX_INF
           SET TAX_NUM = OLD_REC.TAX_NUM3,
               STATUS = 'R',
               REVISED_BY = OLD_REC.UPDATEID,
               UPDATE_DATE = OLD_REC.UPDATEDATE,
               -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
               TAXATION_TYPE = OLD_REC.TAXNOREASON3,
               TAXATION_REMARK = OLD_REC.TAXATION_REMARK3
         WHERE ID = OLD_REC.ID
           AND S_ID = OLD_REC.ID
           AND TAX_COUNTRY = OLD_REC.TAX_COUNTRY3;
        IF SQL%NOTFOUND THEN
           INSERT INTO FAS.S_HOLDER_TAX_INF
                 (ID,S_ID,TAX_COUNTRY,TAX_NUM,STATUS,
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  CREATED_BY,CREATION_DATE,REVISED_BY,UPDATE_DATE,TAXATION_TYPE,TAXATION_REMARK)
             VALUES
                 (OLD_REC.ID,OLD_REC.ID,OLD_REC.TAX_COUNTRY3,OLD_REC.TAX_NUM3,'R',
                 -- 2019.04.23 JIANXIN MOD BY 調整稅籍原因至【受益人稅籍資料檔(FAS.S_HOLDER_TAX_INF)】
                  OLD_REC.CREATEID,OLD_REC.CREATEDATE,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE,OLD_REC.TAXNOREASON3,OLD_REC.TAXATION_REMARK3);
        END IF;
      END IF;

      dbms_output.put_line('UPDATE OR INSERT INTO FAS.S_HOLDER_TAX_INF END');

      dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC BEGIN');

      --3.5 將舊戶變更已審核完成的開戶別資料更新受益人開戶別檔(FAS.HOLDER_AMC)
      --3.5.1 如果找不到瀚亞投信(境內)之開戶,則新增一筆
      BEGIN
        SELECT ID INTO XID_AMC
          FROM FAS.HOLDER_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '01';
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          -- 2018.11.29 JIANXIN MOD BY OPEN_TYPE 欄位調整
          -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
          INSERT INTO FAS.HOLDER_AMC (ID,AMC_NO,OPEN_DATE,ACCOUNT_NO,OPEN_TYPE)
             VALUES (OLD_REC.ID,'01',XSYS_DTTM,OLD_REC.ACCOUNT_NO,'N');
      END;

      dbms_output.put_line('  XID_AMC：' || XID_AMC || '　無值才 INSERT INTO FAS.HOLDER_AMC AMC_NO = 01');

      --3.5.2 如果找不到瀚亞投資(新加坡)之開戶,則新增一筆
      BEGIN
        SELECT ID INTO XID_AMC
          FROM FAS.HOLDER_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '02';
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          -- 2018.11.29 JIANXIN MOD BY OPEN_TYPE 欄位調整
          -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
          INSERT INTO FAS.HOLDER_AMC (ID,AMC_NO,OPEN_DATE,OPEN_TYPE)
             VALUES (OLD_REC.ID,'02',XSYS_DTTM,'1');
      END;

      dbms_output.put_line('  XID_AMC：' || XID_AMC || '　無值才 INSERT INTO FAS.HOLDER_AMC AMC_NO = 02');

      --3.5.3 如果找不到M&G(新加坡)之開戶,則新增一筆
      BEGIN
        SELECT ID INTO XID_AMC
          FROM FAS.HOLDER_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '03';
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          -- 2018.11.29 JIANXIN MOD BY OPEN_TYPE 欄位調整
          -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
          INSERT INTO FAS.HOLDER_AMC (ID,AMC_NO,OPEN_DATE,OPEN_TYPE)
             VALUES (OLD_REC.ID,'03',XSYS_DTTM,'1');
      END;

      dbms_output.put_line('  XID_AMC：' || XID_AMC || '　無值才 INSERT INTO FAS.HOLDER_AMC AMC_NO = 03');

      --3.5.4 如果找不到瑞萬通博(TDCC)之開戶,則新增一筆
      BEGIN
        SELECT ID INTO XID_AMC
          FROM FAS.HOLDER_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '04';
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          -- 2018.11.29 JIANXIN MOD BY OPEN_TYPE、TDCC_OPEN_DATE 欄位調整
          -- 2019.03.15 JIANXIN MOD BY 調整開戶日期要增加時間
          -- 2020.11.03 by Chengyu 調整取戶號取得方式、新增寫入集保戶號
          INSERT INTO FAS.HOLDER_AMC (ID,AMC_NO,OPEN_DATE,OPEN_TYPE,TDCC_OPEN_DATE,TDCC_ACCT_NO)
             VALUES (OLD_REC.ID,'04',XSYS_DTTM,'1' ,XSYS_DTTM,OLD_REC.TDCC_ACCT_NO);
      END;

      dbms_output.put_line('  XID_AMC：' || XID_AMC || '　無值才 INSERT INTO FAS.HOLDER_AMC AMC_NO = 04');
      dbms_output.put_line('INSERT INTO FAS.HOLDER_AMC END');

      dbms_output.put_line('FAS.HOLDER_BANK 系列 BEGIN');

      --3.6 將舊戶變更已審核完成的買回帳號資料更新受益人買回帳號檔(FAS.HOLDER_BANK)
      --3.6.1 財金
      --3.6.1.1 變更財金-台幣相關資料
      IF LTRIM(OLD_REC.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN
        BEGIN --取得台幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK BEGIN  財金-台幣  更新財金台幣買回帳號');
        dbms_output.put_line(' WHERE BANK_NO = OLD_REC.FIS_BANK_NO_TWD = ' || OLD_REC.FIS_BANK_NO_TWD);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD = ' || OLD_REC.FIS_AC_CODE_TWD);
        /*
        dbms_output.put_line('   AND DEPOSITORY_NO = ' || CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND
                                                                    OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND
                                                                    OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                                               THEN '04'
                                                               ELSE '01'
                                                               END);
        */
        dbms_output.put_line('   AND DEPOSITORY_NO IN (01,04)');
        dbms_output.put_line('   AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD = ' || OLD_REC.FIS_CURRENCY_NO_TWD);

        UPDATE FAS.HOLDER_BANK --更新財金台幣買回帳號
           SET FUND_TYPE = 'A',
               ECS = 'Y',
               EMP_NO = OLD_REC.CREATEID,
               LAST_MODIFIED = OLD_REC.CREATEDATE,
               CLOSE_DATE = NULL,
               FUND_CATEGORY = '0',
               -- 2019.06.13 tingting 調整變更財金-台幣相關資料的幣別判斷
               CURRENCY_NO = CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND
                                       OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND
                                       OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE AND
                                       OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND
                                       OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND
                                       OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                  THEN 'MMA'
                                  ELSE CURRENCY_NO
                                  END, --幣別
               -- 2019.05.10 JIANXIN MOD BY 若買回帳號兩者相同，則要共用同一帳號，故而調整
               DEPOSITORY_NO = CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                    THEN '04'
                                    ELSE DEPOSITORY_NO
                                    END, --帳戶保管平台代號(01.空白 04.集保)
               TDCC_BANK_UPLOAD = CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                       THEN 'Y'
                                       ELSE TDCC_BANK_UPLOAD
                                       END,  --受益人集保開戶資料上傳註記
               TDCC_VALID_FROM = CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                      THEN XTDCC_VALID_FROM
                                      ELSE TDCC_VALID_FROM
                                      END --受益人集保帳號生效日
         WHERE ID = OLD_REC.ID
           AND BANK_NO = OLD_REC.FIS_BANK_NO_TWD
           AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
           -- 2019.06.04 tingting 修正UPDATE不到資料就INSERT的條件不一致問題
           -- 2019.06.13 tingting 調整變更財金-台幣相關資料的帳戶保管平台判斷
           /*
           AND DEPOSITORY_NO = CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                    THEN '04'
                                    ELSE '01'
                                    END
           */
           AND DEPOSITORY_NO IN ('01','04')
           AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK END');

        IF SQL%NOTFOUND THEN --若財金台幣買回帳號找不到,則新增一筆

           dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  財金-台幣  更新不到資料才INSERT');
           dbms_output.put_line(' VALUES BANK_NO = OLD_REC.FIS_BANK_NO_TWD = ' || OLD_REC.FIS_BANK_NO_TWD);
           dbms_output.put_line(' VALUES AC_CODE = OLD_REC.FIS_AC_CODE_TWD = ' || OLD_REC.FIS_AC_CODE_TWD);
           dbms_output.put_line(' VALUES DEPOSITORY_NO = 01 OR 04 = ' || CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND
                                                                                   OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND
                                                                                   OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                                                                              THEN '04'
                                                                              ELSE '01'
                                                                              END);
           dbms_output.put_line(' VALUES CURRENCY_NO = MMA OR OLD_REC.FIS_CURRENCY_NO_TWD = ' || CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND
                                                                                                           OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND
                                                                                                           OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE AND
                                                                                                           OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND
                                                                                                           OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND
                                                                                                           OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                                                                                      THEN 'MMA'
                                                                                                      ELSE OLD_REC.FIS_CURRENCY_NO_TWD
                                                                                                      END);

           INSERT INTO FAS.HOLDER_BANK
                 (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
                  LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
                  ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
             VALUES
                 (OLD_REC.ID, --受益人ID
                  OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                  OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                  OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                  OLD_REC.NAME, --帳號名稱(即受益人姓名)
                  XSNAME, --往來銀行簡稱
                  XSYS_DATE, --生效日(即轉入FAS.HOLDER的日期)
                  'A', --基金種類(B:債券型 E:股票型 A:全部)
                  'Y', --適用網路交易(Y:是 N:否)
                  OLD_REC.CREATEID, --最後修改人員
                  OLD_REC.CREATEDATE, --最後修改時間
                  -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                  CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND
                            OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND
                            OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE AND
                            OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND
                            OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND
                            OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                       THEN 'MMA'
                       ELSE OLD_REC.FIS_CURRENCY_NO_TWD
                       END , --幣別
                  '0', --基金類別(0:全部 1:境內 2:境外)
                  XSWIFT_CODE, --swift code
                  'TWN', --FATCA國籍代號
                  -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                  OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名(受益人英文戶名)
                  -- 2018.11.29 JIANXIN MOD BY 若是集保台幣與財金台幣相同時，則新增時帳戶保管平台 = '04'、集保開戶資料 = 'Y'，並更新受益人集保帳號生效日
                  CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                       THEN '04'
                       ELSE '01'
                       END , --帳戶保管平台代號(01.空白 04.集保)
                  CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                       THEN 'Y'
                       ELSE 'N'
                       END , --受益人集保開戶資料上傳註記
                  CASE WHEN OLD_REC.FIS_BANK_NO_TWD = OLD_REC.TDCC_BANK_NO AND OLD_REC.FIS_BRANCH_NO_TWD = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.FIS_AC_CODE_TWD = OLD_REC.TDCC_AC_CODE
                       THEN XTDCC_VALID_FROM
                       ELSE NULL
                       END --受益人集保帳號生效日
                 );

           dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK END');

        END IF;
      END IF;

      --3.6.1.2 變更財金-外幣相關資料
      -- 2018.11.29 JIANXIN MOD BY 調整財金外幣判斷
      IF LTRIM(OLD_REC.FIS_CURRENCY_NO_FCY) IS NOT NULL THEN
        BEGIN --取得外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK BEGIN  財金-外幣  更新財金外幣買回帳號');
        dbms_output.put_line(' WHERE BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY = ' || OLD_REC.FIS_BANK_NO_TWD_FCY);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY = ' || OLD_REC.FIS_AC_CODE_TWD_FCY);
        dbms_output.put_line('   AND DEPOSITORY_NO = 01');
        dbms_output.put_line('   AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY = ' || OLD_REC.FIS_CURRENCY_NO_FCY);

        UPDATE FAS.HOLDER_BANK --更新財金外幣買回帳號
           SET FUND_TYPE = 'A',
               ECS = 'Y',
               EMP_NO = OLD_REC.CREATEID,
               LAST_MODIFIED = OLD_REC.CREATEDATE,
               CLOSE_DATE = NULL,
               FUND_CATEGORY = '0'
         WHERE ID = OLD_REC.ID
           AND BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY
           AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY
           AND DEPOSITORY_NO = '01'
           AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;
        IF SQL%NOTFOUND THEN --若財金外幣買回帳號找不到,則新增一筆

           dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN  財金-外幣  更新不到資料才INSERT');

           INSERT INTO FAS.HOLDER_BANK
                 (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
                  LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
                  ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
             VALUES
                 (OLD_REC.ID, --受益人ID
                  OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                  OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                  OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                  OLD_REC.NAME, --帳號名稱(即受益人姓名)
                  XSNAME, --往來銀行簡稱
                  XSYS_DATE, --生效日(即轉入FAS.HOLDER的日期)
                  'A', --基金種類(B:債券型 E:股票型 A:全部)
                  -- 2018.11.30 JIANXIN 財金外幣帳號，不適用於EC
                  'N', --適用網路交易(Y:是 N:否)
                  OLD_REC.CREATEID, --最後修改人員
                  OLD_REC.CREATEDATE, --最後修改時間
                  OLD_REC.FIS_CURRENCY_NO_FCY, --幣別
                  '0', --基金類別(0:全部 1:境內 2:境外)
                  XSWIFT_CODE, --swift code
                  'TWN', --FATCA國籍代號
                  -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                  OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名(受益人英文戶名)
                  '01', --帳戶保管平台代號(01.空白 04.集保)
                  'N', --受益人集保開戶資料上傳註記
                  NULL --受益人集保帳號生效日
                 );

           dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK END');

        END IF;
      END IF;

      --3.6.2 集保
      --3.6.2.1 變更集保-台幣/MMA帳號
      --3.6.2.1.1 變更'MMA'帳號
      XIS_NEW_TDCC_MMA := 'N';
      XIS_01 := 'N';
      IF OLD_REC.TDCC_CURRENCY_NO = 'MMA' THEN --若變更的幣別為'MMA',則須將目前買回帳號檔中屬'04'非'MMA'的帳號之幣別改成'MMA',其他的帳號改成'01'

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK BEGIN  若變更的幣別為MMA,則須將目前買回帳號檔中屬04非MMA的帳號之幣別改成MMA,其他的帳號改成01   同帳號');
        dbms_output.put_line(' WHERE BANK_NO = OLD_REC.TDCC_BANK_NO = ' || OLD_REC.TDCC_BANK_NO);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.TDCC_AC_CODE = ' || OLD_REC.TDCC_AC_CODE);
        dbms_output.put_line('   AND DEPOSITORY_NO = 04');
        dbms_output.put_line('   AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO = ' || OLD_REC.TDCC_CURRENCY_NO);

        --同帳號時
        UPDATE FAS.HOLDER_BANK --更新原帳號
           SET FUND_TYPE = 'A',
               ECS = 'Y',
               EMP_NO = OLD_REC.CREATEID,
               LAST_MODIFIED = OLD_REC.CREATEDATE,
               CLOSE_DATE = NULL,
               FUND_CATEGORY = '0'
         WHERE ID = OLD_REC.ID
           AND BANK_NO = OLD_REC.TDCC_BANK_NO
           AND AC_CODE = OLD_REC.TDCC_AC_CODE
           AND DEPOSITORY_NO = '04'
           AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO; --MMA
        IF SQL%NOTFOUND THEN --不同帳號時

          dbms_output.put_line('UPDATE FAS.HOLDER_BANK BEGIN  若變更的幣別為MMA,則須將目前買回帳號檔中屬04非MMA的帳號之幣別改成MMA,其他的帳號改成01  若更新不到同帳號則更新不同帳號');
          dbms_output.put_line(' WHERE DEPOSITORY_NO = 04');
          dbms_output.put_line('   AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO = ' || OLD_REC.TDCC_CURRENCY_NO);

          UPDATE FAS.HOLDER_BANK --只變更MMA帳號(更新欄位參考Excel表中的買回帳號頁次的J 欄)
             SET BANK_NO = OLD_REC.TDCC_BANK_NO,
                 BRANCH_NO = OLD_REC.TDCC_BRANCH_NO,
                 AC_CODE = OLD_REC.TDCC_AC_CODE,
                 FUND_TYPE = 'A',
                 ECS = 'Y',
                 EMP_NO = OLD_REC.CREATEID,
                 LAST_MODIFIED = OLD_REC.CREATEDATE,
                 CLOSE_DATE = NULL,
                 FUND_CATEGORY = '0',
                 TDCC_BANK_UPLOAD = 'A',
                 TDCC_VALID_FROM = XTDCC_VALID_FROM
           WHERE ID = OLD_REC.ID
             AND DEPOSITORY_NO = '04'
             AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO; --MMA
          IF SQL%NOTFOUND THEN --若找不MMA,則為新開立MMA帳號
            dbms_output.put_line('不同帳號也更新不到資料');
            XIS_NEW_TDCC_MMA := 'Y';
          END IF;
        END IF;
      END IF;

      --3.6.2.1.2 新開立集保-MMA帳號(須將目前買回帳號檔中屬'04'非'MMA'的帳號之幣別改成'MMA',其他的帳號改成'01'保管平台)
      --          若'04'平台無任何帳號,則新增此帳號
      IF OLD_REC.TDCC_CURRENCY_NO = 'MMA' AND XIS_NEW_TDCC_MMA = 'Y' THEN
        FOR BANK_REC IN
           (SELECT Z.*
              FROM (
                    SELECT A.*,
                           CASE WHEN A.CURRENCY_NO = 'NTD' THEN 0
                                ELSE 1 END SRNO
                      FROM FAS.HOLDER_BANK A
                     WHERE A.ID = OLD_REC.ID
                       AND A.DEPOSITORY_NO = '04'
                   ) Z
             ORDER BY Z.SRNO
           ) LOOP
             IF XIS_01 = 'N' THEN

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK BEGIN  將04平台第一筆帳號幣別改成MMA');
               dbms_output.put_line(' WHERE BANK_NO = BANK_REC.BANK_NO = ' || BANK_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = BANK_REC.AC_CODE = ' || BANK_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = BANK_REC.DEPOSITORY_NO = ' || BANK_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = BANK_REC.CURRENCY_NO = ' || BANK_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK --將'04'平台第一筆帳號幣別改成'MMA'
                  SET CURRENCY_NO = 'MMA',
                      FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0',
                      TDCC_BANK_UPLOAD = 'A',
                      TDCC_VALID_FROM = XTDCC_VALID_FROM
                WHERE ID = BANK_REC.ID
                  AND BANK_NO = BANK_REC.BANK_NO
                  AND AC_CODE = BANK_REC.AC_CODE
                  AND DEPOSITORY_NO = BANK_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = BANK_REC.CURRENCY_NO;
             ELSE
               BEGIN --將第二筆(含)之後帳號平台改成'01'
                 SELECT ID INTO XID_AMC
                   FROM FAS.HOLDER_BANK
                  WHERE ID = BANK_REC.ID
                    AND BANK_NO = BANK_REC.BANK_NO
                    AND AC_CODE = BANK_REC.AC_CODE
                    AND DEPOSITORY_NO = '01'
                    AND CURRENCY_NO = BANK_REC.CURRENCY_NO;

                 dbms_output.put_line('XID_AMC：' || XID_AMC);

                 --若'01'平台已有此帳號,則由'04'平台移除此帳號
                 DELETE FROM FAS.HOLDER_BANK
                  WHERE ID = BANK_REC.ID
                    AND BANK_NO = BANK_REC.BANK_NO
                    AND AC_CODE = BANK_REC.AC_CODE
                    AND DEPOSITORY_NO = BANK_REC.DEPOSITORY_NO
                    AND CURRENCY_NO = BANK_REC.CURRENCY_NO;

                 dbms_output.put_line('UPDATE FAS.HOLDER_BANK  將01平台此帳號停用日清空');
                 dbms_output.put_line(' WHERE BANK_NO = BANK_REC.BANK_NO = ' || BANK_REC.BANK_NO);
                 dbms_output.put_line('   AND AC_CODE = BANK_REC.AC_CODE = ' || BANK_REC.AC_CODE);
                 dbms_output.put_line('   AND DEPOSITORY_NO = 01');
                 dbms_output.put_line('   AND CURRENCY_NO = BANK_REC.CURRENCY_NO = ' || BANK_REC.CURRENCY_NO);

                 --同時將'01'平台此帳號停用日清空
                 UPDATE FAS.HOLDER_BANK
                    SET FUND_TYPE = 'A',
                        ECS = 'Y',
                        EMP_NO = OLD_REC.CREATEID,
                        LAST_MODIFIED = OLD_REC.CREATEDATE,
                        CLOSE_DATE = NULL,
                        FUND_CATEGORY = '0'
                  WHERE ID = BANK_REC.ID
                    AND BANK_NO = BANK_REC.BANK_NO
                    AND AC_CODE = BANK_REC.AC_CODE
                    AND DEPOSITORY_NO = '01'
                    AND CURRENCY_NO = BANK_REC.CURRENCY_NO;
               EXCEPTION
                 WHEN NO_DATA_FOUND THEN ----若'01'平台無此帳號,則將此帳號平台改成'01'

                     dbms_output.put_line('UPDATE FAS.HOLDER_BANK  若01平台無此帳號,則將此帳號平台改成01');
                     dbms_output.put_line(' WHERE BANK_NO = BANK_REC.BANK_NO = ' || BANK_REC.BANK_NO);
                     dbms_output.put_line('   AND AC_CODE = BANK_REC.AC_CODE = ' || BANK_REC.AC_CODE);
                     dbms_output.put_line('   AND DEPOSITORY_NO = BANK_REC.DEPOSITORY_NO = ' || BANK_REC.DEPOSITORY_NO);
                     dbms_output.put_line('   AND CURRENCY_NO = BANK_REC.CURRENCY_NO = ' || BANK_REC.CURRENCY_NO);

                     UPDATE FAS.HOLDER_BANK
                        SET FUND_TYPE = 'A',
                            ECS = 'Y',
                            EMP_NO = OLD_REC.CREATEID,
                            LAST_MODIFIED = OLD_REC.CREATEDATE,
                            CLOSE_DATE = NULL,
                            FUND_CATEGORY = '0',
                            DEPOSITORY_NO = '01' --改成'01'平台
                WHERE ID = BANK_REC.ID
                  AND BANK_NO = BANK_REC.BANK_NO
                  AND AC_CODE = BANK_REC.AC_CODE
                  AND DEPOSITORY_NO = BANK_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = BANK_REC.CURRENCY_NO;
               END;
             END IF;
             XIS_01 := 'Y';
             dbms_output.put_line('FOR OLD_REC IN LOOP END');
           END LOOP;

        -- 2019.05.28 JIANXIN MOD 修正'04'平台寫入幣別錯誤
        IF XIS_01 = 'N' AND OLD_REC.TDCC_CURRENCY_NO IS NOT NULL THEN --表示'04'平台無任何帳號,則新增此帳號
          BEGIN --取得MMA存款帳戶銀行簡稱
            -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
            SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
              INTO XSNAME,XSWIFT_CODE
              FROM FAS.FIS_BRANCH
                 JOIN FAS.FIS_BANK
                   ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
             WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO
                  AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO ;
          EXCEPTION
            WHEN NO_DATA_FOUND THEN
              XSNAME := NULL;
              XSWIFT_CODE := NULL;
          END;

          dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK BEGIN');
          dbms_output.put_line('  VALUES BANK_NO = OLD_REC.TDCC_BANK_NO = ' || OLD_REC.TDCC_BANK_NO);
          dbms_output.put_line('  VALUES AC_CODE = OLD_REC.TDCC_AC_CODE = ' || OLD_REC.TDCC_AC_CODE);
          dbms_output.put_line('  VALUES DEPOSITORY_NO = 04');
          dbms_output.put_line('  VALUES CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO = ' || OLD_REC.TDCC_CURRENCY_NO);

          INSERT INTO FAS.HOLDER_BANK
                 (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
                  LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
                  ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
             VALUES
                 (OLD_REC.ID, --受益人ID
                  OLD_REC.TDCC_BANK_NO, --往來銀行
                  OLD_REC.TDCC_BRANCH_NO, --往來分行
                  OLD_REC.TDCC_AC_CODE, --往來帳號
                  OLD_REC.NAME, --帳號名稱(即受益人姓名)
                  XSNAME, --往來銀行簡稱
                  XSYS_DATE, --生效日(即轉入FAS.HOLDER的日期)
                  'A', --基金種類(B:債券型 E:股票型 A:全部)
                  'Y', --適用網路交易(Y:是 N:否)
                  OLD_REC.CREATEID, --最後修改人員
                  OLD_REC.CREATEDATE, --最後修改時間
                  -- 2019.05.28 JIANXIN MOD 修正'04'平台寫入幣別錯誤
                  OLD_REC.TDCC_CURRENCY_NO, --幣別
                  '0', --基金類別(0:全部 1:境內 2:境外)
                  XSWIFT_CODE, --swift code
                  'TWN', --FATCA國籍代號
                  -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                  OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名(受益人英文戶名)
                  '04', --帳戶保管平台代號(01.空白 04.集保)
                  'A', --受益人集保開戶資料上傳註記
                  XTDCC_VALID_FROM --受益人集保帳號生效日
                 );

          dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK END');

        END IF;
      END IF;

      --3.6.2.1.3 變更台幣帳號
      IF OLD_REC.TDCC_CURRENCY_NO = 'NTD' THEN
        BEGIN --取得台幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BRANCH.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
               JOIN FAS.FIS_BANK
               ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
             WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO
               AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        FOR NTD_REC IN
           (SELECT A.*
              FROM FAS.HOLDER_BANK A
             WHERE A.ID = OLD_REC.ID
               AND A.DEPOSITORY_NO = '04'
               AND A.CURRENCY_NO IN ('NTD','MMA')
           ) LOOP

             dbms_output.put_line('FOR NTD_REC IN LOOP BEGIN');

             --同台幣同帳號
             IF NTD_REC.CURRENCY_NO = 'NTD' AND NTD_REC.BANK_NO = OLD_REC.TDCC_BANK_NO AND NTD_REC.AC_CODE = OLD_REC.TDCC_AC_CODE THEN

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更台幣帳號  同台幣同帳號');
               dbms_output.put_line(' WHERE BANK_NO = NTD_REC.BANK_NO = ' || NTD_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = NTD_REC.AC_CODE = ' || NTD_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = NTD_REC.DEPOSITORY_NO = ' || NTD_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = NTD_REC.CURRENCY_NO = ' || NTD_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0'
                WHERE ID = NTD_REC.ID
                  AND BANK_NO = NTD_REC.BANK_NO
                  AND AC_CODE = NTD_REC.AC_CODE
                  AND DEPOSITORY_NO = NTD_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = NTD_REC.CURRENCY_NO;
             ELSE --同台幣不同帳號或原幣別為'MMA'(須送集保核印)

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更台幣帳號  同台幣不同帳號或原幣別為MMA(須送集保核印)');
               dbms_output.put_line(' WHERE BANK_NO = NTD_REC.BANK_NO = ' || NTD_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = NTD_REC.AC_CODE = ' || NTD_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = NTD_REC.DEPOSITORY_NO = ' || NTD_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = NTD_REC.CURRENCY_NO = ' || NTD_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET BANK_NO = OLD_REC.TDCC_BANK_NO,
                      BRANCH_NO = OLD_REC.TDCC_BRANCH_NO,
                      AC_CODE = OLD_REC.TDCC_AC_CODE,
                      AC_NAME = OLD_REC.NAME,
                      FIS_SNAME = XSNAME,
                      VALID_FROM = XSYS_DATE,
                      -- 2019.06.13 JIANXIN 調整帳戶幣別的判斷
                      CURRENCY_NO = CASE WHEN OLD_REC.TDCC_CURRENCY_NO = 'NTD' AND OLD_REC.TDCC_CURRENCY_NO_FCY = 'FCY' THEN 'MMA' ELSE OLD_REC.TDCC_CURRENCY_NO END,
                      FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0',
                      INTERMEDIARY_SWIFT_CODE = XSWIFT_CODE,
                      COUNTRY_CODE = 'TWN',
                      -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                      ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME,
                      TDCC_BANK_UPLOAD = 'A',
                      TDCC_VALID_FROM = XTDCC_VALID_FROM
                WHERE ID = NTD_REC.ID
                  AND BANK_NO = NTD_REC.BANK_NO
                  AND AC_CODE = NTD_REC.AC_CODE
                  AND DEPOSITORY_NO = NTD_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = NTD_REC.CURRENCY_NO;
             END IF;

             dbms_output.put_line('FOR NTD_REC IN LOOP END');

           END LOOP;
      END IF;

      --3.6.2.2 變更集保-外幣
      --3.6.2.2.1 變更集保-綜合外幣
      IF OLD_REC.TDCC_CURRENCY_NO_FCY = 'FCY' THEN
        BEGIN --取得綜合外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
               JOIN FAS.FIS_BANK
               ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
             WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY
               AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY ;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        FOR FCY_REC IN
           (SELECT A.*
              FROM FAS.HOLDER_BANK A
             WHERE A.ID = OLD_REC.ID
               AND A.DEPOSITORY_NO = '04'
               AND A.CURRENCY_NO NOT IN ('NTD','MMA')
           ) LOOP

             dbms_output.put_line('FOR FCY_REC IN LOOP BEGIN');

             --同綜合外幣同帳號
             IF FCY_REC.CURRENCY_NO = 'FCY' AND FCY_REC.BANK_NO = OLD_REC.TDCC_BANK_NO AND FCY_REC.AC_CODE = OLD_REC.TDCC_AC_CODE THEN

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更集保-綜合外幣  同綜合外幣同帳號');
               dbms_output.put_line(' WHERE BANK_NO = FCY_REC.BANK_NO = ' || FCY_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = FCY_REC.AC_CODE = ' || FCY_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = FCY_REC.DEPOSITORY_NO = ' || FCY_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = FCY_REC.CURRENCY_NO = ' || FCY_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0'
                WHERE ID = FCY_REC.ID
                  AND BANK_NO = FCY_REC.BANK_NO
                  AND AC_CODE = FCY_REC.AC_CODE
                  AND DEPOSITORY_NO = FCY_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = FCY_REC.CURRENCY_NO;
             ELSE --同綜合外幣不同帳號或原指定外幣(須送集保核印)

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更集保-綜合外幣  同綜合外幣不同帳號或原指定外幣(須送集保核印)');
               dbms_output.put_line(' WHERE BANK_NO = FCY_REC.BANK_NO = ' || FCY_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = FCY_REC.AC_CODE = ' || FCY_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = FCY_REC.DEPOSITORY_NO = ' || FCY_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = FCY_REC.CURRENCY_NO = ' || FCY_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY,
                      BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY,
                      AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY,
                      AC_NAME = OLD_REC.NAME,
                      FIS_SNAME = XSNAME,
                      VALID_FROM = XSYS_DATE,
                      CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO_FCY,
                      FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0',
                      INTERMEDIARY_SWIFT_CODE = XSWIFT_CODE,
                      COUNTRY_CODE = 'TWN',
                      -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                      ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME,
                      TDCC_BANK_UPLOAD = 'A',
                      TDCC_VALID_FROM = XTDCC_VALID_FROM
                WHERE ID = FCY_REC.ID
                  AND BANK_NO = FCY_REC.BANK_NO
                  AND AC_CODE = FCY_REC.AC_CODE
                  AND DEPOSITORY_NO = FCY_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = FCY_REC.CURRENCY_NO;
             END IF;

             dbms_output.put_line('FOR FCY_REC IN LOOP END');

           END LOOP;
      END IF;

      --3.6.2.2.2 變更集保-指定外幣
      IF NVL(OLD_REC.TDCC_CURRENCY_NO_FCY,' ') NOT IN ('FCY',' ') THEN
        BEGIN --取得綜合外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
               JOIN FAS.FIS_BANK
               ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
             WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY
               AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        FOR NFCY_REC IN
           (SELECT A.*
              FROM FAS.HOLDER_BANK A
             WHERE A.ID = OLD_REC.ID
               AND A.DEPOSITORY_NO = '04'
               AND A.CURRENCY_NO NOT IN ('NTD','MMA')
           ) LOOP

             dbms_output.put_line('FOR NFCY_REC IN LOOP BEGIN');

             --同指定外幣同帳號
             IF NFCY_REC.CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO_FCY AND NFCY_REC.BANK_NO = OLD_REC.TDCC_BANK_NO AND NFCY_REC.AC_CODE = OLD_REC.TDCC_AC_CODE THEN

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更集保-指定外幣 同指定外幣同帳號');
               dbms_output.put_line(' WHERE BANK_NO = NFCY_REC.BANK_NO = ' || NFCY_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = NFCY_REC.AC_CODE = ' || NFCY_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = NFCY_REC.DEPOSITORY_NO = ' || NFCY_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = NFCY_REC.CURRENCY_NO = ' || NFCY_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0'
                WHERE ID = NFCY_REC.ID
                  AND BANK_NO = NFCY_REC.BANK_NO
                  AND AC_CODE = NFCY_REC.AC_CODE
                  AND DEPOSITORY_NO = NFCY_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = NFCY_REC.CURRENCY_NO;
             ELSE --同指定外幣不同帳號或原綜合外幣(須送集保核印)

               dbms_output.put_line('UPDATE FAS.HOLDER_BANK  變更集保-指定外幣 同指定外幣不同帳號或原綜合外幣(須送集保核印)');
               dbms_output.put_line(' WHERE BANK_NO = NFCY_REC.BANK_NO = ' || NFCY_REC.BANK_NO);
               dbms_output.put_line('   AND AC_CODE = NFCY_REC.AC_CODE = ' || NFCY_REC.AC_CODE);
               dbms_output.put_line('   AND DEPOSITORY_NO = NFCY_REC.DEPOSITORY_NO = ' || NFCY_REC.DEPOSITORY_NO);
               dbms_output.put_line('   AND CURRENCY_NO = NFCY_REC.CURRENCY_NO = ' || NFCY_REC.CURRENCY_NO);

               UPDATE FAS.HOLDER_BANK
                  SET BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY,
                      BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY,
                      AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY,
                      AC_NAME = OLD_REC.NAME,
                      FIS_SNAME = XSNAME,
                      VALID_FROM = XSYS_DATE,
                      CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO_FCY,
                      FUND_TYPE = 'A',
                      ECS = 'Y',
                      EMP_NO = OLD_REC.CREATEID,
                      LAST_MODIFIED = OLD_REC.CREATEDATE,
                      CLOSE_DATE = NULL,
                      FUND_CATEGORY = '0',
                      INTERMEDIARY_SWIFT_CODE = XSWIFT_CODE,
                      COUNTRY_CODE = 'TWN',
                      -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                      ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME,
                      TDCC_BANK_UPLOAD = 'A',
                      TDCC_VALID_FROM = XTDCC_VALID_FROM
                WHERE ID = NFCY_REC.ID
                  AND BANK_NO = NFCY_REC.BANK_NO
                  AND AC_CODE = NFCY_REC.AC_CODE
                  AND DEPOSITORY_NO = NFCY_REC.DEPOSITORY_NO
                  AND CURRENCY_NO = NFCY_REC.CURRENCY_NO;
             END IF;

             dbms_output.put_line('FOR NFCY_REC IN LOOP END');

           END LOOP;
      END IF;

      -- 2022.01.07 Chengyu 修正帳號沒新增問題
      --因不曉得原本邏輯為何，故再最後新增判斷是否需要新增(邏輯參考ECS.F_ECSB007_GetBankR)
      BEGIN
        SELECT COUNT(1) 
          INTO XDATA_CNT
          FROM FAS.HOLDER_BANK
         WHERE ID = OLD_REC.ID
           AND DEPOSITORY_NO = '04'
                  --MMA狀況
           AND (  (CURRENCY_NO = 'MMA')  
                  --若有輸入集保外幣資料時，則會用原本資料
               OR (    BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY 
                   AND BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY
                   AND AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY
                   AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO_FCY  
                  ) 
                  --若無輸入集保外幣資料時，則會用財金外幣資料寫入
               OR (    BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY 
                   AND BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY
                   AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY
                   AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY  
                  ) 
               );

        IF NVL(XDATA_CNT,0) = 0 THEN
        BEGIN

            IF OLD_REC.TDCC_CURRENCY_NO_FCY IS NOT NULL THEN
            BEGIN

            INSERT INTO FAS.HOLDER_BANK
                   (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
                    LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
                    ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
               VALUES
                   (OLD_REC.ID, --受益人ID
                    OLD_REC.TDCC_BANK_NO_TWD_FCY, --往來銀行
                    OLD_REC.TDCC_BRANCH_NO_TWD_FCY, --往來分行
                    OLD_REC.TDCC_AC_CODE_TWD_FCY, --往來帳號
                    OLD_REC.NAME, --帳號名稱(即受益人姓名)
                    XSNAME, --往來銀行簡稱
                    XSYS_DATE, --生效日(即轉入FAS.HOLDER的日期)
                    'A', --基金種類(B:債券型 E:股票型 A:全部)
                    'Y', --適用網路交易(Y:是 N:否)
                    OLD_REC.CREATEID, --最後修改人員
                    OLD_REC.CREATEDATE, --最後修改時間
                    -- 2019.05.28 JIANXIN MOD 修正'04'平台寫入幣別錯誤
                    OLD_REC.TDCC_CURRENCY_NO_FCY, --幣別
                    '0', --基金類別(0:全部 1:境內 2:境外)
                    XSWIFT_CODE, --swift code
                    'TWN', --FATCA國籍代號
                    -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                    OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名(受益人英文戶名)
                    '04', --帳戶保管平台代號(01.空白 04.集保)
                    'A', --受益人集保開戶資料上傳註記
                    XTDCC_VALID_FROM --受益人集保帳號生效日
                   );
            END;
            ELSIF OLD_REC.FIS_BANK_NO_TWD_FCY IS NOT NULL THEN
            BEGIN

            INSERT INTO FAS.HOLDER_BANK
                   (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,VALID_FROM,FUND_TYPE,ECS,EMP_NO,
                    LAST_MODIFIED,CURRENCY_NO,FUND_CATEGORY,INTERMEDIARY_SWIFT_CODE,COUNTRY_CODE,
                    ENAME,DEPOSITORY_NO,TDCC_BANK_UPLOAD,TDCC_VALID_FROM)
               VALUES
                   (OLD_REC.ID, --受益人ID
                    OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                    OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                    OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                    OLD_REC.NAME, --帳號名稱(即受益人姓名)
                    XSNAME, --往來銀行簡稱
                    XSYS_DATE, --生效日(即轉入FAS.HOLDER的日期)
                    'A', --基金種類(B:債券型 E:股票型 A:全部)
                    'Y', --適用網路交易(Y:是 N:否)
                    OLD_REC.CREATEID, --最後修改人員
                    OLD_REC.CREATEDATE, --最後修改時間
                    -- 2019.05.28 JIANXIN MOD 修正'04'平台寫入幣別錯誤
                    OLD_REC.FIS_CURRENCY_NO_FCY, --幣別
                    '0', --基金類別(0:全部 1:境內 2:境外)
                    XSWIFT_CODE, --swift code
                    'TWN', --FATCA國籍代號
                    -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                    OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名(受益人英文戶名)
                    '04', --帳戶保管平台代號(01.空白 04.集保)
                    'A', --受益人集保開戶資料上傳註記
                    XTDCC_VALID_FROM --受益人集保帳號生效日
                   );
            END;
            END IF;
        END;
        END IF;
      END;


      dbms_output.put_line('FAS.HOLDER_BANK 系列 END');

      dbms_output.put_line('FAS.HOLDER_BANK_EC 系列 BEGIN');

      --3.7 將舊戶變更已審核完成的扣款帳號資料更新受益人扣款帳號檔(FAS.HOLDER_BANK_EC)
      --    原則上一定有集保台幣/MMA帳號,不一定有集保外幣帳號
      --3.7.1 財金-台幣
      IF LTRIM(OLD_REC.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN
        BEGIN --取得財金-台幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK_EC  財金-台幣  同幣別同帳號');
        dbms_output.put_line(' WHERE AC_BANK = OLD_REC.FIS_BANK_NO_TWD = ' || OLD_REC.FIS_BANK_NO_TWD);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD = ' || OLD_REC.FIS_AC_CODE_TWD);
        dbms_output.put_line('   AND DEPOSITORY_NO = 01');
        dbms_output.put_line('   AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD = ' || OLD_REC.FIS_CURRENCY_NO_TWD);
        dbms_output.put_line('   AND VERIFIED >= SELECT FIS_SEAL_DATE FROM ECS.SYSTEM_PARAMETER');

       -- 2018.11.29 JIANXIN MOD BY 若財金台幣不存在，則新增台幣帳號
       --同幣別同帳號
        UPDATE FAS.HOLDER_BANK_EC
           -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
           SET DELIVERED = CASE WHEN DELIVERED IS NULL THEN XSYS_DTTM ELSE DELIVERED END --若"送交核印日"為空白時，則更新"送交核印日",否則不異動也不新增
         WHERE ID = OLD_REC.ID
           AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD
           AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
           AND DEPOSITORY_NO = '01'
           AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD
           -- 2019.06.17 tingting 新增判斷，財金-台幣若核印完成日期在2016/12/1前，需新增一筆”提高扣款額度”之異動資料
           AND (VERIFIED IS NULL OR
                VERIFIED >= (SELECT FIS_SEAL_DATE FROM ECS.SYSTEM_PARAMETER));      --核印完成日期
        IF SQL%NOTFOUND THEN --同帳號不同幣別或不同帳號或找不到財金帳號
          BEGIN
            SELECT * INTO HOLDER_BANK_EC_REC
              FROM FAS.HOLDER_BANK_EC
             WHERE ID = OLD_REC.ID
               -- 2019.06.18 tingting 新增判斷，若客戶原有"其他銀行"平台之扣款帳號，應新增一筆"變更扣款帳號"之異動資料，變更扣款帳號為財金帳號，不是二者同時存在
               AND DEPOSITORY_NO IN ('01','02')
               AND CURRENCY_NO IN ('MMA','NTD');

            dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC_CHANGE  財金-台幣  更新不到資料才INSERT  同帳號不同幣別或不同帳號或找不到財金帳號');
            dbms_output.put_line('  VALUES AC_BANK = HOLDER_BANK_EC_REC.AC_BANK = ' || HOLDER_BANK_EC_REC.AC_BANK);
            dbms_output.put_line('  VALUES AC_BRANCH = HOLDER_BANK_EC_REC.AC_BRANCH = ' || HOLDER_BANK_EC_REC.AC_BRANCH);
            dbms_output.put_line('  VALUES AC_CODE = HOLDER_BANK_EC_REC.AC_CODE = ' || HOLDER_BANK_EC_REC.AC_CODE);
            dbms_output.put_line('  VALUES LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
            dbms_output.put_line('  VALUES DEPOSITORY_NO_OLD = HOLDER_BANK_EC_REC.DEPOSITORY_NO = ' || HOLDER_BANK_EC_REC.DEPOSITORY_NO);

            --有集保台幣/MMA帳號,寫入"扣款帳號變更記錄檔"
            INSERT INTO FAS.HOLDER_BANK_EC_CHANGE
                  (ID,NEW_AC_BANK,NEW_AC_BRANCH,NEW_AC_CODE,NEW_AC_NAME,NEW_FIS_SNAME,AC_BANK,AC_BRANCH,AC_CODE,
                   AC_NAME,FIS_SNAME,DELIVERED,EMP_NO,LAST_MODIFIED,DEPOSITORY_NO,CURRENCY_NO,CURRENCY_NO_OLD,DEPOSITORY_NO_OLD)
              VALUES
                  (OLD_REC.ID,  --受益人ID
                   OLD_REC.FIS_BANK_NO_TWD,  --往來銀行(新)
                   OLD_REC.FIS_BRANCH_NO_TWD,  --往來分行(新)
                   OLD_REC.FIS_AC_CODE_TWD,  --往來帳號(新)
                   OLD_REC.NAME,  --帳號名稱(新)
                   XSNAME,  --往來銀行簡稱(新)
                   HOLDER_BANK_EC_REC.AC_BANK,  --往來銀行
                   HOLDER_BANK_EC_REC.AC_BRANCH,  --往來分行
                   HOLDER_BANK_EC_REC.AC_CODE,  --往來帳號
                   HOLDER_BANK_EC_REC.AC_NAME,  --帳號名稱
                   HOLDER_BANK_EC_REC.FIS_SNAME,  --往來銀行簡稱
                   -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                   XSYS_DTTM,  --送交核印日期
                   OLD_REC.UPDATEID, --員工代碼
                   -- 2019.06.04 tingting 調整FAS.HOLDER_BANK_EC_CHANGE最後修改日，含有時分秒
                   XSYS_DTTM, --最後修改日
                   '01',  --帳戶保管平台代號
                   -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                   -- 2019.06.13 tingting 還原帳戶幣別的判斷
                   /*
                   CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                        THEN 'MMA'
                        ELSE OLD_REC.TDCC_CURRENCY_NO
                        END, --幣別
                   */
                   OLD_REC.FIS_CURRENCY_NO_TWD,  --幣別
                   HOLDER_BANK_EC_REC.CURRENCY_NO,  --幣別-舊
                   HOLDER_BANK_EC_REC.DEPOSITORY_NO --帳戶保管平台代號-舊
                  );
          EXCEPTION
            WHEN NO_DATA_FOUND THEN --無財金台幣/MMA帳號,則寫入"扣款帳號檔"

              dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC  財金-台幣  INSERT INTO FAS.HOLDER_BANK_EC_CHANGE不到資料才INSERT  無財金台幣/MMA帳號,則寫入"扣款帳號檔"');
              dbms_output.put_line('  VALUES AC_BANK = OLD_REC.FIS_BANK_NO_TWD = ' || OLD_REC.FIS_BANK_NO_TWD);
              dbms_output.put_line('  VALUES FIS_BRANCH_NO_TWD = OLD_REC.FIS_BRANCH_NO_TWD = ' || OLD_REC.FIS_BRANCH_NO_TWD);
              dbms_output.put_line('  VALUES AC_CODE = OLD_REC.FIS_AC_CODE_TWD = ' || OLD_REC.FIS_AC_CODE_TWD);
              dbms_output.put_line('  VALUES DEPOSITORY_NO = 01');
              dbms_output.put_line('  VALUES CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD = ' || OLD_REC.FIS_CURRENCY_NO_TWD);

              INSERT INTO FAS.HOLDER_BANK_EC
                     (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,CURRENCY_NO,DEPOSITORY_NO)
              VALUES (OLD_REC.ID,
                      OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                      OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                      OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                      OLD_REC.NAME, --帳號名稱
                      XSNAME, --往來銀行簡稱
                      -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                      XSYS_DTTM, --送交核印日期(即轉入FAS.HOLDER的日期)
                      -- 2019.06.04 JIANXIN 調整幣別
                      OLD_REC.FIS_CURRENCY_NO_TWD, --幣別
                      '01' --帳戶保管平台代號
                     );  

              -- 2021.12.23 Chengyu 若舊戶RSP契約已存在扣款帳號資料，則寫入送核時間與完成核印日期   BEGIN
              SELECT COUNT(1)
                INTO XCOUNT
                FROM FAS.PERIODIC
               WHERE ID = OLD_REC.ID
                 AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD
                 AND AC_BRANCH = OLD_REC.FIS_BRANCH_NO_TWD
                 AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
                 AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;

              -- 2023.04.19 JIANXIN 調整傳統定額取得多筆資料，造成後續錯誤，故而調整同帳號，只取得最後核印狀況
              MERGE INTO FAS.HOLDER_BANK_EC MAIN
              USING
              (
                SELECT ID
                      ,AC_BANK
                      ,AC_BRANCH
                      ,AC_CODE
                      ,AC_NAME
                      ,CURRENCY_NO
                      ,DELIVERED
                      ,VERIFIED
                 FROM FAS.PERIODIC
                WHERE ID = OLD_REC.ID
                  AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD
                  AND AC_BRANCH = OLD_REC.FIS_BRANCH_NO_TWD
                  AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
                  AND ROWNUM = 1
                ORDER BY VERIFIED DESC
              )DATA
              ON (DATA.ID = MAIN.ID
             AND DATA.AC_BANK = MAIN.AC_BANK
             AND DATA.AC_BRANCH = MAIN.AC_BRANCH
             AND DATA.AC_CODE = MAIN.AC_CODE
             AND DATA.CURRENCY_NO = MAIN.CURRENCY_NO)
            WHEN MATCHED THEN UPDATE SET
                  MAIN.DELIVERED = DATA.DELIVERED
                 ,MAIN.VERIFIED = DATA.VERIFIED;

              IF XCOUNT > 0 THEN

                INSERT INTO FAS.HOLDER_BANK_EC_CHANGE
                       (ID,NEW_AC_BANK,NEW_AC_BRANCH,NEW_AC_CODE,NEW_AC_NAME,NEW_FIS_SNAME,AC_BANK,AC_BRANCH,AC_CODE,
                        AC_NAME,FIS_SNAME,DELIVERED,EMP_NO,LAST_MODIFIED,DEPOSITORY_NO,CURRENCY_NO,CURRENCY_NO_OLD,DEPOSITORY_NO_OLD)
                VALUES (OLD_REC.ID,  --受益人ID
                        OLD_REC.FIS_BANK_NO_TWD,  --往來銀行(新)
                        OLD_REC.FIS_BRANCH_NO_TWD,  --往來分行(新)
                        OLD_REC.FIS_AC_CODE_TWD,  --往來帳號(新)
                        OLD_REC.NAME,  --帳號名稱(新)
                        XSNAME,  --往來銀行簡稱(新)
                        OLD_REC.FIS_BANK_NO_TWD,  --往來銀行
                        OLD_REC.FIS_BRANCH_NO_TWD,  --往來分行
                        OLD_REC.FIS_AC_CODE_TWD,  --往來帳號
                        OLD_REC.NAME,  --帳號名稱
                        XSNAME,  --往來銀行簡稱
                        XSYS_DTTM,  --送交核印日期
                        OLD_REC.UPDATEID, --員工代碼
                        XSYS_DTTM, --最後修改日
                        '01',  --帳戶保管平台代號
                        OLD_REC.FIS_CURRENCY_NO_TWD,  --幣別
                        OLD_REC.FIS_CURRENCY_NO_TWD,  --幣別-舊
                        '01'  --帳戶保管平台代號-舊                        
                       );
              END IF;
              -- 2021.12.23 Chengyu 若舊戶RSP契約已存在扣款帳號資料，則寫入送核時間與完成核印日期   END

            END;
        END IF;

        -- 2019.06.14 tingting 因加開"04.瑞萬"或實體戶升級EC戶的部份，已經在其他地方處理過了，故註解掉
        /*
        --加開"04.瑞萬"或實體戶升級EC戶
        IF XCOUNT_AMC04 = 0 OR XIS_TO_EC <> 0 THEN
          BEGIN

            --寫LOG用
            BEGIN
                SELECT AC_BANK,  --往來銀行
                       AC_BRANCH,  --往來分行
                       AC_CODE,  --往來帳號
                       DEPOSITORY_NO DEPOSITORY_NO_OLD  --帳戶保管平台代號-舊
                  INTO XLOG_AC_BANK,
                       XLOG_AC_BRANCH,
                       XLOG_AC_CODE,
                       XLOG_DEPOSITORY_NO_OLD
                  FROM FAS.HOLDER_BANK_EC
                 WHERE ID = OLD_REC.ID
                   --AND DEPOSITORY_NO IN ('01')
                   ---- 2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
                   --AND (  (AC_BANK <> OLD_REC.FIS_BANK_NO_TWD AND AC_BANK IS NOT NULL)
                   --    OR (AC_CODE <> OLD_REC.FIS_AC_CODE_TWD AND AC_CODE IS NOT NULL)
                   --    OR (CURRENCY_NO <> OLD_REC.FIS_CURRENCY_NO_TWD AND CURRENCY_NO IS NOT NULL)
                   --    )
                   -- 2019.06.04 tingting 還原2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
                   AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD
                   AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
                   AND DEPOSITORY_NO IN ('01')
                   AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD
                   AND ROWNUM = 1;
              EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    XLOG_AC_BANK := '';
                    XLOG_AC_BRANCH := '';
                    XLOG_AC_CODE := '';
                    XLOG_DEPOSITORY_NO_OLD := '';
            END;
            dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC_CHANGE  財金-台幣  加開"04.瑞萬"或實體戶升級EC戶');
            dbms_output.put_line('  VALUES AC_BANK = XLOG_AC_BANK = ' || XLOG_AC_BANK);
            dbms_output.put_line('  VALUES AC_BRANCH = XLOG_AC_BRANCH = ' || XLOG_AC_BRANCH);
            dbms_output.put_line('  VALUES AC_CODE = XLOG_AC_CODE = ' || XLOG_AC_CODE);
            dbms_output.put_line('  VALUES LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
            dbms_output.put_line('  VALUES DEPOSITORY_NO_OLD = XLOG_DEPOSITORY_NO_OLD = ' || XLOG_DEPOSITORY_NO_OLD);

            --己有約定帳號，則寫入"扣款帳號變更記錄檔"
            INSERT INTO FAS.HOLDER_BANK_EC_CHANGE
                  (ID,NEW_AC_BANK,NEW_AC_BRANCH,NEW_AC_CODE,NEW_AC_NAME,NEW_FIS_SNAME,AC_BANK,AC_BRANCH,AC_CODE,
                   AC_NAME,FIS_SNAME,DELIVERED,EMP_NO,LAST_MODIFIED,DEPOSITORY_NO,CURRENCY_NO,CURRENCY_NO_OLD,DEPOSITORY_NO_OLD)
            SELECT OLD_REC.ID,  --受益人ID
                   AC_BANK NEW_AC_BANK,  --往來銀行(新)
                   AC_BRANCH NEW_AC_BRANCH,  --往來分行(新)
                   AC_CODE NEW_AC_CODE,  --往來帳號(新)
                   AC_NAME NEW_AC_NAME,  --帳號名稱(新)
                   FIS_SNAME NEW_FIS_SNAME,  --往來銀行簡稱(新)
                   AC_BANK,  --往來銀行
                   AC_BRANCH,  --往來分行
                   AC_CODE,  --往來帳號
                   AC_NAME,  --帳號名稱
                   FIS_SNAME,  --往來銀行簡稱
                   -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                   XSYS_DTTM DELIVERED,  --送交核印日期
                   OLD_REC.UPDATEID EMP_NO, --員工代碼
                   -- 2019.06.04 tingting 調整FAS.HOLDER_BANK_EC_CHANGE最後修改日，含有時分秒
                   XSYS_DTTM LAST_MODIFIED, --最後修改日
                   -- 2019.06.04 tingting 調整加開"04.瑞萬"寫入平台代碼錯誤(01→04)
                   '04' DEPOSITORY_NO,  --帳戶保管平台代號
                   CURRENCY_NO,  --幣別
                   CURRENCY_NO CURRENCY_NO_OLD,  --幣別-舊
                   DEPOSITORY_NO DEPOSITORY_NO_OLD  --帳戶保管平台代號-舊
              FROM FAS.HOLDER_BANK_EC
             WHERE ID = OLD_REC.ID
               --AND DEPOSITORY_NO IN ('01')
               ---- 2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
               --AND (  (AC_BANK <> OLD_REC.FIS_BANK_NO_TWD AND AC_BANK IS NOT NULL)
               --    OR (AC_CODE <> OLD_REC.FIS_AC_CODE_TWD AND AC_CODE IS NOT NULL)
               --    OR (CURRENCY_NO <> OLD_REC.FIS_CURRENCY_NO_TWD AND CURRENCY_NO IS NOT NULL)
               --    )
               -- 2019.06.04 tingting 還原2019.05.14 JIANXIN MOD 若總行、銀行帳號、幣別不為空白，且總行、銀行帳號、幣別不相等，則寫入一筆異動檔；若從未核印過，則無需寫入扣款帳號異動檔
               AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD
               AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD
               AND DEPOSITORY_NO IN ('01')
               AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD
               AND ROWNUM = 1;
          EXCEPTION
            WHEN NO_DATA_FOUND THEN  --無約定帳號，則寫入"扣款帳號檔"

              dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC  財金-台幣  新增不到資料才INSERT  無約定帳號，則寫入"扣款帳號檔"');
              dbms_output.put_line('  VALUES AC_BANK = OLD_REC.FIS_BANK_NO_TWD = ' || OLD_REC.FIS_BANK_NO_TWD);
              dbms_output.put_line('  VALUES AC_CODE = OLD_REC.FIS_AC_CODE_TWD = ' || OLD_REC.FIS_AC_CODE_TWD);
              dbms_output.put_line('  VALUES DEPOSITORY_NO = 01');
              dbms_output.put_line('  VALUES CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD = ' || OLD_REC.FIS_CURRENCY_NO_TWD);

              INSERT INTO FAS.HOLDER_BANK_EC
                    (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,CURRENCY_NO,DEPOSITORY_NO)
                VALUES
                    (OLD_REC.ID,
                     OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                     OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                     OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                     OLD_REC.NAME, --帳號名稱
                     XSNAME, --往來銀行簡稱
                     -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                     XSYS_DTTM, --送交核印日期(即轉入FAS.HOLDER的日期)
                     OLD_REC.FIS_CURRENCY_NO_TWD, --幣別
                     -- 2019.06.04 tingting 調整加開"04.瑞萬"寫入平台代碼錯誤(01→04)
                     '04' --帳戶保管平台代號
                    );
          END;
        END IF;
        */
      END IF;

      --3.7.2 財金-外幣
      -- 2018.12.14 JIANXIN MOD BY 調整舊戶加開內容
      IF LTRIM(OLD_REC.FIS_BANK_NO_TWD_FCY) IS NOT NULL AND XFIS_BANK_NO_TWD_FCY= 'Y' THEN
        BEGIN --取得財金-外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        --寫LOG用
        BEGIN
            SELECT COUNT(1)
              INTO XDATA_CNT
              FROM FAS.HOLDER_BANK_EC
             WHERE ID = OLD_REC.ID
               AND AC_BANK = OLD_REC.FIS_BANK_NO_TWD_FCY
               AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY
               AND DEPOSITORY_NO IN ('01')
               AND (CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY)
               AND ROWNUM = 1;
        END;
        /*
        dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC_CHANGE  財金-外幣  加開"04.瑞萬"或實體戶升級EC戶');
        dbms_output.put_line('  VALUES AC_BANK = XLOG_AC_BANK = ' || XLOG_AC_BANK);
        dbms_output.put_line('  VALUES AC_BRANCH = XLOG_AC_BRANCH = ' || XLOG_AC_BRANCH);
        dbms_output.put_line('  VALUES AC_CODE = XLOG_AC_CODE = ' || XLOG_AC_CODE);
        dbms_output.put_line('  VALUES LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
        dbms_output.put_line('  VALUES DEPOSITORY_NO_OLD = XLOG_DEPOSITORY_NO_OLD = ' || XLOG_DEPOSITORY_NO_OLD);
        */           
        -- 2022.01.07 Chengyu 修正帳號沒新增問題
        --因不曉得原本邏輯為何，故再最後新增判斷是否需要新增(邏輯參考ECS.F_ECSB007_GetBankA)
        IF NVL(XDATA_CNT,0) = 0 THEN
          BEGIN              
            INSERT INTO FAS.HOLDER_BANK_EC
                  (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,CURRENCY_NO,DEPOSITORY_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                   XSYS_DTTM, --送交核印日期(即轉入FAS.HOLDER的日期)
                   OLD_REC.FIS_CURRENCY_NO_FCY, --幣別
                   -- 2019.06.04 tingting 調整加開"04.瑞萬"寫入平台代碼錯誤(01→04)
                   '01' --帳戶保管平台代號
                  );
          END;
        END IF;

      END IF;

      --3.7.3 集保-台幣/MMA
      IF LTRIM(OLD_REC.TDCC_CURRENCY_NO) IS NOT NULL THEN
        BEGIN --取得集保-台幣/MMA存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK_EC  集保-台幣/MMA  同幣別同帳號');
        dbms_output.put_line(' WHERE AC_BANK = OLD_REC.TDCC_BANK_NO = ' || OLD_REC.TDCC_BANK_NO);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.TDCC_AC_CODE = ' || OLD_REC.TDCC_AC_CODE);
        dbms_output.put_line('   AND DEPOSITORY_NO = 04');
        dbms_output.put_line('   AND CURRENCY_NO = MMA OR OLD_REC.TDCC_CURRENCY_NO = ' || CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND
                                                                                                    OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND
                                                                                                    OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                                                                               THEN 'MMA'
                                                                                               ELSE OLD_REC.TDCC_CURRENCY_NO
                                                                                               END);

        --同幣別同帳號
        UPDATE FAS.HOLDER_BANK_EC
           -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
           SET DELIVERED = CASE WHEN DELIVERED IS NULL THEN XSYS_DTTM ELSE DELIVERED END --若"送交核印日"為空白時，則更新"送交核印日",否則不異動也不新增
         WHERE ID = OLD_REC.ID
           AND AC_BANK = OLD_REC.TDCC_BANK_NO
           AND AC_CODE = OLD_REC.TDCC_AC_CODE
           AND DEPOSITORY_NO = '04'
           -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
           AND CURRENCY_NO = CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                  THEN 'MMA'
                                  ELSE OLD_REC.TDCC_CURRENCY_NO
                                  END;
        IF SQL%NOTFOUND THEN --同帳號不同幣別或不同帳號或找不到集保帳號
          BEGIN
            SELECT * INTO HOLDER_BANK_EC_REC
              FROM FAS.HOLDER_BANK_EC
             WHERE ID = OLD_REC.ID
               AND DEPOSITORY_NO = '04'
               AND CURRENCY_NO IN ('MMA','NTD');

            dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC_CHANGE  集保-台幣/MMA  UPDATE不到同幣別同帳號資料的送交核印日期 才INSERT 同帳號不同幣別或不同帳號或找不到集保帳號');
            dbms_output.put_line('  VALUES AC_BANK = HOLDER_BANK_EC_REC.AC_BANK = ' || HOLDER_BANK_EC_REC.AC_BANK);
            dbms_output.put_line('  VALUES AC_BRANCH = OLD_REC.TDCC_BRANCH_NO = ' || OLD_REC.TDCC_BRANCH_NO);
            dbms_output.put_line('  VALUES AC_CODE = HOLDER_BANK_EC_REC.AC_CODE = ' || HOLDER_BANK_EC_REC.AC_CODE);
            dbms_output.put_line('  VALUES LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
            dbms_output.put_line('  VALUES DEPOSITORY_NO_OLD = HOLDER_BANK_EC_REC.DEPOSITORY_NO' || HOLDER_BANK_EC_REC.DEPOSITORY_NO);

            --有集保台幣/MMA帳號,寫入"扣款帳號變更記錄檔"
            INSERT INTO FAS.HOLDER_BANK_EC_CHANGE
                  (ID,NEW_AC_BANK,NEW_AC_BRANCH,NEW_AC_CODE,NEW_AC_NAME,NEW_FIS_SNAME,AC_BANK,AC_BRANCH,AC_CODE,
                   AC_NAME,FIS_SNAME,DELIVERED,EMP_NO,LAST_MODIFIED,DEPOSITORY_NO,CURRENCY_NO,CURRENCY_NO_OLD,DEPOSITORY_NO_OLD)
              VALUES
                  (OLD_REC.ID,  --受益人ID
                   OLD_REC.TDCC_BANK_NO,  --往來銀行(新)
                   OLD_REC.TDCC_BRANCH_NO,  --往來分行(新)
                   OLD_REC.TDCC_AC_CODE,  --往來帳號(新)
                   OLD_REC.NAME,  --帳號名稱(新)
                   XSNAME,  --往來銀行簡稱(新)
                   HOLDER_BANK_EC_REC.AC_BANK,  --往來銀行
                   HOLDER_BANK_EC_REC.AC_BRANCH,  --往來分行
                   HOLDER_BANK_EC_REC.AC_CODE,  --往來帳號
                   HOLDER_BANK_EC_REC.AC_NAME,  --帳號名稱
                   HOLDER_BANK_EC_REC.FIS_SNAME,  --往來銀行簡稱
                   -- 2018.11.29 JIANXIN MOD BY 調整送交核印日期
                   -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                   XSYS_DTTM,  --送交核印日期
                   OLD_REC.UPDATEID, --員工代碼
                   -- 2019.06.04 tingting 調整FAS.HOLDER_BANK_EC_CHANGE最後修改日，含有時分秒
                   XSYS_DTTM, --最後修改日
                   '04',  --帳戶保管平台代號
                   -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                   CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                        THEN 'MMA'
                        ELSE OLD_REC.TDCC_CURRENCY_NO
                        END,  --幣別
                   HOLDER_BANK_EC_REC.CURRENCY_NO,  --幣別-舊
                   HOLDER_BANK_EC_REC.DEPOSITORY_NO --帳戶保管平台代號-舊
                  );
          EXCEPTION
            WHEN NO_DATA_FOUND THEN --無集保台幣/MMA帳號,則寫入"扣款帳號檔"

              dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC  集保-台幣/MMA  新增不到資料才INSERT 無集保台幣/MMA帳號,則寫入"扣款帳號檔"');
              dbms_output.put_line('  VALUES AC_BANK = OLD_REC.TDCC_BANK_NO = ' || OLD_REC.TDCC_BANK_NO);
              dbms_output.put_line('  VALUES AC_CODE = OLD_REC.TDCC_AC_CODE = ' || OLD_REC.TDCC_AC_CODE);
              dbms_output.put_line('  VALUES DEPOSITORY_NO = 04');
              dbms_output.put_line('  VALUES CURRENCY_NO = MMA OR OLD_REC.TDCC_CURRENCY_NO = ' || CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                                                                                       THEN 'MMA'
                                                                                                       ELSE OLD_REC.TDCC_CURRENCY_NO
                                                                                                       END);

              INSERT INTO FAS.HOLDER_BANK_EC
                    (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,CURRENCY_NO,DEPOSITORY_NO)
                VALUES
                    (OLD_REC.ID,
                     OLD_REC.TDCC_BANK_NO, --往來銀行
                     OLD_REC.TDCC_BRANCH_NO, --往來分行
                     OLD_REC.TDCC_AC_CODE, --往來帳號
                     OLD_REC.NAME, --帳號名稱
                     XSNAME, --往來銀行簡稱
                     -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                     XSYS_DTTM, --送交核印日期(即轉入FAS.HOLDER的日期)
                     -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                     CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                          THEN 'MMA'
                          ELSE OLD_REC.TDCC_CURRENCY_NO
                          END, --幣別
                     '04' --帳戶保管平台代號
                    );
            END;
        END IF;
      END IF;

      --3.7.4 集保-外幣
      IF LTRIM(OLD_REC.TDCC_CURRENCY_NO_FCY) IS NOT NULL THEN
        BEGIN --取得集保-台幣/MMA存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK_EC  集保-外幣  同幣別同帳號');
        dbms_output.put_line(' WHERE AC_BANK = OLD_REC.TDCC_BANK_NO_TWD_FCY = ' || OLD_REC.TDCC_BANK_NO_TWD_FCY);
        dbms_output.put_line('   AND AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY = ' || OLD_REC.TDCC_AC_CODE_TWD_FCY);
        dbms_output.put_line('   AND DEPOSITORY_NO = 04');
        dbms_output.put_line('   AND CURRENCY_NO = MMA OR OLD_REC.TDCC_CURRENCY_NO_FCY = ' || CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND
                                                                                                        OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND
                                                                                                        OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                                                                                   THEN 'MMA'
                                                                                                   ELSE OLD_REC.TDCC_CURRENCY_NO_FCY
                                                                                                   END);

        --同幣別同帳號
        UPDATE FAS.HOLDER_BANK_EC
           -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
           SET DELIVERED = CASE WHEN DELIVERED IS NULL THEN XSYS_DTTM ELSE DELIVERED END --若"送交核印日"為空白時，則更新"送交核印日",否則不異動也不新增
         WHERE ID = OLD_REC.ID
           AND AC_BANK = OLD_REC.TDCC_BANK_NO_TWD_FCY
           AND AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY
           AND DEPOSITORY_NO = '04'
           -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
           AND CURRENCY_NO = CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                  THEN 'MMA'
                                  ELSE OLD_REC.TDCC_CURRENCY_NO_FCY
                                  END;
        IF SQL%NOTFOUND THEN --同帳號不同幣別或不同帳號或找不到集保帳號
          BEGIN
            SELECT * INTO HOLDER_BANK_EC_REC
              FROM FAS.HOLDER_BANK_EC
             WHERE ID = OLD_REC.ID
               AND DEPOSITORY_NO = '04'
               AND CURRENCY_NO NOT IN ('MMA','NTD');

            dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC_CHANGE  集保-外幣  UPDATE不到同幣別同帳號的送交核印日 才INSERT 同帳號不同幣別或不同帳號或找不到集保帳號');
            dbms_output.put_line('  VALUES AC_BANK = HOLDER_BANK_EC_REC.AC_BANK = ' || HOLDER_BANK_EC_REC.AC_BANK);
            dbms_output.put_line('  VALUES AC_BRANCH = HOLDER_BANK_EC_REC.AC_BRANCH = ' || HOLDER_BANK_EC_REC.AC_BRANCH);
            dbms_output.put_line('  VALUES AC_CODE = HOLDER_BANK_EC_REC.AC_CODE = ' || HOLDER_BANK_EC_REC.AC_CODE);
            dbms_output.put_line('  VALUES LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
            dbms_output.put_line('  VALUES DEPOSITORY_NO_OLD = HOLDER_BANK_EC_REC.DEPOSITORY_NO = ' || HOLDER_BANK_EC_REC.DEPOSITORY_NO);

            --有集保外幣帳號,寫入"扣款帳號變更記錄檔"
            INSERT INTO FAS.HOLDER_BANK_EC_CHANGE
                  (ID,NEW_AC_BANK,NEW_AC_BRANCH,NEW_AC_CODE,NEW_AC_NAME,NEW_FIS_SNAME,AC_BANK,AC_BRANCH,AC_CODE,
                   AC_NAME,FIS_SNAME,DELIVERED,EMP_NO,LAST_MODIFIED,DEPOSITORY_NO,CURRENCY_NO,CURRENCY_NO_OLD,DEPOSITORY_NO_OLD)
              VALUES
                  (OLD_REC.ID,  --受益人ID
                   OLD_REC.TDCC_BANK_NO_TWD_FCY,  --往來銀行(新)
                   OLD_REC.TDCC_BRANCH_NO_TWD_FCY,  --往來分行(新)
                   OLD_REC.TDCC_AC_CODE_TWD_FCY,  --往來帳號(新)
                   OLD_REC.NAME,  --帳號名稱(新)
                   XSNAME,  --往來銀行簡稱(新)
                   HOLDER_BANK_EC_REC.AC_BANK,  --往來銀行
                   HOLDER_BANK_EC_REC.AC_BRANCH,  --往來分行
                   HOLDER_BANK_EC_REC.AC_CODE,  --往來帳號
                   HOLDER_BANK_EC_REC.AC_NAME,  --帳號名稱
                   HOLDER_BANK_EC_REC.FIS_SNAME,  --往來銀行簡稱
                   -- 2018.11.29 JIANXIN MOD BY 調整送交核印日期
                   -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                   XSYS_DTTM,  --送交核印日期
                   OLD_REC.UPDATEID, --員工代碼
                   -- 2019.06.04 tingting 調整FAS.HOLDER_BANK_EC_CHANGE最後修改日，含有時分秒
                   XSYS_DTTM, --最後修改日
                   '04',  --帳戶保管平台代號
                   -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                   CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                        THEN 'MMA'
                        ELSE OLD_REC.TDCC_CURRENCY_NO_FCY
                        END,  --幣別
                   HOLDER_BANK_EC_REC.CURRENCY_NO,  --幣別-舊
                   HOLDER_BANK_EC_REC.DEPOSITORY_NO --帳戶保管平台代號-舊
                  );
          EXCEPTION
            WHEN NO_DATA_FOUND THEN --無集保外幣帳號,則寫入"扣款帳號檔"

              dbms_output.put_line('INSERT INTO FAS.HOLDER_BANK_EC  集保-外幣  新增不到資料才INSERT  無集保外幣帳號,則寫入"扣款帳號檔" ');
              dbms_output.put_line('  VALUES AC_BANK = OLD_REC.TDCC_BANK_NO_TWD_FCY = ' || OLD_REC.TDCC_BANK_NO_TWD_FCY);
              dbms_output.put_line('  VALUES AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY = ' || OLD_REC.TDCC_AC_CODE_TWD_FCY);
              dbms_output.put_line('  VALUES DEPOSITORY_NO = 04');
              dbms_output.put_line('  VALUES CURRENCY_NO = MMA OR OLD_REC.TDCC_CURRENCY_NO_FCY = ' || CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                                                                                                           THEN 'MMA'
                                                                                                           ELSE OLD_REC.TDCC_CURRENCY_NO_FCY
                                                                                                           END);

              INSERT INTO FAS.HOLDER_BANK_EC
                    (ID,AC_BANK,AC_BRANCH,AC_CODE,AC_NAME,FIS_SNAME,DELIVERED,CURRENCY_NO,DEPOSITORY_NO)
                VALUES
                    (OLD_REC.ID,
                     OLD_REC.TDCC_BANK_NO_TWD_FCY, --往來銀行
                     OLD_REC.TDCC_BRANCH_NO_TWD_FCY, --往來分行
                     OLD_REC.TDCC_AC_CODE_TWD_FCY, --往來帳號
                     OLD_REC.NAME, --帳號名稱
                     XSNAME, --往來銀行簡稱
                     -- 2020.08.10 tingting 因應線上開戶調整：調整送交核印日期含有時分秒、增加更新核印完成日期、財金核印完成回覆日
                     XSYS_DTTM, --送交核印日期(即轉入FAS.HOLDER的日期)
                     -- 2019.06.10 JIANXIN 調整帳戶幣別的判斷
                     CASE WHEN OLD_REC.TDCC_BANK_NO_TWD_FCY = OLD_REC.TDCC_BANK_NO AND OLD_REC.TDCC_BRANCH_NO_TWD_FCY = OLD_REC.TDCC_BRANCH_NO AND OLD_REC.TDCC_AC_CODE_TWD_FCY = OLD_REC.TDCC_AC_CODE
                          THEN 'MMA'
                          ELSE OLD_REC.TDCC_CURRENCY_NO_FCY
                          END, --幣別
                     '04' --帳戶保管平台代號
                    );
          END;
        END IF;
      END IF;

      dbms_output.put_line('FAS.HOLDER_BANK_EC 系列 END');

      dbms_output.put_line('FAS.HOLDER_DIVIDEN 系列 BEGIN');

      dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND BEGIN');

      --3.8 將舊戶變更已審核完成的配息設定資料更新受益人配息設定檔(FAS.HOLDER_DIVIDEND)
      --若存在則更新,不存在新增
      UPDATE FAS.HOLDER_DIVIDEND
         SET REVISED_BY = 'ECS',
             REVISION_DATE = XSYS_DTTM,
             REVIEWED_BY = 'ECS',
             REVIEW_DATE = XSYS_DTTM,
             STATUS = 'R'
       WHERE ID = OLD_REC.ID;
      IF SQL%NOTFOUND THEN
        INSERT INTO FAS.HOLDER_DIVIDEND
              (ID,CREATED_BY,CREATION_DATE,REVISED_BY,REVISION_DATE,REVIEWED_BY,REVIEW_DATE,STATUS)
          VALUES
              (OLD_REC.ID,OLD_REC.CREATEID,OLD_REC.CREATEDATE,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE,OLD_REC.APPROVEID,OLD_REC.APPROVEDATE,'R');
      END IF;

      dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND END');

      --3.9 將舊戶變更已審核完成的配息設定資料更新基金公司配息設定檔(FAS.HOLDER_DIVIDEND_AMC)
      --3.9.1 01.瀚亞投信(境內)
      BEGIN
        SELECT * INTO HOLDER_DIVIDEND_AMC_REC
          FROM FAS.HOLDER_DIVIDEND_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '01';
        --找到時,若變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔
        IF HOLDER_DIVIDEND_AMC_REC.PAY_TYPE <> '3' OR
           HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.OMIT <> 'N' THEN

          dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE  AMC_NO = 01  將變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE
                (ID,AMC_NO,PAY_TYPE,FUND_NO_IN,PAY_ADDRESS,OMIT,REVISED_BY,REVISION_DATE)
            VALUES
                (OLD_REC.ID,'01',HOLDER_DIVIDEND_AMC_REC.PAY_TYPE,HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN,HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS,HOLDER_DIVIDEND_AMC_REC.OMIT,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE);
        END IF;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN --找不到瀚亞投信(境內),則新增一筆

          dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC  AMC_NO = 01');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC
                (ID,AMC_NO,PAY_TYPE,OMIT)
            VALUES
                (OLD_REC.ID,'01','3','N');
      END;

      --3.9.2 02.瀚亞投資(新加坡)
      BEGIN
        SELECT * INTO HOLDER_DIVIDEND_AMC_REC
          FROM FAS.HOLDER_DIVIDEND_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '02';
        --找到時,若變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔
        IF HOLDER_DIVIDEND_AMC_REC.PAY_TYPE <> '3' OR
           HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.OMIT <> 'N' THEN

           dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE  AMC_NO = 02  將變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE
                (ID,AMC_NO,PAY_TYPE,FUND_NO_IN,PAY_ADDRESS,OMIT,REVISED_BY,REVISION_DATE)
            VALUES
                (OLD_REC.ID,'02',HOLDER_DIVIDEND_AMC_REC.PAY_TYPE,HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN,HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS,HOLDER_DIVIDEND_AMC_REC.OMIT,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE);
        END IF;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN --找不到瀚亞投資(新加坡),則新增一筆

          dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC  AMC_NO = 02');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC
                (ID,AMC_NO,PAY_TYPE,OMIT)
            VALUES
                (OLD_REC.ID,'02','3','N');
      END;

      --3.9.3 03.M&G(新加坡)
      BEGIN
        SELECT * INTO HOLDER_DIVIDEND_AMC_REC
          FROM FAS.HOLDER_DIVIDEND_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '03';
        --找到時,若變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔
        IF HOLDER_DIVIDEND_AMC_REC.PAY_TYPE <> '4' OR
           HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.OMIT <> 'N' THEN

           dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE  AMC_NO = 03  將變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE
                (ID,AMC_NO,PAY_TYPE,FUND_NO_IN,PAY_ADDRESS,OMIT,REVISED_BY,REVISION_DATE)
            VALUES
                (OLD_REC.ID,'03',HOLDER_DIVIDEND_AMC_REC.PAY_TYPE,HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN,HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS,HOLDER_DIVIDEND_AMC_REC.OMIT,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE);
        END IF;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN --找不到M&G(新加坡)),則新增一筆

          dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC  AMC_NO = 03');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC
                (ID,AMC_NO,PAY_TYPE,OMIT)
            VALUES
                (OLD_REC.ID,'03','4','N');
      END;

      --3.9.4 04.瑞萬通博(TDCC)
      BEGIN
        SELECT * INTO HOLDER_DIVIDEND_AMC_REC
          FROM FAS.HOLDER_DIVIDEND_AMC
         WHERE ID = OLD_REC.ID
           AND AMC_NO = '04';
        --找到時,若變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔
        IF HOLDER_DIVIDEND_AMC_REC.PAY_TYPE <> '4' OR
           HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS IS NOT NULL OR
           HOLDER_DIVIDEND_AMC_REC.OMIT <> 'N' THEN

           dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE  AMC_NO = 04  將變更前後資料不一樣,須將變更前資料寫入基金公司配息設定變更檔');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE
                (ID,AMC_NO,PAY_TYPE,FUND_NO_IN,PAY_ADDRESS,OMIT,REVISED_BY,REVISION_DATE)
            VALUES
                (OLD_REC.ID,'04',HOLDER_DIVIDEND_AMC_REC.PAY_TYPE,HOLDER_DIVIDEND_AMC_REC.FUND_NO_IN,HOLDER_DIVIDEND_AMC_REC.PAY_ADDRESS,HOLDER_DIVIDEND_AMC_REC.OMIT,OLD_REC.UPDATEID,OLD_REC.UPDATEDATE);
        END IF;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN --找不到瑞萬通博(TDCC),則新增一筆

          dbms_output.put_line('INSERT INTO FAS.HOLDER_DIVIDEND_AMC  AMC_NO = 04');

          INSERT INTO FAS.HOLDER_DIVIDEND_AMC

                (ID,AMC_NO,PAY_TYPE,OMIT)
            VALUES
                (OLD_REC.ID,'04','4','N');
      END;

      --3.10 將舊戶變更已審核完成的配息帳號資料更新受益人配息帳號檔(FAS.HOLDER_DIVIDEND_BANK)
      --     現行規則：ID + 基金公司(AMC_NO) + 幣別，只能有一組配息帳號
      --3.10.1 財金-台幣
      IF LTRIM(OLD_REC.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN
        BEGIN --取得財金-台幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        --3.10.1.1 處理01.瀚亞投信(境內)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '01'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣  AMC_NO = 01');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN

            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'Y',
                   OFFSHORE = 'N',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '01'
               AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到瀚亞投信(境內),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'Y', --境內基金適用(Y,N)
                   'N', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_TWD,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '01' --基金經理公司(瀚亞投信(境內))
                  );
        END;

        --3.10.1.2 處理02.瀚亞投資(新加坡)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '02'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣  AMC_NO = 02');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   -- 2023.02.03 JIANXIN 調整瀚亞投資與M&G的基金公司，境內與境外寫反調整
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '02'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到瀚亞投資(新加坡),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'N', --境內基金適用(Y,N)
                   'Y', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_TWD,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '02' --基金經理公司(瀚亞投資(新加坡))
                  );
        END;

        --3.10.1.3 處理03.M&G(新加坡)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '03'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-台幣  AMC_NO = 03');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   -- 2023.02.03 JIANXIN 調整瀚亞投資與M&G的基金公司，境內與境外寫反調整
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '03'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_TWD;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到瀚亞投資(新加坡),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'N', --境內基金適用(Y,N)
                   'Y', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_TWD,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '03' --基金經理公司(M&G(新加坡))
                  );
        END;
      END IF;

      --3.10.2 財金-外幣
      IF LTRIM(OLD_REC.FIS_CURRENCY_NO_FCY) IS NOT NULL THEN
        BEGIN --取得財金-外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        --3.10.2.1 處理01.瀚亞投信(境內)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '01'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣  AMC_NO = 01');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'Y',
                   OFFSHORE = 'N',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '01'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到瀚亞投信(境內),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'Y', --境內基金適用(Y,N)
                   'N', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_FCY,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '01' --基金經理公司(瀚亞投信(境內))
                  );
        END;

        --3.10.2.2 處理02.瀚亞投資(新加坡)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '02'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣  AMC_NO = 02');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '02'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到瀚亞投資(新加坡),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'N', --境內基金適用(Y,N)
                   'Y', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_FCY,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '02' --基金經理公司(瀚亞投資(新加坡))
                  );
        END;

        --3.10.2.3 處理03.M&G(新加坡)
        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '03'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  財金-外幣  AMC_NO = 03');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.FIS_BANK_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.FIS_BRANCH_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.FIS_AC_CODE_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY,
                   BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY,
                   AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '03'
             AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到M&G(新加坡),則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                   OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                   OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'N', --境內基金適用(Y,N)
                   'Y', --境外基金適用(Y,N)
                   OLD_REC.FIS_CURRENCY_NO_FCY,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '03' --基金經理公司(瀚亞投資(新加坡))
                  );
        END;
      END IF;

      --3.10.3 集保-台幣/MMA
      IF LTRIM(OLD_REC.TDCC_CURRENCY_NO) IS NOT NULL THEN
        BEGIN --取得集保-台幣/MMA存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '04'
             AND CURRENCY_NO IN ('MMA','NTD');

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  集保-台幣/MMA  AMC_NO = 04');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.TDCC_BANK_NO OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.TDCC_BRANCH_NO OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.TDCC_AC_CODE OR
             HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO <> OLD_REC.TDCC_CURRENCY_NO OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.TDCC_BANK_NO,
                   BRANCH_NO = OLD_REC.TDCC_BRANCH_NO,
                   AC_CODE = OLD_REC.TDCC_AC_CODE,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '04'
               AND CURRENCY_NO IN ('MMA','NTD');

            --若找到的幣別為要由台幣改成MMA,則原配息帳號檔中若有外幣,則須將其寫入配息帳號變更檔後移除此筆
            IF HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO = 'NTD' AND OLD_REC.TDCC_CURRENCY_NO = 'MMA' THEN
              BEGIN
                SELECT * INTO HOLDER_DIVIDEND_BANK_NTD_REC
                  FROM FAS.HOLDER_DIVIDEND_BANK
                 WHERE ID = OLD_REC.ID
                   AND AMC_NO = '04'
                   AND CURRENCY_NO <> 'NTD';
                --若有外幣,則須將寫入配息帳號變更檔後移除此筆
                INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                      (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                       REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
                  VALUES
                      (OLD_REC.ID,
                       HOLDER_DIVIDEND_BANK_NTD_REC.BANK_NO,
                       HOLDER_DIVIDEND_BANK_NTD_REC.BRANCH_NO,
                       HOLDER_DIVIDEND_BANK_NTD_REC.AC_CODE,
                       HOLDER_DIVIDEND_BANK_NTD_REC.AC_NAME,
                       HOLDER_DIVIDEND_BANK_NTD_REC.FIS_SNAME,
                       HOLDER_DIVIDEND_BANK_NTD_REC.ONSHORE,
                       HOLDER_DIVIDEND_BANK_NTD_REC.OFFSHORE,
                       HOLDER_DIVIDEND_BANK_NTD_REC.CURRENCY_NO,
                       HOLDER_DIVIDEND_BANK_NTD_REC.ENAME,
                       HOLDER_DIVIDEND_BANK_NTD_REC.IBAN_CODE,
                       HOLDER_DIVIDEND_BANK_NTD_REC.REMARK,
                       'ECS',
                       XSYS_DTTM,
                       '加開帳戶，同時變更配息帳號',
                       HOLDER_DIVIDEND_BANK_NTD_REC.AMC_NO
                      );
                --移除此筆
                DELETE FROM FAS.HOLDER_DIVIDEND_BANK
                 WHERE ID = OLD_REC.ID
                   AND AMC_NO = '04'
                   AND CURRENCY_NO <> 'NTD';
              EXCEPTION
                WHEN NO_DATA_FOUND THEN
                  XID_AMC := NULL;
              END;
            END IF;
          END IF;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN --找不到則新增一筆
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   OLD_REC.TDCC_BANK_NO, --往來銀行
                   OLD_REC.TDCC_BRANCH_NO, --往來分行
                   OLD_REC.TDCC_AC_CODE, --往來帳號
                   OLD_REC.NAME, --帳號名稱
                   XSNAME, --往來銀行簡稱
                   'N', --境內基金適用(Y,N)
                   'Y', --境外基金適用(Y,N)
                   OLD_REC.TDCC_CURRENCY_NO,
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                   '04' --基金經理公司(瑞萬通博(TDCC))
                  );
        END;
      END IF;

      --3.10.4 集保-外幣
      IF LTRIM(OLD_REC.TDCC_CURRENCY_NO_FCY) IS NOT NULL THEN
        BEGIN --取得集保-外幣存款帳戶銀行簡稱
          -- 2018.11.29 JIANXIN MOD BY 調整至分行簡稱
          SELECT FIS_BRANCH.SNAME,FIS_BANK.SWIFT_CODE
            INTO XSNAME,XSWIFT_CODE
            FROM FAS.FIS_BRANCH
            JOIN FAS.FIS_BANK
              ON FIS_BRANCH.BANK_NO = FIS_BANK.BANK_NO
           WHERE FIS_BRANCH.BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY
             AND FIS_BRANCH.BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XSNAME := NULL;
            XSWIFT_CODE := NULL;
        END;

        BEGIN
          SELECT * INTO HOLDER_DIVIDEND_BANK_REC
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '04'
             AND CURRENCY_NO NOT IN ('MMA','NTD');

          dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK BEGIN  集保-外幣  AMC_NO = 04');

          --找到時,若變更前後資料不一樣,須將變更前資料寫入受益人配息帳號變更檔
          IF HOLDER_DIVIDEND_BANK_REC.BANK_NO <> OLD_REC.TDCC_BANK_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.BRANCH_NO <> OLD_REC.TDCC_BRANCH_NO_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_CODE <> OLD_REC.TDCC_AC_CODE_TWD_FCY OR
             HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO <> OLD_REC.TDCC_CURRENCY_NO_FCY OR
             HOLDER_DIVIDEND_BANK_REC.AC_NAME <> OLD_REC.NAME OR
             -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
             HOLDER_DIVIDEND_BANK_REC.ENAME <> OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME THEN
            INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
                  (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,IBAN_CODE,
                   REMARK,REVISED_BY,REVISION_DATE,REMARK1,AMC_NO)
              VALUES
                  (OLD_REC.ID,
                   HOLDER_DIVIDEND_BANK_REC.BANK_NO,
                   HOLDER_DIVIDEND_BANK_REC.BRANCH_NO,
                   HOLDER_DIVIDEND_BANK_REC.AC_CODE,
                   HOLDER_DIVIDEND_BANK_REC.AC_NAME,
                   HOLDER_DIVIDEND_BANK_REC.FIS_SNAME,
                   HOLDER_DIVIDEND_BANK_REC.ONSHORE,
                   HOLDER_DIVIDEND_BANK_REC.OFFSHORE,
                   HOLDER_DIVIDEND_BANK_REC.CURRENCY_NO,
                   HOLDER_DIVIDEND_BANK_REC.ENAME,
                   HOLDER_DIVIDEND_BANK_REC.IBAN_CODE,
                   HOLDER_DIVIDEND_BANK_REC.REMARK,
                   'ECS',
                   XSYS_DTTM,
                   '加開帳戶，同時變更配息帳號',
                   HOLDER_DIVIDEND_BANK_REC.AMC_NO
                  );

            --同時將變更後資料更新受益人配息帳號檔
            UPDATE FAS.HOLDER_DIVIDEND_BANK
               SET BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY,
                   BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY,
                   AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY,
                   AC_NAME = OLD_REC.NAME,
                   FIS_SNAME = XSNAME,
                   ONSHORE = 'N',
                   OFFSHORE = 'Y',
                   -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                   ENAME = OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME
             WHERE ID = OLD_REC.ID
               AND AMC_NO = '04'
               AND CURRENCY_NO NOT IN ('MMA','NTD');
          END IF;
          EXCEPTION
               WHEN NO_DATA_FOUND THEN --找不到則新增一筆
             INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                   (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
               VALUES
                   (OLD_REC.ID,
                    OLD_REC.TDCC_BANK_NO_TWD_FCY, --往來銀行
                    OLD_REC.TDCC_BRANCH_NO_TWD_FCY, --往來分行
                    OLD_REC.TDCC_AC_CODE_TWD_FCY, --往來帳號
                    OLD_REC.NAME, --帳號名稱
                    XSNAME, --往來銀行簡稱
                    'N', --境內基金適用(Y,N)
                    'Y', --境外基金適用(Y,N)
                    OLD_REC.TDCC_CURRENCY_NO_FCY,
                    -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                    OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                    '04' --基金經理公司(瑞萬通博(TDCC))
                   );
        END;
      END IF;

        -- 2022.01.07 Chengyu 修正帳號沒新增問題
        --因不曉得原本邏輯為何，故再最後新增判斷是否需要新增(邏輯參考ECS.F_ECSB007_GetBankD)
        BEGIN

          SELECT COUNT(1) 
            INTO XDATA_CNT
            FROM FAS.HOLDER_DIVIDEND_BANK
           WHERE ID = OLD_REC.ID
             AND AMC_NO = '04'
                    --MMA情況
             AND (  (CURRENCY_NO = 'MMA')
                    --若有輸入集保外幣資料時，則會用原本資料
                 OR (   BANK_NO = OLD_REC.TDCC_BANK_NO_TWD_FCY 
                    AND BRANCH_NO = OLD_REC.TDCC_BRANCH_NO_TWD_FCY
                    AND AC_CODE = OLD_REC.TDCC_AC_CODE_TWD_FCY
                    AND CURRENCY_NO = OLD_REC.TDCC_CURRENCY_NO_FCY  
                    )
                   --若無輸入集保外幣資料時，則會用財金外幣資料寫入
                 OR (    BANK_NO = OLD_REC.FIS_BANK_NO_TWD_FCY 
                     AND BRANCH_NO = OLD_REC.FIS_BRANCH_NO_TWD_FCY
                     AND AC_CODE = OLD_REC.FIS_AC_CODE_TWD_FCY
                     AND CURRENCY_NO = OLD_REC.FIS_CURRENCY_NO_FCY  
                    ) 
                 );

          IF NVL(XDATA_CNT,0) = 0 THEN
          BEGIN

            IF OLD_REC.TDCC_CURRENCY_NO_FCY IS NOT NULL THEN 
            BEGIN
              INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                     (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
                 VALUES
                     (OLD_REC.ID,
                      OLD_REC.TDCC_BANK_NO_TWD_FCY, --往來銀行
                      OLD_REC.TDCC_BRANCH_NO_TWD_FCY, --往來分行
                      OLD_REC.TDCC_AC_CODE_TWD_FCY, --往來帳號
                      OLD_REC.NAME, --帳號名稱
                      XSNAME, --往來銀行簡稱
                      'N', --境內基金適用(Y,N)
                      'Y', --境外基金適用(Y,N)
                      OLD_REC.TDCC_CURRENCY_NO_FCY,
                      -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                      OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                      '04' --基金經理公司(瑞萬通博(TDCC))
                     );
            END;
            ELSIF OLD_REC.FIS_CURRENCY_NO_FCY IS NOT NULL THEN
            BEGIN
              INSERT INTO FAS.HOLDER_DIVIDEND_BANK
                     (ID,BANK_NO,BRANCH_NO,AC_CODE,AC_NAME,FIS_SNAME,ONSHORE,OFFSHORE,CURRENCY_NO,ENAME,AMC_NO)
                 VALUES
                     (OLD_REC.ID,
                      OLD_REC.FIS_BANK_NO_TWD_FCY, --往來銀行
                      OLD_REC.FIS_BRANCH_NO_TWD_FCY, --往來分行
                      OLD_REC.FIS_AC_CODE_TWD_FCY, --往來帳號
                      OLD_REC.NAME, --帳號名稱
                      XSNAME, --往來銀行簡稱
                      'N', --境內基金適用(Y,N)
                      'Y', --境外基金適用(Y,N)
                      OLD_REC.FIS_CURRENCY_NO_FCY,
                      -- 2019.01.17 JIANXIN MOD BY 調整ENAME 欄位內容
                      OLD_REC.LAST_NAME || ' ' || OLD_REC.FIRST_NAME|| ' ' || OLD_REC.MIDDLE_NAME, --英文戶名
                      '04' --基金經理公司(瑞萬通博(TDCC))
                     );
            END;
            END IF;
          END;
          END IF;
        END;

      dbms_output.put_line('UPDATE OR INSERT FAS.HOLDER_DIVIDEND_BANK END');
      dbms_output.put_line('FAS.HOLDER_DIVIDEN 系列 END');
      dbms_output.put_line('FOR OLD_REC IN LOOP END');

  END LOOP; --處理舊戶

  dbms_output.put_line(' ');
  dbms_output.put_line('FOR SEAL_DATE_REC IN LOOP BEGIN');

  --2020.07.14 tingting 因應線上開戶調整：調整送交核印日期、更新核印完成日期
  FOR SEAL_DATE_REC IN
  (
    --財金-台幣
    SELECT  Z.ID
           ,A.FIS_BANK_NO_TWD AS AC_BANK
           ,A.FIS_BRANCH_NO_TWD AS AC_BRANCH
           ,A.FIS_AC_CODE_TWD AS AC_CODE
           ,'01' AS DEPOSITORY_NO
           ,A.FIS_CURRENCY_NO_TWD AS CURRENCY_NO
           ,A.FIS_SEAL_DATE_TWD AS VERIFIED
           ,'Y' AS IS_FIS
           ,'財金-台幣' AS BANK_TYPE
      FROM ECS.ECSB007_IDList Z
      JOIN ECS.HOLDER A
        ON A.ID = Z.ID
     WHERE A.IS_ES_ACCOUNT = 'Y'    --既有客戶\N：新戶；Y：舊戶
       AND A.OPEN_TYPE = '2'        --開戶類別\1：預約開戶；2：無紙化開戶
       AND LTRIM(A.FIS_CURRENCY_NO_TWD) IS NOT NULL
       AND A.FIS_SEAL_DATE_TWD IS NOT NULL

    UNION ALL

    --財金-外幣
    SELECT  Z.ID
           ,A.FIS_BANK_NO_TWD_FCY AS AC_BANK
           ,A.FIS_BRANCH_NO_TWD_FCY AS AC_BRANCH
           ,A.FIS_AC_CODE_TWD_FCY AS AC_CODE
           ,'01' AS DEPOSITORY_NO
           ,A.FIS_CURRENCY_NO_FCY AS CURRENCY_NO
           ,A.FIS_SEAL_DATE_FCY AS VERIFIED
           ,'Y' AS IS_FIS
           ,'財金-外幣' AS BANK_TYPE
      FROM ECS.ECSB007_IDList Z
      JOIN ECS.HOLDER A
        ON A.ID = Z.ID
     WHERE A.IS_ES_ACCOUNT = 'Y'    --既有客戶\N：新戶；Y：舊戶
       AND A.OPEN_TYPE = '2'        --開戶類別\1：預約開戶；2：無紙化開戶
       AND LTRIM(A.FIS_CURRENCY_NO_FCY) IS NOT NULL
       AND A.FIS_SEAL_DATE_FCY IS NOT NULL

    UNION ALL

    --集保-台幣
    SELECT  Z.ID
           ,A.TDCC_BANK_NO AS AC_BANK
           ,A.TDCC_BRANCH_NO AS AC_BRANCH
           ,A.TDCC_AC_CODE AS AC_CODE
           ,'04' AS DEPOSITORY_NO
           ,A.TDCC_CURRENCY_NO AS CURRENCY_NO
           ,A.TDCC_SEAL_DATE AS VERIFIED
           ,'N' AS IS_FIS
           ,'集保-台幣' AS BANK_TYPE
      FROM ECS.ECSB007_IDList Z
      JOIN ECS.HOLDER A
        ON A.ID = Z.ID
     WHERE A.IS_ES_ACCOUNT = 'Y'    --既有客戶\N：新戶；Y：舊戶
       AND A.OPEN_TYPE = '2'        --開戶類別\1：預約開戶；2：無紙化開戶
       AND LTRIM(A.TDCC_CURRENCY_NO) IS NOT NULL
       AND A.TDCC_SEAL_DATE IS NOT NULL

    UNION ALL

    --集保-外幣
    SELECT  Z.ID
           ,A.TDCC_BANK_NO_TWD_FCY AS AC_BANK
           ,A.TDCC_BRANCH_NO_TWD_FCY AS AC_BRANCH
           ,A.TDCC_AC_CODE_TWD_FCY AS AC_CODE
           ,'04' AS DEPOSITORY_NO
           ,A.TDCC_CURRENCY_NO_FCY AS CURRENCY_NO
           ,A.TDCC_SEAL_DATE_FCY AS VERIFIED
           ,'N' AS IS_FIS
           ,'集保-外幣' AS BANK_TYPE
      FROM ECS.ECSB007_IDList Z
      JOIN ECS.HOLDER A
        ON A.ID = Z.ID
     WHERE A.IS_ES_ACCOUNT = 'Y'    --既有客戶\N：新戶；Y：舊戶
       AND A.OPEN_TYPE = '2'        --開戶類別\1：預約開戶；2：無紙化開戶
       AND LTRIM(A.TDCC_CURRENCY_NO_FCY) IS NOT NULL
       AND A.TDCC_SEAL_DATE IS NOT NULL
  ) LOOP

    dbms_output.put_line(' ');
    dbms_output.put_line('UPDATE FAS.HOLDER_BANK_EC_CHANGE 更新核印完成日期  ' || SEAL_DATE_REC.BANK_TYPE);
    dbms_output.put_line(' WHERE ID = SEAL_DATE_REC.ID = ' || SEAL_DATE_REC.ID);
    dbms_output.put_line('   AND NEW_AC_BANK = SEAL_DATE_REC.AC_BANK = ' || SEAL_DATE_REC.AC_BANK);
    dbms_output.put_line('   AND NEW_AC_BRANCH = SEAL_DATE_REC.AC_BRANCH = ' || SEAL_DATE_REC.AC_BRANCH);
    dbms_output.put_line('   AND NEW_AC_CODE = SEAL_DATE_REC.AC_CODE = ' || SEAL_DATE_REC.AC_CODE);
    dbms_output.put_line('   AND LAST_MODIFIED = XSYS_DTTM = ' || XSYS_DTTM);
    dbms_output.put_line('   AND DEPOSITORY_NO = SEAL_DATE_REC.DEPOSITORY_NO = ' || SEAL_DATE_REC.DEPOSITORY_NO);

    -- 2021.09.01 Chengyu 修正舊戶做線上開戶時，沒有押核印完成日問題
    UPDATE FAS.HOLDER_BANK_EC_CHANGE
       SET VERIFIED = CASE WHEN VERIFIED IS NULL THEN XSYS_DTTM ELSE VERIFIED END       --核印完成日期
     WHERE ID = SEAL_DATE_REC.ID
       AND NEW_AC_BANK = SEAL_DATE_REC.AC_BANK
       AND NEW_AC_BRANCH = SEAL_DATE_REC.AC_BRANCH
       AND NEW_AC_CODE = SEAL_DATE_REC.AC_CODE
       AND LAST_MODIFIED = XSYS_DTTM
       AND DEPOSITORY_NO = SEAL_DATE_REC.DEPOSITORY_NO;

    IF SQL%NOTFOUND THEN
    BEGIN

        dbms_output.put_line('UPDATE FAS.HOLDER_BANK_EC 更新核印完成日期  ' || SEAL_DATE_REC.BANK_TYPE || '  UPDATE FAS.HOLDER_BANK_EC_CHANGE不到資料才UPDATE FAS.HOLDER_BANK_EC');
        dbms_output.put_line(' WHERE ID = SEAL_DATE_REC.ID = ' || SEAL_DATE_REC.ID);
        dbms_output.put_line('   AND AC_BANK = SEAL_DATE_REC.AC_BANK = ' || SEAL_DATE_REC.AC_BANK);
        dbms_output.put_line('   AND AC_CODE = SEAL_DATE_REC.AC_CODE = ' || SEAL_DATE_REC.AC_CODE);
        dbms_output.put_line('   AND DEPOSITORY_NO = SEAL_DATE_REC.DEPOSITORY_NO = ' || SEAL_DATE_REC.DEPOSITORY_NO);
        dbms_output.put_line('   AND CURRENCY_NO IN (SEAL_DATE_REC.CURRENCY_NO, MMA) = ' || SEAL_DATE_REC.CURRENCY_NO);

        -- 2021.09.01 Chengyu 修正舊戶做線上開戶時，沒有押核印完成日問題
        UPDATE FAS.HOLDER_BANK_EC
           SET VERIFIED = CASE WHEN VERIFIED IS NULL THEN XSYS_DTTM ELSE VERIFIED END       --核印完成日期
         WHERE ID = SEAL_DATE_REC.ID
           AND AC_BANK = SEAL_DATE_REC.AC_BANK
           AND AC_CODE = SEAL_DATE_REC.AC_CODE
           AND DEPOSITORY_NO = SEAL_DATE_REC.DEPOSITORY_NO
           AND CURRENCY_NO IN (SEAL_DATE_REC.CURRENCY_NO, 'MMA');

    END;
    END IF;
  END LOOP;

  dbms_output.put_line('FOR SEAL_DATE_REC IN LOOP END');
  dbms_output.put_line('處理舊戶 END');

  dbms_output.put_line(' ');
  dbms_output.put_line('FOR REWARD_REC IN LOOP BEGIN');

  --4.若「境內紅利活動編號(ON_REWARD_PROGRAM)」或「境外紅利活動編號(OFF_REWARD_PROGRAM)」不為空白時，則要產生紅利配發資料檔(FAS.REWARD_POINT)
  FOR REWARD_REC IN
    (SELECT A.ID,           --受益人ID
            XSYS_DATE ISSUE_DATE, --配發日期
            B.REWARD_POINT, --紅利點數
            0 USED_POINT,   --使用點數
            B.PROGRAM_NO,   --活動編號
            B.VALID_FROM,   --生效日(含)
            B.VALID_THRU,   --截止日(含)
            --紅利編號
            TRIM(A.EMAIL) AS EMAIL, --EMAIL
            'N' IS_EMAIL    --紅利通知寄發否
       FROM ECS.ECSB007_IDList Z
       JOIN ECS.HOLDER A ON A.ID = Z.ID
       JOIN FAS.REWARD_PROGRAM B ON B.PROGRAM_NO = ON_REWARD_PROGRAM
      WHERE LTRIM(A.ON_REWARD_PROGRAM) IS NOT NULL
     UNION ALL
     SELECT A.ID,           --受益人ID
            XSYS_DATE ISSUE_DATE, --配發日期
            B.REWARD_POINT, --紅利點數
            0 USED_POINT,   --使用點數
            B.PROGRAM_NO,   --活動編號
            B.VALID_FROM,   --生效日(含)
            B.VALID_THRU,   --截止日(含)
            --紅利編號
            TRIM(A.EMAIL) AS EMAIL, --EMAIL
            'N' IS_EMAIL    --紅利通知寄發否
       FROM ECS.ECSB007_IDList Z
       JOIN ECS.HOLDER A ON A.ID = Z.ID
       JOIN FAS.REWARD_PROGRAM B ON B.PROGRAM_NO = OFF_REWARD_PROGRAM
      WHERE LTRIM(A.OFF_REWARD_PROGRAM) IS NOT NULL
    ) LOOP

      XREWARD_NO := 0;
      -- 2021.03.16 by Chengyu 1.修正推薦人優惠券新增語法;2.修正呼叫ECS.s_GetSrNo3錯誤
      ECS.s_GetSrNo3('ECSM006','00',1,XREWARD_NO);
      INSERT INTO FAS.REWARD_POINT
            (ID,ISSUE_DATE,REWARD_POINT,USED_POINT,PROGRAM_NO,VALID_FROM,VALID_THRU,REWARD_NO,
             CREATION_DATE,CREATED_BY,REVISION_DATE,REVISED_BY,IS_EMAIL,STATUS,
             CREATEID,CREATEDATE,ENTRYID,ENTRYDATE,UPDATEID,UPDATEDATE,
             VERIFYID,VERIFYDATE,APPROVEID,APPROVEDATE,EMAIL
            )
        VALUES
            (REWARD_REC.ID,      --受益人ID
             REWARD_REC.ISSUE_DATE,      --配發日期
             REWARD_REC.REWARD_POINT,    --紅利點數
             REWARD_REC.USED_POINT,      --使用點數
             REWARD_REC.PROGRAM_NO,      --活動編號
             REWARD_REC.VALID_FROM,      --生效日(含)
             REWARD_REC.VALID_THRU,      --截止日(含)
             XREWARD_NO,       --紅利編號
             XSYS_DTTM,      --建檔日期
             'ECS',      --建檔人
             XSYS_DTTM,      --修改日期
             'ECS',      --修改人
             REWARD_REC.IS_EMAIL,    --是否寄發紅利通知(Y/N)
             '301',    --資料狀態碼
             'ECS',    --資料建立者
             XSYS_DTTM,      --資料建立日期
             'ECS',    --最後輸入者
             XSYS_DTTM,     --最後輸入日期
             'ECS',    --最後修改者
             XSYS_DTTM,      --最後修改日期
             'ECS',    --資料確認者
             XSYS_DTTM,      --資料確認日期
             'ECS',    --資料覆核者
             XSYS_DTTM,      --資料覆核日期
             REWARD_REC.EMAIL       --EMAIL
            );

    END LOOP;

  dbms_output.put_line('FOR REWARD_REC IN LOOP END');

  dbms_output.put_line(' ');
  dbms_output.put_line('UPDATE ECS.HOLDER 更新作業處理碼 6.股務審核完成，待開戶 → 7.完成');

  --5.開戶完成後，將【預約開戶資料(ECS.HOLDER)】檔中的作業處理碼設定為'7'(開戶完成)
  --5.1 新戶
  UPDATE ECS.HOLDER A
     SET A.ACCOUNT_NO = (SELECT ACCOUNT_NO FROM ECS.ECSB007_IDList WHERE IS_ES_ACCOUNT = 'N' AND ID = A.ID), --戶號
         A.PROCESS_CODE = '7', --作業處理碼
         A.UPDATEID = WEXEC_UERID, --執行者代碼
         A.UPDATEDATE = XSYS_DTTM
   WHERE A.ID IN (SELECT ID FROM ECS.ECSB007_IDList WHERE IS_ES_ACCOUNT = 'N'); --新戶
  --5.2 舊戶
  UPDATE ECS.HOLDER
     SET PROCESS_CODE = '7', --作業處理碼
         UPDATEID = WEXEC_UERID, --執行者代碼
         UPDATEDATE = XSYS_DTTM
   WHERE ID IN (SELECT ID FROM ECS.ECSB007_IDList WHERE IS_ES_ACCOUNT = 'Y'); --舊戶

END S_ECSB007_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB007_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB008_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB008_EXECUTE" --開戶相關通知信寄發作業
-- =============================================
-- Author:      Stu
-- Create date: 
-- Description: 預約開戶寄信通知
-- 2018.11.28 JIANXIN MOD BY 1. 調整執行條件日期
--                           2. 處理寄送信件只能是唯一
--                           3. 取得分行簡稱
--                           4. 因為系統有時間，所以為了取得執行日當天所有的資料調整
--                           5. 帳號隱碼處理
-- 2018.12.05 JIANXIN MOD BY 核印失敗處理
-- 2018.12.06 JIANXIN MOD BY 新增TA 後台寄發處理作業
-- 2018.12.18 JIANXIN MOD BY 新增TA 後台開戶完成通知信
-- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
-- 2019.05.03 yunchu MOD BY 調整取得日期含時間
-- 2019.05.27 tingting 開戶完成通知信增加判斷條件，防止重覆寄信
-- 2019.07.09 JIANXIN MOD BY 因應後台加開網路戶，必須去除時間
-- 2020.03.03 ChengYu MOD BY 修正帳號變更核印成功後，寄發的信件上帳號應顯示NEW_AC_CODE(往來帳號(新))
-- =============================================
(
    WEXEC_DATE      IN DATE,          --執行條件日期時分
    WEXEC_UERID     IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE   OUT VARCHAR2,     --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    LIST_DATA       OUT SYS_REFCURSOR,--開戶資料寄發資料列表
    LIST_EMAIL      OUT SYS_REFCURSOR,--電子郵件檢核確認通知信
    LIST_RESERVE    OUT SYS_REFCURSOR,--庫存查詢戶寄發資料列表
    LIST_SEND_CODE  OUT SYS_REFCURSOR,--送交核印寄發資料列表
    LIST_SEAL_CODE  OUT SYS_REFCURSOR --核印結果寄發資料列表
) IS
  --變數宣告
  XCONDITION_DATE DATE;
  XSYS_DTTM DATE;
  SYS_DTTM_10 DATE;
  LastSendDT1 DATE;
  LastSendDT2 DATE;
  DATA_COUNT INT;

BEGIN
  --給變數值
  -- 2018.11.28 JIANXIN MOD BY 因為系統有時間，所以為了取得執行日當天所有的資料調整
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD')+1-1/24/60/60; --取得傳入參數中的日期
  XSYS_DTTM := sysdate;--取得系統日期時間
  SYS_DTTM_10 := sysdate-10;

  -- 2018.11.28 JIANXIN MOD BY 調整執行條件日期
  SELECT TRUNC(A.OpenBalanceAccount)
    INTO LastSendDT1
    FROM ECS.OTHER_PARAMETER A;

  -- 2018.11.28 JIANXIN MOD BY 調整執行條件日期
  -- 2019.05.03 yunchu MOD BY 調整取得日期含時間
  SELECT A.ECBank
    INTO LastSendDT2
    FROM ECS.OTHER_PARAMETER A;

  SELECT COUNT(X.NAME)
    INTO DATA_COUNT
    FROM ECS.HOLDER X
   WHERE X.PROCESS_CODE = '7'
     AND X.RECEIPT_DOC_OPEN = 'N';

 --開戶成功通知信
 --條件:作業處理碼(PROCESS_CODE)= '7.開戶完成' 且開戶成功通知信(RECEIPT_DOC_OPEN)= 'N.未寄發'
 OPEN LIST_DATA FOR
  SELECT  X.NAME AS BF_NAME       --受益人姓名
         ,X.EMAIL AS BF_EMAIL     --寄發EMAIL
         ,X.ACCOUNT_NO AS BF_NO   --戶號
    FROM ECS.HOLDER X
   WHERE X.PROCESS_CODE = '7'
     AND X.RECEIPT_DOC_OPEN = 'N'
   UNION
  -- 2018.12.18 JIANXIN MOD BY 新增TA 後台開戶完成通知信
  SELECT  X.NAME AS BF_NAME      --受益人姓名
         ,X.EMAIL AS BF_EMAIL    --寄發EMAIL
         ,X.ACCOUNT_NO AS BF_NO  --戶號
    FROM FAS.HOLDER X
    LEFT JOIN ECS.HOLDER Y
      ON Y.ID = X.ID
   -- 2019.07.09 JIANXIN MOD BY 因應後台加開網路戶，必須去除時間
   WHERE TRUNC(X.EC_DATE) = TRUNC(WEXEC_DATE)
     AND X.ECS_STATUS = '1'      --EC狀態 0 未開電子交易戶 1 電子交易戶啟用 2 電子交易戶停用 3 庫存查詢啟用 4 庫存查詢停用
     -- 2019.05.27 tingting 開戶完成通知信增加判斷條件，防止重覆寄信
     AND Y.ID IS NULL;

 DECLARE CURSOR UPDATE_DATA IS
  SELECT X.ID
    FROM ECS.HOLDER X
   WHERE X.PROCESS_CODE = '7'
     AND X.RECEIPT_DOC_OPEN = 'N';

  BEGIN
   FOR UPDATE_ROW IN UPDATE_DATA LOOP
   --更新【預約開戶資料(ECS.HOLDER)】檔
   --開戶成功通知信更新為Y.已寄發
   UPDATE ECS.HOLDER
      SET RECEIPT_DOC_OPEN = 'Y' ,UPDATEID = WEXEC_UERID , UPDATEDATE = XSYS_DTTM
    WHERE ID = UPDATE_ROW.ID;
   END LOOP;
  END;

 --電子郵件檢核確認通知信
 --條件:作業處理碼(PROCESS_CODE)= '7.開戶完成'且Email檢核通知信(RECEIPT_DOC_EMAIL)= 'N.未寄發'
 --2018.11.25 yunchu 增加戶號及既有客戶，供寄信參數
 OPEN LIST_EMAIL FOR
  SELECT  X.NAME AS BF_NAME--受益人姓名
         ,X.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.ACCOUNT_NO AS BF_ACCOUNT_NO--戶號
         ,X.IS_ES_ACCOUNT AS isNewAccount --既有客戶\N：新戶；Y：舊戶
    FROM ECS.HOLDER X
   WHERE X.PROCESS_CODE = '7'
     AND X.RECEIPT_DOC_EMAIL = 'N'
   UNION
  -- 2018.12.06 JIANXIN MOD BY 新增TA 後台寄發處理作業
  SELECT  X.NAME AS BF_NAME--受益人姓名
         ,X.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.ACCOUNT_NO AS BF_ACCOUNT_NO--戶號
         ,'Y' AS isNewAccount --既有客戶\N：新戶；Y：舊戶
    FROM FAS.HOLDER X
   WHERE X.ECS_STATUS = '1'
     AND X.EMAIL_VALID = 'N'
     AND X.EC_DATE BETWEEN LastSendDT1 AND XCONDITION_DATE
     AND X.EC_DATE >= SYS_DTTM_10;

 DECLARE CURSOR UPDATE_DATA IS
  SELECT X.ID
    FROM ECS.HOLDER X
   WHERE X.PROCESS_CODE = '7'
     AND X.RECEIPT_DOC_EMAIL = 'N';

  BEGIN
   FOR UPDATE_ROW IN UPDATE_DATA LOOP
   --更新【預約開戶資料(ECS.HOLDER)】檔
   --Email檢核通知信更新為Y.已寄發
   UPDATE ECS.HOLDER
      SET RECEIPT_DOC_EMAIL = 'Y' ,UPDATEID = WEXEC_UERID , UPDATEDATE = XSYS_DTTM
    WHERE ID = UPDATE_ROW.ID;
   END LOOP;
  END;

 --庫存查詢戶通知信
 --EC狀態 (ECS_STATUS)='3.庫存查詢啟用'且
 --庫存查詢開戶日(EC2_DATE)介於『庫存查詢戶上次寄送日期(@LastSendDT1)』及執行條件『資料處理日期』且
 --庫存查詢開戶日(EC2_DATE)大於等於『前10日的截止日期(@SYS_DTTM_10)』
 OPEN LIST_RESERVE FOR
  SELECT  X.NAME AS BF_NAME--受益人姓名
         ,X.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.ACCOUNT_NO AS BF_NO--戶號
    FROM FAS.HOLDER X
   WHERE X.ECS_STATUS = '3'
     AND X.EC2_DATE BETWEEN LastSendDT1 AND XCONDITION_DATE
     AND X.EC2_DATE >= SYS_DTTM_10;

 --更新【EC 其他參數(ECS.OTHER_PARAMETER)】檔
 --庫存查詢功能開啟成功通知信更新『系統日期(@SYS_DATE)』
 UPDATE ECS.OTHER_PARAMETER
    SET OpenBalanceAccount = XSYS_DTTM;

 --送交核印通知信
 --【受益人扣款帳號(FAS.HOLDER_BANK_EC)】的「送交核印日期(DELIVERED)」介於『銀行核印上次寄送日期(@LastSendDT2)』及執行條件『資料處理日期』且
 --【受益人扣款帳號(FAS.HOLDER_BANK_EC)】的「送交核印日期(DELIVERED)」大於等於『前10日的截止日期(@SYS_DTTM_10)』 且
 --【受益人扣款帳號(FAS.HOLDER_BANK_EC)】的「核印完成日期(VERIFIED)」或「 退件日期(REJECTED)」為空白 且
 --【受益人(FAS.HOLDER)】的「EC狀態 (ECS_STATUS)」=1.電子交易戶啟用
 OPEN LIST_SEND_CODE FOR  
  -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.Ac_Bank AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         ,ECS.FN_STUFF_STR(X.Ac_Code,5,'*') AS AC_CODE--銀行帳號
    FROM FAS.HOLDER_BANK_EC X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      ON B.BANK_NO = X.Ac_Bank AND X.AC_BRANCH = B.BRANCH_NO
   WHERE A.ECS_STATUS = '1'
     AND X.DELIVERED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.DELIVERED >= SYS_DTTM_10
     -- 2018.11.28 JIANXIN MOD BY 條件寫法調整
     AND (X.VERIFIED IS NULL OR X.REJECTED IS NULL)
   UNION
   -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.NEW_AC_BANK AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         ,ECS.FN_STUFF_STR(X.NEW_AC_CODE,5,'*') AS AC_CODE--銀行帳號
    FROM FAS.HOLDER_BANK_EC_CHANGE X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      -- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
      ON B.BANK_NO = X.NEW_AC_BANK AND X.NEW_AC_BRANCH = B.BRANCH_NO
   WHERE A.ECS_STATUS = '1'
     AND X.DELIVERED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.DELIVERED >= SYS_DTTM_10
     -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
     AND (X.VERIFIED IS NULL OR X.REJECTED IS NULL);

 --核印結果通知信
 --【受益人扣款帳號(FAS.HOLDER_BANK_EC)】的「核印完成日期(VERIFIED)」介於『銀行核印上次寄送日期(@LastSendDT2)』及執行條件『資料處理日期』且
 --【受益人扣款帳號(FAS.HOLDER_BANK_EC)】的「核印完成日期(VERIFIED)」大於等於『前10日的截止日期(@SYS_DTTM_10)』 且
 --【受益人(FAS.HOLDER)】的「EC狀態 (ECS_STATUS)」=1.電子交易戶啟用
 OPEN LIST_SEAL_CODE FOR
 -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.Ac_Bank AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         ,ECS.FN_STUFF_STR(X.Ac_Code,5,'*') AS AC_CODE--銀行帳號
         ,'核印成功' AS SEAL_CODE--核印結果
    FROM FAS.HOLDER_BANK_EC X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      ON B.BANK_NO = X.Ac_Bank AND X.AC_BRANCH = B.BRANCH_NO
   WHERE A.ECS_STATUS = '1'
     AND X.VERIFIED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.VERIFIED >= SYS_DTTM_10
   UNION
   -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         ,X.Ac_Bank AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         ,ECS.FN_STUFF_STR(X.Ac_Code,5,'*') AS AC_CODE--銀行帳號
         ,C.NAME AS SEAL_CODE--核印結果
    FROM FAS.HOLDER_BANK_EC X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      ON B.BANK_NO = X.Ac_Bank AND X.AC_BRANCH = B.BRANCH_NO
    JOIN FAS.REJECT_CODE C
      ON X.REJECT_CODE = C.REJECT_CODE
   WHERE A.ECS_STATUS = '1'
     -- 2018.12.05 JIANXIN MOD BY 核印失敗處理
     AND X.REJECTED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.REJECTED >= SYS_DTTM_10
   UNION
    -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         -- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
         ,X.NEW_AC_BANK AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         -- 2020.03.03 ChengYu MOD BY 修正帳號變更核印成功後，寄發的信件上帳號應顯示NEW_AC_CODE(往來帳號(新))
         ,ECS.FN_STUFF_STR(X.NEW_AC_CODE,5,'*')  AS AC_CODE--銀行帳號
         ,'核印成功' AS SEAL_CODE--核印結果
    FROM FAS.HOLDER_BANK_EC_CHANGE X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      -- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
      ON B.BANK_NO = X.NEW_AC_BANK AND X.NEW_AC_BRANCH = B.BRANCH_NO
   WHERE A.ECS_STATUS = '1'
     AND X.VERIFIED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.VERIFIED >= SYS_DTTM_10
   UNION
     -- 2018.11.28 JIANXIN MOD BY 處理寄送信件只能是唯一
  SELECT DISTINCT A.NAME AS BF_NAME--受益人姓名
         ,A.EMAIL AS BF_EMAIL--寄發EMAIL
         -- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
         ,X.NEW_AC_BANK AS AC_BANK--指定銀行代碼
         -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
         ,B.SName AS AC_NAME--指定銀行分行名稱
         -- 2018.11.28 JIANXIN MOD BY 帳號隱碼處理
         -- 2020.03.03 ChengYu MOD BY 修正帳號變更核印成功後，寄發的信件上帳號應顯示NEW_AC_CODE(往來帳號(新))
         ,ECS.FN_STUFF_STR(X.NEW_AC_CODE,5,'*')  AS AC_CODE--銀行帳號
         ,C.NAME AS SEAL_CODE--核印結果
    FROM FAS.HOLDER_BANK_EC_CHANGE X
    JOIN FAS.HOLDER A
      ON X.ID = A.ID
    JOIN FAS.FIS_BRANCH B
      -- 2018.11.28 JIANXIN MOD BY 取得分行簡稱
      -- 2019.05.02 tingting 調整銀行代碼、簡稱改抓異動後的欄位
      ON B.BANK_NO = X.NEW_AC_BANK AND X.NEW_AC_BRANCH = B.BRANCH_NO
    JOIN FAS.REJECT_CODE C
      ON X.REJECT_CODE = C.REJECT_CODE
   WHERE A.ECS_STATUS = '1'
     -- 2018.12.05 JIANXIN MOD BY 核印失敗處理
     AND X.REJECTED BETWEEN LastSendDT2 AND XCONDITION_DATE
     AND X.REJECTED >= SYS_DTTM_10;

 --更新【EC 其他參數(ECS.OTHER_PARAMETER)】檔
 --銀行核印相關通知信更新『系統日期(@SYS_DATE)』
 UPDATE ECS.OTHER_PARAMETER
    SET ECBank = XSYS_DTTM;

  IF DATA_COUNT > 0 THEN  
    WFINSISH_CODE := 'S'; 
  ELSE  
    WFINSISH_CODE := 'X'; 
  END IF; 

END S_ECSB008_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB008_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB009_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB009_EXECUTE" --觀察基金 & 到價提示計算
-- =============================================
-- Author:      CTS
-- Create date:
-- Description:
-- 2018.11.01 JIANXIN MOD 調整加總錯誤問題
-- 2018.11.28 yunchu 調整通知頻率(ALERT_FREQ)為(E:每次通知我)時,也要發送信件
-- 2018.11.29 yunchu 調整Mail名單
-- 2018.12.27 JIANXIN MOD 調整停損到價通知錯誤問題
-- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
-- 2019.03.13 JIANXIN MOD BY 庫存成本應該要用原幣計算
-- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
-- 2019.03.25 yunchu 調整交易幣投資報酬率交易幣不等於計價幣才乘匯率
-- 2021.03.02 Chengyu 修正轉申購時因沒有寫入台幣成本而顯示到價提示問題
-- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
-- =============================================
(
    WINPUT_DATE     IN DATE,           --計算處理日期(即執行日期)
    WEXE_TYPE       IN VARCHAR2,       --執行類別(S:系統自動執行, M:人工執行)
    WEXEC_UERID     IN VARCHAR2,       --執行者代碼
    WFINSISH_CODE   OUT VARCHAR2,      --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    CMSGLIST_NM     OUT SYS_REFCURSOR, --回傳的基金觀察Mail名單
    CMSGLIST_NMLIST OUT SYS_REFCURSOR, --回傳的基金觀察Mail名單的到價提示內容
    CMSGLIST_GL     OUT SYS_REFCURSOR, --回傳的停損停利Mail名單
    CMSGLIST_GLLIST OUT SYS_REFCURSOR  --回傳的停損停利Mail名單的到價提示內容
) IS
  --變數宣告
  XCOUNT NUMBER(9);     --筆數
  -- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
  XRETURN_BAL_UNIT NUMBER(18,6);    --報酬率計算單位數
  XRETURN_TOTAL_COST NUMBER(14,2);  --報酬率計算總成本
  XINVEST_RATE NUMBER(6,2);         --投資報酬率

BEGIN
  --給變數值
  WFINSISH_CODE := 'S';

  --1.以投資人的到價警示設定，計算各基金的警示資料，並將計算結果，寫入【基金到價計算執行記錄檔(ECS.PRICE_LOG)】中
  --1.1 找出有那些設定到價提示/停損停利的基金
  --  自【停損停利到價通知WPS.FUND_ALERT)】檔中找出「警示設定(ALERT)」= “Y.啟動通知”且到價提示單位為1(淨值)且
  --      【受益人(FAS.HOLDER)】的「銷戶日期(CLOSE_DATE)」為空白的資料,直接寫入基金到價計算執行記錄檔(ECS.PRICE_LOG)
  INSERT INTO ECS.PRICE_LOG
        (INPUT_DATE,EXE_TYPE,ID,FUND_NO,TYPE,UPPER_LIMIT,LOWER_LIMIT,BUY_IN,SELL_OUT,ALERT_PRU,
         NAV_DATE,NAV,IS_NAV_ALTER,IS_RETURN_ALTER,IS_READ)
  SELECT WINPUT_DATE,   --執行日期(即計算處理日期)
         WEXE_TYPE,     --執行類別
         Z.ID,          --受益人ID
         Z.FUND_NO,     --基金編號
         Z.TYPE,        --類別(0.我的投資組合；1.我的基金觀察)
         Z.UPPER_LIMIT, --停利(%)
         Z.LOWER_LIMIT, --停損(%)
         Z.BUY_IN,      --買進價位
         Z.SELL_OUT,    --賣出價位
         Z.ALERT_PRU,   --到價提示單位(1：淨值；2：報酬率)
         Z.NAV_DATE,    --最新淨值日期
         Z.NAV,         --最新淨值
         CASE WHEN Z.NAV <= Z.BUY_IN THEN '1'
              WHEN Z.NAV >= Z.SELL_OUT THEN '2'
              ELSE 'N'
          END IS_NAV_ALTER,  --基金淨值警示
         'N' IS_RETURN_ALTER,--停利停損警示
         -- 2018.10.17  yunchu 基金淨值或停利停損若有警示，IS_READ為Ｎ，反之給NULL
         CASE WHEN Z.NAV <= Z.BUY_IN THEN 'N'
              WHEN Z.NAV >= Z.SELL_OUT THEN 'N'
              ELSE null
          END IS_READ    --是否已讀
    FROM (
          SELECT A.ID,          --受益人ID
                 A.FUND_NO,     --基金編號
                 A.TYPE,        --類別(0.我的投資組合；1.我的基金觀察)
                 A.UPPER_LIMIT, --停利(%)
                 A.LOWER_LIMIT, --停損(%)
                 A.BUY_IN,      --買進價位
                 A.SELL_OUT,    --賣出價位
                 A.ALERT_PRU,   --到價提示單位(1：淨值；2：報酬率)
                 CASE WHEN D.FUND_NO IS NOT NULL THEN WINPUT_DATE
                      ELSE (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = A.FUND_NO AND NAV_DATE <= WINPUT_DATE)
                  END NAV_DATE, --最新淨值日期
                 CASE WHEN D.FUND_NO IS NOT NULL THEN D.NAV
                      ELSE NVL((SELECT NAV FROM NAV.NAV
                                 WHERE FUND_NO = A.FUND_NO
                                   AND NAV_DATE = (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = A.FUND_NO AND NAV_DATE <= WINPUT_DATE)),0)
                  END NAV  --最新淨值
            FROM WPS.FUND_ALERT A
            JOIN FAS.HOLDER B ON B.ID = A.ID
            JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
            LEFT JOIN NAV.NAV D ON D.FUND_NO = A.FUND_NO AND D.NAV_DATE = WINPUT_DATE
           WHERE A.ALERT = 'Y' --啟動通知
             AND (A.TYPE = '1' OR (A.TYPE = '0' AND A.ALERT_PRU = '1')) --觀察基金 或 屬於淨值之到價提示
             AND B.CLOSE_DATE IS NULL --未銷戶
        ) Z;

  --1.2 找出我的投資組合之到價提示單位為2(報酬率)且
  --      【受益人(FAS.HOLDER)】的「銷戶日期(CLOSE_DATE)」為空白的資料,直接寫入基金到價計算執行記錄檔(ECS.PRICE_LOG)
  FOR ALTER_REC IN
     (SELECT A.ID,          --受益人ID
             A.FUND_NO,     --基金編號
             A.TYPE,        --類別(0.我的投資組合；1.我的基金觀察)
             A.UPPER_LIMIT, --停利(%)
             A.LOWER_LIMIT, --停損(%)
             A.BUY_IN,      --買進價位
             A.SELL_OUT,    --賣出價位
             A.ALERT_PRU,   --到價提示單位(1：淨值；2：報酬率)
             CASE WHEN D.FUND_NO IS NOT NULL THEN WINPUT_DATE
                  ELSE (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = A.FUND_NO AND NAV_DATE <= WINPUT_DATE)
              END NAV_DATE, --最新淨值日期
             CASE WHEN D.FUND_NO IS NOT NULL THEN D.NAV
                  ELSE NVL((SELECT NAV FROM NAV.NAV
                             WHERE FUND_NO = A.FUND_NO
                               AND NAV_DATE = (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = A.FUND_NO AND NAV_DATE <= WINPUT_DATE)),0)
              END NAV,  --最新淨值
             C.CURRENCY_NO FUND_CRNCY, --計價幣別
             C.ANNUALIZED_ROI IS_ROI   --年化報酬率否(Y:年化, N:不年化)
        FROM WPS.FUND_ALERT A
        JOIN FAS.HOLDER B ON B.ID = A.ID
        JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
        LEFT JOIN NAV.NAV D ON D.FUND_NO = A.FUND_NO AND D.NAV_DATE = WINPUT_DATE
       WHERE A.ALERT = 'Y' --啟動通知
         AND A.TYPE = '0' AND A.ALERT_PRU = '2'
         AND B.CLOSE_DATE IS NULL --未銷戶
    ) LOOP

    --不採年化報酬率的方式,計算投資報酬率= ([庫存單位數*最新淨值] - 庫存成本) / 庫存成本 * 100
    -- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
    IF ALTER_REC.IS_ROI = 'N' THEN
      SELECT SUM(RETURN_BAL_UNIT),   --交易幣庫存單位數
             SUM(RETURN_TOTAL_COST), --交易幣庫存成本
             -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
             -- 2019.03.25 yunchu 調整交易幣投資報酬率交易幣不等於計價幣才乘匯率
             SUM(CASE WHEN X.RETURN_TOTAL_COST = 0 THEN 0
                      ELSE (CASE WHEN X.CURRENCY_NO = ALTER_REC.FUND_CRNCY THEN ROUND((ROUND(X.RETURN_BAL_UNIT * ALTER_REC.NAV,Y.AMT_DECIMAL) - X.RETURN_TOTAL_COST) / X.RETURN_TOTAL_COST * 100,2) 
                                 ELSE ROUND((ROUND(X.RETURN_BAL_UNIT * ALTER_REC.NAV * X.EX_RATE,Y.AMT_DECIMAL) - X.RETURN_TOTAL_COST) / X.RETURN_TOTAL_COST * 100,2) 
                             END )
                  END) --交易幣投資報酬率
        INTO XRETURN_BAL_UNIT,XRETURN_TOTAL_COST,XINVEST_RATE
        FROM (
              SELECT A.CURRENCY_NO, --交易幣別
                     -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
                     MAX(B.EX_RATE) EX_RATE, --匯率
                     SUM(A.SHARES) RETURN_BAL_UNIT, --交易幣庫存單位數
                     -- 2019.03.13 JIANXIN MOD BY 庫存成本應該要用原幣計算
                     -- 2019.03.18 JIANXIN MOD BY 庫存成本會分成原幣與交易幣兩種
                     SUM(CASE WHEN A.CURRENCY_NO = ALTER_REC.FUND_CRNCY --交易幣為計價幣時
                                   THEN A.COST                          --彙總原幣申購金額
                                   -- 2021.03.02 Chengyu 修正轉申購時因沒有寫入台幣成本而顯示到價提示問題
                              ELSE DECODE(A.NTD_COST,NULL,A.COST * NTD_EXRATE.EX_RATE,A.NTD_COST)  --否則彙總台幣申購金額
                          END) RETURN_TOTAL_COST --交易幣庫存成本
                     --SUM(A.COST) RETURN_TOTAL_COST --交易幣庫存成本
                FROM FAS.Certificate A
                -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
                JOIN (SELECT V_CURRENCY_RATE.FUND_NO,V_CURRENCY_RATE.EX_RATE
                        FROM FAS.V_CURRENCY_RATE
                        JOIN ( SELECT FUND_NO,MAX(TX_DATE) TX_DATE
                                 FROM FAS.V_CURRENCY_RATE
                                WHERE TX_DATE <= SYSDATE
                                GROUP BY FUND_NO )MAX_CURRENCY_RATE
                          ON MAX_CURRENCY_RATE.FUND_NO = V_CURRENCY_RATE.FUND_NO
                         AND MAX_CURRENCY_RATE.TX_DATE = V_CURRENCY_RATE.TX_DATE ) B
                  ON B.FUND_NO = A.FUND_NO
                JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
                  ON NTD_EXRATE.FUND_NO = A.FUND_NO
                 AND NTD_EXRATE.TX_DATE = A.PUR_DATE 
               WHERE A.FUND_NO = ALTER_REC.FUND_NO
                 AND A.ID = ALTER_REC.ID
                 AND A.ISSUE_DATE <= WINPUT_DATE
                 AND (A.CANCEL_DATE IS NULL OR A.CANCEL_DATE > WINPUT_DATE)
                 AND A.SHARES > 0
                 AND A.STATUS = '1'
              GROUP BY A.CURRENCY_NO
            ) X
        JOIN ECS.V_FUND_CRNCY Y ON Y.CURRENCY_NO = X.CURRENCY_NO;
    END IF;

    --採年化報酬率的方式,計算投資報酬率 = 加總每一張憑證資料的年化報酬率
    -- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
    IF ALTER_REC.IS_ROI = 'Y' THEN
      --取得報酬率計算總成本
      SELECT SUM(CASE WHEN A.CURRENCY_NO = ALTER_REC.FUND_CRNCY --交易幣為計價幣時
                           THEN A.COST                          --彙總原幣申購金額
                           -- 2021.03.02 Chengyu 修正轉申購時因沒有寫入台幣成本而顯示到價提示問題
                      ELSE DECODE(A.NTD_COST,NULL,A.COST * NTD_EXRATE.EX_RATE,A.NTD_COST) --否則彙總台幣申購金額
                  END) COST  --報酬率計算總成本
        INTO XRETURN_TOTAL_COST
        FROM FAS.Certificate A
        JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
          ON NTD_EXRATE.FUND_NO = A.FUND_NO
         AND NTD_EXRATE.TX_DATE = A.PUR_DATE 
       WHERE A.FUND_NO = ALTER_REC.FUND_NO
         AND A.ID = ALTER_REC.ID
         AND A.ISSUE_DATE <= WINPUT_DATE
         AND (A.CANCEL_DATE IS NULL OR A.CANCEL_DATE > WINPUT_DATE)
         AND A.SHARES > 0
         AND A.STATUS = '1';

      --加總每一張憑證資料的年化報酬率
      -- 2018.11.01 JIANXIN MOD 調整加總錯誤問題
      -- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
      SELECT SUM(X.SHARES), --庫存單位數
             SUM(X.COST),   --庫存成本
             SUM(CASE WHEN WINPUT_DATE <= X.PUR_DATE THEN 0 --若計算處理日期小於等於原始申購日期,則年化報酬率 = 0
                      WHEN WINPUT_DATE > X.PUR_DATE AND XRETURN_TOTAL_COST = 0 THEN 1 --若計算處理日期大於原始申購日期且報酬率計算總成本為0,則年化報酬率 = 1
                      ELSE CASE WHEN X.COST = 0 THEN 1
                                ELSE (X.MARKET_VALUE - X.COST) / X.COST / HOLD_DAYS * 365 * 100 --年化報酬率＝(市價－成本)/成本*(持有天數/365)*100
                            END
                  END) --年化報酬率
        INTO XRETURN_BAL_UNIT,XRETURN_TOTAL_COST,XINVEST_RATE
        FROM (
              SELECT A.CURRENCY_NO,
                     -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
                     C.EX_RATE, --匯率
                     A.PUR_DATE,  --原始申購日期
                     A.SHARES,    --庫存單位數
                     -- 2019.03.13 JIANXIN MOD BY 庫存成本應該要用原幣計算
                     -- 2019.03.18 JIANXIN MOD BY 庫存成本會分成原幣與交易幣兩種
                     CASE WHEN A.CURRENCY_NO = ALTER_REC.FUND_CRNCY --交易幣為計價幣時
                               THEN A.COST                          --彙總原幣申購金額
                               -- 2021.03.02 Chengyu 修正轉申購時因沒有寫入台幣成本而顯示到價提示問題
                          ELSE DECODE(A.NTD_COST,NULL,A.COST * NTD_EXRATE.EX_RATE,A.NTD_COST) --否則彙總台幣申購金額
                      END COST,   --庫存成本
                     --A.COST AS COST,   --庫存成本
                     -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
                     ROUND(A.SHARES * ALTER_REC.NAV * C.EX_RATE,B.AMT_DECIMAL) MARKET_VALUE, --市價
                     (WINPUT_DATE - A.PUR_DATE) HOLD_DAYS  --持有天數(= 計算處理日期 至 原始申購日期 之間的天數)
                FROM FAS.Certificate A
                JOIN ECS.V_FUND_CRNCY B ON B.CURRENCY_NO = A.CURRENCY_NO
                -- 2019.03.18 JIANXIN MOD BY 庫存成本增加申購幣別計算
                JOIN (SELECT V_CURRENCY_RATE.FUND_NO,V_CURRENCY_RATE.EX_RATE
                        FROM FAS.V_CURRENCY_RATE
                        JOIN ( SELECT FUND_NO,MAX(TX_DATE) TX_DATE
                                 FROM FAS.V_CURRENCY_RATE
                                WHERE TX_DATE <= SYSDATE
                                GROUP BY FUND_NO )MAX_CURRENCY_RATE
                          ON MAX_CURRENCY_RATE.FUND_NO = V_CURRENCY_RATE.FUND_NO
                         AND MAX_CURRENCY_RATE.TX_DATE = V_CURRENCY_RATE.TX_DATE ) C
                  ON C.FUND_NO = A.FUND_NO
                JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
                  ON NTD_EXRATE.FUND_NO = A.FUND_NO
                 AND NTD_EXRATE.TX_DATE = A.PUR_DATE 
               WHERE A.FUND_NO = ALTER_REC.FUND_NO
                 AND A.ID = ALTER_REC.ID
                 AND A.ISSUE_DATE <= WINPUT_DATE
                 AND (A.CANCEL_DATE IS NULL OR A.CANCEL_DATE > WINPUT_DATE)
                 AND A.SHARES > 0
                 AND A.STATUS = '1'
             ) X;
    END IF;

    --將上述計算結果寫入【基金到價計算執行記錄檔(ECS.PRICE_LOG)】
    -- 2018.10.17  yunchu 基金淨值或停利停損若有警示，IS_READ為Ｎ，反之給NULL
    INSERT INTO ECS.PRICE_LOG
              (INPUT_DATE,EXE_TYPE,ID,FUND_NO,TYPE,
               UPPER_LIMIT,LOWER_LIMIT,BUY_IN,SELL_OUT,ALERT_PRU,
               NAV_DATE,NAV,RETURN_BAL_UNIT,RETURN_TAOTAL_COST,INVEST_RATE,
               IS_NAV_ALTER,IS_RETURN_ALTER,IS_READ)
       VALUES (WINPUT_DATE,WEXE_TYPE,ALTER_REC.ID,ALTER_REC.FUND_NO,ALTER_REC.TYPE,
               ALTER_REC.UPPER_LIMIT,ALTER_REC.LOWER_LIMIT,ALTER_REC.BUY_IN,ALTER_REC.SELL_OUT,ALTER_REC.ALERT_PRU,
               ALTER_REC.NAV_DATE,ALTER_REC.NAV,XRETURN_BAL_UNIT,XRETURN_TOTAL_COST,XINVEST_RATE,
               'N',
               -- 2018.12.27 JIANXIN MOD 調整停損到價通知錯誤問題
               CASE WHEN XINVEST_RATE >= ALTER_REC.UPPER_LIMIT THEN '1' --投資報酬率大於等於到價停利,則為"1.停利"
                    WHEN XINVEST_RATE <= ALTER_REC.LOWER_LIMIT THEN '2' --投資報酬率小於等於到價停損,則為"2.停損"
                    ELSE 'N'  --否則為"N.未到警示"
                END,
               CASE WHEN XINVEST_RATE >= ALTER_REC.UPPER_LIMIT THEN 'N' --投資報酬率大於等於到價停利,則為"1.停利"
                    WHEN XINVEST_RATE <= ALTER_REC.LOWER_LIMIT THEN 'N' --投資報酬率小於等於到價停損,則為"2.停損"
                    ELSE null  --否則為"N.未到警示"
                END);
  END LOOP;

  --2.取得寄發【基金觀察到價通知信】或【停損停利警示通知信之名單】
  -- 2018.11.28 yunchu 調整通知頻率(ALERT_FREQ)為(E:每次通知我)時,也要發送信件
  INSERT INTO ECS.ECSB009_FundAlertList
        (INPUT_DATE,ID,FUND_NO,TYPE)
  SELECT A.INPUT_DATE,
         A.ID,
         A.FUND_NO,
         A.TYPE
    FROM ECS.PRICE_LOG A
    JOIN FAS.HOLDER B ON B.ID = A.ID
    JOIN WPS.FUND_ALERT C ON C.ID = A.ID AND C.FUND_NO = A.FUND_NO AND C.TYPE = A.TYPE AND C.ALERT = 'Y'
    JOIN WPS.FUND_ALERT_TYPE D ON D.ID = A.ID AND D.FUND_NO = A.FUND_NO AND D.TYPE = A.TYPE AND
                                  D.ALERT_TYPE = '2' AND ((D.ALERT_FREQ = '1' AND D.ALERTED = '0') OR (D.ALERT_FREQ = 'E'))
   WHERE A.INPUT_DATE = WINPUT_DATE
     AND A.TYPE IN ('0','1')
     AND (A.IS_NAV_ALTER <> 'N' OR A.IS_RETURN_ALTER <> 'N')
     AND (B.EMAIL IS NOT NULL OR B.EMAIL <> ' ')
     AND B.EMAIL_VALID = 'Y';

  --2.1 若無任何符合的資料,須通知前端
  SELECT COUNT(*) INTO XCOUNT
    FROM ECS.ECSB009_FundAlertList;

  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
  END IF;

  --3.將上述名單的「已通知(ALERTED)」設為"1:已通知"
  UPDATE WPS.FUND_ALERT_TYPE
     SET ALERTED = '1' --已通知
   WHERE ALERT_TYPE = '2'
     AND ID||FUND_NO||TYPE IN (SELECT ID||FUND_NO||TYPE FROM ECS.ECSB009_FundAlertList);

  --4.將基金觀察名單及名單中的基金提示傳回前端寄發Email
  --4.1 傳回基金觀察Mail名單
  -- 2018.11.29 yunchu 調整Mail名單
  OPEN CMSGLIST_NM FOR
    --SELECT X.INPUT_DATE,X.ID,X.TYPE,
    --       Y.NAME BF_NAME,  --受益人姓名
    --       Y.EMAIL BF_EMAIL --收件人Email
    --  FROM (SELECT DISTINCT INPUT_DATE,ID,TYPE FROM ECS.ECSB009_FundAlertList WHERE TYPE = '1') X
    --  JOIN FAS.HOLDER Y ON Y.ID = X.ID;

    SELECT A.INPUT_DATE,        --執行日期
           A.ID,A.TYPE,
           Y.NAME BF_NAME,  --受益人姓名
           Y.EMAIL BF_EMAIL --收件人Email
      FROM ECS.ECSB009_FundAlertList A
      --JOIN ECS.PRICE_LOG B ON B.INPUT_DATE = A.INPUT_DATE AND B.ID = A.ID AND B.TYPE = A.TYPE
      JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
      JOIN FAS.HOLDER Y ON Y.ID = A.ID
      JOIN ECS.PRICE_LOG D ON D.INPUT_DATE = A.INPUT_DATE AND D.ID = A.ID AND D.FUND_NO = A.FUND_NO AND D.TYPE = A.TYPE
     WHERE A.TYPE = '1'
     ORDER BY A.ID;

  --4.2 傳回基金觀察Mail名單中的基金到價提示
  -- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
  OPEN CMSGLIST_NMLIST FOR
    SELECT D.NAV_DATE AS INPUT_DATE, --淨值日期
           A.ID,A.TYPE,
           C.SNAME FUND_SNAME,  --基金名稱
           D.NAV,               --最新淨值
           CASE WHEN D.IS_NAV_ALTER = '1' THEN '買進'
                WHEN D.IS_NAV_ALTER = '2' THEN '賣出'
                ELSE NULL
            END IS_NAV_ALTER, --(淨值)到達警示類別
           CASE WHEN D.IS_NAV_ALTER = '1' THEN D.BUY_IN
                WHEN D.IS_NAV_ALTER = '2' THEN D.SELL_OUT
                ELSE NULL
            END GOAL_NAV  --目標淨值
      FROM ECS.ECSB009_FundAlertList A
      --JOIN ECS.PRICE_LOG B ON B.INPUT_DATE = A.INPUT_DATE AND B.ID = A.ID AND B.TYPE = A.TYPE
      JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
      JOIN ECS.PRICE_LOG D ON D.INPUT_DATE = A.INPUT_DATE AND D.ID = A.ID AND D.FUND_NO = A.FUND_NO AND D.TYPE = A.TYPE
     WHERE A.TYPE = '1'
     ORDER BY A.ID;

  --5.將停損停利名單及名單中的基金提示傳回前端寄發Email
  --5.1 傳回停損停利Mail名單
  -- 2018.11.29 yunchu 調整Mail名單
  OPEN CMSGLIST_GL FOR
   -- SELECT X.INPUT_DATE,X.ID,X.TYPE,
   --        Y.NAME BF_NAME,  --受益人姓名
   --       Y.EMAIL BF_EMAIL --收件人Email
   --   FROM (SELECT DISTINCT INPUT_DATE,ID,TYPE FROM ECS.ECSB009_FundAlertList WHERE TYPE = '0') X
   --   JOIN FAS.HOLDER Y ON Y.ID = X.ID;

    SELECT A.INPUT_DATE,        --執行日期
           A.ID,A.TYPE,
           Y.NAME BF_NAME,  --受益人姓名
           Y.EMAIL BF_EMAIL --收件人Email
      FROM ECS.ECSB009_FundAlertList A
      JOIN FAS.HOLDER Y ON Y.ID = A.ID
      --JOIN ECS.PRICE_LOG B ON B.INPUT_DATE = A.INPUT_DATE AND B.ID = A.ID AND B.TYPE = A.TYPE
      JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
      JOIN ECS.PRICE_LOG D ON D.INPUT_DATE = A.INPUT_DATE AND D.ID = A.ID AND D.FUND_NO = A.FUND_NO AND D.TYPE = A.TYPE
     WHERE A.TYPE = '0'
     ORDER BY A.ID;

  --5.2 傳回停損停利Mail名單中的基金到價提示
  -- 2019.03.12 yunchu 調整取受益憑證檔須為有效、信件內容日期改為淨值日期
  OPEN CMSGLIST_GLLIST FOR
    SELECT D.NAV_DATE AS INPUT_DATE, --淨值日期
           A.ID,
           A.TYPE,
           C.SNAME FUND_SNAME,  --基金名稱
           D.NAV,               --最新淨值
           CASE WHEN D.IS_NAV_ALTER = '1' THEN '買進'
                WHEN D.IS_NAV_ALTER = '2' THEN '賣出'
                ELSE NULL
            END IS_NAV_ALTER, --(淨值)到達警示類別(若不為null,則表示停損停利以"淨值"提示)
           CASE WHEN D.IS_NAV_ALTER = '1' THEN D.BUY_IN
                WHEN D.IS_NAV_ALTER = '2' THEN D.SELL_OUT
                ELSE NULL
            END GOAL_NAV,     --目標淨值
           CASE WHEN D.IS_RETURN_ALTER = '1' THEN '停利'
                WHEN D.IS_RETURN_ALTER = '2' THEN '停損'
                ELSE NULL
            END IS_RETURN_ALTER, --(報酬率)到達警示類別(若不為null,則表示停損停利以"報酬率"提示
           CASE WHEN D.IS_RETURN_ALTER = '1' THEN D.UPPER_LIMIT
                WHEN D.IS_RETURN_ALTER = '2' THEN D.LOWER_LIMIT
                ELSE NULL
            END GOAL_INVEST_RATE --目標報酬率
      FROM ECS.ECSB009_FundAlertList A
      --JOIN ECS.PRICE_LOG B ON B.INPUT_DATE = A.INPUT_DATE AND B.ID = A.ID AND B.TYPE = A.TYPE
      JOIN FAS.FUND C ON C.FUND_NO = A.FUND_NO
      JOIN ECS.PRICE_LOG D ON D.INPUT_DATE = A.INPUT_DATE AND D.ID = A.ID AND D.FUND_NO = A.FUND_NO AND D.TYPE = A.TYPE
     WHERE A.TYPE = '0'
     ORDER BY A.ID;

END S_ECSB009_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB009_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB010_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB010_EXECUTE" --投資人開戶資料批次開戶作業
-- =============================================
-- Author:      Chengyu
-- Create date: 2018.08.21
-- Description: 未完成開戶資料刪除作業
-- 2020.10.12 by Chengyu 新增刪除線上開戶資料
-- 2021.11.08 by Chengyu 新增刪除ECS.HOLDER_TMP資料
-- =============================================
(
    WEXEC_DATE              IN DATE,          --資料處理日期
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE           OUT VARCHAR2      --完成狀能(S:執行成功, F:執行失敗, X:無資料)
) IS
  --變數宣告
  XSYS_DATE DATE;   --執行日期
  XSYS_DTTM DATE;   --執行時間
  XCOUNT NUMBER(9); --筆數
  XOPEN_DATA_KEEP_DAY NUMBER(3); --開戶資料保留天數
  XDELENDDATE DATE; --刪除資料截止日期

BEGIN
  --給變數值
  XSYS_DTTM := sysdate; --取得系統日期時間
  XSYS_DATE := TO_DATE(TO_CHAR(XSYS_DTTM,'YYYYMMDD'),'YYYYMMDD');
  WFINSISH_CODE := 'S';

  BEGIN
    SELECT OPEN_DATA_KEEP_DAY INTO XOPEN_DATA_KEEP_DAY
      FROM ECS.SYSTEM_PARAMETER
     WHERE SYSTEM_ID = 'ECS';
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        XOPEN_DATA_KEEP_DAY := 90;
  END;

  --取得刪除資料截止日期
  XDELENDDATE := XSYS_DATE - XOPEN_DATA_KEEP_DAY;

  --1.自【預約開戶資料(ECS.HOLDER)】取得合乎下列條件的ID,宗寫入暫存檔
  --  a.開戶類別(OPEN_TYPE)」='1.預約開戶'
  --  b.作業處理碼(PROCESS_CODE)為” 0.申請開戶，待件中 或2.文件到件，退件中 或5.股務審核失敗，退件中”
  --  c.申請日期(APPLY_DATE)小於等於『刪除資料截止日期』
  -- 2020.10.12 by Chengyu 新增刪除線上開戶資料
  INSERT INTO ECS.ECSB007_IDList (ID)
  SELECT A.ID
    FROM ECS.HOLDER A
   WHERE A.PROCESS_CODE IN ('0','2','5')
     AND TO_DATE(TO_CHAR(A.APPLY_DTTM,'YYYYMMDD'),'YYYYMMDD') <= XDELENDDATE;

  -- 2021.11.08 by Chengyu 新增刪除ECS.HOLDER_TMP資料
  INSERT INTO ECS.ECSB007_IDList (ID)
  SELECT HOLDER_TMP.ID
    FROM ECS.HOLDER_TMP
    LEFT JOIN ECS.HOLDER
      ON HOLDER.ID = HOLDER_TMP.ID
   WHERE HOLDER_TMP.FINISH_DTTM IS NULL
     AND HOLDER.ID IS NULL
     AND TO_DATE(TO_CHAR(HOLDER_TMP.APPLY_DTTM,'YYYYMMDD'),'YYYYMMDD') <= XDELENDDATE;

  SELECT COUNT(*) INTO XCOUNT FROM ECS.ECSB007_IDList;
  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
    RETURN;
  END IF;

  --2.將上述ID的預約開戶資料刪除
  -- 2021.11.08 by Chengyu 新增刪除ECS.HOLDER_TMP資料
  DELETE FROM ECS.HOLDER_TMP
   WHERE ID IN (SELECT DISTINCT ID FROM ECS.ECSB007_IDList);
  DELETE FROM ECS.HOLDER
   WHERE ID IN (SELECT DISTINCT ID FROM ECS.ECSB007_IDList);
  DELETE FROM ECS.HOLDER_DOC
   WHERE ID IN (SELECT DISTINCT ID FROM ECS.ECSB007_IDList);
  DELETE FROM ECS.HOLDER_REJECT
   WHERE ID IN (SELECT DISTINCT ID FROM ECS.ECSB007_IDList);

END S_ECSB010_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB010_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB011_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB011_EXECUTE" --RSP & DRSP 扣款前通知信寄發作業
-- =============================================
-- Author:      STU
-- Create date: 2018.07.20
-- 2018.12.06 yunchu 增加email判斷不為空
-- 2018.12.11 yunchu 調整姓名為隱碼
-- =============================================
(
    WEXEC_DATE      IN DATE,          --執行條件日期時分
    WEXEC_UERID     IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE   OUT VARCHAR2,     --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    LIST_DATA       OUT SYS_REFCURSOR,--RSP資料寄發名單表
    LIST_ON_RSP     OUT SYS_REFCURSOR,--境內RSP扣款前通知明細
    LIST_ON_DRSP    OUT SYS_REFCURSOR,--境內DRSP扣款前通知明細
    LIST_OFF_RSP    OUT SYS_REFCURSOR,--境外RSP扣款前通知明細
    LIST_OFF_DRSP   OUT SYS_REFCURSOR --境外DRSP扣款前通知明細
) IS
  --變數宣告
  XSYS_DATE DATE;   --執行日期
  XSYS_DTTM DATE;   --執行時間
  XCOUNT NUMBER(9); --筆數
  XDEF_SUB_DATE DATE; --預計扣款日

BEGIN
  --給變數值
  XSYS_DTTM := sysdate; --取得系統日期時間
  XSYS_DATE := TO_DATE(TO_CHAR(XSYS_DTTM,'YYYYMMDD'),'YYYYMMDD');
  WFINSISH_CODE := 'S';

  --取得預計扣款日(=系統日期 再加上2個日曆日)
  XDEF_SUB_DATE := XSYS_DATE + 2;

  --1.自【後台EC RSP契約資料檔(FAS.EC_RSP)】取得合乎下列條件的ID及ID_SEQ寫入暫存檔
  --  a.契約狀態(STATUS)」= “4.有效"
  --  b.扣款日(AC_DAY)」= 預計扣款日
  --  c.受益人檔(FAS.HOLDER)】的「電子郵件帳號有效註記(EMAIL_VALID)」= ”Y.有效”
  INSERT INTO ECS.RSPList (ID,ID_SEQ)
  SELECT A.ID,A.ID_SEQ
    FROM FAS.EC_RSP A
    JOIN FAS.HOLDER B ON B.ID = A.ID
   WHERE A.STATUS = '4'
     AND A.AC_DAY = TO_CHAR(XDEF_SUB_DATE,'DD')
     AND B.EMAIL_VALID = 'Y'
	 -- 2018.12.10 yunchu 增加email判斷不為空
     AND B.EMAIL IS NOT NULL;

  SELECT COUNT(*) INTO XCOUNT FROM ECS.RSPList;

  IF XCOUNT = 0 THEN
    WFINSISH_CODE := 'X';
  ELSE
    WFINSISH_CODE := 'S';
  END IF;

    --2.找出RSP資料寄發名單表
	-- 2018.12.06 yunchu 增加email判斷不為空
	-- 2018.12.11 yunchu 調整姓名為隱碼
    OPEN LIST_DATA FOR
      SELECT DISTINCT B.ID,D.NAME AS AC_NAME,D.Email,B.BANK_NO,B.AC_CODE,B.PRODUCT_TYPE
        FROM ECS.RSPList A
        JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ
        JOIN FAS.HOLDER D ON D.ID = B.ID
       ORDER BY B.ID;

    --3.找出境內RSP扣款前通知明細
    OPEN LIST_ON_RSP FOR
      SELECT B.ID,
             D.NAME BF_NAME,    --受益人姓名
             D.EMAIL BF_EMAIL,  --寄發EMAIL
             C.FUND_CATEGORY,   --基金類別(境內)
             B.BANK_NO AC_BANK, --扣款銀行代碼
             E.NAME AC_NAME,    --扣款銀行名稱
             CASE WHEN LENGTH(B.AC_CODE) <= 10 THEN B.AC_CODE
                  ELSE SUBSTRB(B.AC_CODE,1,4)||'XXXXXX'||SUBSTRB(B.AC_CODE,11,LENGTH(B.AC_CODE)-10)
              END AC_CODE, --銀行帳號
             CASE WHEN B.PRODUCT_TYPE = 'P8' THEN '定期定額' ELSE '定期不定額' END RSP_TYPE, --契約類別
             B.ID_SEQ,      --契約編號
             B.FUND_NO,     --基金代碼
             C.SNAME FUND_SNAME, --基金名稱
             C.TX_CALENDAR_CODE, --交易日行事曆類別
             B.AC_DAY,           --扣款日
             B.AMOUNT SUB_AMT,  --扣款金額
             F.NAME CRNCY_NM,   --申購幣別
             ECS.F_GetRealSubDate(B.FUND_NO,C.TX_CALENDAR_CODE,XDEF_SUB_DATE) REAL_SUB_DATE, --實際扣款日期
             (SELECT NVL(COUNT(*),0)
                FROM FAS.EC_RSP_PURCHASE R
               WHERE R.AC_DATE < C.AC_DATE
                 AND R.ID = B.ID AND R.ID_SEQ = B.ID_SEQ AND R.FUND_NO = B.FUND_NO
                 AND R.RESULT_CODE = '00' AND R.STATUS = 'P'
              ) SUS_CNT --累計扣款成功次數
        FROM ECS.RSPList A
        JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ AND B.PRODUCT_TYPE = 'P8' --定期定額
        JOIN FAS.FUND C ON C.FUND_NO = B.FUND_NO AND C.FUND_CATEGORY = '1' --境內
        JOIN FAS.HOLDER D ON D.ID = A.ID
        LEFT JOIN FAS.FIS_BANK E ON E.BANK_NO = B.BANK_NO
        LEFT JOIN ECS.V_FUND_CRNCY F ON F.CURRENCY_NO = B.CURRENCY_NO
       ORDER BY B.ID;

    --4.找出境內DRSP扣款前通知明細
    OPEN LIST_ON_DRSP FOR
      SELECT B.ID,
             D.NAME BF_NAME,    --受益人姓名
             D.EMAIL BF_EMAIL,  --寄發EMAIL
             C.FUND_CATEGORY,   --基金類別(境內)
             B.BANK_NO AC_BANK, --扣款銀行代碼
             E.NAME AC_NAME,    --扣款銀行名稱
             CASE WHEN LENGTH(B.AC_CODE) <= 10 THEN B.AC_CODE
                  ELSE SUBSTRB(B.AC_CODE,1,4)||'XXXXXX'||SUBSTRB(B.AC_CODE,11,LENGTH(B.AC_CODE)-10)
              END AC_CODE, --銀行帳號
             CASE WHEN B.PRODUCT_TYPE = 'P8' THEN '定期定額' ELSE '定期不定額' END RSP_TYPE, --契約類別
             B.ID_SEQ,      --契約編號
             B.FUND_NO,     --基金代碼
             C.SNAME FUND_SNAME, --基金名稱
             C.TX_CALENDAR_CODE, --交易日行事曆類別
             B.AC_DAY,           --扣款日
             B.AMOUNT SUB_AMT,   --扣款金額
             F.NAME CRNCY_NM,    --申購幣別
             B.RAISE_ROI,        --加碼點
             B.RAISE_AMOUNT,     --加碼金額
             B.REDUCE_ROI,       --減碼點
             B.REDUCE_AMOUNT,    --減碼金額
             ECS.F_GetRealSubDate(B.FUND_NO,C.TX_CALENDAR_CODE,XDEF_SUB_DATE) REAL_SUB_DATE, --實際扣款日期
             (SELECT NVL(COUNT(*),0)
                FROM FAS.EC_RSP_PURCHASE R
               WHERE R.AC_DATE < C.AC_DATE
                 AND R.ID = B.ID AND R.ID_SEQ = B.ID_SEQ AND R.FUND_NO = B.FUND_NO
                 AND R.RESULT_CODE = '00' AND R.STATUS = 'P'
              ) SUS_CNT --累計扣款成功次數
        FROM ECS.RSPList A
        JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ AND B.PRODUCT_TYPE = 'P9' --定期不定額
        JOIN FAS.FUND C ON C.FUND_NO = B.FUND_NO AND C.FUND_CATEGORY = '1' --境內
        JOIN FAS.HOLDER D ON D.ID = A.ID
        LEFT JOIN FAS.FIS_BANK E ON E.BANK_NO = B.BANK_NO
        LEFT JOIN ECS.V_FUND_CRNCY F ON F.CURRENCY_NO = B.CURRENCY_NO
       ORDER BY B.ID;

    --5.找出境外RSP扣款前通知明細
    OPEN LIST_OFF_RSP FOR
      SELECT B.ID,
             D.NAME BF_NAME,    --受益人姓名
             D.EMAIL BF_EMAIL,  --寄發EMAIL
             C.FUND_CATEGORY,   --基金類別(境內)
             B.BANK_NO AC_BANK, --扣款銀行代碼
             E.NAME AC_NAME,    --扣款銀行名稱
             CASE WHEN LENGTH(B.AC_CODE) <= 10 THEN B.AC_CODE
                  ELSE SUBSTRB(B.AC_CODE,1,4)||'XXXXXX'||SUBSTRB(B.AC_CODE,11,LENGTH(B.AC_CODE)-10)
              END AC_CODE, --銀行帳號
             CASE WHEN B.PRODUCT_TYPE = 'P8' THEN '定期定額' ELSE '定期不定額' END RSP_TYPE, --契約類別
             B.ID_SEQ,      --契約編號
             B.FUND_NO,     --基金代碼
             C.SNAME FUND_SNAME, --基金名稱
             C.TX_CALENDAR_CODE, --交易日行事曆類別
             B.AC_DAY,           --扣款日
             B.AMOUNT SUB_AMT,  --扣款金額
             F.NAME CRNCY_NM,   --申購幣別
             ECS.F_GetRealSubDate(B.FUND_NO,C.TX_CALENDAR_CODE,XDEF_SUB_DATE) REAL_SUB_DATE, --實際扣款日期
             (SELECT NVL(COUNT(*),0)
                FROM FAS.EC_RSP_PURCHASE R
               WHERE R.AC_DATE < C.AC_DATE
                 AND R.ID = B.ID AND R.ID_SEQ = B.ID_SEQ AND R.FUND_NO = B.FUND_NO
                 AND R.RESULT_CODE = '00' AND R.STATUS = 'P'
              ) SUS_CNT --累計扣款成功次數
        FROM ECS.RSPList A
        JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ AND B.PRODUCT_TYPE = 'P8' --定期定額
        JOIN FAS.FUND C ON C.FUND_NO = B.FUND_NO AND C.FUND_CATEGORY = '2' --境外
        JOIN FAS.HOLDER D ON D.ID = A.ID
        LEFT JOIN FAS.FIS_BANK E ON E.BANK_NO = B.BANK_NO
        LEFT JOIN ECS.V_FUND_CRNCY F ON F.CURRENCY_NO = B.CURRENCY_NO
       ORDER BY B.ID;

    --6.找出境外DRSP扣款前通知明細
    OPEN LIST_OFF_DRSP FOR
      SELECT B.ID,
             D.NAME BF_NAME,    --受益人姓名
             D.EMAIL BF_EMAIL,  --寄發EMAIL
             C.FUND_CATEGORY,   --基金類別(境內)
             B.BANK_NO AC_BANK, --扣款銀行代碼
             E.NAME AC_NAME,    --扣款銀行名稱
             CASE WHEN LENGTH(B.AC_CODE) <= 10 THEN B.AC_CODE
                  ELSE SUBSTRB(B.AC_CODE,1,4)||'XXXXXX'||SUBSTRB(B.AC_CODE,11,LENGTH(B.AC_CODE)-10)
              END AC_CODE, --銀行帳號
             CASE WHEN B.PRODUCT_TYPE = 'P8' THEN '定期定額' ELSE '定期不定額' END RSP_TYPE, --契約類別
             B.ID_SEQ,      --契約編號
             B.FUND_NO,     --基金代碼
             C.SNAME FUND_SNAME, --基金名稱
             C.TX_CALENDAR_CODE, --交易日行事曆類別
             B.AC_DAY,           --扣款日
             B.AMOUNT SUB_AMT,   --扣款金額
             F.NAME CRNCY_NM,    --申購幣別
             B.RAISE_ROI,        --加碼點
             B.RAISE_AMOUNT,     --加碼金額
             B.REDUCE_ROI,       --減碼點
             B.REDUCE_AMOUNT,    --減碼金額
             ECS.F_GetRealSubDate(B.FUND_NO,C.TX_CALENDAR_CODE,XDEF_SUB_DATE) REAL_SUB_DATE, --實際扣款日期
             (SELECT NVL(COUNT(*),0)
                FROM FAS.EC_RSP_PURCHASE R
               WHERE R.AC_DATE < C.AC_DATE
                 AND R.ID = B.ID AND R.ID_SEQ = B.ID_SEQ AND R.FUND_NO = B.FUND_NO
                 AND R.RESULT_CODE = '00' AND R.STATUS = 'P'
              ) SUS_CNT --累計扣款成功次數
        FROM ECS.RSPList A
        JOIN FAS.EC_RSP B ON B.ID = A.ID AND B.ID_SEQ = A.ID_SEQ AND B.PRODUCT_TYPE = 'P9' --定期不定額
        JOIN FAS.FUND C ON C.FUND_NO = B.FUND_NO AND C.FUND_CATEGORY = '2' --境外
        JOIN FAS.HOLDER D ON D.ID = A.ID
        LEFT JOIN FAS.FIS_BANK E ON E.BANK_NO = B.BANK_NO
        LEFT JOIN ECS.V_FUND_CRNCY F ON F.CURRENCY_NO = B.CURRENCY_NO
       ORDER BY B.ID;

END S_ECSB011_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB011_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB012_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB012_EXECUTE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/12/17
-- Description: 優惠券發放通知信寄發作業
-- =============================================
(
    WEXEC_DATE     DATE               -- 執行日期
   ,OUT_ECSB012    OUT SYS_REFCURSOR  -- 回傳的 TABLEDATA
) IS
BEGIN

    OPEN OUT_ECSB012 FOR
    SELECT  ECSB012_DATA.SOURCE_TYPE
           ,ECSB012_DATA.ID
           ,ECSB012_DATA.NAME
           ,ECSB012_DATA.EMAIL
           ,ECSB012_DATA.VALID_THRU
           ,ECSB012_DATA.PROGRAM_NO
           ,ECSB012_DATA.PROGRAM_NAME
           ,LISTAGG(COUPON_ID, ',') WITHIN GROUP (ORDER BY ID,PROGRAM_NO) AS COUPON_ID
      FROM (SELECT  CASE WHEN HOLDER.ID IS NOT NULL THEN '1'
                         ELSE '2'
                    END SOURCE_TYPE      -- 1:既有客戶 2:非既有客戶
                   ,COUPON_DATA.ID AS ID -- 受益人ID
                   ,CASE WHEN COUPON_DATA.NAME IS NOT NULL THEN COUPON_DATA.NAME
                         WHEN HOLDER.NAME IS NOT NULL THEN HOLDER.NAME
                         ELSE ''
                    END AS NAME          -- 受益姓名
                   ,CASE WHEN COUPON_DATA.EMAIL IS NOT NULL THEN COUPON_DATA.EMAIL
                         WHEN HOLDER.EMAIL IS NOT NULL AND HOLDER.EMAIL_VALID = 'Y' THEN HOLDER.EMAIL
                         ELSE ''
                    END AS EMAIL         -- Email
                   ,COUPON_DATA.COUPON_ID AS COUPON_ID       -- 優惠券號碼
                   ,COUPON_DATA.VALID_THRU AS VALID_THRU     -- 截止日
                   ,COUPON_PROGRAM.PROGRAM_NO AS PROGRAM_NO  -- 活動代碼
                   ,COUPON_PROGRAM.NAME AS PROGRAM_NAME      -- 活動名稱
              FROM ECS.COUPON_DATA
              LEFT JOIN FAS.HOLDER
                ON HOLDER.ID = COUPON_DATA.ID
               AND HOLDER.CLOSE_DATE IS NULL
               AND HOLDER.EC_DATE IS NOT NULL
              LEFT JOIN ECS.COUPON_PROGRAM
                ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO
             WHERE TRUNC(COUPON_DATA.VALID_FROM) <= TRUNC(WEXEC_DATE)
               AND COUPON_DATA.IS_EMAIL = 'N'
           )ECSB012_DATA
     WHERE ECSB012_DATA.EMAIL IS NOT NULL
     GROUP BY ECSB012_DATA.SOURCE_TYPE
             ,ECSB012_DATA.ID
             ,ECSB012_DATA.NAME
             ,ECSB012_DATA.EMAIL
             ,ECSB012_DATA.VALID_THRU
             ,ECSB012_DATA.PROGRAM_NO
             ,ECSB012_DATA.PROGRAM_NAME;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSB012_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB012_UPDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB012_UPDATE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/12/17
-- Description: 更新寄發過的優惠券發放通知信
-- =============================================
(
    WID            VARCHAR2           -- 客戶ID
   ,WPROGRAM_NO    VARCHAR2           -- 活動代碼
) IS
BEGIN

    UPDATE ECS.COUPON_DATA
       SET COUPON_DATA.IS_EMAIL = 'Y'
     WHERE COUPON_DATA.ID = WID
       AND COUPON_DATA.PROGRAM_NO = WPROGRAM_NO;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSB012_UPDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB013_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB013_EXECUTE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/01/02
-- Description: 優惠券即將到期提醒通知信寄發作業
-- =============================================
(
     WEXEC_DATE     DATE               -- 執行日期
    ,OUT_ECSB013    OUT SYS_REFCURSOR  -- 回傳的 TABLEDATA
) IS
BEGIN
     OPEN OUT_ECSB013 FOR
     SELECT *
       FROM (SELECT CASE WHEN HOLDER.ID IS NOT NULL THEN '1'
                         ELSE '2'
                    END SOURCE_TYPE     -- 1:既有客戶 2:非既有客戶 
                   ,CASE WHEN COUPON_DATA.NAME IS NOT NULL THEN COUPON_DATA.NAME
                         WHEN HOLDER.NAME IS NOT NULL THEN HOLDER.NAME
                         ELSE ''
                    END NAME            -- 受益人姓名
                   ,CASE WHEN COUPON_DATA.EMAIL IS NOT NULL THEN COUPON_DATA.EMAIL
                         WHEN HOLDER.EMAIL IS NOT NULL AND HOLDER.EMAIL_VALID = 'Y' THEN HOLDER.EMAIL
                         ELSE ''
                    END EMAIL           -- EMAIL
                   ,COUPON_PROGRAM.NAME AS PROGRAM_NAME
                   ,COUPON_DATA.VALID_THRU
                   ,COUNT(1) AS COUPON_CNT    --優惠券張數
              FROM ECS.COUPON_DATA
              LEFT JOIN FAS.HOLDER
                ON HOLDER.ID = COUPON_DATA.ID
               AND HOLDER.CLOSE_DATE IS NULL
               AND HOLDER.EC_DATE IS NOT NULL
              LEFT JOIN ECS.COUPON_PROGRAM
                ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO
             WHERE TO_CHAR(COUPON_DATA.VALID_THRU,'YYYYMM') = TO_CHAR(WEXEC_DATE,'YYYYMM')
               AND COUPON_DATA.IS_EFFECT = 'Y'
             GROUP BY HOLDER.ID
                     ,COUPON_DATA.ID
                     ,HOLDER.NAME
                     ,COUPON_DATA.NAME
                     ,HOLDER.EMAIL
                     ,COUPON_DATA.EMAIL
                     ,COUPON_DATA.PROGRAM_NO
                     ,COUPON_PROGRAM.NAME
                     ,COUPON_DATA.VALID_THRU
                     ,HOLDER.EMAIL_VALID
            )ECSB013_DATA
      WHERE ECSB013_DATA.EMAIL IS NOT NULL;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSB013_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB014_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB014_EXECUTE" --受益人ID變更處理作業
-- =============================================
-- Author:      STU
-- Create date: 2018/10/29
-- Description: 受益人ID變更處理作業
-- 2019.01.23 yunchu 增加寄發給客戶資料及移除更新變更ID記錄改由API更新
-- =============================================
(
    WEXEC_DATE              IN DATE,          --執行條件日期時分
    WEXEC_UERID             IN VARCHAR2,      --執行者代碼
    WFINSISH_CODE           OUT VARCHAR2,     --完成狀能(S:執行成功, F:執行失敗, X:無資料)
    CMSGLIST                OUT SYS_REFCURSOR --回傳表列
) IS
  --變數宣告
  XCONDITION_DATE DATE;
  XSYS_DTTM DATE;
  XDATA_COUNT INTEGER;

BEGIN
  --給變數值
  XCONDITION_DATE := TO_DATE(TO_CHAR(WEXEC_DATE,'YYYYMMDD'),'YYYYMMDD'); --取得傳入參數中的日期
  XSYS_DTTM := sysdate;--取得系統日期時間

  SELECT COUNT(1)
    INTO XDATA_COUNT
    FROM ECS.ID_CHANGE_LOG
   WHERE IS_UPDATE_LDAP = 'N';

  IF XDATA_COUNT = 0 THEN
    BEGIN
      WFINSISH_CODE := 'X';      
      OPEN CMSGLIST FOR SELECT '' FROM DUAL;      
    END;
  ELSE
    BEGIN
      --2.依下述規則至【變更ID記錄(ECS.ID_CHANGE_LOG)】取得要變更ID的客戶資料
      --2.1.「變更LDAP系統(IS_UPDATE_LDAP)」=”N.未更新”
      DECLARE CURSOR UPDATE_DATA IS
       SELECT ID      AS ID      --受益人ID
              ,NEW_ID AS NEW_ID  --(新)受益人ID
         FROM ECS.ID_CHANGE_LOG
        WHERE IS_UPDATE_LDAP = 'N';

      BEGIN
        FOR UPDATE_ROW IN UPDATE_DATA LOOP

          --3.1.  購物車紀錄檔(ECS.SHOP_CART)的「ID (ID)」
          UPDATE ECS.SHOP_CART
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.2.  受益人行銷身分群組(ECS.MARKET_GROUP) 的「受益人ID (ID)」
          UPDATE ECS.MARKET_GROUP
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.3.  優惠券配發資料(ECS.COUPON_DATA) 的「受益人ID (ID)」
          UPDATE ECS.COUPON_DATA
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.4.  優惠券歷史使用明細(ECS.COUPON_HISTORY) 的「受益人ID (ID)」
          UPDATE ECS.COUPON_HISTORY
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.5.  Robo 契約解約資料(ECS.ROBO_DISMISSAL) 的「受益人ID (ID)」
          UPDATE ECS.ROBO_DISMISSAL
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.6.  預約開戶資料(ECS.HOLDER) 的「客戶ID (ID)」
          UPDATE ECS.HOLDER
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.7.  預約開戶文件檔(ECS.HOLDER_DOC) 的「客戶ID (ID)」
          UPDATE ECS.HOLDER_DOC
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.8.  預約開戶退件記錄(ECS.HOLDER_REJECT) 的「客戶ID (ID)」
          UPDATE ECS.HOLDER_REJECT
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.9.  預約開戶暫存資料(ECS.HOLDER_TMP) 的「客戶ID (ID)」
          UPDATE ECS.HOLDER_TMP
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.10.  開戶登入憑證記錄檔(ECS.OPEN_TOKEN_POOL) 的「客戶ID (ID)」
          UPDATE ECS.OPEN_TOKEN_POOL
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.11.  開戶手機證件上傳檔(ECS.OPEN_MOBILE_UPLOAD_DATA) 的「客戶ID (ID)」
          UPDATE ECS.OPEN_MOBILE_UPLOAD_DATA
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.12.  預約開戶網路上傳資料(ECS.HOLDER_UPLOAD_DATA) 的「客戶ID (ID)」
          UPDATE ECS.HOLDER_UPLOAD_DATA
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.13.  簡訊紀錄檔(ECS.OTP_RECORD) 的「客戶ID (ID)」
          UPDATE ECS.OTP_RECORD
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.14.  基金到價計算執行記錄檔(ECS.PRICE_LOG) 的「受益人ID (ID)」
          UPDATE ECS.PRICE_LOG
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.15.  停損停利到價通知(WPS.FUND_ALERT) 的「受益人ID (ID)」
          UPDATE WPS.FUND_ALERT
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          --3.16.  基金到價及停損停利設定(WPS.FUND_ALERT_TYPE) 的「受益人ID (ID)」
          UPDATE WPS.FUND_ALERT_TYPE
             SET ID = UPDATE_ROW.NEW_ID
           WHERE ID = UPDATE_ROW.ID;

          -- 2019.01.23 yunchu 增加寄發給客戶資料及移除更新變更ID記錄改由API更新
          --5.  執行後，更新【變更ID記錄(ECS.ID_CHANGE_LOG)】檔
          --UPDATE ECS.ID_CHANGE_LOG
          --   SET  IS_UPDATE_LDAP = 'Y'
          --       ,UPDATEID = WEXEC_UERID
          --       ,UPDATEDATE = XSYS_DTTM
          -- WHERE ID = UPDATE_ROW.ID;

        END LOOP;

        -- 2019.01.23 yunchu 增加寄發給客戶資料及移除更新變更ID記錄改由API更新      
        OPEN CMSGLIST FOR 
          SELECT  ID_CHANGE_LOG.NEW_ID AS ID
                 ,HOLDER.NAME AS BF_NAME
                 ,HOLDER.EMAIL AS BF_EMAIL
                 ,TO_DATE(TO_CHAR(HOLDER.BIRTH_DATE,'YYYYMMDD'),'YYYYMMDD') AS BIRTH_DATE
            FROM ECS.ID_CHANGE_LOG
            JOIN ECS.HOLDER
              ON ID_CHANGE_LOG.NEW_ID = HOLDER.ID
           WHERE IS_UPDATE_LDAP = 'N'
             AND HOLDER.EMAIL is not null;

      END;      

      WFINSISH_CODE := 'S';

    END;
  END IF;
END S_ECSB014_Execute;

/

  GRANT EXECUTE ON "ECS"."S_ECSB014_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB015_EXECUTE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB015_EXECUTE" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2018/11/20
-- Description: 網路後續通知信寄發處理作業
-- 2018.11.26 ChengYu 調整使用的TABLE 名稱
-- 2018.11.27 ChengYu 四捨五入在SP處理
-- 2018.11.27 ChengYu 修正定期(不)定額 交易失敗判斷、扣款失敗三次金額、日期
-- 2018.12.04 tingting 調整扣款失敗三次取日期、金額的取法
-- 2018.12.06 JIANXIN 依據William 確認 現行EC 是沒有境外基金轉申購，故而改為計價幣別
-- 2018.12.07 tingting 增加生日賀卡通知信
-- 2018.12.10 ChengYu 小數位數取原幣小數位數
-- 2018.12.10 ChengYu 寄發生日賀卡排除沒有Email狀況
-- 2018.12.11 tingting 調整定額三次扣款失敗通知信判斷條件
-- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
-- 2018.12.19 ChengYu 修正買回效能
-- 2018.12.19 ChengYu 調整買回幣別欄位
-- 2018.04.22 JIANXIN 調整贖回單位數由 EC 而來     
-- 2018.04.23 JIANXIN 調整資料串接錯誤問題        
-- =============================================
(
    WQUERY_TYPE       IN VARCHAR2                -- 執行信件種類 (1：單筆申購成功與失敗通知信；2：網路定額扣款成功與失敗通知信；3：買回交易結果通知信；4：轉申購交易結果通知信；5：定額三次扣款失敗通知信；6：生日賀卡通知信)   
   ,OUT_ECSB015       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS
    --變數宣告
    XDAY INTEGER;

BEGIN

    XDAY := 10 ;

    -- 單筆申購成功與失敗通知信
    IF WQUERY_TYPE = '1' THEN

        OPEN OUT_ECSB015 FOR
        SELECT  PURCHASE.ID                                                      -- 統編
               ,HOLDER.NAME                                                      -- 受益人姓名
               ,HOLDER.EMAIL                                                     -- 受益人Email
               ,PURCHASE.RESULT_CODE                                             -- 回傳代碼
               ,MSG.MSG                                                          -- 回傳訊息
               ,PURCHASE.TX_DATE AS TX_DATE                                      -- 交易日
               ,PURCHASE.FUND_NO                                                 -- 基金代碼
               ,FUND.NAME AS FUND_NAME                                           -- 基金名稱
               ,FUND.CURRENCY_NO                                                 -- 計價幣別
               ,CURRENCY.NAME AS CURRENCY_NAME                                   -- 計價幣別名稱
               ,NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) AS PAY_CURRENCY_NO   -- 付款幣別
               ,TX_CURRENCY.NAME AS PAY_CURRENCY_NAME                            -- 付款幣別名稱
               ,ROUND(PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT        -- 申購金額
               ,ROUND(PURCHASE.SERVICE_CHARGE,V_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE -- 申購手續費
               ,PURCHASE.AC_DATE AS AC_DATE                                      -- 淨值日
               ,NAV.NAV                                                          -- 淨值
               ,ROUND(FAS_PURCHASE.SHARES,FUND.SHARE_DECIMAL) AS SHARES          -- 申購單位數
               ,PURCHASE.AC_CODE                                                 -- 扣款帳號
               ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5            -- 扣款帳號後5碼
               ,PURCHASE.BROKER_NO                                               -- 總行
               ,PURCHASE.BRANCH_NO                                               -- 分行
               ,PURCHASE.SER_NO                                                  -- 序號
               ,PURCHASE.PAY_TYPE                                                -- 付款方式
               ,PAY_TYPE.NAME AS PAY_TYPE_NAME                                   -- 付款方式名稱
               ,PURCHASE.BANK_NO                                                 -- 扣款總行
               ,FIS_BANK.NAME AS BANK_NAME                                       -- 扣款銀行名稱
               ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL                          -- 金額小數位數
               ,FUND.SHARE_DECIMAL                                               -- 單位數小數位數
          FROM ECS.PURCHASE
          JOIN FAS.PURCHASE FAS_PURCHASE
            ON PURCHASE.FUND_NO = FAS_PURCHASE.FUND_NO
           AND PURCHASE.TX_DATE = FAS_PURCHASE.TX_DATE
           AND FAS_PURCHASE.BROKER_NO = '999'
           AND FAS_PURCHASE.BRANCH_NO = '8000'
           AND PURCHASE.SER_NO = FAS_PURCHASE.SER_NO
          JOIN FAS.HOLDER
            ON PURCHASE.ID = HOLDER.ID
           AND HOLDER.EMAIL IS NOT NULL
          JOIN FAS.FUND
            ON FUND.FUND_NO = PURCHASE.FUND_NO
          LEFT JOIN FAS.MSG
            ON PURCHASE.RESULT_CODE = MSG.MSG_NO
          LEFT JOIN FAS.PAY_TYPE
            ON PURCHASE.PAY_TYPE = PAY_TYPE.PAY_TYPE
          LEFT JOIN NAV.NAV
            ON PURCHASE.FUND_NO = NAV.FUND_NO
           AND PURCHASE.AC_DATE = NAV.NAV_DATE
          LEFT JOIN FAS.CURRENCY
            ON CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN FAS.CURRENCY TX_CURRENCY
            ON NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) = TX_CURRENCY.CURRENCY_NO
          LEFT JOIN FAS.FIS_BANK
            ON PURCHASE.BANK_NO = FIS_BANK.BANK_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO)
         WHERE PURCHASE.IS_EMAIL = 'N'
           AND PURCHASE.STATUS = 'P'
           AND PURCHASE.RESULT_CODE = '00'
           AND FUND.AC_DATE > PURCHASE.AC_DATE
           AND PURCHASE.TX_DATE >= FUND.AC_DATE - XDAY
         UNION
        SELECT  PURCHASE.ID                                                      -- 統編
               ,HOLDER.NAME                                                      -- 受益人姓名
               ,HOLDER.EMAIL                                                     -- 受益人Email
               ,PURCHASE.RESULT_CODE                                             -- 回傳代碼
               ,MSG.MSG                                                          -- 回傳訊息
               ,PURCHASE.TX_DATE AS TX_DATE                                      -- 交易日
               ,PURCHASE.FUND_NO                                                 -- 基金代碼
               ,FUND.NAME AS FUND_NAME                                           -- 基金名稱
               ,FUND.CURRENCY_NO                                                 -- 計價幣別
               ,CURRENCY.NAME AS CURRENCY_NAME                                   -- 計價幣別名稱
               ,NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) AS PAY_CURRENCY_NO   -- 付款幣別
               ,TX_CURRENCY.NAME AS PAY_CURRENCY_NAME                            -- 付款幣別名稱
               ,ROUND(PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT        -- 申購金額
               ,ROUND(PURCHASE.SERVICE_CHARGE,V_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE -- 申購手續費
               ,PURCHASE.AC_DATE AS AC_DATE                                      -- 淨值日
               ,NAV.NAV                                                          -- 淨值
               ,0 AS SHARES                                                      -- 申購單位數
               ,PURCHASE.AC_CODE                                                 -- 扣款帳號
               ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5            -- 扣款帳號後5碼
               ,PURCHASE.BROKER_NO                                               -- 總行
               ,PURCHASE.BRANCH_NO                                               -- 分行
               ,PURCHASE.SER_NO                                                  -- 序號
               ,PURCHASE.PAY_TYPE                                                -- 付款方式
               ,PAY_TYPE.NAME AS PAY_TYPE_NAME                                   -- 付款方式名稱
               ,PURCHASE.BANK_NO                                                 -- 扣款總行
               ,FIS_BANK.NAME AS BANK_NAME                                       -- 扣款銀行名稱
               ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL                          -- 金額小數位數
               ,FUND.SHARE_DECIMAL                                               -- 單位數小數位數
          FROM ECS.PURCHASE
          JOIN FAS.HOLDER
            ON PURCHASE.ID = HOLDER.ID
           AND HOLDER.EMAIL IS NOT NULL
          JOIN FAS.FUND
            ON FUND.FUND_NO = PURCHASE.FUND_NO
          LEFT JOIN FAS.MSG
            ON PURCHASE.RESULT_CODE = MSG.MSG_NO
          LEFT JOIN FAS.PAY_TYPE
            ON PURCHASE.PAY_TYPE = PAY_TYPE.PAY_TYPE
          LEFT JOIN NAV.NAV
            ON PURCHASE.FUND_NO = NAV.FUND_NO
           AND PURCHASE.AC_DATE = NAV.NAV_DATE
          LEFT JOIN FAS.CURRENCY
            ON CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN FAS.CURRENCY TX_CURRENCY
            ON NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) = TX_CURRENCY.CURRENCY_NO
          LEFT JOIN FAS.FIS_BANK
            ON PURCHASE.BANK_NO = FIS_BANK.BANK_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = NVL(PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO)
         WHERE PURCHASE.IS_EMAIL = 'N'
           AND PURCHASE.STATUS = 'P'
           AND PURCHASE.RESULT_CODE <> '00'
           AND FUND.AC_DATE > PURCHASE.AC_DATE
           AND PURCHASE.TX_DATE >= FUND.AC_DATE - XDAY;

    END IF; 

    -- 網路定額扣款成功與失敗通知信
    IF WQUERY_TYPE = '2' THEN

        OPEN OUT_ECSB015 FOR
        SELECT  EC_RSP_PURCHASE.ID                                                       -- 統編
               ,EC_RSP_PURCHASE.ID_SEQ                                                   -- 契約序號
               ,EC_RSP_PURCHASE.TX_DATE                                                  -- 交易日
               ,EC_RSP_PURCHASE.SER_NO                                                   -- 契約序號
               ,EC_RSP_PURCHASE.PRODUCT_TYPE                                             -- 契約類別
               ,DECODE(EC_RSP_PURCHASE.PRODUCT_TYPE,'P8','定期定額','定期不定額') AS PRODUCT_NAME    -- 契約類別名稱
               ,HOLDER.NAME                                                              -- 受益人姓名
               ,HOLDER.EMAIL                                                             -- 受益人Email
               ,MSG.MSG                                                                  -- 回覆訊息
               ,FUND.NAME AS FUND_NAME                                                   -- 基金名稱
               ,EC_RSP_PURCHASE.FUND_NO                                                  -- 基金代碼
               ,FUND.CURRENCY_NO AS FUND_CURRENCY_NO                                     -- 計價幣別
               ,CURRENCY.NAME AS FUND_CURRENCY_NAME                                      -- 計價幣別名稱
               ,NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) AS PAY_CURRENCY_NO    -- 付款幣別
               ,TX_CURRENCY.NAME AS PAY_CURRENCY_NAME                                    -- 付款幣別名稱
               ,ROUND(EC_RSP_PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT         -- 扣款金額
               ,ROUND(EC_RSP_PURCHASE.SERVICE_CHARGE,V_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE -- 扣款手續費
               ,EC_RSP_PURCHASE.AC_DATE                                                  -- 淨值日
               ,NAV.NAV                                                                  -- 淨值
               ,ROUND(NVL(PURCHASE.SHARES,0),FUND.SHARE_DECIMAL) SHARES                  -- 單位數
               ,FIS_BANK.NAME BANK_NAME                                                  -- 扣款銀行名稱
               ,EC_RSP_PURCHASE.AC_CODE                                                  -- 扣款帳號
               ,ECS.FN_STUFF_STR(EC_RSP_PURCHASE.AC_CODE,5,'*') AS AC_CODE_5             -- 扣款帳號後5碼
               ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL                                  -- 金額小數位數
               ,FUND.SHARE_DECIMAL                                                       -- 單位數小數位數
          FROM FAS.EC_RSP_PURCHASE
          JOIN FAS.PURCHASE
            ON EC_RSP_PURCHASE.ID = PURCHASE.ID
           AND EC_RSP_PURCHASE.FUND_NO = PURCHASE.FUND_NO
           AND EC_RSP_PURCHASE.TX_DATE = PURCHASE.TX_DATE
           AND PURCHASE.BROKER_NO = '999'
           AND PURCHASE.BRANCH_NO = '8200'
           AND EC_RSP_PURCHASE.SER_NO = PURCHASE.SER_NO
          JOIN FAS.HOLDER
            ON EC_RSP_PURCHASE.ID = HOLDER.ID
          JOIN FAS.FUND
            ON EC_RSP_PURCHASE.FUND_NO = FUND.FUND_NO
          LEFT JOIN FAS.MSG
            ON EC_RSP_PURCHASE.RESULT_CODE = MSG.MSG_NO
          LEFT JOIN FAS.CURRENCY
            ON FUND.CURRENCY_NO = CURRENCY.CURRENCY_NO
          LEFT JOIN NAV.NAV
            ON EC_RSP_PURCHASE.FUND_NO = NAV.FUND_NO
           AND EC_RSP_PURCHASE.AC_DATE = NAV.NAV_DATE
          LEFT JOIN FAS.FIS_BANK
            ON EC_RSP_PURCHASE.AC_BANK = FIS_BANK.BANK_NO
          LEFT JOIN FAS.CURRENCY TX_CURRENCY
            ON NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) = TX_CURRENCY.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO)
         WHERE EC_RSP_PURCHASE.IS_EMAIL = 'N'
           AND HOLDER.EMAIL IS NOT NULL
           AND EC_RSP_PURCHASE.STATUS = 'P'
           AND EC_RSP_PURCHASE.RESULT_CODE = '00'
           AND FUND.AC_DATE > EC_RSP_PURCHASE.AC_DATE
           AND EC_RSP_PURCHASE.TX_DATE >= FUND.AC_DATE - XDAY
         UNION
        SELECT  EC_RSP_PURCHASE.ID                                                       -- 統編
               ,EC_RSP_PURCHASE.ID_SEQ                                                   -- 契約序號
               ,EC_RSP_PURCHASE.TX_DATE                                                  -- 交易日
               ,EC_RSP_PURCHASE.SER_NO                                                   -- 契約序號
               ,EC_RSP_PURCHASE.PRODUCT_TYPE                                             -- 契約類別
               ,DECODE(EC_RSP_PURCHASE.PRODUCT_TYPE,'P8','定期定額','定期不定額') AS PRODUCT_NAME    -- 契約類別名稱
               ,HOLDER.NAME                                                              -- 受益人姓名
               ,HOLDER.EMAIL                                                             -- 受益人Email
               ,MSG.MSG                                                                  -- 回覆訊息
               ,FUND.NAME AS FUND_NAME                                                   -- 基金名稱
               ,EC_RSP_PURCHASE.FUND_NO                                                  -- 基金代碼
               ,FUND.CURRENCY_NO AS FUND_CURRENCY_NO                                     -- 計價幣別
               ,CURRENCY.NAME AS FUND_CURRENCY_NAME                                      -- 計價幣別名稱
               ,NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) AS PAY_CURRENCY_NO    -- 付款幣別
               ,TX_CURRENCY.NAME AS PAY_CURRENCY_NAME                                    -- 付款幣別名稱
               ,ROUND(EC_RSP_PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT         -- 扣款金額
               ,ROUND(EC_RSP_PURCHASE.SERVICE_CHARGE,V_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE    -- 扣款手續費
               ,EC_RSP_PURCHASE.AC_DATE                                                  -- 淨值日
               ,NAV.NAV                                                                  -- 淨值
               ,0 SHARES                                                                 -- 單位數
               ,FIS_BANK.NAME BANK_NAME                                                  -- 扣款銀行名稱
               ,EC_RSP_PURCHASE.AC_CODE                                                  -- 扣款帳號
               ,ECS.FN_STUFF_STR(EC_RSP_PURCHASE.AC_CODE,5,'*') AS AC_CODE_5             -- 扣款帳號後5碼
               ,V_FUND_CRNCY.AMT_DECIMAL                                                 -- 金額小數位數
               ,FUND.SHARE_DECIMAL                                                       -- 單位數小數
          FROM FAS.EC_RSP_PURCHASE        
          JOIN FAS.HOLDER
            ON EC_RSP_PURCHASE.ID = HOLDER.ID
          JOIN FAS.FUND
            ON EC_RSP_PURCHASE.FUND_NO = FUND.FUND_NO
          LEFT JOIN FAS.MSG
            ON EC_RSP_PURCHASE.RESULT_CODE = MSG.MSG_NO
          LEFT JOIN FAS.CURRENCY
            ON FUND.CURRENCY_NO = CURRENCY.CURRENCY_NO
          LEFT JOIN NAV.NAV
            ON EC_RSP_PURCHASE.FUND_NO = NAV.FUND_NO
           AND EC_RSP_PURCHASE.AC_DATE = NAV.NAV_DATE
          LEFT JOIN FAS.FIS_BANK
            ON EC_RSP_PURCHASE.AC_BANK = FIS_BANK.BANK_NO
          LEFT JOIN FAS.CURRENCY TX_CURRENCY
            ON NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO) = TX_CURRENCY.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = NVL(EC_RSP_PURCHASE.CURRENCY_NO, FUND.CURRENCY_NO)
         WHERE EC_RSP_PURCHASE.IS_EMAIL = 'N'
           AND HOLDER.EMAIL IS NOT NULL
           AND EC_RSP_PURCHASE.STATUS = 'P'
           -- 2018.11.27 ChengYu 修正定期(不)定額 交易失敗判斷、扣款失敗三次金額、日期
           AND EC_RSP_PURCHASE.RESULT_CODE <> '00'
           AND FUND.AC_DATE > EC_RSP_PURCHASE.AC_DATE
           AND EC_RSP_PURCHASE.TX_DATE >= FUND.AC_DATE - XDAY;

    END IF ;

    -- 買回交易結果通知信
    IF WQUERY_TYPE = '3' THEN

        OPEN OUT_ECSB015 FOR
        SELECT  ECS_REDEMPTION.ID
               ,ECS_REDEMPTION.FUND_NO
               ,TO_CHAR(ECS_REDEMPTION.TX_DATE,'YYYY/MM/DD') AS TX_DATE
               ,ECS_REDEMPTION.BROKER_NO
               ,ECS_REDEMPTION.BRANCH_NO
               ,ECS_REDEMPTION.SER_NO
               ,HOLDER.NAME
               ,HOLDER.EMAIL
               ,DECODE(SUBSTR(FUND.SNAME,2,1),'&',REPLACE(FUND.SNAME,SUBSTR(FUND.SNAME,2,1),'＆'),FUND.SNAME) AS FUND_NAME -- 原使用FAS.F_REPLACE_FUNDSNAME(F.FUND_NO) AS FUND_NAME
               ,FUND.CURRENCY_NO AS FUND_CURRENCY_NO
               ,FUND_CURRENCY.NAME AS FUND_CURRENCY_NAME
               -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼。
               -- 2018.12.19 ChengYu 調整買回幣別欄位
               ,FAS_REDEMPTION.CURRENCY_NO AS PAY_CURRENCY_NO
               ,V_TRADE_CRNCY.NAME AS PAY_CURRENCY_NAME
               ,RED_BANK.CURRENCY_NO AS BANK_CURRENCY_NO
               ,V_BANK_CRNCY.NAME AS BANK_CURRENCY_NAME
               -- 2018.04.22 JIANXIN 調整贖回單位數由 EC 而來
               ,ROUND(ECS_REDEMPTION.APPLICATION_SHARE,FUND.SHARE_DECIMAL) AS APPLICATION_SHARE
               -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
               -- 2018.12.19 ChengYu 調整買回幣別欄位
               ,ROUND(RED_BANK.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT
               ,FAS_REDEMPTION.CURRENCY_NO AS ORG_PAY_CURRENCY_NO
               ,FAS_REDEMPTION.AC_DATE
               ,NAV.NAV
               ,RED_BANK.AC_FIS_SNAME AS BANK_NAME
               ,RED_BANK.AC_CODE
               ,ECS.FN_STUFF_STR(RED_BANK.AC_CODE,5,'*') AS AC_CODE_5           -- 扣款帳號後5碼
               -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
               -- 2018.12.19 ChengYu 調整買回幣別欄位
               ,ROUND(RED_BANK.WIRE_FEE,V_FUND_CRNCY.AMT_DECIMAL) AS WIRE_FEE
               ,DECODE(COUNT(RED_BANK.SER_NO),1,FAS_REDEMPTION.EARLY_REDEMPTION_FEE+FAS_REDEMPTION.REDEMPTION_FEE,NULL) AS REDEMPTION_FEE
               -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
               -- 2018.12.19 ChengYu 調整買回幣別欄位
               ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL                         -- 金額小數位數
               ,FUND.SHARE_DECIMAL                                              -- 單位數小數位數
               -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
               ,FUND.AMC_NO AS AMC_NO                                           -- 基金公司代碼
          FROM FAS.REDEMPTION FAS_REDEMPTION
          JOIN ECS.REDEMPTION ECS_REDEMPTION
            ON FAS_REDEMPTION.FUND_NO = ECS_REDEMPTION.FUND_NO
           AND FAS_REDEMPTION.TX_DATE = ECS_REDEMPTION.TX_DATE
           AND FAS_REDEMPTION.BROKER_NO = ECS_REDEMPTION.BROKER_NO
           AND FAS_REDEMPTION.BRANCH_NO = ECS_REDEMPTION.BRANCH_NO
           -- 2019.04.23 JIANXIN 調整串接Key 應為ID，不可為SER_NO，因為會有多筆明細的狀況
           AND FAS_REDEMPTION.ID = ECS_REDEMPTION.ID
           AND ECS_REDEMPTION.BROKER_NO = '999' 
           AND ECS_REDEMPTION.BRANCH_NO = '8000' 
           AND ECS_REDEMPTION.IS_EMAIL = 'N' 
           AND ECS_REDEMPTION.STATUS = 'P' 
           AND ECS_REDEMPTION.FUND_NO_IN IS NULL
          JOIN FAS.HOLDER HOLDER
            ON ECS_REDEMPTION.ID = HOLDER.ID
           AND HOLDER.EMAIL IS NOT NULL
          JOIN FAS.FUND FUND
            ON ECS_REDEMPTION.FUND_NO = FUND.FUND_NO
          JOIN FAS.CURRENCY FUND_CURRENCY
            ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
          JOIN NAV.NAV NAV
            ON ECS_REDEMPTION.FUND_NO = NAV.FUND_NO 
           AND ECS_REDEMPTION.AC_DATE = NAV.NAV_DATE
          JOIN FAS.RED_BANK RED_BANK
            ON ECS_REDEMPTION.FUND_NO = RED_BANK.FUND_NO 
           AND ECS_REDEMPTION.TX_DATE = RED_BANK.TX_DATE 
           -- 2019.04.23 JIANXIN 調整串接Key 應為FE系列，不可用原生資料串接
           AND ECS_REDEMPTION.BROKER_NO = RED_BANK.FE_BROKER_NO 
           AND ECS_REDEMPTION.BRANCH_NO = RED_BANK.FE_BRANCH_NO 
           AND ECS_REDEMPTION.SER_NO = RED_BANK.FE_SER_NO
           AND RED_BANK.FUND_NO_IN IS NULL
          JOIN FAS.CURRENCY REDEMPTION_CURRENCY
            -- 2018.12.19 ChengYu 修正買回效能
            ON NVL(ECS_REDEMPTION.CURRENCY_NO,FUND.CURRENCY_NO) = REDEMPTION_CURRENCY.CURRENCY_NO
          -- 2018.12.19 ChengYu 因通知信付款幣別使用銀行幣別，所以調整付款幣別、金額小數、買回新增傳出參數基金公司代碼
          -- 2018.12.19 ChengYu 調整買回幣別欄位
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY V_BANK_CRNCY
            ON V_BANK_CRNCY.CURRENCY_NO = RED_BANK.CURRENCY_NO
          -- 2018.12.19 ChengYu 調整買回幣別欄位
          JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
            ON V_TRADE_CRNCY.CURRENCY_NO = ECS_REDEMPTION.CURRENCY_NO 
         WHERE FUND.AC_DATE > FAS_REDEMPTION.AC_DATE
           -- 2018.12.19 ChengYu 修正買回效能
           AND ECS_REDEMPTION.TX_DATE >= FUND.AC_DATE - XDAY
           AND ECS_REDEMPTION.IS_EMAIL = 'N' 
         GROUP BY ECS_REDEMPTION.ID, ECS_REDEMPTION.FUND_NO, ECS_REDEMPTION.TX_DATE, ECS_REDEMPTION.BROKER_NO, ECS_REDEMPTION.BRANCH_NO, 
                  ECS_REDEMPTION.SER_NO, HOLDER.NAME, HOLDER.EMAIL,FUND.FUND_NO,FUND.CURRENCY_NO, FUND_CURRENCY.NAME,FAS_REDEMPTION.CURRENCY_NO,FUND.CURRENCY_NO, REDEMPTION_CURRENCY.NAME, 
                  RED_BANK.CURRENCY_NO, V_BANK_CRNCY.NAME,ECS_REDEMPTION.APPLICATION_SHARE, RED_BANK.AMOUNT, FAS_REDEMPTION.CURRENCY_NO ,
                  FAS_REDEMPTION.AC_DATE, NAV.NAV, RED_BANK.AC_FIS_SNAME, RED_BANK.AC_CODE,RED_BANK.WIRE_FEE,RED_BANK.SER_NO, FAS_REDEMPTION.EARLY_REDEMPTION_FEE,
                  FAS_REDEMPTION.REDEMPTION_FEE,FUND.SHARE_DECIMAL,V_BANK_CRNCY.AMT_DECIMAL,FUND.SNAME,FUND.AMC_NO,V_TRADE_CRNCY.NAME,V_FUND_CRNCY.AMT_DECIMAL;

    END IF ;

    -- 轉申購交易結果通知信
    IF WQUERY_TYPE = '4' THEN

        OPEN OUT_ECSB015 FOR
        SELECT  ECS_REDEMPTION.ID
               ,ECS_REDEMPTION.FUND_NO
               ,TO_CHAR(ECS_REDEMPTION.TX_DATE,'YYYY/MM/DD') AS TX_DATE
               ,ECS_REDEMPTION.BROKER_NO
               ,ECS_REDEMPTION.BRANCH_NO
               ,ECS_REDEMPTION.SER_NO
               ,HOLDER.NAME
               ,HOLDER.EMAIL
               ,DECODE(SUBSTR(FUND_OUT.SNAME,2,1),'&',REPLACE(FUND_OUT.SNAME,SUBSTR(FUND_OUT.SNAME,2,1),'＆'),FUND_OUT.SNAME) AS RFUND_NAME -- 原使用FAS.F_REPLACE_FUNDSNAME(FR.FUND_NO) AS FUND_NAME
               ,NAV_OUT.NAV_DATE AS RNAV_DATE
               ,NAV_OUT.NAV AS RNAV
               ,ROUND(RED_BANK.SHARES,FUND_OUT.SHARE_DECIMAL) AS RSHARES
               ,ROUND(RED_BANK.AMOUNT,R_FUND_CRNCY.AMT_DECIMAL) AS RAMOUNT
               ,PURCHASE.TX_DATE AS PTX_DATE
               ,NAV_IN.NAV AS PNAV
               ,DECODE(SUBSTR(FUND_IN.SNAME,2,1),'&',REPLACE(FUND_IN.SNAME,SUBSTR(FUND_IN.SNAME,2,1),'＆'),FUND_IN.SNAME) AS PFUND_NAME -- 原使用FAS.F_REPLACE_FUNDSNAME(FP.FUND_NO) AS PSNAME
               ,ROUND(PURCHASE.SERVICE_CHARGE,P_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE
               ,ROUND(PURCHASE.AMOUNT,P_FUND_CRNCY.AMT_DECIMAL) AS PAMOUNT
               ,ROUND(PURCHASE.SHARES,FUND_IN.SHARE_DECIMAL) AS PSHARES
               ,FAS_REDEMPTION.CURRENCY_NO AS ORG_RED_CURRENCY_NO
               ,REDEMPTION_CURRENCY.NAME AS ORG_RED_CURRENCY_NAME
               -- 2018.12.06 JIANXIN 依據William 確認 現行EC 是沒有境外基金轉申購，故而改為計價幣別
               ,FUND_OUT_CURRENCY.CURRENCY_NO AS ORG_PAY_CURRENCY_NO
               ,FUND_OUT_CURRENCY.NAME AS ORG_PAY_CURRENCY_NAME
               ,FUND_OUT_CURRENCY.CURRENCY_NO AS R_CURRENCY_NO
               ,FUND_OUT_CURRENCY.NAME AS ER_CURRENCY_NAME
               ,FUND_IN_CURRENCY.CURRENCY_NO AS P_CURRENCY_NO
               ,FUND_IN_CURRENCY.NAME AS P_CURRENCY_NAME
               ,ROUND(RED_BANK.WIRE_FEE,R_FUND_CRNCY.AMT_DECIMAL) AS WIRE_FEE
               ,NAV_IN.NAV_DATE AS PNAV_DATE
               ,DECODE(COUNT(RED_BANK.SER_NO), 1, FAS_REDEMPTION.EARLY_REDEMPTION_FEE + FAS_REDEMPTION.REDEMPTION_FEE, NULL) AS REDEMPTION_FEE
               ,R_FUND_CRNCY.AMT_DECIMAL AS RAMT_DECIMAL
               ,FUND_OUT.SHARE_DECIMAL AS RSHARE_DECIMAL
               ,P_FUND_CRNCY.AMT_DECIMAL AS PAMT_DECIMAL
               ,FUND_IN.SHARE_DECIMAL AS PSHARE_DECIMAL
          FROM FAS.REDEMPTION FAS_REDEMPTION
          JOIN ECS.REDEMPTION ECS_REDEMPTION
            ON ECS_REDEMPTION.ID = FAS_REDEMPTION.ID 
           AND FAS_REDEMPTION.FUND_NO = ECS_REDEMPTION.FUND_NO
           AND FAS_REDEMPTION.TX_DATE = ECS_REDEMPTION.TX_DATE
           AND FAS_REDEMPTION.BROKER_NO = ECS_REDEMPTION.BROKER_NO
           AND FAS_REDEMPTION.BRANCH_NO = ECS_REDEMPTION.BRANCH_NO
           -- 2019.04.23 JIANXIN 調整串接Key 應為ID，不可為SER_NO，因為會有多筆明細的狀況
           AND FAS_REDEMPTION.ID = ECS_REDEMPTION.ID
          JOIN FAS.HOLDER HOLDER
            ON HOLDER.ID = FAS_REDEMPTION.ID
          JOIN FAS.FUND FUND_OUT
            ON ECS_REDEMPTION.FUND_NO = FUND_OUT.FUND_NO
          JOIN NAV.NAV NAV_OUT
            ON ECS_REDEMPTION.FUND_NO = NAV_OUT.FUND_NO 
           AND ECS_REDEMPTION.AC_DATE = NAV_OUT.NAV_DATE 
          JOIN FAS.RED_BANK RED_BANK
            ON ECS_REDEMPTION.FUND_NO = RED_BANK.FUND_NO 
           AND ECS_REDEMPTION.TX_DATE = RED_BANK.TX_DATE 
           AND ECS_REDEMPTION.SER_NO = RED_BANK.FE_SER_NO 
           AND ECS_REDEMPTION.BROKER_NO = RED_BANK.FE_BROKER_NO
           AND ECS_REDEMPTION.BRANCH_NO = RED_BANK.FE_BRANCH_NO 
          JOIN FAS.PURCHASE PURCHASE
            ON RED_BANK.FUND_NO_IN = PURCHASE.FUND_NO 
           AND RED_BANK.FUND_NO = PURCHASE.FUND_NO_OUT 
           AND RED_BANK.TX_DATE = PURCHASE.TX_DATE_OUT 
           AND PURCHASE.BROKER_NO = '999' 
           AND PURCHASE.BRANCH_NO = '8300' 
           AND RED_BANK.FE_SER_NO = PURCHASE.SER_NO_OUT
          JOIN FAS.FUND FUND_IN
            ON PURCHASE.FUND_NO = FUND_IN.FUND_NO 
          JOIN NAV.NAV NAV_IN
            ON PURCHASE.FUND_NO = NAV_IN.FUND_NO 
           AND PURCHASE.AC_DATE = NAV_IN.NAV_DATE
          JOIN FAS.CURRENCY FUND_OUT_CURRENCY
            ON FUND_OUT.CURRENCY_NO = FUND_OUT_CURRENCY.CURRENCY_NO 
          JOIN FAS.CURRENCY FUND_IN_CURRENCY
            ON FUND_IN.CURRENCY_NO = FUND_IN_CURRENCY.CURRENCY_NO
          -- 2018.12.10 ChengYu 小數位數取原幣小數位數
          JOIN ECS.V_FUND_CRNCY R_FUND_CRNCY
            ON R_FUND_CRNCY.CURRENCY_NO = FUND_OUT.CURRENCY_NO
          -- 2018.12.10 ChengYu 小數位數取原幣小數位數
          JOIN ECS.V_FUND_CRNCY P_FUND_CRNCY
            ON P_FUND_CRNCY.CURRENCY_NO = FUND_IN.CURRENCY_NO
          JOIN FAS.CURRENCY REDEMPTION_CURRENCY
            ON REDEMPTION_CURRENCY.CURRENCY_NO = FAS_REDEMPTION.CURRENCY_NO
          JOIN FAS.CURRENCY PURCHASE_CURRENCY
            ON PURCHASE_CURRENCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
         WHERE ECS_REDEMPTION.IS_EMAIL = 'N' 
           AND HOLDER.EMAIL IS NOT NULL
           AND ECS_REDEMPTION.STATUS = 'P' 
           AND ECS_REDEMPTION.FUND_NO_IN IS NOT NULL
           AND ECS_REDEMPTION.BROKER_NO = '999' 
           AND ECS_REDEMPTION.BRANCH_NO = '8300'
           AND FUND_IN.AC_DATE > PURCHASE.AC_DATE
           AND ECS_REDEMPTION.TX_DATE >= FUND_IN.AC_DATE - XDAY
     GROUP BY ECS_REDEMPTION.ID, ECS_REDEMPTION.FUND_NO, ECS_REDEMPTION.TX_DATE, ECS_REDEMPTION.BROKER_NO, ECS_REDEMPTION.BRANCH_NO, 
              ECS_REDEMPTION.SER_NO, HOLDER.NAME, HOLDER.EMAIL, FUND_OUT.FUND_NO,
              NAV_OUT.NAV_DATE , NAV_OUT.NAV , RED_BANK.SHARES , RED_BANK.AMOUNT , 
              PURCHASE.TX_DATE, NAV_IN.NAV ,FUND_IN.FUND_NO, 
              PURCHASE.SERVICE_CHARGE, PURCHASE.AMOUNT, PURCHASE.SHARES, FAS_REDEMPTION.CURRENCY_NO, 
              FUND_OUT_CURRENCY.CURRENCY_NO , FUND_OUT_CURRENCY.NAME , FUND_IN_CURRENCY.CURRENCY_NO,
              FUND_IN_CURRENCY.NAME , RED_BANK.WIRE_FEE, NAV_IN.NAV_DATE,FAS_REDEMPTION.EARLY_REDEMPTION_FEE, FAS_REDEMPTION.REDEMPTION_FEE,R_FUND_CRNCY.AMT_DECIMAL ,
              FUND_OUT.SHARE_DECIMAL,P_FUND_CRNCY.AMT_DECIMAL ,FUND_IN.SHARE_DECIMAL,FUND_OUT.SNAME,FUND_IN.SNAME,
              REDEMPTION_CURRENCY.NAME,PURCHASE.CURRENCY_NO ,PURCHASE_CURRENCY.NAME ,FUND_OUT_CURRENCY.CURRENCY_NO;

    END IF ;

    -- 定額三次扣款失敗通知信
    IF WQUERY_TYPE = '5' THEN

        OPEN OUT_ECSB015 FOR
        SELECT EC_RSP.ID
              ,HOLDER.NAME
              ,HOLDER.EMAIL
              ,RSP_STATUS.NAME STATUS_NAME
              ,EC_RSP.ID_SEQ
              ,DECODE(SUBSTR(FUND.SNAME,2,1),'&',REPLACE(FUND.SNAME,SUBSTR(FUND.SNAME,2,1),'＆'),FUND.SNAME) AS FUND_NAME -- 原使用FAS.F_REPLACE_FUNDSNAME(FUND_NO)
              ,ROUND(EC_RSP.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT
              ,EC_RSP.AC_DAY
              ,FIS_BRANCH.NAME AS BRANCH_NAME
              ,EC_RSP.PRODUCT_TYPE
              ,DECODE(EC_RSP.PRODUCT_TYPE,'P8','定期定額','定期不定額') AS PRODUCT_NAME
              ,ROUND(EC_RSP.RAISE_ROI * 100,2) AS RAISE_ROI
              ,ROUND(EC_RSP.RAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS RAISE_AMOUNT
              ,ROUND(EC_RSP.REDUCE_ROI * 100,2) AS REDUCE_ROI
              ,ROUND(EC_RSP.REDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) AS REDUCE_AMOUNT
              ,EC_RSP.AC_CODE
              ,ECS.FN_STUFF_STR(EC_RSP.AC_CODE,5,'*') AS AC_CODE_5             -- 扣款帳號後5碼
              ,EC_RSP.AC_NAME
              ,EC_RSP.CURRENCY_NO AS BANK_CURRENCY_NO
              ,CURRENCY.NAME AS BANK_CURRENCY_NAME
              -- 2018.11.27 ChengYu 修正定期(不)定額 交易失敗判斷、扣款失敗三次金額、日期
              ,ROUND(TO_NUMBER(EC_RSP_DATE.AMOUNT1),V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT1
              ,ROUND(TO_NUMBER(EC_RSP_DATE.AMOUNT2),V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT2
              ,ROUND(TO_NUMBER(EC_RSP_DATE.AMOUNT3),V_FUND_CRNCY.AMT_DECIMAL) AS AMOUNT3
              ,TO_DATE(EC_RSP_DATE.TX_DATE1,'YYYY/MM/DD') AS TX_DATE1
              ,TO_DATE(EC_RSP_DATE.TX_DATE2,'YYYY/MM/DD') AS TX_DATE2
              ,TO_DATE(EC_RSP_DATE.TX_DATE3,'YYYY/MM/DD') AS TX_DATE3
              ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL
              ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL
          FROM FAS.EC_RSP EC_RSP
          JOIN FAS.HOLDER HOLDER
            ON EC_RSP.ID = HOLDER.ID
          JOIN FAS.RSP_STATUS RSP_STATUS
            ON EC_RSP.STATUS = RSP_STATUS.STATUS
          JOIN FAS.FUND FUND
            ON EC_RSP.FUND_NO = FUND.FUND_NO
          JOIN FAS.FIS_BRANCH FIS_BRANCH
            ON EC_RSP.BANK_NO = FIS_BRANCH.BANK_NO
           AND EC_RSP.BRANCH_NO = FIS_BRANCH.BRANCH_NO
          JOIN FAS.CURRENCY CURRENCY
            ON EC_RSP.CURRENCY_NO = CURRENCY.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = EC_RSP.CURRENCY_NO
          -- 2018.11.27 ChengYu 修正定期(不)定額 交易失敗判斷、扣款失敗三次金額、日期
          -- 2018.12.04 tingting 調整扣款失敗三次取日期、金額的取法
          JOIN (SELECT  ID
                       ,ID_SEQ
                       ,SUBSTR(TX_DATE,0,INSTR(TX_DATE,';',1,1)-1) AS TX_DATE1
                       ,SUBSTR(TX_DATE,INSTR(TX_DATE,';',1,1)+1,INSTR(TX_DATE,';',1,2)-1 - INSTR(TX_DATE,';',1,1)) AS TX_DATE2
                       ,SUBSTR(TX_DATE,INSTR(TX_DATE,';',1,2)+1,INSTR(TX_DATE,';',1,3)-1 - INSTR(TX_DATE,';',1,2)) AS TX_DATE3
                       ,SUBSTR(AMOUNT,0,INSTR(AMOUNT,';',1,1)-1) AS AMOUNT1
                       ,SUBSTR(AMOUNT,INSTR(AMOUNT,';',1,1)+1,INSTR(AMOUNT,';',1,2)-1 - INSTR(AMOUNT,';',1,1)) AS AMOUNT2
                       ,SUBSTR(AMOUNT,INSTR(AMOUNT,';',1,2)+1,INSTR(AMOUNT,';',1,3)-1 - INSTR(AMOUNT,';',1,2)) AS AMOUNT3
                  FROM (
                        SELECT  ID
                               ,ID_SEQ
                               ,LISTAGG(TX_DATE,';') WITHIN GROUP (ORDER BY TX_DATE DESC) || ';' AS TX_DATE
                               ,LISTAGG(AMOUNT,';') WITHIN GROUP (ORDER BY TX_DATE DESC) || ';' AS AMOUNT
                          FROM (
                                SELECT   EC_RSP.ID
                                        ,EC_RSP.ID_SEQ
                                        ,TO_CHAR(EC_RSP_PURCHASE.TX_DATE,'YYYY/MM/DD') AS TX_DATE
                                        ,EC_RSP_PURCHASE.AMOUNT
                                        ,ROW_NUMBER() OVER(PARTITION BY EC_RSP_PURCHASE.ID, EC_RSP.ID_SEQ ORDER BY EC_RSP_PURCHASE.TX_DATE DESC) AS ROW_NUM
                                   FROM FAS.EC_RSP EC_RSP
                                   JOIN FAS.EC_RSP_PURCHASE EC_RSP_PURCHASE
                                     ON EC_RSP_PURCHASE.ID = EC_RSP.ID 
                                    AND EC_RSP_PURCHASE.ID_SEQ = EC_RSP.ID_SEQ 
                                    AND EC_RSP_PURCHASE.RESULT_CODE != '00'     --扣款結果 00:成功/非01:失敗
                                  WHERE EC_RSP.STATUS = '7'         --7:暫停扣款
                                    AND EC_RSP.CONT_DISHONOR >= 3
                                 ORDER BY EC_RSP.ID, EC_RSP.ID_SEQ, ROW_NUM
                               ) EC_RSP
                         WHERE EC_RSP.ROW_NUM <= 3
                         GROUP BY ID, ID_SEQ 
                       )
               ) EC_RSP_DATE
            ON EC_RSP_DATE.ID = EC_RSP.ID
           AND EC_RSP_DATE.ID_SEQ = EC_RSP.ID_SEQ
         WHERE EC_RSP.STATUS = '7' 
           AND HOLDER.EMAIL IS NOT NULL
           AND EC_RSP.CONT_DISHONOR >= 3 
           -- 2018.12.11 tingting 調整定額三次扣款失敗通知信判斷條件
           AND TO_CHAR(EC_RSP.PAUSED,'YYYYMMDD') = TO_CHAR(TRUNC(SYSDATE)-1,'YYYYMMDD')
           AND EC_RSP.PAUSED >= FUND.AC_DATE - XDAY;

    END IF ;

    -- 生日賀卡通知信
    -- 2018.12.07 tingting 增加生日賀卡通知信
    IF WQUERY_TYPE = '6' THEN

        OPEN OUT_ECSB015 FOR
        SELECT  NAME
               ,EMAIL
          FROM FAS.HOLDER
         WHERE TO_CHAR(BIRTH_DATE,'MM') = TO_CHAR(SYSDATE,'MM')
           -- 2018.12.10 ChengYu 寄發生日賀卡排除沒有Email狀況
           AND HOLDER.EMAIL IS NOT NULL
           -- 2022.01.03 Chengyu 若客戶已銷戶則不再寄信 
           AND HOLDER.CLOSE_DATE IS NULL;

    END IF ;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSB015_EXECUTE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSB015_UPDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSB015_UPDATE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/11/22
-- Description: 網路後續通知信寄發後更新IS_EMAIL欄位
-- =============================================
(
       WQUERY_TYPE    IN VARCHAR2                -- 交易類別(1:PURCHASE;2:RSP;3:REDEMTION;4:SWITCH)
      ,WID            IN VARCHAR2                -- 受益人ID
      ,WID_SEQ        IN INT                     -- 契約書號
      ,WFUND_NO       IN VARCHAR2                -- 基金代碼    
      ,WTX_DATE       IN DATE                    -- 交易日期
      ,WBROKER_NO     IN VARCHAR2                -- 代銷單位
      ,WBRANCH_NO     IN VARCHAR2                -- 代銷分公司碼
      ,WSER_NO        IN VARCHAR2                -- 交易序號

) IS

BEGIN

   IF WQUERY_TYPE = '1' THEN

      UPDATE ECS.PURCHASE
         SET PURCHASE.IS_EMAIL = 'Y'
       WHERE PURCHASE.FUND_NO = WFUND_NO
         AND PURCHASE.TX_DATE = WTX_DATE
         AND PURCHASE.BROKER_NO = WBROKER_NO
         AND PURCHASE.BRANCH_NO = WBRANCH_NO
         AND PURCHASE.SER_NO = WSER_NO;

   ELSIF WQUERY_TYPE = '2' THEN

      UPDATE FAS.EC_RSP_PURCHASE
         SET EC_RSP_PURCHASE.IS_EMAIL = 'Y'
       WHERE EC_RSP_PURCHASE.ID = WID
         AND EC_RSP_PURCHASE.ID_SEQ = WID_SEQ
         AND EC_RSP_PURCHASE.TX_DATE = TX_DATE
         AND EC_RSP_PURCHASE.SER_NO = SER_NO;

   ELSIF WQUERY_TYPE = '3' OR WQUERY_TYPE = '4'  THEN

      UPDATE ECS.REDEMPTION
         SET REDEMPTION.IS_EMAIL = 'Y'
       WHERE REDEMPTION.FUND_NO = WFUND_NO
         AND REDEMPTION.TX_DATE = WTX_DATE
         AND REDEMPTION.BROKER_NO = WBROKER_NO
         AND REDEMPTION.BRANCH_NO = WBRANCH_NO
         AND REDEMPTION.SER_NO = WSER_NO;

   END IF;


END S_ECSB015_Update;

/

  GRANT EXECUTE ON "ECS"."S_ECSB015_UPDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR001_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR001_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/28
-- Description: 紅利積點入帳報表
-- 2018.06.28 ChengYu 表中無值直接給NULL
-- 2018.07.20 ChengYu 新增欄位EMAIL
-- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
-- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
-- 2019.03.11 YungLong 增加傳入欄位有效日期(起)、 有效日期(迄)、ID、戶號
--                     增加傳出欄位姓名(活動)、行動電話(活動)、行動電話(受益人)、Email(活動)、紅利有效日期
--                     調整業務員、EC業務員名稱邏輯
--                     合併排序寫法
-- =============================================
(
    WISSUE_DATE_ST    DATE,                      -- 配發日期(起)
    WISSUE_DATE_ED    DATE,                      -- 配發日期(迄)
    -- 2019.03.11 YungLong 增加傳入欄位有效日期(起)、 有效日期(迄)、ID、戶號
    WVALID_DATE_ST    DATE,                      -- 有效日期(起)
    WVALID_DATE_ED    DATE,                      -- 有效日期(迄)
    WID               VARCHAR2,                  -- ID
    WACCOUNT_NO       VARCHAR2,                  -- 戶號
    WPROGRAM_NO       VARCHAR2,                  -- 活動編號
    WORDER_TYPE       VARCHAR2,                  -- 報表排序方式
    OUT_ECSR001       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS
BEGIN
    -- 2018.06.28 ChengYu 表中無值直接給NULL BEGIN
    -- 2019.03.11 YungLong 增加傳入欄位有效日期(起)、 有效日期(迄)、ID、戶號
    --                     增加傳出欄位姓名(活動)、行動電話(活動)、行動電話(受益人)、Email(活動)、紅利有效日期
    --                     調整業務員、EC業務員名稱邏輯
    --                     合併排序寫法
    OPEN OUT_ECSR001 FOR
    SELECT  CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(TEAM.PROFIT_CENTER,'EC')
                 END AS PROFIT_CENTER               --業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(SALES.NAME,'')
                 END AS SALES_NAME                  --業務人員
           ,CASE WHEN HOLDER.ID IS NULL THEN 0
                 ELSE HOLDER.ACCOUNT_NO
                 END AS ACCOUNT_NO                  --戶號
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE ECS_OPTION.DISPLAY_NAME
                 END AS ECS_STATUS                  --EC狀態
           ,REWARD_POINT.ID AS ID                   --ID
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE HOLDER.NAME
                 END AS NAME                        --姓名(受益人)
           --,REWARD_POINT.NAME AS REWARD_NAME        -- 姓名(活動)
           ,'' AS REWARD_NAME                       -- 姓名(活動)因客戶端Table無欄位先給空白
           ,FAS.HOLDER.MOBILE                       -- 行動電話(受益人)
           --,REWARD_POINT.MOBILE AS REWARD_MOBILE    -- 行動電話(活動)
           ,'' AS REWARD_MOBILE                     -- 行動電話(活動)因客戶端Table無欄位先給空白
            -- 2018.07.20 ChengYu 新增欄位EMAIL
           ,HOLDER.EMAIL                            -- Email(受益人)
           ,REWARD_POINT.EMAIL AS REWARD_EMAIL      -- Email(活動)
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_TEAM.PROFIT_CENTER,'EC')
                 END AS EC_PROFIT_CENTER            --EC業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_SALES.NAME,'')
                 END AS EC_SALES_NAME               --EC業務人員
           ,REWARD_POINT.ISSUE_DATE AS ISSUE_DATE   -- 發放日期
           ,REWARD_POINT.PROGRAM_NO AS PROGRAM_NO   -- 活動代碼
           ,REWARD_PROGRAM.NAME AS PROGRAM_NAME     -- 活動名稱
           ,REWARD_POINT.REWARD_POINT AS REWARD_POINT   -- 紅利點數
           ,REWARD_POINT.VALID_THRU AS VALID_THRU   -- 紅利有效日期
      FROM FAS.REWARD_POINT                     --紅利配發資料
      LEFT JOIN FAS.HOLDER                      --受益人基本資料
        ON HOLDER.ID = REWARD_POINT.ID
      LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER     --業務員組別資料
        ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM TEAM                   --業務組別資料
        ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES SALES                 --業務員資料
        ON SALES.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER  --業務員組別資料(For EC)
        ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM EC_TEAM                --業務組別資料(For EC)
        ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES EC_SALES              --業務員資料(For EC)
        ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN FAS.REWARD_PROGRAM              --紅利活動資料
        ON REWARD_PROGRAM.PROGRAM_NO = REWARD_POINT.PROGRAM_NO
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION       --欄位選單資料(ECS_STATUS)
        ON ECS_OPTION.SOURCE_TYPE = '014'
       AND ECS_OPTION.TEXT_VALUE = HOLDER.ECS_STATUS
     -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
     WHERE ((TRUNC(REWARD_POINT.ISSUE_DATE) BETWEEN WISSUE_DATE_ST AND WISSUE_DATE_ED) OR WISSUE_DATE_ST IS NULL OR WISSUE_DATE_ED IS NULL)
       AND (REWARD_POINT.PROGRAM_NO = WPROGRAM_NO OR WPROGRAM_NO IS NULL)
       AND ((TRUNC(REWARD_POINT.VALID_THRU) BETWEEN WVALID_DATE_ST AND WVALID_DATE_ED) OR WVALID_DATE_ST IS NULL OR WVALID_DATE_ED IS NULL)
       AND (REWARD_POINT.ID = WID OR WID IS NULL)
       AND (FAS.HOLDER.ACCOUNT_NO = WACCOUNT_NO OR WACCOUNT_NO IS NULL)
     ORDER BY DECODE(WORDER_TYPE,'1',TEAM.PROFIT_CENTER,EC_TEAM.PROFIT_CENTER)
             ,DECODE(WORDER_TYPE,'1',HOLDER.SALES_NO,HOLDER.EC_SALES_NO)
             ,HOLDER.ECS_STATUS
             ,REWARD_POINT.ISSUE_DATE
             ,HOLDER.ID;
END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR001_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR002_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR002_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/29
-- Description: 紅利積點折抵報表
-- 2018.07.25 ChengYu 新增EMAIL 欄位
-- 2018.08.20 ChemgYu 以業務員代碼、EC業務員代碼代替名稱修正排序 
-- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
-- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
-- 2020.01.31 ChengYu 新增行動電話欄位
-- =============================================
(
    WTX_DATE_ST       DATE,                      -- 交易日期(起)
    WTX_DATE_ED       DATE,                      -- 交易日期(迄)
    WFUND_NO          VARCHAR2,                  -- 基金代碼
    WORDER_TYPE       VARCHAR2,                  -- 報表排序方式
    OUT_ECSR002       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

IF WORDER_TYPE = '1' THEN
BEGIN
    OPEN OUT_ECSR002 FOR
    SELECT  CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_TEAM.PROFIT_CENTER,'EC')
            END AS EC_PROFIT_CENTER -- EC業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_SALES.NAME,'EC')
            END AS EC_SALES_NAME    -- EC業務人員
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' AND PURCHASE.FUND_NO IS NOT NULL THEN '(' || PURCHASE.FUND_NO || ')' || PURCHASE_FUND.SNAME
                 WHEN REWARD_HISTORY.USE_TYPE = '2' AND REDEMPTION.FUND_NO IS NOT NULL THEN '(' || REDEMPTION.FUND_NO || ')'||REDEMPTION_FUND.SNAME
                 ELSE ''
            END AS FUND_NAME        -- 基金名稱
           ,HOLDER.ACCOUNT_NO       -- 戶號
           ,OPTION_ECS_STATUS.DISPLAY_NAME AS ECS_STATUS  -- EC狀態
           ,REWARD_HISTORY.ID AS ID -- 受益人ID
           ,HOLDER.NAME             -- 受益人姓名
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(TEAM.PROFIT_CENTER,'EC')
            END AS PROFIT_CENTER    -- 業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(SALES.NAME,'EC')
            END AS SALES_NAME       -- 業務人員
           ,REWARD_HISTORY.USE_TYPE -- 使用類別
           ,OPTION_USE_TYPE.DISPLAY_NAME AS USE_TYPE_NAME   -- 使用類別名稱
           ,REWARD_HISTORY.TX_DATE  -- 交易日期
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.AMOUNT,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE 0
            END AS AMOUNT           -- 申購幣別
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.ORG_SERVICE_CHARGE,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE 0
            END AS ORG_SERVICE_CHARGE  -- 原手續費
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.SERVICE_CHARGE,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE ROUND(NVL(REDEMPTION.SERVICE_CHARGE,0),NVL(REDEMPTION_CRNCY.AMT_DECIMAL,0))
            END AS SERVICE_CHARGE      -- 折抵後手續費
           ,REWARD_HISTORY.USED_POINT  -- 使用紅利點數
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN NVL(PURCHASE_CRNCY.AMT_DECIMAL,0)
                 ELSE NVL(REDEMPTION_CRNCY.AMT_DECIMAL,0)
            END AS AMT_DECIMAL         -- 幣別小數位數
           -- 2018.07.25 ChengYu 新增EMAIL 欄位
           ,HOLDER.EMAIL
           -- 2020.01.31 ChengYu 新增行動電話欄位
           ,HOLDER.MOBILE
      FROM FAS.REWARD_HISTORY                    -- 紅利歷史使用明細
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ID = REWARD_HISTORY.ID
      LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER      --業務員組別資料
        ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM TEAM                    --業務組別資料
        ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES SALES                  --業務員資料
        ON SALES.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER   --業務員組別資料(FOR EC)
        ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM EC_TEAM                 --業務組別資料(FOR EC)
        ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES EC_SALES               --業務員資料(FOR EC)
        ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN ECS.ECS_OPTION OPTION_ECS_STATUS --欄位選單資料(ECS_STATUS)
        ON OPTION_ECS_STATUS.SOURCE_TYPE = '014'
       AND OPTION_ECS_STATUS.TEXT_VALUE = HOLDER.ECS_STATUS
      LEFT JOIN ECS.ECS_OPTION OPTION_USE_TYPE   --欄位選單資料(USE_TYPE)
        ON OPTION_USE_TYPE.SOURCE_TYPE = '020'
       AND OPTION_USE_TYPE.TEXT_VALUE = REWARD_HISTORY.USE_TYPE
      LEFT JOIN ECS.PURCHASE PURCHASE            --EC申購
        ON PURCHASE.ID = REWARD_HISTORY.ID
       AND PURCHASE.TX_DATE = REWARD_HISTORY.TX_DATE
       AND PURCHASE.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
      LEFT JOIN FAS.FUND PURCHASE_FUND           --基金主檔(FOR 申購)
        ON PURCHASE_FUND.FUND_NO = PURCHASE.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY PURCHASE_CRNCY  --基金幣別View(FOR 申購)
        ON PURCHASE_CRNCY.CURRENCY_NO = PURCHASE_FUND.CURRENCY_NO
      LEFT JOIN ECS.REDEMPTION REDEMPTION        --EC買回
        ON REDEMPTION.ID = REWARD_HISTORY.ID
       AND REDEMPTION.TX_DATE = REWARD_HISTORY.TX_DATE
       AND REDEMPTION.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
      LEFT JOIN FAS.FUND REDEMPTION_FUND         --基金主檔(FOR 買回)
        ON REDEMPTION_FUND.FUND_NO = REDEMPTION.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY REDEMPTION_CRNCY--基金幣別View(FOR 買回)
        ON REDEMPTION_CRNCY.CURRENCY_NO = REDEMPTION_FUND.CURRENCY_NO
     WHERE (CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN PURCHASE.FUND_NO
                ELSE REDEMPTION.FUND_NO
            END = WFUND_NO
        OR WFUND_NO IS NULL)
       -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
       AND TRUNC(REWARD_HISTORY.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
     -- 2018.08.20 ChemgYu 以業務員代碼、EC業務員代碼代替名稱修正排序 
     ORDER BY TEAM.PROFIT_CENTER,HOLDER.SALES_NO,PURCHASE.FUND_NO,HOLDER.ECS_STATUS,REWARD_HISTORY.TX_DATE,REWARD_HISTORY.USE_TYPE,REWARD_HISTORY.ID;
END;

ELSE

BEGIN
    OPEN OUT_ECSR002 FOR
    SELECT  CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_TEAM.PROFIT_CENTER,'EC')
            END AS EC_PROFIT_CENTER -- EC業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(EC_SALES.NAME,'EC')
            END AS EC_SALES_NAME    -- EC業務人員
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' AND PURCHASE.FUND_NO IS NOT NULL THEN '(' || PURCHASE.FUND_NO || ')' || PURCHASE_FUND.SNAME
                 WHEN REWARD_HISTORY.USE_TYPE = '2' AND REDEMPTION.FUND_NO IS NOT NULL THEN '(' || REDEMPTION.FUND_NO || ')'||REDEMPTION_FUND.SNAME
                 ELSE ''
            END AS FUND_NAME        -- 基金名稱
           ,HOLDER.ACCOUNT_NO       -- 戶號
           ,OPTION_ECS_STATUS.DISPLAY_NAME AS ECS_STATUS  -- EC狀態
           ,REWARD_HISTORY.ID AS ID -- 受益人ID
           ,HOLDER.NAME             -- 受益人姓名
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(TEAM.PROFIT_CENTER,'EC')
            END AS PROFIT_CENTER    -- 業務員業績單位
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
           ,CASE WHEN HOLDER.ID IS NULL THEN ''
                 ELSE NVL(SALES.NAME,'EC')
            END AS SALES_NAME       -- 業務人員
           ,REWARD_HISTORY.USE_TYPE -- 使用類別
           ,OPTION_USE_TYPE.DISPLAY_NAME AS USE_TYPE_NAME   -- 使用類別名稱
           ,REWARD_HISTORY.TX_DATE  -- 交易日期
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.AMOUNT,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE 0
            END AS AMOUNT           -- 申購幣別
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.ORG_SERVICE_CHARGE,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE 0
            END AS ORG_SERVICE_CHARGE  -- 原手續費
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN ROUND(NVL(PURCHASE.SERVICE_CHARGE,0),NVL(PURCHASE_CRNCY.AMT_DECIMAL,0))
                 ELSE ROUND(NVL(REDEMPTION.SERVICE_CHARGE,0),NVL(REDEMPTION_CRNCY.AMT_DECIMAL,0))
            END AS SERVICE_CHARGE      -- 折抵後手續費
           ,REWARD_HISTORY.USED_POINT  -- 使用紅利點數
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN NVL(PURCHASE_CRNCY.AMT_DECIMAL,0)
                 ELSE NVL(REDEMPTION_CRNCY.AMT_DECIMAL,0)
            END AS AMT_DECIMAL         -- 幣別小數位數
           -- 2018.07.25 ChengYu 新增EMAIL 欄位
           ,HOLDER.EMAIL
      FROM FAS.REWARD_HISTORY                    -- 紅利歷史使用明細
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ID = REWARD_HISTORY.ID
      LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER      --業務員組別資料
        ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM TEAM                    --業務組別資料
        ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES SALES                  --業務員資料
        ON SALES.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER   --業務員組別資料(FOR EC)
        ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM EC_TEAM                 --業務組別資料(FOR EC)
        ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES EC_SALES               --業務員資料(FOR EC)
        ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN ECS.ECS_OPTION OPTION_ECS_STATUS --欄位選單資料(ECS_STATUS)
        ON OPTION_ECS_STATUS.SOURCE_TYPE = '014'
       AND OPTION_ECS_STATUS.TEXT_VALUE = HOLDER.ECS_STATUS
      LEFT JOIN ECS.ECS_OPTION OPTION_USE_TYPE   --欄位選單資料(USE_TYPE)
        ON OPTION_USE_TYPE.SOURCE_TYPE = '020'
       AND OPTION_USE_TYPE.TEXT_VALUE = REWARD_HISTORY.USE_TYPE
      LEFT JOIN ECS.PURCHASE PURCHASE            --EC申購
        ON PURCHASE.ID = REWARD_HISTORY.ID
       AND PURCHASE.TX_DATE = REWARD_HISTORY.TX_DATE
       AND PURCHASE.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
      LEFT JOIN FAS.FUND PURCHASE_FUND           --基金主檔(FOR 申購)
        ON PURCHASE_FUND.FUND_NO = PURCHASE.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY PURCHASE_CRNCY  --基金幣別View(FOR 申購)
        ON PURCHASE_CRNCY.CURRENCY_NO = PURCHASE_FUND.CURRENCY_NO
      LEFT JOIN ECS.REDEMPTION REDEMPTION        --EC買回
        ON REDEMPTION.ID = REWARD_HISTORY.ID
       AND REDEMPTION.TX_DATE = REWARD_HISTORY.TX_DATE
       AND REDEMPTION.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
      LEFT JOIN FAS.FUND REDEMPTION_FUND         --基金主檔(FOR 買回)
        ON REDEMPTION_FUND.FUND_NO = REDEMPTION.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY REDEMPTION_CRNCY--基金幣別View(FOR 買回)
        ON REDEMPTION_CRNCY.CURRENCY_NO = REDEMPTION_FUND.CURRENCY_NO
     WHERE (CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN PURCHASE.FUND_NO
                ELSE REDEMPTION.FUND_NO
            END = WFUND_NO
        OR WFUND_NO IS NULL)
       -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
       AND TRUNC(REWARD_HISTORY.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
     -- 2018.08.20 ChemgYu 以業務員代碼、EC業務員代碼代替名稱修正排序 
     ORDER BY EC_TEAM.PROFIT_CENTER,HOLDER.EC_SALES_NO,PURCHASE.FUND_NO,HOLDER.ECS_STATUS,REWARD_HISTORY.TX_DATE,REWARD_HISTORY.USE_TYPE,REWARD_HISTORY.ID;
END;

END IF;


END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR002_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR003_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR003_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/29
-- Description: 促銷活動使用紀錄表
-- 2018.07.19 ChengYu 不使用EC定額資料表
-- 2018.08.20 ChengYu 以業務員代碼代替名稱修正排序
-- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
-- 2018.09.10 ChengYu 修正金額取得方式(交易幣為外幣時抓取NTD_AMOUNT、交易幣為計價幣都為台幣時抓取AMOUNT)、基金名稱
-- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
-- =============================================
(
    WTX_DATE_ST       DATE,                      -- 交易日期(起)
    WTX_DATE_ED       DATE,                      -- 交易日期(迄)
    WCAMPAIGN_CODE    VARCHAR2,                  -- 促銷活動代碼
    WORDER_TYPE       VARCHAR2,                  -- 報表排序方式
    OUT_ECSR003       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

IF WORDER_TYPE = '1' THEN
BEGIN
    OPEN OUT_ECSR003 FOR
    SELECT CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
            END AS PROFIT_CENTER
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(SALES.NAME,'EC')
                 ELSE ''
             END AS SALES_NAME
            ,HOLDER.ACCOUNT_NO
            ,HOLDER.ID
            ,HOLDER.NAME
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_TEAM.PROFIT_CENTER,'EC')
                  ELSE ''
             END AS EC_PROFIT_CENTER
             -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_SALES.NAME,'EC')
                  ELSE ''
             END AS EC_SALES_NAME
            ,ECS_OPTION_TX_TYPE.DISPLAY_NAME AS TX_TYPE
            ,V_ALL_PURCHASE.TX_DATE AS TX_DATE
            -- 2018.09.10 ChengYu 修正金額取得方式(交易幣為外幣時抓取NTD_AMOUNT、交易幣為計價幣都為台幣時抓取AMOUNT)、基金名稱
            ,'(' || V_ALL_PURCHASE.FUND_NO || ')' || FUND.SNAME AS FUND_NAME
            ,V_ALL_PURCHASE.CURRENCY_NO AS TX_CURRENCY
            -- 2018.09.10 ChengYu 修正金額取得方式(交易幣為外幣時抓取NTD_AMOUNT、交易幣為計價幣都為台幣時抓取AMOUNT)、基金名稱
            ,CASE WHEN V_ALL_PURCHASE.CURRENCY_NO = 'NTD' AND V_ALL_PURCHASE.CURRENCY_NO = V_ALL_PURCHASE.FUND_CURRENCY_NO THEN ROUND(V_ALL_PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL)
                  WHEN V_ALL_PURCHASE.CURRENCY_NO = 'NTD' AND V_ALL_PURCHASE.CURRENCY_NO != V_ALL_PURCHASE.FUND_CURRENCY_NO THEN ROUND(V_ALL_PURCHASE.NTD_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL)
                  ELSE 0
             END AS AMOUNT
            ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL
            ,CAMPAIGN.CAMPAIGN_CODE
            ,CAMPAIGN.CAMPAIGN_SHNM
       FROM FAS.V_ALL_PURCHASE
       LEFT JOIN FAS.FUND FUND
         ON FUND.FUND_NO = V_ALL_PURCHASE.FUND_NO
       LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
         ON V_FUND_CRNCY.CURRENCY_NO = V_ALL_PURCHASE.CURRENCY_NO
       LEFT JOIN FAS.HOLDER
         ON HOLDER.ID = V_ALL_PURCHASE.ID
       LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER
         ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
       LEFT JOIN SSS.TEAM TEAM
         ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
       LEFT JOIN FAS.SALES SALES
         ON SALES.SALES_NO = HOLDER.SALES_NO
       LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER
         ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
       LEFT JOIN SSS.TEAM EC_TEAM
         ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
       LEFT JOIN FAS.SALES EC_SALES
         ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
       LEFT JOIN ECS.CAMPAIGN CAMPAIGN
         ON CAMPAIGN.CAMPAIGN_CODE = V_ALL_PURCHASE.PROJECT_CODE
       LEFT JOIN ECS.ECS_OPTION ECS_OPTION_TX_TYPE
         ON ECS_OPTION_TX_TYPE.SOURCE_TYPE = '023'
        AND ECS_OPTION_TX_TYPE.TEXT_VALUE = CASE WHEN V_ALL_PURCHASE.BRANCH_NO = '8000' THEN '1'
                                                 WHEN V_ALL_PURCHASE.BRANCH_NO = '8300' THEN '2'
                                                 WHEN V_ALL_PURCHASE.BRANCH_NO = '8200' OR V_ALL_PURCHASE.BRANCH_NO = '8400' THEN '3'
                                                 ELSE ''
                                            END
      WHERE V_ALL_PURCHASE.BROKER_NO = '999'
        AND SUBSTR(V_ALL_PURCHASE.BRANCH_NO,0,1) = '8'
        -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
        AND TRUNC(V_ALL_PURCHASE.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
        AND (CAMPAIGN.CAMPAIGN_CODE = WCAMPAIGN_CODE
         OR WCAMPAIGN_CODE IS NULL)
      -- 2018.08.20 ChengYu 以業務員代碼代替名稱修正排序
      ORDER BY TEAM.PROFIT_CENTER,HOLDER.SALES_NO,CAMPAIGN.CAMPAIGN_CODE,V_ALL_PURCHASE.TX_DATE,TX_TYPE,HOLDER.ID;

END;

ELSE

BEGIN
    OPEN OUT_ECSR003 FOR
    SELECT CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
            END AS PROFIT_CENTER
            -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(SALES.NAME,'EC')
                 ELSE ''
             END AS SALES_NAME
            ,HOLDER.ACCOUNT_NO
            ,HOLDER.ID
            ,HOLDER.NAME
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_TEAM.PROFIT_CENTER,'EC')
                  ELSE ''
             END AS EC_PROFIT_CENTER
             -- 2018.10.02 ChengYu 調整業務員、EC業務員名稱取法
            ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_SALES.NAME,'EC')
                  ELSE ''
             END AS EC_SALES_NAME
            ,ECS_OPTION_TX_TYPE.DISPLAY_NAME AS TX_TYPE
            ,V_ALL_PURCHASE.TX_DATE AS TX_DATE
            -- 2018.09.10 ChengYu 修正金額取得方式(交易幣為外幣時抓取NTD_AMOUNT、交易幣為計價幣都為台幣時抓取AMOUNT)、基金名稱
            ,'(' || V_ALL_PURCHASE.FUND_NO || ')' || FUND.SNAME AS FUND_NAME
            ,V_ALL_PURCHASE.CURRENCY_NO AS TX_CURRENCY
            -- 2018.09.10 ChengYu 修正金額取得方式(交易幣為外幣時抓取NTD_AMOUNT、交易幣為計價幣都為台幣時抓取AMOUNT)、基金名稱
            ,CASE WHEN V_ALL_PURCHASE.CURRENCY_NO = 'NTD' AND V_ALL_PURCHASE.CURRENCY_NO = V_ALL_PURCHASE.FUND_CURRENCY_NO THEN ROUND(V_ALL_PURCHASE.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL)
                  WHEN V_ALL_PURCHASE.CURRENCY_NO = 'NTD' AND V_ALL_PURCHASE.CURRENCY_NO != V_ALL_PURCHASE.FUND_CURRENCY_NO THEN ROUND(V_ALL_PURCHASE.NTD_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL)
                  ELSE 0
             END AS AMOUNT
            ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL
            ,CAMPAIGN.CAMPAIGN_CODE
            ,CAMPAIGN.CAMPAIGN_SHNM
       FROM FAS.V_ALL_PURCHASE
       LEFT JOIN FAS.FUND FUND
         ON FUND.FUND_NO = V_ALL_PURCHASE.FUND_NO
       LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
         ON V_FUND_CRNCY.CURRENCY_NO = V_ALL_PURCHASE.CURRENCY_NO
       LEFT JOIN FAS.HOLDER
         ON HOLDER.ID = V_ALL_PURCHASE.ID
       LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER
         ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
       LEFT JOIN SSS.TEAM TEAM
         ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
       LEFT JOIN FAS.SALES SALES
         ON SALES.SALES_NO = HOLDER.SALES_NO
       LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER
         ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
       LEFT JOIN SSS.TEAM EC_TEAM
         ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
       LEFT JOIN FAS.SALES EC_SALES
         ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
       LEFT JOIN ECS.CAMPAIGN CAMPAIGN
         ON CAMPAIGN.CAMPAIGN_CODE = V_ALL_PURCHASE.PROJECT_CODE
       LEFT JOIN ECS.ECS_OPTION ECS_OPTION_TX_TYPE
         ON ECS_OPTION_TX_TYPE.SOURCE_TYPE = '023'
        AND ECS_OPTION_TX_TYPE.TEXT_VALUE = CASE WHEN V_ALL_PURCHASE.BRANCH_NO = '8000' THEN '1'
                                                 WHEN V_ALL_PURCHASE.BRANCH_NO = '8300' THEN '2'
                                                 WHEN V_ALL_PURCHASE.BRANCH_NO = '8200' OR V_ALL_PURCHASE.BRANCH_NO = '8400' THEN '3'
                                                 ELSE ''
                                            END
      WHERE V_ALL_PURCHASE.BROKER_NO = '999'
        AND SUBSTR(V_ALL_PURCHASE.BRANCH_NO,0,1) = '8'
        -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
        AND TRUNC(V_ALL_PURCHASE.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
        AND (CAMPAIGN.CAMPAIGN_CODE = WCAMPAIGN_CODE
         OR WCAMPAIGN_CODE IS NULL)
      -- 2018.08.20 ChengYu 以業務員代碼代替名稱修正排序
      ORDER BY EC_TEAM.PROFIT_CENTER,HOLDER.EC_SALES_NO,CAMPAIGN.CAMPAIGN_CODE,V_ALL_PURCHASE.TX_DATE,TX_TYPE,HOLDER.ID;
END;

END IF;


END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR003_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR004_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR004_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/08/14
-- Description: 預約開戶名單列印作業
-- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
-- 2018.11.12 yunchu 調整作業處理代碼為(7.開戶完成)，顯示開戶完成
-- 2019.03.04 YungLong 增加JOIN OPTION 是/否
-- 2019.03.04 YungLong 欄位輸出Y/N改成是/否
-- 2021.08.26 ChnegYu 若為線上開戶之客戶，名子前面加*
-- =============================================
(
    WAPPLY_DATE_ST    DATE,                      -- 預約開戶日期(起)
    WAPPLY_DATE_ED    DATE,                      -- 預約開戶日期(迄)
    OUT_ECSR004       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR004 FOR
    SELECT  TRUNC(HOLDER.APPLY_DTTM) AS APPLY_DATE
           ,HOLDER.ID AS ID
            -- 2021.08.26 ChnegYu 若為線上開戶之客戶，名子前面加*
           ,CASE WHEN HOLDER.OPEN_TYPE = '1' THEN HOLDER.NAME 
                 WHEN HOLDER.OPEN_TYPE = '2' THEN '*'||HOLDER.NAME
                 ELSE ' ' END AS NAME
           ,CASE WHEN HOLDER.TEL_O_NO IS NOT NULL THEN '(' || HOLDER.TEL_O_AREA || ')' || HOLDER.TEL_O_NO ||'#' || HOLDER.TEL_O_EXT
                 ELSE ''
            END AS TEL_O
           ,CASE WHEN HOLDER.TEL_H_NO IS NOT NULL THEN '(' || HOLDER.TEL_H_AREA || ')' || HOLDER.TEL_H_NO ||'#' || HOLDER.TEL_H_EXT
                 ELSE ''
            END AS TEL_H
           ,HOLDER.MOBILE AS MOBILE
           ,HOLDER.POST_CODE AS POST_CODE
           ,HOLDER.CONTACT_ADDRESS AS CONTACT_ADDRESS
           -- 2019.03.04 YungLong 增加JOIN OPTION 是/否
           ,ECS_OPTION_DOC_CODE.DISPLAY_NAME AS DOC_CODE
           -- 2018.11.12 yunchu 調整作業處理代碼為(7.開戶完成)，顯示開戶完成
           -- 2019.03.04 YungLong 欄位輸出Y/N改成是/否
           ,CASE WHEN HOLDER.PROCESS_CODE = 7 THEN '是' --作業處理碼 7：開戶完成
                 ELSE '否'
            END AS IS_APPLY
      FROM ECS.HOLDER HOLDER
      -- 2019.03.04 YungLong 增加JOIN OPTION 是/否
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DOC_CODE
        ON ECS_OPTION_DOC_CODE.SOURCE_TYPE = '000'
       AND ECS_OPTION_DOC_CODE.TEXT_VALUE = HOLDER.DOC_CODE
           -- 2018.08.23 ChengYu 修復因資料中日期有時間，而撈不到資料的錯誤
     WHERE TRUNC(HOLDER.APPLY_DTTM) BETWEEN WAPPLY_DATE_ST AND WAPPLY_DATE_ED
     ORDER BY TRUNC(HOLDER.APPLY_DTTM),HOLDER.ID;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR004_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR005_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR005_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/11/6
-- Description: 列印網路申購、贖回、轉申購交易核對表
-- =============================================
(    
    WAMC_NO           VARCHAR2,                  -- 基金公司代碼
    WTX_DATE          DATE,                      -- 交易日
    WTRADE_TYPE       VARCHAR2,                  -- 交易型態(例:1,2,3(多選) 值:1.申購 2.贖回 3.轉申購)
    WPRINT_TYPE       VARCHAR2,                  -- 報表種類(1.總匯表 2.明細表(單選))
    OUT_PURCHASE      OUT SYS_REFCURSOR,         -- 申購回傳的 TABLEDATA
    OUT_REDEMPTION    OUT SYS_REFCURSOR,         -- 贖回回傳的 TABLEDATA
    OUT_SWITCH        OUT SYS_REFCURSOR          -- 轉申購回傳的 TABLEDATA
) IS

BEGIN

-- 報表種類:總匯表
IF WPRINT_TYPE = '1' THEN
BEGIN

  -- 申購
  OPEN OUT_PURCHASE FOR  
  SELECT  AMC.NAME                                            AS AMC_NAME        -- 基金公司
         ,'(' || FUND.FUND_NO || ')' || FUND.SNAME            AS FUND_NAME       -- 基金代碼
         ,V_FUND_CRNCY.AMT_DECIMAL                            AS AMT_DECIMAL     -- 幣別小數
         ,V_FUND_CRNCY.NAME                                   AS TRADE_CRNCY_NAME-- 交易幣別
         ,SUM(PURCHASE.AMOUNT)                                AS AMOUNT          -- 扣款金額
         ,SUM(PURCHASE.SERVICE_CHARGE)                        AS SERVICE_CHARGE  -- 手續費
         ,SUM(PURCHASE.AMOUNT) + SUM(PURCHASE.SERVICE_CHARGE) AS TOT_AMOUNT      -- 總金額
         ,COUNT(1)                                            AS COUNT           -- 筆數
    FROM ECS.PURCHASE
    LEFT JOIN FAS.FUND
      ON FUND.FUND_NO = PURCHASE.FUND_NO
    LEFT JOIN FAS.AMC
      ON AMC.AMC_NO = FUND.AMC_NO
    LEFT JOIN ECS.V_FUND_CRNCY
      ON V_FUND_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
   WHERE PURCHASE.STATUS = 'O'
     AND (   AMC.AMC_NO = WAMC_NO
          OR WAMC_NO IS NULL
         )
     AND PURCHASE.TX_DATE = WTX_DATE
     AND '1' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
   GROUP BY FUND.FUND_NO,AMC.NAME, FUND.SNAME,V_FUND_CRNCY.AMT_DECIMAL,V_FUND_CRNCY.NAME , PURCHASE.CURRENCY_NO,AMC.AMC_NO
   ORDER BY AMC.AMC_NO, FUND.FUND_NO, PURCHASE.CURRENCY_NO;

  -- 贖回 
  OPEN OUT_REDEMPTION FOR
  SELECT  AMC.NAME                                      AS AMC_NAME          -- 基金公司
         ,'('|| REDEMPTION.FUND_NO ||')' || FUND.SNAME  AS FUND_NAME         -- 基金代碼
         ,SUM(REDEMPTION.APPLICATION_SHARE)             AS APPLICATION_SHARE -- 贖回單位數
         ,FUND.SHARE_DECIMAL                            AS SHARE_DECIMAL     -- 單位數小數位數
         ,COUNT(1)                                      AS COUNT             -- 筆數
    FROM ECS.REDEMPTION
    LEFT JOIN FAS.FUND
      ON FUND.FUND_NO = REDEMPTION.FUND_NO
    LEFT JOIN FAS.AMC
      ON AMC.AMC_NO = FUND.AMC_NO
   WHERE REDEMPTION.STATUS = 'O'
     AND REDEMPTION.BRANCH_NO != '8300'
     AND (   AMC.AMC_NO = WAMC_NO
          OR WAMC_NO IS NULL
         )
     AND REDEMPTION.TX_DATE = WTX_DATE
     AND '2' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
   GROUP BY AMC.NAME, REDEMPTION.FUND_NO, FUND.SNAME, FUND.SHARE_DECIMAL, AMC.AMC_NO
   ORDER BY AMC.AMC_NO, REDEMPTION.FUND_NO;

  -- 轉申購 
  OPEN OUT_SWITCH FOR
  SELECT  AMC_OUT.NAME  AS AMC_NAME_OUT                                       --基金公司
         ,'('|| REDEMPTION.FUND_NO ||')' || FUND_OUT.SNAME  AS FUND_NAME_OUT  --基金代碼
         ,FUND_OUT.SHARE_DECIMAL                                              --單位小數
         ,SUM(REDEMPTION.APPLICATION_SHARE) AS APPLICATION_SHARE              --贖回單位數
         ,COUNT(1) AS COUNT                                                   --筆數
         ,AMC_IN.NAME AS AMC_NAME_IN                                          --轉入基金公司
         ,'('|| REDEMPTION.FUND_NO_IN ||')' || FUND_IN.SNAME AS FUND_NAME_IN  --轉入基金代碼
    FROM ECS.REDEMPTION
    LEFT JOIN FAS.FUND FUND_OUT
      ON FUND_OUT.FUND_NO = REDEMPTION.FUND_NO
    LEFT JOIN FAS.AMC AMC_OUT
      ON AMC_OUT.AMC_NO = FUND_OUT.AMC_NO
    LEFT JOIN FAS.FUND FUND_IN
      ON FUND_IN.FUND_NO = REDEMPTION.FUND_NO_IN
    LEFT JOIN FAS.AMC AMC_IN
      ON AMC_IN.AMC_NO = FUND_IN.AMC_NO
   WHERE REDEMPTION.STATUS = 'O'
     AND REDEMPTION.BRANCH_NO = '8300'
     AND (   FUND_OUT.AMC_NO = WAMC_NO
          OR WAMC_NO IS NULL
         )
     AND REDEMPTION.TX_DATE = WTX_DATE
     AND '3' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
   GROUP BY AMC_OUT.NAME, REDEMPTION.FUND_NO, FUND_OUT.SNAME, AMC_IN.NAME, REDEMPTION.FUND_NO_IN, FUND_IN.SNAME, FUND_OUT.SHARE_DECIMAL, AMC_OUT.AMC_NO, AMC_IN.AMC_NO
   ORDER BY AMC_OUT.AMC_NO, REDEMPTION.FUND_NO, AMC_IN.AMC_NO, REDEMPTION.FUND_NO_IN;

END;

-- 報表種類:明細表
ELSE
BEGIN

  -- 申購
  OPEN OUT_PURCHASE FOR
  SELECT  '('||FUND.FUND_NO||')'||FUND.SNAME  AS FUND_NAME                           --基金代碼
         ,DEPOSITORY.NAME AS DEPOSITORY_NAME                                         --付款平台
         ,V_FUND_CRNCY.NAME  AS TRADE_CRNCY_NAME                                     --交易幣別
         ,PURCHASE.BROKER_NO || PURCHASE.BRANCH_NO || PURCHASE.SER_NO AS SER_NO      --申購書號
         ,'('||PURCHASE.BANK_NO||')'||FIS_BANK.SNAME    AS BANK_NAME                 --扣款銀行
         ,PURCHASE.AC_CODE AS AC_CODE                                                --扣款帳號
         ,PURCHASE.ID|| '/' || '('|| HOLDER.ACCOUNT_NO ||')' || HOLDER.NAME AS NAME  --受益人ID/姓名
         ,PURCHASE.AMOUNT AS AMOUNT                                                  --扣款金額
         ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL                                    --金額小數位數
         ,PURCHASE.SC_RATE AS SC_RATE                                                --手續費率(%)
         ,PURCHASE.SERVICE_CHARGE AS SERVICE_CHARGE                                  --手續費
         ,OPTION_041.DISPLAY_NAME AS FEE_CHOICE                                      --優惠方案
         ,PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE AS TOT_AMOUNT                    --總金額
    FROM ECS.PURCHASE
    LEFT JOIN FAS.HOLDER
      ON HOLDER.ID = PURCHASE.ID
    LEFT JOIN FAS.FUND
      ON FUND.FUND_NO = PURCHASE.FUND_NO
    LEFT JOIN FAS.AMC
      ON FUND.AMC_NO = AMC.AMC_NO
    LEFT JOIN FAS.DEPOSITORY
      ON DEPOSITORY.DEPOSITORY_NO = AMC.DEPOSITORY_NO
    LEFT JOIN ECS.V_FUND_CRNCY
      ON V_FUND_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
    LEFT JOIN FAS.FIS_BANK
      ON FIS_BANK.BANK_NO = PURCHASE.BANK_NO
    LEFT JOIN ECS.V_FUND_CRNCY
      ON V_FUND_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
    LEFT JOIN ECS.ECS_OPTION OPTION_041
      ON OPTION_041.SOURCE_TYPE = '041'
     AND OPTION_041.TEXT_VALUE = PURCHASE.FEE_CHOICE
   WHERE PURCHASE.STATUS = 'O'
     AND (   AMC.AMC_NO = WAMC_NO
          OR WAMC_NO IS NULL
         )
     AND PURCHASE.TX_DATE = WTX_DATE
     AND '1' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
   -- 依基金代碼+扣款平台+交易幣別+申購書號
   ORDER BY PURCHASE.FUND_NO, AMC.AMC_NO, PURCHASE.CURRENCY_NO, PURCHASE.BROKER_NO, PURCHASE.BRANCH_NO, PURCHASE.SER_NO;

   -- 贖回
   OPEN OUT_REDEMPTION FOR
   SELECT  '('|| REDEMPTION.FUND_NO ||')' || FUND.SNAME AS FUND_NAME                   --基金代碼
          ,REDEMPTION.BROKER_NO || REDEMPTION.BRANCH_NO || REDEMPTION.SER_NO AS SER_NO --贖回書號
          ,REDEMPTION.ID|| '/' ||'('|| HOLDER.ACCOUNT_NO ||')' || HOLDER.NAME AS NAME  --受益人ID/姓名
          ,'('||REDEMPTION.AC_BANK||')'||FIS_BANK.SNAME AS BANK_NAME                   --匯入銀行
          ,REDEMPTION.AC_CODE AS AC_CODE                                               --匯入帳號
          ,REDEMPTION.APPLICATION_SHARE AS APPLICATION_SHARE                           --贖回單位數
          ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL                                         --單位數小數位數
     FROM ECS.REDEMPTION
     LEFT JOIN FAS.HOLDER
       ON HOLDER.ID = REDEMPTION.ID
     LEFT JOIN FAS.FUND
       ON FUND.FUND_NO = REDEMPTION.FUND_NO
     LEFT JOIN FAS.AMC 
       ON AMC.AMC_NO = FUND.AMC_NO
     LEFT JOIN FAS.FIS_BANK
       ON FIS_BANK.BANK_NO = REDEMPTION.AC_BANK
    WHERE REDEMPTION.STATUS = 'O'
      AND REDEMPTION.BRANCH_NO != '8300'
      AND (   AMC.AMC_NO = WAMC_NO
           OR WAMC_NO IS NULL
          )
      AND REDEMPTION.TX_DATE = WTX_DATE
      AND '2' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
    ORDER BY REDEMPTION.FUND_NO,REDEMPTION.BROKER_NO,REDEMPTION.BRANCH_NO,REDEMPTION.SER_NO;

   --轉申購
   OPEN OUT_SWITCH FOR
   SELECT '('|| REDEMPTION.FUND_NO ||')' || FUND_OUT.SNAME AS FUND_NAME                     --基金代碼
          ,REDEMPTION.BROKER_NO || REDEMPTION.BRANCH_NO || REDEMPTION.SER_NO AS SER_NO      --贖回書號
          ,REDEMPTION.ID || '/' || '(' || HOLDER.ACCOUNT_NO || ')' || HOLDER.NAME AS NAME   --受益人ID/姓名
          ,REDEMPTION.APPLICATION_SHARE AS APPLICATION_SHARE                                --贖回單位數
          ,REDEMPTION.SC_RATE AS SC_RATE                                                    --手續費率(%)
          ,CASE WHEN REDEMPTION.FEE_CHOICE = '3' THEN REDEMPTION.SERVICE_CHARGE
                ELSE 0
           END AS SERVICE_CHARGE                                                            --手續費
          ,OPTION_041.DISPLAY_NAME AS FEE_CHOICE                                            --優惠方案
          ,'(' || REDEMPTION.FUND_NO_IN || ')' || FUND_IN.SNAME AS FUND_NAME_IN             --轉入基金代碼
          ,FUND_OUT.SHARE_DECIMAL
     FROM ECS.REDEMPTION
     LEFT JOIN FAS.HOLDER
       ON HOLDER.ID = REDEMPTION.ID
     LEFT JOIN FAS.FUND FUND_OUT
       ON FUND_OUT.FUND_NO = REDEMPTION.FUND_NO
     LEFT JOIN FAS.FUND FUND_IN
       ON FUND_IN.FUND_NO = REDEMPTION.FUND_NO_IN
     LEFT JOIN ECS.ECS_OPTION OPTION_041
       ON OPTION_041.SOURCE_TYPE = '041'
      AND OPTION_041.TEXT_VALUE = REDEMPTION.FEE_CHOICE
    WHERE REDEMPTION.STATUS = 'O'
      AND REDEMPTION.BRANCH_NO = '8300'
      AND (   FUND_OUT.AMC_NO = WAMC_NO
           OR WAMC_NO IS NULL
          )
      AND REDEMPTION.TX_DATE = WTX_DATE
      AND '3' IN (SELECT VALUE1 FROM (TABLE(ECS.F_FormatStringListToTable(WTRADE_TYPE))))
    ORDER BY REDEMPTION.FUND_NO,REDEMPTION.BROKER_NO,REDEMPTION.BRANCH_NO,REDEMPTION.SER_NO;

END;

END IF;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR005_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR006_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR006_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/10/15
-- Description: 優惠券使用記錄表
-- 2018.12.25 ChengYu 調整電話取法
-- 2018.12.25 ChengYu 調整電話取法、排序
-- 2018.01.10 ChengYu 調整報表的名稱顯示
-- =============================================
(
    WCANCEL_DATE      DATE,                      -- 取消日期
    WFAS_STATUS       VARCHAR2,                  -- FAS 系統處理狀態
    OUT_ECSR006       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

  OPEN OUT_ECSR006 FOR
  SELECT  ROBO_DISMISSAL.ROBO_CONTRACT_NO --ROBO契約書號
          -- 2018.01.10 ChengYu 調整報表的名稱顯示
         ,ROBO_DISMISSAL.ID || 
          CASE WHEN HOLDER.ACCOUNT_NO IS NOT NULL THEN '/(' ||HOLDER.ACCOUNT_NO||')'||HOLDER.NAME ELSE '' END AS NAME --受益人ID/姓名
         -- 2018.12.25 ChengYu 調整電話取法、排序
         ,CASE WHEN HOLDER.TEL_O_AREA IS NOT NULL THEN '(' || HOLDER.TEL_O_AREA || ')' ELSE '' END || 
          HOLDER.TEL_O || 
          CASE WHEN HOLDER.TEL_O_EXT IS NOT NULL THEN '#' || HOLDER.TEL_O_EXT ELSE '' END AS TEL_O --公司電話
         -- 2018.12.25 ChengYu 調整電話取法、排序
         ,CASE WHEN HOLDER.TEL_H_AREA IS NOT NULL THEN '(' || HOLDER.TEL_H_AREA || ')' ELSE '' END || 
          HOLDER.TEL_H || 
          CASE WHEN HOLDER.TEL_H_EXT IS NOT NULL THEN '#' || HOLDER.TEL_H_EXT ELSE '' END TEL_H --住家電話
         ,HOLDER.MOBILE --行動電話
         ,ROBO_DISMISSAL.CANCEL_DATE --取消日期
         ,ECS_OPTION.DISPLAY_NAME AS FAS_STATUS --FAS系統處理狀態
    FROM ECS.ROBO_DISMISSAL
    LEFT JOIN FAS.HOLDER HOLDER
      ON HOLDER.ID = ROBO_DISMISSAL.ID
    LEFT JOIN ECS.ECS_OPTION ECS_OPTION
      ON ECS_OPTION.SOURCE_TYPE = '046'
     AND ECS_OPTION.TEXT_VALUE = ROBO_DISMISSAL.FAS_STATUS
   WHERE TRUNC(ROBO_DISMISSAL.CANCEL_DATE) = WCANCEL_DATE
     AND (ROBO_DISMISSAL.FAS_STATUS = WFAS_STATUS OR WFAS_STATUS IS NULL)
   -- 2018.12.25 ChengYu 調整電話取法、排序
   ORDER BY ROBO_CONTRACT_NO;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR006_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR007_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR007_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/10/11
-- Description: 優惠券發放明細表
-- 2018.10.11 ChengYu 補欄位註解
-- 2018.01.11 ChengYu 調整排序寫法
-- 2018.01.29 YungLong 調整業務員姓名、EC業務人員CASE WHEN判斷及業務員姓名、業績單位排序
-- =============================================
(
    WPROGRAM_NO       VARCHAR2,                  -- 優惠券活動代碼
    WISSUE_DATE_ST    DATE,                      -- 配發日期(起)
    WISSUE_DATE_ED    DATE,                      -- 配發日期(迄)
    WORDER_TYPE       VARCHAR2,                  -- 報表排序方式(1.以業務員業績單位跳頁 2.以EC業務員業績單位跳頁)
    OUT_ECSR007       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN
    -- 2018.10.11 ChengYu 補欄位註解 BEGIN
    OPEN OUT_ECSR007 FOR
    SELECT  CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
                 END AS EC_PROFIT_CENTER                    -- EC業務員業績單位
            -- 2018.01.29 YungLong 調整CASE WHEN判斷
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_SALES.NAME,'')
                 ELSE ''
                 END AS EC_SALES_NAME                       -- EC業務人員
           ,HOLDER.ACCOUNT_NO                               -- 戶號
           ,OPTION_ECS_STATUS.DISPLAY_NAME AS ECS_STATUS    -- EC狀態
           ,COUPON_DATA.ID                                  -- 客戶ID
           ,COUPON_DATA.NAME AS COUPON_NAME                 -- 姓名(活動)
           ,HOLDER.NAME AS HOLDER_NAME                      -- 姓名(受益人)
           ,COUPON_DATA.MOBILE AS COUPON_MOBILE             -- 行動電話(活動)
           ,HOLDER.MOBILE AS HOLDER_MOBILE                  -- 行動電話(受益人)
           ,COUPON_DATA.EMAIL AS COUPON_EMAIL               -- EMAIL(活動)
           ,HOLDER.EMAIL AS HOLDER_EMAIL                    -- EMAIL(受益人)
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
                 END AS PROFIT_CENTER                       -- 業務員業績單位
            -- 2018.01.29 YungLong 調整CASE WHEN判斷
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(SALES.NAME,'')
                 ELSE ''
                 END AS SALES_NAME                          -- 業務員姓名
           ,COUPON_DATA.ISSUE_DATE                          -- 發放日期
           ,COUPON_DATA.PROGRAM_NO                          -- 活動代碼
           ,COUPON_PROGRAM.NAME AS PROGRAM_NAME             -- 活動名稱
           ,COUPON_DATA.COUPON_ID                           -- 優惠券號碼
           ,COUPON_DATA.VALID_THRU                          -- 優惠券有效日期
      FROM ECS.COUPON_DATA COUPON_DATA
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ID = COUPON_DATA.ID
      LEFT JOIN ECS.COUPON_PROGRAM COUPON_PROGRAM
        ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO
      LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER
        ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM TEAM
        ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES SALES
        ON SALES.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER
        ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM EC_TEAM
        ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES EC_SALES
        ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO  
      LEFT JOIN ECS.ECS_OPTION OPTION_ECS_STATUS --欄位選單資料(ECS_STATUS)
        ON OPTION_ECS_STATUS.SOURCE_TYPE = '014'
       AND OPTION_ECS_STATUS.TEXT_VALUE = HOLDER.ECS_STATUS
     WHERE TRUNC(COUPON_DATA.ISSUE_DATE) BETWEEN WISSUE_DATE_ST AND WISSUE_DATE_ED
       AND ((COUPON_DATA.PROGRAM_NO = WPROGRAM_NO)
             OR 
            (WPROGRAM_NO IS NULL))
     -- 2018.01.11 ChengYu 調整排序寫法
     -- 2018.01.29 YungLong 調整業務員姓名、業績單位排序
     ORDER BY DECODE(WORDER_TYPE,'1',PROFIT_CENTER,EC_PROFIT_CENTER) 
             ,DECODE(WORDER_TYPE,'1',SALES_NAME,EC_SALES_NAME) 
             ,HOLDER.ECS_STATUS
             ,COUPON_DATA.ISSUE_DATE
             ,HOLDER.ID; 
     -- 2018.10.11 ChengYu 補欄位註解 END

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR007_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR008_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR008_GET" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/10/15
-- Description: 優惠券使用記錄表
-- 2018.12.25 ChengYu 調整效能
-- 2018.01.29 YungLong 調整業務員姓名、EC業務人員CASE WHEN判斷及業務員姓名、業績單位排序
-- =============================================
(
    WTX_DATE_ST       DATE,                      -- 交易日期(起)
    WTX_DATE_ED       DATE,                      -- 交易日期(迄)
    WFUND_NO          VARCHAR2,                  -- 基金代碼
    WORDER_TYPE       VARCHAR2,                  -- 報表排序方式(1.以業務員業績單位跳頁 2.以EC業務員業績單位跳頁)
    OUT_ECSR008       OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR008 FOR
    -- 2018.12.25 ChengYu 調整效能
    SELECT  CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
                 END AS PROFIT_CENTER       -- 業務員業績單位
            -- 2018.01.29 YungLong 調整CASE WHEN判斷
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(SALES.NAME,'')
                 ELSE ''
                 END AS SALES_NAME          -- 業務員姓名
           ,FUND.FUND_NO                    -- 基金代碼
           ,FUND.SNAME AS FUND_NAME         -- 基金名稱
           ,HOLDER.ACCOUNT_NO               -- 受益人戶號
           ,OPTION_ECS_STATUS.DISPLAY_NAME AS ECS_STATUS  --EC狀態
           ,COUPON_HISTORY.ID               -- 受益人ID
           ,HOLDER.NAME                     -- 姓名
           ,HOLDER.MOBILE                   -- 行動電話
           ,HOLDER.EMAIL                    -- EMAIL
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_TEAM.PROFIT_CENTER,'EC')
                 ELSE ''
                 END AS EC_PROFIT_CENTER    -- EC業務員業績單位
            -- 2018.01.29 YungLong 調整CASE WHEN判斷
           ,CASE WHEN HOLDER.ID IS NOT NULL THEN NVL(EC_SALES.NAME,'')
                 ELSE ''
                 END AS EC_SALES_NAME       -- EC業務員姓名
           ,CASE WHEN COUPON_HISTORY.USE_TYPE = '1' THEN '單筆申購'
                 WHEN COUPON_HISTORY.USE_TYPE = '2' THEN '定期定額'
                 WHEN COUPON_HISTORY.USE_TYPE = '3' THEN '定期不定額'
                 WHEN COUPON_HISTORY.USE_TYPE = '4' THEN '轉申購'
                 ELSE ''
                 END AS USE_TYPE            -- 交易類別
           ,COUPON_HISTORY.TX_DATE          -- 交易日期
           ,ROUND(COUPON_HISTORY.AMOUNT,V_TRADE_CRNCY.AMT_DECIMAL) AS AMOUNT                         -- 申購金額
           ,ROUND(COUPON_HISTORY.ORG_SERVICE_CHARGE,V_TRADE_CRNCY.AMT_DECIMAL) AS ORG_SERVICE_CHARGE -- 原手續費
           ,COUPON_HISTORY.COUPON_ID        -- 優惠券號碼
           ,V_TRADE_CRNCY.AMT_DECIMAL       -- 金額小數位數
      FROM ( -- 單筆申購資料
             SELECT  PURCHASE.FUND_NO               -- 基金別
                    ,PURCHASE.ID                    -- ID
                    ,PURCHASE.CURRENCY_NO           -- 幣別
                    ,COUPON_HISTORY.USE_TYPE        -- 使用類別
                    ,COUPON_HISTORY.TX_DATE         -- 交易日期
                    ,PURCHASE.AMOUNT                -- 申購價金
                    ,PURCHASE.ORG_SERVICE_CHARGE    -- 原手續費
                    ,PURCHASE.COUPON_ID             -- 優惠券號碼
                    ,PURCHASE.TRANSACTION_NO        -- 交易編號
               FROM ECS.COUPON_HISTORY
               JOIN ECS.PURCHASE
                 ON COUPON_HISTORY.TRANSACTION_NO = PURCHASE.TRANSACTION_NO
              WHERE TRUNC(COUPON_HISTORY.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
                AND (PURCHASE.FUND_NO = WFUND_NO
                     OR WFUND_NO IS NULL)
                AND COUPON_HISTORY.USE_TYPE = '1'
             UNION ALL
             -- 定期定額、定期不定額資料
             SELECT  RSP.FUND_NO                    -- 基金別
                    ,RSP.ID                         -- ID
                    ,RSP.CURRENCY_NO                -- 幣別
                    ,COUPON_HISTORY.USE_TYPE        -- 使用類別
                    ,COUPON_HISTORY.TX_DATE         -- 交易日期
                    ,RSP.AMOUNT                     -- 申購價金
                    ,0 AS ORG_SERVICE_CHARGE        -- 原手續費
                    ,RSP.COUPON_ID                  -- 優惠券號碼
                    ,RSP.TRANSACTION_NO             -- 交易編號
               FROM ECS.COUPON_HISTORY
               JOIN ECS.RSP
                 ON COUPON_HISTORY.TRANSACTION_NO = RSP.TRANSACTION_NO
              WHERE TRUNC(COUPON_HISTORY.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
                AND (RSP.FUND_NO = WFUND_NO
                     OR WFUND_NO IS NULL)
                AND (COUPON_HISTORY.USE_TYPE = '2' 
                     OR COUPON_HISTORY.USE_TYPE = '3')
             UNION ALL
             -- 轉申購資料
             SELECT  REDEMPTION.FUND_NO_IN          -- 轉申購基金別
                    ,REDEMPTION.ID                  -- ID
                    ,REDEMPTION.CURRENCY_NO         -- 幣別
                    ,COUPON_HISTORY.USE_TYPE        -- 使用類別
                    ,COUPON_HISTORY.TX_DATE         -- 交易日期
                    ,0 AS AMOUNT                    -- 申購價金
                    ,0 AS ORG_SERVICE_CHARGE        -- 原手續費
                    ,REDEMPTION.COUPON_ID           -- 優惠券號碼
                    ,REDEMPTION.TRANSACTION_NO      -- 交易編號
               FROM ECS.COUPON_HISTORY
               JOIN ECS.REDEMPTION
                 ON COUPON_HISTORY.TRANSACTION_NO = REDEMPTION.TRANSACTION_NO
              WHERE TRUNC(COUPON_HISTORY.TX_DATE) BETWEEN WTX_DATE_ST AND WTX_DATE_ED
                AND (REDEMPTION.FUND_NO_IN = WFUND_NO
                     OR WFUND_NO IS NULL)
                AND COUPON_HISTORY.USE_TYPE = '4'
           ) COUPON_HISTORY
      LEFT JOIN FAS.FUND FUND
        ON FUND.FUND_NO = COUPON_HISTORY.FUND_NO
      LEFT JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = COUPON_HISTORY.CURRENCY_NO
      LEFT JOIN FAS.HOLDER HOLDER
        ON HOLDER.ID = COUPON_HISTORY.ID
      LEFT JOIN FAS.SALES SALES
        ON SALES.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER TEAM_MEMBER
        ON TEAM_MEMBER.SALES_NO = HOLDER.SALES_NO
      LEFT JOIN SSS.TEAM TEAM
        ON TEAM.TEAM_NO = TEAM_MEMBER.TEAM_NO
      LEFT JOIN FAS.SALES EC_SALES
        ON EC_SALES.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM_MEMBER EC_TEAM_MEMBER
        ON EC_TEAM_MEMBER.SALES_NO = HOLDER.EC_SALES_NO
      LEFT JOIN SSS.TEAM EC_TEAM
        ON EC_TEAM.TEAM_NO = EC_TEAM_MEMBER.TEAM_NO
      LEFT JOIN ECS.ECS_OPTION OPTION_ECS_STATUS --欄位選單資料(ECS_STATUS)
        ON OPTION_ECS_STATUS.SOURCE_TYPE = '014'
       AND OPTION_ECS_STATUS.TEXT_VALUE = HOLDER.ECS_STATUS
       -- 2018.01.29 YungLong 調整業務員姓名、業績單位排序
     ORDER BY DECODE(WORDER_TYPE,'1',PROFIT_CENTER,EC_PROFIT_CENTER)
             ,DECODE(WORDER_TYPE,'1',SALES_NAME,EC_SALES_NAME)
             ,FUND.FUND_NO
             ,HOLDER.ECS_STATUS
             ,COUPON_HISTORY.TX_DATE
             ,COUPON_HISTORY.USE_TYPE
             ,HOLDER.ID;
END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR008_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR009_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR009_GET" 
-- =============================================
-- Author:      tingting
-- Create date: 2019/07/19
-- Description: 網路申購外幣扣款總表
-- 2019.08.02 tingting 增加傳出交易幣別、交易幣別小數位數欄位
-- 2019.11.13 ChengYu 修正資料多筆問題，連結ECS.OFD074【代扣款行基本資料檔】時增加BANK_SUB_TYPE(業務別)限制條件
-- =============================================
(
    WALLOT_DATE         DATE,               --交易日期
    WFUND_ID            VARCHAR2,           --基金代碼
    WDATA_CENTER        VARCHAR2,           --代理扣款機構
    OUT_ECSR009         OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR009 FOR
    SELECT  TEMPOFD.ALLOT_DATE                          --交易日期  
           ,TEMPOFD.DATA_CENTER                         --代理扣款機構
           ,FIS_BANK.SNAME AS BANK_HQ_SHNM              --代理扣款機構簡稱
           ,ECS_OPTION.DISPLAY_NAME AS DisplayName      --扣款方式名稱
           ,TEMPOFD.FUND_ID                             --基金代碼
           ,FUND.SNAME AS FUND_SH_NM                    --基金中文簡稱
           ,TEMPOFD.T_COUNT                             --總筆數
           ,TEMPOFD.T_SUM_AMT                           --總金額
           ,TEMPOFD.SUC_COUNT                           --總成功筆數
           ,TEMPOFD.SUC_SUM_AMT                         --總成功金額
           ,TEMPOFD.FAL_COUNT                           --總失敗筆數
           ,TEMPOFD.FAL_SUM_AMT                         --總失敗金額
           --,ISNULL(FUND.REPORT_SEQ, 0) AS REPORT_SEQ    --報表排序順序
           ,FUND_CURRENCY.NAME AS FUND_CURRENCY         --計價幣別
           ,NVL(FUND.AMT_DECIMAL, 0) FUND_DEC_LEN       --計價幣別小數位數
           -- 2019.08.02 tingting 增加傳出交易幣別、交易幣別小數位數欄位
           ,CURRENCY.NAME AS CURRENCY                   --交易幣別
           ,CASE WHEN TEMPOFD.CURRENCY_NO IN ('NTD','TWD') THEN 0 ELSE NVL(FUND.AMT_DECIMAL, 0) END DEC_LEN    --交易幣別小數位數(先抓計價幣別小數位數)
           ,CASE WHEN TEMPOFD.SEAL_TYPE = '1'
                 THEN OFD074.CNT_P
                 ELSE OFD076.CNT_P
                 END AS CNT_P                           --聯絡人
           ,CASE WHEN TEMPOFD.SEAL_TYPE = '1'
                 THEN OFD074.CNT_TEL1_AREA
                 ELSE OFD076.CNT_TEL1_AREA
                 END AS CNT_TEL1_AREA
           ,CASE WHEN TEMPOFD.SEAL_TYPE = '1'
                 THEN OFD074.CNT_TEL1
                 ELSE OFD076.CNT_TEL1
                 END AS CNT_TEL1                        --聯絡電話
           ,CASE WHEN TEMPOFD.SEAL_TYPE = '1'
                 THEN OFD074.CNT_FAX_AREA
                 ELSE OFD076.CNT_FAX_AREA
                 END AS CNT_FAX_AREA
           ,CASE WHEN TEMPOFD.SEAL_TYPE = '1'
                 THEN OFD074.CNT_FAX
                 ELSE OFD076.CNT_FAX
                 END AS CNT_FAX                         --傳真電話
      FROM (
            SELECT  PURCHASE.TX_DATE AS ALLOT_DATE      --交易日期
                   ,OFD074.DATA_CENTER                  --代理扣款機構
                   ,'3' AS SEAL_TYPE                    --扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                   ,PURCHASE.FUND_NO AS FUND_ID         --基金代碼
                   -- 2019.08.02 tingting 增加傳出交易幣別、交易幣別小數位數欄位
                   ,PURCHASE.CURRENCY_NO                --交易幣別
                   ,PURCHASE.SUB_STATUS                 --交易狀態(O: 委託中/C:已確認/P:已結帳)
                   ,COUNT(*) T_COUNT                    --總筆數
                   ,SUM(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE) T_SUM_AMT     --總金額(申購價金+手續費)
                   ,SUM(CASE WHEN PURCHASE.SUB_STATUS = '2' THEN 1 ELSE 0 END) AS SUC_COUNT                                             --總成功筆數
                   ,SUM(CASE WHEN PURCHASE.SUB_STATUS = '2' THEN PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE ELSE 0 END) AS SUC_SUM_AMT   --總成功金額
                   ,SUM(CASE WHEN PURCHASE.SUB_STATUS = '3' THEN 1 ELSE 0 END) AS FAL_COUNT                                             --總失敗筆數
                   ,SUM(CASE WHEN PURCHASE.SUB_STATUS = '3' THEN PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE ELSE 0 END) AS FAL_SUM_AMT   --總失敗金額
              FROM ECS.PURCHASE                         --EC申購
              LEFT JOIN ECS.OFD074                      --代扣款行基本資料檔                
                ON OFD074.BANK_HQ = PURCHASE.BANK_NO
               -- 2019.11.13 ChengYu 修正資料多筆問題，連結ECS.OFD074【代扣款行基本資料檔】時增加BANK_SUB_TYPE(業務別)限制條件
               AND OFD074.BANK_SUB_TYPE = '2'           --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；5：指定扣款；6：信用卡扣款  (CTL014：098)
               AND OFD074.SEAL_TYPE = '3'               --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
             --WHERE PURCHASE.TX_DATE = TO_DATE(WALLOT_DATE,'YYYY\MM\DD')
             WHERE PURCHASE.TX_DATE = WALLOT_DATE
               AND PURCHASE.FUND_NO IN (SELECT VALUE1 AS FUND_ID FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ID)))
               AND (WDATA_CENTER IS NULL OR (OFD074.DATA_CENTER = WDATA_CENTER)) 
               --AND PURCHASE.TRAN_PAY_WAY = '2'        --交易付款方式  1：匯款；2：代扣款  (CTL014：109)
               --AND PURCHASE.ALLOT_CODE = '1'            --申購資料區分碼  1：單筆申購；2：轉申購；3：收益分配；4：定期定額；  5：受讓；6：合併轉入；9：調帳交易  (CTL014：106)
               --add by Silano 只抓臨櫃
               --AND PURCHASE.SYSTEM_ID = '0'             --交易途徑  0：臨櫃；1：網路；2：語音  (CTL014：107)
             GROUP BY PURCHASE.TX_DATE
                     ,OFD074.DATA_CENTER
                     ,PURCHASE.SUB_STATUS
                     --,PURCHASE.SEAL_TYPE
                     ,PURCHASE.FUND_NO
                     ,PURCHASE.CURRENCY_NO
             ORDER BY PURCHASE.TX_DATE
                     ,OFD074.DATA_CENTER
                     ,PURCHASE.FUND_NO
                     ,PURCHASE.CURRENCY_NO
           ) TEMPOFD
      LEFT JOIN FAS.FIS_BANK            --銀行總行
        ON FIS_BANK.BANK_NO = TEMPOFD.DATA_CENTER
      --一般用
      LEFT JOIN ECS.OFD074              --代扣款行基本資料檔
        ON OFD074.BANK_HQ = TEMPOFD.DATA_CENTER
       AND OFD074.BANK_SUB_TYPE = '2'   --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；5：指定扣款；6：信用卡扣款  (CTL014：098)
       AND OFD074.SEAL_TYPE = '1'       --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
       --ACH、財金用
      LEFT JOIN ECS.OFD076              --扣款代理行基本資料檔
        ON OFD076.BANK_HQ = TEMPOFD.DATA_CENTER
       AND OFD076.SEAL_TYPE = TEMPOFD.SEAL_TYPE
      LEFT JOIN FAS.FUND                --基金主檔
        ON FUND.FUND_NO = TEMPOFD.FUND_ID
      LEFT JOIN ECS.ECS_OPTION              --欄位選單資料
        ON ECS_OPTION.SOURCE_TYPE = '100'   --扣款行核印扣款方式
       AND ECS_OPTION.TEXT_VALUE = TEMPOFD.SEAL_TYPE
      LEFT JOIN FAS.CURRENCY FUND_CURRENCY  --幣別(計價幣別)
        ON FUND_CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
      LEFT JOIN FAS.CURRENCY                --幣別(交易幣別)
        ON CURRENCY.CURRENCY_NO = TEMPOFD.CURRENCY_NO
     ORDER BY TEMPOFD.SEAL_TYPE;
             --,FUND.REPORT_SEQ;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR009_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR010_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR010_GET" 
-- =============================================
-- Author:      tingting
-- Create date: 2019/07/22
-- Description: 網路申購外幣扣款明細表
-- 20190.08.02 tingting 增加傳出交易幣別欄位、調整交易序號欄位
-- =============================================
(
    WALLOT_DATE         DATE,               --申購日期
    WFUND_ID            VARCHAR2,           --基金代碼
    WDATA_CENTER_ST     VARCHAR2,           --代理扣款機構(起)
    WDATA_CENTER_END    VARCHAR2,           --代理扣款機構(迄)
    OUT_ECSR010         OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR010 FOR
    SELECT  PURCHASE.TX_DATE AS ALLOT_DATE              --申購日期
           ,OFD074.DATA_CENTER AS DATA_CENTER           --代理扣款機構
           ,FIS_BANK_DATA_CENTER.SNAME AS BANK_HQ_SHNM  --代理扣款機構簡稱
           ,'(' || PURCHASE.BANK_NO || ')' AS SUB_BANK_CODE     --扣款行  資料區分碼為"1：一般申購"，則必須存在OFD074檔中且業務別為"5：指定扣款"  資料區分碼為"4：定期定額"，則必須存在OFD074檔中且業務別為"1：小額扣款"
           ,FIS_BANK_BANK_NO.SNAME AS BANK_BRH_SHNM     --扣款機構簡稱
           ,'3' AS SEAL_TYPE                            --扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
           ,ECS_OPTION.DISPLAY_NAME AS DisplayName      --扣款方式名稱
           ,'(' || PURCHASE.FUND_NO || ')' AS FUND_ID   --基金代碼
           ,FUND.SNAME AS FUND_SH_NM                    --基金中文簡稱
           -- 20190.08.02 tingting 增加傳出交易幣別欄位、調整交易序號欄位
           ,CURRENCY.NAME AS CURRENCY                   --交易幣別
           ,CASE WHEN PURCHASE.CURRENCY_NO IN ('NTD','TWD') THEN 0 ELSE NVL(FUND.AMT_DECIMAL, 0) END DEC_LEN    --交易幣別小數位數(先抓計價幣別小數位數)
           /*
           ,CASE WHEN PURCHASE.SEAL_TYPE = '1'
                 THEN OFD075.DUE_ACC_NO
                 ELSE OFD077.DUE_ACC_NO
                 END AS DUE_ACC_NO                      --取款帳號
           */
           ,OFD077.DUE_ACC_NO AS DUE_ACC_NO             --取款帳號
           ,PURCHASE.AC_CODE AS SUB_ACCOUNT_NO          --扣款帳號
           ,PURCHASE.AMOUNT AS ALLOT_AMT                --扣款申購金額  此金額的幣別為交易幣別     --申購價金
           ,PURCHASE.SERVICE_CHARGE AS ALLOT_FEE        --申購手續費  此金額的幣別為交易幣別    --手續費
           ,PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE AS SUM_AMT    --扣款總金額  此金額的幣別為交易幣別
           ,HOLDER.ID AS ID_NO                          --受益人ID
           ,HOLDER.ACCOUNT_NO AS BF_NO                  --戶號
           ,HOLDER.NAME AS BF_NAME                      --受益人姓名
           -- 20190.08.02 tingting 增加傳出交易幣別欄位、調整交易序號欄位
           ,PURCHASE.TRADE_NO AS ALLOT_NO               --交易序號
           --,NVL(FUND.REPORT_SEQ, 0) AS REPORT_SEQ       --報表排序順序
      FROM ECS.PURCHASE                 --EC申購
      JOIN FAS.HOLDER                   --受益人基本資料
        ON HOLDER.ID = PURCHASE.ID
      LEFT JOIN FAS.FIS_BANK            --銀行總行(扣款行)
        ON FIS_BANK.BANK_NO = PURCHASE.BANK_NO
      --一般用
      LEFT JOIN ECS.OFD074              --代扣款行基本資料檔
        ON OFD074.BANK_HQ = PURCHASE.BANK_NO
       AND OFD074.BANK_SUB_TYPE = '2'   --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；5：指定扣款；6：信用卡扣款  (CTL014：098)
       AND OFD074.SEAL_TYPE = '3'       --扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
      /*
      LEFT JOIN ECS.OFD075              --代扣款行承銷基金設定檔
        ON OFD075.BANK_HQ = PURCHASE.SUB_BANK_CODE
       AND OFD075.FUND_ID = PURCHASE.FUND_ID
       AND OFD075.BANK_SUB_TYPE = OFD074.BANK_SUB_TYPE
       AND OFD075.SEAL_TYPE = OFD074.SEAL_TYPE
      */
      --ACH、財金用
      LEFT JOIN ECS.OFD076              --扣款代理行基本資料檔
        ON OFD076.BANK_HQ = OFD074.DATA_CENTER
       AND OFD076.SEAL_TYPE = OFD074.SEAL_TYPE       --扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
      LEFT JOIN ECS.OFD077              --扣款代理行入款帳號設定檔
        ON OFD077.BANK_HQ = OFD076.BANK_HQ
       AND OFD077.FUND_ID = PURCHASE.FUND_NO
       AND OFD077.SEAL_TYPE = OFD076.SEAL_TYPE
      LEFT JOIN FAS.FIS_BANK FIS_BANK_DATA_CENTER   --銀行總行(代理扣款機構)
        ON FIS_BANK_DATA_CENTER.BANK_NO = OFD074.DATA_CENTER
      LEFT JOIN FAS.FIS_BANK FIS_BANK_BANK_NO       --銀行總行(扣款機構)
        ON FIS_BANK_BANK_NO.BANK_NO = PURCHASE.BANK_NO
      LEFT JOIN FAS.FUND                --基金主檔
        ON FUND.FUND_NO = PURCHASE.FUND_NO
      LEFT JOIN FAS.CURRENCY            --幣別(交易幣別)
        ON CURRENCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
      LEFT JOIN ECS.ECS_OPTION              --欄位選單資料
        ON ECS_OPTION.SOURCE_TYPE = '100'   --扣款行核印扣款方式
       AND ECS_OPTION.TEXT_VALUE = '3'      --扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
     WHERE PURCHASE.TX_DATE = WALLOT_DATE
       AND (PURCHASE.FUND_NO IN (SELECT VALUE1 AS FUND_ID FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ID))))
       AND ((WDATA_CENTER_ST IS NULL) OR (OFD074.DATA_CENTER >= WDATA_CENTER_ST AND OFD074.DATA_CENTER <= WDATA_CENTER_END))
       --AND PURCHASE.TRAN_PAY_WAY = '2'      --交易付款方式  1：匯款；2：代扣款  (CTL014：109)
       --AND PURCHASE.ALLOT_CODE = '1'        --申購資料區分碼  1：單筆申購；2：轉申購；3：收益分配；4：定期定額；  5：受讓；6：合併轉入；9：調帳交易  (CTL014：106)
       --add by Silano 只抓臨櫃
       --AND PURCHASE.SYSTEM_ID = '0'         --交易途徑  0：臨櫃；1：網路；2：語音  (CTL014：107)
     ORDER BY PURCHASE.TX_DATE
             ,OFD074.DATA_CENTER
             --,FUND.REPORT_SEQ
             ,PURCHASE.BANK_NO;

END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR010_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR011_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR011_GET" 
-- =============================================
-- Author:      Yuanlong
-- Create date: 2019/08/05
-- Description: 網路申購外幣扣帳費查核表
-- =============================================
(
    WTX_DATE_ST             DATE,               --交易日期(起)
    WTX_DATE_ED             DATE,               --交易日期(迄)
    WDATA_CENTER_ST         VARCHAR2,           --代理扣款機構(起)
    WDATA_CENTER_ED         VARCHAR2,           --代理扣款機構(迄)
    OUT_ECSR011             OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR011 FOR
    SELECT TB1.SEAL_TYPE                                                        --核印扣款方式  2：ACH；3：財金  (CTL014：099)
          ,ECS_OPTION.DISPLAY_NAME AS SEAL_TYPE_NM                              --扣款方式簡稱
          ,TB1.DATA_CENTER                                                      --代理扣款機構  核印扣款方式為"一般"時，必須存在於OFD019檔中；核印扣款方式為"ACH或財金"，必須存在於OFD076檔中
          ,FIS_BANK.SNAME AS DATA_CENTER_NM                                     --銀行代碼
          ,TB1.FUND_NO                                                          --基金別
          ,TB1.TX_DATE                                                          --交易日期
          ,COUNT(*) AS TOT_COUNT                                                --資料筆數
          ,SUM( CASE TB1.SUB_STATUS WHEN '2' THEN 1 ELSE 0 END) AS SUS_COUNT    --扣款進度
          ,SUM( CASE TB1.SUB_STATUS WHEN '3' THEN 1 ELSE 0 END) AS FAI_COUNT    --扣款進度
          ,SUM(TB1.SUM_AMT) AS SUM_AMT                                          --扣帳手續費(總和)
          ,TB1.SUB_FEE                                                          --扣帳手續費
          ,FUND.FUND_TYPE                                                       --基金種類 B:債券型 E:股票型 A:全部1.refer to FAS.FUND_TYPE.CATEGORY = 12.目前分類，請參閱FAS.FUND_TYPE
          ,FUND.SNAME                                                           --基金簡稱
          ,FUND.AMT_DECIMAL AS DEC_LEN                                          --計價幣別小數位數
      FROM (--單筆:一般、ACH、FIS
            -- 2016.11.14 Mod By Joyce 調整程式寫法
            SELECT OFD076.SEAL_TYPE                                                        --核印扣款方式  2：ACH；3：財金  (CTL014：099)
                  ,OFD074.DATA_CENTER                                                      --代理扣款機構  核印扣款方式為"一般"時，必須存在於OFD019檔中；核印扣款方式為"ACH或財金"，必須存在於OFD076檔中
                  ,PURCHASE.FUND_NO                                                        --基金別
                  ,PURCHASE.TX_DATE                                                        --交易日期
                  ,PURCHASE.SUB_STATUS                                                     --扣款進度 0：未扣款；1：扣款中；2：扣款成功；3：扣款失敗(CTL014：117)
                  ,/*(CASE WHEN OFD220A.SEAL_TYPE = '1' THEN (CASE OFD074.SUB_CODE WHEN '1' THEN (CASE OFD220A.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                                                      WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                                                      WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                                                      ELSE 0 END)
                                                                                WHEN '2' THEN OFD221A.SUB_FEE
                                                                                ELSE 0 END) 
                        WHEN OFD220A.SEAL_TYPE IN ('2','3') THEN (CASE OFD076.SUB_CODE WHEN '1' THEN OFD076.SUB_FEE
                                                                                       WHEN '2' THEN OFD221A.SUB_FEE
                                                                                       ELSE 0 END)
                        ELSE 0 END) SUM_AMT*/
                   CASE OFD076.SUB_CODE WHEN '1' THEN OFD076.SUB_FEE                       --扣帳手續費
                                        WHEN '2' THEN PURCHASE.SERVICE_CHARGE              --手續費
                   ELSE 0 END SUM_AMT                                                          
                  ,/*(CASE WHEN OFD220A.SEAL_TYPE = '1' THEN (CASE OFD220A.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                  WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                  WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                  ELSE 0 END)
                        WHEN OFD220A.SEAL_TYPE IN ('2','3') THEN OFD076.SUB_FEE
                        ELSE 0 END) SUB_FEE*/
                   OFD076.SUB_FEE                                                          --扣帳手續費
              FROM ECS.PURCHASE                                                            --EC申購檔
              LEFT JOIN ECS.OFD074                                                         --代扣款行基本資料檔
                ON OFD074.BANK_HQ = PURCHASE.BANK_NO                                       --扣款機構代碼 代銷分公司碼
               AND OFD074.BANK_SUB_TYPE = '5'                                              --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
               AND OFD074.SEAL_TYPE = '3'                                                  --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
              LEFT JOIN ECS.OFD076                                                         --扣款代理行基本資料檔 
                ON OFD076.BANK_HQ = OFD074.DATA_CENTER                                     --代理扣款機構代碼
               AND OFD076.SEAL_TYPE = OFD074.SEAL_TYPE                                     --核印扣款方式  2：ACH；3：財金  (CTL014：099)
             WHERE (PURCHASE.SUB_STATUS = '2' OR PURCHASE.SUB_STATUS = '3')                --扣款進度 0：未扣款；1：扣款中；2：扣款成功；3：扣款失敗(CTL014：117)
               AND ((WDATA_CENTER_ST IS NULL) OR (OFD074.DATA_CENTER >= WDATA_CENTER_ST AND OFD074.DATA_CENTER <= WDATA_CENTER_ED))    --代理扣款機構代碼
               AND ((WTX_DATE_ST IS NULL) OR (PURCHASE.TX_DATE >= WTX_DATE_ST AND PURCHASE.TX_DATE <= WTX_DATE_ED))                    --交易日期
           /*  UNION ALL  
           -- 2016.11.14 Mod By Joyce 調整程式寫法           
           --單筆(EC/IVR):一般、ACH、FIS FOR 失敗的筆數及金額
           SELECT OFD620A.SEAL_TYPE
                 ,OFD620A.DATA_CENTER
                 ,OFD621A.FUND_ID
                 ,OFD621A.ALLOT_DATE
                 ,OFD621A.SUB_STATUS
                 ,(CASE WHEN OFD620A.SEAL_TYPE = '1' THEN (CASE OFD074.SUB_CODE WHEN '1' THEN (CASE OFD620A.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                                                      WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                                                      WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                                                      ELSE 0 END)
                                                                                WHEN '2' THEN 0
                                                                                ELSE 0 END)
                        WHEN OFD620A.SEAL_TYPE IN ('2','3') THEN (CASE OFD076.SUB_CODE WHEN '1' THEN OFD076.SUB_FEE
                                                                                       WHEN '2' THEN 0
                                                                                       ELSE 0 END)
                        ELSE 0 END) SUM_AMT                                     
                 ,(CASE WHEN OFD620A.SEAL_TYPE = '1' THEN (CASE OFD620A.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                  WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                  WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                  ELSE 0 END)
                        WHEN OFD620A.SEAL_TYPE IN ('2','3') THEN OFD076.SUB_FEE
                        ELSE 0 END) SUB_FEE
            FROM OFD620A 
            JOIN OFD621A ON OFD621A.EC_ALLOT_NO = OFD620A.EC_ALLOT_NO 
                        AND (OFD621A.ALLOT_DATE >= @datiALLOT_DATE_ST AND OFD621A.ALLOT_DATE <= @datiALLOT_DATE_ED )             
            LEFT JOIN OFD074 ON OFD074.BANK_HQ = dbo.f_GetBankHQ(OFD620A.SUB_BANK_CODE)
                            AND OFD074.SEAL_TYPE = OFD620A.SEAL_TYPE
                            -- 2016.11.14 MOD BY Joyce FOR EC/IVR扣款資料回串 OFD074 時,BANK_SUB_TYPE = 1,正確應為 2
                            AND OFD074.BANK_SUB_TYPE = '2'
            LEFT JOIN OFD076 ON OFD076.BANK_HQ = OFD620A.DATA_CENTER
                            AND OFD076.SEAL_TYPE = OFD620A.SEAL_TYPE
           WHERE (OFD621A.SUB_STATUS = '3')
             AND OFD620A.TRAN_PAY_WAY = '2'
             AND ((@striDATA_CENTER_ST = '') OR (OFD620A.DATA_CENTER >= @striDATA_CENTER_ST AND OFD620A.DATA_CENTER <= @striDATA_CENTER_ED))
             AND (   (OFD620A.SYSTEM_ID = '0' AND @striCABNIET = 'Y') 
                  OR (OFD620A.SYSTEM_ID = '1' AND @striEC = 'Y') 
                  OR (OFD620A.SYSTEM_ID = '2' AND @striIVR = 'Y'))
             AND @striNORMAL = '1'   
          UNION ALL
          -- 2016.11.14 Mod By Joyce 扣款行於扣款日無扣款成功資料，扣帳費用處理，調整程式寫法
          --RSP:一般、ACH、FIS:臨櫃
          SELECT  RSP008.SEAL_TYPE
                 ,RSP008.DATA_CENTER
                 ,RSP008.FUND_ID
                 ,RSP008.REAL_SUB_DATE
                 ,RSP008.SUB_STATUS
                 ,(CASE WHEN RSP008.SEAL_TYPE = '1' THEN (CASE OFD074.SUB_CODE WHEN '1' THEN (CASE RSP008.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                                                    WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                                                    WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                                                    ELSE 0 END)
                                                                               WHEN '2' THEN RSP008.BANK_SUB_FEE
                                                                               ELSE 0 END)
                        WHEN RSP008.SEAL_TYPE IN ('2','3') THEN (CASE OFD076.SUB_CODE WHEN '1' THEN OFD076.SUB_FEE
                                                                                      WHEN '2' THEN RSP008.BANK_SUB_FEE
                                                                                      ELSE 0 END)
                        ELSE 0 END) AS TOT_SUB_AMT
                 ,(CASE WHEN RSP008.SEAL_TYPE = '1' THEN (CASE RSP008.SYSTEM_ID WHEN '0' THEN OFD074.SUB_FEE 
                                                                                WHEN '1' THEN OFD074.SUB_FEE_EC 
                                                                                WHEN '2' THEN OFD074.SUB_FEE_IVR 
                                                                                ELSE 0 END)
                        WHEN RSP008.SEAL_TYPE IN ('2','3') THEN OFD076.SUB_FEE
                        ELSE 0 END) SUB_FEE
            FROM RSP008
            LEFT JOIN OFD074 ON OFD074.BANK_HQ = dbo.f_GetBankHQ(RSP008.SUB_BANK_CODE)
                            AND OFD074.SEAL_TYPE = RSP008.SEAL_TYPE
                            AND OFD074.BANK_SUB_TYPE = '1'
            LEFT JOIN OFD076 ON OFD076.BANK_HQ = RSP008.DATA_CENTER
                            AND OFD076.SEAL_TYPE = RSP008.SEAL_TYPE
           WHERE (RSP008.REAL_SUB_DATE  >= @datiALLOT_DATE_ST AND RSP008.REAL_SUB_DATE  <= @datiALLOT_DATE_ED )
             AND (RSP008.SUB_STATUS = '2' OR RSP008.SUB_STATUS = '3')
             AND ((@striDATA_CENTER_ST = '') OR (RSP008.DATA_CENTER >= @striDATA_CENTER_ST AND RSP008.DATA_CENTER <= @striDATA_CENTER_ED))
             AND ((RSP008.SYSTEM_ID = '0' AND @striCABNIET = 'Y' AND ((RSP008.SEAL_TYPE = '1' AND OFD074.FEE_PAY_ITEM = '1') OR RSP008.SEAL_TYPE IN ('2','3'))) 
                   OR (RSP008.SYSTEM_ID = '1' AND @striEC = 'Y' AND ((RSP008.SEAL_TYPE = '1' AND OFD074.FEE_PAY_ITEM_EC = '1') OR RSP008.SEAL_TYPE IN ('2','3'))) 
                   OR (RSP008.SYSTEM_ID = '2' AND @striIVR = 'Y' AND ((RSP008.SEAL_TYPE = '1' AND OFD074.FEE_PAY_ITEM_IVR = '1') OR RSP008.SEAL_TYPE IN ('2','3'))))
             AND @striRSP = '1'*/
           )TB1
      JOIN FAS.FUND                                     --基金主檔
        ON FUND.FUND_NO = TB1.FUND_NO                   --基金別
      LEFT JOIN ECS.ECS_OPTION                          --欄位選單資料
        ON ECS_OPTION.SOURCE_TYPE = '100'               --選項類別
       AND ECS_OPTION.TEXT_VALUE = TB1.SEAL_TYPE        --代碼
      LEFT JOIN FAS.FIS_BANK                            --銀行總行
        ON FIS_BANK.BANK_NO = TB1.DATA_CENTER           --銀行代碼
      --LEFT JOIN FAS.CURRENCY                            --交易幣別檔
      --  ON CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO      --幣別
     GROUP BY TB1.SEAL_TYPE
             ,ECS_OPTION.DISPLAY_NAME
             ,TB1.DATA_CENTER
             ,FIS_BANK.SNAME
             ,TB1.FUND_NO
             ,FUND.FUND_TYPE
             ,FUND.SNAME
             ,FUND.AMT_DECIMAL
             ,TB1.TX_DATE
             ,TB1.SUB_FEE;
END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR011_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_ECSR012_GET
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_ECSR012_GET" 
-- =============================================
-- Author:      Yuanlong
-- Create date: 2019/08/07
-- Description: 外幣核印費請款單
-- 2020.03.31 ChengYu 外幣核印時只有核印成功才收核印費，不論重送、失敗次數
-- 2020.04.23 ChengYu 修正代理行名稱 
-- =============================================
(
    WSUB_BANK_CODE          VARCHAR2,       --扣款(代理)行
    WTRADE_DATE             DATE,           --申請年月
    WTRADE_DATE_BK_ST       DATE,           --核印回復日期(銀行) 起
    WTRADE_DATE_BK_END      DATE,           --核印回復日期(銀行) 迄
    OUT_ECSR012             OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUT_ECSR012 FOR
    SELECT SEAL_TYPE                                                                                        --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
          ,SOURCE_CD                                                                                        --申請書來源  1：定期定額契約；2：定期定額契約變更；  3：授權約定書；4：授權約定書變更  (CTL014：236)
          ,AGENT_BANK                                                                                       --代理(扣款)銀行
          ,AGENT_SHNM                                                                                       --代理(扣款)銀行簡稱
          ,SUB_BANK_CODE                                                                                    --扣款行
          ,BANK_HQ_SHNM                                                                                     --銀行簡稱
          -- 2020.03.31 ChengYu 外幣核印時只有核印成功才收核印費，不論重送、失敗次數
          ,SUCCESS_COUNT AS COUNT_ALL -- 2017.06.21 GINA 筆數計算方式改為將「新件核印筆數、新件重核印筆數、異動件核印筆數、異動件重核印筆數」加總計算
          ,SEAL_CHK_FEE                                                                                     --核印費  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
          -- 2020.03.31 ChengYu 外幣核印時只有核印成功才收核印費，不論重送、失敗次數
          ,SUCCESS_COUNT * SEAL_CHK_FEE AS COUNT_CHK_FEE                                                    --核印費
	  FROM (SELECT OFD702.SEAL_TYPE                                                                         --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                 ,OFD702.AGENT_BANK                                                                        --代理(扣款)銀行
                 -- 2020.04.23 ChengYu 修正代理行名稱
                 ,ECS_OPTION.DISPLAY_NAME || '－' ||                                                       --選單
                        /*CASE WHEN OFD702.SEAL_TYPE = '1' THEN                                               --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                             CASE WHEN OFD702.SOURCE_CD IN ('1','2') THEN 'RSP契約' ELSE '授權扣款帳號' END   --申請書來源  1：定期定額契約；2：定期定額契約變更；  3：授權約定書；4：授權約定書變更  (CTL014：236)
                        ELSE*/ FIS_BANK_AGENT_BANK.SNAME                                                               --銀行簡稱
                        /*END*/ AS AGENT_SHNM                                                                      --代理(扣款)銀行簡稱
                 ,CASE WHEN OFD702.SOURCE_CD IN ('1','2') THEN '1' ELSE '0' END SOURCE_CD                  --申請書來源  1：定期定額契約；2：定期定額契約變更；  3：授權約定書；4：授權約定書變更  (CTL014：236)
		             ,OFD702.SUB_BANK_CODE                                                                     --扣款行
                 ,FIS_BANK.SNAME BANK_HQ_SHNM                                                            --銀行簡稱
                 -- 2020.03.31 ChengYu 外幣核印時只有核印成功才收核印費，不論重送、失敗次數
		             ,SUM(CASE WHEN OFD702.SEAL_STATUS = '2'
                           THEN 1 
                           ELSE 0                                        
                      END) SUCCESS_COUNT
		          ,OFD074.SEAL_CHK_FEE                                                                      --核印費  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
              FROM ECS.OFD702                                                                               --扣款帳號核印歷史記錄檔
              LEFT JOIN FAS.FIS_BANK                                                                        --銀行總行(扣款行)
                ON FIS_BANK.BANK_NO = OFD702.SUB_BANK_CODE                                                  --總行碼
              LEFT JOIN FAS.FIS_BANK FIS_BANK_AGENT_BANK                                                    --銀行總行(代理(扣款)銀行)
                ON FIS_BANK_AGENT_BANK.BANK_NO = OFD702.AGENT_BANK                                          --總行碼 
              LEFT JOIN ECS.ECS_OPTION                                                                      --欄位選單資料
                ON ECS_OPTION.SOURCE_TYPE = '100'                                                           --選項類別
               AND OFD702.SEAL_TYPE = ECS_OPTION.TEXT_VALUE                                                 --核印扣款方式 代碼
              LEFT JOIN (/*SELECT OFD074.BANK_HQ                                                            --扣款機構代碼
                               ,OFD074.BANK_SUB_TYPE                                                        --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
                               ,OFD074.SEAL_TYPE                                                            --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                               ,OFD074.SEAL_CHK_FEE                                                         --核印費  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                               ,OFD074.SEAL_FEE_ID1                                                         --新件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入
                               ,OFD074.SEAL_FEE_ID2                                                         --重新送件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入
                               ,OFD074.SEAL_FEE_ID3                                                         --異動送件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入。
                           FROM ECS.OFD074                                                                  --代扣款行基本資料檔
                          WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5')                                   --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
                            AND OFD074.SEAL_TYPE = '1'                                                      --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                          UNION 
                         SELECT OFD074.BANK_HQ                                                              --扣款機構代碼
                               ,'0' BANK_SUB_TYPE                                                           --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
                               ,OFD074.SEAL_TYPE                                                            --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                               ,MAX(OFD074.SEAL_CHK_FEE) SEAL_CHK_FEE                                       --核印費  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                               ,MAX(OFD074.SEAL_FEE_ID1) SEAL_FEE_ID1                                       --新件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入
                               ,MAX(OFD074.SEAL_FEE_ID2) SEAL_FEE_ID2                                       --重新送件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入
                               ,MAX(OFD074.SEAL_FEE_ID3) SEAL_FEE_ID3                                       --異動送件核印費  Y：收取；N：免收  (CTL014：102)  業務別不為"3：ATM匯款"及"6：信用卡"時，此欄位才可輸入。
                           FROM ECS.OFD074                                                                  --代扣款行基本資料檔
                          WHERE OFD074.SEAL_TYPE = '1'                                                      --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                          GROUP BY OFD074.BANK_HQ, OFD074.SEAL_TYPE
                          UNION*/
                         SELECT * FROM (SELECT OFD074.BANK_HQ                                                           --扣款機構代碼
                                              ,'' BANK_SUB_TYPE                                                         --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
                                              ,OFD074.SEAL_TYPE                                                         --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                                              ,MAX(NVL(OFD076.SEAL_CHK_FEE, OFD074.SEAL_CHK_FEE)) SEAL_CHK_FEE          --核印費  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                                          FROM ECS.OFD074                                                               --代扣款行基本資料檔
                                          LEFT JOIN ECS.OFD076                                                          --扣款代理行基本資料檔 
                                            ON OFD076.BANK_HQ = OFD074.DATA_CENTER                                      --代理扣款機構代碼 代理扣款機構
                                         WHERE OFD074.BANK_SUB_TYPE IN ('1','2','4','5')                                --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
                                           --AND OFD074.SEAL_TYPE IN ('2', '3')                                           --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                                         GROUP BY OFD074.BANK_HQ, OFD074.SEAL_TYPE) A
                                         ) OFD074 
                ON OFD074.BANK_HQ = OFD702.SUB_BANK_CODE                                                                --扣款機構代碼
               AND OFD074.SEAL_TYPE = OFD702.SEAL_TYPE                                                                  --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
               /*AND OFD074.BANK_SUB_TYPE = CASE WHEN OFD702.SEAL_TYPE = '1' AND OFD702.SOURCE_CD IN ('1','2') THEN '1'   --核印扣款方式 申請書來源
                                               WHEN OFD702.SEAL_TYPE = '1' AND OFD702.SOURCE_CD IN ('3','4') THEN       --核印扣款方式 申請書來源
                                               CASE OFD702.ACC_SUB_ID WHEN '4' THEN '5'                                 --帳號用途碼  0：全方位帳號；1：贖回匯入帳號；2：EC扣款帳號；  3：IVR扣款帳號；4：指定扣款帳號  (CTL014：149)
                                                                      WHEN '2' THEN '2' 
                                                                      WHEN '3' THEN '4' 
                                                                      ELSE '0' END
                                          ELSE OFD074.BANK_SUB_TYPE END*/                                                 --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)
              JOIN (SELECT DISTINCT 
                           BANK_HQ                                                                                      --扣款機構代碼
                          ,DATA_CENTER                                                                                  --代理扣款機構  核印扣款方式為"一般"時，必須存在於OFD019檔中；核印扣款方式為"ACH或財金"，必須存在於OFD076檔中
                          ,SEAL_TYPE                                                                                    --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
                      FROM ECS.OFD074                                                                                   --代扣款行基本資料檔
                     WHERE OFD074.BANK_SUB_TYPE IN('1','2','4','5')                                                     --業務別  1：小額扣款；2：EC扣款；3：ATM匯款；4：IVR扣款；  5：指定扣款；6：信用卡扣款  (CTL014：098)		 
                    ) OFD074_2 
                ON (WSUB_BANK_CODE IS NULL OR OFD074_2.DATA_CENTER = WSUB_BANK_CODE)                                    --代理扣款機構  核印扣款方式為"一般"時，必須存在於OFD019檔中；核印扣款方式為"ACH或財金"，必須存在於OFD076檔中
               AND OFD074_2.BANK_HQ = OFD702.SUB_BANK_CODE                                                              --扣款行 扣款機構代碼
               AND OFD074_2.SEAL_TYPE = OFD702.SEAL_TYPE										                        --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
             WHERE OFD702.TRADE_TYPE = '1'                                                                              --交易類別  0：送核；1：回覆  (CTL014：233)
               AND TO_CHAR(OFD702.TRADE_DATE, 'yyyy') =  TO_CHAR(WTRADE_DATE, 'yyyy')                                   --交易日期(年)  送核日期或回覆日期
               AND TO_CHAR(OFD702.TRADE_DATE, 'mm') = TO_CHAR(WTRADE_DATE, 'mm')                                        --交易日期(月)  送核日期或回覆日期
               AND OFD702.SEAL_TYPE = '3'                                                                               --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)  業務別不為"ATM匯款"及"信用卡"時，此欄位才可輸入。
             --AND (ECS.OFD702.AGENT_BANK = @striSUB_BANK_CODE OR @striSUB_BANK_CODE = '')
               AND ((OFD702.SEAL_TYPE IN ('2','3') AND OFD702.SEAL_STATUS = '2') /*OR OFD702.SEAL_TYPE = '1'*/)             --核印扣款方式 核印狀態
                -- 2017.08.09 ChengYu 新增 核印回覆日期(銀行)條件
               AND ((OFD702.TRADE_DATE_BK BETWEEN WTRADE_DATE_BK_ST AND WTRADE_DATE_BK_END) OR WTRADE_DATE_BK_ST = TO_DATE('1900/01/01', 'yyyy/mm/dd'))   --核印回覆日期(銀行) 
             GROUP BY OFD702.SEAL_TYPE
                     ,OFD702.AGENT_BANK
                     ,FIS_BANK_AGENT_BANK.SNAME
                     ,OFD702.SUB_BANK_CODE
                     ,FIS_BANK.SNAME
                     ,CASE WHEN OFD702.SOURCE_CD IN ('1','2') THEN '1' ELSE '0' END
                     -- 2020.04.23 ChengYu 修正代理行名稱
                     ,ECS_OPTION.DISPLAY_NAME || '－' ||
                        /*CASE WHEN OFD702.SEAL_TYPE = '1' THEN
                             CASE WHEN OFD702.SOURCE_CD IN ('1','2') THEN 'RSP契約' ELSE '授權扣款帳號' END
                        ELSE*/ FIS_BANK_AGENT_BANK.SNAME /*END*/     
                     ,OFD074.SEAL_CHK_FEE
           ) TB
     ORDER BY SEAL_TYPE
             ,SOURCE_CD
             ,SUB_BANK_CODE;
END;

/

  GRANT EXECUTE ON "ECS"."S_ECSR012_GET" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_EC_LOGIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_EC_LOGIN" 
(
     WID       VARCHAR2             -- ID
    ,WIP_A     VARCHAR2             -- IP位址(A)
    ,WIP_B     VARCHAR2             -- IP位址(B)
    ,WIP_C     VARCHAR2             -- IP位址(C)
    ,WIP_D     VARCHAR2             -- IP位址(D)
    ,WLOGIN    VARCHAR2             -- 密碼驗證是否正確 Y：是　N：否
    
) IS

XSYS_DTTM   DATE:= SYSDATE; -- 系統日期時間
XCNT        INT;


BEGIN

  BEGIN

	   SELECT COUNT(1) 
      INTO XCNT
      FROM ECS.LOGIN 
     WHERE ID = WID;

      IF XCNT > 0 THEN 

        UPDATE ECS.LOGIN
           SET  LOGIN_FAILED = CASE WHEN WLOGIN = 'Y' THEN 0 ELSE LOGIN_FAILED + 1 END  
               ,LAST_LOGIN = XSYS_DTTM
               ,IP_A = WIP_A
               ,IP_B = WIP_B
               ,IP_C = WIP_C
               ,IP_D = WIP_D
         WHERE ID = WID;

      ELSE 

        INSERT INTO ECS.LOGIN
            ( 
                ID
               ,LOGIN_FAILED
               ,LAST_LOGIN
               ,IP_A
               ,IP_B
               ,IP_C
               ,IP_D
            )
        SELECT  WID                             -- ID
               ,CASE WHEN WLOGIN = 'Y' THEN 0    
                     ELSE 1                      
                 END AS LOGIN_FAILED            -- 登入失敗次數
               ,XSYS_DTTM AS LAST_LOGIN         -- 最後登錄時間
               ,WIP_A                           -- IP A
               ,WIP_B                           -- IP B
               ,WIP_C                           -- IP C
               ,WIP_D                           -- IP D
          FROM DUAL;

      END IF;

    END;

    INSERT INTO ECS.LOGIN_LOG
           ( 
              ID
             ,STATUS
             ,LOG_TIME
             ,IP_A
             ,IP_B
             ,IP_C
             ,IP_D
           )
      SELECT  WID                             -- ID
             ,CASE WHEN WLOGIN = 'Y' THEN 'S'    
                   ELSE 'F'                      
               END AS STATUS                  -- 登入狀態(S:成功/F:失敗)
             ,XSYS_DTTM AS LOG_TIME           -- 登入時間
             ,WIP_A                           -- IP A
             ,WIP_B                           -- IP B
             ,WIP_C                           -- IP C
             ,WIP_D                           -- IP D
        FROM DUAL;



END s_EC_Login;

/

  GRANT EXECUTE ON "ECS"."S_EC_LOGIN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_FORCEACCKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_FORCEACCKEY" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/08/28
-- Description: 強制變更密碼
-- 2018.09.02 JIANXIN MOD 將密碼鎖定清除
-- =============================================
(
     WID                    VARCHAR2                -- 登入帳號
) IS
BEGIN

    BEGIN

        -- 清除密碼鎖定
        UPDATE ECS.LOGIN
           SET LOGIN_FAILED = 0
         WHERE ID = WID;

        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            ROLLBACK;
            Raise_application_error(-20000, '更新失敗');

    END;
END s_ForceAccKey;

/

  GRANT EXECUTE ON "ECS"."S_FORCEACCKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETALLOTFEETYPELIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETALLOTFEETYPELIST" 
-- =============================================
-- Author     : PAN
-- Create date: 2018/08/09
-- Description: API038 取得購物車手續費收取方式
-- 2018.08.28 JIANXIN 若沒有紅利則以0處理，回傳至前端必須要有紅利點數才回傳
-- 2018.09.19 JIANXIN 暫時移除優惠券的選項
-- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
-- 2018.10.02 JIANXIN 調整「網路優惠費率」名稱改為「網路費率」
-- 2018.10.19 JIANXIN 促銷活動顯示條件調整
-- 2018.11.01 JIANXIN 調整紅利積點計算方式
-- 2018.11.07 tingting 調整紅利折抵，在取預扣點數的取法
-- 2020.01.09 ChengYu 解開優惠券的選項
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- =============================================
(
    WACCOUNT_NO               INTEGER,                 -- 受益人戶號 --171619 A101202303 / 171625  G110220333
    WSHOPLIST                 VARCHAR2,                -- 傳入字串 ShopList(SHOP_TYPE;FUND_NO;TX_CURRENCY_NO;TX_DATE)
                                                       --                  (購物車類別;基金代碼;交易幣別;交易日期)
                                                       --          範例    (1;M14;NTD;20180806,1;M25;NTD;20180806)
                                                       --          範例    (2;M14;NTD;20180806,3;M25;NTD;20180806)
    OUTDT                     OUT SYS_REFCURSOR,       -- 傳出TABLE ShopList(購物車手續費收取方式)
    OUTDT2                    OUT SYS_REFCURSOR,       -- 傳出TABLE CouponList(該客戶持有的優惠券代碼列表)
    OUTDT3                    OUT SYS_REFCURSOR        -- 傳出TABLE CampaignCrncyList(促銷活動優惠幣別設定列表)
) IS
  --變數
  XID           FAS.HOLDER.ID%TYPE;
  XBIRTH_DATE   FAS.HOLDER.BIRTH_DATE%TYPE;

BEGIN
    BEGIN
        --取得 ID / 出生日期
        SELECT ID,BIRTH_DATE
          INTO XID,XBIRTH_DATE
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000,'無法取得受益人ID，請檢查！');
    END;

    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    --牌告手續費率
    SELECT  FUND_LIST.SHOP_TYPE AS SHOP_TYPE --購物車類別
           ,FUND_LIST.FUND_NO                --基金代碼
           ,'' AS FEE_CHOICE                 --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           -- 2018.10.02 JIANXIN 調整「網路優惠費率」名稱改為「網路費率」
           ,'網路費率' AS PROJECT_NAME       --促銷活動名稱
           ,CASE WHEN FUND_LIST.SHOP_TYPE = '1' THEN ECS_PURCHASE ELSE ECS_RSP END AS SC_RATE  --優惠手續費率
           ,0 AS USED_POINT                  --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,SALES_CHARGE.AMOUNT              --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,9 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT , CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')) SALES_CHARGE
      CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                    FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                 ) FUND_LIST
      WHERE FUND_LIST.FUND_NO = SALES_CHARGE.FUND_NO
        AND FUND_LIST.TX_CURRENCY_NO = SALES_CHARGE.CURRENCY_NO
    -- 2018.09.19 JIANXIN 暫時移除優惠券的選項
    -- 2020.01.09 ChengYu 解開優惠券的選項
    UNION
    --2：優惠券 : 一律給予此項目,由投資人填寫 優惠券代碼
    SELECT  FUND_LIST.SHOP_TYPE              --購物車類別
           ,FUND_LIST.FUND_NO                --基金代碼
           ,'2' AS FEE_CHOICE                --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           ,'優惠券' AS PROJECT_NAME         --促銷活動名稱
           ,0 AS SC_RATE                     --優惠手續費率
           ,0 AS USED_POINT                  --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,999999999999 AS AMOUNT           --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,3 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO ,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
              FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
           ) FUND_LIST
    UNION
    --3：紅利折抵 : 若客戶帳上仍有紅利點數,則給予此項目,由投資人填寫 紅利點數
    SELECT  FUND_LIST.SHOP_TYPE              --購物車類別
           ,FUND_LIST.FUND_NO                --基金代碼
           ,'3' AS FEE_CHOICE                --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           ,'紅利折抵' AS PROJECT_NAME       --促銷活動名稱
           ,S.ECS_PURCHASE AS SC_RATE        --優惠手續費率\此為牌告費率
           ,REWARD_POINT.USED_POINT          --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,S.AMOUNT                         --申購金額上限\此為牌告費率金額
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,2 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (
            -- ===========2018.11.01 JIANXIN 調整紅利積點計算方式 BNG===========
            -- 2018.08.28 JIANXIN 若沒有紅利則以0處理，回傳至前端必須要有紅利點數才回傳
            -- 2018.11.07 tingting 調整紅利折抵，在取預扣點數的取法
            SELECT SUM(REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0)) AS USED_POINT     --可使用點數(紅利點數 - 使用點數 - 預扣點數)
              FROM FAS.REWARD_POINT
              LEFT JOIN (
                        -- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
                        --還沒真正被使用的預扣點數
                        SELECT  REWARD_POINT.REWARD_NO
                               ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
                          FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
                          JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
                            ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
                           AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
                          JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
                            ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
                         WHERE REWARD_HISTORY.ID = XID
                           AND REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
                         GROUP BY REWARD_POINT.REWARD_NO
                         ORDER BY REWARD_POINT.REWARD_NO
                        ) REWARD_POINT_W         --紅利配發資料(預扣)
                ON REWARD_POINT_W.REWARD_NO = REWARD_POINT.REWARD_NO
             CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                           FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                        ) TRADE_LIST
             WHERE To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
               AND REWARD_POINT.ID  = XID
               AND REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) > 0
            -- ===========2018.11.01 JIANXIN 調整紅利積點計算方式 END===========
            ) REWARD_POINT
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO ,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) FUND_LIST
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = FUND_LIST.FUND_NO   
     WHERE FUND_LIST.SHOP_TYPE  = '1'  --僅提供單筆申購
    -- 2018.08.28 JIANXIN 若沒有紅利則以0處理，回傳至前端必須要有紅利點數才回傳
       AND REWARD_POINT.USED_POINT > 0
    UNION
    --5：生日優惠
    SELECT  FUND_LIST.SHOP_TYPE                     --購物車類別
           ,FUND_LIST.FUND_NO                       --基金代碼
           ,'5' AS FEE_CHOICE                       --優惠方案
           ,CAMPAIGN.CAMPAIGN_CODE AS PROJECT_CODE  --促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME  --促銷活動名稱
           ,CAMPAIGN.FIXED_RATE AS SC_RATE          --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO                --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,CAMPAIGN.CAMPAIGN_BNG_DATE              --活動起始日期
           ,CAMPAIGN.CAMPAIGN_END_DATE              --活動終止日期
           ,1 DATA_ORDER                            --排序
           ,'' AS CAMPAIGN_TYPE                     --促銷類別
      FROM ECS.CAMPAIGN
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO ,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) FUND_LIST
     WHERE FUND_LIST.SHOP_TYPE  = '1'  --僅提供單筆申購
       AND CAMPAIGN.CAMPAIGN_TYPE = 'B'
       AND CAMPAIGN.PROMT_TYPE = '2'  -- 壽星優惠
       AND TO_CHAR(XBIRTH_DATE,'MM') = TO_CHAR(To_Date(FUND_LIST.TX_DATE,'yyyymmdd'),'MM');

    --促銷活動(B：基本 AA：申購特定金額  AD：特定日期) : 所有基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND( CASE T.SHOP_TYPE WHEN '1' THEN S.ECS_PURCHASE ELSE S.ECS_RSP END * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
     CROSS JOIN FAS.FUND C
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '1'  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (T.SHOP_TYPE = '1' AND INSTR(A.PROMT_ITEM,'1',1,1) > 0 ) 
            OR (T.SHOP_TYPE IN ('2','3') AND INSTR(A.PROMT_ITEM,'3',1,1) > 0 )
           )
       AND A.CAMPAIGN_TYPE IN('B','AA','AD')  --促銷類別\B：基本 AA：申購特定金額  AD：特定日期
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       --指定下單日期
       AND CASE WHEN A.CAMPAIGN_TYPE IN('B','AA') THEN 'T'  
                WHEN A.CAMPAIGN_TYPE = 'AD' AND TO_CHAR(SYSDATE,'DD') = A.ORDER_DATE THEN 'T'
                ELSE 'F'
           END = 'T'
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --促銷活動(B：基本 AA：申購特定金額  AD：特定日期) : 基金種類
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
      (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND( CASE T.SHOP_TYPE WHEN '1' THEN S.ECS_PURCHASE ELSE S.ECS_RSP END * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_CATEGORY = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '2'
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (T.SHOP_TYPE = '1' AND INSTR(A.PROMT_ITEM,'1',1,1) > 0 ) 
            OR (T.SHOP_TYPE IN ('2','3') AND INSTR(A.PROMT_ITEM,'3',1,1) > 0 )
           )
       AND A.CAMPAIGN_TYPE IN('B','AA','AD')  --促銷類別\B：基本 AA：申購特定金額  AD：特定日期
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       --指定下單日期
       AND CASE WHEN A.CAMPAIGN_TYPE IN('B','AA') THEN 'T'  
                WHEN A.CAMPAIGN_TYPE = 'AD' AND TO_CHAR(SYSDATE,'DD') = A.ORDER_DATE THEN 'T'
                ELSE 'F'
           END = 'T'
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --促銷活動(B：基本 AA：申購特定金額  AD：特定日期) : 基金公司
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
      (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND( CASE T.SHOP_TYPE WHEN '1' THEN S.ECS_PURCHASE ELSE S.ECS_RSP END * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.AMC_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '3'
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (T.SHOP_TYPE = '1' AND INSTR(A.PROMT_ITEM,'1',1,1) > 0 ) 
              OR (T.SHOP_TYPE IN ('2','3') AND INSTR(A.PROMT_ITEM,'3',1,1) > 0 )
             )
       AND A.CAMPAIGN_TYPE IN('B','AA','AD')  --促銷類別\B：基本 AA：申購特定金額  AD：特定日期
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       --指定下單日期
       AND CASE WHEN A.CAMPAIGN_TYPE IN('B','AA') THEN 'T'  
                WHEN A.CAMPAIGN_TYPE = 'AD' AND TO_CHAR(SYSDATE,'DD') = A.ORDER_DATE THEN 'T'
                ELSE 'F'
           END = 'T'
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --促銷活動(B：基本 AA：申購特定金額  AD：特定日期) : 系列主基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND( CASE T.SHOP_TYPE WHEN '1' THEN S.ECS_PURCHASE ELSE S.ECS_RSP END * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_MASTER_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '4'
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (T.SHOP_TYPE = '1' AND INSTR(A.PROMT_ITEM,'1',1,1) > 0 ) 
            OR (T.SHOP_TYPE IN ('2','3') AND INSTR(A.PROMT_ITEM,'3',1,1) > 0 )
           )
       AND A.CAMPAIGN_TYPE IN('B','AA','AD')  --促銷類別\B：基本 AA：申購特定金額  AD：特定日期
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       --指定下單日期
       AND CASE WHEN A.CAMPAIGN_TYPE IN('B','AA') THEN 'T'  
                WHEN A.CAMPAIGN_TYPE = 'AD' AND TO_CHAR(SYSDATE,'DD') = A.ORDER_DATE THEN 'T'
                ELSE 'F'
           END = 'T'
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --促銷活動(B：基本 AA：申購特定金額  AD：特定日期) : 個別基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND( CASE T.SHOP_TYPE WHEN '1' THEN S.ECS_PURCHASE ELSE S.ECS_RSP END * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_PURCHASE , ECS_RSP , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '5'
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (T.SHOP_TYPE = '1' AND INSTR(A.PROMT_ITEM,'1',1,1) > 0 ) 
              OR (T.SHOP_TYPE IN ('2','3') AND INSTR(A.PROMT_ITEM,'3',1,1) > 0 )
             )
       AND A.CAMPAIGN_TYPE IN('B','AA','AD')  --促銷類別\B：基本 AA：申購特定金額  AD：特定日期
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       --指定下單日期
       AND CASE WHEN A.CAMPAIGN_TYPE IN('B','AA') THEN 'T'  
                WHEN A.CAMPAIGN_TYPE = 'AD' AND TO_CHAR(SYSDATE,'DD') = A.ORDER_DATE THEN 'T'
                ELSE 'F'
           END = 'T'
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ) ;

    --(不)定額促銷活動(RT：(不)定額特定次數) : 所有基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,T.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           ,S.FIXED_RATE AS SC_RATE                 --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 <> '1' -- 定期(不)定額
                ) T
      JOIN (SELECT CAMPAIGN_CODE,FIXED_RATE
              FROM ECS.CAMPAIGN_RSP_TIME
             WHERE DISC_TIMES_BNG = 0
           ) S
        ON S.CAMPAIGN_CODE = A.CAMPAIGN_CODE   
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '1'
       AND A.CAMPAIGN_TYPE IN('RT')           --促銷類別\RT：(不)定額特定次數
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'3',1,1) > 0    --活動項目\3：定期(不)定額
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd');

    --(不)定額促銷活動(RT：(不)定額特定次數) : 基金種類
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,T.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           ,S.FIXED_RATE AS SC_RATE                 --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_CATEGORY = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 <> '1' -- 定期(不)定額
                ) T
      JOIN (SELECT CAMPAIGN_CODE,FIXED_RATE
              FROM ECS.CAMPAIGN_RSP_TIME
             WHERE DISC_TIMES_BNG = 0
           ) S
        ON S.CAMPAIGN_CODE = A.CAMPAIGN_CODE   
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '2'
       AND A.CAMPAIGN_TYPE IN('RT')           --促銷類別\RT：(不)定額特定次數
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'3',1,1) > 0    --活動項目\3：定期(不)定額
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO;

    --(不)定額促銷活動(RT：(不)定額特定次數) : 基金公司
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,T.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           ,S.FIXED_RATE AS SC_RATE                 --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.AMC_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 <> '1' -- 定期(不)定額
                ) T
      JOIN (SELECT CAMPAIGN_CODE,FIXED_RATE
              FROM ECS.CAMPAIGN_RSP_TIME
             WHERE DISC_TIMES_BNG = 0
           ) S
        ON S.CAMPAIGN_CODE = A.CAMPAIGN_CODE   
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '3'
       AND A.CAMPAIGN_TYPE IN('RT')           --促銷類別\RT：(不)定額特定次數
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'3',1,1) > 0    --活動項目\3：定期(不)定額
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO;

    --(不)定額促銷活動(RT：(不)定額特定次數) : 系列主基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,T.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           ,S.FIXED_RATE AS SC_RATE                 --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_MASTER_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 <> '1' -- 定期(不)定額
                ) T
      JOIN (SELECT CAMPAIGN_CODE,FIXED_RATE
              FROM ECS.CAMPAIGN_RSP_TIME
             WHERE DISC_TIMES_BNG = 0
           ) S
        ON S.CAMPAIGN_CODE = A.CAMPAIGN_CODE   
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '4'
       AND A.CAMPAIGN_TYPE IN('RT')           --促銷類別\RT：(不)定額特定次數
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'3',1,1) > 0    --活動項目\3：定期(不)定額
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO ; 


    --(不)定額促銷活動(RT：(不)定額特定次數) : 個別基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,T.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           ,S.FIXED_RATE AS SC_RATE                 --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_NO = D.FUND_TYPE_DTL
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 <> '1' -- 定期(不)定額
                ) T
      JOIN (SELECT CAMPAIGN_CODE,FIXED_RATE
              FROM ECS.CAMPAIGN_RSP_TIME
             WHERE DISC_TIMES_BNG = 0
           ) S
        ON S.CAMPAIGN_CODE = A.CAMPAIGN_CODE   
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '5'
       AND A.CAMPAIGN_TYPE IN('RT')           --促銷類別\RT：(不)定額特定次數
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'3',1,1) > 0    --活動項目\3：定期(不)定額
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.TX_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.TX_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO;  

    --回傳資料
    -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
    OPEN OUTDT FOR
    SELECT SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,CAMPAIGN_TYPE,DATA_ORDER
      FROM ECS.CAMPAIGN_LIST_TEMP;

    OPEN OUTDT2 FOR
    SELECT  '1' AS SHOP_TYPE --購物車類別 單筆申購
           ,COUPON_ID        --優惠券代碼
      FROM ECS.COUPON_DATA
     CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 = '1'  
                 ) TRADE_LIST
     WHERE ID = XID
       AND IS_EFFECT = 'Y'  --必須是有效
        --在有效日期內
       AND To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
       AND INSTR(TX_TYPE,'1',1,1) > 0 
    UNION   
    SELECT  '2' AS SHOP_TYPE --購物車類別 定期定額
           ,COUPON_ID        --優惠券代碼
      FROM ECS.COUPON_DATA
     CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 = '2'  
                 ) TRADE_LIST
     WHERE ID = XID
       AND IS_EFFECT = 'Y'  --必須是有效
        --在有效日期內
       AND To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
       AND INSTR(TX_TYPE,'3',1,1) > 0 
    UNION   
    SELECT  '3' AS SHOP_TYPE --購物車類別 定期不定額
           ,COUPON_ID        --優惠券代碼
      FROM ECS.COUPON_DATA
     CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                  WHERE VALUE1 = '3'  
                 ) TRADE_LIST
     WHERE ID = XID
       AND IS_EFFECT = 'Y'  --必須是有效
        --在有效日期內
       AND To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
       AND INSTR(TX_TYPE,'3',1,1) > 0; 

    OPEN OUTDT3 FOR
    SELECT DISTINCT B.SHOP_TYPE,A.CAMPAIGN_CODE AS PROJECT_CODE,A.CURRENCY_CD AS CURRENCY_NO,A.LIMIT_AMT
      FROM ECS.CAMPAIGN_CRNCY A
      JOIN ECS.CAMPAIGN_LIST_TEMP B
        ON A.CAMPAIGN_CODE = B.PROJECT_CODE
       AND B.FEE_CHOICE = '1'       --優惠方案\1：促銷活動 
       AND B.CAMPAIGN_TYPE = 'AA';  --促銷類別\AA：申購特定金額

    DELETE FROM ECS.CAMPAIGN_LIST_TEMP;

END s_GetAllotFeeTypeList;

/

  GRANT EXECUTE ON "ECS"."S_GETALLOTFEETYPELIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETALLOTFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETALLOTFUNDDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/05/22
-- Description: 取得購物車申購基金列表
-- 2018.05.23 Jim 新增IS_KYC_RSP
-- 2018.07.25 JIANXIN 調整語法寫法
-- 2018.08.01 yunchu 調整幣別改取V_TX_CURRENCY
-- 2018.09.05 YungLong 新增傳出欄位：INVESTMENT_TYPE、INVESTMENT_TYPE_NAME、AREA_TYPE、AREA_NAME
-- 2018.09.19 tingting 增加傳出欄位：EC_DRSP_NEW是否開放新委託網路定期不定額交易
-- 2018.09.28 ChengYu 調整 是否重新填寫KYC
-- 2018.10.03 JIANXIN 風險等級由Function 取得
-- 2018.10.23 JIANXIN 效能調整
-- 2019.03.15 tingting 增加傳出欄位：IS_INVEST_RISK目標到期投資風險預告書
-- 2020.05.07 JAINXIN 增加傳出欄位：IS_INVEST_RISK目標到期投資風險預告書 FUND_SET 增加 10
-- =============================================
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WFUND_NO               VARCHAR,           -- 基金代碼(以 D1,D2,D3...)
     OUTDT                  OUT SYS_REFCURSOR, -- 基金列表
     OUTDT2                 OUT SYS_REFCURSOR  -- 可申購幣別列表
) IS

XID VARCHAR2(10);           -- 受益人ID
XRISK_LEVEL VARCHAR2(1);    -- 客戶風險屬性
XSYS_DATE DATE:=TRUNC(SYSDATE);

BEGIN

  --取得受益人ID、客戶風險屬性(RISK_LEVEL)
  BEGIN

    SELECT ID 
           ,RISK_LEVEL
           INTO 
           XID
           ,XRISK_LEVEL
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

  END;  

  --BEGIN

  --     2018.10.23 JIANXIN 效能調整
  --    INSERT INTO ECS.NAV_DATE_TEMP
  --         (
  --            FUND_NO
  --           ,NAV_DATE
  --           ,TX_DATE
  --           ,NAV
  --           ,CHANGE
  --           ,BAL_SHARE
  --           ,NET_ASSET
  --         )
  --    SELECT B.FUND_NO
  --           ,B.NAV_DATE
  --           ,B.TX_DATE
  --           ,B.NAV
  --           ,B.CHANGE
  --           ,B.BAL_SHARE
  --           ,B.NET_ASSET
  --      FROM (SELECT FUND_NO, MAX(NAV_DATE) AS NAV_DATE
  --              FROM NAV.NAV
  --             WHERE NAV_DATE <= TRUNC(SYSDATE)
  --               AND NAV.FUND_NO IN (SELECT VALUE1 FUND_NO FROM TABLE(ECS.F_FormatStringListToTable(WFUND_NO)))
  --             GROUP BY FUND_NO) A
  --      JOIN NAV.NAV B
  --        ON A.FUND_NO = B.FUND_NO
  --       AND A.NAV_DATE = B.NAV_DATE
  --     WHERE B.FUND_NO IN (SELECT VALUE1 FUND_NO FROM TABLE(ECS.F_FormatStringListToTable(WFUND_NO)));


  --END;

    OPEN OUTDT FOR
    SELECT FUND.FUND_CATEGORY                           --境內外識別碼
           ,CASE FUND.FUND_CATEGORY                     --境內外識別碼名稱
            WHEN '1' THEN '境內'
            WHEN '2' THEN '境外'
            END FUND_CATEGORY_NAME
           ,FUND.AMC_NO                                 --基金公司代碼
           ,AMC.NAME AS AMC_NAME                        --基金公司名稱
           ,AMC.DEPOSITORY_NO                           --帳戶保管平台代號
           ,FUND.ISIN_CODE                              --國際證券代碼
           ,FUND.FUND_NO                                --基金代碼
           ,FUND.NAME AS FUND_NAME                      --基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO             --基金警語
           ,FUND.SHARE_CLASS                            --基金級別
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME   --基金級別名稱
           ,FUND.CURRENCY_NO                            --計價幣別
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME          --計價幣別名稱
           ,FUND.RISK_CATEGORY                          --風險屬性
           -- 2018.09.04 YungLong 新增傳出欄位INVESTMENT_TYPE、INVESTMENT_TYPE_NAME、AREA_TYPE、AREA_NAME
           ,FUND.INVESTMENT_TYPE                        --投資類型
           ,INVESTMENT_TYPE.NAME AS INVESTMENT_TYPE_NAME--投資類型欄位
           ,FUND.AREA_TYPE                              --基金投資區域
           ,FUND_AREA.DESCRIPTION AS AREA_NAME          --基金投資區域資料
           ,FUND.IS_EC_PURCHASE                         --是否開放網路申購
           ,FUND.EC_RSP_NEW                             --是否開放新委託網路定期定額交易
           -- 2018.09.19 tingting 增加傳出欄位：EC_DRSP_NEW是否開放新委託網路定期不定額交易
           ,FUND.EC_DRSP_NEW                            --是否開放新委託網路定期不定額交易
           ,CASE WHEN RISK_LEVEL_ALLOT.RISK_CATEGORY IS NOT NULL THEN 'Y'
                 ELSE 'N'
                 END IS_KYC                             --是否可申購
           -- 2018.05.23 Jim 新增IS_KYC_RSP
           ,CASE WHEN RISK_LEVEL_RSP.RISK_CATEGORY IS NOT NULL THEN 'Y'
                 ELSE 'N'
                 END IS_KYC_RSP                         --是否可定期定額
           -- 2018.07.25 JIANXIN 調整語法寫法
           ,NVL(DOWNLOADFUNDDOC.VALUE,'') AS DOWNLOADFUNDDOC    --公開說明書URL
           ,NVL(OFF_SHORE_CHANNEL_EXPOSE.VALUE,'') AS OFF_SHORE_CHANNEL_EXPOSE  --通路報酬揭露URL
           ,NVL(DOWNLOADINVESTORNOTICE.VALUE,'') AS DOWNLOADINVESTORNOTICE      --投資人須知URL
           ,XRISK_LEVEL AS RISK_LEVEL                                   --客戶風險屬性
           -- 2018.09.28 ChengYu 調整 是否重新填寫KYC
           ,CASE WHEN (HOLDER.RISK_STATUS = '1' AND TO_DATE(TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') > HOLDER.RISK_MAT_DATE) THEN 'Y'    --2．判斷投資人KYC 是否已過期; A.若FAS.HOLDER.RISK_STATUS = 1.已交付 且 系統日期 大於 KYC 到期日期(FAS.HOLDER.RISK_MAT_DATE)
                 WHEN (HOLDER.RISK_STATUS = '3' AND TO_DATE(TO_CHAR(SYSDATE,'YYYYMMDD'),'YYYYMMDD') > HOLDER.RISK_MAT_DATE) THEN 'Y'   --2．判斷投資人KYC 是否已過期; B.若FAS.HOLDER.RISK_STATUS = 3.其他文件 且 系統日期 大於 KYC 到期日期(FAS.HOLDER.RISK_MAT_DATE)'Y' AS IS_WRITE_KYC
                 ELSE 'N'
                 END AS IS_WRITE_KYC                                    --需重填投資適性分析表
           -- 2019.03.15 tingting 增加傳出欄位：IS_INVEST_RISK目標到期投資風險預告書
           -- 2020.05.07 JAINXIN 增加傳出欄位：IS_INVEST_RISK目標到期投資風險預告書 FUND_SET 增加 10
           ,CASE WHEN FUND.FUND_SET IN ('17','10') THEN 'Y' ELSE 'N' END AS IS_INVEST_RISK  --目標到期投資風險預告書 (17:Target Maturity)
           ,FUND.SHARE_DECIMAL                                          --單位數小數位數
           ,FUND.NAV_DECIMAL                                            --淨值小數位數
           ,FUND.AMT_DECIMAL                                            --計價幣別小數位數
           -- 2018.10.23 JIANXIN 效能調整
           ,'Y' AS IS_SUCCESS                                           --執行成功否
           ,' ' AS WARNS_TYPE                                           --警示方式
           ,' ' AS ERROR_MSG                                            --錯誤訊息
           ,CASE WHEN NAV.FUND_NO IS NOT NULL THEN NAV_DATE 
                 ELSE (SELECT NAV_DATE FROM NAV.NAV
                        WHERE NAV.FUND_NO = FUND.FUND_NO
                          AND NAV_DATE = (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = FUND.FUND_NO AND NAV_DATE <= XSYS_DATE))
                 END NAV_DATE
           ,CASE WHEN NAV.FUND_NO IS NOT NULL THEN NAV.NAV 
                 ELSE (SELECT NAV FROM NAV.NAV
                        WHERE NAV.FUND_NO = FUND.FUND_NO
                          AND NAV_DATE = (SELECT MAX(NAV_DATE) FROM NAV.NAV WHERE FUND_NO = FUND.FUND_NO AND NAV_DATE <= XSYS_DATE))
                 END NAV
      FROM FAS.FUND FUND
      JOIN FAS.AMC AMC
        ON AMC.AMC_NO = FUND.AMC_NO
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ACCOUNT_NO = WACCOUNT_NO
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
       AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      -- 2018.10.03 JIANXIN 風險等級由Function 取得
      LEFT JOIN (TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('1',SYSDATE))) RISK_LEVEL_ALLOT
        ON RISK_LEVEL_ALLOT.RISK_LEVEL = XRISK_LEVEL
       AND RISK_LEVEL_ALLOT.RISK_CATEGORY = FUND.RISK_CATEGORY
      -- 2018.10.03 JIANXIN 風險等級由Function 取得
      LEFT JOIN (TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('2',SYSDATE))) RISK_LEVEL_RSP
        ON RISK_LEVEL_RSP.RISK_LEVEL = XRISK_LEVEL
       AND RISK_LEVEL_RSP.RISK_CATEGORY = FUND.RISK_CATEGORY
      -- 2018.07.25 JIANXIN 調整語法寫法
       LEFT JOIN ECS.SYSTEM_SETTINGS DOWNLOADFUNDDOC
        ON DOWNLOADFUNDDOC.NAME = 'DOWNLOADFUNDDOC'
      LEFT JOIN ECS.SYSTEM_SETTINGS OFF_SHORE_CHANNEL_EXPOSE
        ON OFF_SHORE_CHANNEL_EXPOSE.NAME = 'OFF_SHORE_CHANNEL_EXPOSE'
      LEFT JOIN ECS.SYSTEM_SETTINGS DOWNLOADINVESTORNOTICE
        ON DOWNLOADINVESTORNOTICE.NAME = 'DOWNLOADINVESTORNOTICE'
      -- 2018.09.04 YungLong 新增交集FAS.INVESTMENT_TYPE、FUND_AREA.AREA_TYPE
      JOIN FAS.INVESTMENT_TYPE INVESTMENT_TYPE
        ON INVESTMENT_TYPE.INVESTMENT_TYPE = FUND.INVESTMENT_TYPE
      JOIN FAS.FUND_AREA FUND_AREA
        ON FUND_AREA.AREA_TYPE = FUND.AREA_TYPE
      -- 2018.10.23 JIANXIN 效能調整
      LEFT JOIN NAV.NAV 
        ON NAV.FUND_NO = FUND.FUND_NO
       AND NAV.NAV_DATE = XSYS_DATE
      --LEFT JOIN ECS.NAV_DATE_TEMP NAV
      --  ON NAV.FUND_NO = FUND.FUND_NO
     -- 2018.10.23 JIANXIN 效能調整
     WHERE FUND.FUND_NO IN (SELECT VALUE1 FUND_NO FROM TABLE(ECS.F_FormatStringListToTable(WFUND_NO)));

    OPEN OUTDT2 FOR
    SELECT TX_CURRENCY.FUND_NO                              -- 基金代碼
           ,TX_CURRENCY.TRADE_CD                            -- 交易別
           ,TX_CURRENCY.CURRENCY_NO AS TX_CURRENCY_NO       -- 申購幣別
           ,V_FUND_CRNCY.NAME AS TX_CURRENCY_NAME           -- 申購幣別名稱
           ,V_FUND_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
      FROM ECS.V_TX_CURRENCY TX_CURRENCY         
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = TX_CURRENCY.CURRENCY_NO
     -- 2018.10.23 JIANXIN 效能調整
     WHERE TX_CURRENCY.FUND_NO IN (SELECT VALUE1 FUND_NO FROM TABLE(ECS.F_FormatStringListToTable(WFUND_NO)));  

END s_GetAllotFundData;

/

  GRANT EXECUTE ON "ECS"."S_GETALLOTFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETALLOTMINAMT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETALLOTMINAMT" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/09/27
-- Description: 取得預計最低申購扣款金額(含申購、定額、不定額)
-- =============================================
(
    WACCOUNT_NO         INTEGER,        -- 受益人戶號
    WSHOP_TYPE          VARCHAR2,       -- 購物車類別 1. 申購 2.定額 3.不定額
    WFUND_NO            VARCHAR2,       -- 基金代碼
    WTX_CURRENCY_NO     VARCHAR2,       -- 申購幣別
    OUTDT               OUT SYS_REFCURSOR
) IS

XID                     VARCHAR2(10);   -- 受益人ID
XIS_FIRST_ALLOT         VARCHAR2(1);    -- 是否為首次申購
XFUND_COUNT             INTEGER  := 0 ;    -- 基金代碼

BEGIN
    BEGIN
        -- 取得受益人ID
        SELECT ID
          INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END; 

        -- 取得FUND_NO判斷是否有資料 
        SELECT COUNT(FUND_NO)
          INTO XFUND_COUNT
          FROM FAS.V_ALL_REDEMPTION
         WHERE ID = XID
           AND FUND_NO = WFUND_NO;
        -- 是否為首次申購
        SELECT CASE WHEN XFUND_COUNT > 0 THEN 'N' ELSE 'Y' END
          INTO XIS_FIRST_ALLOT
          FROM DUAL;

    OPEN OUTDT FOR
        SELECT CASE WHEN WSHOP_TYPE = '1' 
                    THEN (CASE WHEN WTX_CURRENCY_NO = 'NTD'  AND XIS_FIRST_ALLOT = 'Y' THEN FUND.MIN_INITIAL_PURCHASE_NTD
                               WHEN WTX_CURRENCY_NO = 'NTD'  AND XIS_FIRST_ALLOT = 'N' THEN FUND.MIN_AMOUNT_NTD
                               WHEN WTX_CURRENCY_NO != 'NTD' AND XIS_FIRST_ALLOT = 'Y' THEN FUND.MIN_INITIAL_PURCHASE 
                               WHEN WTX_CURRENCY_NO != 'NTD' AND XIS_FIRST_ALLOT = 'N' THEN FUND.MIN_AMOUNT END)
                    ELSE (CASE WHEN WTX_CURRENCY_NO = 'NTD'  THEN FUND.EC_PERIOD_MIN_NTD 
                               WHEN WTX_CURRENCY_NO != 'NTD' THEN FUND.EC_PERIOD_MIN END) 
                    END AS AMOUNT
              ,V_FUND_CRNCY.AMT_DECIMAL AS AMT_DECIMAL
          FROM FAS.FUND FUND
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = WTX_CURRENCY_NO;

END s_GetAllotMinAmt;

/

  GRANT EXECUTE ON "ECS"."S_GETALLOTMINAMT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETAREA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETAREA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得投資區域列表
-- 2018.03.05 MOD BY JIM FOR 當IS_ALL=Y時，回傳ALL和全部
-- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
    WIS_ALL        VARCHAR2,                  -- 是否需要全部的選項
    OUTDT          OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
        SELECT FUND_AREA.* 
         FROM
          (
            -- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
            SELECT DISTINCT FUND.AREA_TYPE           --基金投資區域
                   ,FUND_AREA.DESCRIPTION            --說明
              FROM FAS.FUND
              LEFT JOIN FAS.FUND_AREA FUND_AREA
                ON FUND.AREA_TYPE = FUND_AREA.AREA_TYPE
             WHERE FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
               AND ( FUND.SALES_TYPE = '0')
               -- 2019.02.19 tingting 調整已清算基金條件語法
               AND (
                     -- 境內基金清算日期判斷 CLEAR_DATE
                     (     
                       FUND.FUND_CATEGORY = '1' 
                       AND  
                       (
                         (FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )              
                     OR
                     -- 境外基金清算日期判斷 ELIMINATION_DATE
                     (     
                       FUND.FUND_CATEGORY = '2' 
                       AND  
                       (
                         (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )
                   )
               AND (  IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
             UNION
            SELECT 'ALL'     AS AREA_TYPE
                   ,'全部'   AS DESCRIPTION
              FROM DUAL
             WHERE WIS_ALL = 'Y'
           ) FUND_AREA
         ORDER BY DECODE(FUND_AREA.AREA_TYPE,'ALL',1),FUND_AREA.AREA_TYPE;

END s_GetArea;

/

  GRANT EXECUTE ON "ECS"."S_GETAREA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBANK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBANK" 
(
    OUTDT          OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(銀行列表)
    OUTDT2         OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA(分行清單)           
) IS

BEGIN

    OPEN OUTDT FOR    
        SELECT FIS_BANK.BANK_NO                --銀行總行代碼
               ,FIS_BANK.NAME AS BANK_NM       --銀行總行名稱
               ,FIS_BANK.SNAME AS BANK_SNM     --銀行總行簡稱
               ,FIS_BANK.AC_LENGTH             --帳號長度
               -- 2018.06.15 MOD BY JIANXIN FOR 銀行判斷調整為 FIS_BANK.PAYEE_GATEWAY = 'Y' AND FIS_BANK.PAYMENT_GATEWAY = 'Y'
               ,CASE WHEN FIS_BANK.PAYEE_GATEWAY = 'Y' AND FIS_BANK.PAYMENT_GATEWAY = 'Y' THEN 'Y'      --扣款銀行否(Y/N)
                     ELSE 'N'
                 END IS_CHARGED_BANK
          FROM FAS.FIS_BANK FIS_BANK
          WHERE FIS_BANK.COUNTRY_CODE ='TW'
          ORDER BY FIS_BANK.BANK_NO;

    OPEN OUTDT2 FOR    
         SELECT FIS_BRANCH.BANK_NO              --銀行總行代碼
                ,FIS_BRANCH.BRANCH_NO           --銀行分行代碼
                ,FIS_BRANCH.NAME AS BRANCH_NM   --銀行分行名稱
                ,FIS_BRANCH.SNAME AS BRANCH_SNM --銀行分行簡稱
          FROM FAS.FIS_BRANCH FIS_BRANCH
          JOIN FAS.FIS_BANK FIS_BANK
           ON FIS_BANK.BANK_NO = FIS_BRANCH.BANK_NO
           AND FIS_BANK.COUNTRY_CODE ='TW'
          ORDER BY FIS_BRANCH.BRANCH_NO;


END s_GetBank;

/

  GRANT EXECUTE ON "ECS"."S_GETBANK" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBESTFUNDLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBESTFUNDLIST" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/31
-- Description: 取得精選基金列表
-- =============================================
(
    WACCOUNT_NO    INTEGER,                        -- 受益人戶號
    OUTDT          OUT SYS_REFCURSOR               -- 回傳的 TABLEDATA
) IS

XID       VARCHAR2(10);    -- 受益人ID
XSYS_DTTM DATE := SYSDATE; -- 系統日期時間
XDATA_NUM INTEGER;         -- 資料筆數

BEGIN

     --取得受益人ID
     BEGIN

       SELECT ID 
         INTO XID
         FROM FAS.HOLDER
        WHERE ACCOUNT_NO = WACCOUNT_NO;

       EXCEPTION
         WHEN NO_DATA_FOUND THEN
           RAISE_APPLICATION_ERROR(-20000,
                                   '無法取得受益人ID，請檢查！');

     END;  

     --找出是否有 「基金設定方式(FUND_TYPE)」=”1. 所有基金” 的資料
     SELECT COUNT(1) AS COUNT
       INTO XDATA_NUM
       FROM ECS.CAMPAIGN
       LEFT JOIN (SELECT  CAMPAIGN.CAMPAIGN_CODE
                         ,COUNT(1) AS COUNT
                    FROM ECS.CAMPAIGN
                    JOIN ECS.MARKET_GROUP MARKET_GROUP
                      ON MARKET_GROUP.ID = XID
                    JOIN ECS.CAMPAIGN_MKT CAMPAIGN_MKT
                      ON CAMPAIGN_MKT.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
                     AND CAMPAIGN_MKT.MKT_ID = MARKET_GROUP.MKT_ID
                   WHERE CAMPAIGN.PROMT_ITEM = '2'
                     AND CAMPAIGN.IS_PROMT_FUND = 'Y'
                     AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
                   GROUP BY CAMPAIGN.CAMPAIGN_CODE
                 ) CAMPAIGN_CHECK
        ON CAMPAIGN_CHECK.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL CAMPAIGN_FUNDDTL
        ON CAMPAIGN_FUNDDTL.CAMPAIGN_CODE = CASE WHEN CAMPAIGN.CAMPAIGN_OBJ = '2' AND CAMPAIGN_CHECK.COUNT = 0 THEN '' 
                                                 ELSE CAMPAIGN.CAMPAIGN_CODE
                                            END      
      WHERE CAMPAIGN.PROMT_ITEM = '2'
        AND CAMPAIGN.IS_PROMT_FUND = 'Y'
        AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
        AND CAMPAIGN_FUNDDTL.FUND_TYPE = '1';

      OPEN OUTDT FOR 
      SELECT  FUND.FUND_CATEGORY              -- 境內外識別碼
             ,CASE FUND.FUND_CATEGORY 
              WHEN '1' THEN '境內'
              WHEN '2' THEN '境外'
              END FUND_CATEGORY_NAME          -- 境內外識別碼名稱
             ,FUND.AMC_NO                     -- 基金公司代碼
             ,AMC.NAME AS AMC_NAME            -- 基金公司名稱
             ,FUND.FUND_NO                    -- 基金代碼
             ,FUND.NAME AS FUND_NAME          -- 基金名稱
             ,FUND.DIVIDEND_DESC AS FUND_MEMO -- 基金警語
             ,FUND.ISIN_CODE                  -- 國際證券代碼
             ,FUND.RISK_CATEGORY              -- 風險等級
        FROM FAS.FUND
        LEFT JOIN FAS.AMC
          ON AMC.AMC_NO = FUND.AMC_NO
       WHERE XDATA_NUM > 0        
      UNION      
      SELECT  FUND.FUND_CATEGORY              -- 境內外識別碼
             ,CASE FUND.FUND_CATEGORY 
              WHEN '1' THEN '境內'
              WHEN '2' THEN '境外'
              END FUND_CATEGORY_NAME          -- 境內外識別碼名稱
             ,FUND.AMC_NO                     -- 基金公司代碼
             ,AMC.NAME AS AMC_NAME            -- 基金公司名稱
             ,FUND.FUND_NO                    -- 基金代碼
             ,FUND.NAME                       -- 基金名稱
             ,FUND.DIVIDEND_DESC AS FUND_MEMO -- 基金警語
             ,FUND.ISIN_CODE                  -- 國際證券代碼
             ,FUND.RISK_CATEGORY              -- 風險等級
        FROM ECS.CAMPAIGN
        LEFT JOIN (SELECT  CAMPAIGN.CAMPAIGN_CODE
                          ,COUNT(1) AS COUNT
                     FROM ECS.CAMPAIGN
                     JOIN ECS.MARKET_GROUP MARKET_GROUP
                       ON MARKET_GROUP.ID = XID
                     JOIN ECS.CAMPAIGN_MKT CAMPAIGN_MKT
                       ON CAMPAIGN_MKT.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
                      AND CAMPAIGN_MKT.MKT_ID = MARKET_GROUP.MKT_ID
                    WHERE CAMPAIGN.PROMT_ITEM = '2'
                      AND CAMPAIGN.IS_PROMT_FUND = 'Y'
                      AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
                    GROUP BY CAMPAIGN.CAMPAIGN_CODE) CAMPAIGN_CHECK
         ON CAMPAIGN_CHECK.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
       JOIN ECS.CAMPAIGN_FUNDDTL CAMPAIGN_FUNDDTL
         ON CAMPAIGN_FUNDDTL.CAMPAIGN_CODE = CASE WHEN CAMPAIGN.CAMPAIGN_OBJ = '2' AND CAMPAIGN_CHECK.COUNT = 0 THEN '' 
                                                  ELSE CAMPAIGN.CAMPAIGN_CODE
                                             END
       -- 「基金設定方式(FUND_TYPE)」=”2. 基金種類”取得與「基金設定方式明細(FUND_TYPE_DTL)」相同的「基金類別(FUND_CATEGORY)」之「基金代碼FUND_NO)」
       LEFT JOIN FAS.FUND FUND
         ON FUND.FUND_CATEGORY = CAMPAIGN_FUNDDTL.FUND_TYPE_DTL      
       LEFT JOIN FAS.AMC AMC
         ON AMC.AMC_NO = FUND.AMC_NO
      WHERE CAMPAIGN.PROMT_ITEM = '2'
        AND CAMPAIGN.IS_PROMT_FUND = 'Y'
        AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
        AND CAMPAIGN_FUNDDTL.FUND_TYPE = '2'
      UNION      
      SELECT  FUND.FUND_CATEGORY              -- 境內外識別碼
             ,CASE FUND.FUND_CATEGORY 
              WHEN '1' THEN '境內'
              WHEN '2' THEN '境外'
              END FUND_CATEGORY_NAME          -- 境內外識別碼名稱
             ,FUND.AMC_NO                     -- 基金公司代碼
             ,AMC.NAME AS AMC_NAME            -- 基金公司名稱
             ,FUND.FUND_NO                    -- 基金代碼
             ,FUND.NAME                       -- 基金名稱
             ,FUND.DIVIDEND_DESC AS FUND_MEMO -- 基金警語
             ,FUND.ISIN_CODE                  -- 國際證券代碼
             ,FUND.RISK_CATEGORY              -- 風險等級
        FROM ECS.CAMPAIGN
        LEFT JOIN (SELECT  CAMPAIGN.CAMPAIGN_CODE
                          ,COUNT(1) AS COUNT
                     FROM ECS.CAMPAIGN                     
                     JOIN ECS.CAMPAIGN_MKT CAMPAIGN_MKT
                       ON CAMPAIGN_MKT.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
                     JOIN ECS.MARKET_GROUP MARKET_GROUP
                       ON MARKET_GROUP.ID = XID
                      AND CAMPAIGN_MKT.MKT_ID = MARKET_GROUP.MKT_ID
                    WHERE CAMPAIGN.PROMT_ITEM = '2'
                      AND CAMPAIGN.IS_PROMT_FUND = 'Y'
                      AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
                    GROUP BY CAMPAIGN.CAMPAIGN_CODE) CAMPAIGN_CHECK
         ON CAMPAIGN_CHECK.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
       JOIN ECS.CAMPAIGN_FUNDDTL CAMPAIGN_FUNDDTL
         ON CAMPAIGN_FUNDDTL.CAMPAIGN_CODE = CASE WHEN CAMPAIGN.CAMPAIGN_OBJ = '2' AND CAMPAIGN_CHECK.COUNT = 0 THEN '' 
                                                  ELSE CAMPAIGN.CAMPAIGN_CODE
                                             END
       -- 「基金設定方式(FUND_TYPE)」=”3. 基金公司”取得與「基金設定方式明細(FUND_TYPE_DTL)」相同的「基金經理公司(AMC_NO)」之「基金代碼FUND_NO)」
       LEFT JOIN FAS.FUND FUND
         ON FUND.AMC_NO = CAMPAIGN_FUNDDTL.FUND_TYPE_DTL      
       LEFT JOIN FAS.AMC AMC
         ON AMC.AMC_NO = FUND.AMC_NO
      WHERE CAMPAIGN.PROMT_ITEM = '2'
        AND CAMPAIGN.IS_PROMT_FUND = 'Y'
        AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
        AND CAMPAIGN_FUNDDTL.FUND_TYPE = '3'
      UNION
      SELECT  FUND.FUND_CATEGORY              -- 境內外識別碼
             ,CASE FUND.FUND_CATEGORY 
              WHEN '1' THEN '境內'
              WHEN '2' THEN '境外'
              END FUND_CATEGORY_NAME          -- 境內外識別碼名稱
             ,FUND.AMC_NO                     -- 基金公司代碼
             ,AMC.NAME AS AMC_NAME            -- 基金公司名稱
             ,FUND.FUND_NO                    -- 基金代碼
             ,FUND.NAME                       -- 基金名稱
             ,FUND.DIVIDEND_DESC AS FUND_MEMO -- 基金警語
             ,FUND.ISIN_CODE                  -- 國際證券代碼
             ,FUND.RISK_CATEGORY              -- 風險等級
        FROM ECS.CAMPAIGN
        LEFT JOIN (SELECT  CAMPAIGN.CAMPAIGN_CODE
                          ,COUNT(1) AS COUNT
                     FROM ECS.CAMPAIGN                     
                     JOIN ECS.CAMPAIGN_MKT CAMPAIGN_MKT
                       ON CAMPAIGN_MKT.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
                     JOIN ECS.MARKET_GROUP MARKET_GROUP
                       ON MARKET_GROUP.ID = XID
                      AND CAMPAIGN_MKT.MKT_ID = MARKET_GROUP.MKT_ID
                    WHERE CAMPAIGN.PROMT_ITEM = '2'
                      AND CAMPAIGN.IS_PROMT_FUND = 'Y'
                      AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
                    GROUP BY CAMPAIGN.CAMPAIGN_CODE) CAMPAIGN_CHECK
         ON CAMPAIGN_CHECK.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
       JOIN ECS.CAMPAIGN_FUNDDTL CAMPAIGN_FUNDDTL
         ON CAMPAIGN_FUNDDTL.CAMPAIGN_CODE = CASE WHEN CAMPAIGN.CAMPAIGN_OBJ = '2' AND CAMPAIGN_CHECK.COUNT = 0 THEN '' 
                                                  ELSE CAMPAIGN.CAMPAIGN_CODE
                                             END
       -- 「基金設定方式(FUND_TYPE)」=”4. 系列主基金”取得與「基金設定方式明細(FUND_TYPE_DTL)」相同的「主基金別(FUND_MASTER_NO)」之「基金代碼FUND_NO)」
       LEFT JOIN FAS.FUND FUND
         ON FUND.FUND_MASTER_NO = CAMPAIGN_FUNDDTL.FUND_TYPE_DTL      
       LEFT JOIN FAS.AMC AMC
         ON AMC.AMC_NO = FUND.AMC_NO
      WHERE CAMPAIGN.PROMT_ITEM = '2'
        AND CAMPAIGN.IS_PROMT_FUND = 'Y'
        AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
        AND CAMPAIGN_FUNDDTL.FUND_TYPE = '4'
      UNION      
      SELECT  FUND.FUND_CATEGORY              -- 境內外識別碼
             ,CASE FUND.FUND_CATEGORY 
              WHEN '1' THEN '境內'
              WHEN '2' THEN '境外'
              END FUND_CATEGORY_NAME          -- 境內外識別碼名稱
             ,FUND.AMC_NO                     -- 基金公司代碼
             ,AMC.NAME AS AMC_NAME            -- 基金公司名稱
             ,FUND.FUND_NO                    -- 基金代碼
             ,FUND.NAME                       -- 基金名稱
             ,FUND.DIVIDEND_DESC AS FUND_MEMO -- 基金警語
             ,FUND.ISIN_CODE                  -- 國際證券代碼
             ,FUND.RISK_CATEGORY              -- 風險等級
        FROM ECS.CAMPAIGN
        LEFT JOIN (SELECT  CAMPAIGN.CAMPAIGN_CODE
                          ,COUNT(1) AS COUNT
                     FROM ECS.CAMPAIGN                     
                     JOIN ECS.CAMPAIGN_MKT CAMPAIGN_MKT
                       ON CAMPAIGN_MKT.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
                     JOIN ECS.MARKET_GROUP MARKET_GROUP
                       ON MARKET_GROUP.ID = XID
                      AND CAMPAIGN_MKT.MKT_ID = MARKET_GROUP.MKT_ID
                    WHERE CAMPAIGN.PROMT_ITEM = '2'
                      AND CAMPAIGN.IS_PROMT_FUND = 'Y'
                      AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
                    GROUP BY CAMPAIGN.CAMPAIGN_CODE) CAMPAIGN_CHECK
         ON CAMPAIGN_CHECK.CAMPAIGN_CODE = CAMPAIGN.CAMPAIGN_CODE
       JOIN ECS.CAMPAIGN_FUNDDTL CAMPAIGN_FUNDDTL
         ON CAMPAIGN_FUNDDTL.CAMPAIGN_CODE = CASE WHEN CAMPAIGN.CAMPAIGN_OBJ = '2' AND CAMPAIGN_CHECK.COUNT = 0 THEN '' 
                                                  ELSE CAMPAIGN.CAMPAIGN_CODE
                                             END
       -- 「基金設定方式(FUND_TYPE)」=”5. 個別基金”取得與「基金設定方式明細(FUND_TYPE_DTL)」相同的「基金代碼FUND_NO)」之「基金代碼FUND_NO)」
       LEFT JOIN FAS.FUND FUND
         ON FUND.FUND_NO = CAMPAIGN_FUNDDTL.FUND_TYPE_DTL      
       LEFT JOIN FAS.AMC AMC
         ON AMC.AMC_NO = FUND.AMC_NO
      WHERE CAMPAIGN.PROMT_ITEM = '2'
        AND CAMPAIGN.IS_PROMT_FUND = 'Y'
        AND XSYS_DTTM BETWEEN CAMPAIGN.CAMPAIGN_BNG_DATE AND CAMPAIGN.CAMPAIGN_END_DATE
        AND CAMPAIGN_FUNDDTL.FUND_TYPE = '5';

END s_GetBestFundList;

/

  GRANT EXECUTE ON "ECS"."S_GETBESTFUNDLIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBFBASICDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBFBASICDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/03/27
-- Description: 取得受益人基本資料
-- 2018.05.25 Jim 新增EDM_ACCEPTED、NAV_EPAPER
-- 2019.06.27 JIANXIN 以防資料是 Null 預設回傳 N
-- 2019.06.28 tingting 因應NULL值會造成通知信Trim()發生錯誤，作的緊急處理，將NULL值轉成空格
-- =============================================
(
     WACCOUNT_NO    INTEGER,                 -- 戶號
     OUTDT          OUT SYS_REFCURSOR        -- 回傳的 TABLEDATA
) IS

BEGIN

    --受益人基本資料
    OPEN OUTDT FOR
    SELECT  HOLDER.ACCOUNT_NO                       -- 受益人戶號
           ,HOLDER.NAME                             -- 受益人名稱
           ,HOLDER.MOBILE_COUNTRY                   -- 行動電話-國家碼
           ,HOLDER.MOBILE                           -- 行動電話-電話碼
           -- 2019.06.28 tingting 因應NULL值會造成通知信Trim()造成錯誤，作的緊急處理，將NULL值轉成空格
           ,NVL(HOLDER.TEL_O_COUNTRY,' ') AS TEL_O_COUNTRY  -- 聯絡電話(公)-國家碼
           ,NVL(HOLDER.TEL_O_AREA,' ') AS TEL_O_AREA        -- 聯絡電話(公)-區域碼
           ,NVL(HOLDER.TEL_O_NO,' ') AS TEL_O_NO            -- 聯絡電話(公)-電話碼
           ,NVL(HOLDER.TEL_O_EXT,' ') AS TEL_O_EXT          -- 聯絡電話(公)-分機碼
           ,NVL(HOLDER.TEL_H_COUNTRY,' ') AS TEL_H_COUNTRY  -- 聯絡電話(家)-國家碼
           ,NVL(HOLDER.TEL_H_AREA,' ') AS TEL_H_AREA        -- 聯絡電話(家)-區域碼
           ,NVL(HOLDER.TEL_H_NO,' ') AS TEL_H_NO            -- 聯絡電話(家)-電話碼
           ,NVL(HOLDER.TEL_H_EXT,' ') AS TEL_H_EXT          -- 聯絡電話(家)-分機碼
           ,NVL(HOLDER.FAX_COUNTRY,' ') AS FAX_COUNTRY      -- 傳真電話-國家碼
           ,NVL(HOLDER.FAX_AREA,' ') AS FAX_AREA            -- 傳真電話-區域碼
           ,NVL(HOLDER.FAX_NO,' ') AS FAX_NO                -- 傳真電話-電話碼
           ,NVL(HOLDER.FAX_EXT,' ') AS FAX_EXT              -- 傳真電話-分機碼
           ,HOLDER.EMAIL                            -- 電子郵件信箱
           ,HOLDER.CONTACT_ADDRESS_COUNTRY          -- 通訊地址-國家碼
           ,HOLDER.POST_CODE                        -- 通訊地址-郵遞區號
           ,HOLDER.CONTACT_ADDRESS                  -- 通訊地址-全址
           -- 2018.05.25 Jim 新增EDM_ACCEPTED、NAV_EPAPER
           -- 2019.06.27 JIANXIN 以防資料是 Null 預設回傳 N
           ,NVL(TRIM(HOLDER.EDM_ACCEPTED),'N')  AS EDM_ACCEPTED                   -- 訂閱瀚亞電子報
           ,NVL(TRIM(HOLDER.NAV_EPAPER),'N')  AS NAV_EPAPER                       -- 訂閱淨值電子報
      FROM FAS.HOLDER HOLDER
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

END s_GetBFBasicData;

/

  GRANT EXECUTE ON "ECS"."S_GETBFBASICDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBFCONTRACTACCOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBFCONTRACTACCOUNT" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/03/29
-- Description: 取得約定帳號一覽表
-- 2018.03.30 ChengYu 新增錯誤訊息
-- 2018.03.30 Jim 修改買回帳戶清單邏輯
-- 2018.03.31 Jim 因規格變更，調整SP邏輯
-- 2018.08.09 JIANXIN 買回帳號有境內、境外、全部的選項
-- 2018.09.18 JIANXIN 買回帳戶增加集保買回帳戶
-- 2018.09.21 JIANXIN MOD BY 調整買回帳號取得邏輯並整理程式
-- 2018.10.15 yunchu 調整資料重覆顯示問題
-- 2018.12.18 JIANXIN MOD BY 調整基金公司帳號對應問題
-- 2018.12.18 JIANXIN MOD BY 增加付款方式作為群組判斷依據、調整付款名稱
-- 2018.12.20 JIANXIN MOD BY 增加中信銀行付款清單、收益分配帳戶調整
-- 2019.06.05 tingting 調整買回帳戶清單的串接條件
-- 2019.06.05 tingting 調整買回帳戶瑞萬的判斷條件(生效日>=集保生效日 → 集保生效日>=生效日)
-- 2019.06.13 tingting 調整買回帳戶的銀行簡稱改從總行檔拿
-- =============================================
(
     WACCOUNT_NO      INTEGER                     -- 受益人戶號
    ,OUTDT            OUT SYS_REFCURSOR           -- 扣款帳戶清單
    ,OUTDT2           OUT SYS_REFCURSOR           -- 買回帳戶清單
    ,OUTDT3           OUT SYS_REFCURSOR           -- 收益分配帳戶清單
    ,OUTDT4           OUT SYS_REFCURSOR           -- 配息帳號清單
) IS

BEGIN

   DECLARE 

   XID      VARCHAR2(10);                         -- 受益人ID
   XSYSDATE DATE:=TRUNC(SYSDATE);                 -- 系統日期

   BEGIN

    -- 2018.03.30 ChengYu 新增錯誤訊息
    BEGIN
           SELECT ID   --受益人ID
             INTO XID
             FROM FAS.HOLDER
            WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
             WHEN NO_DATA_FOUND THEN
                  RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    -- 扣款帳戶清單
    OPEN OUTDT FOR
         SELECT AMC.AMC_NO                              --基金公司代碼
                ,AMC.NAME AS AMC_NAME                   --基金公司名稱
                ,HOLDER_BANK_EC.AC_NAME                 --銀行戶名
                ,HOLDER_BANK_EC.AC_BANK                 --銀行代碼
                ,HOLDER_BANK_EC.AC_BRANCH               --銀行分行代碼
                ,FIS_BANK.SNAME AS FIS_SNAME            --銀行簡稱
                ,HOLDER_BANK_EC.AC_CODE                 --銀行帳號
                ,HOLDER_BANK_EC.CURRENCY_NO             --帳戶幣別代碼
                ,V_FUND_CRNCY.NAME AS CURRENCY_NAME     --帳戶幣別名稱
                ,FIS_BANK.SWIFT_CODE                    --SWIFT 代號
                ,CASE WHEN HOLDER_BANK_EC.VERIFIED IS NULL THEN '1.核印中'
                      ELSE '2.核印成功'
                      END SEAL_TYPE                     --核印狀態
           FROM FAS.HOLDER_BANK_EC HOLDER_BANK_EC
           LEFT JOIN FAS.FIS_BANK FIS_BANK
             ON HOLDER_BANK_EC.AC_BANK = FIS_BANK.BANK_NO
           -- 2018.12.20 JIANXIN MOD BY 增加中信銀行付款清單
           LEFT JOIN FAS.AMC AMC
             ON (  HOLDER_BANK_EC.DEPOSITORY_NO = AMC.DEPOSITORY_NO
                OR (HOLDER_BANK_EC.DEPOSITORY_NO = '02'  AND '01' = AMC.AMC_NO)
                )
           LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
             ON HOLDER_BANK_EC.CURRENCY_NO = V_FUND_CRNCY.CURRENCY_NO
          WHERE HOLDER_BANK_EC.ID = XID
            AND HOLDER_BANK_EC.REJECTED IS NULL
          ORDER BY AMC.AMC_NO;      

   --買回帳戶清單
   OPEN OUTDT2 FOR
        SELECT AMC.AMC_NO                           -- 基金公司代碼
              ,AMC.NAME AS AMC_NAME                 -- 基金公司名稱
              ,HOLDER_BANK.BANK_NO                  -- 銀行代碼
              ,HOLDER_BANK.BRANCH_NO                -- 銀行分行代碼
              -- 2019.06.13 tingting 調整買回帳戶的銀行簡稱改從總行檔拿
              ,FIS_BANK.SNAME AS FIS_SNAME          -- 銀行簡稱
              ,HOLDER_BANK.AC_CODE                  -- 銀行帳號
              ,HOLDER_BANK.CURRENCY_NO              -- 帳戶幣別代碼
              ,V_FUND_CRNCY.NAME AS CURRENCY_NAME   -- 帳戶幣別名稱
              ,HOLDER_BANK.ECS AS TRADE_CHANNEL     -- 交易方式
              ,DECODE(HOLDER_BANK.ECS,'Y','EC買回','N','傳真買回','') AS TRADE_CHANNEL_NM -- 交易方式說明
         FROM FAS.HOLDER_BANK HOLDER_BANK
         LEFT JOIN FAS.FIS_BANK FIS_BANK
           ON FIS_BANK.BANK_NO = HOLDER_BANK.BANK_NO
         LEFT JOIN FAS.AMC AMC
           -- 2019.06.05 tingting 調整買回帳戶清單的串接條件
           --ON AMC.DEPOSITORY_NO = HOLDER_BANK.DEPOSITORY_NO
           -- 2018.08.09 JIANXIN 買回帳號有境內、境外、全部的選項
           ON ((HOLDER_BANK.DEPOSITORY_NO ='01' AND HOLDER_BANK.FUND_TYPE != 'A' AND (HOLDER_BANK.FUND_CATEGORY = AMC.FUND_CATEGORY OR HOLDER_BANK.FUND_CATEGORY = '0'))
           OR (HOLDER_BANK.DEPOSITORY_NO ='01' AND HOLDER_BANK.FUND_TYPE = 'A')
           -- 2018.09.18 JIANXIN 買回帳戶增加集保買回帳戶
           OR (HOLDER_BANK.DEPOSITORY_NO ='04' AND HOLDER_BANK.FUND_TYPE = 'A') )
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
           ON V_FUND_CRNCY.CURRENCY_NO = HOLDER_BANK.CURRENCY_NO
        -- 2018.09.21 JIANXIN MOD BY 調整買回帳號取得邏輯並整理程式
        WHERE HOLDER_BANK.ID = XID
          AND HOLDER_BANK.ECS = 'Y'
          AND (
                (    AMC.AMC_NO != '04' 
                 AND (  HOLDER_BANK.VALID_FROM IS NULL 
                     OR (   HOLDER_BANK.VALID_FROM IS NOT NULL 
                        AND XSYSDATE >= HOLDER_BANK.VALID_FROM
                        )
                     )
                )
                OR 
                (    AMC.AMC_NO = '04' 
                 --- 2019.06.05 tingting 調整買回帳戶瑞萬的判斷條件(生效日>=集保生效日 → 集保生效日>=生效日)
                 AND HOLDER_BANK.TDCC_VALID_FROM >= HOLDER_BANK.VALID_FROM
                )
              )
          AND (HOLDER_BANK.CLOSE_DATE IS NULL OR (HOLDER_BANK.CLOSE_DATE IS NOT NULL AND XSYSDATE < HOLDER_BANK.CLOSE_DATE))
        ORDER BY AMC.AMC_NO;

   -- 收益分配帳戶清單
   -- 2018.10.15 yunchu 調整資料重覆顯示問題
   -- 2018.12.18 JIANXIN MOD BY 調整基金公司帳號對應問題
   OPEN OUTDT3 FOR
        SELECT  DISTINCT HOLDER_DIVIDEND_AMC.PAY_TYPE                                                 -- 付款方式
                -- 2018.12.18 JIANXIN MOD BY 增加付款方式作為群組判斷依據、調整付款名稱
               ,DECODE(HOLDER_DIVIDEND_AMC.PAY_TYPE,'1','支票郵寄','2','轉申購','3','匯款','4','匯款(不受最低金額限制)','') AS PAY_TYPE_NM    -- 付款方式說明
               --,DECODE(HOLDER_DIVIDEND_AMC.PAY_TYPE,'3','',HOLDER_DIVIDEND_AMC.AMC_NO) AS AMC_NO      -- 基金公司代碼
               --,DECODE(HOLDER_DIVIDEND_AMC.PAY_TYPE,'3','',AMC.NAME) AS AMC_NAME                      -- 基金公司名稱   
               ,'' AS AMC_NO
               ,'' AS AMC_NAME
               ,CASE WHEN HOLDER_DIVIDEND_AMC.PAY_TYPE = '1' THEN HOLDER_DIVIDEND_AMC.PAY_ADDRESS
                     ELSE ''
                     END AS PAY_ADDRESS                       -- 郵寄支票地址          
          FROM FAS.HOLDER_DIVIDEND_AMC
          JOIN FAS.HOLDER_DIVIDEND_BANK
            ON HOLDER_DIVIDEND_AMC.ID = HOLDER_DIVIDEND_BANK.ID
           AND HOLDER_DIVIDEND_AMC.AMC_NO = HOLDER_DIVIDEND_BANK.AMC_NO
          LEFT JOIN FAS.AMC AMC
            ON AMC.AMC_NO = HOLDER_DIVIDEND_AMC.AMC_NO
         WHERE HOLDER_DIVIDEND_AMC.ID = XID
         ORDER BY HOLDER_DIVIDEND_AMC.PAY_TYPE;

   -- 配息帳號清單
   -- 2018.12.18 JIANXIN MOD BY 調整基金公司帳號對應問題
   OPEN OUTDT4 FOR
        SELECT HOLDER_DIVIDEND_BANK.AMC_NO              -- 基金公司代碼
               ,AMC.NAME AS AMC_NAME                    -- 基金公司名稱
               ,HOLDER_DIVIDEND_BANK.BANK_NO            -- 銀行代碼
               ,HOLDER_DIVIDEND_BANK.BRANCH_NO          -- 銀行分行代碼
               ,FIS_BANK.SNAME AS FIS_SNAME             -- 銀行簡稱
               ,HOLDER_DIVIDEND_BANK.AC_CODE            -- 銀行帳號
               ,HOLDER_DIVIDEND_BANK.CURRENCY_NO        -- 帳戶幣別代碼
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME      -- 帳戶幣別名稱
               -- 2018.12.18 JIANXIN MOD BY 增加付款方式作為群組判斷依據、調整付款名稱
               ,HOLDER_DIVIDEND_AMC.PAY_TYPE            -- 付款方式
               ,DECODE(HOLDER_DIVIDEND_AMC.PAY_TYPE,'1','支票郵寄','2','轉申購','3','匯款','4','匯款(不受最低金額限制)','') AS PAY_TYPE_NM    -- 付款方式說明
          FROM FAS.HOLDER_DIVIDEND_AMC
          JOIN FAS.HOLDER_DIVIDEND_BANK
            ON HOLDER_DIVIDEND_AMC.ID = HOLDER_DIVIDEND_BANK.ID
           AND HOLDER_DIVIDEND_AMC.AMC_NO = HOLDER_DIVIDEND_BANK.AMC_NO
          LEFT JOIN FAS.AMC AMC
            ON AMC.AMC_NO = HOLDER_DIVIDEND_AMC.AMC_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK
            ON FIS_BANK.BANK_NO = HOLDER_DIVIDEND_BANK.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = HOLDER_DIVIDEND_BANK.CURRENCY_NO
         WHERE HOLDER_DIVIDEND_BANK.ID = XID
           -- 2018.12.20 JIANXIN MOD BY 收益分配帳戶調整：只有匯款才會有資料
           AND HOLDER_DIVIDEND_AMC.PAY_TYPE IN ('3','4');

   END;

END s_GetBFContractAccount;

/

  GRANT EXECUTE ON "ECS"."S_GETBFCONTRACTACCOUNT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBFKYC
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBFKYC" 
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WTX_DATE               DATE,              -- 交易日期
     OUTDT                  OUT SYS_REFCURSOR  -- 回傳的table
) IS

XIS_WRITE_KYC     VARCHAR2(1);                 --取得資料成功否
XWARNS_TYPE       VARCHAR2(1);                 --警示方式
XERROR_MSG        VARCHAR2(250);               --錯誤訊息
XTX_DATE          DATE:=TRUNC(WTX_DATE);            --交易日期
XRISK_LEVEL       FAS.HOLDER.RISK_LEVEL%TYPE;       --風險屬性
XRISK_STATUS      FAS.HOLDER.RISK_STATUS%TYPE;      --適合度分析表交付狀態
XRISK_WRITE_DATE  FAS.HOLDER.RISK_WRITE_DATE%TYPE;  --適合度分析表最後一次填寫日
XRISK_MAT_DATE    FAS.HOLDER.RISK_MAT_DATE%TYPE;    --適合度分析表最後一次填寫到期日

BEGIN

  --取得受益人基本資料
  BEGIN

    SELECT HOLDER.RISK_LEVEL
           ,HOLDER.RISK_STATUS
           -- 2018.11.16 ChengYu 修正 適合度分析表最後一次填寫日、適合度分析表最後一次填寫到期日 日期格式
           -- 2021.05.10 JIANXIN  調整”風險屬性填寫日期”　與　”風險屬性到期日期”預設值
           ,TRUNC(NVL(HOLDER.RISK_WRITE_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')))
           ,TRUNC(NVL(HOLDER.RISK_MAT_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')))
           INTO
           XRISK_LEVEL
           ,XRISK_STATUS
           ,XRISK_WRITE_DATE
           ,XRISK_MAT_DATE
      FROM FAS.HOLDER 
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人基本資料，請檢查！');

  END;

  --若『風險屬性交付狀態(@RISK_STATUS)』為”0. 未交付”時
  IF XRISK_STATUS = '0' THEN

    XRISK_LEVEL := '0';
    XIS_WRITE_KYC := 'Y';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T006';

  --若『風險屬性交付狀態(@RISK_STATUS)』為” 1.已交付” 且『風險屬性填寫日期(@RISK_WRITE_DATE)』大於傳入參數『交易日期(@TX_DATE)』時         
  ELSIF XRISK_STATUS = '1' AND XRISK_WRITE_DATE > XTX_DATE THEN

    XRISK_LEVEL := '0';
    XIS_WRITE_KYC := 'Y';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T006';

  --若『風險屬性交付狀態(@RISK_STATUS)』為” 1.已交付” 且傳入參數『交易日期(@TX_DATE)』小於等於『風險屬性到期日期(@RISK_MAT_DATE)』時         
  ELSIF XRISK_STATUS = '1' AND XTX_DATE <= XRISK_MAT_DATE THEN

    XIS_WRITE_KYC := 'N';

    XWARNS_TYPE   := '';
    XERROR_MSG    := '';

  --若『風險屬性交付狀態(@RISK_STATUS)』為” 1.已交付” 且傳入參數『交易日期(@TX_DATE)』大於『風險屬性到期日期(@RISK_MAT_DATE)』 
  ELSIF XRISK_STATUS = '1' AND XTX_DATE > XRISK_MAT_DATE THEN

    XRISK_LEVEL := '1';
    XIS_WRITE_KYC := 'Y';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T007';

  --若『風險屬性交付狀態(@RISK_STATUS)』為”2.不需交付”時，         
  ELSIF XRISK_STATUS = '2' THEN

    XRISK_LEVEL := '3';
    XIS_WRITE_KYC := 'N';

    XWARNS_TYPE   := '';
    XERROR_MSG    := '';

  --若『風險屬性交付狀態(@RISK_STATUS)』為” 3. 交付其他文件” 且傳入參數『交易日期(@TX_DATE)』小於等於『風險屬性到期日期(@RISK_MAT_DATE)』時                        
  ELSIF XRISK_STATUS = '3' AND XTX_DATE <= XRISK_MAT_DATE THEN

    XRISK_LEVEL := '3';
    XIS_WRITE_KYC := 'N';

    XWARNS_TYPE   := '';
    XERROR_MSG    := '';

  --若『風險屬性交付狀態(@RISK_STATUS)』為” 3. 交付其他文件” 且傳入參數『交易日期(@TX_DATE)』大於『風險屬性到期日期(@RISK_MAT_DATE)』時 
  ELSIF XRISK_STATUS = '3' AND XTX_DATE > XRISK_MAT_DATE THEN

    XRISK_LEVEL := '1';
    XIS_WRITE_KYC := 'Y';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T007';

  END IF;

  OPEN OUTDT FOR
       SELECT XRISK_LEVEL    AS RISK_LEVEL    --客戶風險屬性
              ,XIS_WRITE_KYC AS IS_WRITE_KYC  --需重填投資適性分析表
              -- 2021.05.10 JIANXIN  新增”風險屬性填寫日期”　與　”風險屬性到期日期”　欄位
              ,XRISK_WRITE_DATE   AS RISK_WRITE_DATE    --風險屬性填寫日期
              ,XRISK_MAT_DATE   AS RISK_MAT_DATE    --風險屬性到期日期
              ,XWARNS_TYPE   AS WARNS_TYPE    --警示方式
              ,XERROR_MSG    AS ERROR_MSG     --錯誤訊息
               -- 2023.10.07 JIANXIN 新增回傳KYC上次寫入的資料
              ,EMPLOYER
              ,CUST_FAMILY_STATUS
              ,CUST_FAMILY_STATUS_TXT AS CUST_FAMILY_STATUS_OTHERS
              ,CUST_CHILD_STATUS
              ,CUST_CHILD_STATUS_TXT
              ,PROFESSION
              ,PROFESSION_OTHERS_NEW
              ,POSITION
              ,POSITION_OTHERS
              , NVL(CUST_INV_FUNDS_1,'N')  || ','||
                NVL(CUST_INV_FUNDS_2,'N')  || ','||
                NVL(CUST_INV_FUNDS_3,'N')  || ','||
                NVL(CUST_INV_FUNDS_4,'N')  || ','||
                NVL(CUST_INV_FUNDS_5,'N')  || ','||
                NVL(CUST_INV_FUNDS_6,'N')  || ','||
                NVL(CUST_INV_FUNDS_7,'N')  AS INV_ORI
              ,CUST_INV_FUNDS_7_TXT  AS INV_ORI_OTHERS
              , NVL(CUST_INV_FINSOURCE_1,'N')  || ','||
                NVL(CUST_INV_FINSOURCE_2,'N')  || ','||
                NVL(CUST_INV_FINSOURCE_3,'N')  || ','||
                NVL(CUST_INV_FINSOURCE_4,'N')  AS CUST_INV_FINSOURCE
              ,CUST_INV_FINSOURCE_4_TXT AS CUST_INV_FINSOURCE_OTHERS
              ,CUST_INV_ESTAMT
              ,CUST_RESIDENCE_STATUS
              ,CUST_RESIDENCE_STATUS_TXT AS CUST_RESIDENCE_STATUS_OTHERS
              ,CUST_MIND_STATUS
              ,MAJOR_ILLNESS
              ,MAJOR_ILLNESS_REMARK
              ,CUST_RISK_AGE
              ,EDUCATION
              ,CUST_RISK_INVTOOL
              ,CUST_RISK_INVEXP
              ,CUST_RISK_INVPURPOSE
              ,FAMILY_INCOME
              ,CUST_RISK_INVPROFIT
              ,CUST_RISK_FUNDING
              ,CUST_RISK_FLUIDITY
              ,CUST_RISK_PRICEVOL
         FROM FAS.HOLDER 
     　 WHERE ACCOUNT_NO = WACCOUNT_NO;

END s_GetBFKYC;

/

  GRANT EXECUTE ON "ECS"."S_GETBFKYC" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBFNOTICE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBFNOTICE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/10/17
-- Description: 取得受益人相關通知內容
-- 2018.10.19 ChengYu 警示訊息拿掉警示日期
-- =============================================
(
    WACCOUNT_NO       INTEGER,                   -- 受益人戶號
    NOTICE_LIST       OUT SYS_REFCURSOR,         -- 停損/觀察通知列表
    MSG_LIST          OUT SYS_REFCURSOR          -- 訊息列表
) IS

XINPUT_DATE DATE;    --最新執行日期

BEGIN

    SELECT MAX(INPUT_DATE)
       INTO XINPUT_DATE
       FROM ECS.PRICE_LOG A
       LEFT JOIN FAS.HOLDER B
         ON A.ID = B.ID
      WHERE B.ACCOUNT_NO = WACCOUNT_NO
        AND (A.IS_NAV_ALTER IN('1','2')
         OR A.IS_RETURN_ALTER IN('1','2'));

    OPEN NOTICE_LIST FOR    
    SELECT  PRICE_LOG.INPUT_DATE        -- 執行日期
           ,PRICE_LOG.FUND_NO           -- 基金代碼
           ,FUND.NAME AS FUND_NAME      -- 基金名稱
           ,PRICE_LOG.TYPE              -- 類別
           ,PRICE_LOG.UPPER_LIMIT       -- 到價停利(%)
           ,PRICE_LOG.LOWER_LIMIT       -- 到價停損(%)
           ,PRICE_LOG.BUY_IN            -- 到價買進價位
           ,PRICE_LOG.SELL_OUT          -- 到價賣出價位
           ,PRICE_LOG.ALERT_PRU         -- 到價提示單位 
           ,PRICE_LOG.NAV_DATE          -- 最新淨值日期
           ,PRICE_LOG.NAV               -- 最新淨值
           ,PRICE_LOG.RETURN_BAL_UNIT   -- 報酬計算單位數(交易幣)
           ,RETURN_TAOTAL_COST          -- 報酬計算總成本(交易幣)
           ,PRICE_LOG.INVEST_RATE       -- 投資報酬率(交易幣)
           ,PRICE_LOG.IS_NAV_ALTER      -- 基金淨值警示
           ,PRICE_LOG.IS_RETURN_ALTER   -- 停利停損警示
           ,FUND.AMT_DECIMAL            -- 幣別小數位數
           ,FUND.SHARE_DECIMAL          -- 單位數小數位數
           ,FUND.NAV_DECIMAL            -- 淨值小數位數
      FROM ECS.PRICE_LOG
      LEFT JOIN FAS.FUND
        ON FUND.FUND_NO = PRICE_LOG.FUND_NO
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ID = PRICE_LOG.ID
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO
       AND (PRICE_LOG.IS_NAV_ALTER IN('1','2')
            OR PRICE_LOG.IS_RETURN_ALTER IN('1','2')
           )
       AND PRICE_LOG.INPUT_DATE = XINPUT_DATE;

    OPEN MSG_LIST FOR    
    SELECT  PRICE_LOG.INPUT_DATE          -- 執行日期
           ,PRICE_LOG.FUND_NO             -- 基金代碼
           ,FUND.NAME AS FUND_NAME        -- 基金名稱
           ,PRICE_LOG.TYPE                -- 類別
           ,ECS_OPTION_036.DISPLAY_NAME AS TYPE_NAME   -- 類別名稱
           ,PRICE_LOG.IS_READ             -- 是否已讀
           -- 2018.10.19 ChengYu 警示訊息拿掉警示日期
           ,CASE WHEN IS_NAV_ALTER = '1' THEN REPLACE(REPLACE(REPLACE(MSGINFO_T017.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{NAV}',PRICE_LOG.NAV),'{BUY_IN}',PRICE_LOG.BUY_IN)
                 WHEN IS_NAV_ALTER = '2' THEN REPLACE(REPLACE(REPLACE(MSGINFO_T016.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{NAV}',PRICE_LOG.NAV),'{SELL_OUT}',PRICE_LOG.SELL_OUT)
                 WHEN IS_RETURN_ALTER = '1' THEN REPLACE(REPLACE(REPLACE(MSGINFO_T019.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{NAV}',PRICE_LOG.NAV),'{UPPER_LIMIT}',PRICE_LOG.UPPER_LIMIT)
                 WHEN IS_RETURN_ALTER = '2' THEN REPLACE(REPLACE(REPLACE(MSGINFO_T018.MSGCONTENT,'{FUND_NAME}',FUND.NAME),'{NAV}',PRICE_LOG.NAV),'{LOWER_LIMIT}',PRICE_LOG.LOWER_LIMIT)
            END AS MSG_CONTENT            -- 訊息內容
      FROM ECS.PRICE_LOG
      LEFT JOIN FAS.FUND
        ON FUND.FUND_NO = PRICE_LOG.FUND_NO
      LEFT JOIN FAS.HOLDER HOLDER
        ON HOLDER.ID = PRICE_LOG.ID
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_036
        ON ECS_OPTION_036.SOURCE_TYPE = '036'
       AND ECS_OPTION_036.TEXT_VALUE = PRICE_LOG.TYPE
     CROSS JOIN (SELECT MSGCONTENT FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'T016') MSGINFO_T016     
     CROSS JOIN (SELECT MSGCONTENT FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'T017') MSGINFO_T017    
     CROSS JOIN (SELECT MSGCONTENT FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'T018') MSGINFO_T018
     CROSS JOIN (SELECT MSGCONTENT FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'T019') MSGINFO_T019
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO
       AND (PRICE_LOG.IS_NAV_ALTER IN('1','2')
            OR PRICE_LOG.IS_RETURN_ALTER IN('1','2')
           )
       AND PRICE_LOG.INPUT_DATE = XINPUT_DATE;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETBFNOTICE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETBMSDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETBMSDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/08
-- Description: 取得受益人資訊
-- 2018.03.22 ChengYu 查詢基金資料
-- 2018.03.27 Jim     新增KYC
-- 2018.06.26 JIANXIN 新增KYC 分數欄位
-- 2018.07.16 ChengYu 新增欄位 帳戶狀態,ROBO同意書,是否為員工員眷,是否為弱勢族群
-- 2018.07.19 ChengYu 新增欄位 KYC 是否有效(KYC_EFFECTIVE)
-- 2018.07.20 ChengYu 新增欄位 停損停利是否設定(IS_STOP_LOSS)、當日是否到價(IS_PRICE_ALERT)
-- 2018.09.20 tingting 修正傳出欄位ECS_STATUS的判斷方式
-- 2018.09.26 ChengYu 新增回傳基金風險等級
-- 2018.10.04 YungLong 新增傳出參數「出生日期」
-- 2018.10.25 JIANXIN 弱勢族群判斷調整
-- 2018.10.25 JIANXIN KYC 等級判斷調整
-- 2018.10.26 JIANXIN 新增年齡欄位
-- 2018.10.26 JIANXIN 弱勢族群判斷二次調整
-- 2018.12.03 ChengYu 新增傳出欄位 是否可轉申購
-- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
-- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶
-- 2018.12.24 JIANXIN 弱勢族群判斷 20 歲以下不是弱勢族群
-- 2018.12.24 JIANXIN 因緊急上版先行移除【調整未開戶完成者，視為查詢戶】
-- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶 恢復
-- 2019.01.03 tingting 移除【調整未開戶完成者，視為查詢戶】
-- 2021.09.29 JIANXIN 因應外幣贖回調整邏輯
-- 2022.09.14 JIANXIN 判斷 65 歲以上是弱勢族群
-- 2022.12.26 JIANXIN 弱勢族群判斷由20歲以上且國中小學歷異動為18歲以上且國中小學歷，方才是弱勢族群
-- 2024.03.04 JIANXIN 新增最後使用者更新日期
-- =============================================
(
    WACCOUNT_NO    INTEGER,                   -- 受益人戶號
    OUTDT          OUT SYS_REFCURSOR,         -- 回傳的 BMSData
    OUTDT2         OUT SYS_REFCURSOR,         -- 回傳的 FundData
    OUTDT3         OUT SYS_REFCURSOR          -- 回傳的 停損停利到價通知 Table
) IS

XSYS_DTTM DATE :=SYSDATE;    --系統時間

BEGIN

    OPEN OUTDT FOR
    SELECT  HOLDER.NAME
           ,HOLDER.GENDAR AS GENDER
           ,CASE HOLDER.GENDAR
               WHEN 'F' THEN '女生'
               WHEN 'M' THEN '男生'
               WHEN 'C' THEN '公司'
            END GENDER_NAME
           -- 2018.10.25 JIANXIN KYC 等級判斷調整
           ,CASE WHEN HOLDER.RISK_LEVEL IS NULL THEN '1'
                 ELSE HOLDER.RISK_LEVEL 
             END RISK_LEVEL
           ,CASE WHEN HOLDER.RISK_LEVEL = '1' THEN '保守'
                 WHEN HOLDER.RISK_LEVEL = '2' THEN '穩健'
                 WHEN HOLDER.RISK_LEVEL = '3' THEN '積極'
                 ELSE '保守' 
             END RISK_LEVEL_NAME
           -- 2018.03.27 Jim 新增KYC
           -- 2018.06.26 JIANXIN 新增KYC 分數欄位
           ,KYC_SCROE AS KYC_SCORE
           ,HOLDER.ACCOUNT_NO
           -- 2018.09.20 tingting 修正傳出欄位ECS_STATUS的判斷方式
           -- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶
           -- 2018.12.24 JIANXIN 因緊急上版先行移除【調整未開戶完成者，視為查詢戶】
           -- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶 恢復
           -- 2019.01.03 tingting 移除【調整未開戶完成者，視為查詢戶】
           ,CASE WHEN HOLDER.ECS_STATUS = '1'  THEN 'Y'
                 ELSE 'N'
             END ECS_STATUS
            -- 2018.07.16 ChengYu 新增欄位 帳戶狀態,ROBO同意書,是否為員工員眷,是否為弱勢族群 BEGIN
           ,HOLDER.AML_STATUS AS AML_STATUS
           ,HOLDER.ROBO_AGREEMENT AS ROBO_AGREEMENT
            -- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
           ,CASE WHEN (EMP.STATUS = 'A') AND (RELATIVE.RELATIONSHIP IN ('S','P','C')) THEN 'Y'
                 ELSE 'N'
            END AS IS_EMP
            -- 2018.10.25 JIANXIN 弱勢族群判斷調整
            -- 2018.10.26 JIANXIN 弱勢族群判斷二次調整
            -- 2018.12.24 JIANXIN 弱勢族群判斷 20 歲以下不是弱勢族群
            -- 2022.09.14 JIANXIN 判斷 65 歲以上是弱勢族群
            -- 2022.12.26 JIANXIN 弱勢族群判斷由20歲以上且國中小學歷異動為18歲以上且國中小學歷，方才是弱勢族群
           ,CASE WHEN HOLDER.MAJOR_ILLNESS = 'Y' THEN 'Y'   -- 有重大傷病證明
                 WHEN TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(HOLDER.BIRTH_DATE,'yyyyMMdd'))/10000) >= 18 AND (HOLDER.EDUCATION = 'a' OR HOLDER.EDUCATION = 'A') THEN 'Y'  -- 18歲以上，學歷為國中小以下
                 WHEN TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(HOLDER.BIRTH_DATE,'yyyyMMdd'))/10000) >= 65  THEN 'Y'  --65歲以上
                 ELSE 'N' 
             END AS VULNERABLE_GROUP
            -- 2018.07.16 ChengYu 新增欄位 帳戶狀態,ROBO同意書,是否為員工員眷,是否為弱勢族群 END
            -- 2018.07.19 ChengYu 新增欄位 KYC 是否有效(KYC_EFFECTIVE)
           ,CASE WHEN HOLDER.RISK_STATUS = '1' AND XSYS_DTTM <= HOLDER.RISK_MAT_DATE THEN 'Y'
                 WHEN HOLDER.RISK_STATUS = '2' OR HOLDER.RISK_STATUS = '3' THEN 'Y'
                 WHEN HOLDER.RISK_STATUS = '1' AND XSYS_DTTM > HOLDER.RISK_MAT_DATE THEN 'N'
                 WHEN HOLDER.RISK_STATUS = '0' THEN 'N'
                 ELSE ''
            END AS KYC_EFFECTIVE
            -- 2018.10.04 YungLong 新增傳出參數「出生日期」
            ,HOLDER.BIRTH_DATE
            -- 2018.10.26 JIANXIN 新增年齡欄位
            ,TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(BIRTH_DATE,'yyyyMMdd'))/10000) AS AGE
            ,(SELECT MAX(LAST_MODIFIED) FROM FAS.HOLDER_CHANGE WHERE TX_TYPE = 'Q'  AND ID = HOLDER.ID) AS LAST_PWD_DATE
            -- 2024.03.04 JIANXIN 新增最後使用者更新日期
            ,HOLDER.USER_ALIAS_CHG_DATE AS LAST_USER_ALIAS_CHG_DATE
      FROM FAS.HOLDER HOLDER
      LEFT JOIN FAS.EMP EMP            -- 員工資料
        ON EMP.ID = HOLDER.ID
      LEFT JOIN FAS.RELATIVE RELATIVE  -- 員眷資料
        ON RELATIVE.ID = HOLDER.ID
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

    -- 2018.03.22 ChengYu 查詢基金資料
    OPEN OUTDT2 FOR
    SELECT  FUND.FUND_NO AS FUND_NO
           -- 2021.09.29 JIANXIN 因應外幣贖回調整邏輯
           ,V_TX_CURRENCY.CURRENCY_NO AS TX_CURRENCY
           ,FUND.IS_EC AS IS_EC
           -- 2021.09.29 JIANXIN 因應外幣贖回調整邏輯
           ,CASE WHEN FUND.IS_EC_REDEMPTION = 'N'  THEN 'N'
                 WHEN TX_CURRENCY_REDEM.CURRENCY_NO IS NULL  THEN 'N'  
                 ELSE 'Y' END AS IS_EC_REDEM
           -- 2018.12.03 ChengYu 新增傳出欄位 是否可轉申購
           -- 2021.09.29 JIANXIN 因應外幣贖回調整邏輯
           ,CASE WHEN FUND.IS_EC_SWITCH_IN = 'N'  THEN 'N'
                 WHEN TX_CURRENCY_SWITCH.CURRENCY_NO IS NULL  THEN 'N'  
                 ELSE 'Y' END  AS IS_EC_SWITCH_IN
           ,FUND.EC_RSP_UPDATE AS EC_RSP_UPDATE
           ,FUND.EC_DRSP_UPDATE AS EC_DRSP_UPDATE
             -- 2018.09.26 ChengYu 新增回傳基金風險等級
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY
      FROM FAS.FUND
      JOIN (SELECT DISTINCT FUND_NO, CURRENCY_NO FROM ECS.V_TX_CURRENCY) V_TX_CURRENCY
        ON FUND.FUND_NO = V_TX_CURRENCY.FUND_NO
      LEFT JOIN   ECS.V_TX_CURRENCY TX_CURRENCY_REDEM
        ON TX_CURRENCY_REDEM.FUND_NO = V_TX_CURRENCY.FUND_NO
       AND TX_CURRENCY_REDEM.CURRENCY_NO = V_TX_CURRENCY.CURRENCY_NO
       AND TX_CURRENCY_REDEM.TRADE_CD = '4'
      LEFT JOIN   ECS.V_TX_CURRENCY TX_CURRENCY_SWITCH
        ON TX_CURRENCY_SWITCH.FUND_NO = V_TX_CURRENCY.FUND_NO
       AND TX_CURRENCY_SWITCH.CURRENCY_NO = V_TX_CURRENCY.CURRENCY_NO
       AND TX_CURRENCY_SWITCH.TRADE_CD = '5';


    -- 2018.07.20 ChengYu 新增欄位 停損停利是否設定(IS_STOP_LOSS)、當日是否到價(IS_PRICE_ALERT)
    OPEN OUTDT3 FOR
    SELECT  HOLDER.ACCOUNT_NO AS ACCOUNT_NO
           ,FUND_ALERT.FUND_NO 
           ,FUND_ALERT.TYPE 
           ,ALERT_PRU
           ,BUY_IN
           ,SELL_OUT
           ,UPPER_LIMIT
           ,LOWER_LIMIT
      FROM WPS.FUND_ALERT
      LEFT JOIN FAS.HOLDER
        ON HOLDER.ID = FUND_ALERT.ID;

END s_GetBMSData;

/

  GRANT EXECUTE ON "ECS"."S_GETBMSDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETCANCELDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETCANCELDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/05/18
-- Description: 取得委託交易資訊
-- 2018.06.17 ChengYu 回傳(定期定額)、(定期不定額)的查詢條件TX_STATUS = 'O' 改為 STATUS = '1'
-- 2018.07.15 JIANXIN 調整回傳RSP、DRSP扣款日型態
-- 2018.08.15 JIANXIN 促銷活動名稱串接、預計首次扣款日欄位改由 EXPECTED_TX_DATE 取得
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.08.29 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.10.09 ChengYu 新增傳出欄位風險屬性
-- 2018.10.09 ChengYu 修正轉申購列表的傳出欄位
-- 2018.10.11 JIANXIN 調整手續費計算內容
-- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
-- 2018.10.31 ChengYu 贖回列表補上計價幣別、轉申購列表補上交易幣別
-- 2018.11.01 JIANXIN 轉申購基金級別調整
-- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
-- 2018.11.30 ChegngYu 修正轉申購轉入基金交易幣別
-- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
--                     調整「生日優惠」名稱改為促銷活動的名稱
-- 2018.12.11 JIANXIN MOD BY 調整轉申購交易幣別的顯示
-- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位：
--                     單筆申購　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】欄位
--                     贖回　　　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】欄位
--                     轉申購　　：新增【轉出基金是否為配息(IS_DIVIDEND_OUT)】、【轉出基金配息頻率(DIVIDEND_TYPE_OUT)】、【轉出基金配息頻率名稱(DIVIDEND_TYPE_NAME_OUT)】、【轉入基金是否為配息(IS_DIVIDEND_IN)】、【轉入基金配息頻率(DIVIDEND_TYPE_IN)】、【轉入基金配息頻率名稱(DIVIDEND_TYPE_NAME_IN)】、【委託日期(RCV_DATE)】、【郵匯費(WIRE_FEE)】、【轉出基金淨額(AMOUNT_OUT)】、【轉入基金淨額(AMOUNT_IN)】、【匯率日期(EX_DATE)】、【匯率-交叉匯率(EX_RATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】欄位
--                     定期定額　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】
--                     定期不定額：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】
-- 2019.04.30 tingtnig 單筆申購列表增加傳出淨值日期欄位
-- 2019.05.09 tingting 調整促銷活動名稱顯示
-- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
-- =============================================
(
    WACCOUNT_NO    INTEGER,                    -- 受益人戶號
    WAMC_NO        VARCHAR2,                   -- 基金公司代碼
    WFUND_NO       VARCHAR2,                   -- 基金代碼
    OUTDT          OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(單筆申購)
    OUTDT2         OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(買回)
    OUTDT3         OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(轉申購)
    OUTDT4         OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(定期定額)
    OUTDT5         OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA(定期不定額)
) IS

    XAMC_NO   VARCHAR2(3);  -- 基金經理公司代碼
    XFUND_NO  VARCHAR2(5);  -- 基金公司代碼
    XID       VARCHAR2(10); -- 受益人ID

BEGIN

    --取得受益人ID
    BEGIN

        SELECT HOLDER.ID
          INTO XID
          FROM FAS.HOLDER HOLDER
         WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;


    --取得基金經理公司代碼
    IF WAMC_NO IS NULL THEN

        XAMC_NO := 'ALL';

    ELSE

        XAMC_NO := WAMC_NO;

    END IF;

    --取得基金公司代碼
    IF WFUND_NO IS NULL THEN

        XFUND_NO := 'ALL';

    ELSE

        XFUND_NO := WFUND_NO;

    END IF;

    --取得單筆申購
    OPEN OUTDT FOR
    SELECT  -- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
            ROW_NUMBER() OVER(ORDER BY PURCHASE.TX_DATE, FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, FUND.SHARE_CLASS NULLS FIRST, FUND.ORDINAL) AS ROW_NUM   -- 排列序號
           ,PURCHASE.FUND_NO                                                                          -- 基金代碼
           ,FUND.NAME AS FUND_NAME                                                                    -- 基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                                                           -- 基金警語
           ,FUND.ISIN_CODE                                                                            -- ISIN Code
           ,FUND.SHARE_CLASS                                                                          -- 基金級別
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                                 -- 基金級別名稱
           ,FUND.CURRENCY_NO                                                                          -- 計價幣別
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                                                        -- 計價幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位風險屬性
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY                                                       -- 基金風險屬性
           ,NVL(PURCHASE.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS TX_DATE                       -- 交易日期
           -- 2019.04.30 tingtnig 單筆申購列表增加傳出淨值日期欄位
           ,NVL(PURCHASE.AC_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS AC_DATE                       -- 淨值日期
           ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY                                                       -- 申購幣別
           ,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                                                      -- 申購幣別名稱
           ,PURCHASE.AMOUNT                                                                           -- 申購價金
           -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
           -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
           --                     調整「生日優惠」名稱改為促銷活動的名稱
           ,CASE WHEN PURCHASE.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || PURCHASE.COUPON_ID
                 WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵' || PURCHASE.USED_POINT || '點'
                 WHEN PURCHASE.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率' 
                 END FEE_CHOICE                                                                       -- 手續費收取方式
           ,PURCHASE.SC_RATE                                                                          -- 申購手續費率
           ,PURCHASE.SERVICE_CHARGE                                                                   -- 申購手續費
           ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE,V_TRADE_CRNCY.AMT_DECIMAL) AS TOT_AMOUNT  -- 申購總價金
           ,PURCHASE.BANK_NO                                                                          -- 扣款總行代碼
           ,PURCHASE.AC_BRANCH                                                                        -- 扣款分行代碼
           ,FIS_BANK.SNAME AS FIS_SNAME                                                               -- 扣款銀行簡稱
           ,PURCHASE.AC_CODE                                                                          -- 扣款帳號
           -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
           ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5                                     -- 扣款帳號後5碼
           ,V_TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL                                            -- 申購幣別小數位數
           ,'1' AS TX_TYPE                                                                            -- 交易類別
           ,PURCHASE.SER_NO                                                                           -- 交易序號
           -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
           ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND                   -- 是否為配息
           ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                                       -- 配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME                               -- 配息頻率名稱
           ,PURCHASE_LOG.REVISION_DATE AS RCV_DATE                                                    -- 委託日期(含時分秒)
           ,PURCHASE.FEE_CHOICE AS FEE_CHOICE_TYPE                                                    -- 優惠方案代碼
           -- 2019.05.09 tingting 調整促銷活動名稱顯示
           -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
           ,CASE WHEN PURCHASE.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || PURCHASE.COUPON_ID
                 WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵' || PURCHASE.USED_POINT || '點'
                 WHEN PURCHASE.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
                 END AS FEE_CHOICE_NAME                                                               -- 優惠方案名稱
           ,PURCHASE.PROJECT_CODE                                                                     -- 促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                                                    -- 促銷活動名稱
      FROM ECS.PURCHASE PURCHASE
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = PURCHASE.FUND_NO
       AND (FUND.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
       AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
      JOIN FAS.FIS_BANK FIS_BANK
        ON FIS_BANK.BANK_NO = PURCHASE.BANK_NO 
      -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
      LEFT JOIN ECS.CAMPAIGN CAMPAIGN
        ON CAMPAIGN.CAMPAIGN_CODE = PURCHASE.PROJECT_CODE
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
      LEFT JOIN (
            SELECT  PURCHASE_LOG.FUND_NO
                   ,PURCHASE_LOG.ID
                   ,PURCHASE_LOG.TX_DATE
                   ,PURCHASE_LOG.BROKER_NO
                   ,PURCHASE_LOG.BRANCH_NO
                   ,PURCHASE_LOG.SER_NO
                   ,MAX(PURCHASE_LOG.REVISION_DATE) AS REVISION_DATE 
              FROM ECS.PURCHASE_LOG     -- EC申購異動紀錄
             WHERE PURCHASE_LOG.ACTION_TYPE = 'A'   -- 交易動作(A:新增/M:修改/D:刪除)
             GROUP BY PURCHASE_LOG.FUND_NO
                   ,PURCHASE_LOG.ID
                   ,PURCHASE_LOG.TX_DATE
                   ,PURCHASE_LOG.BROKER_NO
                   ,PURCHASE_LOG.BRANCH_NO
                   ,PURCHASE_LOG.SER_NO
           ) PURCHASE_LOG       -- EC申購異動紀錄
        ON PURCHASE_LOG.FUND_NO = PURCHASE.FUND_NO
       AND PURCHASE_LOG.ID = PURCHASE.ID
       AND PURCHASE_LOG.TX_DATE = PURCHASE.TX_DATE
       AND PURCHASE_LOG.BROKER_NO = PURCHASE.BROKER_NO
       AND PURCHASE_LOG.BRANCH_NO = PURCHASE.BRANCH_NO
       AND PURCHASE_LOG.SER_NO = PURCHASE.SER_NO
     WHERE PURCHASE.BROKER_NO = '999'
       AND PURCHASE.BRANCH_NO = '8000'
       AND PURCHASE.STATUS = 'O'
       AND PURCHASE.ID = XID
       AND (PURCHASE.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
     ORDER BY ROW_NUM;

	--取得買回
	OPEN OUTDT2 FOR
    SELECT  -- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
            ROW_NUMBER() OVER(ORDER BY REDEMPTION.TX_DATE, FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, FUND.SHARE_CLASS NULLS FIRST, FUND.ORDINAL) AS ROW_NUM   -- 排列序號
           ,REDEMPTION.FUND_NO                                                       -- 基金代碼
           ,FUND.NAME AS FUND_NAME                                                   -- 基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                                          -- 基金警語
           ,FUND.ISIN_CODE                                                           -- ISIN Code
           ,FUND.SHARE_CLASS                                                         -- 基金級別
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                -- 基金級別名稱
           -- 2018.10.31 ChengYu 贖回列表補上計價幣別、轉申購列表補上交易幣別
           ,FUND.CURRENCY_NO                                                         -- 計價幣別
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                                       -- 計價幣別名稱
           ,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY                                    -- 申購幣別
           ,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                                     -- 申購幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位風險屬性
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY                                      -- 基金風險屬性
           ,NVL(REDEMPTION.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS TX_DATE    -- 買回交易日期
           ,REDEMPTION.BANK_CURRENCY_NO AS PAY_CRNCY                                 -- 付款幣別
           ,V_PAY_CRNCY.NAME AS PAY_CRNCY_NM                                         -- 付款幣別中文名稱
           ,REDEMPTION.APPLICATION_SHARE                                             -- 買回單位數
           ,NVL(REDEMPTION.AC_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS AC_DATE    -- 買回計算淨值日期
           ,NVL(REDEMPTION.PAY_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS PAY_DATE  -- 預計買回入帳日期
           ,REDEMPTION.AC_BANK AS BANK_NO                                            -- 買回總行代碼
           ,REDEMPTION.AC_BRANCH                                                     -- 買回分行代碼
           ,REDEMPTION.AC_FIS_SNAME AS FIS_SNAME                                     -- 買回銀行簡稱
           ,REDEMPTION.AC_CODE                                                       -- 買回帳號
           -- 2018.08.29 JIANXIN MOD BY 新增帳號隱碼函數
           ,ECS.FN_STUFF_STR(REDEMPTION.AC_CODE,5,'*')  AS AC_CODE_5                 -- 買回帳號後5碼
           ,FUND.SHARE_DECIMAL                                                       -- 單位數小數位數
           ,'2' AS TX_TYPE                                                           -- 交易類別
           ,REDEMPTION.SER_NO                                                        -- 交易序號
           -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
           ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND  -- 是否為配息
           ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                      -- 配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME              -- 配息頻率名稱
           ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE                                 -- 委託日期(含時分秒)
      FROM ECS.REDEMPTION REDEMPTION
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = REDEMPTION.FUND_NO
       AND (FUND.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
       AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
      -- 2018.10.31 ChengYu 贖回列表補上計價幣別、轉申購列表補上交易幣別
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_PAY_CRNCY
        ON V_PAY_CRNCY.CURRENCY_NO = REDEMPTION.BANK_CURRENCY_NO
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
      LEFT JOIN (
            SELECT  REDEMPTION_LOG.FUND_NO
                   ,REDEMPTION_LOG.ID
                   ,REDEMPTION_LOG.TX_DATE
                   ,REDEMPTION_LOG.BROKER_NO
                   ,REDEMPTION_LOG.BRANCH_NO
                   ,REDEMPTION_LOG.SER_NO
                   ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
              FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
             WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
             GROUP BY REDEMPTION_LOG.FUND_NO
                   ,REDEMPTION_LOG.ID
                   ,REDEMPTION_LOG.TX_DATE
                   ,REDEMPTION_LOG.BROKER_NO
                   ,REDEMPTION_LOG.BRANCH_NO
                   ,REDEMPTION_LOG.SER_NO
           ) REDEMPTION_LOG       -- EC買回異動紀錄
        ON REDEMPTION_LOG.FUND_NO = REDEMPTION.FUND_NO
       AND REDEMPTION_LOG.ID = REDEMPTION.ID
       AND REDEMPTION_LOG.TX_DATE = REDEMPTION.TX_DATE
       AND REDEMPTION_LOG.BROKER_NO = REDEMPTION.BROKER_NO
       AND REDEMPTION_LOG.BRANCH_NO = REDEMPTION.BRANCH_NO
       AND REDEMPTION_LOG.SER_NO = REDEMPTION.SER_NO
     WHERE REDEMPTION.BROKER_NO = '999'
       AND REDEMPTION.BRANCH_NO = '8000'
       AND REDEMPTION.STATUS = 'O'
       AND REDEMPTION.ID = XID
       AND (REDEMPTION.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
     ORDER BY ROW_NUM;

	--取得轉申購
	-- 2018.10.09 ChengYu 修正轉申購列表的傳出欄位
	OPEN OUTDT3 FOR
    SELECT  -- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
            ROW_NUMBER() OVER(ORDER BY REDEMPTION.TX_DATE, FUND_OUT.FUND_CATEGORY, FUND_OUT.AMC_NO, FUND_OUT.SITCA_FUND_TYPE, FUND_OUT.ORDINAL, FUND_OUT.SHARE_CLASS NULLS FIRST, FUND_OUT.ORDINAL) AS ROW_NUM   -- 排列序號
           ,REDEMPTION.FUND_NO AS FUND_NO_OUT                                      -- 買回基金代碼
           ,FUND_OUT.NAME AS FUND_NAME_OUT                                         -- 買回基金名稱
           ,FUND_OUT.DIVIDEND_DESC AS FUND_MEMO_OUT                                -- 買回基金警語
           ,FUND_OUT.ISIN_CODE AS ISIN_CODE_OUT                                    -- 買回國際證券代碼
           ,FUND_OUT.SHARE_CLASS                                                   -- 買回基金級別
           ,FUND_OUT_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                          -- 買回基金級別名稱
           ,FUND_OUT.CURRENCY_NO                                                   -- 買回計價幣別
           ,V_FUND_OUT_CRNCY.NAME AS CURRENCY_NAME                                 -- 買回計價幣別名稱
           -- 2018.10.31 ChengYu 贖回列表補上計價幣別、轉申購列表補上交易幣別
           -- 2018.12.11 JIANXIN MOD BY 調整轉申購交易幣別的顯示
           ,FUND_OUT.CURRENCY_NO AS TRADE_CRNCY                                    -- 買回申購幣別
           ,V_FUND_OUT_CRNCY.NAME AS TRADE_CRNCY_NM                                -- 買回申購幣別名稱
           --,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY                                  -- 買回申購幣別
           --,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                                   -- 買回申購幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位 風險屬性(RISK_CATEGORY)
           ,FUND_OUT.RISK_CATEGORY AS RISK_CATEGORY                                -- 買回基金風險屬性
           ,NVL(REDEMPTION.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS TX_DATE  -- 買回交易日期
           ,NVL(REDEMPTION.AC_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS AC_DATE  -- 買回計算淨值日期
           ,REDEMPTION.APPLICATION_SHARE                                           -- 轉申購單位數
           ,REDEMPTION.FUND_NO_IN                                                  -- 轉入基金代碼
           ,FUND_IN.NAME AS FUND_NAME_IN                                           -- 轉入基金名稱
           ,FUND_IN.DIVIDEND_DESC AS FUND_MEMO_IN                                  -- 轉入基金警語
           ,FUND_IN.ISIN_CODE AS ISIN_CODE_IN                                      -- 轉入基金國際證券代碼
           ,FUND_IN.SHARE_CLASS AS SHARE_CLASS_IN                                  -- 轉入基金級別
           ,FUND_IN_SHARE_CLASS.NAME AS SHARE_CLASS_NAME_IN                        -- 轉入基金級別名稱
           ,FUND_IN.CURRENCY_NO AS CURRENCY_NO_IN                                  -- 轉入基金計價幣別
           ,V_FUND_IN_CRNCY.NAME AS CURRENCY_NAME_IN                               -- 轉入基金計價幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位 風險屬性(RISK_CATEGORY)
           ,FUND_IN.RISK_CATEGORY AS RISK_CATEGORY_IN                              -- 轉入基金風險屬性
           -- 2018.11.30 ChegngYu 修正轉申購轉入基金交易幣別
           -- 2018.12.11 JIANXIN MOD BY 調整轉申購交易幣別的顯示
           ,FUND_IN.CURRENCY_NO AS TRADE_CRNCY_IN                                  -- 轉入基金申購幣別
           ,V_FUND_IN_CRNCY.NAME AS TRADE_CRNCY_NM_IN                              -- 轉入基金申購幣別名稱
           --,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY_IN                               -- 轉入基金申購幣別
           --,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM_IN                                -- 轉入基金申購幣別名稱
           ,NVL(REDEMPTION.SWITCH_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS SWITCH_DATE -- 轉申購日期
           -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
           -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
           --                     調整「生日優惠」名稱改為促銷活動的名稱
           ,CASE WHEN REDEMPTION.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN REDEMPTION.FEE_CHOICE = '2' THEN '優惠券' || REDEMPTION.COUPON_ID
                 WHEN REDEMPTION.FEE_CHOICE = '3' THEN '紅利折抵' || REDEMPTION.USED_POINT || '點'
                 WHEN REDEMPTION.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN REDEMPTION.FEE_CHOICE IS NULL THEN '網路費率' 
                 END FEE_CHOICE                                                    -- 手續費收取方式
           ,REDEMPTION.SC_RATE                                                     -- 轉申購手續費率
           ,FUND_OUT.SHARE_DECIMAL                                                 -- 單位數小數位數
           ,'3' AS TX_TYPE                                                         -- 交易類別
           ,REDEMPTION.SER_NO                                                      -- 交易序號
           -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
           ,CASE WHEN FUND_OUT.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_OUT -- 轉出基金是否為配息
           ,FUND_OUT.DIVIDEND_FREQ AS DIVIDEND_TYPE_OUT                                     -- 轉出基金配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ_OUT.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_OUT             -- 轉出基金配息頻率名稱
           ,CASE WHEN FUND_IN.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_IN   -- 轉入基金是否為配息
           ,FUND_IN.DIVIDEND_FREQ AS DIVIDEND_TYPE_IN                                       -- 轉入基金配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ_IN.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_IN               -- 轉入基金配息頻率名稱
           ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE                                        -- 委託日期(含時分秒)
           ,0 AS WIRE_FEE                                                                   -- 郵匯費
           ,0 AS AMOUNT_OUT                                                                 -- 轉出基金淨額
           ,0 AS AMOUNT_IN                                                                  -- 轉入基金淨額
           ,TO_DATE('1900/01/01', 'YYYY/MM/DD') AS EX_DATE                                  -- 匯率日期
           ,0 AS EX_RATE                                                                    -- 匯率-交叉匯率
           ,REDEMPTION.FEE_CHOICE AS FEE_CHOICE_TYPE                                        -- 優惠方案代碼
           -- 2019.05.09 tingting 調整促銷活動名稱顯示
           -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
           ,CASE WHEN REDEMPTION.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN REDEMPTION.FEE_CHOICE = '2' THEN '優惠券' || REDEMPTION.COUPON_ID
                 WHEN REDEMPTION.FEE_CHOICE = '3' THEN '紅利折抵' || REDEMPTION.USED_POINT || '點'
                 WHEN REDEMPTION.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN REDEMPTION.FEE_CHOICE IS NULL THEN '網路費率'
                 END AS FEE_CHOICE_NAME                                                     -- 優惠方案名稱
           ,REDEMPTION.PROJECT_CODE                                                         -- 促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                                          -- 促銷活動名稱
      FROM ECS.REDEMPTION REDEMPTION
      JOIN FAS.FUND FUND_OUT
        ON FUND_OUT.FUND_NO = REDEMPTION.FUND_NO
       AND (FUND_OUT.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_OUT_SHARE_CLASS
        ON FUND_OUT_SHARE_CLASS.SHARE_CLASS = FUND_OUT.SHARE_CLASS
       -- 2018.11.01 JIANXIN 轉申購基金級別調整
       --AND (FUND_OUT_SHARE_CLASS.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
       --2018.11.06 PAN  轉申購基金級別調整
       AND FUND_OUT_SHARE_CLASS.AMC_NO = FUND_OUT.AMC_NO
      JOIN ECS.V_FUND_CRNCY V_FUND_OUT_CRNCY
        ON V_FUND_OUT_CRNCY.CURRENCY_NO = FUND_OUT.CURRENCY_NO
      JOIN FAS.FUND FUND_IN
        ON FUND_IN.FUND_NO = REDEMPTION.FUND_NO_IN
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_IN_SHARE_CLASS
        ON FUND_IN_SHARE_CLASS.SHARE_CLASS = FUND_IN.SHARE_CLASS
       AND FUND_IN_SHARE_CLASS.AMC_NO = FUND_IN.AMC_NO
      -- 2018.10.31 ChengYu 贖回列表補上計價幣別、轉申購列表補上交易幣別
      JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_FUND_IN_CRNCY
        ON V_FUND_IN_CRNCY.CURRENCY_NO = FUND_IN.CURRENCY_NO
      -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
      LEFT JOIN ECS.CAMPAIGN CAMPAIGN
        ON CAMPAIGN.CAMPAIGN_CODE = REDEMPTION.PROJECT_CODE
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_OUT -- 欄位選單資料(轉出基金配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ_OUT.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ_OUT.TEXT_VALUE = FUND_OUT.DIVIDEND_FREQ
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_IN  -- 欄位選單資料(轉入基金配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ_IN.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ_IN.TEXT_VALUE = FUND_IN.DIVIDEND_FREQ
      LEFT JOIN (
            SELECT  REDEMPTION_LOG.FUND_NO
                   ,REDEMPTION_LOG.ID
                   ,REDEMPTION_LOG.TX_DATE
                   ,REDEMPTION_LOG.BROKER_NO
                   ,REDEMPTION_LOG.BRANCH_NO
                   ,REDEMPTION_LOG.SER_NO
                   ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
              FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
             WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
             GROUP BY REDEMPTION_LOG.FUND_NO
                   ,REDEMPTION_LOG.ID
                   ,REDEMPTION_LOG.TX_DATE
                   ,REDEMPTION_LOG.BROKER_NO
                   ,REDEMPTION_LOG.BRANCH_NO
                   ,REDEMPTION_LOG.SER_NO
           ) REDEMPTION_LOG       -- EC買回異動紀錄
        ON REDEMPTION_LOG.FUND_NO = REDEMPTION.FUND_NO
       AND REDEMPTION_LOG.ID = REDEMPTION.ID
       AND REDEMPTION_LOG.TX_DATE = REDEMPTION.TX_DATE
       AND REDEMPTION_LOG.BROKER_NO = REDEMPTION.BROKER_NO
       AND REDEMPTION_LOG.BRANCH_NO = REDEMPTION.BRANCH_NO
       AND REDEMPTION_LOG.SER_NO = REDEMPTION.SER_NO
     WHERE REDEMPTION.BROKER_NO = '999'
       AND REDEMPTION.BRANCH_NO = '8300'
       AND REDEMPTION.STATUS = 'O'
       AND REDEMPTION.ID = XID
       AND (REDEMPTION.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
     ORDER BY ROW_NUM;

	--取得定期定額
	OPEN OUTDT4 FOR
    SELECT  -- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
            ROW_NUMBER() OVER(ORDER BY FIRST_TX_DATE, FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, FUND.SHARE_CLASS NULLS FIRST, FUND.ORDINAL) AS ROW_NUM   -- 排列序號
           ,RSP.FUND_NO                                                                         -- 基金代碼
           ,FUND.NAME AS FUND_NAME                                                              -- 基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                                                     -- 基金警語
           ,FUND.ISIN_CODE                                                                      -- ISIN Code
           ,FUND.SHARE_CLASS                                                                    -- 基金級別
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                           -- 基金級別名稱
           ,FUND.CURRENCY_NO                                                                    -- 計價幣別
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                                                  -- 計價幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位 風險屬性(RISK_CATEGORY)
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY                                                 -- 基金風險屬性
           -- 2018.07.15 JIANXIN 調整回傳RSP、DRSP扣款日型態
           ,RSP.AC_DAY AS AC_DAY                                                                -- 每月扣款日
           -- 2018.08.15 JIANXIN 預計首次扣款日，欄位調整
           ,NVL(RSP.EXPECTED_TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS FIRST_TX_DATE       -- 預計首次扣款日
           ,RSP.CURRENCY_NO AS TRADE_CRNCY                                                      -- 申購幣別
           ,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                                                -- 申購幣別名稱
           ,RSP.AMOUNT                                                                          -- 申購價金
           -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
           -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
           ,CASE WHEN RSP.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN RSP.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
                 WHEN RSP.FEE_CHOICE IS NULL THEN '網路費率' 
                 END FEE_CHOICE                                                                 -- 手續費收取方式
           ,RSP.SC_RATE                                                                         -- 申購手續費率
           -- 2018.10.11 JIANXIN 調整手續費計算內容
           ,ROUND(RSP.AMOUNT * RSP.SC_RATE * 0.01,V_TRADE_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE           -- 申購手續費
           ,ROUND(RSP.AMOUNT + RSP.AMOUNT * RSP.SC_RATE * 0.01,V_TRADE_CRNCY.AMT_DECIMAL) AS TOT_AMOUNT  -- 申購總價金
           ,RSP.BANK_NO                                                                         -- 扣款總行代碼
           ,RSP.BRANCH_NO AS AC_BRANCH                                                          -- 扣款分行代碼
           ,FIS_BANK.SNAME AS FIS_SNAME                                                         -- 扣款銀行簡稱
           ,RSP.AC_CODE                                                                         -- 扣款帳號
           -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
           ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5                                    -- 扣款帳號後5碼
           ,V_TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL                                      -- 申購幣別小數位數
           ,'4' AS TX_TYPE                                                                      -- 交易類別
           ,RSP.ID_SEQ || '' AS SER_NO                                                          -- 交易序號
           -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
           ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND             -- 是否為配息
           ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                                 -- 配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME                         -- 配息頻率名稱
           ,RSP_LOG.REVISION_DATE AS RCV_DATE                                                   -- 委託日期(含時分秒)
           ,RSP.FEE_CHOICE AS FEE_CHOICE_TYPE                                                   -- 優惠方案代碼
           -- 2019.05.09 tingting 調整促銷活動名稱顯示
           -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
           ,CASE WHEN RSP.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN RSP.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
                 WHEN RSP.FEE_CHOICE = '3' THEN '紅利折抵'
                 WHEN RSP.FEE_CHOICE = '5' THEN '生日優惠'
                 WHEN RSP.FEE_CHOICE IS NULL THEN '網路費率'
                 END AS FEE_CHOICE_NAME                                                         -- 優惠方案名稱
           ,RSP.PROJECT_CODE                                                                    -- 促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                                              -- 促銷活動名稱
      FROM ECS.RSP RSP
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = RSP.FUND_NO
       AND (FUND.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
       AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = RSP.CURRENCY_NO
      JOIN FAS.FIS_BANK FIS_BANK
        ON FIS_BANK.BANK_NO = RSP.BANK_NO
      -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
      LEFT JOIN ECS.CAMPAIGN CAMPAIGN
        ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
      LEFT JOIN (
            SELECT  RSP_LOG.ID
                   ,RSP_LOG.ID_SEQ
                   ,MAX(RSP_LOG.REVISION_DATE) AS REVISION_DATE 
              FROM ECS.RSP_LOG       -- EC定額異動紀錄
             WHERE RSP_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
             GROUP BY RSP_LOG.ID
                     ,RSP_LOG.ID_SEQ
           ) RSP_LOG             -- EC定額異動紀錄
        ON RSP_LOG.ID = RSP.ID
       AND RSP_LOG.ID_SEQ = RSP.ID_SEQ
     WHERE RSP.PRODUCT_TYPE = 'P8'
       -- 2018.06.17 ChengYu 回傳(定期定額)、(定期不定額)的查詢條件TX_STATUS = 'O' 改為 STATUS = '1'
       AND RSP.STATUS = '1'
       AND RSP.ID = XID
       AND (RSP.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
     ORDER BY ROW_NUM;

	--取得定期不定額
	OPEN OUTDT5 FOR
    SELECT  -- 2018.10.25 tingting 增加傳出欄位：排列序號(先依交易日期，再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)編號)
            ROW_NUMBER() OVER(ORDER BY FIRST_TX_DATE, FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, FUND.SHARE_CLASS NULLS FIRST, FUND.ORDINAL) AS ROW_NUM   -- 排列序號
           ,RSP.FUND_NO                                                                         -- 基金代碼
           ,FUND.NAME AS FUND_NAME                                                              -- 基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                                                     -- 基金警語
           ,FUND.ISIN_CODE                                                                      -- ISIN Code
           ,FUND.SHARE_CLASS                                                                    -- 基金級別
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                           -- 基金級別名稱
           ,FUND.CURRENCY_NO                                                                    -- 計價幣別
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                                                  -- 計價幣別名稱
           -- 2018.10.09 ChengYu 新增傳出欄位 風險屬性(RISK_CATEGORY)
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY                                                 -- 基金風險屬性
           -- 2018.07.15 JIANXIN 調整回傳RSP、DRSP扣款日型態
           ,RSP.AC_DAY AS AC_DAY                                                                -- 每月扣款日
           -- 2018.08.15 JIANXIN 預計首次扣款日，欄位調整
           ,NVL(RSP.EXPECTED_TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS FIRST_TX_DATE       -- 預計首次扣款日
           ,RSP.CURRENCY_NO AS TRADE_CRNCY                                                      -- 申購幣別
           ,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                                                -- 申購幣別名稱
           ,RSP.AMOUNT                                                                          -- 申購價金
           -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
           -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
           ,CASE WHEN RSP.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN RSP.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
                 WHEN RSP.FEE_CHOICE IS NULL THEN '網路費率' 
                 END FEE_CHOICE                                                                 -- 手續費收取方式
           ,RSP.SC_RATE                                                                         -- 申購手續費率
           -- 2018.10.11 JIANXIN 調整手續費計算內容
           ,ROUND(RSP.AMOUNT * RSP.SC_RATE * 0.01,V_TRADE_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE           -- 申購手續費
           ,ROUND(RSP.AMOUNT + RSP.AMOUNT * RSP.SC_RATE * 0.01,V_TRADE_CRNCY.AMT_DECIMAL) AS TOT_AMOUNT  -- 申購總價金
           ,RSP.BANK_NO                                                                         -- 扣款總行代碼
           ,RSP.BRANCH_NO AS AC_BRANCH                                                          -- 扣款分行代碼
           ,FIS_BANK.SNAME AS FIS_SNAME                                                         -- 扣款銀行簡稱
           ,RSP.AC_CODE                                                                         -- 扣款帳號
           -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
           ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5                                    -- 扣款帳號後5碼
           -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須 * 100
           ,ROUND(RSP.RAISE_ROI * 100 , 2) AS RAISE_ROI                                         -- 加碼點(%)
           ,ROUND(RSP.RAISE_AMOUNT,V_TRADE_CRNCY.AMT_DECIMAL) AS RAISE_AMOUNT                   -- 加碼金額
           -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須 * 100
           ,ROUND(RSP.REDUCE_ROI * 100 , 2) AS REDUCE_ROI                                       -- 減碼點(%)
           ,ROUND(RSP.REDUCE_AMOUNT,V_TRADE_CRNCY.AMT_DECIMAL) AS REDUCE_AMOUNT                 -- 減碼金額
           ,V_TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL                                      -- 申購幣別小數位數
           ,'5' AS TX_TYPE                                                                      -- 交易類別
           ,RSP.ID_SEQ || '' AS SER_NO                                                          -- 交易序號
           -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
           ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND             -- 是否為配息
           ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                                 -- 配息頻率
           ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME                         -- 配息頻率名稱
           ,RSP.REVISION_DATE AS RCV_DATE                                                       -- 委託日期(含時分秒)
           ,RSP.FEE_CHOICE AS FEE_CHOICE_TYPE                                                   -- 優惠方案代碼
           -- 2019.05.09 tingting 調整促銷活動名稱顯示
           -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
           ,CASE WHEN RSP.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                 WHEN RSP.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
                 WHEN RSP.FEE_CHOICE = '3' THEN '紅利折抵'
                 WHEN RSP.FEE_CHOICE = '5' THEN '生日優惠'
                 WHEN RSP.FEE_CHOICE IS NULL THEN '網路費率'
                 END AS FEE_CHOICE_NAME                                                         -- 優惠方案名稱
           ,RSP.PROJECT_CODE                                                                    -- 促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                                              -- 促銷活動名稱
      FROM ECS.RSP RSP
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = RSP.FUND_NO
       AND (FUND.AMC_NO = XAMC_NO OR XAMC_NO = 'ALL')
      LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
       AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
      JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
        ON V_TRADE_CRNCY.CURRENCY_NO = RSP.CURRENCY_NO
      JOIN FAS.FIS_BANK FIS_BANK
        ON FIS_BANK.BANK_NO = RSP.BANK_NO
      -- 2018.08.15 JIANXIN 促銷活動處理名稱串接
      LEFT JOIN ECS.CAMPAIGN CAMPAIGN
        ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
      LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
        ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
       AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
      LEFT JOIN (
            SELECT  RSP_LOG.ID
                   ,RSP_LOG.ID_SEQ
                   ,MAX(RSP_LOG.REVISION_DATE) AS REVISION_DATE 
              FROM ECS.RSP_LOG       -- EC定額異動紀錄
             WHERE RSP_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
             GROUP BY RSP_LOG.ID
                     ,RSP_LOG.ID_SEQ
           ) RSP_LOG             -- EC定額異動紀錄
        ON RSP_LOG.ID = RSP.ID
       AND RSP_LOG.ID_SEQ = RSP.ID_SEQ
     WHERE RSP.PRODUCT_TYPE = 'P9'
       -- 2018.06.17 ChengYu 回傳(定期定額)、(定期不定額)的查詢條件TX_STATUS = 'O' 改為 STATUS = '1'
       AND RSP.STATUS = '1'
       AND RSP.ID = XID
       AND (RSP.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
     ORDER BY ROW_NUM;

END s_GetCancelData;

/

  GRANT EXECUTE ON "ECS"."S_GETCANCELDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETCOUNTRY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETCOUNTRY" 
(
    OUTDT          OUT SYS_REFCURSOR         -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
        SELECT COUNTRY.COUNTRY_CODE          --國家代碼
               ,COUNTRY.COUNTRY_CODE1        --FATCA國籍代號
               ,COUNTRY.NAME AS COUNTRY_NM   --國家全名
               ,COUNTRY.PHONE_CODE           --國際電話代碼
          FROM FAS.COUNTRY COUNTRY
          WHERE COUNTRY.LIST_TYPE = 'Y'
         ORDER BY COUNTRY.COUNTRY_CODE;
END s_GetCountry;

/

  GRANT EXECUTE ON "ECS"."S_GETCOUNTRY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETCOUPONDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETCOUPONDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/04/10
-- Description: 取得紅利積點資料
-- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
-- 2018.07.18 ChengYu 調整 適用交易別、使用交易別 顯示方式
-- 2020.04.14 ChengYu 調整USE_TYPE(使用代碼)名稱
-- =============================================
(
     WACCOUNT_NO            INTEGER,                -- 受益人戶號
     WTX_DATE               DATE,                   -- 交易日期
     OUTDT                  OUT SYS_REFCURSOR,      -- MASTER
     OUTDT1                 OUT SYS_REFCURSOR,      -- 可使用清單
     OUTDT2                 OUT SYS_REFCURSOR,      -- 已使用清單
     OUTDT3                 OUT SYS_REFCURSOR       -- 已逾期清單
) IS

XQUERY_DATE DATE;          -- 查詢日期
XID VARCHAR2(10);          -- 受益人ID
XGETCOUPONQTY INTEGER;     -- 可使用優惠券張數
XUSEDCOUPONQTY INTEGER;    -- 已使用優惠券張數
XEXPIREDCOUPONQTY INTEGER; -- 已逾期優惠券張數
-- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
XDATE_FROM DATE;           -- 查詢日期(起)
BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID              -- 受益人ID
      INTO XID       
      FROM FAS.HOLDER      -- 受益人基本資料
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  -- 取得查詢日期
  IF WTX_DATE <= TO_DATE('1900/01/01','YYYY/MM/DD') THEN

    XQUERY_DATE := TRUNC(SYSDATE);

  ELSE  

    XQUERY_DATE := WTX_DATE;
    -- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
    XDATE_FROM := ADD_MONTHS(WTX_DATE, -12);       
  END IF;


  SELECT COUNT(1) AS USEABLE_COUNT -- 可使用優惠券張數
    INTO XGETCOUPONQTY
    FROM ECS.COUPON_DATA COUPON_DATA -- 優惠券配發資料
   WHERE COUPON_DATA.ID = XID
     AND XQUERY_DATE >= COUPON_DATA.VALID_FROM
     AND XQUERY_DATE <= COUPON_DATA.VALID_THRU
     AND COUPON_DATA.IS_EFFECT = 'Y';

  SELECT COUNT(1) AS USED_COUNT    -- 已使用優惠券張數
    INTO XUSEDCOUPONQTY
    FROM ECS.COUPON_DATA COUPON_DATA -- 優惠券配發資料
   WHERE COUPON_DATA.ID = XID
     AND COUPON_DATA.IS_EFFECT = 'N'
     AND COUPON_DATA.USED_DATE <= XQUERY_DATE
     -- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
     AND COUPON_DATA.VALID_THRU >= XDATE_FROM;

  SELECT COUNT(1) AS OVERDUE_COUNT -- 已逾期優惠券張數
    INTO XEXPIREDCOUPONQTY
    FROM ECS.COUPON_DATA COUPON_DATA -- 優惠券配發資料
   WHERE COUPON_DATA.ID = XID
     AND COUPON_DATA.IS_EFFECT ='Y'
     AND COUPON_DATA.USED_DATE IS NULL
     AND COUPON_DATA.VALID_THRU <= XQUERY_DATE
     -- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
     AND COUPON_DATA.VALID_THRU >= XDATE_FROM;

  -- MASTER
	OPEN OUTDT FOR
      SELECT  XGETCOUPONQTY AS GETCOUPONQTY            -- 可使用優惠券張數
             ,XUSEDCOUPONQTY AS USEDCOUPONQTY          -- 已使用優惠券張數
             ,XEXPIREDCOUPONQTY AS EXPIREDCOUPONQTY    -- 已逾期優惠券張數
        FROM DUAL;

  -- 可使用清單
  OPEN OUTDT1 FOR
       SELECT  COUPON_DATA.PROGRAM_NO                  -- 優惠券代碼
              ,COUPON_PROGRAM.NAME AS PROGRAM_NAME     -- 優惠券名稱
              ,COUPON_DATA.ISSUE_DATE                  -- 發送日期(可使用)
              ,COUPON_DATA.COUPON_ID                   -- 優惠券序號(可使用)
              ,COUPON_DATA.VALID_THRU                  -- 使用期限(可使用)
              -- 2018.07.18 ChengYu 調整 適用交易別、使用交易別 顯示方式
              ,CASE WHEN INSTR(COUPON_DATA.TX_TYPE,'1') > 0 THEN '單筆申購'                    
                    ELSE ''
               END ||
               CASE WHEN INSTR(COUPON_DATA.TX_TYPE,'1') > 0 AND INSTR(COUPON_DATA.TX_TYPE,'2') > 0 THEN '/轉申購'
                    WHEN INSTR(COUPON_DATA.TX_TYPE,'2') > 0 THEN '轉申購'
                    ELSE ''
               END || 
               CASE WHEN (INSTR(COUPON_DATA.TX_TYPE,'1') > 0 OR INSTR(COUPON_DATA.TX_TYPE,'2') > 0) AND INSTR(COUPON_DATA.TX_TYPE,'3') > 0 THEN '/定期定額/定期不定額'                 
                    WHEN INSTR(COUPON_DATA.TX_TYPE,'3') > 0 THEN '定期定額/定期不定額'
                    ELSE ''
               END AS APPLY_TYPE                       -- 適用交易別(可使用)
         FROM ECS.COUPON_DATA COUPON_DATA              -- 優惠券配發資料
         LEFT JOIN ECS.COUPON_PROGRAM COUPON_PROGRAM   -- 優惠券活動資料
           ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO
        WHERE COUPON_DATA.ID = XID
          AND XQUERY_DATE >= COUPON_DATA.VALID_FROM
          AND XQUERY_DATE <= COUPON_DATA.VALID_THRU
          AND COUPON_DATA.IS_EFFECT = 'Y';

  -- 已使用清單       
  OPEN OUTDT2 FOR
  SELECT  COUPON_DATA.PROGRAM_NO                 -- 優惠券代碼
         ,COUPON_PROGRAM.NAME AS PROGRAM_NAME    -- 優惠券名稱
         ,COUPON_DATA.COUPON_ID                  -- 優惠券序號(已使用)
         ,COUPON_DATA.USED_DATE                  -- 使用日期(已使用)
         -- 2018.07.18 ChengYu 調整 適用交易別、使用交易別 顯示方式
         -- 2020.04.14 ChengYu 調整USE_TYPE(使用代碼)名稱
         ,CASE WHEN COUPON_DATA.USE_TYPE = '1' THEN '單筆申購'
               WHEN COUPON_DATA.USE_TYPE = '2' THEN '定期定額'
               WHEN COUPON_DATA.USE_TYPE = '3' THEN '定期不定額'
               WHEN COUPON_DATA.USE_TYPE = '4' THEN '轉申購' 
               ELSE ''
          END AS USE_TYPE                        -- 使用交易別(已使用)
    FROM ECS.COUPON_DATA COUPON_DATA             -- 優惠券配發資料
    LEFT JOIN ECS.COUPON_PROGRAM COUPON_PROGRAM  -- 優惠券活動資料
      ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO
   WHERE COUPON_DATA.ID = XID
     AND COUPON_DATA.IS_EFFECT = 'N'
     AND COUPON_DATA.USED_DATE <= XQUERY_DATE
     -- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
     AND COUPON_DATA.VALID_THRU >= XDATE_FROM;

  -- 已逾期清單
  OPEN OUTDT3 FOR
	SELECT  COUPON_DATA.PROGRAM_NO              -- 優惠券代碼
         ,COUPON_PROGRAM.NAME AS PROGRAM_NAME -- 優惠券名稱
         ,COUPON_DATA.ISSUE_DATE              -- 配發日期(已逾期)         
         ,COUPON_DATA.COUPON_ID               -- 優惠券序號(已逾期)
         ,COUPON_DATA.VALID_THRU              -- 截止日(已逾期)        
         -- 2018.07.18 ChengYu 調整 適用交易別、使用交易別 顯示方式                 
         ,CASE WHEN INSTR(COUPON_DATA.TX_TYPE,'1') > 0 THEN '單筆申購'                    
                    ELSE ''
          END ||
          CASE WHEN INSTR(COUPON_DATA.TX_TYPE,'1') > 0 AND INSTR(COUPON_DATA.TX_TYPE,'2') > 0 THEN '/轉申購'
               WHEN INSTR(COUPON_DATA.TX_TYPE,'2') > 0 THEN '轉申購'
               ELSE ''
          END || 
          CASE WHEN (INSTR(COUPON_DATA.TX_TYPE,'1') > 0 OR INSTR(COUPON_DATA.TX_TYPE,'2') > 0) AND INSTR(COUPON_DATA.TX_TYPE,'3') > 0 THEN '/定期定額/定期不定額'                 
               WHEN INSTR(COUPON_DATA.TX_TYPE,'3') > 0 THEN '定期定額/定期不定額'
               ELSE ''
          END AS APPLY_TYPE                     -- 適用交易別(已逾期)
    FROM ECS.COUPON_DATA COUPON_DATA            -- 優惠券配發資料
    LEFT JOIN ECS.COUPON_PROGRAM COUPON_PROGRAM -- 優惠券活動資料
      ON COUPON_PROGRAM.PROGRAM_NO = COUPON_DATA.PROGRAM_NO 
   WHERE COUPON_DATA.ID = XID
     AND COUPON_DATA.IS_EFFECT ='Y'
     AND COUPON_DATA.USED_DATE IS NULL
     AND COUPON_DATA.VALID_THRU <= XQUERY_DATE
     -- 2018.05.24 ChengYu 調整 已使用、已逾期的WHERE條件
     AND COUPON_DATA.VALID_THRU >= XDATE_FROM;

END s_GetCouponData;

/

  GRANT EXECUTE ON "ECS"."S_GETCOUPONDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETCURRENCY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETCURRENCY" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得基金幣別
-- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
     WIS_ALL        VARCHAR2,                -- 是否需要全部的選項
     OUTDT          OUT SYS_REFCURSOR        -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
     SELECT CURRENCY.*
       FROM
            (
             -- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
             SELECT  DISTINCT FUND.CURRENCY_NO                               --幣別
                    ,NVL(V_FUND_CRNCY.NAME,FUND.CURRENCY_NO) AS NAME         --名稱
               FROM FAS.FUND
               LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
                 ON FUND.CURRENCY_NO = V_FUND_CRNCY.CURRENCY_NO
              WHERE FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
                AND ( FUND.SALES_TYPE = '0')
                -- 2019.02.19 tingting 調整已清算基金條件語法
                AND (
                      -- 境內基金清算日期判斷 CLEAR_DATE
                      (     
                        FUND.FUND_CATEGORY = '1' 
                        AND  
                        (
                          (FUND.CLEAR_DATE IS NULL) 
                          OR 
                          (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                        )
                      )              
                      OR
                      -- 境外基金清算日期判斷 ELIMINATION_DATE
                      (     
                        FUND.FUND_CATEGORY = '2' 
                        AND  
                        (
                          (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                          OR 
                          (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                          OR 
                          (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                        )
                      )
                    )
                AND (  IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
              UNION
             SELECT 'ALL'     AS CURRENCY_NO
                    ,'全部'   AS NAME
               FROM DUAL
              WHERE WIS_ALL = 'Y'
             ) CURRENCY
       ORDER BY DECODE(CURRENCY.CURRENCY_NO,'ALL',1),CURRENCY.CURRENCY_NO;

END s_GetCurrency;

/

  GRANT EXECUTE ON "ECS"."S_GETCURRENCY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETCUSTOMTODOGROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETCUSTOMTODOGROUP" 
(
    v_FunctionID  IN NVARCHAR2 DEFAULT NULL, 
    v_EVAAction  IN NVARCHAR2 DEFAULT NULL,
    cv_1 IN OUT SYS_REFCURSOR
)
AS
BEGIN
  OPEN cv_1 FOR
  Select Distinct AA_DeptGroup.GroupID, '' DeptID, '' GroupType From AA_DeptGroup
Inner Join 

  AA_GroupRight GRToDo
		ON AA_DeptGroup.GroupID = GRToDo.GroupID
		AND GRToDo.FunctionID = v_FunctionID
        AND 
          (
            ( v_EVAAction = 'V' And AA_DeptGroup.GroupType = 'V'  And GRToDo.IsVerify = 1 ) OR
            ( v_EVAAction = 'A' And AA_DeptGroup.GroupType = 'A'  And GRToDo.IsApprove = 1 ) OR
            ( v_EVAAction = 'E' And AA_DeptGroup.GroupType = 'E'  And (
																			    GRToDo.IsExecute = 1 
																			OR  GRToDo.IsAdd     = 1 
																			OR  GRToDo.IsUpdate  = 1 
																			OR  GRToDo.IsDelete  = 1 
																	      )
																							  ) OR

            ( v_EVAAction = 'R' And AA_DeptGroup.GroupType = 'E')

           )
Inner Join 
AA_Group GRP
		on GRP.GroupID = AA_DeptGroup.GroupID

 Where ( v_EVAAction = 'V' And AA_DeptGroup.GroupType = 'V' ) OR 
       ( v_EVAAction = 'A' And AA_DeptGroup.GroupType = 'A' ) OR
       ( v_EVAAction = 'E' And AA_DeptGroup.GroupType = 'E' ) OR
       ( v_EVAAction = 'R' And AA_DeptGroup.GroupType = 'E' );
END S_GETCUSTOMTODOGROUP;

/

  GRANT EXECUTE ON "ECS"."S_GETCUSTOMTODOGROUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDATAPERMISSION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDATAPERMISSION" 
(
  v_striEntryID IN VARCHAR2 DEFAULT NULL ,-- 本筆資料的最後輸入者,
  v_striUserID IN VARCHAR2 DEFAULT NULL ,-- 本次操作的使用者,
  v_striFunctionID IN VARCHAR2 DEFAULT NULL ,-- 功能代碼,
  v_striUpdID IN VARCHAR2 DEFAULT NULL ,-- 本筆資料的最後修改者,
  v_striStatus IN VARCHAR2 DEFAULT NULL ,-- 本筆資料的狀態,
  v_intiIsValidateEntry IN INTEGER DEFAULT NULL ,-- 修改,刪除時是否考慮Entry權限,
  v_intiIsFromVerify IN INTEGER DEFAULT NULL ,-- 最後修改者動作為驗證,
  v_intiIsReport IN INTEGER DEFAULT NULL ,
  P_RESULTSET   OUT SYS_REFCURSOR
)
AS
  m_v_striEntryID varchar2(11) := v_striEntryID;
  m_v_striUserID varchar2(11) := v_striUserID;

   v_intIsVerifyGp NUMBER(10,0);
   v_intIsApproveGp NUMBER(10,0);
   v_intIsEntryGp NUMBER(10,0);
   v_intIsAdd NUMBER(10,0);
   v_intIsUpdate NUMBER(10,0);
   v_intIsDelete NUMBER(10,0);
   v_intIsVerify NUMBER(10,0);
   v_intIsApprove NUMBER(10,0);
   v_tempIsA NUMBER(10,0);

   v_temp NUMBER(1, 0) := 0;

-- 列印時的當場放行權限判斷
BEGIN
   v_intIsVerifyGp := 0 ;
   v_intIsApproveGp := 0 ;
   v_intIsEntryGp := 0 ;
   v_intIsAdd := 0 ;
   v_intIsUpdate := 0 ;
   v_intIsDelete := 0 ;
   v_intIsVerify := 0 ;
   v_intIsApprove := 0 ;
   --檢核傳入參數
   IF ( v_striEntryID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：EntryID不可為NULL，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striEntryID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：EntryID不可為空白，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striUserID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：UserID不可為NULL，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striUserID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：UserID不可為空白，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striFunctionID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：FunctionID不可為NULL，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striFunctionID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：FunctionID不可為空白，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striUpdID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：UpdID不可為NULL，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striUpdID IS NULL ) THEN

   BEGIN
      RAISE_APPLICATION_ERROR( -20002, 's_GetDataPermission：UpdID不可為空白，請檢查' );
      RETURN;
   END;
   END IF;

   --若EntryID已被停用、刪除或不存在，則取UserID原本的權限取代
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE NOT EXISTS ( SELECT *
                          FROM AA_USER 
                           WHERE DeputyID = m_v_striEntryID
                                   AND BanMark = 1 );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN

   BEGIN
      m_v_striEntryID := m_v_striUserID ;
   END;
   END IF; 


   BEGIN
      -- 則將EVA的權限取出
      -- 規則 : 若有所屬的任意一部門群組具有 Approve 的權限 , 則此操作者具備了此筆資料的Approve權限
      SELECT SUM(IsV),
             SUM(IsA),
             SUM(IsE),
             SUM(IsAdd),
             SUM(IsUpdate),
             SUM(IsDelete),
             SUM(IsVerify),
             SUM(IsApprove)

        INTO v_intIsVerifyGp,
             v_intIsApproveGp,
             v_intIsEntryGp,
             v_intIsAdd,
             v_intIsUpdate,
             v_intIsDelete,
             v_intIsVerify,
             v_intIsApprove
        FROM ( SELECT SUM(LoginEVA.IsE) IsE,
                      SUM(LoginEVA.IsV) IsV,
                      SUM(LoginEVA.IsA) IsA,
                      SUM(LoginEVA.IsAdd) IsAdd,
                      SUM(LoginEVA.IsUpdate) IsUpdate,
                      SUM(LoginEVA.IsDelete) IsDelete,
                      SUM(LoginEVA.IsVerify) IsVerify,
                      SUM(LoginEVA.IsApprove) IsApprove
               FROM ( SELECT *
                      FROM TABLE(cast(FN_GetEVA(v_striEntryID, v_striFunctionID) as t_fn_geteva_table) ) 
                       WHERE ( v_intiIsReport = 1 )
                               OR ( v_intiIsReport = 0
                               AND IsE = 1 ) ) UpdEVA-- Entry 者在哪些部門有 Entry 此程式的權限

                      JOIN ( SELECT *
                             FROM TABLE(FN_GetDeptGroupRight(v_striUserID, v_striFunctionID))  ) LoginEVA-- Login 者是否在該部門具有 E/V/A 權限

                       ON UpdEVA.DeptID = LoginEVA.DeptID
                 GROUP BY LoginEVA.DeptID,LoginEVA.GroupID,LoginEVA.GroupType
               UNION-- 當修改,刪除不考慮Entry權限時

               SELECT 0 IsE,
                      0 IsV,
                      0 IsA,
                      0 IsAdd,
                      SUM(LoginEVA.IsUpdate) IsUpdate,
                      SUM(LoginEVA.IsDelete) IsDelete,
                      0 IsVerify,
                      0 IsApprove
               FROM ( SELECT *
                      FROM TABLE(FN_GetDeptGroupRight(v_striUserID, v_striFunctionID)) 
                       WHERE v_intiIsValidateEntry = 0
                               OR IsValidateEntry = 0 ) LoginEVA-- Login 者是否在該部門具有 E/V/A 權限               

                 GROUP BY LoginEVA.DeptID,LoginEVA.GroupID,LoginEVA.GroupType ) EVA;
      IF ( v_intIsVerifyGp > 0 ) THEN
         v_intIsVerifyGp := 1 ;
      END IF;
      IF ( v_intIsApproveGp > 0 ) THEN
         v_intIsApproveGp := 1 ;
      END IF;
      IF ( v_intIsEntryGp > 0 ) THEN
         v_intIsEntryGp := 1 ;
      END IF;
      IF ( v_intIsAdd > 0 ) THEN
         v_intIsAdd := 1 ;
      END IF;
      IF ( v_intIsUpdate > 0 ) THEN
         v_intIsUpdate := 1 ;
      END IF;
      IF ( v_intIsDelete > 0 ) THEN
         v_intIsDelete := 1 ;
      END IF;
      IF ( v_intIsVerify > 0 ) THEN
         v_intIsVerify := 1 ;
      END IF;
      IF ( v_intIsApprove > 0 ) THEN
         v_intIsApprove := 1 ;
      END IF;
   -- 若最後修改者和本次操作者具有共同所屬的部門群組,
   END;
   -- 若最後修改者為自己,則無 驗證/覆核權限
   IF ( SUBSTR(v_striStatus, 1, 1) = '1' ) THEN

   --- 待驗證
   BEGIN
      IF ( v_striEntryID = v_striUserID ) THEN

      BEGIN
         v_intIsVerify := 0 ;
         v_intIsApprove := 0 ;
      END;
      END IF;
   END;
   ELSE
      IF ( SUBSTR(v_striStatus, 1, 1) = '2' ) THEN

      --- 待覆核
      BEGIN
         IF ( v_intiIsFromVerify = 1 ) THEN

         BEGIN
            --IF ((@striUpdID = @striUserID) OR (@striEntryID = @striUserID) )
            IF ( v_striUpdID = v_striUserID ) THEN


            --最後修改者動作為驗證
            BEGIN
               v_intIsVerify := 0 ;
               v_intIsApprove := 0 ;
            END;
            END IF;
         END;
         ELSE

         BEGIN
            IF ( v_striEntryID = v_striUserID ) THEN


            --最後修改者動作不為驗證(為輸入或重送)
            BEGIN
               v_intIsVerify := 0 ;
               v_intIsApprove := 0 ;
            END;
            END IF;
         END;
         END IF;
      END;
      ELSE
         IF ( SUBSTR(v_striStatus, 1, 1) = '3'
           OR v_striStatus IS NULL ) THEN

         --- 已覆核(當場放行需判斷)
         BEGIN
            IF ( v_striEntryID = v_striUserID ) THEN


            --最後修改者動作不為驗證(為輸入或重送)
            BEGIN
               v_intIsVerify := 0 ;
               v_intIsApprove := 0 ;
            END;
            END IF;
         END;
         END IF;
      END IF;
   END IF;
   OPEN P_RESULTSET FOR
      SELECT NVL(v_intIsVerifyGp, 0) IsVerifyGp,
             NVL(v_intIsApproveGp, 0) IsApproveGp,
             NVL(v_intIsEntryGp, 0) IsEntryGp,
             NVL(v_intIsAdd, 0) IsAdd,
             NVL(v_intIsUpdate, 0) IsUpdate,
             NVL(v_intIsDelete, 0) IsDelete,
             NVL(v_intIsVerify, 0) IsVerify,
             NVL(v_intIsApprove, 0) IsApprove
        FROM DUAL ;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETDATAPERMISSION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDEBITACCOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDEBITACCOUNT" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/04/16
-- Description: 取得申購基金扣款帳號列表
-- 2018.04.19 ChengYu 調整傳入幣別為MMA或FCY的條件
-- 2018.04.20 ChengYu 刪除DISTINCT、修正條件
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.09.27 YungLong 新增傳出欄位FIS_SEAL_DATE、PER_PUR_AMOUNT_BYACT
-- 2018.12.20 JIANXIN MOD BY 取得點對點的扣款帳號、調整寫法
-- 2019.02.27 yunchu 調整抓取MMA或FCY資料的判斷條件
-- 2019.03.13 JIANXIN MOD BY 分階層需增加括號
-- 2019.03.14 JIANXIN MOD BY 瑞萬基金取得帳號必須增加條件
-- 2020.04.07 ChengYu 調整取扣款帳號條件，外幣也能使用MMA帳號、修正綜合帳戶條件
-- =============================================
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     WDEPOSITORY_CRNCY      VARCHAR2,          -- 帳戶保管平台代號及申購幣別
     WFUND_NO               VARCHAR2:='',      -- 基金代碼
     WISIN_CODE             VARCHAR2:='',      -- 國際證券代碼
     OUTDT                  OUT SYS_REFCURSOR  -- 扣款帳號列表
) IS

XID      VARCHAR2(10);            -- 受益人ID
-- 2018.12.20 JIANXIN MOD BY 取得點對點的扣款帳號
XFUND_NO VARCHAR2(10);            -- 基金代碼

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');
  END;


  --取得FUND_NO
  -- 2018.12.20 JIANXIN MOD BY 取得點對點的扣款帳號
  BEGIN
      SELECT FUND.FUND_NO 
        INTO XFUND_NO 
        FROM FAS.FUND FUND
       WHERE FUND.FUND_NO = WFUND_NO;

      EXCEPTION
          WHEN NO_DATA_FOUND THEN
          BEGIN
              SELECT FUND.FUND_NO 
                INTO XFUND_NO 
                FROM FAS.FUND FUND
               WHERE FUND.ISIN_CODE = WISIN_CODE;

              EXCEPTION
                  -- 2018.12.20 JIANXIN MOD BY 為了前一版與後一版能夠並存，則先暫時以NULL處理
                  WHEN NO_DATA_FOUND THEN XFUND_NO:= NULL;
                      --RAISE_APPLICATION_ERROR(-20000, ' 無法取得基金代碼，請檢查！');
          END;
  END;


  OPEN OUTDT FOR
      -- 抓取MMA或FCY資料
      -- 2018.04.20 ChengYu 刪除DISTINCT、修正條件
      SELECT  HOLDER_BANK_EC.AC_BANK AS BANK_NO             -- 往來總行代碼
             ,HOLDER_BANK_EC.AC_BRANCH AS BRANCH_NO         -- 往來分行代碼
             ,HOLDER_BANK_EC.FIS_SNAME AS FIS_SNAME         -- 往來銀行簡稱
             ,HOLDER_BANK_EC.AC_CODE AS AC_CODE             -- 往來帳號
             ,HOLDER_BANK_EC.AC_NAME AS AC_NAME             -- 帳號戶名
             -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
             ,ECS.FN_STUFF_STR(HOLDER_BANK_EC.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
             ,HOLDER_BANK_EC.CURRENCY_NO AS CURRENCY_NO     -- 往來帳戶幣別
             ,HOLDER_BANK_EC.DEPOSITORY_NO AS DEPOSITORY_NO -- 帳戶保管平台代號
             -- 2018.09.27 YungLong 新增傳出欄位FIS_SEAL_DATE、PER_PUR_AMOUNT_BYACT
             ,CASE WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' 
                   THEN HOLDER_BANK_EC.VERIFIED
                   ELSE TO_DATE('1900/01/01','YYYY/MM/DD') END AS FIS_SEAL_DATE   -- 核印完成日期
             ,CASE WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' AND HOLDER_BANK_EC.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE
                   THEN SYSTEM_PARAMETER.PER_PUR_AMOUNT_BYACT1
                   WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' AND HOLDER_BANK_EC.VERIFIED >= SYSTEM_PARAMETER.FIS_SEAL_DATE
                   THEN SYSTEM_PARAMETER.PER_PUR_AMOUNT_BYACT2 ELSE 0 END AS PER_PUR_AMOUNT_BYACT   -- 同客戶同扣款日同銀行帳戶單筆申購金額上限
        FROM FAS.HOLDER_BANK_EC HOLDER_BANK_EC
        -- 以','分行、';'分欄位拆成Table
        -- 2018.12.20 JIANXIN MOD BY 調整寫法
        JOIN (SELECT  LINE.VALUE1 AS DEBIT_ID
                     ,LINE.VALUE2 AS TRADE_CRNCY
                FROM ((TABLE(ECS.F_FormatStringListToTable(WDEPOSITORY_CRNCY)))
                     )LINE
             )DEPOSITORY_CRNCY
          ON HOLDER_BANK_EC.DEPOSITORY_NO = DEPOSITORY_CRNCY.DEBIT_ID 
         -- 2020.04.07 ChengYu 調整取扣款帳號條件，外幣也能使用MMA帳號、修正綜合帳戶條件
         AND (
              (HOLDER_BANK_EC.CURRENCY_NO = 'MMA')
              OR 
              (DEPOSITORY_CRNCY.TRADE_CRNCY != 'NTD' AND HOLDER_BANK_EC.CURRENCY_NO = 'FCY')
             )             
       --2018.09.27 YungLong JOIN SYSTEM_PARAMETER
       -- 2018.12.20 JIANXIN MOD BY 調整寫法
       CROSS JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER
       WHERE HOLDER_BANK_EC.ID = XID
         AND HOLDER_BANK_EC.VERIFIED IS NOT NULL    
         -- 2020.04.07 ChengYu 調整取扣款帳號條件，外幣也能使用MMA帳號、修正綜合帳戶條件     
         AND (   XFUND_NO IS NULL  
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) != '04') 
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '1') 
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '04' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '2' )
             )
       UNION 
       -- 抓取符合傳入幣別的資料
       -- 2018.04.20 ChengYu 刪除DISTINCT、修正條件
       SELECT HOLDER_BANK_EC.AC_BANK AS BANK_NO             -- 往來總行代碼
             ,HOLDER_BANK_EC.AC_BRANCH AS BRANCH_NO         -- 往來分行代碼
             ,HOLDER_BANK_EC.FIS_SNAME AS FIS_SNAME         -- 往來銀行簡稱
             ,HOLDER_BANK_EC.AC_CODE AS AC_CODE             -- 往來帳號
             ,HOLDER_BANK_EC.AC_NAME AS AC_NAME             -- 帳號戶名
             -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
             ,ECS.FN_STUFF_STR(HOLDER_BANK_EC.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
             ,HOLDER_BANK_EC.CURRENCY_NO AS CURRENCY_NO     -- 往來帳戶幣別
             ,HOLDER_BANK_EC.DEPOSITORY_NO AS DEPOSITORY_NO -- 帳戶保管平台代號
             -- 2018.09.27 YungLong 新增傳出欄位FIS_SEAL_DATE、PER_PUR_AMOUNT_BYACT
             ,CASE WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' THEN HOLDER_BANK_EC.VERIFIED
                   ELSE TO_DATE('1900/01/01','YYYY/MM/DD') END AS FIS_SEAL_DATE   -- 核印完成日期
             ,CASE WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' AND HOLDER_BANK_EC.VERIFIED < SYSTEM_PARAMETER.FIS_SEAL_DATE
                   THEN SYSTEM_PARAMETER.PER_PUR_AMOUNT_BYACT1
                   WHEN HOLDER_BANK_EC.DEPOSITORY_NO = '01' AND HOLDER_BANK_EC.VERIFIED >= SYSTEM_PARAMETER.FIS_SEAL_DATE
                   THEN SYSTEM_PARAMETER.PER_PUR_AMOUNT_BYACT2 ELSE 0 END AS PER_PUR_AMOUNT_BYACT   -- 同客戶同扣款日同銀行帳戶單筆申購金額上限
        FROM FAS.HOLDER_BANK_EC HOLDER_BANK_EC
        -- 以','分行、';'分欄位拆成Table
        -- 2018.12.20 JIANXIN MOD BY 調整寫法
        JOIN (SELECT  LINE.VALUE1 AS DEBIT_ID
                     ,LINE.VALUE2 AS TRADE_CRNCY
                FROM ((TABLE(ECS.F_FormatStringListToTable(WDEPOSITORY_CRNCY)))
                     )LINE
             )DEPOSITORY_CRNCY
          ON HOLDER_BANK_EC.DEPOSITORY_NO = DEPOSITORY_CRNCY.DEBIT_ID 
         AND HOLDER_BANK_EC.CURRENCY_NO = DEPOSITORY_CRNCY.TRADE_CRNCY
       --2018.09.27 YungLong JOIN SYSTEM_PARAMETER
       -- 2018.12.20 JIANXIN MOD BY 調整寫法
       CROSS JOIN ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER
       WHERE HOLDER_BANK_EC.ID = XID
         AND HOLDER_BANK_EC.VERIFIED IS NOT NULL
         -- 2018.12.20 JIANXIN MOD BY 取得點對點的扣款帳號
         -- 2019.03.13 JIANXIN MOD BY 分階層需增加括號
         -- 2019.03.14 JIANXIN MOD BY 瑞萬基金取得帳號必須增加條件
         AND (   XFUND_NO IS NULL  --為了前一版與後一版能夠並存，則先暫時以NULL處理
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '01' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) != '04') 
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '02' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) != '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '1') 
              OR (DEPOSITORY_CRNCY.DEBIT_ID = '04' AND (SELECT AMC_NO FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '04' AND (SELECT FUND_CATEGORY FROM FAS.FUND WHERE FUND_NO = XFUND_NO) = '2' )
             );


END s_GetDebitAccount;

/

  GRANT EXECUTE ON "ECS"."S_GETDEBITACCOUNT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDELETEUSER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDELETEUSER" 
(v_HostName IN VARCHAR2 DEFAULT NULL, 
 v_UpdateID IN VARCHAR2 DEFAULT NULL) 
 
AS
 
 v_UserOrder NUMBER(10,0);
 v_Userid VARCHAR2(255);

BEGIN

 DECLARE CURSOR GetData  

    IS

        SELECT NVL(MAX(UserOrder),0) ,A.UserID 
        from AA_UserGroup_Log C 
        right join AA_UserGroup A on C.UserID = A.UserID  Group by A.UserID;      

     BEGIN

       OPEN GetData;

      LOOP

      FETCH  GetData  INTO v_UserOrder,v_Userid;    
      EXIT WHEN GetData % NOTFOUND;

       INSERT INTO AA_UserGroup_Log (
                    LogType, LogDate, LogID, HostName
                  ,dataid, UserID, GroupID, Status, CreateID, CreateDate, EntryID,EntryDate, UpdateID, UpdateDate, VerifyID, VerifyDate, ApproveID,ApproveDate, RejectID, RejectDate, UserOrder)
        SELECT
                    'D',SYSDATE, USER ,v_HostName ,A.dataid, A.UserID, A.GroupID, A.Status, A.CreateID, 
                    A.CreateDate ,A.EntryID ,A.EntryDate, v_UpdateID, SYSDATE, A.VerifyID, A.VerifyDate, A.ApproveID, A.ApproveDate, A.RejectID ,A.RejectDate ,v_UserOrder+1
         FROM AA_UserGroup  A 
         WHERE A.UserID = v_Userid;

       END LOOP;
     CLOSE GetData;                 
END;

end s_GetDeleteUser;

/

  GRANT EXECUTE ON "ECS"."S_GETDELETEUSER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDEPUTYID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDEPUTYID" 
(
       v_UserID   IN VARCHAR2 DEFAULT NULL,
       v_DeputyID IN VARCHAR2 DEFAULT NULL,
       cv_1       OUT SYS_REFCURSOR
)

 AS

BEGIN

  IF v_UserID IS NOT NULL and v_DeputyID IS NOT NULL THEN
    OPEN cv_1 FOR

      select distinct a.UserID, a.UserCName, a.UserEName
        from AA_USER a
        Left join AA_UserGroup b on a.UserID = b.UserID
        Left join AA_DeptGroup c on b.GroupID = c.GroupID
       where c.DeptID in
             (select distinct c.DeptID
                from AA_USER a
                Left join AA_UserGroup b on a.UserID = b.UserID
                Left join AA_DeptGroup c on b.GroupID = c.GroupID
               where a.UserID = v_UserID)
         and a.UserID <> v_UserID
         and a.UserID like v_DeputyID;

  ELSE

    OPEN cv_1 FOR

      select distinct a.UserID, a.UserCName, a.UserEName
        from AA_USER a
        Left join AA_UserGroup b on a.UserID = b.UserID
        Left join AA_DeptGroup c on b.GroupID = c.GroupID
       where c.DeptID in
             (select distinct c.DeptID
                from AA_USER a
                Left join AA_UserGroup b on a.UserID = b.UserID
                Left join AA_DeptGroup c on b.GroupID = c.GroupID
               where a.UserID = v_UserID)
         and a.UserID <> v_UserID;

  END IF;

END S_GETDEPUTYID;

/

  GRANT EXECUTE ON "ECS"."S_GETDEPUTYID" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDIVIDEND
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDIVIDEND" 
(
    WIS_ALL        VARCHAR2,                   -- 是否需要全部的選項
    OUTDT          OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
     SELECT FUND.* 
      FROM
       (
        SELECT CASE FUND.DIVIDEND_FREQ --收益分配設定
                 WHEN 'N' THEN
                  'N'
                 ELSE
                  'Y'
               END DIVIDEND_FREQ,
               CASE FUND.DIVIDEND_FREQ --名稱
                 WHEN 'N' THEN
                  '不配息'
                 ELSE
                  '配息'
               END NAME
          FROM FAS.FUND FUND
          UNION
        SELECT 'ALL'     AS DIVIDEND_FREQ
               ,'全部'   AS NAME
          FROM DUAL
         WHERE WIS_ALL = 'Y'
        ) FUND
       ORDER BY DECODE(FUND.DIVIDEND_FREQ,'ALL',1),FUND.DIVIDEND_FREQ;

END s_GetDividend;

/

  GRANT EXECUTE ON "ECS"."S_GETDIVIDEND" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDIVIDENDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDIVIDENDDATA" 
(
     WACCOUNT_NO     INT                            -- 受益人戶號
    ,WISIN_CODE      VARCHAR2                       -- 國際證券代碼
    ,WDIVIDEND_DATE  DATE                           -- 收益分配日期
    ,WPAYMENT_DATE   DATE                           -- 收益分配發放日期
    ,OUTDT           OUT SYS_REFCURSOR              -- 回傳的 TABLEDATA
) IS

  XID      VARCHAR2(10):=' '; -- 身份證號
  XFUND_NO VARCHAR2(5):=' ';  -- 基金代碼

BEGIN

  -- 取得身份證號
  BEGIN
    SELECT HOLDER.ID
      INTO XID
      FROM FAS.HOLDER HOLDER
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
         WHEN NO_DATA_FOUND THEN
              RAISE_APPLICATION_ERROR(-20000,
                                      '無法取得受益人ID，請檢查！');
  END;

  IF WISIN_CODE != 'ALL' THEN

    --刪除暫存檔資料
    DELETE FROM ECS.DIVIDENDDATA_TEMP;

    --將傳入的WISIN_CODE參數以","分開  
    FOR ITEM IN (    SELECT REGEXP_SUBSTR(WISIN_CODE,'[^,]+', 1, LEVEL) AS ISIN_CODE       
                       FROM DUAL
                       CONNECT BY REGEXP_SUBSTR(WISIN_CODE, '[^,]+', 1, LEVEL) IS NOT NULL )
    LOOP

      XFUND_NO := '';

      -- 取得基金代碼
      BEGIN
        SELECT FUND_NO
          INTO XFUND_NO
          FROM FAS.FUND
         WHERE ISIN_CODE = ITEM.ISIN_CODE;

        EXCEPTION
             WHEN NO_DATA_FOUND THEN
                  RAISE_APPLICATION_ERROR(-20000,
                                          ITEM.ISIN_CODE || '無法取得基金代碼，請檢查！');
      END;

      -- 2018.06.20 ChengYu ECS.DIVIDENDDATA_TEMP 對應欄位
      INSERT INTO ECS.DIVIDENDDATA_TEMP
           (
              ACCOUNT_NO
             ,ISIN_CODE
             ,FUND_NO
             ,FUND_NAME
             ,CURRENCY_NO
             ,CURRENCY_NAME
             ,DIVIDEND_DATE
             ,PAYMENT_DATE
             ,TOTAL_RETURN
             ,WIRE_FEE
             ,AMOUNT
           )
        SELECT  HOLDER.ACCOUNT_NO                                    -- 受益人戶號
               ,FUND.ISIN_CODE                                       -- 國際證券代碼
               ,FUND.FUND_NO                                         -- 基金代碼
               ,FUND.NAME AS FUND_NAME                               -- 基金名稱
               ,DIVIDEND_DETAIL.ORG_CURRENCY_NO AS CURRENCY_NO       -- 付款幣別
               -- 2018.03.31 ChengYu 幣別名稱改由 ECS.V_FUND_CRNCY 取得
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                   -- 付款幣別名稱
               ,DIVIDEND_DETAIL.DIVIDEND_DATE                        -- 收益分配日期
               ,DIVIDEND_DETAIL.PAYMENT_DATE                         -- 收益分配發放日期
               ,CASE WHEN DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.AMOUNT
                     ELSE DIVIDEND_DETAIL.NTD_AMOUNT END AMOUNT      -- 匯款金額
               ,DIVIDEND_DETAIL.WIRE_FEE                 	           -- 郵匯費
               ,CASE WHEN DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.TOTAL_RETURN
                     ELSE DIVIDEND_DETAIL.NTD_TOTAL_RETURN END TOTAL_RETURN       -- 匯回金額
          FROM FAS.DIVIDEND_DETAIL DIVIDEND_DETAIL                    -- 受益人收益分配明細
          JOIN FAS.HOLDER HOLDER
            ON DIVIDEND_DETAIL.ID = HOLDER.ID
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = DIVIDEND_DETAIL.FUND_NO
          -- 2018.03.31 ChengYu 幣別名稱改由 ECS.V_FUND_CRNCY 取得
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = DIVIDEND_DETAIL.CURRENCY_NO
         WHERE (DIVIDEND_DETAIL.FUND_NO = XFUND_NO)
           AND (DIVIDEND_DETAIL.ID = XID )
           AND (WDIVIDEND_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR DIVIDEND_DETAIL.DIVIDEND_DATE = WDIVIDEND_DATE )
           AND (WPAYMENT_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR DIVIDEND_DETAIL.PAYMENT_DATE = WPAYMENT_DATE );

    END LOOP;

    OPEN OUTDT FOR
      SELECT ACCOUNT_NO        -- 受益人戶號
             ,ISIN_CODE        -- 國際證券代碼
             ,FUND_NO          -- 基金代碼
             ,FUND_NAME        -- 基金名稱
             ,CURRENCY_NO      -- 付款幣別
             ,CURRENCY_NAME    -- 付款幣別名稱
             ,DIVIDEND_DATE    -- 收益分配日期
             ,PAYMENT_DATE     -- 收益分配發放日期
             ,TOTAL_RETURN     -- 匯回金額
             ,WIRE_FEE         -- 郵匯費
             ,AMOUNT           -- 匯款金額
        FROM ECS.DIVIDENDDATA_TEMP;

  -- 2018.05.17 ChengYu NULL只能以 IS NULL 或 IS NOT NULL 判斷
  ELSIF WISIN_CODE = 'ALL' THEN

    OPEN OUTDT FOR
      SELECT  HOLDER.ACCOUNT_NO                                    -- 受益人戶號
             ,FUND.ISIN_CODE                                       -- 國際證券代碼
             ,FUND.FUND_NO                                         -- 基金代碼
             ,FUND.NAME AS FUND_NAME                               -- 基金名稱
             ,DIVIDEND_DETAIL.ORG_CURRENCY_NO AS CURRENCY_NO       -- 付款幣別
             -- 2018.03.31 ChengYu 幣別名稱改由 ECS.V_FUND_CRNCY 取得
             ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                   -- 付款幣別名稱
             ,DIVIDEND_DETAIL.DIVIDEND_DATE                        -- 收益分配日期
             ,DIVIDEND_DETAIL.PAYMENT_DATE                         -- 收益分配發放日期
             ,CASE WHEN DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.AMOUNT
                   ELSE DIVIDEND_DETAIL.NTD_AMOUNT END AMOUNT      -- 匯款金額
             ,DIVIDEND_DETAIL.WIRE_FEE                 	           -- 郵匯費
             ,CASE WHEN DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.TOTAL_RETURN
                   ELSE DIVIDEND_DETAIL.NTD_TOTAL_RETURN END TOTAL_RETURN       -- 匯回金額
        FROM FAS.DIVIDEND_DETAIL DIVIDEND_DETAIL                    -- 受益人收益分配明細
        JOIN FAS.HOLDER HOLDER
          ON DIVIDEND_DETAIL.ID = HOLDER.ID
        JOIN FAS.FUND FUND
          ON FUND.FUND_NO = DIVIDEND_DETAIL.FUND_NO
        -- 2018.03.31 ChengYu 幣別名稱改由 ECS.V_FUND_CRNCY 取得
        JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
          ON V_FUND_CRNCY.CURRENCY_NO = DIVIDEND_DETAIL.CURRENCY_NO
       WHERE (DIVIDEND_DETAIL.ID = XID )
         AND (WDIVIDEND_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR DIVIDEND_DETAIL.DIVIDEND_DATE = WDIVIDEND_DATE )
         AND (WPAYMENT_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR DIVIDEND_DETAIL.PAYMENT_DATE = WPAYMENT_DATE );   

	ELSE
    -- 2018.05.17 ChengYu NULL只能以 IS NULL 或 IS NOT NULL 判斷
    RAISE_APPLICATION_ERROR(-20000,
         '無法取得基金代碼，請檢查！');

  END IF;

END s_GetDividendData;

/

  GRANT EXECUTE ON "ECS"."S_GETDIVIDENDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETDIVIDENDHISTORY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETDIVIDENDHISTORY" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/8/28
-- Description: 取得配息相關歷史資料(公開資訊)
-- 2018.08.30 YUANLONG 增加ORDER BY 依基準日排序DESC
-- 2018.11.22 tingting 1.增加傳入欄位：ISIN_CODE 2.調整欄位型別：配息年份、配息月份(數值→字串)
-- =============================================
(
     WFUND_NO               VARCHAR               -- 基金代碼
    ,WISIN_CODE             VARCHAR               -- 國際證券代碼
    ,OUTDT                  OUT SYS_REFCURSOR     -- 回傳錯誤訊息
    ,OUTDT2                 OUT SYS_REFCURSOR     -- 回傳的 TABLEDATA
) IS
    XFUND_NO                VARCHAR2(5);          --基金代碼
BEGIN

    -- 2018.11.22 tingting 1.增加傳入欄位：ISIN_CODE 2.調整欄位型別：配息年份、配息月份(數值→字串)
    -- 取得基金代碼
    IF WFUND_NO IS NOT NULL THEN
    BEGIN

        XFUND_NO := WFUND_NO;

    END;
    ELSIF WFUND_NO IS NULL AND WISIN_CODE IS NOT NULL THEN
    BEGIN

        SELECT FUND_NO
          INTO XFUND_NO
          FROM FAS.FUND
         WHERE ISIN_CODE = WISIN_CODE;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, WISIN_CODE || '無法取得基金代碼，請檢查！');

    END;
    END IF;

    OPEN OUTDT FOR
    SELECT  FUND_NO
           ,NAME AS FUND_NAME
           ,NAV_DECIMAL
           ,AMT_DECIMAL
      FROM FAS.FUND
     WHERE FUND_NO = XFUND_NO;

    OPEN OUTDT2 FOR
    SELECT  DIVIDEND_TYPE
           ,CASE DIVIDEND_TYPE WHEN 'M' THEN '月配'
                               WHEN 'Q' THEN '季配'
                               WHEN 'S' THEN '半年配'
                               WHEN 'Y' THEN '年配' 
                               END AS DIVIDEND_TYPE_NAME
           -- 2018.11.22 tingting 1.增加傳出欄位：ISIN_CODE 2.調整欄位型別：配息年份、配息月份(數值→字串)
           ,TO_CHAR(DIVIDEND_YEAR) AS DIVIDEND_YEAR
           ,TO_CHAR(DIVIDEND_MONTH) AS DIVIDEND_MONTH
           ,UNIT_DIVIDEND_RATE
           ,DIVIDEND_DATE
           ,NEXT_DIVIDEND_DATE
           ,PAYMENT_DATE
           ,NAV AS DIVIDEND_NAV
           ,ROI AS DIVIDEND_ROI
           ,MONTH_DIVIDEND_RATE
           ,YEAR_DIVIDEND_RATE
           ,INTEREST_DIVIDEND
           ,PRINCIPAL_DIVIDEND
           ,PAY_DATE
      FROM WPS.FUND_DIVIDEND
     WHERE FUND_NO = XFUND_NO
     -- 2018.08.30 YUANLONG 增加ORDER BY 依基準日排序DESC
     ORDER BY DIVIDEND_DATE DESC;

END s_GetDividendHistory;

/

  GRANT EXECUTE ON "ECS"."S_GETDIVIDENDHISTORY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETECSYSPARAMETER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETECSYSPARAMETER" 
(
    OUTDT          OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
        SELECT TO_NUMBER(SYSTEM_PARAMETER.AC_RETRY_CNT) AS AC_RETRY_CNT -- Robo 扣款交易重送次數
          FROM ECS.SYSTEM_PARAMETER SYSTEM_PARAMETER;

END s_GetEcSysParameter;

/

  GRANT EXECUTE ON "ECS"."S_GETECSYSPARAMETER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFMQDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFMQDATA" 
(
     WACCOUNT_NO      INTEGER                     -- 受益人戶號
    ,OUTDT            OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA
) IS

BEGIN
   DECLARE XID VARCHAR2(10);
   BEGIN

   SELECT ID   --受益人ID
    INTO XID
    FROM FAS.HOLDER
   WHERE ACCOUNT_NO = WACCOUNT_NO;


    OPEN OUTDT FOR
    SELECT FIN_QNAIRE.LIVE_STATUS                 -- 居住狀況
           ,FIN_QNAIRE.MARRIAGE                   -- 婚姻狀況
           ,FIN_QNAIRE.CHILDREN                   -- 子女數
           ,FIN_QNAIRE.EDUCATION                  -- 教育程度
           ,FIN_QNAIRE.PROFESSION_CODE            -- 行業別
           ,FIN_QNAIRE.IN_COME                    -- 家庭年收入
           ,FIN_QNAIRE.INVESTMENT                 -- 投資金額
           ,FIN_QNAIRE.INVEST_TYPE                -- 投資理財工具
           ,FIN_QNAIRE.INVEST_OTHER               -- 投資理財工具–其他
           ,FIN_QNAIRE.INVEST_STAND_ON            -- 投資依據
           ,FIN_QNAIRE.INVEST_INFO                -- 投資訊息
      FROM ECS.FIN_QNAIRE FIN_QNAIRE
     WHERE FIN_QNAIRE.ID = XID;

   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       RAISE_APPLICATION_ERROR(-20000,
                               '無法取得受益人ID，請檢查！');
   END;
END s_GetFMQData;

/

  GRANT EXECUTE ON "ECS"."S_GETFMQDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFUNDFILTER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFUNDFILTER" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得基金篩選結果
-- 2018.03.31 ChengYu 幣別名稱從 ECS.V_FUND_CRNCY 取得
-- 2018.03.31 Jim 修改系統日期格式
-- 2018.05.18 MOD BY JIM 因ECS.FUND_SHARE_CLASS架構更改，多了AMC_NO的KEY
-- 2018.07.05 MOD BY JIANXIN 調整串接語法錯誤內容
-- 2018.08.09 MOD BY JIANXIN 依據法尊要求，成立日未滿六個月不能顯示報酬
-- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
-- 2018.08.24 JIANXIN 增加「取得最新更新日期」
-- 2018.08.28 JIANXIN 只能取得公募基金
-- 2018.09.13 JIANXIN 整理程式碼
-- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
-- 2018.09.21 JIANXIN 排除多種配息方式的內容
-- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
-- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)、序號
-- 2018.10.15 JIANXIN 1. 增加母基金英文名稱
--                    2. 若淨值檔無此基金，則排除該基金
--                    3. 調整母基金串接寫法
--                    4. 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
-- 2018.12.20 JIANXIN MOD BY 若績效無資料，則回傳1900/01/01
-- 2019.01.10 JIANXIN 移除 若淨值檔無此基金，則排除該基金 的規則
-- 2019.01.11 JIANXIN 若淨值無資料，則回傳1900/01/01
-- 2019.02.19 tingting 調整已清算基金條件語法
-- 2019.04.02 JIANXIN 因配息欄位定義不同，故而調整
--                    FUND_DIVIDEND 配息頻率： M 月配 Q 季配 S 半年配 Y 年配
--                    FUND 收益分配設定：N: 本基金無收益分配, A:本基金每年收益分配 , S:本基金每半年收益分配, Q:本基金每季收益分配 , M:本基金每月收益分配 , q:本基金每季+每年收益分配 , m:本基金每月+每年收益分配
-- 2019.04.02 JIANXIN 因配息欄位定義調整
-- 2019.08.22 JIANXIN 配息資訊回傳資料調整
-- 2023.11.27 JIANXIN 調整配息率至10位小數
-- 2023.12.29 JIANXIN 報酬率顯示為-99999.0 
-- 2023.12.31 JIANXIN 配息相關與淨值相關null顯示為-99999.0 
-- 2024.01.03 Richard 調整配息null值由-99999.0 , 改為null
-- =============================================
(
     -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
     WIS_TRADE        VARCHAR2           -- 是否只有交易
    ,OUTDT            OUT SYS_REFCURSOR  -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;
BEGIN

      OPEN OUTDT FOR
    -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)、序號
    SELECT  ROWNUM AS ROW_NUM                                                                           -- 序號
           ,FUNDLIST.*
      FROM (
            SELECT  FUND.FUND_CATEGORY                                                                  --基金類別
                   -- 2018.09.13 JIANXIN 整理程式碼
                   ,CASE FUND.FUND_CATEGORY                                                             --基金類別名稱
                         WHEN '1' THEN '境內'
                         WHEN '2' THEN '境外'
                     END AS FUND_CATEGORY_NAME
                   ,FUND.AMC_NO                                                                         --基金經理公司代碼
                   ,AMC.NAME AS AMC_NAME                                                                --基金經理公司名稱
                   ,FUND.FUND_MASTER_NO                                                                 --主基金別代碼
                   ,FUND_MASTER.SNAME AS FUND_MASTER_NAME                                               --主基金別名稱
                   -- 2018.10.15 JIANXIN 增加母基金英文名稱
                   ,FUND_MASTER.ENAME AS FUND_MASTER_ENAME                                              --主基金別英文名稱
                   ,FUND.FUND_NO                                                                        --基金別
                   ,FUND.NAME AS FUND_NAME                                                              --基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO                                                     --配息基金說明
                   ,FUND.ISIN_CODE                                                                      --ISIN Code
                   ,FUND.SHARE_CLASS                                                                    --級別代碼
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                           --級別名稱
                   ,FUND.CURRENCY_NO                                                                    --幣別代碼
                   -- 2018.03.31 ChengYu 幣別名稱從 ECS.V_FUND_CRNCY 取得
                   ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                                                  --幣別名稱
                   ,FUND.INVESTMENT_TYPE                                                                --投資類型代碼
                   ,INVESTMENT_TYPE.NAME AS INVESTMENT_TYPE_NAME                                        --投資類型名稱
                   ,NVL(FUND.RISK_CATEGORY,'RR5') AS RISK_CATEGORY                                      --風險收益等級
                   ,FUND.AREA_TYPE                                                                      --基金區域投資
                   ,FUND_AREA.DESCRIPTION AS AREA_NAME                                                  --基金區域投資名稱
                   -- 2019.01.11 JIANXIN 若淨值無資料，則回傳1900/01/01
                   ,NVL(TO_CHAR(NAV.NAV_DATE,'yyyy/mm/dd'),'1900/01/01') NAV_DATE                       --最新淨值日期
                   -- 2023.12.31 JIANXIN 配息相關與淨值相關null顯示為-99999.0 
                   ,ROUND(NVL(NAV.NAV,-99999.0),FUND.NAV_DECIMAL) AS NAV                                --最新淨值
                   ,ROUND(NVL(NAV.CHANGE,-99999.0),FUND.NAV_DECIMAL) AS NAV_CHANGE                      --淨值漲跌
                   ,ROUND(CASE WHEN NVL(NAV.NAV,-99999.0) = -99999.0 THEN -99999.0 
                               WHEN NAV.NAV = 0 THEN 0 
                               ELSE NAV.CHANGE / NAV.NAV * 100 
                           END,2) AS NAV_CHANGE_PER                               --淨值漲跌幅(%)
                   -- 2018.08.09 MOD BY JIANXIN 依據法尊要求，成立日未滿六個月不能顯示報酬
                   -- 2023.12.29 JIANXIN 報酬率顯示為-99999.0 
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_3_MONTH,4) ELSE NULL END,-99999.0) AS ROI_3_MONTH                                       --報酬率-3個月
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_6_MONTH,4) ELSE NULL END,-99999.0) AS ROI_6_MONTH                                       --報酬率-6個月
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_1_YEAR,4) ELSE NULL END,-99999.0) AS ROI_1_YEAR                                         --報酬率-1年
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_2_YEAR,4) ELSE NULL END,-99999.0) AS ROI_2_YEAR                                         --報酬率-2年
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_3_YEAR,4) ELSE NULL END,-99999.0) AS ROI_3_YEAR                                         --報酬率-3年
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_5_YEAR,4) ELSE NULL END,-99999.0) AS ROI_5_YEAR                                         --報酬率-5年
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI,4) ELSE NULL END,-99999.0) AS ROI                                                       --報酬率-成立以來
                   ,NVL(CASE WHEN ADD_MONTHS(FUND.INCEPTION_DATE,6) < XSYSDATE THEN ROUND(FUND_INFO.ROI_THIS_YEAR,4) ELSE NULL END,-99999.0) AS ROI_THIS_YEAR                                   --報酬率-今年以來
                   -- 2018.09.21 JIANXIN 排除多種配息方式的內容
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                                 --配息頻率
                   -- 2018.09.13 JIANXIN 整理程式碼
                   -- 2018.09.21 JIANXIN 排除多種配息方式的內容
                   ,CASE FUND.DIVIDEND_FREQ                                                             --配息頻率名稱
                         WHEN 'M' THEN '月配'
                         WHEN 'Q' THEN '季配'
                         WHEN 'S' THEN '半年配'
                         WHEN 'A' THEN '年配'
                         WHEN 'N' THEN '無收益分配'
                         WHEN 'm' THEN '月配 + 年配'
                         WHEN 'q' THEN '季配 + 年配'
                     END DIVIDEND_TYPE_NAME
                   ,FUND_DIVIDEND.DIVIDEND_YEAR AS DIVIDEND_YEAR                                        --配息年份
                   ,FUND_DIVIDEND.DIVIDEND_MONTH AS DIVIDEND_MONTH                                      --配息月份
                   -- 2023.11.27 JIANXIN 調整配息率至10位小數
                   -- 2023.12.31 JIANXIN 配息相關與淨值相關null顯示為-99999.0 
                   -- 2024.01.03 Richard 配合使用者需要 , 調整-99999.0為null
                   ,ROUND(FUND_DIVIDEND.UNIT_DIVIDEND_RATE,10) AS UNIT_DIVIDEND_RATE                    --每單位配息
                   ,NVL(TO_CHAR(FUND_DIVIDEND.DIVIDEND_DATE,'yyyy/mm/dd'),'1900/01/01') AS DIVIDEND_DATE              --基準日
                   ,NVL(TO_CHAR(FUND_DIVIDEND.NEXT_DIVIDEND_DATE,'yyyy/mm/dd'),'1900/01/01') AS NEXT_DIVIDEND_DATE    --除息日
                   ,NVL(TO_CHAR(FUND_DIVIDEND.PAYMENT_DATE,'yyyy/mm/dd'),'1900/01/01') AS PAYMENT_DATE                --配息日
                   -- 2024.01.03 Richard 配合使用者需要 , 調整-99999.0為null
                   ,ROUND(FUND_DIVIDEND.NAV,FUND.NAV_DECIMAL) AS DIVIDEND_NAV                           --境內基準日淨值/境外除息日淨值
                   ,ROUND(FUND_DIVIDEND.ROI,8) AS DIVIDEND_ROI                                          --當月報酬率(含息)
                   -- 2023.11.27 JIANXIN 調整配息率至10位小數
                   -- 2023.12.31 JIANXIN 配息相關與淨值相關null顯示為-99999.0 
                   -- 2024.01.03 Richard 配合使用者需要 , 調整-99999.0為null
                   ,ROUND(FUND_DIVIDEND.MONTH_DIVIDEND_RATE,10) AS MONTH_DIVIDEND_RATE                  --月配息率(%)
                   ,ROUND(FUND_DIVIDEND.YEAR_DIVIDEND_RATE,10)  AS YEAR_DIVIDEND_RATE                   --年化配息率(%)
                   -- 2019.08.22 JIANXIN 配息資訊回傳資料調整
                   -- 2023.12.31 JIANXIN 配息相關與淨值相關null顯示為-99999.0 
                   -- 2024.01.03 Richard 配合使用者需要 , 調整-99999.0為null
                   ,FUND_DIVIDEND.INTEREST_DIVIDEND AS INTEREST_DIVIDEND                                --可分配淨利益/配息
                   ,FUND_DIVIDEND.PRINCIPAL_DIVIDEND AS PRINCIPAL_DIVIDEND                              --本金/配息
                   ,NVL(TO_CHAR(FUND_DIVIDEND.PAY_DATE,'yyyy/mm/dd'),'1900/01/01') AS PAY_DATE                        --預計付款日
                   ,FUND.NAV_DECIMAL AS NAV_DECIMAL                                                                   --淨值小數位數
                   ,FUND.AMT_DECIMAL AS AMT_DECIMAL                                                                   --價金小數位數
                   -- 2018.12.20 JIANXIN MOD BY 若績效無資料，則回傳1900/01/01
                   ,NVL(TO_CHAR(FUND_INFO.DATA_UPD_DATE,'yyyy/mm/dd'),'1900/01/01') AS DATA_UPD_DATE                  --資料更新日期
              FROM FAS.FUND FUND
              -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              -- 2018.10.15 JIANXIN 增加母基金英文名稱、調整母基金串接寫法
              JOIN (SELECT DISTINCT FUND.FUND_NO, FUND_MASTER.ORDINAL,FUND_MASTER.SNAME,FUND_MASTER.ENAME
                      FROM FAS.FUND 
                      JOIN FAS.FUND FUND_MASTER
                        ON FUND.FUND_MASTER_NO = FUND_MASTER.FUND_NO 
                   ) FUND_MASTER
                ON FUND_MASTER.FUND_NO = FUND.FUND_NO
              JOIN FAS.AMC AMC
                ON AMC.AMC_NO = FUND.AMC_NO
              -- 2018.03.31 ChengYu 幣別名稱從 ECS.V_FUND_CRNCY 取得
              JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
                ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
              -- 2018.07.05 MOD BY JIANXIN 調整串接語法錯誤內容
              JOIN FAS.INVESTMENT_TYPE INVESTMENT_TYPE
                ON INVESTMENT_TYPE.INVESTMENT_TYPE = FUND.INVESTMENT_TYPE
              JOIN FAS.FUND_AREA FUND_AREA
                ON FUND_AREA.AREA_TYPE = FUND.AREA_TYPE              
              LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
              LEFT JOIN (  SELECT  NAV.FUND_NO
                                  ,NAV.NAV.NAV
                                  ,NAV.NAV_DATE
                                  ,NAV.CHANGE
                             FROM NAV.NAV
                             JOIN (SELECT FUND_NO, MAX(NAV_DATE) AS NAV_DATE
                                     FROM NAV.NAV
                                    -- 2018.09.13 JIANXIN 整理程式碼
                                    WHERE NAV_DATE <= TRUNC(XSYSDATE)
                                    GROUP BY FUND_NO) A
                               ON A.FUND_NO = NAV.NAV.FUND_NO
                              AND A.NAV_DATE = NAV.NAV.NAV_DATE) NAV
                ON NAV.FUND_NO = FUND.FUND_NO
              LEFT JOIN WPS.FUND_INFO FUND_INFO
                ON FUND_INFO.FUND_NO = FUND.FUND_NO
              -- 2018.03.20 MOD BY JIM 先轉型成大寫 + DISTINCT
              -- 2018.09.21 JIANXIN 排除多種配息方式的內容
              LEFT JOIN (  SELECT DISTINCT FUND_DIVIDEND.FUND_NO
                                  ,UPPER(FUND.DIVIDEND_FREQ) AS DIVIDEND_TYPE
                                  ,FUND_DIVIDEND.DIVIDEND_YEAR
                                  ,FUND_DIVIDEND.DIVIDEND_MONTH
                                  ,FUND_DIVIDEND.UNIT_DIVIDEND_RATE
                                  ,FUND_DIVIDEND.DIVIDEND_DATE
                                  ,FUND_DIVIDEND.NEXT_DIVIDEND_DATE
                                  ,FUND_DIVIDEND.PAYMENT_DATE
                                  ,FUND_DIVIDEND.NAV
                                  ,FUND_DIVIDEND.ROI
                                  ,FUND_DIVIDEND.MONTH_DIVIDEND_RATE
                                  ,FUND_DIVIDEND.YEAR_DIVIDEND_RATE
                                  ,FUND_DIVIDEND.INTEREST_DIVIDEND
                                  ,FUND_DIVIDEND.PRINCIPAL_DIVIDEND
                                  ,FUND_DIVIDEND.PAY_DATE
                             FROM WPS.FUND_DIVIDEND
                             JOIN FAS.FUND
                               ON FUND.FUND_NO = FUND_DIVIDEND.FUND_NO
                               -- 2019.04.02 JIANXIN 因配息欄位定義不同，故而調整
                               -- 2019.04.02 JIANXIN 因配息欄位定義調整
                              AND CASE WHEN UPPER(FUND.DIVIDEND_FREQ) = 'A' THEN 'Y' ELSE UPPER(FUND.DIVIDEND_FREQ) END =  FUND_DIVIDEND.DIVIDEND_TYPE 
                             JOIN (SELECT FUND_NO, MAX(DIVIDEND_DATE) AS DIVIDEND_DATE
                                     FROM WPS.FUND_DIVIDEND
                                     -- 2018.09.13 JIANXIN 整理程式碼
                                    WHERE DIVIDEND_DATE <= TRUNC(XSYSDATE)
                                    GROUP BY FUND_NO) A
                               ON A.FUND_NO = WPS.FUND_DIVIDEND.FUND_NO
                              AND A.DIVIDEND_DATE = WPS.FUND_DIVIDEND.DIVIDEND_DATE ) FUND_DIVIDEND
                ON FUND.FUND_NO = FUND_DIVIDEND.FUND_NO
                   -- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
                   -- 2018.08.28 JIANXIN 只能取得公募基金
                   -- 2018.09.13 JIANXIN 整理程式碼
             WHERE FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
               -- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
               AND (  (WIS_TRADE IS NULL AND FUND.SALES_TYPE IN ('0','1')) -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；
                   OR
                      (WIS_TRADE = 'N' AND FUND.SALES_TYPE IN ('0','1'))
                   OR
                      (WIS_TRADE = 'Y' AND FUND.SALES_TYPE = '0')
                   )
               -- 2019.02.19 tingting 調整已清算基金條件語法
               AND (
                     -- 境內基金清算日期判斷 CLEAR_DATE
                     (     
                       FUND.FUND_CATEGORY = '1' 
                       AND  
                       (
                         (FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )              
                     OR
                     -- 境外基金清算日期判斷 ELIMINATION_DATE
                     (     
                       FUND.FUND_CATEGORY = '2' 
                       AND  
                       (
                         -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                         (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )
                   )
               -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
               AND (  WIS_TRADE IS NULL   -- 以免舊程式壞掉
                   OR
                      WIS_TRADE = 'N'
                   OR
                      (WIS_TRADE = 'Y' AND IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
                   )
                -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
             ORDER BY FUND.FUND_CATEGORY,FUND.AMC_NO,FUND.SITCA_FUND_TYPE,FUND_MASTER.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL
           ) FUNDLIST;


END s_GetFundfilter;

/

  GRANT EXECUTE ON "ECS"."S_GETFUNDFILTER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFUNDHOUSELIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFUNDHOUSELIST" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得基金公司列表
-- 2018.03.05 MOD BY JIM FOR 當IS_ALL=Y時，回傳ALL和全部
-- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
    WIS_ALL        VARCHAR2,          -- 是否需要全部的選項
    OUTDT          OUT SYS_REFCURSOR  -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
     SELECT AMC.*
       FROM
            (
              -- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
              SELECT  DISTINCT FUND.AMC_NO                          --基金公司
                     ,NVL(AMC.NAME,FUND.AMC_NO) AS NAME             --基金公司名稱
                FROM FAS.FUND
                LEFT JOIN FAS.AMC AMC
                  ON AMC.AMC_NO = FUND.AMC_NO
               WHERE FUND.OFFERING_TYPE = '1'                       -- 募集方式 1：公開募集；2：私募
                 AND ( FUND.SALES_TYPE = '0')
                 -- 2019.02.19 tingting 調整已清算基金條件語法
                 AND (
                       -- 境內基金清算日期判斷 CLEAR_DATE
                       (     
                         FUND.FUND_CATEGORY = '1' 
                         AND  
                         (
                           (FUND.CLEAR_DATE IS NULL) 
                           OR 
                           (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                         )
                       )              
                       OR
                       -- 境外基金清算日期判斷 ELIMINATION_DATE
                       (     
                         FUND.FUND_CATEGORY = '2' 
                         AND  
                         (
                           -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                           (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                           OR 
                           (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                           OR 
                           (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                         )
                       )
                     )
                 -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
                 AND (  IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
               UNION
              SELECT 'ALL'    AS AMC_NO
                     ,'全部'  AS NAME
                FROM DUAL
               WHERE WIS_ALL = 'Y'
             ) AMC
       ORDER BY DECODE(AMC.AMC_NO,'ALL',1),AMC.AMC_NO;

END s_GetFundHouseList;

/

  GRANT EXECUTE ON "ECS"."S_GETFUNDHOUSELIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFUNDLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFUNDLIST" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/05
-- Description: 取得基金基本資料
-- 2018.03.31 ChengYu 幣別名稱改由 ECS.V_FUND_CRNCY 取得
-- 2018.05.10 Jim 因某些基金級別為空值，改LEFT JOIN
-- 2018.05.18 MOD BY JIM 因ECS.FUND_SHARE_CLASS架構更改，多了AMC_NO的KEY  
-- 2018.05.25 Jim 新增IS_ROBO
-- 2018.05.29 ChengYu FundList(基金列表)增加欄位　成立日、保管銀行、申購淨值日、買回淨值日、買回付款日、最低首次申購金額、最低首次申購金額(台幣)，新增FundFeeList(基金牌告手續費列表)
-- 2018.07.16 ChengYu FundDocList(基金相關文件列表) 外殼
-- 2018.09.05 YungLong 新增傳出欄位FUND_TYPE、FUND_TYPE_NAME
-- 2018.09.06 JIANXIN 調整FUND_TYPE_NAME寫法
-- 2018.09.13 JIANXIN 1. 新增傳入參數，判斷是否只需要可交易基金
--                    2. 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
--                    3. 只能取得公募基金
-- 2018.09.17 JIANXIN 新增控制欄位
-- 2018.09.18 JIANXIN 調整FUND_TYPE 來源串接
-- 2018.09.21 YUNCHU 增加境內外基金清算日期判斷
-- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
-- 2018.10.08 JIANXIN 1. 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
--                    2. 處理基金級別串接問題
-- 2018.10.08 JIANXIN 網路最低申購金額調整取得欄位
-- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)、新增欄位基金英文名稱、銷售狀態、銷售狀態名稱、註冊地代碼、註冊地名稱、是否可交易
-- 2018.10.15 JIANXIN 1. 調整經理費率 (保管費率)，改為經理費率 (保管費率) * 100
--                    2. 若淨值檔無此基金，則排除該基金
--                    3. 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
-- 2018.12.28 JIANXIN 新增【目標到期投資風險預告書(IS_INVEST_RISK)】欄位 
-- 2019.01.10 JIANXIN 移除 若淨值檔無此基金，則排除該基金 的規則
-- 2019.01.11 JIANXIN 基金成立日，若沒有資料則回傳1900/01/01
-- 2019.02.19 tingting 調整已清算基金條件語法
-- 2020.05.07 JIANXIN 新增檢查【目標到期投資風險預告書】新增 FUND_SET = '10'
-- 2022.03.11 JIANXIN 調整經理費率 (保管費率)，改為不取小數位數兩位
-- =============================================
(
    -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
    WIS_TRADE      VARCHAR2           -- 是否只有交易
   ,OUTDT          OUT SYS_REFCURSOR  -- 回傳的 FundList (基金列表)
   ,OUTDT2         OUT SYS_REFCURSOR  -- 回傳的 FundFeeList (基金牌告手續費列表)
   ,OUTDT3         OUT SYS_REFCURSOR  -- 回傳的 FundDocList (基金相關文件列表)
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
        -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
        SELECT  ROWNUM AS ROW_NUM                                                      -- 序號
               ,FUNDLIST.*
          FROM (
                SELECT  FUND.FUND_CATEGORY AS FUND_CATEGORY                            --基金類別
                       ,CASE FUND.FUND_CATEGORY                                        --基金類別名稱
                             WHEN '1' THEN '境內'
                             WHEN '2' THEN '境外'
                         END FUND_CATEGORY_NAME
                       ,FUND.AMC_NO                                                    --基金經理公司
                       ,AMC.NAME AS AMC_NAME                                           --基金公司名稱
                       ,FUND.ISIN_CODE                                                 --ISIN Code
                       ,FUND.FUND_NO                                                   --基金別
                       ,FUND.NAME AS FUND_NAME                                         --基金名稱
                       -- 2018.10.14 JIANXIN 新增欄位基金英文名稱
                       ,FUND.ENAME AS ENAME                                            --基金英文名稱
                       ,FUND.DIVIDEND_DESC AS FUND_MEMO                                --配息基金說明
                       ,FUND.CURRENCY_NO                                               --幣別
                       -- 2018.03.31 ChengYu 幣別名稱由 ECS.V_FUND_CRNCY 取得
                       ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                             --幣別名稱
                       ,FUND.RISK_CATEGORY                                             --風險收益等級
                       ,'' AS DOCUMENTATION_URL
                       ,NVL(FUND.SHARE_CLASS,'') AS SHARE_CLASS                        --級別
                       ,NVL(FUND_SHARE_CLASS.NAME,'') AS SHARE_CLASS_NAME              --級別名稱
                       -- 2018.10.14 JIANXIN 新增欄位銷售狀態、銷售狀態名稱、註冊地代碼、註冊地名稱
                       ,FUND.SALES_TYPE                                                --銷售狀態
                       ,CASE WHEN FUND.SALES_TYPE = '0' THEN '正常'
                             WHEN FUND.SALES_TYPE = '1' THEN '暫停銷售'
                             WHEN FUND.SALES_TYPE = '2' THEN '未開賣'
                             ELSE ''
                         END AS SALES_TYPE_NAME                                        --銷售狀態名稱
                       ,FUND.REGISTRATION                                              --註冊地代碼
                       ,COUNTRY.NAME AS REGISTRATION_NAME                              --註冊地名稱
                       -- 2018.10.15 JIANXIN 調整經理費率 (保管費率)，改為經理費率 (保管費率) * 100
                       -- 2022.03.11 JIANXIN 調整經理費率 (保管費率)，改為不取小數位數兩位
                       ,FUND.MF_RATE * 100 AS MF_RATE                                  --經理費率
                       ,FUND.SF_RATE * 100 AS SF_RATE                                  --保管費
                       -- 2018.10.08 JIANXIN 網路最低申購金額調整取得欄位
                       ,ROUND(FUND.MIN_AMOUNT,FUND.AMT_DECIMAL) AS EC_MIN_AMOUNT       --網路最低申購金額(原幣)
                       ,ROUND(FUND.MIN_AMOUNT_NTD,0) AS EC_MIN_AMOUNT_NTD              --網路最低申購金額(台幣)
                       ,ROUND(FUND.EC_PERIOD_MIN,FUND.AMT_DECIMAL) AS EC_PERIOD_MIN    --網路定額最低申購金額
                       ,ROUND(FUND.EC_PERIOD_MIN_NTD,0) AS EC_PERIOD_MIN_NTD           --網路定額最低申購金額(台幣)
                       ,ROUND(FUND.MIN_RED_SHARE,FUND.SHARE_DECIMAL) AS MIN_RED_SHARE  --最低買回單位數
                       ,ROUND(FUND.MIN_BAL_SHARE,FUND.SHARE_DECIMAL) AS MIN_BAL_SHARE  --最低結餘單位數
                       ,FUND.EARLY_RED_MIN_DAYS                                        --短線交易最小持有日數
                       ,FUND.SHARE_DECIMAL                                             --單位數小數位數
                       ,FUND.NAV_DECIMAL                                               --淨值小數位數
                       ,FUND.AMT_DECIMAL                                               --價金小數位數
                       -- 2018.05.25 Jim 新增IS_ROBO
                       ,FUND.IS_ROBO                                                   --是否開放ROBO，Y/N
                       -- 2018.05.29 ChengYu FundList(基金列表)增加欄位　成立日、保管銀行、申購淨值日、買回淨值日、買回付款日、最低首次申購金額、最低首次申購金額(台幣)，新增FundFeeList(基金牌告手續費列表)
                       -- 2019.01.11 JIANXIN 基金成立日，若沒有資料則回傳1900/01/01 
                       ,NVL(FUND.INCEPTION_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) INCEPTION_DATE  --成立日
                       ,FUND.CUSTODIAN                                                 --保管銀行
                       ,FUND.PUR_NAV_DAY                                               --申購淨值日
                       ,FUND.RED_NAV_DAY                                               --買回淨值日
                       ,FUND.PAY_DAY                                                   --買回付款日
                       ,FUND.MIN_INITIAL_PURCHASE                                      --最低首次申購金額
                       ,FUND.MIN_INITIAL_PURCHASE_NTD                                  --最低首次申購金額(台幣)
                       -- 2018.09.05 YungLong 新增傳出欄位FUND_TYPE、FUND_TYPE_NAME
                       ,FUND.FUND_TYPE2 AS FUND_TYPE                                   --基金類型
                       -- 2018.09.06 JIANXIN 調整FUND_TYPE_NAME寫法
                       -- 2018.09.18 JIANXIN 調整FUND_TYPE 來源串接
                       ,FUND_TYPE.NAME AS FUND_TYPE_NAME                               --基金類型名稱
                       -- 2018.10.14 JIANXIN 新增欄位是否可交易
                       ,CASE WHEN FUND.IS_EC = 'Y' AND (FUND.IS_EC_PERIODIC = 'Y' OR FUND.IS_EC_PURCHASE = 'Y') THEN 'Y'
                             ELSE 'N' 
                         END IS_TRADE
                       -- 2018.09.17 JIANXIN 新增控制欄位
                       ,FUND.IS_EC                                                     --是否開辦網路交易
                       ,FUND.IS_EC_PERIODIC                                            --是否開放網路定期定額交易
                       ,FUND.IS_EC_PURCHASE                                            --是否開放網路申購
                       ,FUND.IS_EC_REDEMPTION                                          --是否開放網路買回
                       ,FUND.IS_EC_SWITCH_IN                                           --是否開放網路轉申購
                       ,FUND.EC_RSP_NEW                                                --是否開放新委託網路定期定額交易
                       ,FUND.EC_RSP_UPDATE                                             --網路定期定額開放變更(皆可停扣)
                       ,FUND.RSP_CHANGE                                                --開放網路變更書面定額
                       ,FUND.IS_EC_DRSP                                                --是否開放網路定期不定額交易
                       ,FUND.EC_DRSP_NEW                                               --是否開放新委託網路定期不定額交易
                       ,FUND.EC_DRSP_UPDATE                                            --網路定期不定額開放變更(皆可停扣)
                       -- 2019.01.02 JIANXIN 新增檢查【目標到期投資風險預告書】
                       -- 2020.05.07 JIANXIN 新增檢查【目標到期投資風險預告書】新增 FUND_SET = '10'
                       ,CASE WHEN FUND.FUND_SET IN ('10','17') THEN 'Y' ELSE 'N' END AS IS_INVEST_RISK --目標到期投資風險預告書
                  FROM FAS.FUND FUND --基金主檔
                  -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
                  JOIN (SELECT DISTINCT FUND.FUND_NO, FUND_MASTER.ORDINAL
                          FROM FAS.FUND 
                          JOIN FAS.FUND FUND_MASTER
                            ON FUND.FUND_MASTER_NO = FUND_MASTER.FUND_NO 
                       ) FUND_MASTER
                    ON FUND_MASTER.FUND_NO = FUND.FUND_NO
                  -- 2018.03.31 ChengYu 幣別名稱由 ECS.V_FUND_CRNCY 取得
                  JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY --幣別檔(View)
                    ON FUND.CURRENCY_NO = V_FUND_CRNCY.CURRENCY_NO
                  JOIN FAS.AMC AMC --基金公司名稱
                    ON FUND.AMC_NO = AMC.AMC_NO
                  LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS --基金級別檔
                    ON FUND.SHARE_CLASS = FUND_SHARE_CLASS.SHARE_CLASS
                  -- 2018.10.08 JIANXIN 處理基金級別串接問題
                   AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
                  -- 2018.09.18 JIANXIN 調整FUND_TYPE 來源串接
                  LEFT JOIN FAS.FUND_TYPE FUND_TYPE
                    ON FUND_TYPE.FUND_TYPE = FUND.FUND_TYPE2
                   AND FUND_TYPE.CATEGORY = '3'
                  LEFT JOIN FAS.COUNTRY
                    ON COUNTRY.COUNTRY_CODE = FUND.REGISTRATION
                 -- 2018/03/19 JIANXIN 只能選到網路可以交易的基金
                  -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
                 WHERE FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
                   -- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
                   AND (  (WIS_TRADE IS NULL AND FUND.SALES_TYPE IN ('0','1')) -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；
                       OR
                          (WIS_TRADE = 'N' AND FUND.SALES_TYPE IN ('0','1'))
                       OR
                          (WIS_TRADE = 'Y' AND FUND.SALES_TYPE = '0')
                       )
                   -- 2018.09.21 YUNCHU 增加境內外基金清算日期判斷
                   -- 2019.02.19 tingting 調整已清算基金條件語法
                   AND (
                         -- 境內基金清算日期判斷 CLEAR_DATE
                         (     
                           FUND.FUND_CATEGORY = '1' 
                           AND  
                           (
                             (FUND.CLEAR_DATE IS NULL) 
                             OR 
                             (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                           )
                         )              
                         OR
                         -- 境外基金清算日期判斷 ELIMINATION_DATE
                         (     
                           FUND.FUND_CATEGORY = '2' 
                           AND  
                           (
                             -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                             (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                             OR 
                             (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                             OR 
                             (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                           )
                         )
                       )
                 -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
                  AND (  WIS_TRADE IS NULL   -- 以免舊程式壞掉
                      OR 
                         WIS_TRADE = 'N' 
                      OR
                         (WIS_TRADE = 'Y' AND IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
                      )
                -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
                ORDER BY FUND.FUND_CATEGORY,FUND.AMC_NO,FUND.SITCA_FUND_TYPE,FUND_MASTER.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL
              ) FUNDLIST;

   -- 2018.05.29 ChengYu FundList(基金列表)增加欄位　成立日、保管銀行、申購淨值日、買回淨值日、買回付款日、最低首次申購金額、最低首次申購金額(台幣)，新增FundFeeList(基金牌告手續費列表)
   OPEN OUTDT2 FOR
        SELECT  FUND.FUND_NO              --基金代碼
               ,SALES_CHARGE.AMOUNT       --價金
               ,SALES_CHARGE.FAS_PURCHASE --臨櫃單筆申購費率
               ,SALES_CHARGE.FAS_RSP      --臨櫃RSP申購費率
               ,SALES_CHARGE.FAS_SWITCH   --臨櫃轉申購費率
               ,SALES_CHARGE.ECS_PURCHASE --EC單筆申購費率
               ,SALES_CHARGE.ECS_RSP      --EC RSP申購費率
               ,SALES_CHARGE.ECS_DRSP     --EC DRSP申購費率
               ,SALES_CHARGE.ECS_SWITCH   --EC轉申購費率
          FROM FAS.FUND FUND --基金主檔
          -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
          JOIN (SELECT DISTINCT FUND.FUND_NO, FUND_MASTER.ORDINAL
                  FROM FAS.FUND 
                  JOIN FAS.FUND FUND_MASTER
                    ON FUND.FUND_MASTER_NO = FUND_MASTER.FUND_NO 
               ) FUND_MASTER
            ON FUND_MASTER.FUND_NO = FUND.FUND_NO
          LEFT JOIN FAS.SALES_CHARGE SALES_CHARGE --手續費率
            ON SALES_CHARGE.FUND_NO = FUND.FUND_NO
           AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('20000101','YYYYMMDD')
           AND SALES_CHARGE.CURRENCY_NO = FUND.CURRENCY_NO
          -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
         WHERE FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
           -- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
           AND (  (WIS_TRADE IS NULL AND FUND.SALES_TYPE IN ('0','1')) -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；
               OR
                  (WIS_TRADE = 'N' AND FUND.SALES_TYPE IN ('0','1'))
               OR
                  (WIS_TRADE = 'Y' AND FUND.SALES_TYPE = '0')
               )
           -- 2018.09.21 YUNCHU 增加境內外基金清算日期判斷
           -- 2019.02.19 tingting 調整已清算基金條件語法
           AND (
                 -- 境內基金清算日期判斷 CLEAR_DATE
                 (     
                   FUND.FUND_CATEGORY = '1' 
                   AND  
                   (
                     (FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )              
                 OR
                 -- 境外基金清算日期判斷 ELIMINATION_DATE
                 (     
                   FUND.FUND_CATEGORY = '2' 
                   AND  
                   (
                     -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                     (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )
               )
         -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
          AND (  WIS_TRADE IS NULL   -- 以免舊程式壞掉
           OR 
              WIS_TRADE = 'N' 
           OR
              (WIS_TRADE = 'Y' AND IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
           )
        -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
        ORDER BY FUND.FUND_CATEGORY,FUND.AMC_NO,FUND.SITCA_FUND_TYPE,FUND_MASTER.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL;

   -- 2018.07.16 ChengYu FundDocList(基金相關文件列表) 外殼
   OPEN OUTDT3 FOR
        SELECT  FUND.FUND_NO              --基金代碼
               ,FUND.ISIN_CODE            --國際證券代碼
               ,'CHANNEL_DOCURL' AS CHANNEL_DOCURL
               ,'DAILY_DOCURL' AS DAILY_DOCURL
               ,'MONTHLY_DOCURL' AS MONTHLY_DOCURL
               ,'SIM_PROSPECTUS_DOCURL' AS SIM_PROSPECTUS_DOCURL
               ,'PROSPECTUS_DOCURL' AS PROSPECTUS_DOCURL
               ,'INVESTOR_GEN_DOCURL' AS INVESTOR_GEN_DOCURL
               ,'INVESTOR_SPEC_DOCURL' AS INVESTOR_SPEC_DOCURL
          FROM FAS.FUND FUND --基金主檔          
         WHERE FUND.IS_EC = 'Y';

END s_GetFundList;

/

  GRANT EXECUTE ON "ECS"."S_GETFUNDLIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFUNDNAME
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFUNDNAME" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/02
-- Description: 取得基金名稱(關鍵字搜尋)
-- 2018.08.17 ChengYu 加入塞選條件
-- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
-- 2018.08.28 JIANXIN 只能取得公募基金
-- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
-- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
-- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
-- 2018.10.15 JIANXIN 1. 若淨值檔無此基金，則排除該基金
--                    2. 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
-- 2019.01.10 JIANXIN 移除 若淨值檔無此基金，則排除該基金 的規則
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
     WFUND_NAME     VARCHAR2                -- 基金名稱
    ,WIS_TRADE      VARCHAR2                -- 是否只有交易
    ,OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
    -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
    SELECT  ROWNUM AS ROW_NUM                  -- 序號
           ,FUNDLIST.*
      FROM (
            SELECT  FUND.ISIN_CODE             -- ISIN Code
                   ,FUND.FUND_NO  AS FUND_ID   -- 基金別
                   ,FUND.NAME     AS FUND_NAME -- 基金名稱
              FROM FAS.FUND FUND
              -- 2018.10.08 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              JOIN (SELECT DISTINCT FUND.FUND_NO, FUND_MASTER.ORDINAL
                      FROM FAS.FUND 
                      JOIN FAS.FUND FUND_MASTER
                        ON FUND.FUND_MASTER_NO = FUND_MASTER.FUND_NO 
                   ) FUND_MASTER
                ON FUND_MASTER.FUND_NO = FUND.FUND_NO
             WHERE (WFUND_NAME IS NULL OR FUND.NAME LIKE '%' || WFUND_NAME || '%')
               -- 2018.09.13 JIANXIN 新增傳入參數，判斷是否只需要可交易基金
               AND FUND.OFFERING_TYPE = '1'             -- 募集方式 1：公開募集；2：私募
               -- 2018.10.02 JIANXIN 當WIS_TRADE = "Y"，則只能選擇 銷售狀態 =  0：正常，其他則顯示 銷售狀態 =  0：正常； 1：暫停銷售
               AND (  (WIS_TRADE IS NULL AND FUND.SALES_TYPE IN ('0','1')) -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；
                   OR
                      (WIS_TRADE = 'N' AND FUND.SALES_TYPE IN ('0','1'))
                   OR
                      (WIS_TRADE = 'Y' AND FUND.SALES_TYPE = '0')
                   )
               -- 2019.02.19 tingting 調整已清算基金條件語法
               AND (
                     -- 境內基金清算日期判斷 CLEAR_DATE
                     (     
                       FUND.FUND_CATEGORY = '1' 
                       AND  
                       (
                         (FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )              
                     OR
                     -- 境外基金清算日期判斷 ELIMINATION_DATE
                     (     
                       FUND.FUND_CATEGORY = '2' 
                       AND  
                       (
                         -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                         (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                         OR 
                         (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                         OR 
                         (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                       )
                     )
                   )
               AND (  WIS_TRADE IS NULL   -- 以免舊程式壞掉
                   OR 
                      WIS_TRADE = 'N' 
                   OR
                      (WIS_TRADE = 'Y' AND IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
                   )
                -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
             ORDER BY FUND.FUND_CATEGORY,FUND.AMC_NO,FUND.SITCA_FUND_TYPE,FUND_MASTER.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL
           ) FUNDLIST;


END s_GetFundName;

/

  GRANT EXECUTE ON "ECS"."S_GETFUNDNAME" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETFUNDRISK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETFUNDRISK" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得基金風險等級列表
-- 2018.03.14 MOD BY JIM FOR RISK_CATEGORY回傳NULL時，為RR5
-- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
    WIS_ALL        VARCHAR2,               -- 是否需要全部的選項
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS


XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
     SELECT FUND.* 
       FROM
            (
               -- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
               SELECT DISTINCT NVL(FUND.RISK_CATEGORY,'RR5') AS RISK_CATEGORY    --基金風險等級
                      ,NVL(FUND.RISK_CATEGORY,'RR5') AS NAME                     --名稱
                 FROM FAS.FUND FUND
                WHERE FUND.OFFERING_TYPE = '1'                       -- 募集方式 1：公開募集；2：私募
                  AND ( FUND.SALES_TYPE = '0')
                  -- 2019.02.19 tingting 調整已清算基金條件語法
                  AND (
                        -- 境內基金清算日期判斷 CLEAR_DATE
                        (     
                          FUND.FUND_CATEGORY = '1' 
                          AND  
                          (
                            (FUND.CLEAR_DATE IS NULL) 
                            OR 
                            (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                          )
                        )              
                        OR
                        -- 境外基金清算日期判斷 ELIMINATION_DATE
                        (     
                          FUND.FUND_CATEGORY = '2' 
                          AND  
                          (
                            (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                            OR 
                            (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                            OR 
                            (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                          )
                        )
                      )
                  AND (  IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
                UNION
               SELECT 'ALL'    AS RISK_CATEGORY
                      ,'全部'  AS NAME
                 FROM DUAL
               WHERE WIS_ALL = 'Y'
             ) FUND
       ORDER BY DECODE(FUND.RISK_CATEGORY,'ALL',1),RISK_CATEGORY;

END s_GetFundRisk;

/

  GRANT EXECUTE ON "ECS"."S_GETFUNDRISK" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETGROUPTYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETGROUPTYPE" 
(
  v_GroupID IN VARCHAR2 DEFAULT NULL ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS

BEGIN
   OPEN cv_1 FOR
      WITH cteGRoupType AS ( SELECT DISTINCT CASE 
                                                  WHEN GroupType = 'E' THEN 1
                                                  WHEN GroupType IS NULL THEN -1
                                             ELSE 0
                                                END IsEntryGroup,
                                             CASE 
                                                  WHEN GroupType = 'V' THEN 1
                                                  WHEN GroupType IS NULL THEN -1
                                             ELSE 0
                                                END IsVerifyGroup,
                                             CASE 
                                                  WHEN GroupType = 'A' THEN 1
                                                  WHEN GroupType IS NULL THEN -1
                                             ELSE 0
                                                END IsApproveGroup
     FROM AA_DeptGroup 
            LEFT JOIN AA_Group 
             ON AA_DeptGroup.GroupID = AA_Group.GroupID
    WHERE AA_Group.GroupID = v_GroupID ) 
      SELECT NVL(SUM(IsEntryGroup), -1) IsEntry,
             NVL(SUM(IsVerifyGroup), -1) IsVerify,
             NVL(SUM(IsApproveGroup), -1) IsApprove
        FROM cteGRoupType ;
END;

/

  GRANT EXECUTE ON "ECS"."S_GETGROUPTYPE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETHISTORYTRADE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETHISTORYTRADE" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2018/08/13
-- Description: 歷史交易
-- 2018.08.22 JIANXIN MOD BY 調整收益分配 BRANCH_NO = '7000'
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.09.05 tingting MOD BY 1.修正轉申購手續費欄位錯誤 
--                            2.(不)定額扣款列表 分開拆成定額扣款列表、不定額扣款列表及相關調整 
--                            3.申購列表、定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金 
--                            4.不定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金、加碼點(%)、加碼金額、減碼點(%)、減碼金額
-- 2018.09.07 JIANXIN MOD BY 因應系統資料無狀態欄位，進行調整
-- 2018.09.07 tingting MOD BY 定額扣款列表、不定額扣款列表增加傳出欄位：每月扣款日
-- 2018.09.07 tingting MOD BY 1.申購列表' 定額扣款列表、不定額扣款列表 增加傳出欄位：扣款總行代碼、扣款分行代碼、扣款銀行簡稱、扣款帳號、扣款帳號後5碼
--                            2.調整申購列表 交易狀態 = S：交易成功 的取資料方式(Mark掉Union上面那段，從下面那段出資料)
-- 2018.09.24 JIANXIN MOD BY 調整日期為配息日
-- 2018.10.05 JIANXIN MOD BY 歷史贖回交易顯示處理
-- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
-- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
-- 2018.10.12 JIANXIN MOD BY 調整歷史交易申購重複問題
-- 2018.10.12 yunchu 調整轉入.轉出淨值為依據轉入基金及轉出基金
-- 2018.10.17 ChengYu 修正轉申購的手續費、贖回金額、轉申購金額、轉申購單位數
-- 2018.10.24 ChengYu 調整FAS.PURCHASE、FAS.RED_BANK 的JOIN語法
-- 2018.10.25 tingting 1.增加傳出欄位：排列序號
--                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
--                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
-- 2018.10.30 ChengYu 補FAS.PURCHASE、FAS.RED_BANK 的JOIN條件
-- 2018.11.01 JIANXIN 排除Robo交易
-- 2018.11.09 PEN MOD 網路定額、網路不定額列表 調整 處理中 的判斷條件
-- 2018.11.30 ChengYu 修正轉申購 轉出淨值、轉入淨值 抓取方式
-- 2018.12.03 JIANXIN 調整 發放日、每單位分配金額、實際分配淨額、總分配金額 取得邏輯
-- 2018.12.04 ChengYu 修正轉申購金額、手續費欄位(瀚亞NTD_AMOUNT、NTD_SERVICE_CHARGE欄位無值，改抓AMOUNT、SERVICE_CHARGE)
-- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
-- 2018.12.05 JIANXIN 1. 調整贖回金額、贖回淨額等欄位取得方式
--                    2. 贖回交易幣別改為計價幣別
--                    3. 不定額百分比顯示調整
-- 2018.12.06 JIANXIN 調整配息內容交易幣別與計價幣別回傳錯誤
-- 2018.12.12 JIANXIN MOD BY 調整贖回串接FE_BROKER_NO 
-- 2018.12.18 JIANXIN 調整配息的內容
-- 2018.12.18 JIANXIN 調整配息相關費用的內容
-- 2018.12.19 JIANXIN 依據 與瀚亞Ada討論，邏輯調整如下:
--                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO <> 計價幣 則 回傳 NTD_AMOUT
--                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO = 計價幣 則 回傳 AMOUT
--                    配息=再申購：金額 回傳 AMOUT
--                    配息=再申購：交易幣別 回傳 計價幣別
-- 2018.12.27 JIANXIN 若付款日期無資料，則回傳1900/01/01 
-- 2019.02.14 yunchu 調整欄位名稱買回預計入款日(PAY_DATE) 
-- 2019.02.15 yunchu 調整買回預計入款日字串轉日期 
-- 2019.02.21 JIANXIN 若付款日期無資料，則回傳0001/01/01 (暫時解決線上問題) 
-- 2019.03.11 JIANXIN 若付款日期無資料，則回傳1900/01/01 
-- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位：
--                     單筆申購　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】欄位
--                     贖回　　　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】欄位
--                     轉申購　　：新增【轉出基金是否為配息(IS_DIVIDEND_OUT)】、【轉出基金配息頻率(DIVIDEND_TYPE_OUT)】、【轉出基金配息頻率名稱(DIVIDEND_TYPE_NAME_OUT)】、【轉入基金是否為配息(IS_DIVIDEND_IN)】、【轉入基金配息頻率(DIVIDEND_TYPE_IN)】、【轉入基金配息頻率名稱(DIVIDEND_TYPE_NAME_IN)】、【委託日期(RCV_DATE)】、【郵匯費(WIRE_FEE)】、【轉出基金淨額(NET_AMOUNT_OUT)】、【匯率日期(EX_DATE)】、【匯率-交叉匯率(EX_RATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】欄位
--                     定期定額　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】
--                     定期不定額：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】、【委託日期(RCV_DATE)】、【優惠方案代碼(FEE_CHOICE_TYPE)】、【優惠方案名稱(FEE_CHOICE_NAME)】、【促銷活動代碼(PROJECT_CODE)】、【促銷活動名稱(PROJECT_NAME)】
--                     收益分配　：新增【是否為配息(IS_DIVIDEND)】、【配息頻率(DIVIDEND_TYPE)】、【配息頻率名稱(DIVIDEND_TYPE_NAME)】
-- 2019.04.29 tingting 修正申購列表單位數錯誤
-- 2019.04.29 tingting 修正定額扣款列表、不定額扣款列表單位數錯誤
-- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
-- 2019.05.09 tingting 贖回交易幣別改回付款幣別
-- 2019.05.09 JIANXIN 贖回交易幣別改從買回付款(含轉申購)檔來、修正贖回價金錯誤
-- 2019.05.09 tingting 調整促銷活動名稱顯示
-- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
-- 2019.12.25 ChengYu 贖回使用FAS.REDEMPTION【買回】的欄位匯率日(EX_DATE)來取匯率(EX_RATE)、轉申購雖從FAS.PURCHASE抓取不影響，但調整轉出轉入基金匯率與FAS.PURCHASE保持規則一致性
-- 2020.01.21 JIANXIN 1. 匯率改由買進匯率取得
--                    2. 贖回金額顯示方式為交易幣別與計價幣別不同時，顯示不同的金額欄位
-- 2020.04.14 JIANXIN 調整轉申購發生效能問題
-- 2020.04.28 Chengyu 調整贖回與轉申購效能
-- 2020.08.31 JIANXIN 將處理中的轉申購與贖回另外處理
-- 2020.12.15 Chengyu 調整淨值資料限制條件為NAV_DATE
-- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
-- 2021.06.24 Chengyu 新增書面資料
-- 2021.07.19 Chengyu 調整書面與ROBO資料取法
-- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
-- 2021.07.22 JIANXIN 調整書面相關資訊並且整理程式碼
-- 2021.09.03 Chengyu 1.調整申購金額顯示
--                    2.修正轉申購資料顯示
-- 2021.09.22 Chengyu 修正轉申購時的申購資料串接語法
-- 2021.09.24 Chengyu 新增欄位除息日
-- 2021.10.14 Chengyu 調整分配串接FAS.PURCHASE邏輯(TX_DATE)
-- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
-- 2021.10.28 Chengyu 調整分配串接FAS.PURCHASE邏輯(TX_DATE)
-- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
-- 2022.04.14 JIANXIN 調整報酬率小數點2位
-- 2022.04.21 JIANXIN 調整轉申購配息不能用PUR_SER_NO (因為有一些是空的)
-- 2022.05.24 JIANXIN 調整報酬率計算方式，若遇到配息再申購或者是瑞萬系列的基金，則以 CERTIFICATE.AMOUNT 作為成本，否則以 CERTIFICATE.COST 作為成本
-- 2022.10.19 JIANXIN 調整報酬率計算方式
-- 2023.10.25 JIANXIN 調整匯率改由函數取得
-- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
-- 2024.05.24 RICHARD 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
-- 2024.08.01 RICHARD 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
-- 2025.10.20 Patrick 加上Key值 (SER_NO) 
-- =============================================
(
     WACCOUNT_NO        INTEGER             -- 受益人戶號
    ,WTX_DATE_FROM      DATE                -- 交易日期(起)
    ,WTX_DATE_TO        DATE                -- 交易日期(迄)
    ,WTX_TYPE           VARCHAR2            -- 交易類別　ALL：全部；1：單筆申購；2：定期定額；3：定期不定額；4：買回；5：轉申購；6：收益分配
    ,WTX_STATUS         VARCHAR2            -- 交易狀態　C：處理中；S：交易成功；F：交易失敗
    ,WDIV_TYPE          VARCHAR2            -- 收益分配方式　1：匯款；2：再投資；3：郵寄支票
    ,ERRDT              OUT SYS_REFCURSOR   -- 錯誤訊息列表
    ,ALLOTDT            OUT SYS_REFCURSOR   -- 申購列表
    ,REDEMDT            OUT SYS_REFCURSOR   -- 贖回列表
    ,SWITCHDT           OUT SYS_REFCURSOR   -- 轉申購列表
    ,RSPDT              OUT SYS_REFCURSOR   -- 定額扣款列表
    ,DRSPDT             OUT SYS_REFCURSOR   -- 不定額扣款列表
    ,DIVDENDDT          OUT SYS_REFCURSOR   -- 收益分配列表
) IS

    XID                 VARCHAR2(10);       -- 受益人ID
    XWARNS_TYPE         VARCHAR2(1);        -- 警示方式
    XERROR_MSG          VARCHAR2(100);      -- 錯誤訊息

BEGIN

    BEGIN

        --取得受益人ID
        SELECT ID 
          INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    -- ============================================================== 單筆申購 BNG ==============================================================  
    OPEN ALLOTDT FOR
    SELECT  ROWNUM AS ROW_NUM                                     -- 排列序號
           ,DataList.*
      FROM (
            -- EC 單筆申購 交易失敗 或 處理中 或 交易成功
            SELECT  PURCHASE.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 風險屬性
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,CASE WHEN PURCHASE.BRANCH_NO = '8000' THEN 'L1'
                         ELSE '' 
                     END AS PRODUCT_TYPE                          -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,CASE WHEN PURCHASE.BRANCH_NO = '8000' THEN ECS.F_GET_PRODUCT_NAME('L1')
                         ELSE '' 
                     END AS PRODUCT_NAME                          -- 產品類別名稱
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(FAS_PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT  --未轉入FAS時顯示
                         ELSE 0
                     END AS NTD_AMOUNT                            -- 台幣申購價金
                   -- 2019.04.29 tingting 修正申購列表單位數錯誤
                   ,FAS_PURCHASE.SHARES AS SHARES                 -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE --未轉入FAS時顯示
                         ELSE 0 
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   -- 2018.09.05 tingting MOD BY 1.修正轉申購手續費欄位錯誤 
                   --                            2.(不)定額扣款列表 分開拆成定額扣款列表、不定額扣款列表及相關調整 
                   --                            3.申購列表、定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金 
                   --                            4.不定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金、加碼點(%)、加碼金額、減碼點(%)、減碼金額
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT  --未轉入FAS時顯示
                               ELSE 0 
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE --未轉入FAS時顯示
                               ELSE 0  
                           END, 0) AS NTD_TOT_AMOUNT     -- 台幣申購總價金
                   ,CASE WHEN PURCHASE.STATUS = 'C' THEN 'C'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN 'S'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN 'F'
                         ELSE '' 
                     END AS STATUS                               -- 交易狀態代碼
                   ,CASE WHEN PURCHASE.STATUS = 'C' THEN '處理中'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN '交易成功'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN '交易失敗'
                         ELSE '' 
                     END AS STATUS_NAME                           -- 交易狀態
                   ,PURCHASE.BROKER_NO                            -- 銷售機構代碼
                   ,PURCHASE.BRANCH_NO                            -- 銷售機構分行代碼
                   ,PURCHASE.SER_NO                               -- 成交序號
                   ,PURCHASE.PAY_TYPE                             -- 付款方式
                   ,PAY_TYPE.NAME AS PAY_TYPE_NAME                -- 付款方式名稱
                   -- 2018.09.07 tingting MOD BY 1.申購列表' 定額扣款列表、不定額扣款列表 增加傳出欄位：扣款總行代碼、扣款分行代碼、扣款銀行簡稱、扣款帳號、扣款帳號後5碼
                   --                            2.調整申購列表 交易狀態 = S：交易成功 的取資料方式(Mark掉Union上面那段，從下面那段出資料)
                   ,PURCHASE.BANK_NO AS AC_BANK                   -- 扣款總行代碼
                   ,PURCHASE.AC_BRANCH                            -- 扣款分行代碼
                   ,FIS_BRANCH.SNAME AS FIS_SNAME                 -- 扣款銀行簡稱
                   ,PURCHASE.AC_CODE                              -- 扣款帳號
                   ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,PURCHASE_LOG.REVISION_DATE AS RCV_DATE        -- 委託日期(含時分秒)
                   ,PURCHASE.FEE_CHOICE AS FEE_CHOICE_TYPE        -- 優惠方案代碼
                   -- 2019.05.09 tingting 調整促銷活動名稱顯示
                   -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
                   -- 2024.08.01 RICHARD begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
--                   ,CASE WHEN PURCHASE.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
--                         WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || PURCHASE.COUPON_ID
--                         WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵' || PURCHASE.USED_POINT || '點'
--                         WHEN PURCHASE.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','2','3','5') THEN CAMPAIGN.CAMPAIGN_SHNM
                   -- 2024.08.01 RICHARD end 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
                         WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
                         END AS FEE_CHOICE_NAME                   -- 優惠方案名稱
                   ,PURCHASE.PROJECT_CODE                         -- 促銷活動代碼
                   ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME        -- 促銷活動名稱
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM ECS.PURCHASE PURCHASE
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              JOIN FAS.PAY_TYPE
                ON PAY_TYPE.PAY_TYPE = PURCHASE.PAY_TYPE
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.ID = PURCHASE.ID
               AND FAS_PURCHASE.FUND_NO = PURCHASE.FUND_NO
               AND FAS_PURCHASE.TX_DATE = PURCHASE.TX_DATE
               AND FAS_PURCHASE.BRANCH_NO = PURCHASE.BRANCH_NO
               AND FAS_PURCHASE.SER_NO = PURCHASE.SER_NO
               -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH
                ON FIS_BRANCH.BANK_NO = PURCHASE.BANK_NO
               AND FIS_BRANCH.BRANCH_NO = PURCHASE.AC_BRANCH
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN (
                    SELECT  PURCHASE_LOG.FUND_NO
                           ,PURCHASE_LOG.ID
                           ,PURCHASE_LOG.TX_DATE
                           ,PURCHASE_LOG.BROKER_NO
                           ,PURCHASE_LOG.BRANCH_NO
                           ,PURCHASE_LOG.SER_NO
                           ,MAX(PURCHASE_LOG.REVISION_DATE) AS REVISION_DATE 
                      FROM ECS.PURCHASE_LOG     -- EC申購異動紀錄
                     WHERE PURCHASE_LOG.ACTION_TYPE = 'A'   -- 交易動作(A:新增/M:修改/D:刪除)
                       AND PURCHASE_LOG.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
                     GROUP BY PURCHASE_LOG.FUND_NO
                           ,PURCHASE_LOG.ID
                           ,PURCHASE_LOG.TX_DATE
                           ,PURCHASE_LOG.BROKER_NO
                           ,PURCHASE_LOG.BRANCH_NO
                           ,PURCHASE_LOG.SER_NO
                   ) PURCHASE_LOG       -- EC申購異動紀錄
                ON PURCHASE_LOG.FUND_NO = PURCHASE.FUND_NO
               AND PURCHASE_LOG.ID = PURCHASE.ID
               AND PURCHASE_LOG.TX_DATE = PURCHASE.TX_DATE
               AND PURCHASE_LOG.BROKER_NO = PURCHASE.BROKER_NO
               AND PURCHASE_LOG.BRANCH_NO = PURCHASE.BRANCH_NO
               AND PURCHASE_LOG.SER_NO = PURCHASE.SER_NO
              LEFT JOIN ECS.CAMPAIGN    -- 促銷活動
                ON CAMPAIGN.CAMPAIGN_CODE = PURCHASE.PROJECT_CODE
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               -- 2018.11.01 JIANXIN 排除Robo交易
               AND TX_TYPE.TX_TYPE IN ('ALL' ,'1' ) 
               AND PURCHASE.BRANCH_NO IN ('8000') -- EC單筆：8000；Robo :8800
               -- 2018.10.12 JIANXIN MOD BY 調整歷史交易申購重複問題
               AND (  (TX_STATUS.TX_STATUS = 'C' AND PURCHASE.STATUS = 'C')  -- 處理中：STATUS='C'；交易失敗：STATUS='P' AND RESULT_CODE <> '00'
                   OR (TX_STATUS.TX_STATUS = 'F' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00')
                   OR (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') -- 交易成功
                   )   
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO             
            UNION
            -- 2021.06.24 Chengyu 新增書面資料
            SELECT  PURCHASE.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 風險屬性
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,PURCHASE.PRODUCT_TYPE AS PRODUCT_TYPE                          -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME(PURCHASE.PRODUCT_TYPE) AS PRODUCT_NAME                          -- 產品類別名稱
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                         ELSE 0 
                     END AS NTD_AMOUNT                            -- 台幣申購價金
                   ,PURCHASE.SHARES AS SHARES                     -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                         ELSE 0
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                               ELSE 0 
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                               ELSE 0
                           END, 0) AS NTD_TOT_AMOUNT     -- 台幣申購總價金
                   -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
                   ,'S' AS STATUS                                 -- 交易狀態代碼
                   ,'交易成功' AS STATUS_NAME                     -- 交易狀態
                   ,PURCHASE.BROKER_NO                            -- 銷售機構代碼
                   ,PURCHASE.BRANCH_NO                            -- 銷售機構分行代碼
                   ,PURCHASE.SER_NO                               -- 成交序號
                   ,PURCHASE.PAY_TYPE                             -- 付款方式
                   ,PAY_TYPE.NAME AS PAY_TYPE_NAME                -- 付款方式名稱
                   ,CASE WHEN PURCHASE.PAY_TYPE IN ('4','7') THEN FAX_PURCHASE.AC_BANK
                         ELSE '' END AS AC_BANK                   -- 扣款總行代碼
                   ,CASE WHEN PURCHASE.PAY_TYPE IN ('4','7') THEN FAX_PURCHASE.AC_BRANCH
                         ELSE '' END AS AC_BRANCH                 -- 扣款分行代碼
                   ,CASE WHEN PURCHASE.PAY_TYPE IN ('4','7') THEN FIS_BRANCH.SNAME
                         ELSE '' END AS FIS_SNAME                 -- 扣款銀行簡稱
                   ,CASE WHEN PURCHASE.PAY_TYPE IN ('4','7') THEN FAX_PURCHASE.AC_CODE
                         ELSE '' END AS AC_CODE                   -- 扣款帳號
                   ,CASE WHEN PURCHASE.PAY_TYPE IN ('4','7') THEN ECS.FN_STUFF_STR(FAX_PURCHASE.AC_CODE,5,'*') 
                         ELSE '' END AS AC_CODE_5                 -- 往來帳號後5碼
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS RCV_DATE            -- 委託日期(含時分秒)
                   ,'' FEE_CHOICE_TYPE     -- 優惠方案代碼
                   ,'' FEE_CHOICE_NAME     -- 優惠方案名稱
                   ,'' PROJECT_CODE        -- 促銷活動代碼(臨櫃促銷活動與EC促銷活動取得方式不同)
                   ,'' PROJECT_NAME        -- 促銷活動名稱(臨櫃促銷活動與EC促銷活動取得方式不同)
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM FAS.PURCHASE PURCHASE
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              JOIN FAS.PAY_TYPE
                ON PAY_TYPE.PAY_TYPE = PURCHASE.PAY_TYPE  
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO ) NAV  --限制特定區間以減少效能問題
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE            
              LEFT JOIN FAS.FAX_PURCHASE
                ON FAX_PURCHASE.FUND_NO = PURCHASE.FUND_NO
               AND FAX_PURCHASE.TX_DATE = PURCHASE.TX_DATE 
               AND FAX_PURCHASE.BROKER_NO = PURCHASE.BROKER_NO
               AND FAX_PURCHASE.BRANCH_NO = PURCHASE.BRANCH_NO
               --2025.10.20 Patrick Chen. 加上Key值 
               AND FAX_PURCHASE.SER_NO = PURCHASE.SER_NO               
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH
                ON FIS_BRANCH.BANK_NO = FAX_PURCHASE.AC_BANK
               AND FIS_BRANCH.BRANCH_NO = FAX_PURCHASE.AC_BRANCH
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'1' ) AND PURCHASE.BRANCH_NO NOT IN ('8000','8200','8300','8400','8800')) -- EC單筆：8000；Robo :8800
               -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
               -- 書面申購交易成功： FAS.PURCHASE.STATUS = 'S' or 'T'都為成功
               AND (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.STATUS IN ('S','T')) 
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
           ) DataList
     -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
     --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
     --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
     ORDER BY DataList.TX_DATE,                         --交易日期
              CASE WHEN DataList.STATUS = 'C' THEN 1    --處理中
                   WHEN DataList.STATUS = 'S' THEN 2        --交易成功
                   WHEN DataList.STATUS = 'F' THEN 3       --交易失敗
                   ELSE 4 END,                          --交易狀態
              DataList.FUND_CATEGORY, DataList.AMC_NO, DataList.SITCA_FUND_TYPE, DataList.ORDINAL, DataList.SHARE_CLASS NULLS FIRST, DataList.ORDINAL;
    -- ============================================================== 單筆申購 END ==============================================================

    -- ============================================================== 單筆贖回 BNG ==============================================================
    OPEN REDEMDT FOR
    SELECT  ROWNUM AS ROW_NUM                                -- 排列序號
           ,DataList.*
           -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
           ,RATE  --報酬率
      FROM (
            -- 贖回
            -- 2020.08.31 JIANXIN 將處理中的轉申購與贖回另外處理
            SELECT  REDEMPTION.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                          -- 基金名稱
                   ,FUND.FUND_CATEGORY                              -- 基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                     -- 基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                            -- 投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                    -- 基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO                 -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                        -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                     -- 國際證券代碼
                   ,FUND.SHARE_CLASS                                -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO                 -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME             -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL        -- 基金計價幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY             -- 風險屬性
                   ,REDEMPTION.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,CASE WHEN REDEMPTION.BRANCH_NO = '8000' THEN 'R1'
                         ELSE '' 
                     END AS PRODUCT_TYPE                            -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,CASE WHEN REDEMPTION.BRANCH_NO = '8000' THEN ECS.F_GET_PRODUCT_NAME('R1')
                         ELSE '' 
                     END AS PRODUCT_NAME                            -- 產品類別名稱
                   -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
                   ,CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                         WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                         ELSE RED_BANK.CURRENCY_NO
                     END AS TRADE_CRNCY             -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME               -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL       -- 付款幣別小數位數
                   ,0 AS EX_RATE                                    -- 參考匯率(處理中，固定給 0 )
                   ,0 AS AMOUNT                                     -- 贖回價金(處理中，固定給 0 )
                   ,REDEMPTION.APPLICATION_SHARE AS SHARES          -- 贖回單位數
                   ,FUND.SHARE_DECIMAL                              -- 單位數小數位數
                   ,REDEMPTION.AC_DATE                              -- 淨值日期
                   ,0 AS NAV                                        -- 淨值 (處理中，固定給 0 )
                   ,FUND.NAV_DECIMAL                                -- 淨值小數位數
                   ,0 AS WIRE_FEE                                   -- 匯費(處理中匯費，固定給 0 )  
                   ,0  AS TOTAL_RETURN                              -- 贖回價金淨額 (處理中，固定給 0 )
                   ,'C' AS STATUS                                   -- 交易狀態代碼 (處理中，固定給 C)
                   ,'處理中' AS STATUS_NAME                         -- 交易狀態 (處理中，固定給 '處理中')
                   ,REDEMPTION.BROKER_NO                            -- 銷售機構代碼
                   ,REDEMPTION.BRANCH_NO                            -- 銷售機構分行代碼
                   ,REDEMPTION.SER_NO                               -- 成交序號
                   ,'3' AS PAY_TYPE                                 -- 付款方式
                   ,'匯款' AS PAY_TYPE_NAME                         -- 付款方式名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS PAY_DATE   -- 付款日期 (處理中 固定給 1900/01/01 )
                   ,REDEMPTION.AC_NAME                              -- 贖回匯款戶名
                   ,REDEMPTION.AC_FIS_SNAME                         -- 贖回匯款銀行名稱
                   ,REDEMPTION.AC_BANK                              -- 贖回匯款銀行代碼
                   ,REDEMPTION.AC_BRANCH                            -- 贖回匯款銀行分行碼
                   -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
                   ,ECS.FN_STUFF_STR(REDEMPTION.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE             -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE        -- 委託日期(含時分秒)
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   ,0 RATE
              FROM ECS.REDEMPTION REDEMPTION
              JOIN FAS.FUND
                ON REDEMPTION.FUND_NO = FUND.FUND_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.TX_DATE = REDEMPTION.TX_DATE
               AND RED_BANK.FUND_NO = REDEMPTION.FUND_NO
               AND RED_BANK.FE_BROKER_NO = REDEMPTION.BROKER_NO
               AND RED_BANK.FE_BRANCH_NO = REDEMPTION.BRANCH_NO
               AND RED_BANK.FE_SER_NO = REDEMPTION.SER_NO
              -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
              LEFT JOIN ECS.V_FUND_CRNCY CURRENCY
                ON CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                        WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                        ELSE RED_BANK.CURRENCY_NO
                    END = CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN (
                    SELECT  REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                           ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
                      FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
                     WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
                       AND REDEMPTION_LOG.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
                     GROUP BY REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                   ) REDEMPTION_LOG       -- EC買回異動紀錄
                ON REDEMPTION_LOG.FUND_NO = REDEMPTION.FUND_NO
               AND REDEMPTION_LOG.ID = REDEMPTION.ID
               AND REDEMPTION_LOG.TX_DATE = REDEMPTION.TX_DATE
               AND REDEMPTION_LOG.BROKER_NO = REDEMPTION.BROKER_NO
               AND REDEMPTION_LOG.BRANCH_NO = REDEMPTION.BRANCH_NO
               AND REDEMPTION_LOG.SER_NO = REDEMPTION.SER_NO
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE REDEMPTION.ID = XID
               -- 2018.11.01 JIANXIN 排除Robo交易
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'4' ) AND REDEMPTION.BRANCH_NO IN ('8000')) -- 單筆贖回：8000；ROBO贖回 :8800
               AND (TX_STATUS.TX_STATUS = 'C' AND REDEMPTION.STATUS = 'C') -- 交易成功：STATUS='P' ；處理中：STATUS='C'；
               AND REDEMPTION.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
            UNION
            SELECT  REDEMPTION.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                          -- 基金名稱
                   ,FUND.FUND_CATEGORY                              -- 基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                     -- 基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                            -- 投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                    -- 基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO                 -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                        -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                     -- 國際證券代碼
                   ,FUND.SHARE_CLASS                                -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO                 -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME             -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL        -- 基金計價幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY             -- 風險屬性
                   ,REDEMPTION.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,CASE WHEN REDEMPTION.BRANCH_NO = '8000' THEN 'R1'
                         ELSE '' 
                     END AS PRODUCT_TYPE                            -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,CASE WHEN REDEMPTION.BRANCH_NO = '8000' THEN ECS.F_GET_PRODUCT_NAME('R1')
                         ELSE '' 
                     END AS PRODUCT_NAME                            -- 產品類別名稱
                   -- 2018.12.05 JIANXIN 贖回交易幣別改為計價幣別
                   -- 2019.05.09 tingting 贖回交易幣別改回付款幣別
                   -- 2019.05.09 JIANXIN 贖回交易幣別改從買回付款(含轉申購)檔來、修正贖回價金錯誤
                   --,FUND.CURRENCY_NO AS TRADE_CRNCY                 -- 付款幣別
                   --,FUND_CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   --,FUND_CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL        -- 付款幣別小數位數
                   -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
                   ,CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                         WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                         ELSE RED_BANK.CURRENCY_NO
                     END AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME               -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL       -- 付款幣別小數位數
                   -- 2020.01.21 JIANXIN 匯率改由買進匯率取得
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN FUND.CURRENCY_NO = REDEMPTION.CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(FAS_REDEMPTION.FUND_NO,FAS_REDEMPTION.EX_DATE,'B')
                     END AS EX_RATE                                 -- 參考匯率
                   -- 2018.10.05 JIANXIN MOD BY 歷史贖回交易顯示處理
                   -- 2018.12.05 JIANXIN 調整贖回金額、贖回淨額等欄位取得方式
                   -- 2019.05.09 JIANXIN 贖回交易幣別改從買回付款(含轉申購)檔來、修正贖回價金錯誤
                   -- 2020.01.21 JIANXIN 贖回金額顯示方式為交易幣別與計價幣別不同時，顯示不同的金額欄位                   
                   ,CASE WHEN FUND.CURRENCY_NO = REDEMPTION.CURRENCY_NO THEN RED_BANK.AMOUNT 
                         ELSE RED_BANK.NTD_AMOUNT
                     END AS AMOUNT                -- 贖回價金
                   ,REDEMPTION.APPLICATION_SHARE AS SHARES          -- 贖回單位數
                   ,FUND.SHARE_DECIMAL                              -- 單位數小數位數
                   ,REDEMPTION.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN REDEMPTION.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                       -- 淨值 
                   ,FUND.NAV_DECIMAL                                -- 淨值小數位數
                   -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
                   ,NVL(RED_BANK.WIRE_FEE,0) AS WIRE_FEE                                   -- 匯費  
                   -- 2018.12.05 JIANXIN 調整贖回金額、贖回淨額等欄位取得方式
                   ,NVL(RED_BANK.AMOUNT - RED_BANK.WIRE_FEE  ,0) AS TOTAL_RETURN                               -- 贖回價金淨額 
                   ,CASE WHEN REDEMPTION.STATUS = 'C' THEN 'C'
                         WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00' THEN 'S'
                         WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE <> '00' THEN 'F'
                         ELSE '' 
                     END AS STATUS                                 -- 交易狀態代碼
                   ,CASE WHEN REDEMPTION.STATUS = 'C' THEN '處理中'
                         WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00' THEN '交易成功'
                         WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE <> '00' THEN '交易失敗'
                         ELSE '' 
                     END AS STATUS_NAME                             -- 交易狀態
                   ,REDEMPTION.BROKER_NO                            -- 銷售機構代碼
                   ,REDEMPTION.BRANCH_NO                            -- 銷售機構分行代碼
                   ,REDEMPTION.SER_NO                               -- 成交序號
                   ,'3' AS PAY_TYPE                                 -- 付款方式
                   ,'匯款' AS PAY_TYPE_NAME                         -- 付款方式名稱
                   -- 2018.12.27 JIANXIN 若付款日期無資料，則回傳1900/01/01 
                   -- 2019.02.14 yunchu 調整欄位名稱買回預計入款日(PAY_DATE) 
                   -- 2019.02.15 yunchu 調整買回預計入款日字串轉日期 
                   -- 2019.02.21 JIANXIN 若付款日期無資料，則回傳0001/01/01 (暫時解決線上問題) 
                   -- 2019.03.11 JIANXIN 若付款日期無資料，則回傳1900/01/01 
                   ,TO_DATE(NVL(TO_CHAR(REDEMPTION.PAY_DATE,'YYYY/MM/DD'),'1900/01/01'),'YYYY/MM/DD') AS PAY_DATE   -- 付款日期
                   ,REDEMPTION.AC_NAME                              -- 贖回匯款戶名
                   ,REDEMPTION.AC_FIS_SNAME                         -- 贖回匯款銀行名稱
                   ,REDEMPTION.AC_BANK                              -- 贖回匯款銀行代碼
                   ,REDEMPTION.AC_BRANCH                            -- 贖回匯款銀行分行碼
                   -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
                   ,ECS.FN_STUFF_STR(REDEMPTION.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE             -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE        -- 委託日期(含時分秒)
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   -- 2022.04.14 JIANXIN 調整報酬率小數點2位
                   -- 2022.05.24 JIANXIN 調整報酬率計算方式，若遇到配息再申購或者是瑞萬系列的基金，則以 CERTIFICATE.AMOUNT 作為成本，否則以 CERTIFICATE.COST 作為成本
                   -- 2022.10.19 JIANXIN 調整報酬率計算方式
                   ,(SELECT ROUND((FAS_REDEMPTION.AMOUNT / SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' THEN CERTIFICATE.AMOUNT ELSE CERTIFICATE.COST END * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) - 1)*100 ,2)
                       FROM FAS.CERTIFICATE,
                            FAS.RED_CERTIFICATE
                      WHERE FAS.CERTIFICATE.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS.CERTIFICATE.CERTIFICATE_NO = FAS.RED_CERTIFICATE.CERTIFICATE_NO
                        AND FAS_REDEMPTION.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS_REDEMPTION.TX_DATE = FAS.RED_CERTIFICATE.TX_DATE
                        AND FAS_REDEMPTION.BROKER_NO = FAS.RED_CERTIFICATE.BROKER_NO
                        AND FAS_REDEMPTION.BRANCH_NO = FAS.RED_CERTIFICATE.BRANCH_NO
                        AND FAS_REDEMPTION.SER_NO = FAS.RED_CERTIFICATE.SER_NO
                    ) RATE
              FROM ECS.REDEMPTION REDEMPTION
              JOIN FAS.FUND
                ON REDEMPTION.FUND_NO = FUND.FUND_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
               -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
               -- 2020.04.28 Chengyu 調整贖回與轉申購效能
               -- 2020.12.15 Chengyu 調整淨值資料限制條件為NAV_DATE
               -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = REDEMPTION.AC_DATE
              -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.TX_DATE = REDEMPTION.TX_DATE
               AND RED_BANK.FUND_NO = REDEMPTION.FUND_NO
               -- 2018.12.12 JIANXIN MOD BY 調整贖回串接FE_BROKER_NO 
               AND RED_BANK.FE_BROKER_NO = REDEMPTION.BROKER_NO 
               AND RED_BANK.FE_BRANCH_NO = REDEMPTION.BRANCH_NO
               AND RED_BANK.FE_SER_NO = REDEMPTION.SER_NO
              LEFT JOIN FAS.REDEMPTION FAS_REDEMPTION
                ON FAS_REDEMPTION.ID = REDEMPTION.ID 
               AND FAS_REDEMPTION.TX_DATE = RED_BANK.TX_DATE 
               AND FAS_REDEMPTION.FUND_NO = RED_BANK.FUND_NO  
               AND FAS_REDEMPTION.BROKER_NO = RED_BANK.BROKER_NO
               AND FAS_REDEMPTION.BRANCH_NO = RED_BANK.BRANCH_NO
               AND FAS_REDEMPTION.SER_NO = RED_BANK.SER_NO    
                -- 2020.04.28 Chengyu 調整贖回與轉申購效能
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE
              --  ON V_CURRENCY_RATE.FUND_NO = FAS_REDEMPTION.FUND_NO
              -- AND V_CURRENCY_RATE.TX_DATE = FAS_REDEMPTION.EX_DATE
              -- 2018.10.05 JIANXIN MOD BY 歷史贖回交易顯示處理
              -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
              LEFT JOIN ECS.V_FUND_CRNCY CURRENCY
                ON CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                        WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                        ELSE RED_BANK.CURRENCY_NO
                    END = CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN (
                    SELECT  REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                           ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
                      FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
                     WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
                       AND REDEMPTION_LOG.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
                     GROUP BY REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                   ) REDEMPTION_LOG       -- EC買回異動紀錄
                ON REDEMPTION_LOG.FUND_NO = REDEMPTION.FUND_NO
               AND REDEMPTION_LOG.ID = REDEMPTION.ID
               AND REDEMPTION_LOG.TX_DATE = REDEMPTION.TX_DATE
               AND REDEMPTION_LOG.BROKER_NO = REDEMPTION.BROKER_NO
               AND REDEMPTION_LOG.BRANCH_NO = REDEMPTION.BRANCH_NO
               AND REDEMPTION_LOG.SER_NO = REDEMPTION.SER_NO
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE REDEMPTION.ID = XID
               -- 2018.11.01 JIANXIN 排除Robo交易
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'4' ) AND REDEMPTION.BRANCH_NO IN ('8000')) -- 單筆贖回：8000；ROBO贖回 :8800
               AND (TX_STATUS.TX_STATUS = 'S' AND REDEMPTION.STATUS = 'P') -- 交易成功：STATUS='P' ；處理中：STATUS='C'；
               AND REDEMPTION.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
             UNION 
             -- 2021.06.24 Chengyu 新增書面資料
             SELECT  REDEMPTION.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                          -- 基金名稱
                   ,FUND.FUND_CATEGORY                              -- 基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                     -- 基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                            -- 投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                    -- 基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO                 -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                        -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                     -- 國際證券代碼
                   ,FUND.SHARE_CLASS                                -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO                 -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME             -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL        -- 基金計價幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY             -- 風險屬性
                   ,REDEMPTION.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,REDEMPTION.PRODUCT_TYPE  AS PRODUCT_TYPE                            -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME(REDEMPTION.PRODUCT_TYPE) AS PRODUCT_NAME                            -- 產品類別名稱
                   -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
                   ,CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                         WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                         ELSE RED_BANK.CURRENCY_NO
                    END AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME               -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL       -- 付款幣別小數位數
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN FUND.CURRENCY_NO = REDEMPTION.CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(REDEMPTION.FUND_NO,REDEMPTION.EX_DATE,'B') 
                     END AS EX_RATE                                 -- 參考匯率
                   ,CASE WHEN FUND.CURRENCY_NO = REDEMPTION.CURRENCY_NO THEN RED_BANK.AMOUNT 
                         ELSE RED_BANK.NTD_AMOUNT
                     END AS AMOUNT                -- 贖回價金
                   ,REDEMPTION.APPLICATION_SHARE AS SHARES          -- 贖回單位數
                   ,FUND.SHARE_DECIMAL                              -- 單位數小數位數
                   ,REDEMPTION.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN REDEMPTION.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                       -- 淨值 
                   ,FUND.NAV_DECIMAL                                -- 淨值小數位數
                   ,NVL(RED_BANK.WIRE_FEE,0) AS WIRE_FEE                                   -- 匯費  
                   ,NVL(RED_BANK.AMOUNT - RED_BANK.WIRE_FEE  ,0) AS TOTAL_RETURN           -- 贖回價金淨額   
                   -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)                 
                   ,'S' AS STATUS                                   -- 交易狀態代碼
                   ,'交易成功' AS STATUS_NAME                       -- 交易狀態
                   ,REDEMPTION.BROKER_NO                            -- 銷售機構代碼
                   ,REDEMPTION.BRANCH_NO                            -- 銷售機構分行代碼
                   ,REDEMPTION.SER_NO                               -- 成交序號
                   ,'3' AS PAY_TYPE                                 -- 付款方式
                   ,'匯款' AS PAY_TYPE_NAME                         -- 付款方式名稱
                   ,TO_DATE(NVL(TO_CHAR(REDEMPTION.PAY_DATE,'YYYY/MM/DD'),'1900/01/01'),'YYYY/MM/DD') AS PAY_DATE   -- 付款日期
                   ,RED_BANK.AC_NAME                              -- 贖回匯款戶名
                   ,RED_BANK.AC_FIS_SNAME                         -- 贖回匯款銀行名稱                   
                   ,RED_BANK.AC_BANK                              -- 贖回匯款銀行代碼
                   ,RED_BANK.AC_BRANCH                            -- 贖回匯款銀行分行碼
                   ,ECS.FN_STUFF_STR(RED_BANK.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS RCV_DATE          -- 委託日期(含時分秒)
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   -- 2022.04.14 JIANXIN 調整報酬率小數點2位
                   -- 2022.05.24 JIANXIN 調整報酬率計算方式，若遇到配息再申購或者是瑞萬系列的基金，則以 CERTIFICATE.AMOUNT 作為成本，否則以 CERTIFICATE.COST 作為成本
                   -- 2022.10.19 JIANXIN 調整報酬率計算方式
                   ,(SELECT ROUND((REDEMPTION.AMOUNT / SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' THEN CERTIFICATE.AMOUNT ELSE CERTIFICATE.COST END * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) - 1)*100 ,2)
                       FROM FAS.CERTIFICATE,
                            FAS.RED_CERTIFICATE
                      WHERE FAS.CERTIFICATE.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS.CERTIFICATE.CERTIFICATE_NO = FAS.RED_CERTIFICATE.CERTIFICATE_NO
                        AND REDEMPTION.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND REDEMPTION.TX_DATE = FAS.RED_CERTIFICATE.TX_DATE
                        AND REDEMPTION.BROKER_NO = FAS.RED_CERTIFICATE.BROKER_NO
                        AND REDEMPTION.BRANCH_NO = FAS.RED_CERTIFICATE.BRANCH_NO
                        AND REDEMPTION.SER_NO = FAS.RED_CERTIFICATE.SER_NO
                    ) RATE
              FROM FAS.REDEMPTION REDEMPTION
              JOIN FAS.FUND
                ON REDEMPTION.FUND_NO = FUND.FUND_NO              
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = REDEMPTION.AC_DATE
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.TX_DATE = REDEMPTION.TX_DATE
               AND RED_BANK.FUND_NO = REDEMPTION.FUND_NO
               AND RED_BANK.BROKER_NO = REDEMPTION.BROKER_NO
               AND RED_BANK.BRANCH_NO = REDEMPTION.BRANCH_NO
               AND RED_BANK.SER_NO = REDEMPTION.SER_NO
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE
              --  ON V_CURRENCY_RATE.FUND_NO = REDEMPTION.FUND_NO
              -- AND V_CURRENCY_RATE.TX_DATE = REDEMPTION.EX_DATE
              -- 2023.10.27 JIANXIN 若交易幣=MMA、FCY、NULL，則回傳RDEMEPTION的幣別
              LEFT JOIN ECS.V_FUND_CRNCY CURRENCY
                ON CASE WHEN RED_BANK.CURRENCY_NO IS NULL THEN REDEMPTION.CURRENCY_NO 
                        WHEN RED_BANK.CURRENCY_NO IN ('MMA','FCY') THEN REDEMPTION.CURRENCY_NO 
                        ELSE RED_BANK.CURRENCY_NO
                    END = CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE REDEMPTION.ID = XID
               -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'4' ) AND REDEMPTION.BRANCH_NO NOT IN ('8000','8200','8300','8400','8800')) -- 單筆贖回：8000；ROBO贖回 :8800
               -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
               -- 書面交易成功： FAS.REDEMPTION.STATUS = 'S' or 'T'
               AND (TX_STATUS.TX_STATUS = 'S' AND REDEMPTION.STATUS IN  ('S','T')) 
               AND REDEMPTION.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
               --無轉申購日期為贖回資料
               AND REDEMPTION.ST_DATE IS NULL
           ) DataList
           -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
           --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
           --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
           ORDER BY TX_DATE,                          --交易日期
                      CASE WHEN STATUS = 'C' THEN 1     --處理中
                           WHEN STATUS = 'S' THEN 2     --交易成功
                           WHEN STATUS = 'F' THEN 3     --交易失敗
                           ELSE 4 END,                  --交易狀態
                      FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS NULLS FIRST, ORDINAL; 
    -- ============================================================== 單筆贖回 END ==============================================================

    -- =============================================================== 轉申購 BNG ===============================================================
    OPEN SWITCHDT FOR
    SELECT  ROWNUM AS ROW_NUM                                                            -- 排列序號
           ,DataList.*
           -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
           ,RATE  --034340161            
      FROM (
            -- 轉換
            -- 2020.08.31 JIANXIN 將處理中的轉申購與贖回另外處理
            SELECT  SWITCH.FUND_NO AS FUND_NO_OUT                                      -- 轉出基金代碼
                   ,FUND.NAME AS FUND_NAME_OUT                                         -- 轉出基金名稱
                   ,FUND.FUND_CATEGORY                                                 -- 轉出基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                                        -- 轉出基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                                               -- 轉出基金投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                                       -- 轉出基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO_OUT                                -- 轉出基金警語
                   ,FUND.SNAME AS FUND_SNAME_OUT                                       -- 轉出基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE_OUT                                    -- 轉出基金國際證券代碼
                   ,FUND.SHARE_CLASS AS SHARE_CLASS_OUT                                -- 轉出基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME_OUT                      -- 轉出基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO_OUT                                -- 轉出基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME_OUT                            -- 轉出基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL_OUT                       -- 轉出基金計價幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY_OUT                            -- 轉出基金風險屬性 
                   ,SWITCH.TX_DATE                                                     -- 交易日期
                   ,'' AS PRODUCT_TYPE                                                 -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,'轉申購' AS PRODUCT_NAME                                           -- 產品類別名稱
                   ,FUND_CURRENCY.CURRENCY_NO AS TRADE_CRNCY_OUT                       -- 轉出基金申購幣別
                   ,FUND_CURRENCY.NAME AS TRADE_CRNCY_NAME_OUT                         -- 轉出基金申購幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL_OUT                 -- 轉出基金申購幣別小數位數
                   ,0 AS EX_RATE_OUT                                                   -- 轉出基金參考匯率 (處理中，固定為 0)
                   ,0 AS AMOUNT_OUT                                                    -- 贖回價金 (處理中，固定為 0)
                   ,SWITCH.APPLICATION_SHARE AS SHARES_OUT                             -- 贖回單位數
                   ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL_OUT                            -- 轉出基金單位數小數位數
                   ,SWITCH.AC_DATE AS AC_DATE_OUT                                      -- 轉出基金淨值日期
                   ,0 AS NAV_OUT                                                       -- 轉出基金淨值 (處理中，固定為 0)
                   ,FUND.NAV_DECIMAL AS NAV_DECIMAL_OUT                                -- 轉出基金淨值小數位數
                   ,'C' AS STATUS                                                      -- 交易狀態代碼 (處理中，固定為 C)
                   ,'處理中' AS STATUS_NAME                                            -- 交易狀態 (處理中，固定為 '處理中')
                   ,SWITCH.BROKER_NO                                                   -- 銷售機構代碼
                   ,SWITCH.BRANCH_NO                                                   -- 銷售機構分行代碼
                   ,SWITCH.SER_NO                                                      -- 成交序號
                   ,SWITCH.FUND_NO_IN AS FUND_NO_IN                                    -- 轉入基金代碼
                   ,FUND_IN.NAME AS FUND_NAME_IN                                       -- 轉入基金名稱
                   ,FUND_IN.DIVIDEND_DESC AS FUND_MEMO_IN                              -- 轉入基金警語
                   ,FUND_IN.SNAME AS FUND_SNAME_IN                                     -- 轉入基金簡稱
                   ,FUND_IN.ISIN_CODE AS ISIN_CODE_IN                                  -- 轉入基金國際證券代碼
                   ,FUND_IN.SHARE_CLASS AS SHARE_CLASS_IN                              -- 轉入基金級別
                   ,FUND_IN.NAME AS SHARE_CLASS_NAME_IN                                -- 轉入基金級別名稱
                   ,FUND_IN.CURRENCY_NO AS CURRENCY_NO_IN                              -- 轉入基金計價幣別
                   ,FUND_CURRENCY_IN.NAME AS CURRENCY_NAME_IN                          -- 轉入基金計價幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS AMT_DECIMAL_IN                     -- 轉入基金計價幣別小數位數
                   ,FUND_IN.RISK_CATEGORY AS RISK_CATEGORY_IN                          -- 轉入基金風險屬性
                   ,SWITCH.SWITCH_DATE AS SWITCH_DATE                                  -- 轉申購日期
                   ,FUND_CURRENCY_IN.CURRENCY_NO AS TRADE_CRNCY_IN                     -- 轉入基金申購幣別
                   ,FUND_CURRENCY_IN.NAME AS TRADE_CRNCY_NAME_IN                       -- 轉入基金申購幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS TRADE_AMT_DECIMAL_IN               -- 轉入基金申購幣別小數位數
                   ,0 AS EX_RATE_IN                                                    -- 轉入基金參考匯率(處理中，固定為 0)
                   ,0 AS AMOUNT_IN                                                     -- 轉申購金額(轉入基金淨額)(處理中，固定為 0)
                   ,0 AS SERVICE_CHARGE_IN                                             -- 轉申購手續費(處理中，固定為 0)
                   ,0 AS SHARES_IN                                                     -- 轉申購單位數(處理中，固定為 0)
                   ,FUND_IN.SHARE_DECIMAL AS SHARE_DECIMAL_IN                          -- 轉入基金單位數小數位數
                   ,FAS_PURCHASE.AC_DATE AS AC_DATE_IN                                 -- 轉入基金淨值日期
                   ,0 AS NAV_IN                                                        -- 轉入基金淨值(處理中，固定為 0) 
                   ,FUND_IN.NAV_DECIMAL AS NAV_DECIMAL_IN                              -- 轉入基金淨值小數位數
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_OUT     -- 轉出基金是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE_OUT                                         -- 轉出基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_OUT.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_OUT             -- 轉出基金配息頻率名稱
                   ,CASE WHEN FUND_IN.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_IN   -- 轉入基金是否為配息
                   ,FUND_IN.DIVIDEND_FREQ AS DIVIDEND_TYPE_IN                                       -- 轉入基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_IN.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_IN               -- 轉入基金配息頻率名稱
                   ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE                           -- 委託日期(含時分秒)
                   ,0 AS WIRE_FEE                                                      -- 郵匯費(處理中，固定為 0) 
                   -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
                   ,ROUND(RED_BANK.AMOUNT,FUND_CURRENCY.AMT_DECIMAL) - ROUND(RED_BANK.WIRE_FEE,FUND_CURRENCY.AMT_DECIMAL) AS NET_AMOUNT_OUT   -- 轉出基金淨額(贖回價金 - 郵匯費)
                   ,FAS_SWITCH.EX_DATE                                                 -- 匯率日期
                   ,0 AS EX_RATE                                                       -- 匯率-交叉匯率(處理中，固定為 0) 
                   ,SWITCH.FEE_CHOICE AS FEE_CHOICE_TYPE                               -- 優惠方案代碼
                   ,CASE WHEN SWITCH.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                         WHEN SWITCH.FEE_CHOICE = '2' THEN '優惠券' || SWITCH.COUPON_ID
                         WHEN SWITCH.FEE_CHOICE = '3' THEN '紅利折抵' || SWITCH.USED_POINT || '點'
                         WHEN SWITCH.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                         WHEN SWITCH.FEE_CHOICE IS NULL THEN '網路費率'
                         END AS FEE_CHOICE_NAME                                        -- 優惠方案名稱
                   ,SWITCH.PROJECT_CODE                                                -- 促銷活動代碼
                   ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                             -- 促銷活動名稱
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   ,0 RATE
              FROM ECS.REDEMPTION SWITCH    
              JOIN FAS.FUND
                ON SWITCH.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON SWITCH.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              JOIN FAS.FUND FUND_IN
                ON SWITCH.FUND_NO_IN = FUND_IN.FUND_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY_IN
                ON FUND_IN.CURRENCY_NO = FUND_CURRENCY_IN.CURRENCY_NO      
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.FUND_NO_OUT = SWITCH.FUND_NO
               AND FAS_PURCHASE.TX_DATE_OUT = SWITCH.TX_DATE
               AND FAS_PURCHASE.BROKER_NO = SWITCH.BROKER_NO
               AND FAS_PURCHASE.BRANCH_NO = SWITCH.BRANCH_NO
               AND FAS_PURCHASE.SER_NO_OUT = SWITCH.SER_NO
               AND FAS_PURCHASE.FUND_NO = SWITCH.FUND_NO_IN     
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.FUND_NO = FAS_PURCHASE.FUND_NO_OUT
               AND RED_BANK.TX_DATE = FAS_PURCHASE.TX_DATE_OUT
               AND RED_BANK.FE_BROKER_NO = '999'
               AND RED_BANK.FE_BRANCH_NO = '8300'
               AND RED_BANK.FE_SER_NO = FAS_PURCHASE.SER_NO_OUT
               AND RED_BANK.FUND_NO_IN = FAS_PURCHASE.FUND_NO
               AND RED_BANK.AC_BRANCH = SWITCH.AC_BRANCH
               AND RED_BANK.AC_BANK = SWITCH.AC_BANK
               AND RED_BANK.AC_CODE = SWITCH.AC_CODE
              -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
              LEFT JOIN FAS.REDEMPTION FAS_SWITCH
                ON FAS_SWITCH.FUND_NO = RED_BANK.FUND_NO
               AND FAS_SWITCH.TX_DATE = RED_BANK.TX_DATE
               AND FAS_SWITCH.BROKER_NO = RED_BANK.BROKER_NO
               AND FAS_SWITCH.BRANCH_NO = RED_BANK.BRANCH_NO
               AND FAS_SWITCH.SER_NO = RED_BANK.SER_NO
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_OUT -- 欄位選單資料(轉出基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_OUT.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_OUT.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_IN  -- 欄位選單資料(轉入基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_IN.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_IN.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN (
                    SELECT  REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                           ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
                      FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
                     WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
                       AND REDEMPTION_LOG.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
                     GROUP BY REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                   ) REDEMPTION_LOG       -- EC買回異動紀錄
                ON REDEMPTION_LOG.FUND_NO = SWITCH.FUND_NO
               AND REDEMPTION_LOG.ID = SWITCH.ID
               AND REDEMPTION_LOG.TX_DATE = SWITCH.TX_DATE
               AND REDEMPTION_LOG.BROKER_NO = SWITCH.BROKER_NO
               AND REDEMPTION_LOG.BRANCH_NO = SWITCH.BRANCH_NO
               AND REDEMPTION_LOG.SER_NO = SWITCH.SER_NO
              LEFT JOIN ECS.CAMPAIGN    -- 促銷活動
                ON CAMPAIGN.CAMPAIGN_CODE = SWITCH.PROJECT_CODE
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE SWITCH.ID = XID
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'5' ) AND SWITCH.BRANCH_NO IN ('8300')) -- 轉申購：8300；
               AND (TX_STATUS.TX_STATUS = 'C' AND SWITCH.STATUS = 'C') -- 交易成功：STATUS='P' ；處理中：STATUS='C'；
               AND SWITCH.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
            UNION
            SELECT  SWITCH.FUND_NO AS FUND_NO_OUT                                      -- 轉出基金代碼
                   ,FUND.NAME AS FUND_NAME_OUT                                         -- 轉出基金名稱
                   ,FUND.FUND_CATEGORY                                                 -- 轉出基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                                        -- 轉出基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                                               -- 轉出基金投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                                       -- 轉出基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO_OUT                                -- 轉出基金警語
                   ,FUND.SNAME AS FUND_SNAME_OUT                                       -- 轉出基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE_OUT                                    -- 轉出基金國際證券代碼
                   ,FUND.SHARE_CLASS AS SHARE_CLASS_OUT                                -- 轉出基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME_OUT                      -- 轉出基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO_OUT                                -- 轉出基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME_OUT                            -- 轉出基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL_OUT                       -- 轉出基金計價幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY_OUT                            -- 轉出基金風險屬性 
                   ,SWITCH.TX_DATE                                                     -- 交易日期
                   ,'' AS PRODUCT_TYPE                                                 -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,'轉申購' AS PRODUCT_NAME                                           -- 產品類別名稱
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,FUND_CURRENCY.CURRENCY_NO AS TRADE_CRNCY_OUT                       -- 轉出基金申購幣別
                   ,FUND_CURRENCY.NAME AS TRADE_CRNCY_NAME_OUT                         -- 轉出基金申購幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL_OUT                 -- 轉出基金申購幣別小數位數
                   -- 2020.01.21 JIANXIN 匯率改由買進匯率取得(同步修正，但畫面上沒有此欄位)
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN FUND.CURRENCY_NO = SWITCH.CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(FAS_SWITCH.FUND_NO,FAS_SWITCH.EX_DATE,'B') 
                     END AS EX_RATE_OUT                                                -- 轉出基金參考匯率
                   -- 2018.10.17 ChengYu 修正轉申購的手續費、贖回金額、轉申購金額、轉申購單位數
                   -- 2018.12.04 ChengYu 修正轉申購金額、手續費欄位(瀚亞NTD_AMOUNT、NTD_SERVICE_CHARGE欄位無值，改抓AMOUNT、SERVICE_CHARGE)
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,ROUND(RED_BANK.AMOUNT,FUND_CURRENCY.AMT_DECIMAL) AS AMOUNT_OUT     -- 贖回價金
                   ,SWITCH.APPLICATION_SHARE AS SHARES_OUT                             -- 贖回單位數
                   ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL_OUT                            -- 轉出基金單位數小數位數
                   ,SWITCH.AC_DATE AS AC_DATE_OUT                                      -- 轉出基金淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN SWITCH.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV_OUT.NAV END  AS NAV_OUT                              -- 轉出基金淨值 
                   ,FUND.NAV_DECIMAL AS NAV_DECIMAL_OUT                                -- 轉出基金淨值小數位數
                   ,CASE WHEN SWITCH.STATUS = 'C' THEN 'C'
                         WHEN SWITCH.STATUS = 'P' AND SWITCH.RESULT_CODE = '00' THEN 'S'
                         WHEN SWITCH.STATUS = 'P' AND SWITCH.RESULT_CODE <> '00' THEN 'F'
                         ELSE '' 
                     END AS STATUS                                                     -- 交易狀態代碼
                   ,CASE WHEN SWITCH.STATUS = 'C' THEN '處理中'
                         WHEN SWITCH.STATUS = 'P' AND SWITCH.RESULT_CODE = '00' THEN '交易成功'
                         WHEN SWITCH.STATUS = 'P' AND SWITCH.RESULT_CODE <> '00' THEN '交易失敗'
                         ELSE '' 
                     END AS STATUS_NAME                                                -- 交易狀態
                   ,SWITCH.BROKER_NO                                                   -- 銷售機構代碼
                   ,SWITCH.BRANCH_NO                                                   -- 銷售機構分行代碼
                   ,SWITCH.SER_NO                                                      -- 成交序號
                   ,SWITCH.FUND_NO_IN AS FUND_NO_IN                                    -- 轉入基金代碼
                   ,FUND_IN.NAME AS FUND_NAME_IN                                       -- 轉入基金名稱
                   ,FUND_IN.DIVIDEND_DESC AS FUND_MEMO_IN                              -- 轉入基金警語
                   ,FUND_IN.SNAME AS FUND_SNAME_IN                                     -- 轉入基金簡稱
                   ,FUND_IN.ISIN_CODE AS ISIN_CODE_IN                                  -- 轉入基金國際證券代碼
                   ,FUND_IN.SHARE_CLASS AS SHARE_CLASS_IN                              -- 轉入基金級別
                   ,FUND_IN.NAME AS SHARE_CLASS_NAME_IN                                -- 轉入基金級別名稱
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,FUND_IN.CURRENCY_NO AS CURRENCY_NO_IN                              -- 轉入基金計價幣別
                   ,FUND_CURRENCY_IN.NAME AS CURRENCY_NAME_IN                          -- 轉入基金計價幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS AMT_DECIMAL_IN                     -- 轉入基金計價幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND_IN.RISK_CATEGORY AS RISK_CATEGORY_IN                          -- 轉入基金風險屬性
                   ,SWITCH.SWITCH_DATE AS SWITCH_DATE                                  -- 轉申購日期
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,FUND_CURRENCY_IN.CURRENCY_NO AS TRADE_CRNCY_IN                     -- 轉入基金申購幣別
                   ,FUND_CURRENCY_IN.NAME AS TRADE_CRNCY_NAME_IN                       -- 轉入基金申購幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS TRADE_AMT_DECIMAL_IN               -- 轉入基金申購幣別小數位數
                   -- 2020.01.21 JIANXIN 匯率改由賣出匯率取得(同步修正，但畫面上沒有此欄位)
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN SWITCH.CURRENCY_NO = SWITCH.BANK_CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(SWITCH.FUND_NO_IN,FAS_SWITCH.EX_DATE,'S')
                     END AS EX_RATE_IN                                                 -- 轉入基金參考匯率
                   -- 2018.10.17 ChengYu 修正轉申購的手續費、贖回金額、轉申購金額、轉申購單位數 BEGIN
                   -- 2018.12.04 ChengYu 修正轉申購金額、手續費欄位(瀚亞NTD_AMOUNT、NTD_SERVICE_CHARGE欄位無值，改抓AMOUNT、SERVICE_CHARGE)
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,ROUND(FAS_PURCHASE.AMOUNT,FUND_CURRENCY_IN.AMT_DECIMAL)  AS AMOUNT_IN  -- 轉申購金額(轉入基金淨額)
                   -- 2018.12.04 ChengYu 修正轉申購金額、手續費欄位(瀚亞NTD_AMOUNT、NTD_SERVICE_CHARGE欄位無值，改抓AMOUNT、SERVICE_CHARGE)
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,ROUND(FAS_PURCHASE.SERVICE_CHARGE,FUND_CURRENCY_IN.AMT_DECIMAL) AS SERVICE_CHARGE_IN  -- 轉申購手續費
                   ,FAS_PURCHASE.SHARES AS SHARES_IN                                   -- 轉申購單位數
                   -- 2018.10.17 ChengYu 修正轉申購的手續費、贖回金額、轉申購金額、轉申購單位數 END
                   -- 2018.12.04 ChengYu 調整轉申購金額、手續費、交易幣別、交易幣別名稱、轉入小數位數、淨值日
                   ,FUND_IN.SHARE_DECIMAL AS SHARE_DECIMAL_IN                          -- 轉入基金單位數小數位數
                   ,FAS_PURCHASE.AC_DATE AS AC_DATE_IN                                 -- 轉入基金淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN SWITCH.AC_DATE < FUND_IN.INCEPTION_DATE THEN 10 
                         ELSE NAV_IN.NAV END AS NAV_IN                                 -- 轉入基金淨值 
                   ,FUND_IN.NAV_DECIMAL AS NAV_DECIMAL_IN                              -- 轉入基金淨值小數位數
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_OUT     -- 轉出基金是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE_OUT                                         -- 轉出基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_OUT.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_OUT             -- 轉出基金配息頻率名稱
                   ,CASE WHEN FUND_IN.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_IN   -- 轉入基金是否為配息
                   ,FUND_IN.DIVIDEND_FREQ AS DIVIDEND_TYPE_IN                                       -- 轉入基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_IN.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_IN               -- 轉入基金配息頻率名稱
                   ,REDEMPTION_LOG.REVISION_DATE AS RCV_DATE                           -- 委託日期(含時分秒)
                   -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
                   ,ROUND(RED_BANK.WIRE_FEE,FUND_CURRENCY.AMT_DECIMAL) AS WIRE_FEE   -- 郵匯費
                   ,ROUND(RED_BANK.AMOUNT,FUND_CURRENCY.AMT_DECIMAL) - ROUND(RED_BANK.WIRE_FEE,FUND_CURRENCY.AMT_DECIMAL) AS NET_AMOUNT_OUT   -- 轉出基金淨額(贖回價金 - 郵匯費)
                   ,FAS_SWITCH.EX_DATE                                                 -- 匯率日期
                   ,FAS_PURCHASE.EX_RATE                                               -- 匯率-交叉匯率
                   ,SWITCH.FEE_CHOICE AS FEE_CHOICE_TYPE                               -- 優惠方案代碼
                   -- 2019.05.09 tingting 調整促銷活動名稱顯示
                   -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
                   ,CASE WHEN SWITCH.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
                         WHEN SWITCH.FEE_CHOICE = '2' THEN '優惠券' || SWITCH.COUPON_ID
                         WHEN SWITCH.FEE_CHOICE = '3' THEN '紅利折抵' || SWITCH.USED_POINT || '點'
                         WHEN SWITCH.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                         WHEN SWITCH.FEE_CHOICE IS NULL THEN '網路費率'
                         END AS FEE_CHOICE_NAME                                        -- 優惠方案名稱
                   ,SWITCH.PROJECT_CODE                                                -- 促銷活動代碼
                   ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME                             -- 促銷活動名稱
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   -- 2022.04.14 JIANXIN 調整報酬率小數點2位
                   -- 2022.05.24 JIANXIN 調整報酬率計算方式，若遇到配息再申購或者是瑞萬系列的基金，則以 CERTIFICATE.AMOUNT 作為成本，否則以 CERTIFICATE.COST 作為成本
                   -- 2022.10.19 JIANXIN 調整報酬率計算方式
                   ,(SELECT ROUND((FAS_SWITCH.AMOUNT / SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' THEN CERTIFICATE.AMOUNT ELSE CERTIFICATE.COST END * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) - 1)*100 ,2)
                       FROM FAS.CERTIFICATE,
                            FAS.RED_CERTIFICATE
                      WHERE FAS.CERTIFICATE.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS.CERTIFICATE.CERTIFICATE_NO = FAS.RED_CERTIFICATE.CERTIFICATE_NO
                        AND FAS_SWITCH.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS_SWITCH.TX_DATE = FAS.RED_CERTIFICATE.TX_DATE
                        AND FAS_SWITCH.BROKER_NO = FAS.RED_CERTIFICATE.BROKER_NO
                        AND FAS_SWITCH.BRANCH_NO = FAS.RED_CERTIFICATE.BRANCH_NO
                        AND FAS_SWITCH.SER_NO = FAS.RED_CERTIFICATE.SER_NO
                    ) RATE
              FROM ECS.REDEMPTION SWITCH    
              JOIN FAS.FUND
                ON SWITCH.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON SWITCH.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              JOIN FAS.FUND FUND_IN
                ON SWITCH.FUND_NO_IN = FUND_IN.FUND_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY_IN
                ON FUND_IN.CURRENCY_NO = FUND_CURRENCY_IN.CURRENCY_NO
              -- 2018.11.30 ChengYu 修正轉申購 轉出淨值、轉入淨值 抓取方式
              -- 2020.04.14 JIANXIN 調整轉申購發生效能問題
              -- 2020.12.15 Chengyu 調整淨值資料限制條件為NAV_DATE
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO ) NAV_OUT
                ON NAV_OUT.FUND_NO = SWITCH.FUND_NO
               AND NAV_OUT.NAV_DATE = SWITCH.AC_DATE              
              -- 2018.10.24 ChengYu 調整FAS.PURCHASE、FAS.RED_BANK 的JOIN語法 BEGIN
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.FUND_NO_OUT = SWITCH.FUND_NO
               AND FAS_PURCHASE.TX_DATE_OUT = SWITCH.TX_DATE
               AND FAS_PURCHASE.BROKER_NO = SWITCH.BROKER_NO
               AND FAS_PURCHASE.BRANCH_NO = SWITCH.BRANCH_NO
               -- 2018.10.30 ChengYu 補FAS.PURCHASE、FAS.RED_BANK 的JOIN條件
               AND FAS_PURCHASE.SER_NO_OUT = SWITCH.SER_NO
               AND FAS_PURCHASE.FUND_NO = SWITCH.FUND_NO_IN     
              -- 2018.10.12 yunchu 調整轉入.轉出淨值為依據轉入基金及轉出基金
              -- 2018.11.30 ChengYu 修正轉申購 轉出淨值、轉入淨值 抓取方式
              -- 2020.04.14 JIANXIN 調整轉申購發生效能問題
              -- 2020.12.15 Chengyu 調整淨值資料限制條件為NAV_DATE
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) NAV_IN
                ON NAV_IN.FUND_NO = FAS_PURCHASE.FUND_NO
               AND NAV_IN.NAV_DATE = FAS_PURCHASE.AC_DATE
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.FUND_NO = FAS_PURCHASE.FUND_NO_OUT
               AND RED_BANK.TX_DATE = FAS_PURCHASE.TX_DATE_OUT
               -- 2018.10.30 ChengYu 補FAS.PURCHASE、FAS.RED_BANK 的JOIN條件
               AND RED_BANK.FE_BROKER_NO = '999'
               AND RED_BANK.FE_BRANCH_NO = '8300'
               AND RED_BANK.FE_SER_NO = FAS_PURCHASE.SER_NO_OUT
               AND RED_BANK.FUND_NO_IN = FAS_PURCHASE.FUND_NO
               AND RED_BANK.AC_BRANCH = SWITCH.AC_BRANCH
               AND RED_BANK.AC_BANK = SWITCH.AC_BANK
               AND RED_BANK.AC_CODE = SWITCH.AC_CODE
              -- 2021.05.10 Chengyu 修正贖回、轉申購時，FAS.REDEMPTION串接條件
              LEFT JOIN FAS.REDEMPTION FAS_SWITCH
                ON FAS_SWITCH.FUND_NO = RED_BANK.FUND_NO
               AND FAS_SWITCH.TX_DATE = RED_BANK.TX_DATE
               AND FAS_SWITCH.BROKER_NO = RED_BANK.BROKER_NO
               AND FAS_SWITCH.BRANCH_NO = RED_BANK.BRANCH_NO
               AND FAS_SWITCH.SER_NO = RED_BANK.SER_NO
              -- 2019.12.25 ChengYu 贖回使用FAS.REDEMPTION【買回】的欄位匯率日(EX_DATE)來取匯率(EX_RATE)、轉申購雖從FAS.PURCHASE抓取不影響，但調整轉出轉入基金匯率與FAS.PURCHASE保持規則一致性
              -- 2020.04.28 Chengyu 調整贖回與轉申購效能
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE
              --  ON V_CURRENCY_RATE.FUND_NO = FAS_SWITCH.FUND_NO
              -- AND V_CURRENCY_RATE.TX_DATE = FAS_SWITCH.EX_DATE
              -- 2019.12.25 ChengYu 贖回使用FAS.REDEMPTION【買回】的欄位匯率日(EX_DATE)來取匯率(EX_RATE)、轉申購雖從FAS.PURCHASE抓取不影響，但調整轉出轉入基金匯率與FAS.PURCHASE保持規則一致性
              -- 2020.04.28 Chengyu 調整贖回與轉申購效能
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE_IN
              --  ON V_CURRENCY_RATE_IN.FUND_NO = SWITCH.FUND_NO_IN
              -- AND V_CURRENCY_RATE_IN.TX_DATE = FAS_SWITCH.EX_DATE
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_OUT -- 欄位選單資料(轉出基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_OUT.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_OUT.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_IN  -- 欄位選單資料(轉入基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_IN.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_IN.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN (
                    SELECT  REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                           ,MAX(REDEMPTION_LOG.REVISION_DATE) AS REVISION_DATE 
                      FROM ECS.REDEMPTION_LOG       -- EC買回異動紀錄
                     WHERE REDEMPTION_LOG.ACTION_TYPE = 'A'     -- 交易動作(A:新增/M:修改/D:刪除)
                       AND REDEMPTION_LOG.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
                     GROUP BY REDEMPTION_LOG.FUND_NO
                           ,REDEMPTION_LOG.ID
                           ,REDEMPTION_LOG.TX_DATE
                           ,REDEMPTION_LOG.BROKER_NO
                           ,REDEMPTION_LOG.BRANCH_NO
                           ,REDEMPTION_LOG.SER_NO
                   ) REDEMPTION_LOG       -- EC買回異動紀錄
                ON REDEMPTION_LOG.FUND_NO = SWITCH.FUND_NO
               AND REDEMPTION_LOG.ID = SWITCH.ID
               AND REDEMPTION_LOG.TX_DATE = SWITCH.TX_DATE
               AND REDEMPTION_LOG.BROKER_NO = SWITCH.BROKER_NO
               AND REDEMPTION_LOG.BRANCH_NO = SWITCH.BRANCH_NO
               AND REDEMPTION_LOG.SER_NO = SWITCH.SER_NO
              LEFT JOIN ECS.CAMPAIGN    -- 促銷活動
                ON CAMPAIGN.CAMPAIGN_CODE = SWITCH.PROJECT_CODE
              -- 2018.10.24 ChengYu 調整FAS.PURCHASE、FAS.RED_BANK 的JOIN語法 END
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE SWITCH.ID = XID
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'5' ) AND SWITCH.BRANCH_NO IN ('8300')) -- 轉申購：8300；
               AND (TX_STATUS.TX_STATUS = 'S' AND SWITCH.STATUS = 'P') -- 交易成功：STATUS='P' ；處理中：STATUS='C'；
               AND SWITCH.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
             UNION 
             -- 2021.06.24 Chengyu 新增書面資料
             SELECT  SWITCH.FUND_NO AS FUND_NO_OUT                                      -- 轉出基金代碼
                   ,FUND.NAME AS FUND_NAME_OUT                                         -- 轉出基金名稱
                   ,FUND.FUND_CATEGORY                                                 -- 轉出基金類別(境內/境外基金) 1:境內 2:境外
                   ,FUND.AMC_NO                                                        -- 轉出基金經理公司 1.refer to fas.AMC(已隱藏) 2.目前分類 01.瀚亞投信(境內) 02.瀚亞投資(新加坡) 03.MG(新加坡)    04.瑞萬通博(TDCC)
                   ,FUND.SITCA_FUND_TYPE                                               -- 轉出基金投信顧公會基金類型 1.refer to FAS.SITCA_FUND_TYPE 2.目前分類，請參閱 FAS.SITCA_FUND_TYPE
                   ,FUND.ORDINAL                                                       -- 轉出基金序數 - 用於查詢或報表的排序
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO_OUT                                -- 轉出基金警語
                   ,FUND.SNAME AS FUND_SNAME_OUT                                       -- 轉出基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE_OUT                                    -- 轉出基金國際證券代碼
                   ,FUND.SHARE_CLASS AS SHARE_CLASS_OUT                                -- 轉出基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME_OUT                      -- 轉出基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO_OUT                                -- 轉出基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME_OUT                            -- 轉出基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL_OUT                       -- 轉出基金計價幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY_OUT                            -- 轉出基金風險屬性 
                   ,SWITCH.TX_DATE                                                     -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,SWITCH.PRODUCT_TYPE AS PRODUCT_TYPE                                                 -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME(SWITCH.PRODUCT_TYPE) AS PRODUCT_NAME                                           -- 產品類別名稱
                   ,FUND_CURRENCY.CURRENCY_NO AS TRADE_CRNCY_OUT                       -- 轉出基金申購幣別
                   ,FUND_CURRENCY.NAME AS TRADE_CRNCY_NAME_OUT                         -- 轉出基金申購幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL_OUT                 -- 轉出基金申購幣別小數位數
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN FUND.CURRENCY_NO = SWITCH.CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(SWITCH.FUND_NO,SWITCH.TX_DATE,'B') 
                     END AS EX_RATE_OUT                                                -- 轉出基金參考匯率
                   ,ROUND(RED_BANK.AMOUNT,FUND_CURRENCY.AMT_DECIMAL) AS AMOUNT_OUT     -- 贖回價金
                   ,SWITCH.APPLICATION_SHARE AS SHARES_OUT                             -- 贖回單位數
                   ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL_OUT                            -- 轉出基金單位數小數位數
                   ,SWITCH.AC_DATE AS AC_DATE_OUT                                      -- 轉出基金淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN SWITCH.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV_OUT.NAV END AS NAV_OUT                               -- 轉出基金淨值 
                   ,FUND.NAV_DECIMAL AS NAV_DECIMAL_OUT                                -- 轉出基金淨值小數位數
                   -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
                   ,'S' AS STATUS                                                      -- 交易狀態代碼
                   ,'交易成功' AS STATUS_NAME                                          -- 交易狀態
                   ,SWITCH.BROKER_NO                                                   -- 銷售機構代碼
                   ,SWITCH.BRANCH_NO                                                   -- 銷售機構分行代碼
                   ,SWITCH.SER_NO                                                      -- 成交序號
                   ,RED_BANK.FUND_NO_IN AS FUND_NO_IN                                  -- 轉入基金代碼
                   ,FUND_IN.NAME AS FUND_NAME_IN                                       -- 轉入基金名稱
                   ,FUND_IN.DIVIDEND_DESC AS FUND_MEMO_IN                              -- 轉入基金警語
                   ,FUND_IN.SNAME AS FUND_SNAME_IN                                     -- 轉入基金簡稱
                   ,FUND_IN.ISIN_CODE AS ISIN_CODE_IN                                  -- 轉入基金國際證券代碼
                   ,FUND_IN.SHARE_CLASS AS SHARE_CLASS_IN                              -- 轉入基金級別
                   ,FUND_IN.NAME AS SHARE_CLASS_NAME_IN                                -- 轉入基金級別名稱
                   ,FUND_IN.CURRENCY_NO AS CURRENCY_NO_IN                              -- 轉入基金計價幣別
                   ,FUND_CURRENCY_IN.NAME AS CURRENCY_NAME_IN                          -- 轉入基金計價幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS AMT_DECIMAL_IN                     -- 轉入基金計價幣別小數位數
                   ,FUND_IN.RISK_CATEGORY AS RISK_CATEGORY_IN                          -- 轉入基金風險屬性
                   ,FAS_PURCHASE.TX_DATE AS SWITCH_DATE                                -- 轉申購日期
                   ,FUND_CURRENCY_IN.CURRENCY_NO AS TRADE_CRNCY_IN                     -- 轉入基金申購幣別
                   ,FUND_CURRENCY_IN.NAME AS TRADE_CRNCY_NAME_IN                       -- 轉入基金申購幣別名稱
                   ,FUND_CURRENCY_IN.AMT_DECIMAL AS TRADE_AMT_DECIMAL_IN               -- 轉入基金申購幣別小數位數
                   -- 2023.10.25 JIANXIN 調整匯率改由函數取得
                   ,CASE WHEN SWITCH.CURRENCY_NO = RED_BANK.CURRENCY_NO THEN 1 
                         ELSE ECS.F_GET_EX_RATE(RED_BANK.FUND_NO,SWITCH.TX_DATE,'S') 
                     END AS EX_RATE_IN                                                 -- 轉入基金參考匯率
                   ,ROUND(FAS_PURCHASE.AMOUNT,FUND_CURRENCY_IN.AMT_DECIMAL)  AS AMOUNT_IN  -- 轉申購金額(轉入基金淨額)
                   ,ROUND(FAS_PURCHASE.SERVICE_CHARGE,FUND_CURRENCY_IN.AMT_DECIMAL) AS SERVICE_CHARGE_IN  -- 轉申購手續費
                   ,FAS_PURCHASE.SHARES AS SHARES_IN                                   -- 轉申購單位數
                   ,FUND_IN.SHARE_DECIMAL AS SHARE_DECIMAL_IN                          -- 轉入基金單位數小數位數
                   ,FAS_PURCHASE.AC_DATE AS AC_DATE_IN                                 -- 轉入基金淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN SWITCH.AC_DATE < FUND_IN.INCEPTION_DATE THEN 10 
                         ELSE NAV_IN.NAV END AS NAV_IN                                 -- 轉入基金淨值 
                   ,FUND_IN.NAV_DECIMAL AS NAV_DECIMAL_IN                              -- 轉入基金淨值小數位數
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_OUT     -- 轉出基金是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE_OUT                                         -- 轉出基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_OUT.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_OUT             -- 轉出基金配息頻率名稱
                   ,CASE WHEN FUND_IN.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND_IN   -- 轉入基金是否為配息
                   ,FUND_IN.DIVIDEND_FREQ AS DIVIDEND_TYPE_IN                                       -- 轉入基金配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ_IN.DISPLAY_NAME AS DIVIDEND_TYPE_NAME_IN               -- 轉入基金配息頻率名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS  RCV_DATE                                               -- 委託日期(含時分秒)
                   ,ROUND(RED_BANK.WIRE_FEE,FUND_CURRENCY.AMT_DECIMAL) AS WIRE_FEE   -- 郵匯費
                   ,ROUND(RED_BANK.AMOUNT,FUND_CURRENCY.AMT_DECIMAL) - ROUND(RED_BANK.WIRE_FEE,FUND_CURRENCY.AMT_DECIMAL) AS NET_AMOUNT_OUT   -- 轉出基金淨額(贖回價金 - 郵匯費)
                   ,SWITCH.EX_DATE                                                     -- 匯率日期
                   ,FAS_PURCHASE.EX_RATE                                               -- 匯率-交叉匯率
                   ,'' AS FEE_CHOICE_TYPE                                              -- 優惠方案代碼
                   ,'' AS FEE_CHOICE_NAME                                              -- 優惠方案名稱
                   ,'' AS PROJECT_CODE                                                 -- 促銷活動代碼(臨櫃促銷活動處理不同)
                   ,'' AS PROJECT_NAME                                                 -- 促銷活動名稱(臨櫃促銷活動處理不同)
                   -- 2022.03.02 Chengyu 贖回與轉申購新增欄位"報酬率"
                   -- 2022.04.14 JIANXIN 調整報酬率小數點2位
                   -- 2022.05.24 JIANXIN 調整報酬率計算方式，若遇到配息再申購或者是瑞萬系列的基金，則以 CERTIFICATE.AMOUNT 作為成本，否則以 CERTIFICATE.COST 作為成本
                   -- 2022.10.19 JIANXIN 調整報酬率計算方式
                   ,(SELECT ROUND((SWITCH.AMOUNT / SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' THEN CERTIFICATE.AMOUNT ELSE CERTIFICATE.COST END * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) - 1)*100 ,2)
                       FROM FAS.CERTIFICATE,
                            FAS.RED_CERTIFICATE
                      WHERE FAS.CERTIFICATE.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND FAS.CERTIFICATE.CERTIFICATE_NO = FAS.RED_CERTIFICATE.CERTIFICATE_NO
                        AND SWITCH.FUND_NO = FAS.RED_CERTIFICATE.FUND_NO
                        AND SWITCH.TX_DATE = FAS.RED_CERTIFICATE.TX_DATE
                        AND SWITCH.BROKER_NO = FAS.RED_CERTIFICATE.BROKER_NO
                        AND SWITCH.BRANCH_NO = FAS.RED_CERTIFICATE.BRANCH_NO
                        AND SWITCH.SER_NO = FAS.RED_CERTIFICATE.SER_NO
                    ) RATE
              FROM FAS.REDEMPTION SWITCH    
              JOIN FAS.FUND
                ON SWITCH.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON SWITCH.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO ) NAV_OUT
                ON NAV_OUT.FUND_NO = SWITCH.FUND_NO
               AND NAV_OUT.NAV_DATE = SWITCH.AC_DATE
              LEFT JOIN FAS.RED_BANK RED_BANK
                ON RED_BANK.FUND_NO = SWITCH.FUND_NO
               AND RED_BANK.TX_DATE = SWITCH.TX_DATE
               AND RED_BANK.BROKER_NO = SWITCH.BROKER_NO
               AND RED_BANK.BRANCH_NO = SWITCH.BRANCH_NO
               AND RED_BANK.SER_NO = SWITCH.SER_NO
              -- 2021.09.03 Chengyu 2.修正轉申購資料顯示
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.ID = SWITCH.ID
               AND FAS_PURCHASE.FUND_NO_OUT = SWITCH.FUND_NO
               AND FAS_PURCHASE.TX_DATE_OUT = SWITCH.TX_DATE
               AND FAS_PURCHASE.BROKER_NO = SWITCH.BROKER_NO
               AND FAS_PURCHASE.BRANCH_NO = SWITCH.BRANCH_NO
               AND FAS_PURCHASE.ORG_SER_NO = SWITCH.SER_NO
               AND FAS_PURCHASE.FUND_NO = RED_BANK.FUND_NO_IN
              JOIN FAS.FUND FUND_IN
                ON FUND_IN.FUND_NO = FAS_PURCHASE.FUND_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY_IN
                ON FUND_IN.CURRENCY_NO = FUND_CURRENCY_IN.CURRENCY_NO
              -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
              LEFT JOIN (SELECT * FROM NAV.NAV WHERE NAV_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) NAV_IN
                ON NAV_IN.FUND_NO = FAS_PURCHASE.FUND_NO
               AND NAV_IN.NAV_DATE = FAS_PURCHASE.AC_DATE
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE
              --  ON V_CURRENCY_RATE.FUND_NO = SWITCH.FUND_NO
              -- AND V_CURRENCY_RATE.TX_DATE = SWITCH.EX_DATE
              --LEFT JOIN (SELECT * FROM FAS.V_CURRENCY_RATE WHERE TX_DATE BETWEEN ADD_MONTHS(WTX_DATE_FROM, -1) AND WTX_DATE_TO) V_CURRENCY_RATE_IN
              --  ON V_CURRENCY_RATE_IN.FUND_NO = RED_BANK.FUND_NO_IN
              -- AND V_CURRENCY_RATE_IN.TX_DATE = SWITCH.EX_DATE
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_OUT -- 欄位選單資料(轉出基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_OUT.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_OUT.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ_IN  -- 欄位選單資料(轉入基金配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ_IN.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ_IN.TEXT_VALUE = FUND.DIVIDEND_FREQ
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE SWITCH.ID = XID
               -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'5' ) AND SWITCH.BRANCH_NO NOT IN ('8000','8200','8300','8400','8800')) -- 轉申購：8300；
               -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
               -- 書面交易成功： FAS.REDEMPTION.STATUS = 'S' or 'T'
               AND (TX_STATUS.TX_STATUS = 'S' AND SWITCH.STATUS IN ('S','T')) 
               AND SWITCH.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
               --有轉申購日期為轉申購資料
               AND SWITCH.ST_DATE IS NOT NULL
           ) DataList
             -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
             --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
             --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
             ORDER BY TX_DATE,                          --交易日期
                      CASE WHEN STATUS = 'C' THEN 1     --處理中
                           WHEN STATUS = 'S' THEN 2     --交易成功
                           WHEN STATUS = 'F' THEN 3     --交易失敗
                           ELSE 4 END,                  --交易狀態
                      FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS_OUT NULLS FIRST, ORDINAL;
    -- =============================================================== 轉申購 END ===============================================================

    -- ============================================================== 網路/書面定額 BNG ==============================================================
    -- 2018.09.05 tingting MOD BY 1.修正轉申購手續費欄位錯誤 
    --                            2.(不)定額扣款列表 分開拆成定額扣款列表、不定額扣款列表及相關調整 
    --                            3.申購列表、定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金 
    --                            4.不定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金、加碼點(%)、加碼金額、減碼點(%)、減碼金額
    OPEN RSPDT FOR
    SELECT  ROWNUM AS ROW_NUM                                     -- 排列序號
           ,DataList.*
      FROM (
            -- EC 網路申購
            SELECT  PURCHASE.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,'P8' AS PRODUCT_TYPE                          -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME('P8') AS PRODUCT_NAME                     -- 產品類別名稱
                   -- 2018.09.07 tingting MOD BY 定額扣款列表、不定額扣款列表增加傳出欄位：每月扣款日
                   ,PURCHASE.AC_DAY                               -- 每月扣款日
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 基金風險屬性
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(FAS_PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                         ELSE NVL(FAS_PURCHASE.NTD_AMOUNT,0) 
                     END AS NTD_AMOUNT                            -- 台幣申購價金
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                               ELSE 0
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                               ELSE 0 
                           END, 0) AS NTD_TOT_AMOUNT   -- 台幣申購總價金
                   -- 2019.04.29 tingting 修正定額扣款列表、不定額扣款列表單位數錯誤
                   ,FAS_PURCHASE.SHARES                           -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                         ELSE 0 
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   -- 2018.11.09 PEN MOD 網路定額、網路不定額列表 調整 處理中 的判斷條件
                   ,CASE WHEN PURCHASE.STATUS = 'C' OR PURCHASE.STATUS = 'O' THEN 'C'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN 'F'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN 'S'
                         ELSE '' 
                     END AS STATUS                                -- 交易狀態代碼
                   ,CASE WHEN PURCHASE.STATUS = 'C' OR PURCHASE.STATUS = 'O' THEN '處理中'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN '交易失敗'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN '交易成功'
                         ELSE '' 
                     END AS STATUS_NAME                           -- 交易狀態
                   ,PURCHASE.BROKER_NO                            -- 銷售機構代碼
                   ,PURCHASE.BRANCH_NO                            -- 銷售機構分行代碼
                   ,PURCHASE.SER_NO                               -- 成交序號
                   ,'4' AS PAY_TYPE                               -- 付款方式
                   ,'扣款' AS PAY_TYPE_NAME                       -- 付款方式名稱
                   -- 2018.09.07 tingting MOD BY 1.申購列表' 定額扣款列表、不定額扣款列表 增加傳出欄位：扣款總行代碼、扣款分行代碼、扣款銀行簡稱、扣款帳號、扣款帳號後5碼
                   --                            2.調整申購列表 交易狀態 = S：交易成功 的取資料方式(Mark掉Union上面那段，從下面那段出資料)
                   ,PURCHASE.AC_BANK                              -- 扣款總行代碼
                   ,PURCHASE.AC_BRANCH                            -- 扣款分行代碼
                   ,FIS_BRANCH.SNAME AS  FIS_SNAME                -- 扣款銀行簡稱
                   ,PURCHASE.AC_CODE                              -- 扣款帳號
                   ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,PURCHASE.REVISION_DATE AS RCV_DATE            -- 委託日期(含時分秒)
                   ,PURCHASE.FEE_CHOICE AS FEE_CHOICE_TYPE        -- 優惠方案代碼
                   -- 2019.05.09 tingting 調整促銷活動名稱顯示
                   -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
                   -- 2024.08.01 RICHARD begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
--                   -- 2024.05.24 RICHARD begin 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                   --,CASE WHEN PURCHASE.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
--                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','5') THEN CAMPAIGN.CAMPAIGN_SHNM
--                   -- 2024.05.24 richard end 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
--                         WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵'
--                         -- 2024.05.24 richard begin 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         --WHEN PURCHASE.FEE_CHOICE = '5' THEN '生日優惠'
--                         -- 2024.05.24 richard end 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
--                         END AS FEE_CHOICE_NAME                   -- 優惠方案名稱
                   -- 2024.08.01 RICHARD begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
--                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','5') THEN CAMPAIGN.CAMPAIGN_SHNM
--                         WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
--                         WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵'
                     ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','2','3','5') THEN CAMPAIGN.CAMPAIGN_SHNM
                   -- 2024.08.01 RICHARD end 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
                         WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
                         END AS FEE_CHOICE_NAME                   -- 優惠方案名稱
                   -- 2024.08.01 RICHARD end 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
                   ,PURCHASE.PROJECT_CODE                         -- 促銷活動代碼
                   ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME        -- 促銷活動名稱
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM FAS.EC_RSP_PURCHASE PURCHASE
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.ID = PURCHASE.ID
               AND FAS_PURCHASE.FUND_NO = PURCHASE.FUND_NO
               AND FAS_PURCHASE.TX_DATE = PURCHASE.TX_DATE
               AND FAS_PURCHASE.BRANCH_NO = PURCHASE.BRANCH_NO
               AND FAS_PURCHASE.SER_NO = PURCHASE.SER_NO
               -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN ECS.RSP RSP
                ON RSP.ID = PURCHASE.ID
               AND RSP.ID_SEQ = PURCHASE.ID_SEQ
              LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH
                ON FIS_BRANCH.BANK_NO = PURCHASE.AC_BANK
               AND FIS_BRANCH.BRANCH_NO = PURCHASE.AC_BRANCH
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN ECS.CAMPAIGN            -- 促銷活動
                ON CAMPAIGN.CAMPAIGN_CODE = PURCHASE.PROJECT_CODE
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'2' ) AND PURCHASE.BRANCH_NO = '8200') -- 網路定額：8200
               -- 2018.11.09 PEN MOD 網路定額、網路不定額列表 調整 處理中 的判斷條件
               AND (  (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') -- 交易成功：STATUS='P' AND RESULT_CODE = '00'；處理中：STATUS='C'；交易失敗：STATUS='P' AND RESULT_CODE <> '00'
                   OR (TX_STATUS.TX_STATUS = 'C' AND PURCHASE.STATUS IN ('C','O')) 
                   OR (TX_STATUS.TX_STATUS = 'F' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00'))
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
             UNION
             -- 2021.06.24 Chengyu 新增書面資料
             SELECT  PURCHASE.FUND_NO                             -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,PERIODIC.PRODUCT_TYPE AS PRODUCT_TYPE         -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME(PERIODIC.PRODUCT_TYPE) AS PRODUCT_NAME                    -- 產品類別名稱
                   ,PURCHASE.AC_DAY                               -- 每月扣款日
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 基金風險屬性
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                         ELSE 0
                     END AS NTD_AMOUNT                            -- 台幣申購價金  
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                               ELSE 0
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                               ELSE 0 
                           END, 0) AS NTD_TOT_AMOUNT   -- 台幣申購總價金
                   ,PURCHASE.SHARES                               -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                         ELSE 0 
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
                   ,'S' STATUS                                    -- 交易狀態代碼
                   ,'交易成功' AS STATUS_NAME                     -- 交易狀態
                   ,PERIODIC.BROKER_NO                            -- 銷售機構代碼
                   ,PERIODIC.BRANCH_NO                            -- 銷售機構分行代碼
                   ,CAST(PERIODIC.SER_NO AS VARCHAR2(10)) SER_NO  -- 成交序號
                   ,'4' AS PAY_TYPE                               -- 付款方式
                   ,'扣款' AS PAY_TYPE_NAME                       -- 付款方式名稱
                   ,PURCHASE.AC_BANK                              -- 扣款總行代碼
                   ,'' AS AC_BRANCH                               -- 扣款分行代碼(後台未記錄扣款當下分行)
                   ,FIS_BANK.SNAME AS  FIS_SNAME                  -- 扣款銀行簡稱
                   ,PURCHASE.AC_CODE                              -- 扣款帳號
                   ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS RCV_DATE-- 委託日期(含時分秒)
                   ,'' AS FEE_CHOICE_TYPE                         -- 優惠方案代碼
                   ,'' AS FEE_CHOICE_NAME                         -- 優惠方案名稱
                   ,'' AS PROJECT_CODE                            -- 促銷活動代碼(書面定額促銷活動處理方式不同)
                   ,'' AS PROJECT_NAME                            -- 促銷活動名稱(書面定額促銷活動處理方式不同)
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM FAS.PERIODIC_PURCHASE PURCHASE
              JOIN FAS.PERIODIC
                ON PERIODIC.ID = PURCHASE.ID
               AND PERIODIC.ID_SEQ = PURCHASE.ID_SEQ
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN FAS.FIS_BANK FIS_BANK
                ON FIS_BANK.BANK_NO = PURCHASE.AC_BANK
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'2' ) AND PERIODIC.PRODUCT_TYPE = 'P1') 
               -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
               -- 書面定額交易成功： 只顯示成功資料，FAS.PERIODIC_PURCHASE.RESULT_CODE = '00'  AND PERIODIC_PURCHASE.SHARES > 0
               AND (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.RESULT_CODE = '00'  AND PURCHASE.SHARES > 0)
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
           ) DataList
     -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
     --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
     --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
     ORDER BY TX_DATE,                          --交易日期
              CASE WHEN STATUS = 'C' THEN 1     --處理中
                   WHEN STATUS = 'S' THEN 2     --交易成功
                   WHEN STATUS = 'F' THEN 3     --交易失敗
                   ELSE 4 END,                           --交易狀態
              FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS NULLS FIRST, ORDINAL;    
    -- ============================================================== 網路/書面定額 END ==============================================================

    -- 2018.09.05 tingting MOD BY 1.修正轉申購手續費欄位錯誤 
    --                            2.(不)定額扣款列表 分開拆成定額扣款列表、不定額扣款列表及相關調整 
    --                            3.申購列表、定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金 
    --                            4.不定額扣款列表增加傳出欄位：申購總價金、台幣申購總價金、加碼點(%)、加碼金額、減碼點(%)、減碼金額
    -- ============================================================= 網路/書面不定額 BNG ==============================================================
    OPEN DRSPDT FOR
    SELECT  ROWNUM AS ROW_NUM                                     -- 排列序號
           ,DataList.*
      FROM (
            -- EC 網路申購
            SELECT  PURCHASE.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,'P9' AS PRODUCT_TYPE                          -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME('P9') AS PRODUCT_NAME                   -- 產品類別名稱
                   -- 2018.09.07 tingting MOD BY 定額扣款列表、不定額扣款列表增加傳出欄位：每月扣款日
                   ,PURCHASE.AC_DAY                               -- 每月扣款日
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 風險屬性
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(FAS_PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金
                   -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤  
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示                 
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                         ELSE 0 
                     END AS NTD_AMOUNT                            -- 台幣申購價金
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_AMOUNT IS NOT NULL THEN FAS_PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.AMOUNT IS NOT NULL THEN FAS_PURCHASE.AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.AMOUNT
                               ELSE 0 
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                               ELSE 0 
                           END, 0) AS NTD_TOT_AMOUNT   -- 台幣申購總價金
                   -- 2019.04.29 tingting 修正定額扣款列表、不定額扣款列表單位數錯誤
                   ,FAS_PURCHASE.SHARES                           -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND FAS_PURCHASE.SERVICE_CHARGE IS NOT NULL THEN FAS_PURCHASE.SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN PURCHASE.SERVICE_CHARGE
                         ELSE 0 
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   -- 2018.11.09 PEN MOD 網路定額、網路不定額列表 調整 處理中 的判斷條件
                   ,CASE WHEN PURCHASE.STATUS = 'C' OR PURCHASE.STATUS = 'O' THEN 'C'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN 'F'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN 'S'
                         ELSE '' 
                     END AS STATUS                                -- 交易狀態代碼
                   ,CASE WHEN PURCHASE.STATUS = 'C' OR PURCHASE.STATUS = 'O' THEN '處理中'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN '交易失敗'
                         WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00' THEN '交易成功'
                         ELSE '' 
                     END AS STATUS_NAME                           -- 交易狀態
                   ,PURCHASE.BROKER_NO                            -- 銷售機構代碼
                   ,PURCHASE.BRANCH_NO                            -- 銷售機構分行代碼
                   ,PURCHASE.SER_NO                               -- 成交序號
                   ,'4' AS PAY_TYPE                               -- 付款方式
                   ,'扣款' AS PAY_TYPE_NAME                       -- 付款方式名稱
                   -- 2018.12.05 JIANXIN 不定額百分比顯示調整
                   ,RSP.RAISE_ROI * 100 AS RAISE_ROI              -- 加碼點(%)
                   ,RSP.RAISE_AMOUNT                              -- 加碼金額
                   -- 2018.12.05 JIANXIN 不定額百分比顯示調整
                   ,RSP.REDUCE_ROI * 100 AS REDUCE_ROI            -- 減碼點(%)
                   ,RSP.REDUCE_AMOUNT                             -- 減碼金額
                   -- 2018.09.07 tingting MOD BY 1.申購列表' 定額扣款列表、不定額扣款列表 增加傳出欄位：扣款總行代碼、扣款分行代碼、扣款銀行簡稱、扣款帳號、扣款帳號後5碼
                   --                            2.調整申購列表 交易狀態 = S：交易成功 的取資料方式(Mark掉Union上面那段，從下面那段出資料)
                   ,PURCHASE.AC_BANK                              -- 扣款總行代碼
                   ,PURCHASE.AC_BRANCH                            -- 扣款分行代碼
                   ,FIS_BRANCH.SNAME AS  FIS_SNAME                -- 扣款銀行簡稱
                   ,PURCHASE.AC_CODE                              -- 扣款帳號
                   ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,PURCHASE.REVISION_DATE AS RCV_DATE            -- 委託日期(含時分秒)
                   ,PURCHASE.FEE_CHOICE AS FEE_CHOICE_TYPE        -- 優惠方案代碼
                   -- 2019.05.09 tingting 調整促銷活動名稱顯示
                   -- 2019.05.14 tingting 修正促銷活動名稱顯示(語法問題造成網路費率無法顯示)
                   -- 2024.08.01 richard begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
--                   -- 2024.05.24 richard begin 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                   --,CASE WHEN PURCHASE.FEE_CHOICE = '1' THEN CAMPAIGN.CAMPAIGN_SHNM
--                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','5') THEN CAMPAIGN.CAMPAIGN_SHNM
--                   -- 2024.05.24 richard end 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
--                         WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵'
--                         -- 2024.05.24 richard begin 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         --WHEN PURCHASE.FEE_CHOICE = '5' THEN '生日優惠'
--                         -- 2024.05.24 richard end 調整PURCHASE.FEE_CHOICE = '5' 由固定hard code改為,campaign.campagin_shnm
--                         WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
--                         END AS FEE_CHOICE_NAME                   -- 優惠方案名稱

                   -- 2024.08.01 richard begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
--                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','5') THEN CAMPAIGN.CAMPAIGN_SHNM
--                         WHEN PURCHASE.FEE_CHOICE = '2' THEN '優惠券' || RSP.COUPON_ID
--                         WHEN PURCHASE.FEE_CHOICE = '3' THEN '紅利折抵'
                   -- 2024.08.01 richard begin 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
                   ,CASE WHEN PURCHASE.FEE_CHOICE in ('1','2','3','5') THEN CAMPAIGN.CAMPAIGN_SHNM
                         WHEN PURCHASE.FEE_CHOICE IS NULL THEN '網路費率'
                         END AS FEE_CHOICE_NAME                   -- 優惠方案名稱                         
                   -- 2024.08.01 richard end 調整PURCHASE.FEE_CHOICE in ('2','3') 由固定hard code改為,campaign.campagin_shnm
                   ,PURCHASE.PROJECT_CODE                         -- 促銷活動代碼
                   ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME        -- 促銷活動名稱
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM FAS.EC_RSP_PURCHASE PURCHASE
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN FAS.PURCHASE FAS_PURCHASE
                ON FAS_PURCHASE.ID = PURCHASE.ID
               AND FAS_PURCHASE.FUND_NO = PURCHASE.FUND_NO
               AND FAS_PURCHASE.TX_DATE = PURCHASE.TX_DATE
               AND FAS_PURCHASE.BRANCH_NO = PURCHASE.BRANCH_NO
               AND FAS_PURCHASE.SER_NO = PURCHASE.SER_NO
               -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN ECS.RSP RSP
                ON RSP.ID = PURCHASE.ID
               AND RSP.ID_SEQ = PURCHASE.ID_SEQ
              LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH
                ON FIS_BRANCH.BANK_NO = PURCHASE.AC_BANK
               AND FIS_BRANCH.BRANCH_NO = PURCHASE.AC_BRANCH
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
              LEFT JOIN ECS.CAMPAIGN            -- 促銷活動
                ON CAMPAIGN.CAMPAIGN_CODE = PURCHASE.PROJECT_CODE
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'3' ) AND PURCHASE.BRANCH_NO = '8400') -- 網路不定額 :8400
               -- 2018.11.09 PEN MOD 網路定額、網路不定額列表 調整 處理中 的判斷條件
               AND (  (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') -- 交易成功：STATUS='P' AND RESULT_CODE = '00'；處理中：STATUS='C'；交易失敗：STATUS='P' AND RESULT_CODE <> '00'
                   OR (TX_STATUS.TX_STATUS = 'C' AND PURCHASE.STATUS IN ('C','O')) 
                   OR (TX_STATUS.TX_STATUS = 'F' AND PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00'))
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
           UNION 
           -- 2021.06.24 Chengyu 新增書面資料
           SELECT  PURCHASE.FUND_NO                              -- 基金代碼
                   ,FUND.NAME AS FUND_NAME                        -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO               -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                      -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                   -- 國際證券代碼
                   ,FUND.SHARE_CLASS                              -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME     -- 基金級別名稱
                   ,FUND.CURRENCY_NO AS CURRENCY_NO               -- 基金計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME           -- 基金計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL      -- 基金計價幣別小數位數
                   ,PURCHASE.TX_DATE                              -- 交易日期
                   -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
                   ,PERIODIC.PRODUCT_TYPE AS PRODUCT_TYPE         -- 產品類別：L1：單筆申購；L7：ROBO申購；P8：網路定額；P9：網路不定額；R1：買回；R7：ROBO買回
                   ,ECS.F_GET_PRODUCT_NAME(PERIODIC.PRODUCT_TYPE) AS PRODUCT_NAME                   -- 產品類別名稱
                   ,PURCHASE.AC_DAY                               -- 每月扣款日
                   ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY           -- 付款幣別
                   ,CURRENCY.NAME AS TRADE_CRNCY_NAME             -- 付款幣別名稱
                   ,CURRENCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL     -- 付款幣別小數位數
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY           -- 風險屬性
                   ,CASE WHEN FUND.CURRENCY_NO = PURCHASE.CURRENCY_NO THEN 1 
                         ELSE NVL(PURCHASE.EX_RATE,0)
                     END AS EX_RATE                               -- 參考匯率
                   ,PURCHASE.AMOUNT                               -- 原幣申購價金    
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示         
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                         ELSE 0 
                     END AS NTD_AMOUNT                            -- 台幣申購價金
                   ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE, FUND_CURRENCY.AMT_DECIMAL) AS TOT_AMOUNT    -- 原幣申購總價金
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,ROUND(CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_AMOUNT IS NOT NULL THEN PURCHASE.NTD_AMOUNT
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.AMOUNT IS NOT NULL THEN PURCHASE.AMOUNT
                               ELSE 0 
                           END + 
                          CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                               WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                               ELSE 0 
                           END, 0) AS NTD_TOT_AMOUNT   -- 台幣申購總價金
                   ,PURCHASE.SHARES                               -- 單位數
                   ,FUND.SHARE_DECIMAL                            -- 單位數小數位數
                   ,PURCHASE.AC_DATE                              -- 淨值日期
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END NAV                     -- 淨值 
                   ,FUND.NAV_DECIMAL                              -- 淨值小數位數
                   ,PURCHASE.SERVICE_CHARGE                       -- 原幣手續費 
                   -- 2021.09.03 Chengyu 1.調整申購金額顯示
                   ,CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.NTD_SERVICE_CHARGE IS NOT NULL THEN PURCHASE.NTD_SERVICE_CHARGE
                         WHEN PURCHASE.CURRENCY_NO = 'NTD' AND PURCHASE.SERVICE_CHARGE IS NOT NULL THEN PURCHASE.SERVICE_CHARGE
                         ELSE 0 
                     END AS NTD_SERVICE_CHARGE                    -- 台幣申購手續費
                   -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
                   ,'S' STATUS                                    -- 交易狀態代碼
                   ,'交易成功' AS STATUS_NAME                     -- 交易狀態
                   ,PERIODIC.BROKER_NO                            -- 銷售機構代碼
                   ,PERIODIC.BRANCH_NO                            -- 銷售機構分行代碼
                   ,CAST(PERIODIC.SER_NO AS VARCHAR2(10)) SER_NO  -- 成交序號
                   ,'4' AS PAY_TYPE                               -- 付款方式
                   ,'扣款' AS PAY_TYPE_NAME                       -- 付款方式名稱
                   ,ROI_RATE  AS RAISE_ROI                        -- 加碼點(%)
                   ,PERIODIC.RAISE_AMOUNT AS RAISE_AMOUNT         -- 加碼金額
                   ,0 AS REDUCE_ROI                               -- 減碼點(%)
                   ,0 AS REDUCE_AMOUNT                            -- 減碼金額
                   ,PURCHASE.AC_BANK                              -- 扣款總行代碼
                   ,'' AS AC_BRANCH                               -- 扣款分行代碼(後台未記錄扣款當下分行)
                   ,FIS_BANK.SNAME AS  FIS_SNAME                  -- 扣款銀行簡稱
                   ,PURCHASE.AC_CODE                              -- 扣款帳號
                   ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5  -- 往來帳號後5碼
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE           -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME             -- 配息頻率名稱
                   ,TO_DATE('1900/01/01','YYYY/MM/DD') AS RCV_DATE            -- 委託日期(含時分秒)
                   ,''AS FEE_CHOICE_TYPE                          -- 優惠方案代碼
                   ,''AS FEE_CHOICE_NAME                          -- 優惠方案名稱
                   ,'' AS PROJECT_CODE                            -- 促銷活動代碼(書面定額促銷活動處理方式不同)
                   ,'' AS PROJECT_NAME                            -- 促銷活動名稱(書面定額促銷活動處理方式不同)
                   ,FUND.FUND_CATEGORY
                   ,FUND.AMC_NO
                   ,FUND.SITCA_FUND_TYPE
                   ,FUND.ORDINAL
              FROM FAS.PERIODIC_PURCHASE PURCHASE
              JOIN FAS.PERIODIC
                ON PERIODIC.ID = PURCHASE.ID
               AND PERIODIC.ID_SEQ = PURCHASE.ID_SEQ
              JOIN FAS.FUND
                ON PURCHASE.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = FUND.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN FAS.FIS_BANK FIS_BANK
                ON FIS_BANK.BANK_NO = PURCHASE.AC_BANK
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ              
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             CROSS JOIN (SELECT VALUE1 TX_STATUS
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
                         ) TX_STATUS
             WHERE PURCHASE.ID = XID
               -- 2021.07.19 Chengyu 調整書面與ROBO資料取法
               AND (TX_TYPE.TX_TYPE IN ('ALL' ,'3' )  AND PERIODIC.PRODUCT_TYPE = 'P3') 
               -- 2021.07.21 Chengyu 調整書面與ROBO資料取法(只取交易成功資料)
               -- 書面定額交易成功： 只顯示成功資料，FAS.PERIODIC_PURCHASE.RESULT_CODE = '00'  AND PERIODIC_PURCHASE.shares > 0
               AND (TX_STATUS.TX_STATUS = 'S' AND PURCHASE.RESULT_CODE = '00'  AND PURCHASE.SHARES > 0)
               AND PURCHASE.TX_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
           ) DataList
      -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
      --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
      --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
      ORDER BY TX_DATE,                          --交易日期
               CASE WHEN STATUS = 'C' THEN 1     --處理中
                    WHEN STATUS = 'S' THEN 2     --交易成功
                    WHEN STATUS = 'F' THEN 3     --交易失敗
                    ELSE 4 END,                           --交易狀態
               FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS NULLS FIRST, ORDINAL;
    -- ============================================================= 網路/書面不定額 END =============================================================

    -- ============================================================== 收益分配 BNG ==============================================================
    OPEN DIVDENDDT FOR
    SELECT  ROWNUM AS ROW_NUM                                                                   -- 排列序號
           ,DataList.*
      FROM (
            SELECT  DIVIDEND_DETAIL.DIVIDEND_DATE AS DIVIDEND_DATE                              -- 收益分配日
                   -- 2018.12.03 JIANXIN MOD BY 調整 發放日 由 DIVIDEND 取得
                   ,DIVIDEND.PAYMENT_DATE AS PAYMENT_DATE                                       -- 收益分配發放日
                   ,DIVIDEND_DETAIL.FUND_NO AS FUND_NO                                          -- 基金別
                   ,FUND.NAME AS FUND_NAME                                                      -- 基金名稱
                   ,FUND.DIVIDEND_DESC AS FUND_MEMO                                             -- 基金警語
                   ,FUND.SNAME AS FUND_SNAME                                                    -- 基金簡稱
                   ,FUND.ISIN_CODE AS ISIN_CODE                                                 -- 國際證券代碼
                   ,FUND.SHARE_CLASS AS SHARE_CLASS                                             -- 基金級別
                   ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME                                   -- 基金級別名稱
                   -- 2018.12.06 JIANXIN 調整配息內容交易幣別與計價幣別回傳錯誤
                   -- 2018.12.18 JIANXIN 調整配息的內容
                   -- DIVIDEND_DETAIL.ORG_CURRENCY_NO 為憑證檔中的交易幣別
                   -- DIVIDEND_DETAIL.CURRENCY_NO 為收益分配的付款幣別(包含FCY 或 MMA)
                   -- 2018.12.19 JIANXIN 依據 與瀚亞Ada討論，邏輯調整如下:
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO <> 計價幣 則 回傳 NTD_AMOUT
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO = 計價幣 則 回傳 AMOUT
                   --                    配息=再申購：金額 回傳 AMOUT
                   --                    配息=再申購：交易幣別 回傳 計價幣別
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN FUND.CURRENCY_NO 
                         ELSE DIVIDEND_DETAIL.ORG_CURRENCY_NO
                     END AS TRADE_CRNCY                                                         -- 申購幣別 
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN FUND_CURRENCY.NAME  
                         ELSE CURRENCY.NAME 
                     END AS TRADE_CRNCY_NAME                                                    -- 申購幣別名稱
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN FUND_CURRENCY.AMT_DECIMAL
                         ELSE CURRENCY.AMT_DECIMAL
                     END AS TRADE_AMT_DECIMAL                                                   -- 申購幣別小數位數
                   ,FUND.CURRENCY_NO AS CURRENCY_NO                                             -- 計價幣別
                   ,FUND_CURRENCY.NAME AS CURRENCY_NAME                                         -- 計價幣別名稱
                   ,FUND_CURRENCY.AMT_DECIMAL AS AMT_DECIMAL                                    -- 計價幣別小數位數
                   -- 2018.10.09 ChengYu 增加傳出參數 風險屬性(RISK_CATEGORY)
                   ,FUND.RISK_CATEGORY AS RISK_CATEGORY                                         -- 風險屬性
                   ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL                                         -- 單位數小數位數
                   ,FUND.NAV_DECIMAL AS NAV_DECIMAL                                             -- 淨值小數位數
                   ,DIVIDEND_DETAIL.SHARES AS SHARES                                            -- 持有單位數
                   -- 2018.12.03 JIANXIN MOD BY 調整 每單位分配金額 由 DIVIDEND 取得
                   ,DIVIDEND.DIVIDEND_RATE AS ASSIGN_VALUE                                      -- 每單位分配金額
                   ,DIVIDEND_DETAIL.AMOUNT AS AMOUNT                                            -- 總分配金額(計價幣別)
                   ,DIVIDEND.EX_RATE AS EX_RATE                                                 -- 匯率
                   -- 2018.12.03 JIANXIN MOD BY 調整 總分配金額 取得邏輯
                   -- 2018.12.19 JIANXIN 依據 與瀚亞Ada討論，邏輯調整如下:
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO <> 計價幣 則 回傳 NTD_AMOUT
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO = 計價幣 則 回傳 AMOUT
                   --                    配息=再申購：金額 回傳 AMOUT
                   --                    配息=再申購：交易幣別 回傳 計價幣別
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN DIVIDEND_DETAIL.AMOUNT
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO <> FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.NTD_AMOUNT
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO  THEN DIVIDEND_DETAIL.AMOUNT
                         ELSE DIVIDEND_DETAIL.AMOUNT 
                     END AS TX_AMOUNT                                                           -- 總分配金額(申購幣別)
                   -- 2018.12.18 JIANXIN 調整配息相關費用的內容
                   -- 2018.12.19 JIANXIN 依據 與瀚亞Ada討論，邏輯調整如下:
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO <> 計價幣 則 回傳 NTD_AMOUT
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO = 計價幣 則 回傳 AMOUT
                   --                    配息=再申購：金額 回傳 AMOUT
                   --                    配息=再申購：交易幣別 回傳 計價幣別
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN DIVIDEND_DETAIL.WIRE_FEE
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO <> FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.NTD_WIRE_FEE
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO  THEN DIVIDEND_DETAIL.WIRE_FEE
                         ELSE DIVIDEND_DETAIL.WIRE_FEE 
                     END AS WIRE_FEE                                                            -- 相關費用(申購幣別)
                   -- 2018.12.03 JIANXIN MOD BY 調整 實際分配淨額 取得邏輯
                   -- 2018.12.19 JIANXIN 依據 與瀚亞Ada討論，邏輯調整如下:
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO <> 計價幣 則 回傳 NTD_AMOUT
                   --                    配息=匯款：幣別 回傳 ORG_CURRENCY_NO； ORG_CURRENCY_NO = 計價幣 則 回傳 AMOUT
                   --                    配息=再申購：金額 回傳 AMOUT
                   --                    配息=再申購：交易幣別 回傳 計價幣別
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN DIVIDEND_DETAIL.TOTAL_RETURN
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO <> FUND.CURRENCY_NO THEN DIVIDEND_DETAIL.NTD_TOTAL_RETURN
                         WHEN DIVIDEND_DETAIL.PAY_TYPE IN ('3','4') AND DIVIDEND_DETAIL.ORG_CURRENCY_NO = FUND.CURRENCY_NO  THEN DIVIDEND_DETAIL.TOTAL_RETURN
                         ELSE DIVIDEND_DETAIL.TOTAL_RETURN 
                     END AS TOTAL_RETURN                                                        -- 實際分配淨額(申購幣別)
                   ,DIVIDEND_DETAIL.PAY_TYPE AS PAY_TYPE                                        -- 收益分配方式
                   ,CASE WHEN DIVIDEND_DETAIL.PAY_TYPE = '1' THEN '郵寄支票'                    
                         WHEN DIVIDEND_DETAIL.PAY_TYPE = '2' THEN '轉申購'                      
                         WHEN DIVIDEND_DETAIL.PAY_TYPE = '3' THEN '匯款'                        
                         WHEN DIVIDEND_DETAIL.PAY_TYPE = '4' THEN '匯款 (不受最低金額限制) '    
                         ELSE ''                                                                
                     END AS PAY_TYPE_NAME                                                       -- 收益分配方式名稱
                   ,DIVIDEND_DETAIL.CHEQUE AS CHEQUE                                            -- 郵寄支票號碼
                   ,DIVIDEND_DETAIL.PAY_ADDRESS AS PAY_ADDRESS                                  -- 郵寄地址
                   ,PURCHASE.TX_DATE AS SWITCH_DATE                                             -- 再申購日期
                   ,PURCHASE.AMOUNT AS AMOUNT_IN                                                -- 再申購金額
                   ,PURCHASE.SERVICE_CHARGE AS SERVICE_CHARGE_IN                                -- 再申購手續費
                   -- 2021.10.18 Chengyu 調整淨值資料取法(若交易淨值日期在基金成立日前，淨值傳出10)
                   ,CASE WHEN PURCHASE.AC_DATE < FUND.INCEPTION_DATE THEN 10 
                         ELSE NAV.NAV END AS NAV_IN                                             -- 再申購淨值
                   ,PURCHASE.SHARES AS SHARES_IN                                                -- 再申購單位數
                   ,DIVIDEND_DETAIL.AC_NAME AS AC_NAME                                          -- 匯款銀行戶名
                   ,DIVIDEND_DETAIL.SNAME AS SNAME                                              -- 匯款銀行名稱
                   ,DIVIDEND_DETAIL.BANK_NO AS BANK_NO                                          -- 匯款銀行代碼
                   ,DIVIDEND_DETAIL.BRANCH_NO AS BRANCH_NO                                      -- 匯款銀行分行代碼
                   -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
                   ,ECS.FN_STUFF_STR(DIVIDEND_DETAIL.AC_CODE,5,'*') AS AC_CODE_5                -- 往來帳號後5碼
                   -- 2019.04.17 tingting 因應需求編號"ES_20190315_01"，新增輸出欄位
                   ,CASE WHEN FUND.DIVIDEND_FREQ = 'N' THEN 'N' ELSE 'Y' END AS IS_DIVIDEND     -- 是否為配息
                   ,FUND.DIVIDEND_FREQ AS DIVIDEND_TYPE                                         -- 配息頻率
                   ,ECS_OPTION_DIVIDEND_FREQ.DISPLAY_NAME AS DIVIDEND_TYPE_NAME                 -- 配息頻率名稱
                   -- 2021.09.24 Chengyu 新增欄位除息日
                   ,DIVIDEND.NEXT_DIVIDEND_DATE                                                 -- 除息日
              FROM FAS.DIVIDEND_DETAIL 
              JOIN FAS.DIVIDEND
                ON DIVIDEND_DETAIL.DIVIDEND_DATE = DIVIDEND.DIVIDEND_DATE
               AND DIVIDEND_DETAIL.FUND_NO = DIVIDEND.FUND_NO
               AND DIVIDEND_DETAIL.DIVIDEND_TYPE = DIVIDEND.DIVIDEND_TYPE
              JOIN FAS.FUND 
                ON DIVIDEND_DETAIL.FUND_NO = FUND.FUND_NO
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND.CURRENCY_NO = FUND_CURRENCY.CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY CURRENCY
                ON DIVIDEND_DETAIL.ORG_CURRENCY_NO = CURRENCY.CURRENCY_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               -- 2018.10.08 JIANXIN MOD BY 處理基金級別串接問題
               AND FUND.AMC_NO = FUND_SHARE_CLASS.AMC_NO
              LEFT JOIN FAS.PURCHASE
                ON PURCHASE.ID = DIVIDEND_DETAIL.ID 
               AND PURCHASE.FUND_NO = DIVIDEND.FUND_NO
               -- 2021.10.14 Chengyu 調整分配串接FAS.PURCHASE邏輯(TX_DATE)
               -- 2021.10.28 Chengyu 調整分配串接FAS.PURCHASE邏輯(TX_DATE)
               AND DIVIDEND_DETAIL.DIVIDEND_YEAR IN (TO_CHAR(PURCHASE.TX_DATE,'yyyy'), TO_CHAR(PURCHASE.TX_DATE,'yyyy')-1)
               -- 2021.09.22 Chengyu 修正轉申購時的申購資料串接語法
               AND PURCHASE.SER_NO = DIVIDEND_DETAIL.PUR_SER_NO
               -- 2022.04.21 JIANXIN 調整轉申購配息不能用PUR_SER_NO (因為有一些是空的)
               AND PURCHASE.TX_DATE BETWEEN DIVIDEND_DETAIL.PAYMENT_DATE AND TRUNC(DIVIDEND_DETAIL.PAYMENT_DATE + 20 )
               AND PURCHASE.BROKER_NO = '999'
               -- 2018.08.22 JIANXIN MOD BY 調整收益分配 BRANCH_NO = '7000'
               AND PURCHASE.BRANCH_NO = '7000'
               -- 2019.05.03 tingting 修正單筆申購列表，匯率、台幣申購價金、台幣申購手續費錯誤、淨值錯誤
              LEFT JOIN NAV.NAV
                ON NAV.FUND_NO = PURCHASE.FUND_NO
               AND NAV.NAV_DATE = PURCHASE.AC_DATE
              LEFT JOIN ECS.ECS_OPTION ECS_OPTION_DIVIDEND_FREQ     -- 欄位選單資料(配息頻率)
                ON ECS_OPTION_DIVIDEND_FREQ.SOURCE_TYPE = '054'
               AND ECS_OPTION_DIVIDEND_FREQ.TEXT_VALUE = FUND.DIVIDEND_FREQ
             CROSS JOIN (SELECT VALUE1 TX_TYPE
                           FROM TABLE(ECS.F_FormatStringListToTable(WTX_TYPE))
                         ) TX_TYPE
             -- 2018.09.07 JIANXIN MOD BY 因應系統資料無狀態欄位，進行調整
             --CROSS JOIN (SELECT VALUE1 TX_STATUS
             --              FROM TABLE(ECS.F_FormatStringListToTable(WTX_STATUS))
             --            ) TX_STATUS
             WHERE DIVIDEND_DETAIL.ID = XID
               AND TX_TYPE.TX_TYPE IN ('ALL' ,'6' )  -- 收益分配
               -- 2018.09.07 JIANXIN MOD BY 因應系統資料無狀態欄位，進行調整
               --AND (  (TX_STATUS.TX_STATUS = 'S' AND DIVIDEND_DETAIL.STATUS = 'C') -- 交易成功：STATUS='C' ；處理中：STATUS='O'
               --    OR (TX_STATUS.TX_STATUS = 'C' AND DIVIDEND_DETAIL.STATUS = 'O') )
               -- 2018.09.24 JIANXIN MOD BY 調整日期為配息日
               AND DIVIDEND_DETAIL.DIVIDEND_DATE BETWEEN WTX_DATE_FROM AND WTX_DATE_TO
             -- 2018.10.25 tingting 1.增加傳出欄位：排列序號
             --                     2.調整排序：先依交易日期、交易狀態(處理中→交易成功→交易失敗)
             --                                再依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
             ORDER BY DIVIDEND_DATE,                    --收益分配日
                      FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, FUND.SHARE_CLASS NULLS FIRST, FUND.ORDINAL,DIVIDEND.NEXT_DIVIDEND_DATE
           ) DataList; 
    -- ============================================================== 收益分配 END ==============================================================

    -- ============================================================== 錯誤訊息 BNG ==============================================================
    OPEN ERRDT FOR
    SELECT  XWARNS_TYPE AS WARNS_TYPE
           ,XERROR_MSG AS ERROR_MSG
      FROM DUAL;
    -- ============================================================== 錯誤訊息 END ==============================================================

END;

/

  GRANT EXECUTE ON "ECS"."S_GETHISTORYTRADE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETINTERNALSRNO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETINTERNALSRNO" 
/*****************************************************************************************
**Stored Procedure Name: s_GetInternalSrNo.sql
**Desciption:取系統內部序號，不需要參考取號原則檔的取號方式
*****************************************************************************************/
(
  v_striSrID IN VARCHAR2 DEFAULT NULL ,
  v_striSubSrID IN VARCHAR2 DEFAULT NULL ,
  v_striFixParam IN VARCHAR2 DEFAULT NULL ,
  v_intiIsForceGet IN NUMBER DEFAULT NULL, --若不存在，是否要產生一筆新的紀錄 0：不產生，出現錯誤訊息 1：產生,
  v_stroCurrentSrNo OUT VARCHAR2
)
AS
   v_intPreviousSrNo NUMBER(10,0);
   v_intCurrentSrNo NUMBER(10,0);
   m_v_striSrID VARCHAR2(10):= v_striSrID;
   m_v_striSubSrID VARCHAR2(20):= v_striSubSrID;
   m_v_striFixParam VARCHAR2(20):= v_striFixParam;
   m_v_intiIsForceGet number := v_intiIsForceGet;

BEGIN

   --檢核預設值
   IF v_striSrID IS NULL THEN
      m_v_striSrID := '' ;
   END IF;
   IF v_striSubSrID IS NULL THEN
      m_v_striSubSrID := '' ;
   END IF;
   IF v_intiIsForceGet IS NULL THEN
      m_v_intiIsForceGet := 0 ;
   END IF;
   IF v_striFixParam IS NULL THEN
      m_v_striFixParam := '' ;
   END IF;
   --SQL Statement
   --查詢目前的序號
   SELECT SrNo

     INTO v_intPreviousSrNo
     FROM AA_SrNos 
    WHERE SrID = m_v_striSrID
            AND SubSrID = m_v_striSubSrID
            AND FixParam = m_v_striFixParam;
   --取出目前的序號
   IF v_intPreviousSrNo IS NULL
     AND m_v_intiIsForceGet = 0 THEN

   BEGIN
      raise_application_error( -20002, 's_GetInternalSrNo：此類別序號不存在，請檢查' );
      RETURN;
   END;
   ELSE
      IF v_intPreviousSrNo IS NULL
        AND v_intiIsForceGet = 1 THEN

      BEGIN
         v_intCurrentSrNo := 1 ;
         INSERT INTO AA_SrNos
           ( SrID, SubSrID, FixParam, SrNo, STATUS, CreateID, CreateDate, UpdateID, UpdateDate, VerifyID, VerifyDate, ApproveID, ApproveDate )
           VALUES ( m_v_striSrID, m_v_striSubSrID, m_v_striFixParam, v_intCurrentSrNo, '102', 'sysAdmin', SYSDATE, 'sysAdmin', SYSDATE, 'sysAdmin', SYSDATE, 'sysAdmin', SYSDATE );
      END;
      ELSE

      BEGIN
         v_intCurrentSrNo := v_intPreviousSrNo + 1 ;
         UPDATE AA_SrNos
            SET SrNo = v_intCurrentSrNo,
                STATUS = '102',
                CreateID = 'sysAdmin',
                CreateDate = SYSDATE,
                UpdateID = 'sysAdmin',
                UpdateDate = SYSDATE,
                VerifyID = 'sysAdmin',
                VerifyDate = SYSDATE,
                ApproveID = 'sysAdmin',
                ApproveDate = SYSDATE
            WHERE SrID = m_v_striSrID
           AND SubSrID = m_v_striSubSrID
           AND FixParam = m_v_striFixParam;
      END;
      END IF;
   END IF;
   v_stroCurrentSrNo := m_v_striFixParam || 
   CAST(v_intCurrentSrNo AS VARCHAR2);
END;

/

  GRANT EXECUTE ON "ECS"."S_GETINTERNALSRNO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETINVESTMENT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETINVESTMENT" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/02/22
-- Description: 取得投資類型列表
-- 2018.03.05 MOD BY JIM FOR 當IS_ALL=Y時，回傳ALL和全部
-- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
    WIS_ALL        VARCHAR2,                      -- 是否需要全部的選項
    OUTDT          OUT SYS_REFCURSOR              -- 回傳的 TABLEDATA
) IS

XSYSDATE DATE := SYSDATE;

BEGIN

    OPEN OUTDT FOR
     SELECT INVESTMENT_TYPE.*
       FROM
            ( 
              -- 2018.10.19 JIANXIN MOD BY 依據可交易基金回傳資料
             SELECT  DISTINCT FUND.INVESTMENT_TYPE                               --投資類型
                    ,NVL(INVESTMENT_TYPE.NAME,FUND.INVESTMENT_TYPE) AS NAME      --投資類型名稱
               FROM FAS.FUND
               LEFT JOIN FAS.INVESTMENT_TYPE INVESTMENT_TYPE
                 ON INVESTMENT_TYPE.INVESTMENT_TYPE = FUND.INVESTMENT_TYPE
              WHERE FUND.OFFERING_TYPE = '1'                       -- 募集方式 1：公開募集；2：私募
                AND ( FUND.SALES_TYPE = '0')
                -- 2019.02.19 tingting 調整已清算基金條件語法
                AND (
                      -- 境內基金清算日期判斷 CLEAR_DATE
                      (     
                        FUND.FUND_CATEGORY = '1' 
                        AND  
                        (
                          (FUND.CLEAR_DATE IS NULL) 
                          OR 
                          (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                        )
                      )              
                      OR
                      -- 境外基金清算日期判斷 ELIMINATION_DATE
                      (     
                        FUND.FUND_CATEGORY = '2' 
                        AND  
                        (
                          (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                          OR 
                          (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                          OR 
                          (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                        )
                      )
                    )
                AND (  IS_EC = 'Y' AND (IS_EC_PURCHASE = 'Y' OR IS_EC_PERIODIC  = 'Y'))
              UNION
             SELECT 'ALL'    AS INVESTMENT_TYPE
                    ,'全部'  AS NAME
               FROM DUAL
              WHERE WIS_ALL = 'Y'
           ) INVESTMENT_TYPE
       ORDER BY DECODE(INVESTMENT_TYPE.INVESTMENT_TYPE,'ALL',1),INVESTMENT_TYPE.INVESTMENT_TYPE;

END s_GetInvestment;

/

  GRANT EXECUTE ON "ECS"."S_GETINVESTMENT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETINVESTQUEST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETINVESTQUEST" 
(
     OUTDT1                  OUT SYS_REFCURSOR           -- MarriageList 婚姻狀況列表
    ,OUTDT2                  OUT SYS_REFCURSOR           -- ChildrenList 子女數列表
    ,OUTDT3                  OUT SYS_REFCURSOR           -- EducationList 教育程度列表
    ,OUTDT4                  OUT SYS_REFCURSOR           -- InComeList 家庭年收入列表
    ,OUTDT5                  OUT SYS_REFCURSOR           -- LiveStatusList 居住狀況列表
    ,OUTDT6                  OUT SYS_REFCURSOR           -- InvestmentList 投資金額列表
    ,OUTDT7                  OUT SYS_REFCURSOR           -- InvestTypeList 投資理財工具列表
    ,OUTDT8                  OUT SYS_REFCURSOR           -- InvestStandOnList 投資依據列表
    ,OUTDT9                  OUT SYS_REFCURSOR           -- InvestInfoList 投資訊息列表

) IS
BEGIN  
   -- MarriageList 婚姻狀況列表
   OPEN OUTDT1 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '002';

   -- ChildrenList 子女數列表
   OPEN OUTDT2 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '003';

   -- EducationList 教育程度列表
   OPEN OUTDT3 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '004';

   -- InComeList 家庭年收入列表
   OPEN OUTDT4 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '005';

    -- LiveStatusList 居住狀況列表
   OPEN OUTDT5 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '001';

    -- InvestmentList 投資金額列表
   OPEN OUTDT6 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '006';

    -- InvestTypeList 投資理財工具列表
   OPEN OUTDT7 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '007';

    -- InvestStandOnList 投資依據列表
   OPEN OUTDT8 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '008';

    -- InvestInfoList 投資訊息列表
   OPEN OUTDT9 FOR
        SELECT  ECS_OPTION.TEXT_VALUE AS OPTION_CODE         -- 選項代碼
               ,ECS_OPTION.DISPLAY_NAME AS OPTION_NM         -- 選項說明
               ,ECS_OPTION.DISPLAY_ORDER AS DISPLAY_ORDER    -- 顯示順序
          FROM ECS.ECS_OPTION ECS_OPTION
         WHERE ECS_OPTION.SOURCE_TYPE = '009'; 

END s_GetInvestQuest;

/

  GRANT EXECUTE ON "ECS"."S_GETINVESTQUEST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETLOSSANDGAINSETUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETLOSSANDGAINSETUP" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/04/10
-- Description: 取得停損停利資料
-- 2018.05.09 MOD BY JIM 新增ShareClass,ShareClassName
-- 2018.05.18 Mod By Jim 修改SELECT順序
-- 2018.05.18 MOD BY JIM 因ECS.FUND_SHARE_CLASS架構更改，多了AMC_NO的KEY 
-- 2018.09.17 YungLong 增加傳出欄位：基金公司代碼、基金公司名稱、計價幣別、計價幣別名稱、風險屬性、投資類型、投資類型名稱、基金投資地區、基金投資地區名稱、配息頻率、配息頻率名稱
-- 2018.10.23 tingting 增加基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
-- 2019.01.24 yunchu 調整基金配息資訊、類別、通知方式、通知頻率條件
-- =============================================
(
     WACCOUNT_NO            INTEGER                     -- 受益人戶號
    ,OUTDT                  OUT SYS_REFCURSOR           -- MASTER
    ,OUTDT2                 OUT SYS_REFCURSOR
) IS
BEGIN

  DECLARE XID VARCHAR2(10);            -- ID

  BEGIN

    BEGIN
       SELECT HOLDER.ID
         INTO XID
         FROM FAS.HOLDER HOLDER
        WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

       EXCEPTION
            WHEN NO_DATA_FOUND THEN
                 RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
     END;

    -- MASTER
    OPEN OUTDT FOR
        SELECT  FUND.FUND_NO                               -- 基金別
               ,FUND_ALERT.TYPE                            -- 類別 0.我的投資組合；1.我的基金觀察
               ,FUND_ALERT_TYPE.ALERT_TYPE                 -- 通知方式 1. 網頁通知；2. EMail通知。
               ,FUND_ALERT_TYPE.ALERT_FREQ                 -- 通知頻率 1. 通知我一次；E. 每次通知我。
               ,FUND_ALERT.ALERT_PRU                       -- 到價提示單位\1：淨值；2：報酬率
               ,FUND_ALERT.UPPER_LIMIT                     -- 停利(%)
               ,FUND_ALERT.LOWER_LIMIT                     -- 停損(%)
               ,FUND_ALERT.BUY_IN                          -- 買進價位
               ,FUND_ALERT.SELL_OUT                        -- 賣出價位
               ,FUND_ALERT.ALERT                           -- 警示設定 Y.啟動通知；N.關閉通知
               -- 2018.09.17 YungLong 增加傳出欄位：基金公司代碼、基金公司名稱、計價幣別、計價幣別名稱、風險屬性、投資類型、投資類型名稱、基金投資地區、基金投資地區名稱、配息頻率、配息頻率名稱
               ,FUND.AMC_NO                                             -- 基金經理公司
               ,AMC.NAME AS AMC_NAME                                    -- 基金公司名稱
               ,FUND.CURRENCY_NO                                        -- 計價幣別
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                      -- 計價幣別名稱
               ,FUND.INVESTMENT_TYPE                                    -- 投資類型
               ,FUND.RISK_CATEGORY                                      -- 風險屬性
               ,INVESTMENT_TYPE.NAME AS INVESTMENT_TYPE_NAME            -- 投資類型名稱
               ,FUND.AREA_TYPE                                          -- 基金投資地區
               ,FUND_AREA.DESCRIPTION AS AREA_NAME                      -- 基金投資地區名稱
               ,FUND_DIVIDEND.DIVIDEND_TYPE                             -- 配息頻率
               ,CASE WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'M' THEN '月配' 
                     WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'Q' THEN '季配'
                     WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'S' THEN '半年配'
                     WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'Y' THEN '年配'
                END AS DIVIDEND_TYPE_NAME                               -- 配息頻率名稱
               ,NVL(FUND_SHARE_CLASS.SHARE_CLASS,'') AS SHARE_CLASS     -- 級別代碼
               ,NVL(FUND_SHARE_CLASS.NAME,'') AS SHARE_CLASS_NAME       -- 級別名稱
          FROM WPS.FUND_ALERT FUND_ALERT
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = FUND_ALERT.FUND_NO
          LEFT JOIN WPS.FUND_ALERT_TYPE FUND_ALERT_TYPE
            ON FUND_ALERT.FUND_NO = FUND_ALERT_TYPE.FUND_NO
           AND FUND_ALERT.ID = FUND_ALERT_TYPE.ID
           AND FUND_ALERT.TYPE = FUND_ALERT_TYPE.TYPE
           -- 2018.09.17 YungLong JOIN AMC, V_FUND_CRNCY, INVESTMENT_TYPE, FUND_AREA
          LEFT JOIN FAS.AMC AMC
            ON AMC.AMC_NO = FUND.AMC_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN FAS.INVESTMENT_TYPE INVESTMENT_TYPE
            ON INVESTMENT_TYPE.INVESTMENT_TYPE = FUND.INVESTMENT_TYPE
          LEFT JOIN FAS.FUND_AREA FUND_AREA
            ON FUND_AREA.AREA_TYPE = FUND.AREA_TYPE
         -- 2019.01.24 yunchu 調整基金配息資訊、類別、通知方式、通知頻率條件
          LEFT JOIN (SELECT DISTINCT FUND_NO,DIVIDEND_TYPE FROM WPS.FUND_DIVIDEND) FUND_DIVIDEND
            ON FUND_DIVIDEND.FUND_NO = FUND.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS
            ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS 
           AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         WHERE FUND_ALERT.ID = XID
         -- 2019.01.24 yunchu 調整基金配息資訊、類別、通知方式、通知頻率條件
           AND FUND_ALERT.TYPE = '0'
           AND FUND_ALERT_TYPE.ALERT_TYPE IN ('1','2')
           AND FUND_ALERT_TYPE.ALERT_FREQ IN ('1','E')
         -- 2018.10.23 tingting 增加基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
         ORDER BY FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL;

     OPEN OUTDT2 FOR
          SELECT FUND.FUND_NO,                             -- 基金別
                 FUND_SHARE_CLASS.SHARE_CLASS,             --級別代碼
                 FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME --級別名稱
            FROM FAS.FUND
            JOIN ECS.FUND_SHARE_CLASS
              ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
             -- 2018.05.18 MOD BY JIM 因Table架構更改，多了AMC_NO的KEY  
             AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO;

  END;

END s_GetLossAndGainSetup;

/

  GRANT EXECUTE ON "ECS"."S_GETLOSSANDGAINSETUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETLUMPAMT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETLUMPAMT" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/09/25
-- Description: 取得當天網路申購總金額
-- =============================================
(
    WACCOUNT_NO     INTEGER,    -- 受益人戶號
    WTX_DATE        DATE,       -- 交易日期
    OUTDT           OUT SYS_REFCURSOR
) IS

XID                 VARCHAR2(10);     -- 受益人ID

BEGIN
    BEGIN
          -- 取得受益人ID
          SELECT ID
            INTO XID
            FROM FAS.HOLDER
            WHERE ACCOUNT_NO = WACCOUNT_NO;
    END;

    OPEN OUTDT FOR
        SELECT   PURCHASE.FUND_NO AS FUND_NO
                ,FUND.NAME AS FUND_NAME
                ,FUND.ISIN_CODE AS ISIN_CODE
                ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY
                ,V_FUND_CRNCY.NAME AS TRADE_CRNCY_NM
                ,FUND.AMT_DECIMAL AS AMT_DECIMAL
                ,PURCHASE.AMOUNT AS AMOUNT
                ,PURCHASE.SERVICE_CHARGE AS SERVICE_CHARGE
                ,(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE) AS TOT_AMOUNT
           FROM ECS.PURCHASE PURCHASE
           LEFT JOIN FAS.FUND FUND
             ON FUND.FUND_NO = PURCHASE.FUND_NO
           LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
             ON V_FUND_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
          WHERE PURCHASE.ID = XID
            AND TX_DATE = WTX_DATE
        UNION
       SELECT    EC_RSP_PURCHASE.FUND_NO AS FUND_NO
                ,FUND.NAME AS FUND_NAME
                ,FUND.ISIN_CODE AS ISIN_CODE
                ,EC_RSP_PURCHASE.CURRENCY_NO AS TRADE_CRNCY
                ,V_FUND_CRNCY.NAME AS TRADE_CRNCY_NM
                ,FUND.AMT_DECIMAL AS AMT_DECIMAL
                ,EC_RSP_PURCHASE.AMOUNT AS AMOUNT
                ,EC_RSP_PURCHASE.SERVICE_CHARGE AS SERVICE_CHARGE
                ,(EC_RSP_PURCHASE.AMOUNT + EC_RSP_PURCHASE.SERVICE_CHARGE) AS TOT_AMOUNT
           FROM FAS.EC_RSP_PURCHASE EC_RSP_PURCHASE
           LEFT JOIN FAS.FUND FUND
             ON FUND.FUND_NO = EC_RSP_PURCHASE.FUND_NO
           LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
             ON V_FUND_CRNCY.CURRENCY_NO = EC_RSP_PURCHASE.CURRENCY_NO
          WHERE EC_RSP_PURCHASE.ID = XID
            AND TX_DATE = WTX_DATE;

END s_GetLumpAmt;

/

  GRANT EXECUTE ON "ECS"."S_GETLUMPAMT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMAILADDR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMAILADDR" 
(
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
        SELECT POST_AREA.CITY              --城市
               ,POST_AREA.AREA             --市區鄉鎮
               ,POST_AREA.POST_CODE        --郵遞區號(全型)
          FROM FAS.POST_AREA POST_AREA
         GROUP BY POST_AREA.CITY,POST_AREA.AREA,POST_AREA.POST_CODE
         ORDER BY POST_AREA.POST_CODE;

END s_GetMailAddr;

/

  GRANT EXECUTE ON "ECS"."S_GETMAILADDR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMAINFUNCTION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMAINFUNCTION" 
(
  striUSERID IN VARCHAR2  
, striPRODUCTID IN VARCHAR2  
, p_ResultSet        OUT  TYPES.cursorType
) AS 
BEGIN
 OPEN p_ResultSet FOR
  Select 
 cast(DATAID as char(38)) as DATAID
 ,cast(NODEID as char(10)) as NODEID
  ,cast(NODETEXT as VARCHAR2(100)) as NODETEXT
 ,cast(PARENTNODEID as char(10)) as PARENTNODEID
  ,NODETYPE
  ,cast(FUNCTIONID as char(20)) as FUNCTIONID 
  ,ORDERS
  ,cast( STATUS as char(6)) as  STATUS
   from Table(cast (f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table))
;
END S_GETMAINFunction;

/*
VARIABLE resultSet  REFCURSOR
EXEC S_GETMAINMENU('HowARDa','', :resultSet);
PRINT :resultSet
*/

/

  GRANT EXECUTE ON "ECS"."S_GETMAINFUNCTION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMAINMENU
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMAINMENU" 
(p_ResultSet        OUT  TYPES.cursorType
) AS 
BEGIN
 OPEN p_ResultSet FOR

/*  
Select distinct
cast(AA_TREEPATTERN.DATAID as char(38)) as DATAID
,cast(AA_TREEPATTERN.NODEID as char(10)) as NODEID 
,cast(AA_TREEPATTERN.NODETEXT as VARCHAR2(100)) as NODETEXT
,cast(AA_TREEPATTERN.PARENTNODEID as char(10)) as PARENTNODEID
,AA_TREEPATTERN.NODETYPE
,cast(AA_TREEPATTERN.FUNCTIONID as char(20)) as FUNCTIONID
,AA_TREEPATTERN.ORDERS
,cast( AA_TREEPATTERN.STATUS as char(6)) as  STATUS 
from AA_TREEPATTERN 
, Table(cast(f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table)) FunctionCollections
where
AA_TREEPATTERN.FunctionID =  FunctionCollections.functionid(+)
and 
AA_TREEPATTERN.NODETYPE = 0

connect by  
 AA_TREEPATTERN.Nodeid =   Prior AA_TREEPATTERN.Parentnodeid 
start with  AA_TREEPATTERN.Nodeid 
in (select NODEID from Table(cast (f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table)
))  


union all

  Select 
 cast(DATAID as char(38)) as DATAID
 ,cast(NODEID as char(10)) as NODEID
  ,cast(NODETEXT as VARCHAR2(100)) as NODETEXT
 ,cast(PARENTNODEID as char(10)) as PARENTNODEID
  ,NODETYPE
  ,cast(FUNCTIONID as char(20)) as FUNCTIONID 
  ,ORDERS
  ,cast( STATUS as char(6)) as  STATUS
   from Table(cast (f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table))


*/

  Select 
   to_number(level) Levels
  ,DATAID
  ,NODEID
  ,NODETYPE
  ,NODETEXT
  ,PARENTNODEID
  ,FUNCTIONID
  ,ORDERS
  ,STATUS from  
Aa_Treepattern
start with   Parentnodeid = ' ' 
connect by  Prior  Nodeid =   Parentnodeid

;



END S_GETMAINMENU;

/*
VARIABLE resultSet  REFCURSOR
EXEC S_GETMAINMENU('HowARDa','', :resultSet);
PRINT :resultSet

*/

/

  GRANT EXECUTE ON "ECS"."S_GETMAINMENU" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMAINMENU_TEMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMAINMENU_TEMP" 
(
  striUSERID IN VARCHAR2
, striPRODUCTID IN VARCHAR2
, p_ResultSet        OUT  TYPES.cursorType
) AS
BEGIN
-- OPEN p_ResultSet FOR
  --Select DATAID,NODEID,NODETEXT,PARENTNODEID,NODETYPE,FUNCTIONID,ORDERS,STATUS from

  Insert INTO Mainmenu_TEMP(DATAID,NODEID,NODETEXT,PARENTNODEID,NODETYPE,FUNCTIONID,ORDERS,STATUS)
  select  * from
  (
        Select
       cast(DATAID as char(38)) as DATAID
       ,cast(NODEID as char(10)) as NODEID
        ,cast(NODETEXT as VARCHAR2(100)) as NODETEXT
       ,cast(PARENTNODEID as char(10)) as PARENTNODEID
        ,NODETYPE
        ,cast(FUNCTIONID as char(20)) as FUNCTIONID
        ,ORDERS
        ,cast( STATUS as char(6)) as  STATUS
         from Table(cast (f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table))
/*

      union all

      Select distinct
      cast(AA_TREEPATTERN.DATAID as char(38)) as DATAID
      ,cast(AA_TREEPATTERN.NODEID as char(10)) as NODEID
      ,cast(AA_TREEPATTERN.NODETEXT as VARCHAR2(100)) as NODETEXT
      ,cast(AA_TREEPATTERN.PARENTNODEID as char(10)) as PARENTNODEID
      ,AA_TREEPATTERN.NODETYPE
      ,cast(AA_TREEPATTERN.FUNCTIONID as char(20)) as FUNCTIONID
      ,AA_TREEPATTERN.ORDERS
      ,cast( AA_TREEPATTERN.STATUS as char(6)) as  STATUS
      from AA_TREEPATTERN
      , Table(cast(f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table)) FunctionCollections
      where
      AA_TREEPATTERN.FunctionID =  FunctionCollections.functionid(+)
      and
      AA_TREEPATTERN.NODETYPE = 0

      connect by
       AA_TREEPATTERN.Nodeid =   Prior AA_TREEPATTERN.Parentnodeid
      start with  AA_TREEPATTERN.Nodeid
      in (select NODEID from Table(cast (f_GetMainMenu(striUSERID,striPRODUCTID) as type_mainmenu_table)
      ))
  */ 
  ) ;

       commit;    

--and AA_TREEPATTERN.Nodeid in (select distinct Parentnodeid from Table(f_GetMainMenu(striUSERID,striPRODUCTID)) );

END S_GETMAINMENU_TEMP;

/*
VARIABLE resultSet  REFCURSOR
EXEC S_GETMAINMENU('HowARDa','', :resultSet);
PRINT :resultSet

*/

/

  GRANT EXECUTE ON "ECS"."S_GETMAINMENU_TEMP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMEMBERDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMEMBERDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/03/20
-- Description: 取得會員資料
-- 2018.03.27 ChengYu 調整傳入參數名稱
-- 2018.07.13 JIANXIN 調整傳入傳出參數
-- 2018.09.25 tingting 因SOCIAL_TYPE增加選項4：Email註冊，進行調整(1.增加傳出欄位：姓、名 2.相關調整)
-- 2018.10.22 tingting 1.增加傳入欄位：IP位址
--                     2.增加傳出欄位：性別、性別名稱、生日、手機
--                     3.增加寫入ECS.POTENTIAL_LOGIN、ECS.POTENTIAL_LOGIN_LOG Tabel功能，進行調整(1.SP增加傳入欄位：密碼相同否(Y/N) 2.相關調整)
-- 2018.10.31 tingting 增加傳出欄位：建立日期
-- 2018.11.20 tingting 登入部份的功能拆分至API016-Member_Login
-- =============================================
(
     -- 2018.03.27 ChengYu 調整傳入參數名稱
	 -- 2018.07.13 JIANXIN 調整傳入傳出參數
     WSOCIAL_TYPE       VARCHAR2            --社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
    ,WSOCIAL_ID         VARCHAR2            --社群登入帳號
    ,OUTDT              OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS
BEGIN

    -- 2018.07.13 JIANXIN 調整傳入傳出參數
    -- 2018.09.25 tingting 因SOCIAL_TYPE增加選項4：Email註冊，進行調整(1.增加傳出欄位：姓、名 2.相關調整)
    OPEN OUTDT FOR
    SELECT  POTENTIAL.POTENTIAL_ID      --潛在客戶代碼
           ,POTENTIAL.SOCIAL_TYPE       --社群登入種類
           ,POTENTIAL.SOCIAL_EMAIL      --用戶的電子郵件
           ,POTENTIAL.FIRST_NAME        --姓
           ,POTENTIAL.LAST_NAME         --名
           -- 2018.10.22 tingting 1.增加傳入欄位：IP位址
           --                     2.增加傳出欄位：性別、性別名稱、生日、手機
           --                     3.增加寫入ECS.POTENTIAL_LOGIN、ECS.POTENTIAL_LOGIN_LOG Tabel功能，進行調整(1.SP增加傳入欄位：密碼相同否(Y/N) 2.相關調整)
           ,POTENTIAL.GENDER            --性別
           ,ECS_OPTION.DISPLAY_NAME AS GENDER_NAME      --性別名稱
           ,POTENTIAL.BIRTH_DATE        --生日
           ,POTENTIAL.MOBILE            --手機
           -- 2018.10.31 tingting 增加傳出欄位：建立日期
           ,POTENTIAL.CREATE_DATE       --建立日期
      FROM ECS.POTENTIAL POTENTIAL      --潛在客戶檔
      LEFT JOIN ECS.ECS_OPTION          --欄位選單資料
        ON ECS_OPTION.SOURCE_TYPE = '017'
       AND ECS_OPTION.TEXT_VALUE = POTENTIAL.GENDER
     WHERE POTENTIAL.SOCIAL_TYPE = WSOCIAL_TYPE
       AND POTENTIAL.SOCIAL_ID = WSOCIAL_ID;

END s_GetMemberData;

/

  GRANT EXECUTE ON "ECS"."S_GETMEMBERDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETMYINVENTORYINFO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETMYINVENTORYINFO" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/09
-- Description: 取得投資總覽資料
-- 2018.03.21 JIANXIN 新增庫存日期替代系統日
-- 2018.03.31 ChengYu 幣別名稱改從 V_FUND_CRNCY 取得
-- 2018.04.03 JIM 修改邏輯
-- 2018.04.12 Jim 因s_GetTradeDate調整，所以要跟著調整輸入參數
-- 2018.05.11 Jim 修改原幣為台幣時，匯率要為1、取得配息金額
-- 2018.05.14 Jim 補上總投資成本的小數單位數
-- 2018.05.24 Jim 補上table的Owner
-- 2018.07.02 tingting INSERT INTO 指定欄位
-- 2018.07.16 JIANXIN MOD 調整可買回單位數增加參數
-- 2018.07.18 tingting 修正Group by少欄位的錯誤
-- 2018.08.01 yunchu 調整幣別改取V_TX_CURRENCY
-- 2018.08.28 JIANXIN MOD 依 2.原幣的內容無須取得交易幣
-- 2018.09.24 JIANXIN MOD E-Trade 庫存畫面，只顯示 E-Trade 的庫存內容
-- 2018.09.25 JIANXIN MOD 新增參數WIS_ROBO，是否顯示Robo 或 E-Trade
-- 2018.10.18 JIANXIN MOD 當Robo 取消時，庫存單位數必須回歸至EC
-- 2018.10.24 JIANXIN MOD 效能調整
-- 2018.10.29 PAN MOD 效能調整
-- 2018.10.31 JIANXIN MOD 調整除以零的錯誤
-- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
-- 2018.11.05 pan MOD 增加 參考損益 / 投資報酬率(含息)/ 投資報酬率(不含息)的　(參考台幣)欄位；年化報酬率　無特別處理
-- 2018.11.08 ChengYu 查詢幣別 = '1' 市值、參考損益、投資報酬率(含息)、投資報酬率(不含息)以台幣參考損益回傳
-- 2018.11.20 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式
-- 2018.11.21 JIANXIN MOD 1. 調整NAV 日期，以庫存日期為準取得
--                        2. 依據ES 提供之程式調整市值、成本計算方式
-- 2019.01.10 JIANXIN MOD 調整報酬率除以零的錯誤
-- 2019.01.24 JIANXIN MOD 年化報酬率公式調整為 SUM(損益 / 成本 / 持有天數 * 365 * 100) / 憑證筆數 
-- 2019.02.22 JIANXIN MOD 年化報酬的憑證筆數，若結帳日與申購日是同一天時，要排除筆數
-- 2019.03.15 JIANXIN MOD 年化報酬的憑證持有天數要以淨值日為基準處理、同步新台幣之語法
-- 2019.03.19 JIANXIN MOD 調整報酬率除以零的錯誤
-- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
-- 2022.03.02 JIANXIN MOD 1. 平均單位成本改為淨值小數位數
--                        2. 因應平均單位成本需要原幣成本而調整
-- 2022.03.04 JIANXIN MOD 成本調整為計價幣別小數位數
-- =============================================
(
    WACCOUNT_NO    INTEGER,                    -- 受益人戶號
    WQUERY_TYPE    VARCHAR2,                   -- 查詢幣別
    WBAL_DATE      DATE,                       -- 庫存日期
    WIS_TOTAL_DATA VARCHAR2,                   -- 個人總庫存列表
    WIS_ROBO       VARCHAR2,                   -- 是否為Robo；Y：Robo；N：E-Trade；
    OUTDT          OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA
    OUTDT2         OUT SYS_REFCURSOR,          -- 回傳的 TABLEDATA(總投資成本列表)
    OUTDT3         OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA(配息金額)
) IS

    XID            VARCHAR2(10);               --受益人ID
    XBAL_DATE      DATE := TRUNC(WBAL_DATE);   --格式為YYYY/MM/DD

BEGIN

    DELETE FROM ECS.NAV_DATE_TEMP;              --清除TABLE所有資料(最新淨值日)
    DELETE FROM ECS.MYINVENTORY_TEMP;           --清除TABLE所有資料

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' begin 將最新淨值存入暫存檔');

    --將最新淨值存入暫存檔
    INSERT INTO ECS.NAV_DATE_TEMP
    (
         FUND_NO
        ,NAV_DATE
        ,TX_DATE
        ,NAV
        ,CHANGE
        ,BAL_SHARE
        ,NET_ASSET
    )
    SELECT NAV.FUND_NO
           ,NAV.NAV_DATE
           ,NAV.TX_DATE
           ,NAV.NAV
           ,NAV.CHANGE
           ,NAV.BAL_SHARE
           ,NAV.NET_ASSET
      FROM NAV.NAV
      -- 2018.11.20 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式
      JOIN (SELECT NAV.FUND_NO, MAX(NAV_DATE) AS NAV_DATE
              FROM NAV.NAV
              JOIN FAS.FUND
                ON FUND.FUND_NO = NAV.FUND_NO
               AND NAV.NAV_DATE < FUND.AC_DATE
             -- 2018.11.21 JIANXIN MOD 調整NAV 日期，以庫存日期為準取得
             WHERE NAV_DATE <= WBAL_DATE
             GROUP BY NAV.FUND_NO) A
        ON A.FUND_NO = NAV.NAV.FUND_NO
       AND A.NAV_DATE = NAV.NAV.NAV_DATE;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   將最新淨值存入暫存檔');

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' begin 取得受益人ID');

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

  END;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   取得受益人ID');

  --若傳入參數『查詢幣別(@QUERY_TYPE)』為”1.申購幣別”
  IF WQUERY_TYPE = '1' THEN

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' begin 憑證檔');

    --先將基本資料放入暫存檔
    INSERT INTO ECS.MYINVENTORY_TEMP
    (
         HOLDFUND
        ,SHARES
        ,TX_DATE
        ,FUND_CRNCY
        ,FUND_CRNCY_NM
        ,FUND_AMT_DECIMAL
        ,TRADE_CRNCY
        ,TRADE_CRNCY_NM
        ,TRADE_AMT_DECIMAL
        ,TOT_COST
        ,TOT_COST_NTD
        ,RETURN_ROI
      ,FUND_CATEGORY
    )
      SELECT CERTIFICATE.FUND_NO AS HOLDFUND          --持有基金
             ,SUM(CERTIFICATE.SHARES) AS SHARES       --持有單位數
             ,NULL AS TX_DATE                         --交易日
             ,FUND.CURRENCY_NO AS FUND_CRNCY          --計價幣別
             ,FUND_CRNCY.NAME AS FUND_CRNCY_NM        --計價幣別名稱
             ,FUND_CRNCY.AMT_DECIMAL AS FUND_AMT_DECIMAL    --計價幣別小數位數
             ,CERTIFICATE.CURRENCY_NO AS TRADE_CRNCY  --申購幣別
             ,TRADE_CRNCY.NAME AS TRADE_CRNCY_NM      --申購幣別名稱
             ,TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL  --申購幣別小數位數
             -- 2018.05.14 Mod By Jim 補上小數單位數(使用申購幣別小數單位數)
             -- 2018.11.20 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式
             -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
             -- 2022.03.04 JIANXIN MOD 成本調整為計價幣別小數位數
             ,ROUND(SUM(CERTIFICATE.TOT_COST),FUND_CRNCY.AMT_DECIMAL) AS TOT_COST   --總投資成本
             ,ROUND(SUM(CERTIFICATE.TOT_NTD_COST), TRADE_CRNCY.AMT_DECIMAL) AS TOT_COST_NTD  --總投資成本(參考台幣)
             ,CASE                                    --年化報酬率
               WHEN FUND.ANNUALIZED_ROI = 'N' THEN
                0
               -- 2019.01.10 JIANXIN MOD 調整報酬率除以零的錯誤
               -- 2019.03.15 JIANXIN MOD 年化報酬的憑證持有天數要以淨值日為基準處理
               -- 2019.03.19 JIANXIN MOD 調整報酬率除以零的錯誤
               WHEN FUND.ANNUALIZED_ROI = 'Y' THEN ROUND(CASE WHEN SUM(CASE WHEN CERTIFICATE.PUR_DATE = NAV.NAV_DATE THEN 0 ELSE 1 END ) = 0 THEN 0 ELSE 
                                                         SUM( CASE WHEN  (NAV.NAV_DATE = CERTIFICATE.PUR_DATE)
                                                                        OR  ( NAV.NAV_DATE  > CERTIFICATE.PUR_DATE  AND DECODE(FUND.CURRENCY_NO, CERTIFICATE.CURRENCY_NO, CERTIFICATE.COST, CERTIFICATE.NTD_COST ) = 0 )
                                                                   THEN 0
                                                                   WHEN NAV.NAV_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.COST = 0 THEN 1
                                                                   WHEN NAV.NAV_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.COST > 0 THEN
                                                                        ROUND(((ROUND((CERTIFICATE.SHARES * NAV.NAV),
                                                                                      TRADE_CRNCY.AMT_DECIMAL) -
                                                                              DECODE(FUND.CURRENCY_NO,
                                                                                       CERTIFICATE.CURRENCY_NO,
                                                                                       CERTIFICATE.COST,
                                                                                       CERTIFICATE.NTD_COST)) /
                                                                              DECODE(FUND.CURRENCY_NO,
                                                                                      CERTIFICATE.CURRENCY_NO,
                                                                                      CERTIFICATE.COST,
                                                                                      CERTIFICATE.NTD_COST) /
                                                                              (NAV.NAV_DATE - CERTIFICATE.PUR_DATE) * 365 * 100),
                                                          2)
                          -- 2019.01.24 JIANXIN MOD 年化報酬率公式調整為 SUM(損益 / 成本 / 持有天數 * 365 * 100) / 憑證筆數 
                          -- 2019.02.22 JIANXIN MOD 年化報酬的憑證筆數，若結帳日與申購日是同一天時，要排除筆數
                          END)  / SUM(CASE WHEN CERTIFICATE.PUR_DATE = NAV.NAV_DATE THEN 0 ELSE 1 END )  END,
                      2)
              END RETURN_ROI
             ,FUND.FUND_CATEGORY                     --基金類別(境內/境外基金) 1:境內 2:境外
        -- 2018.11.20 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式
        -- 2018.11.21 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式
        FROM ( SELECT  CERTIFICATE.COST AS TOT_COST
                      ,DECODE(CERTIFICATE.NTD_COST,NULL,CERTIFICATE.COST * NTD_EXRATE.EX_RATE,CERTIFICATE.NTD_COST) AS TOT_NTD_COST 
                      ,CERTIFICATE.*
                 FROM FAS.CERTIFICATE 
                 JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
                   ON NTD_EXRATE.FUND_NO = CERTIFICATE.FUND_NO
                  AND NTD_EXRATE.TX_DATE = CERTIFICATE.PUR_DATE 
                WHERE ID = XID )  CERTIFICATE
        JOIN FAS.FUND FUND
          ON FUND.FUND_NO = CERTIFICATE.FUND_NO
         AND FUND.INCEPTION_DATE IS NOT NULL         --「成立日期(INCEPTION_DATE)」不為空白
         AND FUND.INCEPTION_DATE <= XBAL_DATE        --「成立日期(INCEPTION_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND (FUND.CLEAR_DATE IS NULL                --「停止日期(CLEAR_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
             OR FUND.CLEAR_DATE > XBAL_DATE)
        JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
          ON NTD_EXRATE.FUND_NO = CERTIFICATE.FUND_NO
         AND NTD_EXRATE.TX_DATE = CERTIFICATE.PUR_DATE
        JOIN ECS.V_FUND_CRNCY NTD_AMT
          ON NTD_AMT.CURRENCY_NO = 'NTD'
        LEFT JOIN ECS.NAV_DATE_TEMP NAV
          ON NAV.FUND_NO = FUND.FUND_NO
        JOIN ECS.V_FUND_CRNCY TRADE_CRNCY
          ON TRADE_CRNCY.CURRENCY_NO = CERTIFICATE.CURRENCY_NO
        JOIN ECS.V_FUND_CRNCY FUND_CRNCY
          ON FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
       WHERE CERTIFICATE.ID = XID
         AND CERTIFICATE.ISSUE_DATE <= XBAL_DATE       --「配號日期(ISSUE_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND (CERTIFICATE.CANCEL_DATE IS NULL         --「註銷日期(CANCEL_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
             OR CERTIFICATE.CANCEL_DATE > XBAL_DATE)
         -- 2018.09.24 JIANXIN MOD E-Trade 庫存畫面，只顯示 E-Trade 的庫存內容
         -- 2018.09.25 JIANXIN MOD 新增參數WIS_ROBO，是否顯示Robo 或 E-Trade
         -- 2018.10.18 JIANXIN MOD 當Robo 取消時，庫存單位數必須回歸至EC
         AND (  (WIS_ROBO IS NULL)
             OR (WIS_ROBO = 'Y' AND ROBO_CONTRACT_NO IS NOT NULL AND CERTIFICATE.STATUS = '8')
             OR (WIS_ROBO = 'N' AND (ROBO_CONTRACT_NO IS NULL OR CERTIFICATE.STATUS = '1'))
             )
       GROUP BY CERTIFICATE.FUND_NO,
                CERTIFICATE.CURRENCY_NO,
                FUND.CURRENCY_NO,
                FUND_CRNCY.NAME,
                FUND_CRNCY.AMT_DECIMAL,
                TRADE_CRNCY.NAME,
                TRADE_CRNCY.AMT_DECIMAL,
                NTD_AMT.AMT_DECIMAL,
                FUND.ANNUALIZED_ROI,
                FUND.FUND_CATEGORY;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   憑證檔');

    --總投資成本列表
    IF WIS_TOTAL_DATA = 'Y' THEN

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' begin 總投資成本列表');

      OPEN OUTDT2 FOR
        SELECT  TEMP.TRADE_CRNCY  AS CURRENCY_NO        --幣別
               ,TEMP.TRADE_CRNCY_NM AS CURRENCY_NAME    --幣別名稱
               ,ROUND(SUM(CASE WHEN TEMP.FUND_CATEGORY = '1' THEN TEMP.TOT_COST
                    ELSE 0
                    END),TEMP.TRADE_AMT_DECIMAL)
                    AS ONSHORE_AMT                      --境內基金總成本
               ,ROUND(SUM(CASE WHEN TEMP.FUND_CATEGORY = '2' THEN TEMP.TOT_COST
                    ELSE 0
                    END),TEMP.TRADE_AMT_DECIMAL)
                    AS OFFSHORE_AMT                     --境外基金總成本
               ,ROUND(SUM(TEMP.TOT_COST),TEMP.TRADE_AMT_DECIMAL)
                    AS TOT_AMT                          --TOT_AMT
               ,TEMP.TRADE_AMT_DECIMAL AMT_DECIMAL      --幣別小數位數
          FROM -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
               (SELECT MYINVENTORY_TEMP.* 
                       ,CASE WHEN MYINVENTORY_TEMP.FUND_CRNCY = MYINVENTORY_TEMP.TRADE_CRNCY THEN MYINVENTORY_TEMP.TOT_COST ELSE MYINVENTORY_TEMP.TOT_COST_NTD END TOT_COST_TRADE
                  FROM ECS.MYINVENTORY_TEMP) TEMP
          --JOIN FAS.FUND FUND
          --  ON FUND.FUND_NO = TEMP.HOLDFUND
          --JOIN ECS.V_FUND_CRNCY TRADE_CRNCY
          --  ON TRADE_CRNCY.CURRENCY_NO = TEMP.TRADE_CRNCY
         GROUP BY TEMP.TRADE_CRNCY,
                  TEMP.TRADE_CRNCY_NM,
                  TEMP.TRADE_AMT_DECIMAL,
                  TEMP.FUND_CATEGORY
          UNION
        SELECT 'ETD'
               ,'參考台幣'
               ,SUM(CASE WHEN TEMP.FUND_CATEGORY = '1' THEN TEMP.TOT_COST_NTD
                    ELSE 0
                    END)
               ,SUM(CASE WHEN TEMP.FUND_CATEGORY = '2' THEN TEMP.TOT_COST_NTD
                    ELSE 0
                    END)
               ,SUM(TEMP.TOT_COST_NTD)
               ,0
          FROM ECS.MYINVENTORY_TEMP TEMP;
          --JOIN FAS.FUND FUND
          --  ON FUND.FUND_NO = TEMP.HOLDFUND;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   總投資成本列表');

    END IF;

  END IF;

  --若傳入參數『查詢幣別(@QUERY_TYPE)』為”2.原幣”
  IF WQUERY_TYPE = '2' THEN

    INSERT INTO ECS.MYINVENTORY_TEMP
    (
         HOLDFUND
        ,SHARES
        ,TX_DATE
        ,FUND_CRNCY
      ,FUND_CRNCY_NM
      ,FUND_AMT_DECIMAL
        ,TRADE_CRNCY
      ,TRADE_CRNCY_NM
      ,TRADE_AMT_DECIMAL
        ,TOT_COST
        ,TOT_COST_NTD
        ,RETURN_ROI
      ,FUND_CATEGORY
    )
      SELECT CERTIFICATE.FUND_NO AS HOLDFUND                    --持有基金
             ,SUM(CERTIFICATE.SHARES) AS SHARES                 --持有單位數
             ,NULL AS TX_DATE                                   --交易日
             ,FUND.CURRENCY_NO AS FUND_CRNCY                    --計價幣別
           ,FUND_CRNCY.NAME AS FUND_CRNCY_NM                  --計價幣別名稱
           ,FUND_CRNCY.AMT_DECIMAL AS FUND_AMT_DECIMAL        --計價幣別小數位數
             -- 2018.08.28 JIANXIN MOD 依 2.原幣的內容無須取得交易幣
             ,FUND.CURRENCY_NO AS TRADE_CRNCY                   --申購幣別
           ,TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                --申購幣別名稱
           ,TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL      --申購幣別小數位數
             -- 2018.05.14 Mod By Jim 補上小數單位數
             -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
             ,ROUND(SUM(CERTIFICATE.COST),FUND_CRNCY.AMT_DECIMAL) AS TOT_COST                 --總投資成本
             ,ROUND(SUM(CERTIFICATE.COST * CASE WHEN FUND.CURRENCY_NO = 'NTD' THEN 1 ELSE NTD_EXRATE.EX_RATE END )
                   ,NTD_AMT.AMT_DECIMAL) AS TOT_COST_NTD        --總投資成本(參考台幣)
             -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步    
             -- 2019.03.15 JIANXIN MOD 同步新台幣之語法
             ,CASE                                    --年化報酬率
               WHEN FUND.ANNUALIZED_ROI = 'N' THEN
                0
               -- 2019.01.10 JIANXIN MOD 調整報酬率除以零的錯誤
               -- 2019.03.19 JIANXIN MOD 調整報酬率除以零的錯誤
               WHEN FUND.ANNUALIZED_ROI = 'Y' THEN ROUND(CASE WHEN SUM(CASE WHEN CERTIFICATE.PUR_DATE = NAV.NAV_DATE THEN 0 ELSE 1 END ) = 0 THEN 0 ELSE 
                                                         SUM( CASE WHEN  (NAV.NAV_DATE = CERTIFICATE.PUR_DATE)
                                                                        OR  ( NAV.NAV_DATE  > CERTIFICATE.PUR_DATE  AND DECODE(FUND.CURRENCY_NO, CERTIFICATE.CURRENCY_NO, CERTIFICATE.COST, CERTIFICATE.NTD_COST ) = 0 )
                                                                   THEN 0
                                                                   WHEN NAV.NAV_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.COST = 0 THEN 1
                                                                   WHEN NAV.NAV_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.COST > 0 THEN
                                                                        ROUND(((ROUND((CERTIFICATE.SHARES * NAV.NAV),
                                                                                      TRADE_CRNCY.AMT_DECIMAL) -
                                                                              DECODE(FUND.CURRENCY_NO,
                                                                                       CERTIFICATE.CURRENCY_NO,
                                                                                       CERTIFICATE.COST,
                                                                                       CERTIFICATE.NTD_COST)) /
                                                                              DECODE(FUND.CURRENCY_NO,
                                                                                      CERTIFICATE.CURRENCY_NO,
                                                                                      CERTIFICATE.COST,
                                                                                      CERTIFICATE.NTD_COST) /
                                                                              (NAV.NAV_DATE - CERTIFICATE.PUR_DATE) * 365 * 100),
                                                          2)
                          -- 2019.01.24 JIANXIN MOD 年化報酬率公式調整為 SUM(損益 / 成本 / 持有天數 * 365 * 100) / 憑證筆數 
                          -- 2019.02.22 JIANXIN MOD 年化報酬的憑證筆數，若結帳日與申購日是同一天時，要排除筆數
                          END)  / SUM(CASE WHEN CERTIFICATE.PUR_DATE = NAV.NAV_DATE THEN 0 ELSE 1 END ) END ,
                      2)
              END RETURN_ROI
           ,FUND.FUND_CATEGORY                     --基金類別(境內/境外基金) 1:境內 2:境外
        FROM FAS.CERTIFICATE CERTIFICATE
        JOIN FAS.FUND FUND
          ON FUND.FUND_NO = CERTIFICATE.FUND_NO
         AND FUND.INCEPTION_DATE IS NOT NULL                          --「成立日期(INCEPTION_DATE)」不為空白
         AND FUND.INCEPTION_DATE <= XBAL_DATE                         --「成立日期(INCEPTION_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND ( FUND.CLEAR_DATE IS NULL                                --「停止日期(CLEAR_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
            OR FUND.CLEAR_DATE > XBAL_DATE)
        JOIN ECS.V_TX_CURRENCY TX_CURRENCY                              -- 基金交易別申購幣別檔
          ON TX_CURRENCY.FUND_NO = FUND.FUND_NO
         AND TX_CURRENCY.TRADE_CD = '1'
        JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
          ON NTD_EXRATE.FUND_NO = CERTIFICATE.FUND_NO
         AND NTD_EXRATE.TX_DATE = CERTIFICATE.PUR_DATE
        JOIN ECS.V_FUND_CRNCY NTD_AMT
          ON NTD_AMT.CURRENCY_NO = 'NTD'
        LEFT JOIN ECS.NAV_DATE_TEMP NAV
          ON NAV.FUND_NO = FUND.FUND_NO
        JOIN ECS.V_FUND_CRNCY TRADE_CRNCY
          ON TRADE_CRNCY.CURRENCY_NO = CERTIFICATE.CURRENCY_NO
        JOIN ECS.V_FUND_CRNCY FUND_CRNCY
          ON FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
       WHERE CERTIFICATE.ID = XID
         AND CERTIFICATE.ISSUE_DATE <= XBAL_DATE                      --「配號日期(ISSUE_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND (CERTIFICATE.CANCEL_DATE IS NULL                         --「註銷日期(CANCEL_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
             OR CERTIFICATE.CANCEL_DATE > XBAL_DATE)
         -- 2018.09.24 JIANXIN MOD E-Trade 庫存畫面，只顯示 E-Trade 的庫存內容
         -- 2018.09.25 JIANXIN MOD 新增參數WIS_ROBO，是否顯示Robo 或 E-Trade
         -- 2018.10.18 JIANXIN MOD 當Robo 取消時，庫存單位數必須回歸至EC
         AND (  (WIS_ROBO IS NULL)
             OR (WIS_ROBO = 'Y' AND ROBO_CONTRACT_NO IS NOT NULL AND CERTIFICATE.STATUS = '8')
             OR (WIS_ROBO = 'N' AND (ROBO_CONTRACT_NO IS NULL OR CERTIFICATE.STATUS = '1'))
             )
       GROUP BY CERTIFICATE.FUND_NO,
                CERTIFICATE.CURRENCY_NO,
                FUND.CURRENCY_NO,
                FUND_CRNCY.NAME,
                FUND_CRNCY.AMT_DECIMAL,
                TRADE_CRNCY.NAME,
                TRADE_CRNCY.AMT_DECIMAL,
                NTD_AMT.AMT_DECIMAL,
                FUND.ANNUALIZED_ROI,
                FUND.FUND_CATEGORY;

    --總投資成本列表
    IF WIS_TOTAL_DATA = 'Y' THEN

      OPEN OUTDT2 FOR
        SELECT  TEMP.FUND_CRNCY  AS CURRENCY_NO          --幣別
               ,TEMP.TRADE_CRNCY_NM AS CURRENCY_NAME     --幣別名稱
               ,ROUND(SUM(CASE WHEN TEMP.FUND_CATEGORY = '1' THEN TEMP.TOT_COST
                    ELSE 0
                    END),TEMP.TRADE_AMT_DECIMAL)
                     AS ONSHORE_AMT                      --境內基金總成本
               ,ROUND(SUM(CASE WHEN TEMP.FUND_CATEGORY = '2' THEN TEMP.TOT_COST
                    ELSE 0
                    END),TEMP.TRADE_AMT_DECIMAL)
                     AS OFFSHORE_AMT                     --境外基金總成本
               ,ROUND(SUM(TEMP.TOT_COST),TEMP.TRADE_AMT_DECIMAL)
                AS TOT_AMT                               --TOT_AMT
               ,TEMP.TRADE_AMT_DECIMAL AMT_DECIMAL       --幣別小數位數
          FROM ECS.MYINVENTORY_TEMP TEMP
          --JOIN FAS.FUND FUND
          --  ON FUND.FUND_NO = TEMP.HOLDFUND
          --JOIN ECS.V_FUND_CRNCY FUND_CRNCY
          --  ON FUND_CRNCY.CURRENCY_NO = TEMP.FUND_CRNCY
         GROUP BY TEMP.FUND_CRNCY,
                  TEMP.FUND_CATEGORY,
                  TEMP.TRADE_CRNCY_NM,
                  TEMP.TRADE_AMT_DECIMAL
          UNION
        SELECT 'ETD'
               ,'參考台幣'
               ,SUM(CASE WHEN TEMP.FUND_CATEGORY = '1' THEN TEMP.TOT_COST_NTD
                    ELSE 0
                    END)
               ,SUM(CASE WHEN TEMP.FUND_CATEGORY = '2' THEN TEMP.TOT_COST_NTD
                    ELSE 0
                    END)
               ,SUM(TEMP.TOT_COST_NTD)
               ,0
          FROM ECS.MYINVENTORY_TEMP TEMP;
          --JOIN FAS.FUND FUND
          --  ON FUND.FUND_NO = TEMP.HOLDFUND;

    END IF;

  END IF;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' Begin 執行【API041：GetTradeDate】');

  --執行【API041：GetTradeDate】取得各基金的交易日期
  BEGIN

    DECLARE

    TRADEDT SYS_REFCURSOR;
    XFUND_ID VARCHAR2(10);
    XTX_DATE DATE;
    XIS_SUCCESS VARCHAR2(1);
    XWARNS_TYPE VARCHAR2(10);
    XERROR_MSG VARCHAR2(255);

    BEGIN

      FOR ITEM IN (SELECT HOLDFUND,TRADE_CRNCY FROM ECS.MYINVENTORY_TEMP)
        LOOP
          -- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
          ECS.S_GETTRADEDATE('2',ITEM.HOLDFUND,SYSDATE,ITEM.TRADE_CRNCY,TRADEDT);

          LOOP
            FETCH TRADEDT INTO XFUND_ID,XTX_DATE,XIS_SUCCESS,XWARNS_TYPE,XERROR_MSG;
            EXIT WHEN TRADEDT%NOTFOUND;

            --抓取成功則更新交易日
            IF XIS_SUCCESS = 'N' THEN

              RAISE_APPLICATION_ERROR(-20000,
                                      XERROR_MSG);

            ELSE

              UPDATE ECS.MYINVENTORY_TEMP MYINVENTORY_TEMP
                 SET TX_DATE = XTX_DATE
               WHERE MYINVENTORY_TEMP.HOLDFUND = XFUND_ID;

            END IF;

          END LOOP;

        END LOOP;

    END;

  END;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   執行【API041：GetTradeDate】');

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' Begin OPEN OUTDT FOR');

  OPEN OUTDT FOR
    SELECT XID AS ID                                                  --受益人ID
           ,FUND.ANNUALIZED_ROI AS IS_ROI                             --是否年化報酬率
           ,TEMP.RETURN_ROI                                           --年化報酬率
           ,FUND.FUND_CATEGORY                                        --境內外識別碼
           ,DECODE(FUND.FUND_CATEGORY,'1','境內'
              ,'2','境外','') AS FUND_CATEGORY_NAME                   --境內外識別碼名稱
           ,FUND.AMC_NO                                               --基金公司代碼
           ,AMC.NAME AS AMC_NAME                                      --基金公司名稱
           ,FUND.FUND_NO                                              --基金代碼
           ,FUND.NAME AS FUND_NAME                                    --基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                           --基金警語
           ,FUND.ISIN_CODE                                            --國際證券代碼
           ,TEMP.FUND_CRNCY AS CURRENCY_NO                            --計價幣別
           ,TEMP.FUND_CRNCY_NM AS CURRENCY_NAME                       --計價幣別名稱
           -- 2018.10.31 JIANXIN MOD 調整除以零的錯誤
           -- 2022.03.02 JIANXIN MOD 平均單位成本調整為淨值小數位數
           ,CASE WHEN TEMP.SHARES = 0 THEN 0 
                 WHEN WQUERY_TYPE = '1' THEN ROUND(TEMP.TOT_COST / TEMP.SHARES,FUND.NAV_DECIMAL)
                 WHEN WQUERY_TYPE = '2' THEN ROUND(TEMP.TOT_COST / TEMP.SHARES,FUND.NAV_DECIMAL)
            END AVG_COST                                              --平均單位成本
           ,ROUND(TEMP.SHARES,FUND.SHARE_DECIMAL) AS HOLD_SHARES      --持有單位數
           -- 2018.07.16 JIANXIN MOD 調整可買回單位數增加參數
           ,CASE WHEN WQUERY_TYPE = '1' THEN ROUND(ECS.FN_API_GET_RUNIT(XID,TEMP.TX_DATE,TEMP.HOLDFUND,TEMP.TRADE_CRNCY,'1','1'),FUND.SHARE_DECIMAL)
                 WHEN WQUERY_TYPE = '2' THEN ROUND(ECS.FN_API_GET_RUNIT(XID,TEMP.TX_DATE,TEMP.HOLDFUND,TEMP.FUND_CRNCY,'2','1'),FUND.SHARE_DECIMAL)
            END R_SHARES                                              --可買回單位數
           ,TEMP.TRADE_CRNCY                                          --申購幣別
           ,TEMP.TRADE_CRNCY_NM AS TRADE_CRNCY_NM                     --申購幣別中文名稱
           -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
           ,TEMP.TOT_COST_TRADE AS TOT_COST                           --總投資成本
           ,TEMP.TOT_COST_NTD                                         --總投資成本(參考台幣)
           ,FUND.SHARE_DECIMAL                                        --單位數小數位數
           ,FUND.NAV_DECIMAL                                          --淨值小數位數
           ,TEMP.FUND_AMT_DECIMAL AS AMT_DECIMAL                      --計價幣別小數位數
           ,TEMP.TRADE_AMT_DECIMAL AS TRADE_AMT_DECIMAL               --申購幣別小數位數
          -- 2018.10.24 JIANXIN MOD 效能調整
           ,NAV_DATE_TEMP.NAV                                         --淨值
         ,NAV_DATE_TEMP.NAV_DATE                                    --淨值日期
         ,V_CURRENCY_RATE.EX_RATE                                   --匯率
         -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
           -- 2018.11.08 ChengYu 查詢幣別 = '1' 市值、參考損益、投資報酬率(含息)、投資報酬率(不含息)以台幣參考損益回傳
           -- =========2018.11.21 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式  BNG =========
            ,CASE WHEN WQUERY_TYPE = '1' THEN ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* CASE WHEN TEMP.TRADE_CRNCY = TEMP.FUND_CRNCY THEN 1 ELSE V_CURRENCY_RATE.EX_RATE END,TEMP.TRADE_AMT_DECIMAL)
                 ELSE ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL)
             END AS MARKET_PRICE 
            ,ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* V_CURRENCY_RATE.EX_RATE ,0) AS MARKET_PRICE_NTD 
           -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
           -- 2018.11.08 ChengYu 查詢幣別 = '1' 市值、參考損益、投資報酬率(含息)、投資報酬率(不含息)以台幣參考損益回傳
           -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
           ,CASE WHEN WQUERY_TYPE = '1' THEN ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* CASE WHEN TEMP.TRADE_CRNCY = TEMP.FUND_CRNCY THEN 1 ELSE V_CURRENCY_RATE.EX_RATE END,TEMP.TRADE_AMT_DECIMAL)
                 ELSE ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL)
             END - TEMP.TOT_COST_TRADE  AS REF_PROFIT_LOSS               
           -- 2018.11.05 pan MOD 增加 參考損益(參考台幣)
           ,ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* V_CURRENCY_RATE.EX_RATE ,0) - TEMP.TOT_COST_NTD AS REF_PROFIT_LOSS_NTD
           -- 2018.10.31 JIANXIN MOD 調整除以零的錯誤
           -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
           -- 2018.11.08 ChengYu 查詢幣別 = '1' 市值、參考損益、投資報酬率(含息)、投資報酬率(不含息)以台幣參考損益回傳
           -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
           ,CASE WHEN WQUERY_TYPE = '1' AND TEMP.TOT_COST_NTD = 0 THEN 0 
                 WHEN WQUERY_TYPE = '1' AND FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 WHEN WQUERY_TYPE = '1' THEN ROUND((CASE WHEN WQUERY_TYPE = '1' THEN ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* CASE WHEN TEMP.TRADE_CRNCY = TEMP.FUND_CRNCY THEN 1 ELSE V_CURRENCY_RATE.EX_RATE END,TEMP.FUND_AMT_DECIMAL)
                                                         ELSE ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL)
                                                     END - TEMP.TOT_COST_TRADE) / (TEMP.TOT_COST_TRADE) * 100 , 2 )
                 WHEN WQUERY_TYPE = '2' AND TEMP.TOT_COST_TRADE = 0 THEN 0 
                 WHEN WQUERY_TYPE = '2' AND FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 WHEN WQUERY_TYPE = '2' THEN ROUND((ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL) - TEMP.TOT_COST_TRADE) / (TEMP.TOT_COST_TRADE) * 100 , 2 )
                 ELSE 0      
            END INCLUD_RETURN_RATE    --投資報酬率(含息)
           -- 2018.10.31 JIANXIN MOD 調整除以零的錯誤
           -- 2018.11.02 JIANXIN MOD 因後台紀錄的成本金額皆以計價幣別取小數位數，故而調整成計價幣別小數位數，以求與TA後台同步
           -- 2018.11.08 ChengYu 查詢幣別 = '1' 市值、參考損益、投資報酬率(含息)、投資報酬率(不含息)以台幣參考損益回傳
           -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
           ,CASE WHEN WQUERY_TYPE = '1' AND TEMP.TOT_COST_NTD = 0 THEN 0 
                 WHEN WQUERY_TYPE = '1' AND FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 WHEN WQUERY_TYPE = '1' THEN ROUND((CASE WHEN WQUERY_TYPE = '1' THEN ROUND(ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV ,TEMP.FUND_AMT_DECIMAL)* CASE WHEN TEMP.TRADE_CRNCY = TEMP.FUND_CRNCY THEN 1 ELSE V_CURRENCY_RATE.EX_RATE END,TEMP.FUND_AMT_DECIMAL)
                                                         ELSE ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL)
                                                     END - TEMP.TOT_COST_TRADE) / (TEMP.TOT_COST_TRADE) * 100 , 2 )
                 WHEN WQUERY_TYPE = '2' AND TEMP.TOT_COST_TRADE = 0 THEN 0 
                 WHEN WQUERY_TYPE = '2' AND FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 WHEN WQUERY_TYPE = '2' THEN ROUND((ROUND(TEMP.SHARES * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL) - TEMP.TOT_COST_TRADE) / (TEMP.TOT_COST_TRADE) * 100 , 2 )
                 ELSE 0     
            END EXCLUD_RETURN_RATE    --投資報酬率(不含息)
           -- 2018.11.05 pan MOD 增加 投資報酬率(參考台幣)
           ,CASE WHEN TEMP.TOT_COST_NTD = 0 THEN 0 
                 WHEN FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 ELSE ROUND((ROUND(ROUND(ROUND(TEMP.SHARES,FUND.SHARE_DECIMAL) * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL) * V_CURRENCY_RATE.EX_RATE,0) - TEMP.TOT_COST_NTD) / (TEMP.TOT_COST_NTD) * 100 , 2 )
             END INCLUD_RETURN_RATE_NTD    --投資報酬率(含息)(參考台幣)
           ,CASE WHEN TEMP.TOT_COST_NTD = 0 THEN 0 
                 WHEN FUND.ANNUALIZED_ROI = 'Y' THEN TEMP.RETURN_ROI
                 ELSE ROUND((ROUND(ROUND(ROUND(TEMP.SHARES,FUND.SHARE_DECIMAL) * NAV_DATE_TEMP.NAV,TEMP.FUND_AMT_DECIMAL) * V_CURRENCY_RATE.EX_RATE,0) - TEMP.TOT_COST_NTD) / (TEMP.TOT_COST_NTD) * 100 , 2 )
             END EXCLUD_RETURN_RATE_NTD    --投資報酬率(不含息)(參考台幣)
             -- =========2018.11.21 JIANXIN MOD 依據ES 提供之程式調整市值、成本計算方式  END =========
      FROM -- 2022.03.02 JIANXIN MOD 因應平均單位成本需要原幣成本而調整
           (SELECT MYINVENTORY_TEMP.* 
                   ,CASE WHEN MYINVENTORY_TEMP.FUND_CRNCY = MYINVENTORY_TEMP.TRADE_CRNCY THEN MYINVENTORY_TEMP.TOT_COST ELSE MYINVENTORY_TEMP.TOT_COST_NTD END TOT_COST_TRADE
              FROM ECS.MYINVENTORY_TEMP) TEMP
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = TEMP.HOLDFUND
      JOIN FAS.AMC AMC
        ON AMC.AMC_NO = FUND.AMC_NO
      --JOIN ECS.V_FUND_CRNCY FUND_CRNCY
      --  ON FUND_CRNCY.CURRENCY_NO = TEMP.FUND_CRNCY
      --JOIN ECS.V_FUND_CRNCY TRADE_CRNCY
      --  ON TRADE_CRNCY.CURRENCY_NO = TEMP.TRADE_CRNCY
      -- 2018.10.24 JIANXIN MOD 效能調整
      JOIN ECS.NAV_DATE_TEMP NAV_DATE_TEMP
        ON NAV_DATE_TEMP.FUND_NO = TEMP.HOLDFUND
      LEFT JOIN
           (SELECT A.FUND_NO , A.NAV_DATE ,MAX(V_CURRENCY_RATE.TX_DATE) AS TX_DATE
              FROM FAS.V_CURRENCY_RATE V_CURRENCY_RATE
              JOIN ECS.NAV_DATE_TEMP A
                ON A.FUND_NO = V_CURRENCY_RATE.FUND_NO
               AND V_CURRENCY_RATE.TX_DATE <= A.NAV_DATE
             GROUP BY A.FUND_NO,A.NAV_DATE) B
        ON TEMP.HOLDFUND = B.FUND_NO
      LEFT JOIN FAS.V_CURRENCY_RATE V_CURRENCY_RATE
        ON V_CURRENCY_RATE.FUND_NO = B.FUND_NO
       AND V_CURRENCY_RATE.TX_DATE = B.TX_DATE
     ORDER BY FUND.FUND_NO;

--dbms_output.put_line(to_char(systimestamp,'yyyy-mm-dd hh24:mi:ssxff') || ' end   OPEN OUTDT FOR');

  --取得配息金額
  OPEN OUTDT3 FOR
    SELECT DIVIDEND_DETAIL.FUND_NO
           ,DIVIDEND_DETAIL.AMOUNT
           ,DIVIDEND_DETAIL.NTD_AMOUNT
           ,DIVIDEND_DETAIL.ORG_CURRENCY_NO
           ,DIVIDEND_DETAIL.DIVIDEND_DATE
      FROM FAS.DIVIDEND DIVIDEND
      JOIN FAS.DIVIDEND_DETAIL DIVIDEND_DETAIL
        ON DIVIDEND.FUND_NO = DIVIDEND_DETAIL.FUND_NO
       AND DIVIDEND_DETAIL.ID = XID
      -- 2018.10.29 PAN MOD 效能調整，待詢問JIANXIN此OUTDT3哪裡會使用到
      --WHERE DIVIDEND.STATUS = 'C';
      WHERE DIVIDEND.STATUS = 'AAA';

END s_GetMyInventoryInfo;

/

  GRANT EXECUTE ON "ECS"."S_GETMYINVENTORYINFO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETNAV
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETNAV" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/03/07
-- Description: 取得淨值資料
-- 2018.03.14 ChengYu 新增基金代碼多筆、使用類別
-- 2018.03.16 ChengYu 資料存入暫存檔後，再做使用
-- 2018.03.19 ChengYu 多筆的WHERE條件改致C#做
-- 2018.03.22 Jim     新增回傳參數IS_SUCCESS、WARNS_TYPE、ERROR_MSG、EX_RATE、EX_DATE
-- 2018.03.26 ChengYu 調整傳入參數名稱
-- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
-- 2018.03.31 Jim 修改日期格式
-- 2018.04.03 Jim 新增查詢日期(起)與查詢日期(迄)相同的邏輯
-- 2018.04.09 Jim 修改回傳FUND_NO及日期為空值時回傳1900/01/01
-- 2018.05.24 Jim 補上table的Owner
-- 2018.06.20 ChengYu ECS.NAV_DATE_TEMP 對應欄位
-- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
-- 2018.08.28 YUNGLONG 增加「淨值漲跌幅」欄位
-- 2018.09.21 YungLong 修改淨值漲跌幅 公式及小數點取至4位數
-- 2018.09.21 YUNCHU 調整為募集方式為公開募集
-- 2018.09.27 ChengYu 修正原幣為台幣時無匯率錯誤
-- 2018.10.02 JIANXIN 顯示 銷售狀態 =  0：正常； 1：暫停銷售
-- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
-- 2019.01.08 YUNCHU 調整觀察基金淨值與投資組合相同
-- 2019.02.19 tingting 調整已清算基金條件語法
-- =============================================
(
    -- 2018.03.26 ChengYu 調整傳入參數名稱 BEGIN
     WQUERY_DATE_FROM      DATE                  -- 查詢日期(起)
    ,WQUERY_DATE_TO        DATE                  -- 查詢日期(迄)
    ,WUSE_TYPE             VARCHAR2              -- 使用類別 1：交易； 2：淨值公告
    ,WFUND_NO              VARCHAR2              -- 單筆基金代碼
    ,WISIN_CODE            VARCHAR2              -- 單筆ISIN_CODE
    -- 2018.03.26 ChengYu 調整傳入參數名稱 END
    ,OUTDT                  OUT SYS_REFCURSOR     -- 回傳錯誤訊息
    ,OUTDT2                 OUT SYS_REFCURSOR     -- 回傳的 TABLEDATA
) IS

XIS_SUCCESS VARCHAR2(1);    --取得資料成功否
XWARNS_TYPE VARCHAR2(1);    --警示方式
XERROR_MSG  VARCHAR2(250);  --錯誤訊息
XQUERY_DATE_FROM DATE:=TRUNC(WQUERY_DATE_FROM);  --查詢日期(起)(格式改為日期)
XQUERY_DATE_TO DATE:=TRUNC(WQUERY_DATE_TO);     --查詢日期(迄)(格式改為日期)
XFUND_NO VARCHAR2(10):='';
XCNT INT:=0;
-- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
XSYSDATE DATE := SYSDATE;

BEGIN

    -- 新增錯誤訊息 2018.03.22 Mod By Jim
    --若『查詢日期(起)( WQUERY_DATE_FROM)』與『查詢日期(迄)( QUERY_DATE_TO )』不可超過一個月，則回傳錯誤代碼A004
    --IF MONTHS_BETWEEN(XQUERY_DATE_TO,XQUERY_DATE_FROM) > 1 THEN

    --  XIS_SUCCESS := 'N';

    --  SELECT MSGTYPE, MSGCONTENT
    --          INTO XWARNS_TYPE, XERROR_MSG
    --          FROM ECS.MSGINFO
    --         WHERE MSGID = 'A004';

    --  GOTO TO_END;

    --END IF;

    XIS_SUCCESS := 'Y';
    XWARNS_TYPE := '';
    XERROR_MSG  := '';

    SELECT SUM(CNT)
      INTO XCNT
      FROM (SELECT COUNT(VALUE1) CNT
              FROM TABLE(ECS.F_FormatStringListToTable(WFUND_NO))
             UNION
            SELECT COUNT(VALUE1) CNT
              FROM TABLE(ECS.F_FormatStringListToTable(WISIN_CODE))) A;


    BEGIN

        IF WFUND_NO IS NOT NULL  AND XCNT = 1 THEN

             SELECT FUND_NO INTO XFUND_NO
               FROM FAS.FUND
              WHERE WFUND_NO = FUND_NO;

        END IF ;
        IF WISIN_CODE IS NOT NULL AND XCNT = 1  THEN


            SELECT FUND_NO INTO XFUND_NO
              FROM FAS.FUND
             WHERE WISIN_CODE = ISIN_CODE;

        END IF;

        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XFUND_NO := '';

    END;

    --清除淨值暫存檔
    DELETE FROM ECS.NAV_DATE_TEMP;

    -- 如果時間相同則搜尋小於等於WQUERY_DATE_TO的淨值
    IF WQUERY_DATE_FROM = WQUERY_DATE_TO THEN

      -- 2018.06.20 ChengYu ECS.NAV_DATE_TEMP 對應欄位
      -- 2019.01.08 YUNCHU 調整觀察基金淨值與投資組合相同
      INSERT INTO ECS.NAV_DATE_TEMP
           (
              FUND_NO
             ,NAV_DATE
             ,TX_DATE
             ,NAV
             ,CHANGE
             ,BAL_SHARE
             ,NET_ASSET
           )
      SELECT B.FUND_NO
             ,B.NAV_DATE
             ,B.TX_DATE
             ,B.NAV
             ,B.CHANGE
             ,B.BAL_SHARE
             ,B.NET_ASSET
        FROM NAV.NAV B
        JOIN (SELECT NAV.FUND_NO, MAX(NAV_DATE) AS NAV_DATE
                FROM NAV.NAV
                JOIN FAS.FUND
                  ON NAV.FUND_NO = FUND.FUND_NO 
               WHERE NAV.NAV_DATE <= WQUERY_DATE_TO
                 AND (NAV.FUND_NO = XFUND_NO OR XFUND_NO IS NULL)
                 AND (  (WUSE_TYPE = '3' AND NAV.NAV_DATE < FUND.AC_DATE  )
                     OR WUSE_TYPE IN ('1','2') 
                     )
               GROUP BY NAV.FUND_NO) A
          ON A.FUND_NO = B.FUND_NO
         AND A.NAV_DATE = B.NAV_DATE;

    ELSE

      -- 2018.06.20 ChengYu ECS.NAV_DATE_TEMP 對應欄位
      -- 2019.01.08 YUNCHU 調整觀察基金淨值與投資組合相同
      INSERT INTO ECS.NAV_DATE_TEMP
           (
              FUND_NO
             ,NAV_DATE
             ,TX_DATE
             ,NAV
             ,CHANGE
             ,BAL_SHARE
             ,NET_ASSET
           )
      SELECT B.FUND_NO
             ,B.NAV_DATE
             ,B.TX_DATE
             ,B.NAV
             ,B.CHANGE
             ,B.BAL_SHARE
             ,B.NET_ASSET
        FROM NAV.NAV B
        JOIN (SELECT NAV.FUND_NO
                     ,NAV.NAV_DATE
                FROM NAV.NAV NAV
				JOIN FAS.FUND
                  ON NAV.FUND_NO = FUND.FUND_NO
               WHERE NAV.NAV_DATE BETWEEN WQUERY_DATE_FROM AND WQUERY_DATE_TO
                 AND (NAV.FUND_NO = XFUND_NO OR XFUND_NO IS NULL)
				 AND (  (WUSE_TYPE = '3' AND NAV.NAV_DATE < FUND.AC_DATE  )
                     OR WUSE_TYPE IN ('1','2') 
                     )) A
          ON A.FUND_NO = B.FUND_NO
         AND A.NAV_DATE = B.NAV_DATE;

    END IF;

    -- 2018.03.14 CHENGYU 新增基金代碼多筆、使用類別
    IF WUSE_TYPE = '1' THEN

      OPEN OUTDT2 FOR
       SELECT  FUND.FUND_CATEGORY AS FUND_CATEGORY   -- 境內外識別碼
               ,FUND.AMC_NO AS AMC_NO                -- 基金公司代碼
               ,AMC.NAME AS AMC_NAME                 -- 基金公司名稱
               ,FUND.FUND_NO AS FUND_NO              -- 基金代碼
               ,FUND.NAME AS FUND_NAME               -- 基金名稱
               ,FUND.DIVIDEND_DESC AS FUND_MEMO      -- 基金警語
               ,FUND.ISIN_CODE AS ISIN_CODE          -- 國際證券代碼
               ,FUND.CURRENCY_NO AS CURRENCY_NO      -- 計價幣別
               -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME   -- 計價幣別名稱
               ,NVL(NAV.NAV_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS NAV_DATE              -- 最新淨值日期
               ,NAV.NAV AS NAV                       -- 最新淨值
               -- 2018.03.22 MOD BY JIM 新增 EX_RATE、EX_DATE
               -- 2018.09.27 ChengYu 修正原幣為台幣時無匯率錯誤
               ,CASE WHEN FUND.CURRENCY_NO = 'NTD' THEN 1
                     ELSE V_CURRENCY_RATE.EX_RATE
                END AS EX_RATE                       -- 參考匯率
               ,NVL(V_CURRENCY_RATE.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS EX_DATE    -- 參考匯率日期
               ,NAV.CHANGE AS NAV_CHANGE             -- 淨值漲跌
               -- 2018.08.28 YUNGLONG 增加「淨值漲跌幅」欄位
               -- 2018.09.21 YungLong 修改淨值漲跌幅 公式及小數點取至4位數
               ,ROUND((NAV.CHANGE / (NAV.NAV - NAV.CHANGE)) * 100,4) AS NAV_CHANGE_PER	 -- 淨值漲跌幅 
               ,NAV.BAL_SHARE AS BAL_SHARE           -- 庫存單位數
               ,NAV.NET_ASSET AS NAV_ASSET           -- 淨資產
               ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL  -- 單位數小數位數
               ,FUND.NAV_DECIMAL AS NAV_DECIMAL      -- 淨值小數位數
               ,FUND.AMT_DECIMAL AS AMT_DECIMAL      -- 計價幣別小數位數
          FROM FAS.FUND FUND
          LEFT JOIN
              (SELECT  A.FUND_NO , A.NAV_DATE ,MAX(V_CURRENCY_RATE.TX_DATE) AS TX_DATE
                  FROM FAS.V_CURRENCY_RATE V_CURRENCY_RATE
                  JOIN ECS.NAV_DATE_TEMP A
                   ON  A.FUND_NO = V_CURRENCY_RATE.FUND_NO
                   AND V_CURRENCY_RATE.TX_DATE <= A.NAV_DATE
                   GROUP BY A.FUND_NO,A.NAV_DATE) B
            ON FUND.FUND_NO = B.FUND_NO
          LEFT JOIN FAS.V_CURRENCY_RATE V_CURRENCY_RATE
            ON V_CURRENCY_RATE.FUND_NO = B.FUND_NO
            AND V_CURRENCY_RATE.TX_DATE = B.TX_DATE
          LEFT JOIN NAV.NAV NAV
            ON NAV.FUND_NO = B.FUND_NO
            AND NAV.NAV_DATE = B.NAV_DATE
          LEFT JOIN FAS.AMC AMC
            ON FUND.AMC_NO = AMC.AMC_NO
          -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE (FUND.FUND_NO = XFUND_NO OR XFUND_NO IS NULL)
           -- 2018.09.21 YUNCHU 調整為募集方式為公開募集
           AND FUND.OFFERING_TYPE = '1'
           -- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
           -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
           -- 2019.02.19 tingting 調整已清算基金條件語法
           AND (
                 -- 境內基金清算日期判斷 CLEAR_DATE
                 (     
                   FUND.FUND_CATEGORY = '1' 
                   AND  
                   (
                     (FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )              
                 OR
                 -- 境外基金清算日期判斷 ELIMINATION_DATE
                 (     
                   FUND.FUND_CATEGORY = '2' 
                   AND  
                   (
                     -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                     (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )
               )
           -- 2018.10.02 JIANXIN 顯示 銷售狀態 =  0：正常； 1：暫停銷售
           AND FUND.SALES_TYPE IN ('0','1');                 -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；

    GOTO TO_END;

    -- 2018.03.14 CHENGYU 新增基金代碼多筆、使用類別
    ELSIF WUSE_TYPE = '2' THEN

      OPEN OUTDT2 FOR
       SELECT  FUND.FUND_CATEGORY AS FUND_CATEGORY   -- 境內外識別碼
               ,FUND.AMC_NO AS AMC_NO                -- 基金公司代碼
               ,AMC.NAME AS AMC_NAME                 -- 基金公司名稱
               ,FUND.FUND_NO AS FUND_NO              -- 基金代碼
               ,FUND.NAME AS FUND_NAME               -- 基金名稱
               ,FUND.DIVIDEND_DESC AS FUND_MEMO      -- 基金警語
               ,FUND.ISIN_CODE AS ISIN_CODE          -- 國際證券代碼
               ,FUND.CURRENCY_NO AS CURRENCY_NO      -- 計價幣別
               -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME   -- 計價幣別名稱
               ,NVL(NAV.NAV_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS NAV_DATE             -- 最新淨值日期
               ,NAV.NAV AS NAV                       -- 最新淨值
               -- 2018.03.22 MOD BY JIM 新增 EX_RATE、EX_DATE
               -- 2018.09.27 ChengYu 修正原幣為台幣時無匯率錯誤
               ,CASE WHEN FUND.CURRENCY_NO = 'NTD' THEN 1
                     ELSE V_CURRENCY_RATE.EX_RATE
                END AS EX_RATE                       -- 參考匯率
               ,NVL(V_CURRENCY_RATE.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS EX_DATE   -- 參考匯率日期
               ,NAV.CHANGE AS NAV_CHANGE             -- 淨值漲跌
               -- 2018.08.28 YUNGLONG 增加「淨值漲跌幅」欄位
               -- 2018.09.21 YungLong 修改淨值漲跌幅 公式及小數點取至4位數
               ,ROUND((NAV.CHANGE / (NAV.NAV - NAV.CHANGE)) * 100,4) AS NAV_CHANGE_PER	 -- 淨值漲跌幅 
               ,NAV.BAL_SHARE AS BAL_SHARE           -- 庫存單位數
               ,NAV.NET_ASSET AS NAV_ASSET           -- 淨資產
               ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL  -- 單位數小數位數
               ,FUND.NAV_DECIMAL AS NAV_DECIMAL      -- 淨值小數位數
               ,FUND.AMT_DECIMAL AS AMT_DECIMAL      -- 計價幣別小數位數
          FROM FAS.FUND FUND
          LEFT JOIN
              (SELECT  A.FUND_NO , A.NAV_DATE ,MAX(V_CURRENCY_RATE.TX_DATE) AS TX_DATE
                  FROM FAS.V_CURRENCY_RATE V_CURRENCY_RATE
                  JOIN ECS.NAV_DATE_TEMP A
                   ON  A.FUND_NO = V_CURRENCY_RATE.FUND_NO
                   AND V_CURRENCY_RATE.TX_DATE <= A.NAV_DATE
                   GROUP BY A.FUND_NO,A.NAV_DATE) B
            ON FUND.FUND_NO = B.FUND_NO
          LEFT JOIN FAS.V_CURRENCY_RATE V_CURRENCY_RATE
            ON V_CURRENCY_RATE.FUND_NO = B.FUND_NO
            AND V_CURRENCY_RATE.TX_DATE = B.TX_DATE
          LEFT JOIN NAV.NAV NAV
            ON NAV.FUND_NO = B.FUND_NO
            AND NAV.NAV_DATE = B.NAV_DATE
          LEFT JOIN FAS.AMC AMC
            ON FUND.AMC_NO = AMC.AMC_NO
          -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE (FUND.FUND_NO = XFUND_NO OR XFUND_NO IS NULL)
           -- 2018.09.21 YUNCHU 調整為募集方式為公開募集
           AND FUND.OFFERING_TYPE = '1'
           -- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
           -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
           -- 2019.02.19 tingting 調整已清算基金條件語法
           AND (
                 -- 境內基金清算日期判斷 CLEAR_DATE
                 (     
                   FUND.FUND_CATEGORY = '1' 
                   AND  
                   (
                     (FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )              
                 OR
                 -- 境外基金清算日期判斷 ELIMINATION_DATE
                 (     
                   FUND.FUND_CATEGORY = '2' 
                   AND  
                   (
                     -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                     (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )
               )
           -- 2018.10.02 JIANXIN 顯示 銷售狀態 =  0：正常； 1：暫停銷售
           AND FUND.SALES_TYPE IN ('0','1');                 -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；

    GOTO TO_END;

    ELSIF WUSE_TYPE = '3' THEN
     OPEN OUTDT2 FOR
       SELECT  FUND.FUND_CATEGORY AS FUND_CATEGORY   -- 境內外識別碼
               ,FUND.AMC_NO AS AMC_NO                -- 基金公司代碼
               ,AMC.NAME AS AMC_NAME                 -- 基金公司名稱
               ,FUND.FUND_NO AS FUND_NO              -- 基金代碼
               ,FUND.NAME AS FUND_NAME               -- 基金名稱
               ,FUND.DIVIDEND_DESC AS FUND_MEMO      -- 基金警語
               ,FUND.ISIN_CODE AS ISIN_CODE          -- 國際證券代碼
               ,FUND.CURRENCY_NO AS CURRENCY_NO      -- 計價幣別
               -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME   -- 計價幣別名稱
               ,NVL(NAV.NAV_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS NAV_DATE              -- 最新淨值日期
               ,NAV.NAV AS NAV                       -- 最新淨值
               -- 2018.03.22 MOD BY JIM 新增 EX_RATE、EX_DATE
               -- 2018.09.27 ChengYu 修正原幣為台幣時無匯率錯誤
               ,CASE WHEN FUND.CURRENCY_NO = 'NTD' THEN 1
                     ELSE V_CURRENCY_RATE.EX_RATE
                END AS EX_RATE                       -- 參考匯率
               ,NVL(V_CURRENCY_RATE.TX_DATE,TO_DATE('1900/01/01','YYYY/MM/DD')) AS EX_DATE    -- 參考匯率日期
               ,NAV.CHANGE AS NAV_CHANGE             -- 淨值漲跌
               -- 2018.08.28 YUNGLONG 增加「淨值漲跌幅」欄位
               -- 2018.09.21 YungLong 修改淨值漲跌幅 公式及小數點取至4位數
               ,ROUND((NAV.CHANGE / (NAV.NAV - NAV.CHANGE)) * 100,4) AS NAV_CHANGE_PER   -- 淨值漲跌幅
               ,NAV.BAL_SHARE AS BAL_SHARE           -- 庫存單位數
               ,NAV.NET_ASSET AS NAV_ASSET           -- 淨資產
               ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL  -- 單位數小數位數
               ,FUND.NAV_DECIMAL AS NAV_DECIMAL      -- 淨值小數位數
               ,FUND.AMT_DECIMAL AS AMT_DECIMAL      -- 計價幣別小數位數
          FROM FAS.FUND FUND
          LEFT JOIN
               (SELECT A.FUND_NO , A.NAV_DATE ,MAX(V_CURRENCY_RATE.TX_DATE) AS TX_DATE
                  FROM FAS.V_CURRENCY_RATE V_CURRENCY_RATE
                  JOIN ECS.NAV_DATE_TEMP A
                    ON A.FUND_NO = V_CURRENCY_RATE.FUND_NO
                   AND V_CURRENCY_RATE.TX_DATE <= A.NAV_DATE
                  JOIN FAS.FUND
                    ON FUND.FUND_NO = A.FUND_NO
                   AND A.NAV_DATE < FUND.AC_DATE
                 GROUP BY A.FUND_NO,A.NAV_DATE) B
            ON FUND.FUND_NO = B.FUND_NO
          LEFT JOIN FAS.V_CURRENCY_RATE V_CURRENCY_RATE
            ON V_CURRENCY_RATE.FUND_NO = B.FUND_NO
            AND V_CURRENCY_RATE.TX_DATE = B.TX_DATE
          LEFT JOIN NAV.NAV NAV
            ON NAV.FUND_NO = B.FUND_NO
           AND NAV.NAV_DATE = B.NAV_DATE
          LEFT JOIN FAS.AMC AMC
            ON FUND.AMC_NO = AMC.AMC_NO
          -- 2018.03.31 ChengYu 幣別名稱改從 ECS.V_FUND_CRNCY 取得
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE (FUND.FUND_NO = XFUND_NO OR XFUND_NO IS NULL)
           -- 2018.09.21 YUNCHU 調整為募集方式為公開募集
           AND FUND.OFFERING_TYPE = '1'
           -- 2018.08.17 ChengYu 增加「銷售狀態 (SALES_TYPE)」為”0.正常、停止交易日、販售終止日 條件
           -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
           -- 2019.02.19 tingting 調整已清算基金條件語法
           AND (
                 -- 境內基金清算日期判斷 CLEAR_DATE
                 (     
                   FUND.FUND_CATEGORY = '1' 
                   AND  
                   (
                     (FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )              
                 OR
                 -- 境外基金清算日期判斷 ELIMINATION_DATE
                 (     
                   FUND.FUND_CATEGORY = '2' 
                   AND  
                   (
                     -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                     (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                     OR 
                     (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                     OR 
                     (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                   )
                 )
               )
           -- 2018.10.02 JIANXIN 顯示 銷售狀態 =  0：正常； 1：暫停銷售
           AND FUND.SALES_TYPE IN ('0','1');                 -- 銷售狀態 0：正常； 1：暫停銷售 ；2： 未開賣；

    GOTO TO_END;

    END IF;

    <<TO_END>>

    OPEN OUTDT FOR
     -- 2018.03.22 MOD BY JIM 新增 IS_SUCCESS、WARNS_TYPE、ERROR_MSG
     SELECT  XIS_SUCCESS AS IS_SUCCESS             -- 是否成功
             ,XWARNS_TYPE AS WARNS_TYPE            -- 警示方式
             ,XERROR_MSG  AS ERROR_MSG             -- 錯誤訊息
             FROM DUAL;

END s_GetNav;

/

  GRANT EXECUTE ON "ECS"."S_GETNAV" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETOBSERVATIONFUNDLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETOBSERVATIONFUNDLIST" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/04/10
-- Description: API058 取得我的觀察基金列表
-- 2018.04.24 MOD BY JIM 修改Alert_Type
-- 2018.05.04 MOD BY JIM 修改通知回傳Y/N,ALERT_FREQ_EMAIL 名稱
-- 2018.05.09 MOD BY JIM 修改IS_ALERT_DATE為Y才有值
-- 2018.07.17 tingting 修正除以0的錯誤
-- 2018.08.31 JIANXIN 新增資料來源與資料更新日期
-- 2018.09.17 YungLong 新增AMC_NO, AMC_NAME, CURRENCY_NO, CURRENCY_NAME, RISK_CATEGORY, INVESTMENT_TYPE傳出欄位
-- 2018.09.17 YungLong 新增INVESTMENT_TYPE_NAME, DIVIDEND_TYPE, DIVIDEND_TYPE_NAME傳出欄位
-- 2018.10.15 tingting 修正單日淨值漲跌幅(%)計算錯誤
-- 2018.10.23 tingting 增加基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
-- 2019.03.11 tingting 1.效能優化：NAV相關資訊從C#改至SP直接取直接用，並一次回傳全部觀察基金資料
--                     2.修正取配息頻率資料錯誤
-- 2024.01.03 Richard 調整報酬率值若為null時 , 顯示為-99999.0
-- =============================================
(
    WACCOUNT_NO             INTEGER,                    -- 受益人戶號
    OUTDT                   OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA
) IS

    XID                     VARCHAR2(10);               --受益人ID
    XDATA_COUNT             INT;                        --資料筆數
    XSYS_DTTM               DATE := TRUNC(SYSDATE);     --系統日期
    NAV_OUTDT1              SYS_REFCURSOR;              --s_GetNAV回傳的錯誤訊息
    NAV_OUTDT2              SYS_REFCURSOR;              --s_GetNAV回傳的淨值資料
BEGIN

    --取得受益人ID
    BEGIN

        SELECT ID INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    -- 2019.03.11 tingting 1.效能優化：NAV相關資訊從C#改至SP直接取直接用，並一次回傳全部觀察基金資料
    --                     2.修正取配息頻率資料錯誤
    SELECT COUNT(*)
      INTO XDATA_COUNT
      FROM WPS.FUND_ALERT
     WHERE FUND_ALERT.TYPE = '1'        --類別 0.我的投資組合；1.我的基金觀察；2.ROBO 觀察基金
       AND FUND_ALERT.ID = XID;

    IF (XDATA_COUNT > 0) THEN
        ECS.s_GetNAV(XSYS_DTTM, XSYS_DTTM, '2', '', '', NAV_OUTDT1, NAV_OUTDT2);    --取得淨值資料(查詢日期(起), 查詢日期(迄), 使用類別 1：交易； 2：淨值公告, 基金代碼, ISIN_CODE, 回傳的錯誤訊息,  回傳的淨值資料)
    END IF;

    -- 2018.09.17 YungLong 新增AMC_NO, AMC_NAME, CURRENCY_NO, CURRENCY_NAME, RISK_CATEGORY, INVESTMENT_TYPE傳出欄位
    -- 2018.09.17 YungLong 新增INVESTMENT_TYPE_NAME, DIVIDEND_TYPE, DIVIDEND_TYPE_NAME傳出欄位
    -- 2019.03.11 tingting 1.效能優化：NAV相關資訊從C#改至SP直接取直接用，並一次回傳全部觀察基金資料
    --                     2.修正取配息頻率資料錯誤
    OPEN OUTDT FOR
    SELECT FUND.FUND_CATEGORY                                    --境內外識別碼
          ,DECODE(FUND.FUND_CATEGORY,'1','境內','2','境外',NULL) AS FUND_CATEGORY_NAME  --境內外識別碼名稱
           -- 2018.09.17 YungLong 新增AMC_NO, AMC_NAME傳出欄位
          ,FUND.AMC_NO                                           --基金公司代碼
          ,AMC.NAME AS AMC_NAME                                  --基金公司名稱
          ,FUND.FUND_NO                                          --基金代碼
          ,FUND.NAME AS FUND_NAME                                --基金名稱
          ,FUND.DIVIDEND_DESC AS FUND_MEMO                       --基金警語
          ,FUND.ISIN_CODE                                        --國際證券代碼
           -- 2018.09.17 新增CURRENCY_NO, CURRENCY_NAME, INVESTMENT_TYPE, INVESTMENT_TYPE_NAME, RISK_CATEGORY傳出欄位
          ,FUND.CURRENCY_NO                                      --計價幣別
          ,V_FUND_CRNCY.NAME AS CURRENCY_NAME                    --計價幣別名稱
          ,FUND.RISK_CATEGORY                                    --風險等級
          ,FUND.INVESTMENT_TYPE                                  --投資類型
          ,INVESTMENT_TYPE.NAME AS INVESTMENT_TYPE_NAME          --投資類型名稱
          ,FUND.AREA_TYPE                                        --基金投資地區
          ,FUND_AREA.DESCRIPTION AS AREA_NAME                    --基金投資地區名稱
           -- 2018.09.17 YungLong 新增DIVIDEND_TYPE, DIVIDEND_TYPE_NAME傳出欄位
          ,FUND_DIVIDEND.DIVIDEND_TYPE                           --配息頻率
          ,CASE WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'M' THEN '月配'
                WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'Q' THEN '季配'
                WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'S' THEN '半年配'
                WHEN FUND_DIVIDEND.DIVIDEND_TYPE = 'Y' THEN '年配'
                END AS DIVIDEND_TYPE_NAME                        --配息頻率名稱
          ,NAV_LIST.NAV_DATE AS NAV_DATE                         --最新淨值日期
          ,ROUND(NAV_LIST.NAV,FUND.NAV_DECIMAL) AS NAV                   --最新淨值
          ,ROUND(NAV_LIST.CHANGE,FUND.NAV_DECIMAL) AS NAV_CHANGE         --單日淨值漲跌
          -- 2018.07.17 tingting 修正除以0的錯誤
          -- 2018.10.15 tingting 修正單日淨值漲跌幅(%)計算錯誤
          ,CASE WHEN NVL(NAV_LIST.NAV - NAV_LIST.CHANGE, 0) = 0 THEN 0
                ELSE ROUND(NAV_LIST.CHANGE / (NAV_LIST.NAV - NAV_LIST.CHANGE) * 100, 2)
                END AS NAV_CHANGE_PER                            --單日淨值漲跌幅(%)
          -- 2024.01.03 begin modified by Richard 調整報酬率值若為null時 , 顯示為-99999.0
          ,NVL(ROUND(FUND_INFO.ROI_3_MONTH,4),-99999.0) AS ROI_3_MONTH   --報酬率-3個月
          ,NVL(ROUND(FUND_INFO.ROI_6_MONTH,4),-99999.0) AS ROI_6_MONTH   --報酬率-6個月
          ,NVL(ROUND(FUND_INFO.ROI_1_YEAR,4),-99999.0) AS ROI_1_YEAR     --報酬率-1年
          ,NVL(ROUND(FUND_INFO.ROI_2_YEAR,4),-99999.0) AS ROI_2_YEAR     --報酬率-2年
          ,NVL(ROUND(FUND_INFO.ROI_3_YEAR,4),-99999.0) AS ROI_3_YEAR     --報酬率-3年
          ,NVL(ROUND(FUND_INFO.ROI,4),-99999.0) AS ROI                   --報酬率-成立以來
          -- 2024.01.03 end modified by Richard 調整報酬率值若為null時 , 顯示為-99999.0
          ,FUND.NAV_DECIMAL                                      --淨值小數位數
          ,CASE WHEN FUND_ALERT.ALERT IS NOT NULL THEN 'Y'
                ELSE 'N'
                END AS IS_ALERT_DATA                             --有警示設定資料
          ,CASE WHEN FUND_ALERT.ALERT IS NOT NULL THEN FUND_ALERT.BUY_IN
                ELSE NULL
                END AS BUY_IN                                    --警示條件 – 淨值停利價位
          ,CASE WHEN FUND_ALERT.ALERT IS NOT NULL THEN FUND_ALERT.SELL_OUT
                ELSE NULL
                END AS SELL_OUT                                  --警示條件 – 淨值停損價位
          ,CASE WHEN FUND_ALERT.ALERT IS NOT NULL THEN FUND_ALERT.ALERT
                ELSE NULL
                END AS ALERT                                     --警示設定
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT.ALERT = 'Y' AND NAV_LIST.NAV >= FUND_ALERT.BUY_IN THEN 'Y'
                ELSE 'N'
                END AS ALERT_UPPER                               --到達停利警示否
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT.ALERT = 'Y' AND NAV_LIST.NAV >= FUND_ALERT.SELL_OUT THEN 'Y'
                ELSE 'N'
                END AS ALERT_LOWER                               --到達停損警示否
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT_TYPE_WEB.ID IS NOT NULL THEN 'Y'
                ELSE 'N'
                END AS ALERT_TYPE_WEB                            --通知方式(網頁)
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT_TYPE_WEB.ID IS NOT NULL THEN FUND_ALERT_TYPE_WEB.ALERT_FREQ
                ELSE NULL
                END AS ALERT_FREQ_WEB                            --通知方式(網頁) - 通知頻率
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT_TYPE_EMAIL.ID IS NOT NULL THEN 'Y'
                ELSE 'N'
                END AS ALERT_TYPE_EMAIL --通知方式(信件)
          ,CASE WHEN FUND_ALERT.ALERT IS NULL THEN NULL
                WHEN FUND_ALERT_TYPE_EMAIL.ID IS NOT NULL THEN FUND_ALERT_TYPE_EMAIL.ALERT_FREQ
                ELSE NULL
                END AS ALERT_FREQ_EMAIL                          --通知方式(信件) - 通知頻率
           -- 2018.08.31 JIANXIN 新增資料來源與資料更新日期
          ,FUND_INFO.DATA_SOURCE                                 --資料來源
          ,FUND_INFO.DATA_UPD_DATE                               --資料更新日期
      FROM WPS.FUND_ALERT               --停損停利到價通知
      LEFT JOIN WPS.FUND_ALERT_TYPE FUND_ALERT_TYPE_WEB         --基金到價及停損停利設定(網頁通知)
        ON FUND_ALERT_TYPE_WEB.ID = FUND_ALERT.ID
       AND FUND_ALERT_TYPE_WEB.FUND_NO = FUND_ALERT.FUND_NO
       AND FUND_ALERT_TYPE_WEB.TYPE = FUND_ALERT.TYPE
       AND FUND_ALERT_TYPE_WEB.ALERT_TYPE = '1'                 --通知方式 1. 網頁通知；2. EMail通知
      LEFT JOIN WPS.FUND_ALERT_TYPE FUND_ALERT_TYPE_EMAIL       --基金到價及停損停利設定(EMail通知)
        ON FUND_ALERT_TYPE_EMAIL.ID = FUND_ALERT.ID
       AND FUND_ALERT_TYPE_EMAIL.FUND_NO = FUND_ALERT.FUND_NO
       AND FUND_ALERT_TYPE_EMAIL.TYPE = FUND_ALERT.TYPE
       AND FUND_ALERT_TYPE_EMAIL.ALERT_TYPE = '2'               --通知方式 1. 網頁通知；2. EMail通知
      LEFT JOIN FAS.FUND                --基金主檔
        ON FUND.FUND_NO = FUND_ALERT.FUND_NO
      LEFT JOIN FAS.FUND_AREA           --基金投資區域
        ON FUND_AREA.AREA_TYPE = FUND.AREA_TYPE
      LEFT JOIN WPS.FUND_INFO           --基金績效資料
        ON FUND_INFO.FUND_NO = FUND.FUND_NO
      -- 2018.09.17 Yunglong JOIN取得AMC, V_FUND_CRNCY, FAS.INVESTMENT_TYPE, WPS.FUND_DIVIDEND
      LEFT JOIN FAS.AMC                 --基金公司
        ON AMC.AMC_NO = FUND.AMC_NO
      LEFT JOIN  ECS.V_FUND_CRNCY       --幣別檔(View)
        ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
      LEFT JOIN FAS.INVESTMENT_TYPE     --基金投資類型
        ON INVESTMENT_TYPE.INVESTMENT_TYPE = FUND.INVESTMENT_TYPE
      LEFT JOIN (--取得各基金最接近系統日的配息基準日
            SELECT  FUND_DIVIDEND.FUND_NO
                   ,MAX(FUND_DIVIDEND.DIVIDEND_DATE) AS DIVIDEND_DATE
              FROM WPS.FUND_DIVIDEND    --基金配息資訊
             WHERE FUND_DIVIDEND.DIVIDEND_DATE <= XSYS_DTTM
             GROUP BY FUND_DIVIDEND.FUND_NO
           ) FUND_DIVIDEND_DATE         --基金配息資訊(最後日期)
        ON FUND_DIVIDEND_DATE.FUND_NO = FUND.FUND_NO
      LEFT JOIN WPS.FUND_DIVIDEND       --基金配息資訊
        ON FUND_DIVIDEND.FUND_NO = FUND_DIVIDEND_DATE.FUND_NO
       AND FUND_DIVIDEND.DIVIDEND_DATE = FUND_DIVIDEND_DATE.DIVIDEND_DATE
      LEFT JOIN ECS.NAV_DATE_TEMP NAV_LIST  --淨值資料
        ON NAV_LIST.FUND_NO = FUND_ALERT.FUND_NO
     WHERE FUND_ALERT.TYPE = '1'        --類別 0.我的投資組合；1.我的基金觀察；2.ROBO 觀察基金
       AND FUND_ALERT.ID = XID
     -- 2018.10.23 tingting 增加基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
     ORDER BY FUND.FUND_CATEGORY, FUND.AMC_NO, FUND.SITCA_FUND_TYPE, FUND.ORDINAL, DECODE(FUND.SHARE_CLASS,NULL,'1',FUND.SHARE_CLASS), FUND.ORDINAL;

END s_GetObservationFundList;

/

  GRANT EXECUTE ON "ECS"."S_GETOBSERVATIONFUNDLIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETONLINEPARAMETER
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETONLINEPARAMETER" 
-- =============================================
-- Author:      tingting
-- Create date: 2020/06/15
-- Description: API826 取得線上開戶參數
-- =============================================
(
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS
BEGIN

    OPEN OUTDT FOR
    SELECT  '10000081' AS BILLER_ID     --委託單位代號
           ,'00001' AS PAYMENT_TPYE     --繳費類別
      FROM DUAL;

END s_GetOnlineParameter;

/

  GRANT EXECUTE ON "ECS"."S_GETONLINEPARAMETER" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETOPENCURRENCY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETOPENCURRENCY" 
-- =============================================
-- Author:      JIANXIN`
-- Create date: 2021/05/27
-- Description: 取得開戶財金外幣幣別
-- =============================================
(     
     OUTDT          OUT SYS_REFCURSOR        -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
     SELECT V_FUND_CRNCY.CURRENCY_NO AS CURRENCY_NO
	        ,V_FUND_CRNCY.NAME AS NAME
       FROM ECS.V_FUND_CRNCY 
      WHERE V_FUND_CRNCY.CURRENCY_NO IN ('EUR','USD','FCY','MMA','CNY','JPY','AUD')      
       ORDER BY V_FUND_CRNCY.CURRENCY_NO;

END s_GetOpenCurrency;

/

  GRANT EXECUTE ON "ECS"."S_GETOPENCURRENCY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETPOSITION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETPOSITION" 
(
     OUTDT          OUT SYS_REFCURSOR        -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR   
    -- 2018.03.14 ChengYu 刪除多餘Select 
    SELECT  POSITION.POSITION AS POSITION
           ,POSITION.NAME AS POSITION_NM 
      FROM FAS.POSITION POSITION;

END s_GetPosition;

/

  GRANT EXECUTE ON "ECS"."S_GETPOSITION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETPROFESSION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETPROFESSION" 
(
    OUTDT          OUT SYS_REFCURSOR               -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
        SELECT PROFESSION.PROFESSION               --職業別
               ,PROFESSION.NAME AS PROFESSION_NM   --名稱
          FROM FAS.PROFESSION PROFESSION
          WHERE PROFESSION.IR_CODE = 'R'
         GROUP BY PROFESSION.PROFESSION,PROFESSION.NAME
         ORDER BY PROFESSION.PROFESSION;

END s_GetProfession;

/

  GRANT EXECUTE ON "ECS"."S_GETPROFESSION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMACCOUNT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMACCOUNT" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/04/18
-- Description: 取得買回基金可匯入帳號列表
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.09.21 JIANXIN MOD BY 調整買回帳號取得邏輯
-- 2018.10.09 ChengYu 新增回傳欄位 帳戶保管平台代號
-- 2018.10.18 ChengYu 帳戶保管平台代號 依基金公司代號(AMC_NO)來取
-- 2019.06.05 tingting 調整買回帳號瑞萬的判斷條件(生效日>=集保生效日 → 集保生效日>=生效日)
-- 2021.12.21 Chengyu 修正取不到MMA帳戶問題
-- =============================================
(
     WACCOUNT_NO    INTEGER,            -- 受益人戶號
     WFUND_NO       VARCHAR2,           -- 基金代碼
     WTRADE_CRNCY   VARCHAR2,           -- 申購幣別
     WTX_DATE       DATE,               -- 買回交易日期
     OUTDT          OUT SYS_REFCURSOR   -- 買回帳號列表
) IS

XID VARCHAR2(10);               -- 受益人ID
XTX_DATE DATE:=TRUNC(WTX_DATE); -- 買回交易日期(YYYY/MM/DD)

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');
  END;

  OPEN OUTDT FOR
    SELECT HOLDER_BANK.BANK_NO             --往來總行代碼
           ,HOLDER_BANK.BRANCH_NO          --往來分行代碼
           ,HOLDER_BANK.FIS_SNAME          --往來銀行簡稱
           ,HOLDER_BANK.AC_CODE            --往來帳號
           ,HOLDER_BANK.AC_NAME            --帳號戶名
           -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
           ,ECS.FN_STUFF_STR(HOLDER_BANK.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
           ,HOLDER_BANK.CURRENCY_NO        --往來帳戶幣別
           -- 2018.10.18 ChengYu 帳戶保管平台代號 依基金公司代號(AMC_NO)來取
           ,AMC.DEPOSITORY_NO AS DEPOSITORY_NO           --帳戶保管平台代號
      FROM FAS.HOLDER_BANK HOLDER_BANK
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = WFUND_NO
      JOIN FAS.AMC AMC
        ON AMC.AMC_NO = FUND.AMC_NO
     WHERE HOLDER_BANK.ID = XID
       AND HOLDER_BANK.ECS = 'Y'
       -- 2018.09.21 JIANXIN MOD BY 調整買回帳號取得邏輯
       AND (
                (    AMC.AMC_NO != '04' 
                 AND (  HOLDER_BANK.VALID_FROM IS NULL 
                     OR (   HOLDER_BANK.VALID_FROM IS NOT NULL 
                        AND XTX_DATE >= HOLDER_BANK.VALID_FROM
                        )
                     )
                )
                OR 
                (    AMC.AMC_NO = '04' 
                 -- 2019.06.05 tingting 調整買回帳號瑞萬的判斷條件(生效日>=集保生效日 → 集保生效日>=生效日)
                 AND HOLDER_BANK.TDCC_VALID_FROM >= HOLDER_BANK.VALID_FROM
                )
              )       
       AND (HOLDER_BANK.CLOSE_DATE IS NULL OR (HOLDER_BANK.CLOSE_DATE IS NOT NULL AND XTX_DATE < HOLDER_BANK.CLOSE_DATE))
       AND (HOLDER_BANK.FUND_TYPE = 'A' OR HOLDER_BANK.FUND_TYPE = FUND.FUND_TYPE)
       AND (HOLDER_BANK.FUND_CATEGORY = '0' OR HOLDER_BANK.FUND_CATEGORY = FUND.FUND_CATEGORY)
       -- 2021.12.21 Chengyu 修正取不到MMA帳戶問題
       AND ((HOLDER_BANK.CURRENCY_NO = 'MMA') OR (HOLDER_BANK.CURRENCY_NO = 'FCY' AND WTRADE_CRNCY != 'NTD' ) OR (HOLDER_BANK.CURRENCY_NO = WTRADE_CRNCY));

END s_GetRedemAccount;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMACCOUNT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMAMT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMAMT" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/09/25
-- Description: 取得當天網路贖回總金額/總單位數
-- =============================================
(
    WACCOUNT_NO     INTEGER,    -- 受益人戶號
    WTX_DATE        DATE,       -- 交易日期
    OUTDT           OUT SYS_REFCURSOR
) IS

XID                 VARCHAR2(10);     -- 受益人ID

BEGIN
    BEGIN
        -- 取得受益人ID
        SELECT ID
          INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;
        END;


    OPEN OUTDT FOR
        SELECT REDEMPTION.FUND_NO AS FUND_NO
              ,FUND.NAME AS FUND_NAME
              ,FUND.ISIN_CODE AS ISIN_CODE
              ,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY
              ,V_FUND_CRNCY.NAME AS TRADE_CRNCY_NM
              ,FUND.AMT_DECIMAL AS AMT_DECIMAL
              ,FUND.SHARE_DECIMAL AS SHARE_DECIMAL
              ,FUND.NAV_DECIMAL AS NAV_DECIMAL
              ,REDEMPTION.APPLICATION_SHARE AS APPLICATION_SHARE
          FROM ECS.REDEMPTION REDEMPTION
          LEFT JOIN FAS.FUND FUND
            ON FUND.FUND_NO = REDEMPTION.FUND_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
         WHERE REDEMPTION.ID = XID
           AND TX_DATE = WTX_DATE;

END s_GetRedemAmt;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMAMT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/05/21
-- Description: 取得買回委託交易資料
-- 2018.05.31 JIM MOD BY 解開註解傳入參數ROBO_BATCH_NO
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.11.26 JIANXIN MOD BY 新增贖回戶名
-- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
-- 2018.12.10 ChengYu 修正SP傳出條件、基金幣別、基金幣別名稱
-- =============================================
(
    WACCOUNT_NO    VARCHAR2,               -- 受益人戶號
    WFUND_NO       VARCHAR2,               -- 基金代碼
    WTX_DATE       DATE,                   -- 交易日期
    WBROKER_NO     VARCHAR2,               -- 代銷單位
    WBRANCH_NO     VARCHAR2,               -- 代銷分公司碼
    WSER_NO        VARCHAR2,               -- 交易序號
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS

BEGIN

    OPEN OUTDT FOR
         SELECT REDEMPTION.FUND_NO AS FUND_NO
                -- 2018.12.10 ChengYu 修正SP傳出條件、基金幣別、基金幣別名稱
                ,FUND.CURRENCY_NO AS FUND_CURRENCY_NO
                ,FUND_CURRENCY.NAME AS FUND_CURRENCY_NAME
                -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
                ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME
                ,FUND.DIVIDEND_DESC AS FUND_MEMO
                ,FUND.ISIN_CODE AS ISIN_CODE
                ,FUND.SHARE_CLASS AS SHARE_CLASS
                ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME
                ,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY
                ,TRADE_CURRENCY.NAME AS TRADE_CRNCY_NM
                ,REDEMPTION.TX_DATE AS TX_DATE
                ,REDEMPTION.APPLICATION_SHARE AS APPLICATION_SHARE
                ,REDEMPTION.BANK_CURRENCY_NO AS PAY_CRNCY
                ,BANK_CURRENCY.NAME AS PAY_CRNCY_NM
                ,REDEMPTION.AC_DATE AS AC_DATE
                ,REDEMPTION.PAY_DATE AS PAY_DATE
                ,REDEMPTION.AC_BANK AS BANK_NO
                ,REDEMPTION.AC_FIS_SNAME AS FIS_SNAME
                -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
                ,ECS.FN_STUFF_STR(REDEMPTION.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
                -- 2018.11.26 JIANXIN MOD BY 新增贖回戶名
                ,REDEMPTION.AC_NAME
                ,FUND.SHARE_DECIMAL
                ,'B;' || REDEMPTION.FUND_NO || ';' 
                    || TO_CHAR(REDEMPTION.TX_DATE,'yyyymmdd') || ';' || REDEMPTION.BROKER_NO ||
                        ';' || REDEMPTION.BRANCH_NO || ';' || REDEMPTION.SER_NO AS ES_TX_NO
                ,REDEMPTION.ROBO_CONTRACT_NO
                ,REDEMPTION.ROBO_SER_NO
                -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
                ,REDEMPTION.ROBO_BATCH_NO
              FROM ECS.REDEMPTION REDEMPTION
              JOIN FAS.FUND FUND 
                ON FUND.FUND_NO = REDEMPTION.FUND_NO
              LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS 
                ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
               AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
              JOIN ECS.V_FUND_CRNCY BANK_CURRENCY 
                ON BANK_CURRENCY.CURRENCY_NO = REDEMPTION.BANK_CURRENCY_NO
              JOIN ECS.V_FUND_CRNCY TRADE_CURRENCY
                ON TRADE_CURRENCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
              -- 2018.12.10 ChengYu 修正SP傳出條件、基金幣別、基金幣別名稱
              JOIN ECS.V_FUND_CRNCY FUND_CURRENCY
                ON FUND_CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
              JOIN FAS.HOLDER
                ON HOLDER.ID = REDEMPTION.ID
              WHERE REDEMPTION.BROKER_NO = WBROKER_NO 
                AND REDEMPTION.BRANCH_NO = WBRANCH_NO 
                AND REDEMPTION.TX_DATE = TRUNC(WTX_DATE) 
                AND REDEMPTION.FUND_NO = WFUND_NO 
                AND REDEMPTION.SER_NO = WSER_NO
                AND HOLDER.ACCOUNT_NO = WACCOUNT_NO;

END s_GetRedemData;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMFUNDDATA" 
(
    WFUND_NO       VARCHAR2,                  -- 基金代碼
    WRSHARES       DECIMAL,                   -- 可買回單位數
    OUTDT          OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

XIS_EC             VARCHAR2(1);               --開放網路交易
XIS_EC_REDEM       VARCHAR2(1);               --開放網路買回交易
XREDEM_YN          VARCHAR2(1);               --是否可買回
XSWITCH_YN         VARCHAR2(1);               --是否可轉出

BEGIN

    SELECT FUND.IS_EC
           ,FUND.IS_EC_REDEMPTION
           INTO XIS_EC
                ,XIS_EC_REDEM
           FROM FAS.FUND FUND
           WHERE FUND.FUND_NO = WFUND_NO;

    IF WRSHARES = 0 OR XIS_EC = 'N' OR XIS_EC_REDEM = 'N' THEN

      XREDEM_YN := 'N';
      XSWITCH_YN := 'N';

    ELSE

      XREDEM_YN := 'Y';
      XSWITCH_YN := 'Y';

    END IF;

OPEN OUTDT FOR
  SELECT AMC.DEPOSITORY_NO                            --帳戶保管平台代號\01：財金；04：集保
         ,FUND.SHARE_CLASS                            --基金級別
         ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME   --基金級別名稱
         ,RISK_CATEGORY                               --風險屬性
         ,XREDEM_YN AS REDEM_YN                       --是否可買回
         ,XSWITCH_YN AS SWITCH_YN                     --是否可轉出
         FROM FAS.FUND FUND
         JOIN FAS.AMC AMC
           ON AMC.AMC_NO = FUND.AMC_NO
         LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
           ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          -- 2018.05.18 MOD BY JIM 因Table架構更改，多了AMC_NO的KEY  
          AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         WHERE FUND.FUND_NO = WFUND_NO;

END s_GetRedemFundData;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMMINUNIT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMMINUNIT" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/09/27
-- Description: 當部分贖回時，取得最低贖回單位數(含贖回、轉申購)
-- =============================================
(
    WACCOUNT_NO         INTEGER,        -- 受益人戶號
    WFUND_NO            VARCHAR2,       -- 基金代碼
    OUTDT               OUT SYS_REFCURSOR
) IS

XID                     VARCHAR2(10);   -- 受益人ID

BEGIN
     BEGIN
          -- 取得受益人ID
          SELECT ID
            INTO XID
            FROM FAS.HOLDER
           WHERE ACCOUNT_NO = WACCOUNT_NO;
     END;

    OPEN OUTDT FOR
        SELECT MIN_RED_SHARE AS SHARES
              ,SHARE_DECIMAL
          FROM FAS.FUND
         WHERE FUND.FUND_NO = WFUND_NO;



END s_GetRedemMinUnit;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMMINUNIT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMNAVDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMNAVDATE" 
(
    WFUND_NO       VARCHAR2,                  -- 基金代碼
    WTX_DATE       DATE,                      -- 交易日期
    OUTDT          OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

--傳出變數
XNAV_DATE     DATE;                           -- 淨值日
XPAY_DATE     DATE;                           -- 預計買回入帳日期
XIS_SUCCESS   VARCHAR2(1);                    -- 取得資料成功否
XWARNS_TYPE   VARCHAR2(1);                    -- 警示方式
XERROR_MSG    VARCHAR2(250);                  -- 錯誤訊息

--變數
XFUND_CATEGORY  VARCHAR2(1);                  -- 境內外識別碼
XNAV_CALENDAR   VARCHAR2(5);                  -- 淨值日行事曆類別
XTX_CALENDAR    VARCHAR2(5);                  -- 交易日行事曆類別
XPAY_CALENDAR   VARCHAR2(2);                  -- 付款日行事曆類別
XRED_NAV_DAY    INTEGER;                      -- 買回淨值日參數
XPAY_DAY        INTEGER;                      -- 買回付款日參數
XDEPOSITORY_NO  VARCHAR2(2);                  -- 帳戶保管平台代號
XTX_DATE        DATE;                         -- 交易日期
XPRE_TX_DATE    DATE;                         -- 買回交易前置日
XPRE_PAY_DATE   DATE;                         -- 付款前置日
XCHECK_VALUE    VARCHAR2(5);                  -- 檢查是否有資料
XCHECK_BUS      INTEGER;                      -- 檢查是否為營業日

BEGIN

  --從FAS.FUND、FAS.AMC取得基本資料
  SELECT FUND.FUND_CATEGORY                 -- 境內外識別碼
         ,FUND.CALENDAR_CODE                -- 淨值日行事曆類別
         ,FUND.TX_CALENDAR_CODE             -- 交易日行事曆類別
         ,SUBSTR(FUND.CURRENCY_NO,1,2)      -- 付款日行事曆類別
         ,FUND.RED_NAV_DAY                  -- 買回淨值日參數
         ,FUND.PAY_DAY                      -- 買回付款日參數
         ,AMC.DEPOSITORY_NO                 -- 帳戶保管平台代號
         INTO
         XFUND_CATEGORY
         ,XNAV_CALENDAR
         ,XTX_CALENDAR
         ,XPAY_CALENDAR
         ,XRED_NAV_DAY
         ,XPAY_DAY
         ,XDEPOSITORY_NO
    FROM FAS.FUND FUND
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
    WHERE FUND.FUND_NO = WFUND_NO;

  --例外處理狀況
  --1.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T005
  BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XNAV_CALENDAR;
  EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
  END;

  -- 2018.05.14 Mod By Jim 修改狀況意外處理(修改為只有境外才需要使用的值)
  IF XFUND_CATEGORY = '2' THEN

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
       INTO XCHECK_VALUE
       FROM FAS.CALENDAR
      WHERE CALENDAR_CODE = XPAY_CALENDAR;

    EXCEPTION
       WHEN NO_DATA_FOUND THEN
         XIS_SUCCESS := 'N';

         SELECT MSGTYPE, MSGCONTENT
           INTO XWARNS_TYPE, XERROR_MSG
           FROM ECS.MSGINFO
          WHERE MSGID = 'T005';

         GOTO TO_END;
      END;

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XTX_CALENDAR;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
    END;

  ELSE 

    XCHECK_VALUE := ''; 

  END IF ; 

  XTX_DATE := TO_DATE(TO_CHAR(WTX_DATE,'YYYY/MM/DD'),'YYYY/MM/DD'); --將系統日期轉化成YYYY/MM/DD格式

  --淨值日(XNAV_DATE) ：以傳入參數『交易日期(XTX_DATE)』加上『買回淨值日參數(XRED_NAV_DAY)』推算
  XNAV_DATE := XTX_DATE;
  WHILE XRED_NAV_DAY > 0
   LOOP

    XNAV_DATE := XNAV_DATE+1;

    --判斷營業日+1是否為假日
    SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XNAV_DATE
         AND CALENDAR_CODE = XNAV_CALENDAR;

    --不是假日，付款日數-1
    IF XCHECK_BUS = 0 THEN
      XRED_NAV_DAY := XRED_NAV_DAY-1;

    --是假日，繼續往下+1找，直接找到營業日
    ELSE
      WHILE XCHECK_BUS = 1
        LOOP

        XNAV_DATE := XNAV_DATE+1;

         SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XNAV_DATE
             AND CALENDAR_CODE = XNAV_CALENDAR;

        END LOOP;

      --不是假日，付款日數-1
      XRED_NAV_DAY := XRED_NAV_DAY-1;

    END IF;
  END LOOP;

  --若『境內外識別碼(XFUND_CATEGORY) 』為”1.境內”時
  --付款日(XPAY_DATE) ：以傳入參數『交易日期(XTX_DATE)』加上『買回付款日參數(XPAY_DAY)』推算
  IF XFUND_CATEGORY = '1' THEN

    XPAY_DATE := XTX_DATE;

    WHILE XPAY_DAY > 0
     LOOP

      XPAY_DATE := XPAY_DATE+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPAY_DATE
           AND CALENDAR_CODE = XNAV_CALENDAR;

      --不是假日，付款日數-1
      IF XCHECK_BUS = 0 THEN
        XPAY_DAY := XPAY_DAY-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS = 1
          LOOP

          XPAY_DATE := XPAY_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPAY_DATE
               AND CALENDAR_CODE = XNAV_CALENDAR;

          END LOOP;

        --不是假日，付款日數-1
        XPAY_DAY := XPAY_DAY-1;

      END IF;

    END LOOP;

  END IF;

  --若『境內外識別碼(@FUND_CATEGORY) 』為” 2.境外”時，以下述規則取得
  IF XFUND_CATEGORY = '2' THEN

    XPRE_TX_DATE := XTX_DATE;

    --判斷買回交易前置日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS
        FROM FAS.CALENDAR
        WHERE HOLIDAY = XPRE_TX_DATE
          AND CALENDAR_CODE IN (XNAV_CALENDAR, XPAY_CALENDAR);

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS = 1
          LOOP

          XPRE_TX_DATE := XPRE_TX_DATE-1;

          SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XPRE_TX_DATE
             AND CALENDAR_CODE IN (XNAV_CALENDAR, XPAY_CALENDAR);

          END LOOP;


    XPRE_PAY_DATE := XPRE_TX_DATE;

    --付款前置日(XPRE_PAY_DATE)：以『買回交易前置日(XPRE_TX_DATE)』加上『買回付款日參數(XPAY_DAY)』推算
	-- 2018.11.15 yunchu 調整境外基金預計買回付款日
    WHILE XPAY_DAY >= 0
     LOOP

      XPRE_PAY_DATE := XPRE_PAY_DATE+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPRE_PAY_DATE
           AND CALENDAR_CODE = XNAV_CALENDAR;

      --不是假日，買回付款日參數-1
      IF XCHECK_BUS = 0 THEN
        XPAY_DAY := XPAY_DAY-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS = 1
          LOOP

          XPRE_PAY_DATE := XPRE_PAY_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPRE_PAY_DATE
               AND CALENDAR_CODE = XNAV_CALENDAR;

          END LOOP;

        --不是假日，買回付款日參數-1
        XPAY_DAY := XPAY_DAY-1;

      END IF;
    END LOOP;

    XPAY_DATE := XPRE_PAY_DATE-1;

    --判斷付款日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPAY_DATE
        AND CALENDAR_CODE = XTX_CALENDAR;

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS = 1
     LOOP

      XPAY_DATE := XPAY_DATE-1;

      SELECT COUNT(HOLIDAY)
       INTO XCHECK_BUS
       FROM FAS.CALENDAR
      WHERE HOLIDAY = XPAY_DATE
        AND CALENDAR_CODE = XTX_CALENDAR;

     END LOOP;

  END IF;

  XIS_SUCCESS := 'Y';
  XWARNS_TYPE := '';
  XERROR_MSG  := '';

  GOTO TO_END;

  <<TO_END>>

  OPEN OUTDT FOR
   SELECT CASE WHEN XIS_SUCCESS = 'Y' THEN XNAV_DATE
               WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END AC_DATE
          ,CASE WHEN XIS_SUCCESS = 'Y' THEN XPAY_DATE
                WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END PAY_DATE
          ,CASE WHEN XIS_SUCCESS = 'Y' THEN
                    CASE WHEN XFUND_CATEGORY = '2' AND XDEPOSITORY_NO = '04' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
                         ELSE XPAY_DATE END
                WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END PAY_DATE_SHOW
          ,XIS_SUCCESS AS IS_SUCCESS
          ,XWARNS_TYPE AS WARNS_TYPE
          ,XERROR_MSG AS ERROR_MSG
       FROM DUAL;

END s_GetRedemNavDate;

/

  GRANT EXECUTE ON "ECS"."S_GETREDEMNAVDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREDEMNAVDATE_CHECK
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREDEMNAVDATE_CHECK" 
(
    WFUND_NO       VARCHAR2,                  -- 基金代碼
    WTX_DATE       DATE                       -- 交易日期
) IS

--改後傳出變數
XNAV_DATE     DATE;                           -- 淨值日
XPAY_DATE     DATE;                           -- 預計買回入帳日期
XIS_SUCCESS   VARCHAR2(1);                    -- 取得資料成功否
XWARNS_TYPE   VARCHAR2(1);                    -- 警示方式
XERROR_MSG    VARCHAR2(250);                  -- 錯誤訊息

--改後變數
XFUND_CATEGORY  VARCHAR2(1);                  -- 境內外識別碼
XNAV_CALENDAR   VARCHAR2(5);                  -- 淨值日行事曆類別
XTX_CALENDAR    VARCHAR2(5);                  -- 交易日行事曆類別
XPAY_CALENDAR   VARCHAR2(2);                  -- 付款日行事曆類別
XRED_NAV_DAY    INTEGER;                      -- 買回淨值日參數
XPAY_DAY        INTEGER;                      -- 買回付款日參數
XDEPOSITORY_NO  VARCHAR2(2);                  -- 帳戶保管平台代號
XTX_DATE        DATE;                         -- 交易日期
XPRE_TX_DATE    DATE;                         -- 買回交易前置日
XPRE_PAY_DATE   DATE;                         -- 付款前置日
XCHECK_VALUE    VARCHAR2(5);                  -- 檢查是否有資料
XCHECK_BUS      INTEGER;                      -- 檢查是否為營業日
XFUND_NAME      VARCHAR2(500);

--原始傳出變數
XNAV_DATE_original     DATE;                           -- 淨值日
XPAY_DATE_original     DATE;                           -- 預計買回入帳日期
XIS_SUCCESS_original   VARCHAR2(1);                    -- 取得資料成功否
XWARNS_TYPE_original   VARCHAR2(1);                    -- 警示方式
XERROR_MSG_original    VARCHAR2(250);                  -- 錯誤訊息

--原始變數
XFUND_CATEGORY_original  VARCHAR2(1);                  -- 境內外識別碼
XNAV_CALENDAR_original   VARCHAR2(5);                  -- 淨值日行事曆類別
XTX_CALENDAR_original    VARCHAR2(5);                  -- 交易日行事曆類別
XPAY_CALENDAR_original   VARCHAR2(2);                  -- 付款日行事曆類別
XRED_NAV_DAY_original    INTEGER;                      -- 買回淨值日參數
XPAY_DAY_original        INTEGER;                      -- 買回付款日參數
XDEPOSITORY_NO_original  VARCHAR2(2);                  -- 帳戶保管平台代號
XTX_DATE_original        DATE;                         -- 交易日期
XPRE_TX_DATE_original    DATE;                         -- 買回交易前置日
XPRE_PAY_DATE_original   DATE;                         -- 付款前置日
XCHECK_VALUE_original    VARCHAR2(5);                  -- 檢查是否有資料
XCHECK_BUS_original      INTEGER;                      -- 檢查是否為營業日

BEGIN

  --從FAS.FUND、FAS.AMC取得基本資料
  SELECT FUND.FUND_CATEGORY                 -- 境內外識別碼
         ,FUND.CALENDAR_CODE                -- 淨值日行事曆類別
         ,FUND.TX_CALENDAR_CODE             -- 交易日行事曆類別
         ,SUBSTR(FUND.CURRENCY_NO,1,2)      -- 付款日行事曆類別
         ,FUND.RED_NAV_DAY                  -- 買回淨值日參數
         ,FUND.PAY_DAY                      -- 買回付款日參數
         ,AMC.DEPOSITORY_NO                 -- 帳戶保管平台代號
         ,FUND.NAME
         INTO
         XFUND_CATEGORY
         ,XNAV_CALENDAR
         ,XTX_CALENDAR
         ,XPAY_CALENDAR
         ,XRED_NAV_DAY
         ,XPAY_DAY
         ,XDEPOSITORY_NO
         ,XFUND_NAME
    FROM FAS.FUND FUND
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
    WHERE FUND.FUND_NO = WFUND_NO;

  --例外處理狀況
  --1.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T005
  BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XNAV_CALENDAR;
  EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
  END;

  -- 2018.05.14 Mod By Jim 修改狀況意外處理(修改為只有境外才需要使用的值)
  IF XFUND_CATEGORY = '2' THEN

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
       INTO XCHECK_VALUE
       FROM FAS.CALENDAR
      WHERE CALENDAR_CODE = XPAY_CALENDAR;

    EXCEPTION
       WHEN NO_DATA_FOUND THEN
         XIS_SUCCESS := 'N';

         SELECT MSGTYPE, MSGCONTENT
           INTO XWARNS_TYPE, XERROR_MSG
           FROM ECS.MSGINFO
          WHERE MSGID = 'T005';

         GOTO TO_END;
      END;

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XTX_CALENDAR;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
    END;

  ELSE

    XCHECK_VALUE := '';

  END IF ;

  XTX_DATE := TO_DATE(TO_CHAR(WTX_DATE,'YYYY/MM/DD'),'YYYY/MM/DD'); --將系統日期轉化成YYYY/MM/DD格式

  --淨值日(XNAV_DATE) ：以傳入參數『交易日期(XTX_DATE)』加上『買回淨值日參數(XRED_NAV_DAY)』推算
  XNAV_DATE := XTX_DATE;
  WHILE XRED_NAV_DAY > 0
   LOOP

    XNAV_DATE := XNAV_DATE+1;

    --判斷營業日+1是否為假日
    SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XNAV_DATE
         AND CALENDAR_CODE = XNAV_CALENDAR;

    --不是假日，付款日數-1
    IF XCHECK_BUS = 0 THEN
      XRED_NAV_DAY := XRED_NAV_DAY-1;

    --是假日，繼續往下+1找，直接找到營業日
    ELSE
      WHILE XCHECK_BUS = 1
        LOOP

        XNAV_DATE := XNAV_DATE+1;

         SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XNAV_DATE
             AND CALENDAR_CODE = XNAV_CALENDAR;

        END LOOP;

      --不是假日，付款日數-1
      XRED_NAV_DAY := XRED_NAV_DAY-1;

    END IF;
  END LOOP;

  --若『境內外識別碼(XFUND_CATEGORY) 』為”1.境內”時
  --付款日(XPAY_DATE) ：以傳入參數『交易日期(XTX_DATE)』加上『買回付款日參數(XPAY_DAY)』推算
  IF XFUND_CATEGORY = '1' THEN

    XPAY_DATE := XTX_DATE;

    WHILE XPAY_DAY > 0
     LOOP

      XPAY_DATE := XPAY_DATE+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPAY_DATE
           AND CALENDAR_CODE = XNAV_CALENDAR;

      --不是假日，付款日數-1
      IF XCHECK_BUS = 0 THEN
        XPAY_DAY := XPAY_DAY-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS = 1
          LOOP

          XPAY_DATE := XPAY_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPAY_DATE
               AND CALENDAR_CODE = XNAV_CALENDAR;

          END LOOP;

        --不是假日，付款日數-1
        XPAY_DAY := XPAY_DAY-1;

      END IF;

    END LOOP;

  END IF;

  --若『境內外識別碼(@FUND_CATEGORY) 』為” 2.境外”時，以下述規則取得
  IF XFUND_CATEGORY = '2' THEN

    XPRE_TX_DATE := XTX_DATE;

    --判斷買回交易前置日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS
        FROM FAS.CALENDAR
        WHERE HOLIDAY = XPRE_TX_DATE
          -- 2019.10.22 ChengYu 調整境外基金預計買回付款日取法
          AND CALENDAR_CODE = XNAV_CALENDAR;

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS = 1
          LOOP

          XPRE_TX_DATE := XPRE_TX_DATE-1;

          SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XPRE_TX_DATE
             -- 2019.10.22 ChengYu 調整境外基金預計買回付款日取法
             AND CALENDAR_CODE = XNAV_CALENDAR;

          END LOOP;

    XPRE_PAY_DATE := XPRE_TX_DATE;

    --付款前置日(XPRE_PAY_DATE)：以『買回交易前置日(XPRE_TX_DATE)』加上『買回付款日參數(XPAY_DAY)』推算
    -- 2018.11.15 yunchu 調整境外基金預計買回付款日
    -- 2019.10.22 ChengYu 調整境外基金預計買回付款日取法
    WHILE XPAY_DAY > 0
     LOOP

      XPRE_PAY_DATE := XPRE_PAY_DATE+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPRE_PAY_DATE
           AND CALENDAR_CODE = XNAV_CALENDAR;

      --不是假日，買回付款日參數-1
      IF XCHECK_BUS = 0 THEN
        XPAY_DAY := XPAY_DAY-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS = 1
          LOOP

          XPRE_PAY_DATE := XPRE_PAY_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPRE_PAY_DATE
               AND CALENDAR_CODE = XNAV_CALENDAR;

          END LOOP;

        --不是假日，買回付款日參數-1
        XPAY_DAY := XPAY_DAY-1;

      END IF;      
    END LOOP;

    /*
    XPAY_DATE := XPRE_PAY_DATE-1;

    --判斷付款日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPAY_DATE
        AND CALENDAR_CODE = XTX_CALENDAR;

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS = 1
     LOOP

      XPAY_DATE := XPAY_DATE-1;

      SELECT COUNT(HOLIDAY)
       INTO XCHECK_BUS
       FROM FAS.CALENDAR
      WHERE HOLIDAY = XPAY_DATE
        AND CALENDAR_CODE = XTX_CALENDAR;

     END LOOP;  
     */

    --國內付款日 = 國外付款日
    -- 2019.10.22 ChengYu 調整境外基金預計買回付款日取法
    XPAY_DATE := XPRE_PAY_DATE;

  END IF;

  XIS_SUCCESS := 'Y';
  XWARNS_TYPE := '';
  XERROR_MSG  := '';  

  /*
  GOTO TO_END;

  <<TO_END>>

  OPEN OUTDT FOR
   SELECT CASE WHEN XIS_SUCCESS = 'Y' THEN XNAV_DATE
               WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END AC_DATE
          ,CASE WHEN XIS_SUCCESS = 'Y' THEN XPAY_DATE
                WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END PAY_DATE
          ,CASE WHEN XIS_SUCCESS = 'Y' THEN
                    CASE WHEN XFUND_CATEGORY = '2' AND XDEPOSITORY_NO = '04' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
                         ELSE XPAY_DATE END
                WHEN XIS_SUCCESS = 'N' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
          END PAY_DATE_SHOW
          ,XIS_SUCCESS AS IS_SUCCESS
          ,XWARNS_TYPE AS WARNS_TYPE
          ,XERROR_MSG AS ERROR_MSG
       FROM DUAL;
  */

------------------------------------------------------------上為改後SP，下為原始SP------------------------------------------------------------

--從FAS.FUND、FAS.AMC取得基本資料
  SELECT FUND.FUND_CATEGORY                 -- 境內外識別碼
         ,FUND.CALENDAR_CODE                -- 淨值日行事曆類別
         ,FUND.TX_CALENDAR_CODE             -- 交易日行事曆類別
         ,SUBSTR(FUND.CURRENCY_NO,1,2)      -- 付款日行事曆類別
         ,FUND.RED_NAV_DAY                  -- 買回淨值日參數
         ,FUND.PAY_DAY                      -- 買回付款日參數
         ,AMC.DEPOSITORY_NO                 -- 帳戶保管平台代號
         INTO
         XFUND_CATEGORY_original
         ,XNAV_CALENDAR_original
         ,XTX_CALENDAR_original
         ,XPAY_CALENDAR_original
         ,XRED_NAV_DAY_original
         ,XPAY_DAY_original
         ,XDEPOSITORY_NO_original
    FROM FAS.FUND FUND
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
    WHERE FUND.FUND_NO = WFUND_NO;

  --例外處理狀況
  --1.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T005
  BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE_original
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XNAV_CALENDAR_original;
  EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS_original := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE_original, XERROR_MSG_original
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
  END;

  -- 2018.05.14 Mod By Jim 修改狀況意外處理(修改為只有境外才需要使用的值)
  IF XFUND_CATEGORY_original = '2' THEN

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
       INTO XCHECK_VALUE_original
       FROM FAS.CALENDAR
      WHERE CALENDAR_CODE = XPAY_CALENDAR_original;

    EXCEPTION
       WHEN NO_DATA_FOUND THEN
         XIS_SUCCESS_original := 'N';

         SELECT MSGTYPE, MSGCONTENT
           INTO XWARNS_TYPE_original, XERROR_MSG_original
           FROM ECS.MSGINFO
          WHERE MSGID = 'T005';

         GOTO TO_END;
      END;

    BEGIN

      SELECT DISTINCT CALENDAR_CODE
      INTO XCHECK_VALUE_original
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = XTX_CALENDAR_original;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          XIS_SUCCESS_original := 'N';

          SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE_original, XERROR_MSG_original
            FROM ECS.MSGINFO
           WHERE MSGID = 'T005';

          GOTO TO_END;
    END;

  ELSE 

    XCHECK_VALUE_original := ''; 

  END IF ; 

  XTX_DATE_original := TO_DATE(TO_CHAR(WTX_DATE,'YYYY/MM/DD'),'YYYY/MM/DD'); --將系統日期轉化成YYYY/MM/DD格式

  --淨值日(XNAV_DATE_original) ：以傳入參數『交易日期(XTX_DATE_original)』加上『買回淨值日參數(XRED_NAV_DAY_original)』推算
  XNAV_DATE_original := XTX_DATE_original;
  WHILE XRED_NAV_DAY_original > 0
   LOOP

    XNAV_DATE_original := XNAV_DATE_original+1;

    --判斷營業日+1是否為假日
    SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS_original
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XNAV_DATE_original
         AND CALENDAR_CODE = XNAV_CALENDAR_original;

    --不是假日，付款日數-1
    IF XCHECK_BUS_original = 0 THEN
      XRED_NAV_DAY_original := XRED_NAV_DAY_original-1;

    --是假日，繼續往下+1找，直接找到營業日
    ELSE
      WHILE XCHECK_BUS_original = 1
        LOOP

        XNAV_DATE_original := XNAV_DATE_original+1;

         SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS_original
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XNAV_DATE_original
             AND CALENDAR_CODE = XNAV_CALENDAR_original;

        END LOOP;

      --不是假日，付款日數-1
      XRED_NAV_DAY_original := XRED_NAV_DAY_original-1;

    END IF;
  END LOOP;

  --若『境內外識別碼(XFUND_CATEGORY_original) 』為”1.境內”時
  --付款日(XPAY_DATE_original) ：以傳入參數『交易日期(XTX_DATE_original)』加上『買回付款日參數(XPAY_DAY_original)』推算
  IF XFUND_CATEGORY_original = '1' THEN

    XPAY_DATE_original := XTX_DATE_original;

    WHILE XPAY_DAY_original > 0
     LOOP

      XPAY_DATE_original := XPAY_DATE_original+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS_original
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPAY_DATE_original
           AND CALENDAR_CODE = XNAV_CALENDAR_original;

      --不是假日，付款日數-1
      IF XCHECK_BUS_original = 0 THEN
        XPAY_DAY_original := XPAY_DAY_original-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS_original = 1
          LOOP

          XPAY_DATE_original := XPAY_DATE_original+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS_original
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPAY_DATE_original
               AND CALENDAR_CODE = XNAV_CALENDAR_original;

          END LOOP;

        --不是假日，付款日數-1
        XPAY_DAY_original := XPAY_DAY_original-1;

      END IF;

    END LOOP;

  END IF;

  --若『境內外識別碼(@FUND_CATEGORY) 』為” 2.境外”時，以下述規則取得
  IF XFUND_CATEGORY_original = '2' THEN

    XPRE_TX_DATE_original := XTX_DATE_original;

    --判斷買回交易前置日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS_original
        FROM FAS.CALENDAR
        WHERE HOLIDAY = XPRE_TX_DATE_original
          AND CALENDAR_CODE IN (XNAV_CALENDAR_original, XPAY_CALENDAR_original);

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS_original = 1
          LOOP

          XPRE_TX_DATE_original := XPRE_TX_DATE_original-1;

          SELECT COUNT(HOLIDAY)
             INTO XCHECK_BUS_original
             FROM FAS.CALENDAR
            WHERE HOLIDAY = XPRE_TX_DATE_original
             AND CALENDAR_CODE IN (XNAV_CALENDAR_original, XPAY_CALENDAR_original);

          END LOOP;


    XPRE_PAY_DATE_original := XPRE_TX_DATE_original;

    --付款前置日(XPRE_PAY_DATE_original)：以『買回交易前置日(XPRE_TX_DATE_original)』加上『買回付款日參數(XPAY_DAY_original)』推算
  -- 2018.11.15 yunchu 調整境外基金預計買回付款日
    WHILE XPAY_DAY_original >= 0
     LOOP

      XPRE_PAY_DATE_original := XPRE_PAY_DATE_original+1;

      --判斷營業日+1是否為假日
      SELECT COUNT(HOLIDAY)
           INTO XCHECK_BUS_original
           FROM FAS.CALENDAR
          WHERE HOLIDAY = XPRE_PAY_DATE_original
           AND CALENDAR_CODE = XNAV_CALENDAR_original;

      --不是假日，買回付款日參數-1
      IF XCHECK_BUS_original = 0 THEN
        XPAY_DAY_original := XPAY_DAY_original-1;

      --是假日，繼續往下+1找，直接找到營業日
      ELSE
        WHILE XCHECK_BUS_original = 1
          LOOP

          XPRE_PAY_DATE_original := XPRE_PAY_DATE_original+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS_original
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XPRE_PAY_DATE_original
               AND CALENDAR_CODE = XNAV_CALENDAR_original;

          END LOOP;

        --不是假日，買回付款日參數-1
        XPAY_DAY_original := XPAY_DAY_original-1;

      END IF;
    END LOOP;

    XPAY_DATE_original := XPRE_PAY_DATE_original-1;

    --判斷付款日是否為假日
    SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS_original
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPAY_DATE_original
        AND CALENDAR_CODE = XTX_CALENDAR_original;

    --是假日，繼續往下-1找，直接找到營業日
    WHILE XCHECK_BUS_original = 1
     LOOP

      XPAY_DATE_original := XPAY_DATE_original-1;

      SELECT COUNT(HOLIDAY)
       INTO XCHECK_BUS_original
       FROM FAS.CALENDAR
      WHERE HOLIDAY = XPAY_DATE_original
        AND CALENDAR_CODE = XTX_CALENDAR_original; 

     END LOOP;

  END IF;

  XIS_SUCCESS_original := 'Y';
  XWARNS_TYPE_original := '';
  XERROR_MSG_original  := '';

  GOTO TO_END;

  <<TO_END>>

  dbms_output.put_line(WFUND_NO||','||XFUND_NAME||','||TO_CHAR(XTX_DATE_original,'YYYY/MM/DD')||','||TO_CHAR(XTX_DATE,'YYYY/MM/DD')||
                       ','||TO_CHAR(XNAV_DATE_original,'YYYY/MM/DD')||','||TO_CHAR(XNAV_DATE,'YYYY/MM/DD')||
                       ','||TO_CHAR(XPAY_DATE_original,'YYYY/MM/DD')||','||TO_CHAR(XPAY_DATE,'YYYY/MM/DD'));

END s_GetRedemNavDate_check;

/
--------------------------------------------------------
--  DDL for Procedure S_GETREWARDPOINT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREWARDPOINT" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2019/07/11
-- Description: 取得該次交易折扣的紅利點數
-- =============================================
(
      WFUND_NO          VARCHAR2                   -- 基金代碼
    , WTX_CURRENCY_NO   VARCHAR2                   -- 申購幣別
    , WSERVICE_CHARGE   DECIMAL                    -- 申購手續費
    , WUSED_POINT       DECIMAL                    -- 目前剩餘紅利點數
    , OUTDT             OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA(銀行列表)        
) IS

XREWARD_POINT         DECIMAL(18,6);  -- 本次使用紅利點數
XMAX_SERVICE_CHARGE   DECIMAL(18,6);  -- 本次最大扣抵手續費
XSERVICE_CHARGE       DECIMAL(18,6);  -- 本次手續費
XAMT_DECIMAL          INT;

BEGIN

    -- 取得交易幣別小數位數
    SELECT AMT_DECIMAL 
      INTO XAMT_DECIMAL
      FROM ECS.V_FUND_CRNCY V_FUND_CRNCY
     WHERE V_FUND_CRNCY.CURRENCY_NO = WTX_CURRENCY_NO;

  dbms_output.put_line('交易幣別小數位數：' || TO_CHAR(XAMT_DECIMAL));

     -- 最多折抵金額
     SELECT FLOOR(WUSED_POINT / REWARD_CHANGE.REWARD_POINT)
       INTO XMAX_SERVICE_CHARGE
       FROM ECS.REWARD_CHANGE
      WHERE REWARD_CHANGE.CURRENCY_NO = WTX_CURRENCY_NO; 

  dbms_output.put_line('最多折抵金額：' || TO_CHAR(XMAX_SERVICE_CHARGE));

    SELECT CASE WHEN WSERVICE_CHARGE - XMAX_SERVICE_CHARGE > 0 THEN WSERVICE_CHARGE - XMAX_SERVICE_CHARGE 
                ELSE 0 END AS SERVICE_CHARGE -- 本次剩餘手續費
           , ROUND( CASE WHEN WSERVICE_CHARGE - XMAX_SERVICE_CHARGE > 0 THEN XMAX_SERVICE_CHARGE 
                         ELSE WSERVICE_CHARGE END * REWARD_CHANGE.REWARD_POINT ) AS REWARD_POINT  -- 本次折扣點數
      INTO XSERVICE_CHARGE , XREWARD_POINT
      FROM ECS.REWARD_CHANGE
     WHERE REWARD_CHANGE.CURRENCY_NO = WTX_CURRENCY_NO;

  dbms_output.put_line('本次剩餘手續費：' || TO_CHAR(XSERVICE_CHARGE));
  dbms_output.put_line('本次折扣點數：' || TO_CHAR(XREWARD_POINT));

    OPEN OUTDT FOR    
    SELECT   XREWARD_POINT  AS  REWARD_POINT    --手續費需折扣的紅利點數
           , XSERVICE_CHARGE AS SERVICE_CHARGE  --剩餘申購手續費
      FROM DUAL;

END s_GetRewardPoint;

/

  GRANT EXECUTE ON "ECS"."S_GETREWARDPOINT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETREWARDPOINTDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETREWARDPOINTDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/04/10
-- Description: 取得紅利積點資料
-- 2018.04.10 Jim 修改搜尋條件
-- 2018.10.12 JINAXIN 調整紅利積點寫法
-- 2018.11.01 JIANXIN 調整紅利積點使用點數顯示
-- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
-- 2018.11.07 tingting 調整排序
-- 2018.11.09 tingting 調整紅利點數使用列表，取一年內資料的判斷方式(4點後交易，交易日期會是未來日)
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- =============================================
(
    WACCOUNT_NO         INTEGER,            -- 受益人戶號
    WTX_DATE            DATE,               -- 交易日期
    OUTDT               OUT SYS_REFCURSOR,  -- 取得紅利點數持有列表
    OUTDT2              OUT SYS_REFCURSOR   -- 紅利點數使用列表
) IS

    XQUERY_DATE         DATE;               -- 查詢日期
    XID                 VARCHAR2(10);       -- 受益人ID

BEGIN

    --取得受益人ID
    BEGIN

        SELECT ID INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    -- 取得查詢日期
    IF WTX_DATE <= TO_DATE('1900/01/01','YYYY/MM/DD') THEN

        XQUERY_DATE := TRUNC(SYSDATE);

    ELSE  

        XQUERY_DATE := WTX_DATE;

    END IF;

    -- 取得紅利點數持有列表
    -- 2018.10.12 JINAXIN 調整紅利積點寫法
    OPEN OUTDT FOR
    SELECT  REWARD_POINT.PROGRAM_NO                                            --活動編號
           ,REWARD_POINT.REWARD_NO                                             --紅利編號
           ,REWARD_PROGRAM.NAME AS PROGRAM_NAME                                --活動名稱
           ,REWARD_POINT.ISSUE_DATE                                            --配發日期
           ,REWARD_POINT.VALID_THRU                                            --截止日
           -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
           ,REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) AS REWARD_POINT     --可使用紅利點數(紅利點數 - 使用點數 - 預扣點數)
      FROM FAS.REWARD_POINT
      -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
      LEFT JOIN (
            -- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
            --還沒真正被使用的預扣點數
            SELECT  REWARD_POINT.REWARD_NO
                   ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
              FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
              JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
                ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
               AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
              JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
                ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
             WHERE REWARD_HISTORY.ID = XID
               AND REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
             GROUP BY REWARD_POINT.REWARD_NO
             ORDER BY REWARD_POINT.REWARD_NO
           ) REWARD_POINT_W         --紅利配發資料(預扣)
        ON REWARD_POINT_W.REWARD_NO = REWARD_POINT.REWARD_NO
      JOIN FAS.REWARD_PROGRAM REWARD_PROGRAM
        ON REWARD_PROGRAM.PROGRAM_NO = REWARD_POINT.PROGRAM_NO
     WHERE REWARD_POINT.ID = XID
       AND REWARD_POINT.VALID_FROM <= XQUERY_DATE
       AND REWARD_POINT.VALID_THRU >= XQUERY_DATE
       -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
       AND REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) > 0
     -- 2018.11.07 tingting 調整排序
     ORDER BY REWARD_POINT.VALID_THRU, REWARD_POINT.PROGRAM_NO;       

    -- 紅利點數使用列表
    -- 2018.10.12 JINAXIN 調整紅利積點寫法
    OPEN OUTDT2 FOR       
    SELECT  REWARD_HISTORY.TX_DATE AS TX_DATE                      --使用日期 
           ,REWARD_POINT.PROGRAM_NO AS PROGRAM_NO                  --活動代碼
           ,REWARD_PROGRAM.NAME AS PROGRAM_NAME                    --活動名稱
           ,CASE WHEN REWARD_HISTORY.USE_TYPE = '1' THEN '單筆申購'
                 WHEN REWARD_HISTORY.USE_TYPE = '2' THEN '轉申購'
                 ELSE ''
                 END AS TX_TYPE                                    --使用交易別
           -- 2018.11.01 JIANXIN 調整紅利積點使用點數顯示
           ,REWARD_DETAILS.USED_POINT AS USED_POINT                --使用點數
           ,REWARD_HISTORY.TX_TYPE AS POINT_TYPE                   --點數使用種類
      FROM FAS.REWARD_HISTORY REWARD_HISTORY
      JOIN FAS.REWARD_DETAILS REWARD_DETAILS
        ON FAS.REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
       AND REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
      JOIN FAS.REWARD_POINT REWARD_POINT
        ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
      JOIN FAS.REWARD_PROGRAM REWARD_PROGRAM
        ON REWARD_PROGRAM.PROGRAM_NO = REWARD_POINT.PROGRAM_NO
     WHERE REWARD_HISTORY.ID = XID
       AND REWARD_HISTORY.TX_TYPE IN ('U','W')          --交易類別 C：新增 W：預扣 U：使用
       -- 2018.11.09 tingting 調整紅利點數使用列表，取一年內資料的判斷方式(4點後交易，交易日期會是未來日）
       --AND REWARD_HISTORY.TX_DATE <= XQUERY_DATE
       --AND MONTHS_BETWEEN(XQUERY_DATE,REWARD_HISTORY.TX_DATE) <= 12
       --AND MONTHS_BETWEEN(XQUERY_DATE,REWARD_HISTORY.TX_DATE) >= 0
       AND REWARD_HISTORY.TX_DATE >= ADD_MONTHS(XQUERY_DATE,-12)    --取一年內資料
     -- 2018.11.07 tingting 調整排序
     ORDER BY REWARD_HISTORY.TX_DATE DESC, REWARD_POINT.PROGRAM_NO;

END s_GetRewardPointData;

/

  GRANT EXECUTE ON "ECS"."S_GETREWARDPOINTDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETROBOBMSDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETROBOBMSDATA" 
-- =============================================
-- Author:      Jianxin
-- Create date: 2018/06/26
-- Description: 取得Robo 投資組合總覽
-- 2018.06.29 JIANXIN MOD BY Robo 契約書號調整為 IS NOT NULL
-- 2018.07.02 tingting INSERT INTO 指定欄位
-- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
-- 2018.07.17 ChengYu 新增欄位AML_STATUS(帳戶狀態),ROBO_AGREEMENT(ROBO同意書),IS_EMP(是否為員工員眷),VULNERABLE_GROUP(是否為弱勢族群)
-- 2018.07.19 ChengYu 新增欄位 KYC 是否有效(KYC_EFFECTIVE)
-- 2018.08.01 yunchu 調整幣別改取V_TX_CURRENCY
-- 2018.08.29 JIANXIN MOD 可買回單位數新增ROBO契約書號參數
-- 2018.09.26 ChengYu 新增欄位 基金風險屬性
-- 2018.10.04 YungLong 新增傳出欄位「出生日期」
-- 2018.10.25 JIANXIN 弱勢族群判斷調整
-- 2018.10.25 JIANXIN KYC 等級判斷調整
-- 2018.10.26 JIANXIN 新增年齡欄位
-- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
-- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶
-- 2018.12.24 JIANXIN 弱勢族群判斷 20 歲以下不是弱勢族群
-- 2018.12.24 JIANXIN 因緊急上版先行移除【調整未開戶完成者，視為查詢戶】
-- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶 恢復
-- 2019.01.03 tingting 移除【調整未開戶完成者，視為查詢戶】
-- 2019.01.04 JIANXIN 調整ROBO憑證要在STATUS = 8
-- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
-- =============================================
(
    WACCOUNT_NO    INTEGER,                    -- 受益人戶號
    WBAL_DATE      DATE,                       -- 庫存日期
    OUTDT          OUT SYS_REFCURSOR,          -- 回傳的 受益人基本資料
    OUTDT2         OUT SYS_REFCURSOR           -- 回傳的 受益人Robo 庫存檔
) IS
-- 此程式若有調整，請同步調整 s_GetBMSData與s_GetMyInventoryInfo
XID  VARCHAR2(10);                 --受益人ID
XBAL_DATE DATE:= TRUNC(WBAL_DATE); --格式為YYYY/MM/DD
XSYS_DTTM DATE:= SYSDATE;          --系統時間

BEGIN

  DELETE FROM ECS.ROBO_NAV_DATE_TEMP;                     --清除TABLE所有資料(最新淨值日)
  DELETE FROM ECS.ROBO_MYINVENTORY_TEMP;              --清除TABLE所有資料

    --將最新淨值存入暫存檔
    INSERT INTO ECS.ROBO_NAV_DATE_TEMP
    (
         FUND_NO
        ,NAV_DATE
        ,TX_DATE
        ,NAV
        ,CHANGE
        ,BAL_SHARE
        ,NET_ASSET
    )
    SELECT NAV.FUND_NO
           ,NAV.NAV_DATE
           ,NAV.TX_DATE
           ,NAV.NAV
           ,NAV.CHANGE
           ,NAV.BAL_SHARE
           ,NAV.NET_ASSET
      FROM NAV.NAV
      JOIN (SELECT FUND_NO, MAX(NAV_DATE) AS NAV_DATE
             FROM NAV.NAV
            WHERE NAV_DATE <= TRUNC(SYSDATE)
            GROUP BY FUND_NO) A
        ON A.FUND_NO = NAV.NAV.FUND_NO
       AND A.NAV_DATE = NAV.NAV.NAV_DATE;

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

    -- 受益人相關基本資料 (若調整請同步調整 s_GetBMSData)
    OPEN OUTDT FOR
    SELECT  HOLDER.NAME
           ,HOLDER.GENDAR AS GENDER
           ,CASE HOLDER.GENDAR
               WHEN 'F' THEN '女生'
               WHEN 'M' THEN '男生'
               WHEN 'C' THEN '公司'
            END GENDER_NAME
           ,HOLDER.RISK_LEVEL
           ,CASE HOLDER.RISK_LEVEL
               WHEN '1' THEN '保守'
               WHEN '2' THEN '穩健'
               WHEN '3' THEN '積極'
            END RISK_LEVEL_NAME
           -- 2018.03.27 Jim 新增KYC
           -- 2018.06.26 JIANXIN 新增KYC 分數欄位
           ,KYC_SCROE AS KYC_SCORE
           ,HOLDER.ACCOUNT_NO
           -- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶
           -- 2018.12.24 JIANXIN 因緊急上版先行移除【調整未開戶完成者，視為查詢戶】
           -- 2018.12.24 JIANXIN 調整未開戶完成者，視為查詢戶 恢復
           -- 2019.01.03 tingting 移除【調整未開戶完成者，視為查詢戶】
           ,CASE WHEN HOLDER.ECS_STATUS = '1'  THEN 'Y'
                 ELSE 'N'
             END ECS_STATUS
           -- 2018.07.17 ChengYu 新增欄位AML_STATUS(帳戶狀態),ROBO_AGREEMENT(ROBO同意書),IS_EMP(是否為員工員眷),VULNERABLE_GROUP(是否為弱勢族群) BEGIN
           ,HOLDER.AML_STATUS AS AML_STATUS
           ,HOLDER.ROBO_AGREEMENT AS ROBO_AGREEMENT
           -- 2018.12.10 yunchu 調整判斷是否為員工[FAS.EMP(STATUS:A員工;T離職)]
           ,CASE WHEN (EMP.STATUS = 'A') AND (RELATIVE.RELATIONSHIP IN ('S','P','C')) THEN 'Y'
                 ELSE 'N'
            END AS IS_EMP
           -- 2018.10.25 JIANXIN 弱勢族群判斷調整
           -- 2018.12.24 JIANXIN 弱勢族群判斷 20 歲以下不是弱勢族群
           ,CASE WHEN HOLDER.MAJOR_ILLNESS = 'Y' THEN 'Y'   -- 有重大傷病證明
                 WHEN TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(HOLDER.BIRTH_DATE,'yyyyMMdd'))/10000) >= 20 AND (HOLDER.EDUCATION = 'a' OR HOLDER.EDUCATION = 'A') THEN 'Y'  -- 20歲以上，學歷為國中小以下
                 --WHEN TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(HOLDER.BIRTH_DATE,'yyyyMMdd'))/10000) < 20  THEN 'Y'  --20歲以下
                 WHEN TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(HOLDER.BIRTH_DATE,'yyyyMMdd'))/10000) >= 70  THEN 'Y'  --70歲以上
                 ELSE 'N' 
             END AS VULNERABLE_GROUP
           -- 2018.07.17 ChengYu 新增欄位AML_STATUS(帳戶狀態),ROBO_AGREEMENT(ROBO同意書),IS_EMP(是否為員工員眷),VULNERABLE_GROUP(是否為弱勢族群) END
           -- 2018.07.19 ChengYu 新增欄位 KYC 是否有效(KYC_EFFECTIVE)
           ,CASE WHEN HOLDER.RISK_STATUS = '1' AND XSYS_DTTM <= HOLDER.RISK_MAT_DATE THEN 'Y'
                 WHEN HOLDER.RISK_STATUS = '2' OR HOLDER.RISK_STATUS = '3' THEN 'Y'
                 WHEN HOLDER.RISK_STATUS = '1' AND XSYS_DTTM > HOLDER.RISK_MAT_DATE THEN 'N'
                 WHEN HOLDER.RISK_STATUS = '0' THEN 'N'
                 ELSE ''
            END AS KYC_EFFECTIVE
            -- 2018.10.04 YungLong 新增傳出欄位「出生日期」
           ,HOLDER.BIRTH_DATE
            -- 2018.10.26 JIANXIN 新增年齡欄位
            ,TRUNC((TO_CHAR(XSYS_DTTM,'yyyyMMdd')-TO_CHAR(BIRTH_DATE,'yyyyMMdd'))/10000) AS AGE
      FROM FAS.HOLDER HOLDER
      LEFT JOIN FAS.EMP EMP            -- 員工資料
        ON EMP.ID = HOLDER.ID
      LEFT JOIN FAS.RELATIVE RELATIVE  -- 員眷資料
        ON RELATIVE.ID = HOLDER.ID
     WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

    INSERT INTO ECS.ROBO_MYINVENTORY_TEMP
    (
         ROBO_CONTRACT_NO
        ,HOLDFUND
        ,SHARES
        ,TX_DATE
        ,FUND_CRNCY
        ,TRADE_CRNCY
        ,TOT_COST
        ,TOT_COST_NTD
        ,RETURN_ROI
    )
      SELECT  CERTIFICATE.ROBO_CONTRACT_NO AS ROBO_CONTRACT_NO   --Robo 契約書號
             ,CERTIFICATE.FUND_NO AS HOLDFUND                    --持有基金
             ,SUM(CERTIFICATE.SHARES) AS SHARES                 --持有單位數
             ,NULL AS TX_DATE                                   --交易日
             ,FUND.CURRENCY_NO AS FUND_CRNCY                    --計價幣別
             ,TX_CURRENCY.CURRENCY_NO AS TRADE_CRNCY                   --申購幣別
             -- 2018.05.14 Mod By Jim 補上小數單位數
             ,ROUND(SUM(CERTIFICATE.COST),V_FUND_CRNCY.AMT_DECIMAL) AS TOT_COST                 --總投資成本
             ,ROUND(SUM(CERTIFICATE.COST * CASE WHEN FUND.CURRENCY_NO = 'NTD' THEN 1 ELSE NTD_EXRATE.EX_RATE END )
                   ,NTD_AMT.AMT_DECIMAL) AS TOT_COST_NTD        --總投資成本(參考台幣)
             ,CASE                                              --年化報酬率
               WHEN FUND.ANNUALIZED_ROI = 'N' THEN
                0
               WHEN FUND.ANNUALIZED_ROI = 'Y' THEN
                ROUND(SUM(CASE
                            WHEN XBAL_DATE = CERTIFICATE.PUR_DATE THEN
                             0
                            WHEN XBAL_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.Cost = 0 THEN
                             1
                            WHEN XBAL_DATE > CERTIFICATE.PUR_DATE AND CERTIFICATE.Cost > 0 THEN
                             ROUND(((ROUND((CERTIFICATE.SHARES * NAV.NAV),
                                           V_FUND_CRNCY.AMT_DECIMAL) - CERTIFICATE.COST) /
                                   CERTIFICATE.COST / (XBAL_DATE - CERTIFICATE.PUR_DATE) * 365 * 100),
                                   2)
                          END),
                      2)
             END RETURN_ROI
        FROM FAS.CERTIFICATE CERTIFICATE
        JOIN FAS.FUND FUND
          ON FUND.FUND_NO = CERTIFICATE.FUND_NO
         AND FUND.INCEPTION_DATE IS NOT NULL                          --「成立日期(INCEPTION_DATE)」不為空白
         AND FUND.INCEPTION_DATE <= XBAL_DATE                         -- 「成立日期(INCEPTION_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND (FUND.CLEAR_DATE IS NULL                                 --「停止日期(CLEAR_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
            OR FUND.CLEAR_DATE > XBAL_DATE)
        JOIN ECS.V_TX_CURRENCY TX_CURRENCY                              -- 基金交易別申購幣別檔
          ON TX_CURRENCY.FUND_NO = FUND.FUND_NO
         AND TX_CURRENCY.TRADE_CD = '1'
        JOIN FAS.V_CURRENCY_RATE NTD_EXRATE
          ON NTD_EXRATE.FUND_NO = CERTIFICATE.FUND_NO
         AND NTD_EXRATE.TX_DATE = CERTIFICATE.PUR_DATE
        JOIN ECS.V_FUND_CRNCY NTD_AMT
          ON NTD_AMT.CURRENCY_NO = 'NTD'
        LEFT JOIN ECS.ROBO_NAV_DATE_TEMP NAV
          ON NAV.FUND_NO = FUND.FUND_NO
        JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
          ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
       WHERE CERTIFICATE.ID = XID
         AND CERTIFICATE.ISSUE_DATE <= XBAL_DATE                      --「配號日期(ISSUE_DATE)」小於等於傳入參數『庫存日期(BAL_DATE)』
         AND (CERTIFICATE.CANCEL_DATE IS NULL                         --「註銷日期(CANCEL_DATE)」為空白 或 大於傳入參數『庫存日期(BAL_DATE)』
             OR CERTIFICATE.CANCEL_DATE > XBAL_DATE)
         -- 2019.01.04 JIANXIN 調整ROBO憑證要在STATUS = 8
         AND CERTIFICATE.STATUS = '8'
       GROUP BY CERTIFICATE.FUND_NO,
                CERTIFICATE.CURRENCY_NO,
                FUND.CURRENCY_NO,
                TX_CURRENCY.CURRENCY_NO,
                NTD_AMT.AMT_DECIMAL,
                FUND.ANNUALIZED_ROI,
                V_FUND_CRNCY.AMT_DECIMAL,
                CERTIFICATE.ROBO_CONTRACT_NO
      HAVING CERTIFICATE.ROBO_CONTRACT_NO IS NOT NULL;


  --執行【API041：GetTradeDate】取得各基金的交易日期 (若調整請同步調整 s_GetMyInventoryInfo)
  BEGIN

    DECLARE

    TRADEDT SYS_REFCURSOR;
    XFUND_ID VARCHAR2(10);
    XTX_DATE DATE;
    XIS_SUCCESS VARCHAR2(1);
    XWARNS_TYPE VARCHAR2(10);
    XERROR_MSG VARCHAR2(255);

    BEGIN

      FOR ITEM IN (SELECT HOLDFUND,TRADE_CRNCY FROM ECS.ROBO_MYINVENTORY_TEMP)
        LOOP
          -- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
          ECS.S_GETTRADEDATE('2',ITEM.HOLDFUND,SYSDATE,ITEM.TRADE_CRNCY,TRADEDT);

          LOOP
            FETCH TRADEDT INTO XFUND_ID,XTX_DATE,XIS_SUCCESS,XWARNS_TYPE,XERROR_MSG;
            EXIT WHEN TRADEDT%NOTFOUND;

            --抓取成功則更新交易日
            IF XIS_SUCCESS = 'N' THEN

              RAISE_APPLICATION_ERROR(-20000,
                                      XERROR_MSG);

            ELSE

              UPDATE ECS.ROBO_MYINVENTORY_TEMP ROBO_MYINVENTORY_TEMP
                 SET TX_DATE = XTX_DATE
               WHERE ROBO_MYINVENTORY_TEMP.HOLDFUND = XFUND_ID;

            END IF;

          END LOOP;

        END LOOP;

    END;

  END;

  --取得受益人各Robo 計畫中的基金相關資料 (若調整請同步調整 s_GetMyInventoryInfo)
  OPEN OUTDT2 FOR
    SELECT XID AS ID                                                  --受益人ID
           ,FUND.ANNUALIZED_ROI AS IS_ROI                             --是否年化報酬率
           ,TEMP.RETURN_ROI                                           --年化報酬率
           ,FUND.FUND_CATEGORY                                        --境內外識別碼
           ,DECODE(FUND.FUND_CATEGORY,'1','境內' ,'2','境外','') AS FUND_CATEGORY_NAME                   --境內外識別碼名稱
           ,FUND.AMC_NO                                               --基金公司代碼
           ,AMC.NAME AS AMC_NAME                                      --基金公司名稱
           ,FUND.FUND_NO                                              --基金代碼
           ,FUND.NAME AS FUND_NAME                                    --基金名稱
           ,FUND.DIVIDEND_DESC AS FUND_MEMO                           --基金警語
           -- 2018.09.26 ChengYu 新增欄位 基金風險屬性
           ,FUND.RISK_CATEGORY AS RISK_CATEGORY                       --基金風險屬性
           ,FUND.ISIN_CODE                                            --國際證券代碼
           ,TEMP.FUND_CRNCY AS CURRENCY_NO                            --計價幣別
           ,FUND_CRNCY.NAME AS CURRENCY_NAME                          --計價幣別名稱
           ,ROUND(TEMP.TOT_COST / TEMP.SHARES,FUND_CRNCY.AMT_DECIMAL) AVG_COST     --平均單位成本
           ,ROUND(TEMP.SHARES,FUND.SHARE_DECIMAL) AS HOLD_SHARES      --持有單位數
           -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
		       -- 2018.08.29 JIANXIN MOD 可買回單位數新增ROBO契約書號參數
           ,ROUND(ECS.FN_API_GET_RUNIT(XID,TEMP.TX_DATE,TEMP.HOLDFUND,TEMP.TRADE_CRNCY,'1','8',TEMP.ROBO_CONTRACT_NO),FUND.SHARE_DECIMAL)  R_SHARES               --可買回單位數
           ,TEMP.TRADE_CRNCY                                          --申購幣別
           ,TRADE_CRNCY.NAME AS TRADE_CRNCY_NM                        --申購幣別中文名稱
           ,TEMP.TOT_COST                                             --總投資成本
           ,TEMP.TOT_COST_NTD                                         --總投資成本(參考台幣)
           ,FUND.SHARE_DECIMAL                                        --單位數小數位數
           ,FUND.NAV_DECIMAL                                          --淨值小數位數
           ,FUND_CRNCY.AMT_DECIMAL                                    --計價幣別小數位數
           ,TRADE_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL              --申購幣別小數位數
           ,TEMP.ROBO_CONTRACT_NO
      FROM ECS.ROBO_MYINVENTORY_TEMP TEMP
      JOIN FAS.FUND FUND
        ON FUND.FUND_NO = TEMP.HOLDFUND
      JOIN FAS.AMC AMC
        ON AMC.AMC_NO = FUND.AMC_NO
      JOIN ECS.V_FUND_CRNCY FUND_CRNCY
        ON FUND_CRNCY.CURRENCY_NO = TEMP.FUND_CRNCY
      JOIN ECS.V_FUND_CRNCY TRADE_CRNCY
        ON TRADE_CRNCY.CURRENCY_NO = TEMP.TRADE_CRNCY
     ORDER BY FUND.FUND_NO;



END s_GetRoboBMSData;

/

  GRANT EXECUTE ON "ECS"."S_GETROBOBMSDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETROBOSTATUS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETROBOSTATUS" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/03/22
-- Description: 取得交易憑證明細資料
-- 2018.03.23 Jim     新增回傳參數SHARES
-- 2018.03.31 ChengYu 幣別名稱從 ECS.V_FUND_CRNCY 取得
-- 2018.04.10 Jim 新增QUERY_TYPE的條件式及淨值日期別名
-- 2018.04.11 Jim 因規格變動，修改邏輯
-- 2018.04.13 Jim 調整Query_Type為2的邏輯、搜尋條件
-- 2018.05.10 Jim 增加owner別名
-- 2018.05.22 Jim 新增參數AC_CNT 重複扣款次數
-- 2018.05.22 Jim QUERY_TYPE為1時，將WTRADE_TYPE用IF的寫法，閱讀CODE比較容易
-- 2018.06.08 ChengYu 增加回傳值 FAIL_REASON(交易失敗原因)
-- 2018.07.14 JIANXIN 調整錯誤訊息回傳空白問題
-- 2018.07.18 ChengYu 新增回傳欄位 FAIL_CODE(交易失敗代碼)
-- 2018.07.19 ChengYu 新增欄位 交易確認日(CONFIRMATION_DATE)、現金日(CASH_DATE)、交易結帳日(SETTLEMENT_DATE) 
-- 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
-- 2018.08.02 PAN 買回金額改為買回淨額(買回淨額：fas.red_bank.amount - fas.red_bank.wire_fee)
-- 2018.09.04 ChengYu 因資料問題，調整交易狀態 = S.已成功 的判斷方式(增加判斷可買回單位數>=0)
-- 2018.09.23 JIANXIN 若贖回資料已結帳，則回傳FAS的匯費資料，並調整程式寫法
-- 2018.11.05 tingting 調整贖回的現金日都抓ECS.REDEMPTION(因為FAS.REDEMPTION都是NULL)
-- 2018.11.21 JIANXIN ROBO 交易金額調整申購為成本
-- 2018.11.23 JIANXIN MOD BY 若交易幣 = 'NTD'，則無需做匯率轉換
-- 2018.11.24 JIANXIN MOD BY 經Jessie、Lisa、Eric 等人同意交易成本(原幣)計算方式為 單位數 * 淨值，交易成本(台幣)仍以交易成本 * 匯率處理
-- 2018.11.26 JIANXIN MOD BY 若計價幣別等於交易幣別時，出現COST 否則以 單位數 * 淨值 回傳
-- =============================================
(
   WQUERY_TYPE       INTEGER             -- 查詢種類： 1：受益人戶號 ＋ ES交易書號 / 2：淨值日期(起) + 淨值日期(迄) / 3：受益人戶號 + Robo 契約書號 + Robo 交易書號
  ,WACCOUNT_NO       INTEGER             -- 受益人戶號
  ,WISIN_CODE        VARCHAR2            -- ISIN_CODE
  ,WDATE_FROM        DATE                -- 交易日期 (起)
  ,WDATE_TO          DATE                -- 交易日期 (迄)
  ,WROBO_CONTRACT_NO VARCHAR2            -- ROBO 契約編號
  ,WROBO_SER_NO      VARCHAR2            -- ROBO 交易編號
  ,WTRADE_TYPE       VARCHAR2            -- 交易類別 (A:申購 B:買回)
  ,WFUND_NO          VARCHAR2            -- 基金別
  ,WBROKER_NO        VARCHAR2            -- 代銷單位
  ,WBRANCH_NO        VARCHAR2            -- 代銷分公司碼
  ,WTX_DATE          DATE                -- 交易日期
  ,WSER_NO           VARCHAR2            -- 交易序號
  ,OUTDT             OUT SYS_REFCURSOR   -- 回傳資料
) IS

  XID      VARCHAR2(10); -- 身份證號
  XFUND_NO VARCHAR2(5); -- 基金代碼

BEGIN

  /*
    這一支 SP主要是提供給 Alkanza 批次時查詢及更新交易單狀態用，預期一定要傳入 ROBO_CONTRACT_NO
    其它動態的查詢條件，在  API 的  C# 程式碼中用 LINQ 處理，以提升效能

    1：ACCOUNT_NO + ORDER_ID (FUND_NO, BROKER_NO, BRANCH_NO, TX_DATE, SER_NO)
    2：ACCOUNT_NO(Optional) + ISIN_CODE (Optional) + DATE_FROM + DATE_TO
       Optional : 用 ALL 代表全部
    3：ACCOUNT_NO + ROBO_CONTRACT_NO + ROBO_SER_NO
  */

  /*
  --檢核傳入參數的合理性
  IF WQUERY_TYPE = '1' THEN
    IF (WACCOUNT_NO IS NULL OR WFUND_NO IS NULL OR WBROKER_NO IS NULL OR WBRANCH_NO IS NULL OR WTX_DATE IS NULL OR WSER_NO IS NULL)
      RAISE_APPLICATION_ERROR(-20000,'傳入參數有誤，請檢查： WACCOUNT_NO, WFUND_NO, WBROKER_NO, WBRANCH_NO, WTX_DATE, WSER_NO');
    END IF;
  ELSIF WQUERY_TYPE = '2' THEN
    IF (WDATE_FROM IS NULL OR WDATE_TO IS NULL)
      RAISE_APPLICATION_ERROR(-20000,'傳入參數有誤，請檢查： WDATE_FROM, WDATE_TO');
    END IF;
  ELSIF WQUERY_TYPE = '3' THEN
    IF (WACCOUNT_NO IS NULL OR WROBO_CONTRACT_NO IS NULL OR WROBO_SER_NO IS NULL)
      RAISE_APPLICATION_ERROR(-20000,'傳入參數有誤，請檢查：WACCOUNT_NO, WROBO_CONTRACT_NO, WROBO_SER_NO');
    END IF;
  ELSE 
    RAISE_APPLICATION_ERROR(-20000, 'XQUERY_TYPE：必須是 1、2或3');
  END IF;
  */

  -- 取得身份證號
  IF WQUERY_TYPE = 2 THEN
    IF WACCOUNT_NO = 0 THEN
      XID := 'ALL';
    ELSE
      BEGIN
        SELECT ID INTO XID
           FROM FAS.HOLDER
           WHERE ACCOUNT_NO = WACCOUNT_NO;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
      END;
    END IF;
  ELSE
    BEGIN
      SELECT ID INTO XID
         FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;
      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;
  END IF;

  -- 取基金代碼
  IF WQUERY_TYPE = 2 THEN
    IF WISIN_CODE = 'ALL' THEN
      XFUND_NO := 'ALL';
    ELSE
      BEGIN
        SELECT FUND_NO
            INTO XFUND_NO
            FROM FAS.FUND
           WHERE ISIN_CODE = WISIN_CODE;
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20000, WISIN_CODE || '無法取得基金代碼，請檢查！');
      END;
    END IF;
  END IF;

  IF WQUERY_TYPE IS NULL OR (WQUERY_TYPE IS NOT NULL AND WQUERY_TYPE <> '1' AND WQUERY_TYPE <> '2' AND WQUERY_TYPE <> '3' ) THEN  
    RAISE_APPLICATION_ERROR(-20000, 'XQUERY_TYPE：必須是 1、2 或 3 ');
  END IF;

  IF WTRADE_TYPE = 'A' THEN

      OPEN OUTDT FOR
        SELECT  HOLDER.ACCOUNT_NO                 --受益人戶號
               ,PURCHASE.ROBO_CONTRACT_NO         --ROBO契約書號
               ,PURCHASE.ROBO_SER_NO              --ROBO交易書號
               ,PURCHASE.FUND_NO                  --基金代碼
               ,FUND.ISIN_CODE                    --國際證券代碼
               ,PURCHASE.TX_DATE                  --交易日期
               ,PURCHASE.BROKER_NO                --代銷單位
               ,PURCHASE.BRANCH_NO                --代銷分公司碼
               ,PURCHASE.SER_NO                   --交易序號
               ,CASE WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE = '00' THEN 'S'
                     WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN 'F'
                     ELSE PURCHASE.STATUS
                 END AS STATUS     --交易狀態
               ,FUND.CURRENCY_NO --計價幣別
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME --計價幣別名稱
               --BEGIN 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') OR PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN PURCHASE.AC_DATE
                     --ELSE TO_DATE('1900/01/01', 'YYYY/MM/DD')
                     ELSE NULL
                 END AS AC_DATE --淨值日期
               ,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN NAV.NAV
                     WHEN PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN NULL
                     --ELSE 0
                     ELSE NULL
                 END AS NAV --淨值
               --END 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,PURCHASE.SERVICE_CHARGE --手續費
               ,CASE WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE = '00' THEN
                     ROUND(PURCHASE.SERVICE_CHARGE * 
                          -- 2018.11.23 JIANXIN MOD BY 若交易幣 = 'NTD'，則無需做匯率轉換(補)
                           CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN 1 
                                ELSE 
                                      (SELECT B.EX_RATE
                                         FROM FAS.V_CURRENCY_RATE B
                                        WHERE B.FUND_NO = V_ALL_PURCHASE.FUND_NO
                                          AND B.TX_DATE =
                                              (SELECT MAX(A.TX_DATE)
                                                 FROM FAS.V_CURRENCY_RATE A
                                                WHERE A.FUND_NO = V_ALL_PURCHASE.FUND_NO
                                                  AND A.TX_DATE <= V_ALL_PURCHASE.AC_DATE))
                            END,
                            NTD_FUND_CRNCY.AMT_DECIMAL)
                     ELSE 0
                 END AS NTD_SERVICE_CHARGE --手續費(台幣)
               ,CASE WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE = '00' THEN NVL(V_ALL_PURCHASE.SHARES, 0)
                     ELSE 0
                 END AS SHARES --單位數
               --BEGIN 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               -- 2018.11.21 JIANXIN ROBO 交易金額調整申購為成本 
               -- 2018.11.24 JIANXIN MOD BY 經Jessie、Lisa、Eric 等人同意交易成本(原幣)計算方式為 單位數 * 淨值，交易成本(台幣)仍以交易成本 * 匯率處理
               ,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN 
                          -- 2018.11.26 JIANXIN MOD BY 若計價幣別等於交易幣別時，出現COST 否則以 單位數 * 淨值 回傳
                          CASE WHEN PURCHASE.CURRENCY_NO  = FUND.CURRENCY_NO THEN PURCHASE.AMOUNT 
                               ELSE ROUND(NVL(V_ALL_PURCHASE.SHARES, 0) * NAV.NAV,FUND.AMT_DECIMAL) 
                           END 
                     WHEN PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN NULL
                     --WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN 0                 
                     WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN NULL
                 END AS MARKET_PRICE --市值
               ,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN
                     ROUND(PURCHASE.AMOUNT * 
                          -- 2018.11.23 JIANXIN MOD BY 若交易幣 = 'NTD'，則無需做匯率轉換
                           CASE WHEN PURCHASE.CURRENCY_NO = 'NTD' THEN 1 
                                ELSE 
                                      (SELECT B.EX_RATE
                                         FROM FAS.V_CURRENCY_RATE B
                                        WHERE B.FUND_NO = V_ALL_PURCHASE.FUND_NO
                                          AND B.TX_DATE =
                                              (SELECT MAX(A.TX_DATE)
                                                 FROM FAS.V_CURRENCY_RATE A
                                                WHERE A.FUND_NO = V_ALL_PURCHASE.FUND_NO
                                                  AND A.TX_DATE <= V_ALL_PURCHASE.AC_DATE))
                            END,
                            NTD_FUND_CRNCY.AMT_DECIMAL)
                     WHEN PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN NULL
                     --WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN 0
                     WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN NULL
                 END AS NTD_MARKET_PRICE --市值(台幣)               
               --,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN ROUND(NVL(V_ALL_PURCHASE.SHARES, 0) * NAV.NAV, FUND.AMT_DECIMAL)
               --      WHEN PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN NULL
               --      --WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN 0                 
               --      WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN NULL
               --  END AS MARKET_PRICE --市值
               --,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN
               --      ROUND(NVL(V_ALL_PURCHASE.SHARES, 0) * NAV.NAV *
               --           (SELECT B.EX_RATE
               --              FROM FAS.V_CURRENCY_RATE B
               --             WHERE B.FUND_NO = V_ALL_PURCHASE.FUND_NO
               --               AND B.TX_DATE =
               --                   (SELECT MAX(A.TX_DATE)
               --                      FROM FAS.V_CURRENCY_RATE A
               --                     WHERE A.FUND_NO = V_ALL_PURCHASE.FUND_NO
               --                       AND A.TX_DATE <= V_ALL_PURCHASE.AC_DATE)),
               --           NTD_FUND_CRNCY.AMT_DECIMAL)
               --      WHEN PURCHASE.STATUS = 'O' OR PURCHASE.STATUS = 'C' THEN NULL
               --      --WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN 0
               --      WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESUlT_CODE <> '00' THEN NULL
               --  END AS NTD_MARKET_PRICE --市值(台幣)
               --END 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,FUND.SHARE_DECIMAL      --單位數小數位數
               ,FUND.NAV_DECIMAL        --淨值小數位數
               ,V_FUND_CRNCY.AMT_DECIMAL --計價幣別小數位數
               ,'A;' || PURCHASE.FUND_NO || ';' ||
                TO_CHAR(PURCHASE.TX_DATE, 'YYYYMMDD') || ';' || PURCHASE.BROKER_NO || ';' ||
                PURCHASE.BRANCH_NO || ';' || PURCHASE.SER_NO AS ES_TX_NO --ES交易書號
               ,'A' AS TRADE_TYPE --交易別
               --2018.05.22 Jim 新增AC_CNT
               ,PURCHASE.AC_CNT   -- 扣款重送次數
               -- 2018.07.18 ChengYu 新增回傳欄位 FAIL_CODE(交易失敗代碼)
               ,CASE WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN '99' 
                     ELSE ' '
                 END AS FAIL_CODE  -- 交易失敗代碼
               -- 2018.06.08 ChengYu 增加回傳值 FAIL_REASON(交易失敗原因)
               -- 2018.07.14 JIANXIN 調整錯誤訊息回傳空白問題
               ,CASE WHEN PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE <> '00' THEN 
                     CAST(REPLACE(REPLACE(MSGINFO.MSGCONTENT,'{ROBO_CONTRACT_NO}',PURCHASE.ROBO_CONTRACT_NO),'{ROBO_SER_NO}',PURCHASE.ROBO_SER_NO) AS VARCHAR2(500))
                     ELSE ' '
                 END AS FAIL_REASON -- 交易失敗原因
               --BEGIN 2018.07.19 ChengYu 新增欄位 交易確認日(CONFIRMATION_DATE)、現金日(CASH_DATE)、交易結帳日(SETTLEMENT_DATE) 
               ,PURCHASE.TX_DATE AS CONFIRMATION_DATE   -- 交易確認日
               ,PURCHASE.TX_DATE AS CASH_DATE           -- 現金日
               -- 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,CASE WHEN (PURCHASE.STATUS = 'P' AND PURCHASE.RESULT_CODE = '00') THEN PURCHASE.AC_DATE
                     WHEN PURCHASE.STATUS ='O' OR PURCHASE.STATUS = 'C' THEN NULL
                     --ELSE TO_DATE('19000101','YYYYMMDD')                            
                     ELSE NULL
                 END AS SETTLEMENT_DATE                  -- 交易結帳日
               --END 2018.07.19 ChengYu 新增欄位 交易確認日(CONFIRMATION_DATE)、現金日(CASH_DATE)、交易結帳日(SETTLEMENT_DATE) 
          FROM ECS.PURCHASE PURCHASE
          JOIN FAS.HOLDER
            ON PURCHASE.ID = HOLDER.ID
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = PURCHASE.FUND_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY NTD_FUND_CRNCY
            ON NTD_FUND_CRNCY.CURRENCY_NO = 'NTD'
          LEFT JOIN FAS.V_ALL_PURCHASE V_ALL_PURCHASE
            ON V_ALL_PURCHASE.FUND_NO = PURCHASE.FUND_NO
           AND V_ALL_PURCHASE.TX_DATE = PURCHASE.TX_DATE
           AND V_ALL_PURCHASE.BROKER_NO = PURCHASE.BROKER_NO
           AND V_ALL_PURCHASE.BRANCH_NO = PURCHASE.BRANCH_NO
           AND V_ALL_PURCHASE.SER_NO = PURCHASE.SER_NO
          LEFT JOIN NAV.NAV NAV
            ON NAV.NAV_DATE = PURCHASE.AC_DATE
           AND NAV.FUND_NO = PURCHASE.FUND_NO
          -- 2018.06.08 ChengYu 增加回傳值 FAIL_REASON(交易失敗原因)
         CROSS JOIN (SELECT * FROM ECS.MSGINFO WHERE MSGINFO.MSGID = 'Q004') MSGINFO
         WHERE (    WQUERY_TYPE = '1' 
                AND PURCHASE.ID = XID
                AND PURCHASE.BROKER_NO = WBROKER_NO
                AND PURCHASE.BRANCH_NO = WBRANCH_NO
                AND PURCHASE.TX_DATE = TRUNC(WTX_DATE)
                AND PURCHASE.FUND_NO = WFUND_NO
                AND PURCHASE.SER_NO = WSER_NO
                AND PURCHASE.ROBO_CONTRACT_NO IS NOT NULL
                AND PURCHASE.ROBO_SER_NO IS NOT NULL 
               )
            OR (    WQUERY_TYPE = '2' 
                AND PURCHASE.TX_DATE BETWEEN TRUNC(WDATE_FROM) AND TRUNC(WDATE_TO)
                AND PURCHASE.ROBO_CONTRACT_NO IS NOT NULL
                AND PURCHASE.ROBO_SER_NO IS NOT NULL
                AND (PURCHASE.ID = XID OR XID = 'ALL')
                AND (PURCHASE.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
               )
            OR (    WQUERY_TYPE = '3' 
                AND PURCHASE.ID = XID
                AND PURCHASE.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO
                AND PURCHASE.ROBO_SER_NO = WROBO_SER_NO
               );

  ELSIF WTRADE_TYPE = 'B' THEN

      OPEN OUTDT FOR
        SElECT  HOLDER.ACCOUNT_NO            --受益人戶號
               ,REDEMPTION.ROBO_CONTRACT_NO --ROBO契約書號
               ,REDEMPTION.ROBO_SER_NO      --ROBO交易書號
               ,REDEMPTION.FUND_NO          --基金代碼
               ,FUND.ISIN_CODE              --國際證券代碼
               ,REDEMPTION.TX_DATE          --交易日期
               ,REDEMPTION.BROKER_NO        --代銷單位
               ,REDEMPTION.BRANCH_NO        --代銷分公司碼
               ,REDEMPTION.SER_NO           --交易序號
               -- 2018.09.04 ChengYu 因資料問題，調整交易狀態 = S.已成功 的判斷方式(增加判斷可買回單位數>=0)
               ,CASE WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE = '00' THEN 
                     CASE WHEN ECS.FN_API_GET_RUNIT(XID,REDEMPTION.TX_DATE,FUND.FUND_NO,FUND.CURRENCY_NO,'1','8',WROBO_CONTRACT_NO) >= 0 
                          THEN 'S'
                          ELSE 'C'
                      END
                     WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE <> '00' THEN 'F'
                     ELSE REDEMPTION.STATUS
                 END AS STATUS --交易狀態
               ,FUND.CURRENCY_NO --計價幣別
               ,V_FUND_CRNCY.NAME AS CURRENCY_NAME --計價幣別名稱
               --BEGIN 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,CASE WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00' THEN FAS_REDEMPTION.AC_DATE
                     WHEN REDEMPTION.STATUS = 'O' OR REDEMPTION.STATUS = 'C' THEN REDEMPTION.AC_DATE
                     --ELSE TO_DATE('1900/01/01', 'YYYY/MM/DD')
                     ELSE NULL
                 END AS AC_DATE --淨值日期
               ,CASE WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00' THEN NAV.NAV
                     WHEN REDEMPTION.STATUS = 'O' OR REDEMPTION.STATUS = 'C' THEN NULL
                     --ELSE 0
                     ELSE NULL
                 END AS NAV --淨值
               -- 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,RED_BANK.WIRE_FEE AS SERVICE_CHARGE --手續費
               ,CASE WHEN RED_BANK.CURRENCY_NO = 'NTD' THEN RED_BANK.WIRE_FEE 
                     ELSE RED_BANK.NTD_WIRE_FEE 
                 END AS NTD_SERVICE_CHARGE --手續費(台幣)
               ,NVL(V_ALL_REDEMPTION.APPLICATION_SHARE, 0) AS SHARES --單位數
               --END 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               --BEGIN 2018.08.02 PAN 買回金額改為買回淨額(買回淨額：fas.red_bank.amount - fas.red_bank.wire_fee) 
               ,CASE WHEN (REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00') THEN
                          --ROUND(NVL(V_ALL_REDEMPTION.APPLICATION_SHARE, 0) * NAV.NAV,FUND.AMT_DECIMAL)
                          RED_BANK.AMOUNT - RED_BANK.WIRE_FEE
                     WHEN REDEMPTION.STATUS = 'O' OR REDEMPTION.STATUS = 'C' THEN NULL
                     --WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE <> '00' THEN 0
                     WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE <> '00' THEN NULL
                 END AS MARKET_PRICE --申購金額/ 贖回淨額
               ,CASE WHEN (REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00') THEN
                          --ROUND(NVL(V_ALL_REDEMPTION.APPLICATION_SHARE, 0) * NAV.NAV *
                          ROUND((RED_BANK.AMOUNT - RED_BANK.WIRE_FEE) *
                                (SELECT B.EX_RATE
                                   FROM FAS.V_CURRENCY_RATE B
                                  WHERE B.FUND_NO = V_ALL_REDEMPTION.FUND_NO
                                    AND B.TX_DATE =
                                        (SELECT MAX(A.TX_DATE)
                                           FROM FAS.V_CURRENCY_RATE A
                                          WHERE A.FUND_NO = V_ALL_REDEMPTION.FUND_NO
                                            AND A.TX_DATE <= V_ALL_REDEMPTION.AC_DATE)),
                                NTD_FUND_CRNCY.AMT_DECIMAL)
                     WHEN REDEMPTION.STATUS = 'O' OR REDEMPTION.STATUS = 'C' THEN NULL
                     --WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE <> '00' THEN 0                
                     WHEN REDEMPTION.STATUS = 'P' AND REDEMPTION.RESUlT_CODE <> '00' THEN NULL             
                 END AS NTD_MARKET_PRICE --申購金額(台幣)/ 贖回淨額(台幣)
               --END 2018.08.02 PAN 買回金額改為買回淨額(買回淨額：fas.red_bank.amount - fas.red_bank.wire_fee) 
               --END 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,FUND.SHARE_DECIMAL --單位數小數位數
               ,FUND.NAV_DECIMAL --淨值小數位數
               ,V_FUND_CRNCY.AMT_DECIMAL --計價幣別小數位數
               ,'B;' || REDEMPTION.FUND_NO || ';' ||
                TO_CHAR(REDEMPTION.TX_DATE, 'YYYYMMDD') || ';' ||
                REDEMPTION.BROKER_NO || ';' || REDEMPTION.BRANCH_NO || ';' ||
                REDEMPTION.SER_NO AS ES_TX_NO --ES交易書號
               ,'B' AS TRADE_TYPE --交易別
               --2018.05.22 Jim 新增AC_CNT
               ,0 AS AC_CNT       -- 扣款重送次數
               -- 2018.07.18 ChengYu 新增回傳欄位 FAIL_CODE(交易失敗代碼)
               ,' ' AS FAIL_CODE  -- 交易失敗代碼
               -- 2018.06.08 ChengYu 增加回傳值 FAIL_REASON(交易失敗原因)
               ,' ' AS FAIL_REASON
               --2018.07.19 ChengYu 新增欄位 交易確認日(CONFIRMATION_DATE)、現金日(CASH_DATE)、交易結帳日(SETTLEMENT_DATE) BEGIN
               ,CASE WHEN (REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00') THEN FAS_REDEMPTION.TX_DATE
                     ELSE REDEMPTION.TX_DATE
                 END AS CONFIRMATION_DATE
               -- 2018.11.05 tingting 調整贖回的現金日都抓ECS.REDEMPTION(因為FAS.REDEMPTION都是NULL)
               --,CASE WHEN (REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00') THEN FAS_REDEMPTION.PAY_DATE
               --      ELSE REDEMPTION.PAY_DATE
               --  END AS CASH_DATE        --現金日
               ,REDEMPTION.PAY_DATE AS CASH_DATE        --現金日
               -- 2018.07.19 ChengYu 交易狀態 = O.委託中 或 C.已確認 調整回傳值
               ,CASE WHEN (REDEMPTION.STATUS = 'P' AND REDEMPTION.RESULT_CODE = '00') THEN FAS_REDEMPTION.AC_DATE
                     WHEN REDEMPTION.STATUS ='O' OR REDEMPTION.STATUS = 'C' THEN NULL
                     --ELSE TO_DATE('19000101','YYYYMMDD')                            
                     ELSE NULL
                END AS SETTLEMENT_DATE                  -- 交易結帳日
               --2018.07.19 ChengYu 新增欄位 交易確認日(CONFIRMATION_DATE)、現金日(CASH_DATE)、交易結帳日(SETTLEMENT_DATE) END
          FROM ECS.REDEMPTION REDEMPTION          
          JOIN FAS.HOLDER
            ON REDEMPTION.ID = HOLDER.ID
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = REDEMPTION.FUND_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN FAS.REDEMPTION FAS_REDEMPTION
            ON FAS_REDEMPTION.FUND_NO = REDEMPTION.FUND_NO
           AND FAS_REDEMPTION.ID = REDEMPTION.ID
           AND FAS_REDEMPTION.TX_DATE = REDEMPTION.TX_DATE
           AND FAS_REDEMPTION.BROKER_NO = REDEMPTION.BROKER_NO
           AND FAS_REDEMPTION.BRANCH_NO = REDEMPTION.BRANCH_NO
           AND FAS_REDEMPTION.SER_NO = REDEMPTION.SER_NO
          LEFT JOIN FAS.V_ALL_REDEMPTION V_ALL_REDEMPTION
            ON V_ALL_REDEMPTION.FUND_NO = REDEMPTION.FUND_NO
           AND V_ALL_REDEMPTION.TX_DATE = REDEMPTION.TX_DATE
           AND V_ALL_REDEMPTION.BROKER_NO = REDEMPTION.BROKER_NO
           AND V_ALL_REDEMPTION.BRANCH_NO = REDEMPTION.BRANCH_NO
           AND V_ALL_REDEMPTION.SER_NO = REDEMPTION.SER_NO
          -- 2018.08.02 PAN 買回金額改為買回淨額(買回淨額：fas.red_bank.amount - fas.red_bank.wire_fee) 
          LEFT JOIN FAS.RED_BANK RED_BANK
            ON RED_BANK.FUND_NO = REDEMPTION.FUND_NO
           AND RED_BANK.TX_DATE = REDEMPTION.TX_DATE
           AND RED_BANK.FE_BROKER_NO = REDEMPTION.BROKER_NO
           AND RED_BANK.FE_BRANCH_NO = REDEMPTION.BRANCH_NO
           AND RED_BANK.FE_SER_NO = REDEMPTION.SER_NO
          LEFT JOIN NAV.NAV NAV
            ON NAV.NAV_DATE = FAS_REDEMPTION.AC_DATE
           AND NAV.FUND_NO = FAS_REDEMPTION.FUND_NO
         CROSS JOIN (SELECT * FROM ECS.V_FUND_CRNCY WHERE CURRENCY_NO = 'NTD') NTD_FUND_CRNCY
         WHERE (    WQUERY_TYPE = '1' 
                AND REDEMPTION.ID = XID
                AND REDEMPTION.BROKER_NO = WBROKER_NO
                AND REDEMPTION.BRANCH_NO = WBRANCH_NO
                AND REDEMPTION.TX_DATE = TRUNC(WTX_DATE)
                AND REDEMPTION.FUND_NO = WFUND_NO
                AND REDEMPTION.SER_NO = WSER_NO
                AND REDEMPTION.ROBO_CONTRACT_NO IS NOT NULL
                AND REDEMPTION.ROBO_SER_NO IS NOT NULL 
               )
            OR (    WQUERY_TYPE = '2' 
                AND REDEMPTION.TX_DATE BETWEEN TRUNC(WDATE_FROM) AND TRUNC(WDATE_TO)
                AND REDEMPTION.ROBO_CONTRACT_NO IS NOT NULL
                AND REDEMPTION.ROBO_SER_NO IS NOT NULL
                AND (REDEMPTION.ID = XID OR XID = 'ALL')
                AND (REDEMPTION.FUND_NO = XFUND_NO OR XFUND_NO = 'ALL')
               )
            OR (    WQUERY_TYPE = '3' 
                AND REDEMPTION.ID = XID
                AND REDEMPTION.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO
                AND REDEMPTION.ROBO_SER_NO = WROBO_SER_NO
               );

  END IF;

END s_GetRoboStatus;

/

  GRANT EXECUTE ON "ECS"."S_GETROBOSTATUS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETRSPEXPECTEDDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETRSPEXPECTEDDATE" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/28
-- Description: 取得定期(不)定額預計交易日期
-- 2018.04.12 Jim 修改申請日期從APserver取得
-- 2018.04.16 Jim 修改如果付款日為個位數時會出現的錯誤
-- 2018.11.09 PAN MOD 重新調整
-- 2019.04.17 JIANXIN MOD 修改同一基金但不同扣款日會有多種預計扣款日
-- 2020.04.29 Chengyu 調整 交易截止時限 抓取方式
-- =============================================
(
  WFUND_ACDAY    VARCHAR2,         -- 基金代碼及扣款日
  WAPPLY_DATE    DATE,             -- 申請日期
  OUTDT          OUT SYS_REFCURSOR -- 回傳的 TABLEDATA
) 
IS
  --宣告變數
  XAPPLY_DATE           DATE := WAPPLY_DATE;   --申請日期
  XAPPLY_DATE2          INTEGER := EXTRACT(DAY FROM XAPPLY_DATE); --格式日(DD)
  XAPPLY_TIME           DATE := TO_DATE('1900/01/01' || TO_CHAR(XAPPLY_DATE,'HH24:MI:SS'),'YYYY/MM/DD HH24:MI:SS'); --格式時間
  XCHECK                VARCHAR2(5);
  XIS_SUCCESS           VARCHAR2(1);           --取得資料成功否

  XRCV_DATE             INTEGER;               --定額收件日期
  XPRU_TX_DATE          DATE;                  --前置交易日期
  XCHECK_BUS            INTEGER;               --檢查是否為營業日
  XEXPECTED_TX_DATE     DATE;                  --預計交易日期

BEGIN

  -- 2019.04.17 JIANXIN MOD 修改同一基金但不同扣款日會有多種預計扣款日
  DELETE ECS.RSP_EXPDATE_TEMP;  -- 因為同一個tran 暫存檔會累積，故而刪除

  INSERT INTO ECS.RSP_EXPDATE_TEMP
    (DATA_SEQ,FUND_NO,AC_DAY,MSGID,
     TX_CALENDAR_CODE,CUT_OFF,LAUNCH_DATE,SALES_DATE,CLEAR_DATE,ELIMINATION_DATE)
  SELECT  ROWNUM,A.FUND_NO,A.AC_DAY,DECODE(B.FUND_NO,NULL,'X001',NULL)
         ,B.TX_CALENDAR_CODE --行事曆類別   
         -- 2020.04.29 Chengyu 調整 交易截止時限 抓取方式
         ,TO_DATE('1900/01/01 '|| TO_CHAR(B.EC_PUR_CUT_OFF,'HH24:MI:SS'),'YYYY/MM/DD HH24:MI:SS')   --交易截止時限  
         ,B.LAUNCH_DATE      --開始募集日   
         ,B.SALES_DATE       --開賣日     
         ,B.CLEAR_DATE       --停止交易日   
         ,B.ELIMINATION_DATE --販售終止日   
    FROM (SELECT VALUE1 FUND_NO,VALUE2 AC_DAY
                    FROM TABLE(ECS.F_FormatStringListToTable(WFUND_ACDAY))
         ) A
    LEFT JOIN FAS.FUND B 
      ON B.FUND_NO = A.FUND_NO;

  FOR TEMPA IN (SELECT * FROM ECS.RSP_EXPDATE_TEMP
                 WHERE MSGID IS NULL) LOOP
    --變數初始化
    XCHECK      := '';
    XIS_SUCCESS := '';
    XRCV_DATE   := 0;
    XCHECK_BUS  := 0;

    --檢查是否能在FAS.CALENDAR取得資料
    BEGIN
      SELECT DISTINCT CALENDAR_CODE
        INTO XCHECK
        FROM FAS.CALENDAR
       WHERE CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN 
        XIS_SUCCESS := 'N';
    END;

    IF XIS_SUCCESS = 'N' THEN
      UPDATE ECS.RSP_EXPDATE_TEMP
         SET  MSGID = 'T008'
             ,EXPECTED_TX_DATE = TO_DATE('1900/01/01','YYYY/MM/DD')
       WHERE DATA_SEQ = TEMPA.DATA_SEQ;
    ELSE
      --預計交易日期(XEXPECTED_TX_DATE)
      BEGIN
        --定額收件日期(判斷是否已超過交易截止時限)
        IF XAPPLY_TIME > TEMPA.CUT_OFF THEN
          XRCV_DATE := XAPPLY_DATE2 + 1;
        ELSE
          XRCV_DATE := XAPPLY_DATE2;
        END IF; 

        --前置交易日期
        IF TEMPA.AC_DAY < XRCV_DATE THEN
          --次一月的指定扣款日
          IF LENGTH(TEMPA.AC_DAY) = 1 THEN
            XPRU_TX_DATE := TO_DATE(TO_CHAR(ADD_MONTHS(XAPPLY_DATE,1),'YYYY/MM') || '0' || TEMPA.AC_DAY ,'YYYY/MM/DD');
          ELSE
            XPRU_TX_DATE := TO_DATE(TO_CHAR(ADD_MONTHS(XAPPLY_DATE,1),'YYYY/MM') || TEMPA.AC_DAY ,'YYYY/MM/DD');
          END IF;       
        ELSE
          --申請年月的指定扣款日
          IF LENGTH(TEMPA.AC_DAY) = 1 THEN
            XPRU_TX_DATE := TO_DATE(TO_CHAR(XAPPLY_DATE,'YYYY/MM') || '0' || TEMPA.AC_DAY ,'YYYY/MM/DD');
          ELSE
            XPRU_TX_DATE := TO_DATE(TO_CHAR(XAPPLY_DATE,'YYYY/MM') || TEMPA.AC_DAY ,'YYYY/MM/DD');
          END IF;        
        END IF;

        XEXPECTED_TX_DATE := XPRU_TX_DATE;

        --判斷XPRU_TX_DATE是否為營業日
        SELECT COUNT(HOLIDAY)
          INTO XCHECK_BUS
          FROM FAS.CALENDAR
         WHERE HOLIDAY = XEXPECTED_TX_DATE
           AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;          

        --不是營業日則找大於PRU_TX_DATE的下一個營業日
        WHILE XCHECK_BUS = 1 LOOP
          XEXPECTED_TX_DATE := XEXPECTED_TX_DATE+1;

          SELECT COUNT(HOLIDAY)
            INTO XCHECK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XEXPECTED_TX_DATE
            AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;
        END LOOP;         

        --若『預計交易日期(@EXPECTED_TX_DATE)』小於『開始募集日(@LAUNCH_DATE) 』時，表示要重新取得『預計交易日期(@EXPECTED_TX_DATE)』
        IF XEXPECTED_TX_DATE < TEMPA.LAUNCH_DATE THEN
          XEXPECTED_TX_DATE := TEMPA.LAUNCH_DATE;
          --判斷TEMPA.LAUNCH_DATE是否為營業日
          SELECT COUNT(HOLIDAY)
            INTO XCHECK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XEXPECTED_TX_DATE
             AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;

          --不是營業日則找大於TEMPA.LAUNCH_DATE的營業日
          WHILE XCHECK_BUS = 1 LOOP
            XEXPECTED_TX_DATE := XEXPECTED_TX_DATE+1;

            SELECT COUNT(HOLIDAY)
              INTO XCHECK_BUS
              FROM FAS.CALENDAR
             WHERE HOLIDAY = XEXPECTED_TX_DATE
              AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;
          END LOOP;
        END IF; --IF XEXPECTED_TX_DATE < TEMPA.LAUNCH_DATE

        --若『預計交易日期(@EXPECTED_TX_DATE)』小於『開賣日(@SALES_DATE) 』時，表示要重新取得『預計交易日期(@EXPECTED_TX_DATE)』
        IF XEXPECTED_TX_DATE < TEMPA.SALES_DATE THEN
          XEXPECTED_TX_DATE := TEMPA.SALES_DATE;
          --判斷TEMPA.SALES_DATE是否為營業日
          SELECT COUNT(HOLIDAY)
            INTO XCHECK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XEXPECTED_TX_DATE
            AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;

          --不是營業日則找大於TEMPA.SALES_DATE的營業日
          WHILE XCHECK_BUS = 1 LOOP
            XEXPECTED_TX_DATE := XEXPECTED_TX_DATE+1;

            SELECT COUNT(HOLIDAY)
              INTO XCHECK_BUS
              FROM FAS.CALENDAR
             WHERE HOLIDAY = XEXPECTED_TX_DATE
              AND CALENDAR_CODE = TEMPA.TX_CALENDAR_CODE;
          END LOOP;
        END IF; --IF XEXPECTED_TX_DATE < TEMPA.SALES_DATE     
      END;
    END IF; --IF XIS_SUCCESS = 'N'

    --若『預計交易日期(@EXPECTED_TX_DATE)』大於『停止交易日(@CLEAR_DATE)』且『停止交易日(@CLEAR_DATE)』不為空白時，則回傳錯誤代碼T009
    IF XEXPECTED_TX_DATE > TEMPA.CLEAR_DATE AND TEMPA.CLEAR_DATE IS NOT NULL THEN
      UPDATE ECS.RSP_EXPDATE_TEMP
         SET  MSGID = 'T009'
             ,EXPECTED_TX_DATE = TO_DATE('1900/01/01','YYYY/MM/DD')
       WHERE DATA_SEQ = TEMPA.DATA_SEQ;
    --若『預計交易日期(@EXPECTED_TX_DATE)』大於『販售終止日(@ELIMINATION_DATE)』且『販售終止日(@ELIMINATION_DATE)』不為空白時，則回傳錯誤代碼T010
    ELSIF XEXPECTED_TX_DATE > TEMPA.ELIMINATION_DATE AND TEMPA.ELIMINATION_DATE IS NOT NULL THEN
      UPDATE ECS.RSP_EXPDATE_TEMP
         SET  MSGID = 'T010'
             ,EXPECTED_TX_DATE = TO_DATE('1900/01/01','YYYY/MM/DD')
       WHERE DATA_SEQ = TEMPA.DATA_SEQ;
    ELSE 
      UPDATE ECS.RSP_EXPDATE_TEMP
         SET EXPECTED_TX_DATE = XEXPECTED_TX_DATE
       WHERE DATA_SEQ = TEMPA.DATA_SEQ;
    END IF;
  END LOOP;

  OPEN OUTDT FOR
    SELECT  A.FUND_NO --基金代碼
           -- 2019.04.17 JIANXIN MOD 修改同一基金但不同扣款日會有多種預計扣款日
           ,A.AC_DAY  -- 扣款日
           ,A.EXPECTED_TX_DATE --預計交易日期
           ,DECODE(A.MSGID,NULL,'Y','N') IS_SUCCESS --取得資料成功否
           ,DECODE(A.MSGID,NULL,'',DECODE(B.MSGTYPE,NULL,'3',B.MSGTYPE)) WARNS_TYPE   --警示方式
           ,DECODE(A.MSGID,NULL,'',DECODE(B.MSGCONTENT,NULL,A.FUND_NO||'無法取得基金基本資料，請檢查！',B.MSGCONTENT)) ERROR_MSG --錯誤訊息
      FROM ECS.RSP_EXPDATE_TEMP A
      LEFT JOIN ECS.MSGINFO B
        ON B.MSGID = A.MSGID;

END s_GetRspExpectedDate;

/

  GRANT EXECUTE ON "ECS"."S_GETRSPEXPECTEDDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETRSPQUERY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETRSPQUERY" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/04
-- Description: 取得定期(不)定額契約列表
-- 2018.06.12 ChengYu 傳入參數WSTATUS(契約狀態(多筆))對應
-- 2018.07.11 JIANXIN 將基金代碼等於空白視於全部
-- 2018.07.26 JIANXIN 調整RSP取得條件
-- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
-- 2018.08.20 ChengYu 回傳欄位增加欄位 境內外識別碼
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.09.26 YungLong 新增輸出欄位 開放網路定額變更、開放網路不定額變更
-- 2018.10.04 tingting 1.增加查詢書面定額、書面不定額資料 2.增加傳出欄位：風險屬性、最新淨值日期、最新淨值 3.移除傳出欄位：異動日期
-- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)、
--                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
-- 2018.11.09 PEN MOD 調整網路定額、網路不定額 累計扣款成功次數 的判斷方式
-- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
-- 2018.11.29 ChengYu 新增欄位預計交易日期、銀行戶名、契約型態、契約型態名稱、契約型態、契約型態名稱
-- 2018.11.30 ChengYu 修正書面定額銀行簡稱
-- 2018.12.03 tingting 修正書面定額是否可異動契約 欄位抓取錯誤
-- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
-- 2018.12.10 tingting 修正不定額是否可異動契約 欄位抓取錯誤
-- 2018.12.10 JIANXIN MOD BY 修正書面不定額不可異動契約控制
-- 2019.02.18 yunchu 排除已清算基金
-- 2019.04.12 tingting 調整銷售狀態(SALES_TYPE) = 1 暫停銷售也要顯示
-- 2021.06.03 JIANXIN 調整 臨櫃契約手續費率 需要*100
-- 2022.04.26 JIANXIN 新增AML 狀態判斷
-- 2022.05.11 JIANXIN 新增AML 狀態Redeem Only 不可以恢復契約
-- =============================================
(
    WACCOUNT_NO               INTEGER,                     -- 受益人戶號
    WFUND_NO                  VARCHAR2,                    -- 基金代碼
    WSTATUS                   VARCHAR2,                    -- 契約狀態(4:有效,7:暫停扣款)
    OUTDT                     OUT SYS_REFCURSOR,           -- RspList
    OUTDT2                    OUT SYS_REFCURSOR            -- DrspList
) IS

XID VARCHAR2(10);     -- 受益人ID
XFUND_NO VARCHAR2(5); -- 基金代碼
-- 2022.04.26 JIANXIN 新增AML 狀態判斷
XAML_STATUS VARCHAR2(1);     -- 帳戶狀態\D:Dormant：無法進行所有交易、R:Redeem Only：客戶僅能買回，無法進行新申購、A:Active：正常交易
-- 2019.02.18 yunchu 排除已清算基金
XSYSDATE DATE := SYSDATE;

BEGIN

  BEGIN

  -- 取受益人ID
  SELECT ID,AML_STATUS
    INTO XID,XAML_STATUS
    FROM FAS.HOLDER
   WHERE ACCOUNT_NO = WACCOUNT_NO;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
       RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
  END;

  /*
  BEGIN

  -- 取基金代碼
   SELECT FUND.FUND_NO
      INTO XFUND_NO
      FROM FAS.FUND FUND
     WHERE FUND.FUND_NO = WFUND_NO;

    EXCEPTION
         WHEN NO_DATA_FOUND THEN
         BEGIN
           RAISE_APPLICATION_ERROR(-20000, 'FUND_NO：'||WFUND_NO||' 無法取得基金代碼，請檢查！');
         END;
  END;
  */

  OPEN OUTDT FOR
       -- 書面定額
       -- 2018.10.04 tingting 1.增加查詢書面定額、書面不定額資料 2.增加傳出欄位：風險屬性、最新淨值日期、最新淨值 3.移除傳出欄位：異動日期
       SELECT '1' AS RSP_SOURCE                                   -- 契約來源
              ,'臨櫃' AS RSP_SOURCE_NAME                          -- 契約來源名稱
              ,'2' AS RSP_TYPE                                    -- 契約型態
              ,'定期定額' AS RSP_TYPE_NAME                        -- 契約型態名稱
              ,RSP.ID_SEQ                                         -- 契約序號
              ,FUND.FUND_CATEGORY                                 -- 境內外識別碼
              ,ECS_OPTION_O19.DISPLAY_NAME AS FUND_CATEGORY_NAME  -- 境內外識別碼名稱
              ,RSP.FUND_NO                                        -- 基金代碼
              -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME           -- 基金名稱
              ,FUND.SHARE_CLASS                                   -- 基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME          -- 基金級別名稱
              ,FUND.CURRENCY_NO                                   -- 計價幣別代碼
              ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME            -- 計價幣別名稱
              ,FUND.RISK_CATEGORY                                 -- 風險屬性
              ,NULL NAV_DATE                                      -- 最新淨值日期(回到程式再呼叫API014：GetNav取值)
              ,NULL NAV                                           -- 最新淨值(回到程式再呼叫API014：GetNav取值)
              ,RSP.AC_DAY                                         -- 每月扣款日
              ,RSP.AMOUNT                                         -- 扣款金額
              ,RSP.CURRENCY_NO AS TRADE_CRNCY                     -- 申購幣別
              ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM            -- 申購幣別名稱
              ,RSP.AC_BANK AS BANK_NO                             -- 扣款總行代碼
              ,RSP.BRANCH_NO                                      -- 扣款分行代碼
              ,FIS_BRANCH.SNAME AS BANK_SNAME                     -- 扣款銀行簡稱
              ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5   -- 往來帳號後5碼
              ,RSP.STATUS                                         -- 契約狀態
              ,RSP_STATUS.NAME AS STATUS_NAME                     -- 契約狀態名稱
              -- 2018.12.03 tingting 修正書面定額是否可異動契約 欄位抓取錯誤
              -- 2022.04.26 JIANXIN 新增AML 狀態判斷
              -- 2022.05.11 JIANXIN 新增AML 狀態Redeem Only 不可以恢復契約
              ,CASE WHEN FUND.RSP_CHANGE = 'Y' AND XAML_STATUS <> 'D' THEN 'Y'
                    ELSE 'N'
                    END AS IS_CHANGE                              -- 是否可異動契約
              ,CASE WHEN FUND.RSP_CHANGE = 'Y' AND XAML_STATUS <> 'D' AND RSP.STATUS = '4'  THEN 'Y'
                    ELSE 'N'
                    END AS IS_STOP                                -- 是否可暫停契約
              ,CASE WHEN FUND.RSP_CHANGE = 'Y' AND XAML_STATUS NOT IN ('D','R') AND RSP.STATUS = '7' THEN 'Y'
                    ELSE 'N'
                    END AS IS_RESTORE                             -- 是否可恢復契約
              -- 2021.06.03 JIANXIN 調整 臨櫃契約手續費率 需要*100
              ,RSP.SC_RATE * 100 AS SC_RATE                       -- 原始契約手續費率
              ,RSP.CONT_FAIL AS CONT_DISHONOR                     -- 連續扣款失敗次數
              ,SUCCESS_TIME_TB.SUCCESS_TIME                       -- 累計扣款成功次數
              ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL  -- 申購幣別小數位數
              ,'' AS FEE_CHOICE                                   -- 優惠方案
              ,RSP.PROJECT_CODE                                   -- 專案碼
              ,CAMPAIGN.CAMPAIGN_SHNM  AS PROJECT_NAME            -- 活動簡稱
              ,'' AS COUPON_ID                                    -- 優惠券號碼
              ,FUND.EC_RSP_UPDATE                                 -- 開放網路定額變更
              -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
              ,FUND.AMC_NO                                        -- 基金公司(排序用)
              ,FUND.SITCA_FUND_TYPE                               -- 投信顧公會基金類型(排序用)
              ,FUND.ORDINAL                                       -- 子基金排序(排序用)
              -- 2018.11.29 ChengYu 新增欄位預計交易日期、銀行戶名、契約型態、契約型態名稱
              ,RSP.BEGIN_TRANS_DAY AS EXPECTED_TX_DATE            -- 開始扣款日
              ,RSP.AC_NAME                                        -- 銀行戶名
         FROM FAS.PERIODIC RSP                           -- 書面定額資料
         LEFT JOIN FAS.FUND FUND                         -- 基金主檔
           ON FUND.FUND_NO = RSP.FUND_NO
         LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS -- 基金級別檔
           ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND    -- 基金幣別(View)(計價幣別)
           ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP     -- 基金幣別(View)(申購幣別)
           ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
         LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH             -- 銀行分行
           ON FIS_BRANCH.BANK_NO = RSP.AC_BANK
         -- 2018.11.30 ChengYu 修正書面定額銀行簡稱
          AND FIS_BRANCH.BRANCH_NO = RSP.AC_BRANCH
         LEFT JOIN FAS.RSP_STATUS RSP_STATUS             -- RSP狀態
           ON RSP_STATUS.STATUS = RSP.STATUS
         LEFT JOIN ECS.CAMPAIGN                          -- 預約開戶資料
           ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         LEFT JOIN ECS.ECS_OPTION ECS_OPTION_O19         -- 取境內外識別碼名稱
           ON ECS_OPTION_O19.SOURCE_TYPE = '019'
          AND ECS_OPTION_O19.TEXT_VALUE = FUND.FUND_CATEGORY
         LEFT JOIN (SELECT  PERIODIC_PURCHASE.ID
                           ,PERIODIC_PURCHASE.ID_SEQ
                           ,COUNT(PERIODIC_PURCHASE.ID) AS SUCCESS_TIME
                      FROM FAS.PERIODIC_PURCHASE PERIODIC_PURCHASE -- 書面定額申購資料
                     WHERE PERIODIC_PURCHASE.RESULT_CODE = '00'    -- 00:成功
                     GROUP BY PERIODIC_PURCHASE.ID,PERIODIC_PURCHASE.ID_SEQ
                   ) SUCCESS_TIME_TB
           ON SUCCESS_TIME_TB.ID = RSP.ID
          AND SUCCESS_TIME_TB.ID_SEQ = RSP.ID_SEQ
         JOIN (SELECT REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) AS STATUS
                 FROM DUAL
              CONNECT BY REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) IS NOT NULL
              )TB_STATUS
           ON TB_STATUS.STATUS = RSP.STATUS
        WHERE RSP.ID = XID
          AND (RSP.FUND_NO = WFUND_NO OR WFUND_NO IS NULL)
          AND RSP.PRODUCT_TYPE = 'P1'      --P1:定期定額 P2:五年儲蓄計畫 P3:定期不定額 P8:網路定額 P9:網路不定額
          -- 2019.02.18 yunchu 排除已清算基金
          -- 2019.04.12 tingting 調整銷售狀態(SALES_TYPE) = 1 暫停銷售也要顯示
          AND FUND.SALES_TYPE IN ('0', '1') --0 正常 1 暫停銷售 2 未開賣
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
       UNION ALL
       -- 網路定額
       SELECT '2' AS RSP_SOURCE                                   -- 契約來源
              ,'網路' AS RSP_SOURCE_NAME                          -- 契約來源名稱
              ,'2' AS RSP_TYPE                                    -- 契約型態
              ,'定期定額' AS RSP_TYPE_NAME                        -- 契約型態名稱
              ,RSP.ID_SEQ                                         -- 契約序號
              -- 2018.08.20 ChengYu 回傳欄位增加欄位 境內外識別碼
              ,FUND.FUND_CATEGORY                                 -- 境內外識別碼
              ,ECS_OPTION_O19.DISPLAY_NAME AS FUND_CATEGORY_NAME  -- 境內外識別碼名稱
              ,RSP.FUND_NO                                        -- 基金代碼
              -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME           -- 基金名稱
              ,FUND.SHARE_CLASS                                   -- 基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME          -- 基金級別名稱
              ,FUND.CURRENCY_NO                                   -- 計價幣別代碼
              ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME            -- 計價幣別名稱
              -- 2018.10.04 tingting 1.增加查詢書面定額、書面不定額資料 2.增加傳出欄位：風險屬性、最新淨值日期、最新淨值 3.移除傳出欄位：異動日期
              ,FUND.RISK_CATEGORY                                 -- 風險屬性
              ,NULL NAV_DATE                                      -- 最新淨值日期(回到程式再呼叫API014：GetNav取值)
              ,NULL NAV                                           -- 最新淨值(回到程式再呼叫API014：GetNav取值)
              ,RSP.AC_DAY                                         -- 每月扣款日
              ,RSP.AMOUNT                                         -- 扣款金額
              ,RSP.CURRENCY_NO AS TRADE_CRNCY                     -- 申購幣別
              ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM            -- 申購幣別名稱
              ,RSP.BANK_NO                                        -- 扣款總行代碼
              ,RSP.BRANCH_NO                                      -- 扣款分行代碼
              ,FIS_BRANCH.SNAME AS BANK_SNAME                     -- 扣款銀行簡稱
              -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
              ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5   -- 往來帳號後5碼
              ,RSP.STATUS                                         -- 契約狀態
              ,RSP_STATUS.NAME AS STATUS_NAME                     -- 契約狀態名稱
              -- 2022.04.26 JIANXIN 新增AML 狀態判斷
              -- 2022.05.11 JIANXIN 新增AML 狀態Redeem Only 不可以恢復契約
              ,CASE WHEN FUND.EC_RSP_UPDATE = 'Y' AND XAML_STATUS <> 'D' THEN 'Y'
                    ELSE 'N'
                    END AS IS_CHANGE                              -- 是否可異動契約
              ,CASE WHEN FUND.EC_RSP_UPDATE = 'Y' AND XAML_STATUS <> 'D' AND RSP.STATUS = '4'  THEN 'Y'
                    ELSE 'N'
                    END AS IS_STOP                                -- 是否可暫停契約
              ,CASE WHEN FUND.EC_RSP_UPDATE = 'Y' AND XAML_STATUS NOT IN ('D','R') AND RSP.STATUS = '7' THEN 'Y'
                    ELSE 'N'
                    END AS IS_RESTORE                             -- 是否可恢復契約
              ,RSP.SC_RATE                                        -- 原始契約手續費率
              ,EC_RSP.CONT_DISHONOR                               -- 連續扣款失敗次數
              ,SUCCESS_TIME_TB.SUCCESS_TIME                       -- 累計扣款成功次數
              ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL  -- 申購幣別小數位數
              -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
              ,RSP.FEE_CHOICE                                     -- 優惠方案
              ,RSP.PROJECT_CODE                                   -- 專案碼
              ,CAMPAIGN.CAMPAIGN_SHNM  AS PROJECT_NAME            -- 活動簡稱
              ,RSP.COUPON_ID                                      -- 優惠券號碼
              -- 2018.09.26 YungLong 新增輸出欄位 開放網路定額變更
              ,FUND.EC_RSP_UPDATE                                 -- 開放網路定額變更
              -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
              ,FUND.AMC_NO                                        -- 基金公司(排序用)
              ,FUND.SITCA_FUND_TYPE                               -- 投信顧公會基金類型(排序用)
              ,FUND.ORDINAL                                       -- 子基金排序(排序用)
              -- 2018.11.29 ChengYu 新增欄位預計交易日期、銀行戶名、契約型態、契約型態名稱
              ,RSP.EXPECTED_TX_DATE AS EXPECTED_TX_DATE           -- 預計交易日期
              ,RSP.AC_NAME                                        -- 銀行戶名
         FROM ECS.RSP RSP                                -- EC定額
         LEFT JOIN FAS.FUND FUND                         -- 基金主檔
           ON FUND.FUND_NO = RSP.FUND_NO
         LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS -- 基金級別檔
           ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND    -- 基金幣別(View)(計價幣別)
           ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP     -- 基金幣別(View)(申購幣別)
           ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
         LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH             -- 銀行分行
           ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
          AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
         LEFT JOIN FAS.RSP_STATUS RSP_STATUS             -- RSP狀態
           ON RSP_STATUS.STATUS = RSP.STATUS
         LEFT JOIN FAS.EC_RSP EC_RSP                     -- 後台EC RSP契約資料
           ON EC_RSP.ID = RSP.ID
          AND EC_RSP.ID_SEQ = RSP.ID_SEQ
         LEFT JOIN ECS.CAMPAIGN                          -- 預約開戶資料
           ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         LEFT JOIN ECS.ECS_OPTION ECS_OPTION_O19         -- 取境內外識別碼名稱
           ON ECS_OPTION_O19.SOURCE_TYPE = '019'
          AND ECS_OPTION_O19.TEXT_VALUE = FUND.FUND_CATEGORY
         -- 2018.07.26 JIANXIN 調整RSP取得條件
         LEFT JOIN (SELECT  EC_RSP_PURCHASE.ID
                           ,EC_RSP_PURCHASE.ID_SEQ
                           ,COUNT(EC_RSP_PURCHASE.ID) AS SUCCESS_TIME
                      FROM FAS.EC_RSP_PURCHASE EC_RSP_PURCHASE   -- EC(不)定額申購資料
                     WHERE EC_RSP_PURCHASE.RESULT_CODE = '00'    -- 00:成功
                       -- 2018.11.09 PEN MOD 調整網路定額、網路不定額 累計扣款成功次數 的判斷方式
                       AND EC_RSP_PURCHASE.STATUS = 'P'          -- P:已結帳
                     GROUP BY EC_RSP_PURCHASE.ID,EC_RSP_PURCHASE.ID_SEQ
                   ) SUCCESS_TIME_TB
           ON SUCCESS_TIME_TB.ID = RSP.ID
          AND SUCCESS_TIME_TB.ID_SEQ = RSP.ID_SEQ
         -- 2018.06.12 ChengYu 傳入參數WSTATUS(契約狀態(多筆))對應
         JOIN (SELECT REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) AS STATUS
                 FROM DUAL
              CONNECT BY REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) IS NOT NULL
              )TB_STATUS
           ON TB_STATUS.STATUS = RSP.STATUS
        WHERE RSP.ID = XID
          -- 2018.07.11 JIANXIN 將基金代碼等於空白視於全部
          AND (RSP.FUND_NO = WFUND_NO OR WFUND_NO IS NULL)
          AND RSP.PRODUCT_TYPE = 'P8'       --P1:定期定額 P2:五年儲蓄計畫 P3:定期不定額 P8:網路定額 P9:網路不定額
          -- 2019.02.18 yunchu 排除已清算基金
          -- 2019.04.12 tingting 調整銷售狀態(SALES_TYPE) = 1 暫停銷售也要顯示
          AND FUND.SALES_TYPE IN ('0', '1') --0 正常 1 暫停銷售 2 未開賣
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
        -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
        --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
        ORDER BY FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS NULLS FIRST, ORDINAL, 
                 STATUS, AC_DAY, ID_SEQ;

  OPEN OUTDT2 FOR
       -- 書面不定額
       -- 2018.10.04 tingting 1.增加查詢書面定額、書面不定額資料 2.增加傳出欄位：風險屬性、最新淨值日期、最新淨值 3.移除傳出欄位：異動日期
       SELECT  '1' AS RSP_SOURCE                                  -- 契約來源
              ,'臨櫃' AS RSP_SOURCE_NAME                          -- 契約來源名稱
              ,'3' AS RSP_TYPE                                    -- 契約型態
              ,'定期不定額' AS RSP_TYPE_NAME                      -- 契約型態名稱
              ,RSP.ID_SEQ                                         -- 契約序號
              ,FUND.FUND_CATEGORY                                 -- 境內外識別碼
              ,ECS_OPTION_019.DISPLAY_NAME AS FUND_CATEGORY_NAME  -- 境內外識別碼名稱
              ,RSP.FUND_NO                                        -- 基金代碼
              -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME           -- 基金名稱
              ,FUND.SHARE_CLASS                                   -- 基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME          -- 基金級別名稱
              ,FUND.CURRENCY_NO                                   -- 計價幣別代碼
              ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME            -- 計價幣別名稱
              ,FUND.RISK_CATEGORY                                 -- 風險屬性
              ,NULL NAV_DATE                                      -- 最新淨值日期(回到程式再呼叫API014：GetNav取值)
              ,NULL NAV                                           -- 最新淨值(回到程式再呼叫API014：GetNav取值)
              ,RSP.AC_DAY                                         -- 每月扣款日
              ,RSP.AMOUNT                                         -- 扣款金額
              ,RSP.CURRENCY_NO AS TRADE_CRNCY                     -- 申購幣別
              ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM            -- 申購幣別名稱
              ,RSP.AC_BANK AS BANK_NO                             -- 扣款總行代碼
              ,RSP.BRANCH_NO                                      -- 扣款分行代碼
              ,FIS_BRANCH.SNAME AS BANK_SNAME                     -- 扣款銀行簡稱
              ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5   -- 往來帳號後5碼
              ,RSP.STATUS                                         -- 契約狀態
              ,RSP_STATUS.NAME AS STATUS_NAME                     -- 契約狀態名稱
              -- 2018.12.10 tingting 修正不定額是否可異動契約 欄位抓取錯誤
              ,'N' IS_CHANGE                                      -- 是否可異動契約
              ,'N' IS_STOP                                        -- 是否可暫停契約
              ,'N' IS_RESTORE                                     -- 是否可恢復契約
              ,RSP.SC_RATE                                        -- 原始契約手續費率
              ,RSP.CONT_FAIL AS CONT_DISHONOR                     -- 連續扣款失敗次數
              ,SUCCESS_TIME_TB.SUCCESS_TIME                       -- 累計扣款成功次數
              ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL  -- 申購幣別小數位數
              ,0 RAISE_ROI                                        -- 加碼點(%)
              ,RSP.RAISE_AMOUNT                                   -- 加碼金額
              ,0 REDUCE_ROI                                       -- 減碼點(%)
              ,0 REDUCE_AMOUNT                                    -- 減碼金額
              ,'' AS FEE_CHOICE                                   -- 優惠方案
              ,RSP.PROJECT_CODE                                   -- 專案碼
              ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME             -- 活動簡稱
              ,'' AS COUPON_ID                                    -- 優惠券號碼
              ,'N' AS EC_DRSP_UPDATE                              -- 開放網路不定額變更
              -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
              ,FUND.AMC_NO                                        -- 基金公司(排序用)
              ,FUND.SITCA_FUND_TYPE                               -- 投信顧公會基金類型(排序用)
              ,FUND.ORDINAL                                       -- 子基金排序(排序用)
              -- 2018.11.29 ChengYu 新增欄位預計交易日期、銀行戶名、契約型態、契約型態名稱
              ,RSP.BEGIN_TRANS_DAY AS EXPECTED_TX_DATE            -- 開始扣款日
              ,RSP.AC_NAME                                        -- 銀行戶名
         FROM FAS.PERIODIC RSP                           -- 書面定額資料
         LEFT JOIN FAS.FUND FUND                         -- 基金主檔
           ON FUND.FUND_NO = RSP.FUND_NO
         LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS -- 基金級別檔
           ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND    -- 基金幣別(View)(計價幣別)
           ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP     -- 基金幣別(View)(申購幣別)
           ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
         LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH             -- 銀行分行
         -- 2018.11.30 ChengYu 修正書面定額銀行簡稱
           ON FIS_BRANCH.BANK_NO = RSP.AC_BANK
          AND FIS_BRANCH.BRANCH_NO = RSP.AC_BRANCH
         LEFT JOIN FAS.RSP_STATUS RSP_STATUS             -- RSP狀態
           ON RSP_STATUS.STATUS = RSP.STATUS
         LEFT JOIN ECS.CAMPAIGN                          -- 預約開戶資料
           ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE  
         LEFT JOIN ECS.ECS_OPTION ECS_OPTION_019         -- 取境內外識別碼名稱
           ON ECS_OPTION_019.SOURCE_TYPE = '019'
          AND ECS_OPTION_019.TEXT_VALUE = FUND.FUND_CATEGORY
         LEFT JOIN (SELECT  PERIODIC_PURCHASE.ID
                           ,PERIODIC_PURCHASE.ID_SEQ
                           ,COUNT(PERIODIC_PURCHASE.ID) AS SUCCESS_TIME
                      FROM FAS.PERIODIC_PURCHASE PERIODIC_PURCHASE -- 書面定額申購資料
                     WHERE PERIODIC_PURCHASE.RESULT_CODE = '00'    -- 00:成功
                     GROUP BY PERIODIC_PURCHASE.ID,PERIODIC_PURCHASE.ID_SEQ
                   ) SUCCESS_TIME_TB
           ON SUCCESS_TIME_TB.ID = RSP.ID
          AND SUCCESS_TIME_TB.ID_SEQ = RSP.ID_SEQ
         JOIN (SELECT  REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) AS STATUS
                 FROM DUAL
              CONNECT BY REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) IS NOT NULL
              )TB_STATUS
           ON TB_STATUS.STATUS = RSP.STATUS
        WHERE RSP.ID = XID
          AND (RSP.FUND_NO = WFUND_NO OR WFUND_NO IS NULL)
          AND RSP.PRODUCT_TYPE = 'P3'      --P1:定期定額 P2:五年儲蓄計畫 P3:定期不定額 P8:網路定額 P9:網路不定額
          -- 2019.02.18 yunchu 排除已清算基金
          -- 2019.04.12 tingting 調整銷售狀態(SALES_TYPE) = 1 暫停銷售也要顯示
          AND FUND.SALES_TYPE IN ('0', '1') --0 正常 1 暫停銷售 2 未開賣
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
       UNION ALL
       -- 網路不定額
       SELECT  '2' AS RSP_SOURCE                                  -- 契約來源
              ,'網路' AS RSP_SOURCE_NAME                          -- 契約來源名稱
              ,'3' AS RSP_TYPE                                    -- 契約型態
              ,'定期不定額' AS RSP_TYPE_NAME                      -- 契約型態名稱
              ,RSP.ID_SEQ                                         -- 契約序號
              -- 2018.08.20 ChengYu 回傳欄位增加欄位 境內外識別碼
              ,FUND.FUND_CATEGORY                                 -- 境內外識別碼
              ,ECS_OPTION_019.DISPLAY_NAME AS FUND_CATEGORY_NAME  -- 境內外識別碼名稱
              ,RSP.FUND_NO                                        -- 基金代碼
              -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME           -- 基金名稱
              ,FUND.SHARE_CLASS                                   -- 基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME          -- 基金級別名稱
              ,FUND.CURRENCY_NO                                   -- 計價幣別代碼
              ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME            -- 計價幣別名稱
              -- 2018.10.04 tingting 1.增加查詢書面定額、書面不定額資料 2.增加傳出欄位：風險屬性、最新淨值日期、最新淨值 3.移除傳出欄位：異動日期
              ,FUND.RISK_CATEGORY                                 -- 風險屬性
              ,NULL NAV_DATE                                      -- 最新淨值日期(回到程式再呼叫API014：GetNav取值)
              ,NULL NAV                                           -- 最新淨值(回到程式再呼叫API014：GetNav取值)
              ,RSP.AC_DAY                                         -- 每月扣款日
              ,RSP.AMOUNT                                         -- 扣款金額
              ,RSP.CURRENCY_NO AS TRADE_CRNCY                     -- 申購幣別
              ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM            -- 申購幣別名稱
              ,RSP.BANK_NO                                        -- 扣款總行代碼
              ,RSP.BRANCH_NO                                      -- 扣款分行代碼
              ,FIS_BRANCH.SNAME AS BANK_SNAME                     -- 扣款銀行簡稱
              -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
              ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5   -- 往來帳號後5碼
              ,RSP.STATUS                                         -- 契約狀態
              ,RSP_STATUS.NAME AS STATUS_NAME                     -- 契約狀態名稱
              -- 2018.12.10 tingting 修正不定額是否可異動契約 欄位抓取錯誤
              -- 2022.04.26 JIANXIN 新增AML 狀態判斷
              -- 2022.05.11 JIANXIN 新增AML 狀態Redeem Only 不可以恢復契約
              ,CASE WHEN FUND.EC_DRSP_UPDATE = 'Y' AND XAML_STATUS <> 'D' THEN 'Y'
                    ELSE 'N'
                    END AS IS_CHANGE                              -- 是否可異動契約
              ,CASE WHEN FUND.EC_DRSP_UPDATE = 'Y' AND XAML_STATUS <> 'D' AND RSP.STATUS = '4'  THEN 'Y'
                    ELSE 'N'
                    END AS IS_STOP                                -- 是否可暫停契約
              ,CASE WHEN FUND.EC_DRSP_UPDATE = 'Y' AND XAML_STATUS NOT IN ('D','R') AND RSP.STATUS = '7' THEN 'Y'
                    ELSE 'N'
                    END AS IS_RESTORE                             -- 是否可恢復契約
              ,RSP.SC_RATE                                        -- 原始契約手續費率
              ,EC_RSP.CONT_DISHONOR                               -- 連續扣款失敗次數
              ,SUCCESS_TIME_TB.SUCCESS_TIME                       -- 累計扣款成功次數
              ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL  -- 申購幣別小數位數
              -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
              ,RSP.RAISE_ROI * 100 AS RAISE_ROI                   -- 加碼點(%)
              ,RSP.RAISE_AMOUNT                                   -- 加碼金額
              -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
              ,RSP.REDUCE_ROI * 100 AS REDUCE_ROI                 -- 減碼點(%)
              ,RSP.REDUCE_AMOUNT                                  -- 減碼金額
              -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
              ,RSP.FEE_CHOICE                                     -- 優惠方案
              ,RSP.PROJECT_CODE                                   -- 專案碼
              ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME             -- 活動簡稱
              ,RSP.COUPON_ID                                      -- 優惠券號碼
              -- 2018.09.26 YungLong 新增輸出欄位 開放網路不定額變更
              ,FUND.EC_DRSP_UPDATE                                -- 開放網路不定額變更
              -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
              --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
              ,FUND.AMC_NO                                        -- 基金公司(排序用)
              ,FUND.SITCA_FUND_TYPE                               -- 投信顧公會基金類型(排序用)
              ,FUND.ORDINAL                                       -- 子基金排序(排序用)
              -- 2018.11.29 ChengYu 新增欄位預計交易日期、銀行戶名、契約型態、契約型態名稱
              ,RSP.EXPECTED_TX_DATE  AS EXPECTED_TX_DATE          -- 預計交易日期
              ,RSP.AC_NAME                                        -- 銀行戶名
         FROM ECS.RSP                                    -- EC定額
         LEFT JOIN FAS.FUND FUND                         -- 基金主檔
           ON FUND.FUND_NO = RSP.FUND_NO
         LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS -- 基金級別檔
           ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND    -- 基金幣別(View)(計價幣別)
           ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
         LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP     -- 基金幣別(View)(申購幣別)
           ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
         LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH             -- 銀行分行
           ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
          AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
         LEFT JOIN FAS.RSP_STATUS RSP_STATUS             -- RSP狀態
           ON RSP_STATUS.STATUS = RSP.STATUS
         LEFT JOIN FAS.EC_RSP EC_RSP                     -- 後台EC RSP契約資料
           ON EC_RSP.ID = RSP.ID
          AND EC_RSP.ID_SEQ = RSP.ID_SEQ
         LEFT JOIN ECS.CAMPAIGN                          -- 預約開戶資料
           ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE  
         LEFT JOIN ECS.ECS_OPTION ECS_OPTION_019         -- 取境內外識別碼名稱
           ON ECS_OPTION_019.SOURCE_TYPE = '019'
          AND ECS_OPTION_019.TEXT_VALUE = FUND.FUND_CATEGORY
         -- 2018.07.26 JIANXIN 調整RSP取得條件
         LEFT JOIN (SELECT  EC_RSP_PURCHASE.ID
                           ,EC_RSP_PURCHASE.ID_SEQ
                           ,COUNT(EC_RSP_PURCHASE.ID) AS SUCCESS_TIME
                      FROM FAS.EC_RSP_PURCHASE EC_RSP_PURCHASE   -- EC(不)定額申購資料
                     WHERE EC_RSP_PURCHASE.RESULT_CODE = '00'    -- 00:成功
                       -- 2018.11.09 PEN MOD 調整網路定額、網路不定額 累計扣款成功次數 的判斷方式
                       AND EC_RSP_PURCHASE.STATUS = 'P'          -- P:已結帳
                     GROUP BY EC_RSP_PURCHASE.ID,EC_RSP_PURCHASE.ID_SEQ
                   ) SUCCESS_TIME_TB
           ON SUCCESS_TIME_TB.ID = RSP.ID
          AND SUCCESS_TIME_TB.ID_SEQ = RSP.ID_SEQ
         -- 2018.06.12 ChengYu 傳入參數WSTATUS(契約狀態(多筆))對應
         JOIN (SELECT  REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) AS STATUS
                 FROM DUAL
              CONNECT BY REGEXP_SUBSTR(WSTATUS, '[^,]+', 1, LEVEL) IS NOT NULL
              )TB_STATUS
           ON TB_STATUS.STATUS = RSP.STATUS
        WHERE RSP.ID = XID
          -- 2018.07.11 JIANXIN 將基金代碼等於空白視於全部
          AND (RSP.FUND_NO = WFUND_NO OR WFUND_NO IS NULL)
          AND RSP.PRODUCT_TYPE = 'P9'       --P1:定期定額 P2:五年儲蓄計畫 P3:定期不定額 P8:網路定額 P9:網路不定額
          -- 2019.02.18 yunchu 排除已清算基金
          -- 2019.04.12 tingting 調整銷售狀態(SALES_TYPE) = 1 暫停銷售也要顯示
          AND FUND.SALES_TYPE IN ('0', '1') --0 正常 1 暫停銷售 2 未開賣
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
        -- 2018.10.23 tingting 調整排序：先依基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
        --                              再依契約排序規則(契約狀態(4:有效,7:暫停扣款)、每月扣款日、契約序號)
        ORDER BY FUND_CATEGORY, AMC_NO, SITCA_FUND_TYPE, ORDINAL, SHARE_CLASS NULLS FIRST, ORDINAL, 
                 STATUS, AC_DAY, ID_SEQ;

END s_GetRSPQuery;

/

  GRANT EXECUTE ON "ECS"."S_GETRSPQUERY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETRSPQUERYFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETRSPQUERYFUNDDATA" 
(
    WACCOUNT_NO               INTEGER,                     -- 受益人戶號
    OUTDT                     OUT SYS_REFCURSOR,           -- AllFundList
    OUTDT2                    OUT SYS_REFCURSOR            -- BFFundList
) IS

XID VARCHAR2(10);
-- 2019.02.15 yunchu 排除已清算基金
XSYSDATE DATE := SYSDATE;

BEGIN

  BEGIN

  SELECT ID             -- 受益人ID
    INTO XID
    FROM FAS.HOLDER
   WHERE ACCOUNT_NO = WACCOUNT_NO;

  EXCEPTION
     WHEN NO_DATA_FOUND THEN
       RAISE_APPLICATION_ERROR(-20000,
                               '無法取得受益人ID，請檢查！');
  END;

  -- 2018.06.12 ChengYu AllFundList、BFFundList加入排序、DISTINCT
  OPEN OUTDT FOR
       SELECT  FUND.FUND_NO             -- 基金代碼
              ,FUND.NAME AS FUND_NAME   -- 基金名稱
         FROM FAS.FUND -- 基金主檔
        WHERE FUND.IS_EC_PERIODIC = 'Y'
        -- 2019.02.15 yunchu 排除已清算基金
          AND FUND.SALES_TYPE = '0'
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
        ORDER BY FUND.FUND_NO;

  -- 2018.06.12 ChengYu AllFundList、BFFundList加入排序、DISTINCT
  OPEN OUTDT2 FOR
       SELECT DISTINCT RSP.FUND_NO      -- 基金代碼
              ,FUND.NAME AS FUND_NAME   -- 基金名稱
         FROM ECS.RSP            -- EC定額
         LEFT JOIN FAS.FUND FUND -- 基金主檔
           ON FUND.FUND_NO = RSP.FUND_NO
        WHERE RSP.ID = XID
        -- 2019.02.18 yunchu 依據戶號排除已清算基金
          AND FUND.SALES_TYPE = '0'
          AND (
                -- 境內基金清算日期判斷 CLEAR_DATE
                (     
                  FUND.FUND_CATEGORY = '1' 
                  AND  
                  (
                    (FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )              
             OR
                -- 境外基金清算日期判斷 ELIMINATION_DATE
                (     
                  FUND.FUND_CATEGORY = '2' 
                  AND  
                  (
                    (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                    OR 
                    (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                    OR 
                    (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
                  )
                )
              )
        ORDER BY RSP.FUND_NO;

END s_GetRspQueryFundData;

/

  GRANT EXECUTE ON "ECS"."S_GETRSPQUERYFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSHARECLASS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSHARECLASS" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/11/12
-- Description: 取得基金級別代碼
-- 2018.11.14 tingting 調整級別說明欄位取FUND.SHARE_CLASS(原FUND_SHARE_CLASS.NAME)
-- =============================================
(
    WIS_ALL         VARCHAR2,               -- 是否需要全部的選項
    OUTDT           OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS
BEGIN

    OPEN OUTDT FOR
    SELECT FUND_SHARE_CLASS.* 
      FROM (SELECT  DISTINCT 
                    FUND.SHARE_CLASS            --基金級別
                   -- 2018.11.14 tingting 調整級別說明欄位取FUND.SHARE_CLASS(原FUND_SHARE_CLASS.NAME)
                   --,FUND_SHARE_CLASS.NAME       --級別說明
                   ,FUND.SHARE_CLASS AS NAME    --級別說明
              FROM FAS.FUND                     --基金主檔
              LEFT JOIN ECS.FUND_SHARE_CLASS    --基金級別檔
                ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
               AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
             WHERE FAS.FUND.SHARE_CLASS IS NOT NULL
             UNION ALL
            SELECT  'ALL' AS SHARE_CLASS
                   ,'全部' AS NAME
              FROM DUAL
             WHERE WIS_ALL = 'Y'
           ) FUND_SHARE_CLASS
     ORDER BY DECODE(FUND_SHARE_CLASS.SHARE_CLASS,'ALL',1);

END s_GetShareClass;

/

  GRANT EXECUTE ON "ECS"."S_GETSHARECLASS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSHOPPINGCAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSHOPPINGCAR" 
(
    WSHOP_TYPE     VARCHAR2,               -- 購物車類別(1：單筆申購 2：定期定額 3：定期不定額)
    WFUND_NO       VARCHAR2,               -- 基金代碼
    WTX_DATE       DATE,                   -- 交易日期
    WBRANCH_NO     VARCHAR2,               -- 代銷單位
    WSER_NO        VARCHAR2,               -- 交易序號
    WID            VARCHAR2,               -- 受益人ID
    WID_SEQ        VARCHAR2,               -- 契約序號
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS

XBROKER_NO VARCHAR2(3):= '999' ;

BEGIN

  IF WSHOP_TYPE = '1' THEN

    OPEN OUTDT FOR
        -- 2018.11.01 tingting MOD BY 將購物車類別欄位，拆成購物車類別、購物車類別名稱
        SELECT WSHOP_TYPE AS SHOP_TYPE                     --購物車類別
              ,ECS_OPTION.DISPLAY_NAME AS  SHOP_TYPE_NAME  --購物車類別名稱
              ,FUND.ISIN_CODE                              --國際證券代碼
              ,PURCHASE.FUND_NO                            --基金代碼
              -- 2018.12.05 JIANXIN 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME    --基金名稱
              ,FUND.DIVIDEND_DESC AS FUND_MEMO             --基金警語
              ,FUND.SHARE_CLASS                            --基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME   --基金級別名稱
              ,FUND.CURRENCY_NO                            --計價幣別
              ,TX_CURRENCY.NAME AS CURRENCY_NAME           --計價幣別名稱
              ,PURCHASE.TX_DATE                            --交易日期
              ,PURCHASE.CURRENCY_NO AS TRADE_CRNCY         --申購幣別
              ,CURRENCY.NAME AS TRADE_CRNCY_NM             --申購幣別名稱
              ,PURCHASE.AMOUNT                             --申購金額
              -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
              --                     調整「生日優惠」名稱改為促銷活動的名稱
              ,CASE PURCHASE.FEE_CHOICE WHEN '1' THEN '全民大富翁' --沒有FAS.PROJECT 所以先寫死
                                        WHEN '2' THEN '優惠券' || PURCHASE.COUPON_ID
                                        WHEN '3' THEN '紅利折抵' || PURCHASE.USED_POINT || '點' || '，申購手續費：' || PURCHASE.SERVICE_CHARGE
                                        WHEN '4' THEN '全民大富翁' --沒有FAS.PROJECT 所以先寫死
                                        WHEN '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                                        ELSE '網路費率'
                                        END FEE_CHOICE     --手續費收取方式
              ,PURCHASE.SC_RATE                            --申購手續費率
              ,PURCHASE.SERVICE_CHARGE                     --申購手續費
              ,ROUND(PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE,V_FUND_CRNCY.AMT_DECIMAL) AS TOT_AMOUNT  --申購總金額
              ,PURCHASE.BANK_NO                                                                         --扣款總行代碼
              ,FIS_BRANCH.SNAME AS FIS_SNAME                                                            --扣款銀行簡稱
              -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
              ,ECS.FN_STUFF_STR(PURCHASE.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
              ,NULL AS AC_DAY                                                                           --每月扣款日
              ,NULL AS FIRST_TX_DATE                                                                    --預計首次扣款日
              ,NULL AS RAISE_ROI                                                                        --加碼點(%)
              ,NULL AS RAISE_AMOUNT                                                                     --加碼金額
              ,NULL AS REDUCE_ROI                                                                       --減碼點(%)
              ,NULL AS REDUCE_AMOUNT                                                                    --減碼金額
              ,V_FUND_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL                                            --申購幣別小數位數
              ,'A;' || PURCHASE.FUND_NO || ';'
                    || TO_CHAR(PURCHASE.TX_DATE,'yyyymmdd') || ';' 
                    || PURCHASE.BROKER_NO || ';' 
                    || PURCHASE.BRANCH_NO || ';' 
                    || PURCHASE.SER_NO AS ES_TX_NO                                                      --ES交易書號
              ,PURCHASE.ROBO_CONTRACT_NO                                                                --ROBO契約書號
              ,PURCHASE.ROBO_SER_NO                                                                     --ROBO交易書號
              -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
              ,PURCHASE.ROBO_BATCH_NO                                                                   --ROBO再平衡批次編號
              --2018.05.22 Jim 新增重送扣款次數
              ,PURCHASE.AC_CNT                                                                          --扣款重送次數
          FROM ECS.PURCHASE PURCHASE
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = PURCHASE.FUND_NO
          JOIN FAS.AMC AMC
            ON FUND.AMC_NO = AMC.AMC_NO
          JOIN ECS.V_FUND_CRNCY CURRENCY
            ON PURCHASE.CURRENCY_NO = CURRENCY.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY TX_CURRENCY
            ON TX_CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
            ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
           AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
          -- 2018.11.30 ChengYu 修正通知信銀行戶名顯示
          JOIN FAS.FIS_BRANCH FIS_BRANCH 
            ON FIS_BRANCH.BANK_NO = PURCHASE.BANK_NO
           -- 2018.12.03 ChengYu 修正單筆申購通知信
           AND FIS_BRANCH.BRANCH_NO = PURCHASE.AC_BRANCH
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
          LEFT JOIN ECS.ECS_OPTION ECS_OPTION
            ON SOURCE_TYPE = '022'
           AND TEXT_VALUE = WSHOP_TYPE
          -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
          --                     調整「生日優惠」名稱改為促銷活動的名稱
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN
            ON CAMPAIGN.CAMPAIGN_CODE = PURCHASE.PROJECT_CODE
         WHERE PURCHASE.FUND_NO = WFUND_NO
           AND PURCHASE.TX_DATE = TRUNC(WTX_DATE)
           AND PURCHASE.BROKER_NO = XBROKER_NO
           AND PURCHASE.BRANCH_NO = WBRANCH_NO
           AND PURCHASE.SER_NO = WSER_NO;

  ELSE

    OPEN OUTDT FOR
        -- 2018.11.01 tingting MOD BY 將購物車類別欄位，拆成購物車類別、購物車類別名稱
        SELECT WSHOP_TYPE AS SHOP_TYPE                     --購物車類別
              ,ECS_OPTION.DISPLAY_NAME AS  SHOP_TYPE_NAME  --購物車類別名稱
              -- 2018.11.30 ChengYu 新增傳出參數契約書號
              ,RSP.ID_SEQ                                  --契約序號
              ,FUND.ISIN_CODE                              --國際證券代碼
              ,RSP.FUND_NO                                 --基金代碼
              -- 2018.12.05 JIANXIN 修正基金名稱中的 & 造成組信錯誤，替代成＆
              ,REPLACE(FUND.NAME,'&','＆') AS FUND_NAME    --基金名稱
              ,FUND.DIVIDEND_DESC AS FUND_MEMO             --基金警語
              ,FUND.SHARE_CLASS                            --基金級別
              ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME   --基金級別名稱
              ,FUND.CURRENCY_NO                            --計價幣別
              ,TX_CURRENCY.NAME AS CURRENCY_NAME           --計價幣別名稱
              ,RSP.EXPECTED_TX_DATE AS TX_DATE             --交易日期
              ,RSP.CURRENCY_NO AS TRADE_CRNCY              --申購幣別
              ,CURRENCY.NAME AS TRADE_CRNCY_NM             --申購幣別名稱
              ,RSP.AMOUNT                                  --申購金額
			  -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
              ,CASE NVL(RSP.FEE_CHOICE,'NET') WHEN '1' THEN '全民大富翁'
                                              WHEN '4' THEN '全民大富翁'
                                              WHEN 'NET' THEN '網路費率'
                                              END FEE_CHOICE    --手續費收取方式
              ,RSP.SC_RATE                                 --申購手續費率
              -- 2018.11.07 ChengYu 修正定期(不)定額手續費計算
              ,ROUND(RSP.AMOUNT*RSP.SC_RATE/100,V_FUND_CRNCY.AMT_DECIMAL) AS SERVICE_CHARGE             --申購手續費
              ,ROUND(RSP.AMOUNT + RSP.AMOUNT*RSP.SC_RATE/100,V_FUND_CRNCY.AMT_DECIMAL) AS TOT_AMOUNT    --申購總金額
              ,RSP.BANK_NO                                                                              --扣款總行代碼
              ,FIS_BRANCH.SNAME AS FIS_SNAME                                                            --扣款銀行簡稱
              -- 2018.11.26 JIANXIN MOD BY 新增扣款戶名
              ,RSP.AC_NAME AS AC_NAME                                                                   --扣款戶名
              -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
              ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5 -- 往來帳號後5碼
              ,RSP.AC_DAY                                                                               --每月扣款日
              ,RSP.FIRST_TX_DATE                                                                        --預計首次扣款日
              -- 2018.11.30 ChengYu 調整加減碼點顯示
              ,RSP.RAISE_ROI * 100 AS RAISE_ROI                                                         --加碼點(%)
              ,RSP.RAISE_AMOUNT AS RAISE_AMOUNT                                                         --加碼金額
              -- 2018.11.30 ChengYu 調整加減碼點顯示
              ,RSP.REDUCE_ROI * 100  AS REDUCE_ROI                                                      --減碼點(%)
              ,RSP.REDUCE_AMOUNT AS REDUCE_AMOUNT                                                       --減碼金額
              ,V_FUND_CRNCY.AMT_DECIMAL AS TRADE_AMT_DECIMAL                                            --申購幣別小數位數
              ,NULL AS ES_TX_NO                                                                         --ES交易書號
              ,NULL AS ROBO_CONTRACT_NO                                                                 --ROBO契約書號
              ,NULL AS ROBO_SER_NO                                                                      --ROBO交易書號
              -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
              ,NULL AS ROBO_BATCH_NO                                                                    --ROBO再平衡批次編號
              --2018.05.22 Jim 新增重送扣款次數
              ,NULL AS AC_CNT                                                                           --扣款重送次數
          FROM ECS.RSP RSP
          JOIN FAS.FUND FUND
            ON FUND.FUND_NO = RSP.FUND_NO
          JOIN FAS.AMC AMC
            ON FUND.AMC_NO = AMC.AMC_NO
          JOIN ECS.V_FUND_CRNCY CURRENCY
            ON RSP.CURRENCY_NO = CURRENCY.CURRENCY_NO
          JOIN ECS.V_FUND_CRNCY TX_CURRENCY
            ON TX_CURRENCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS
            ON FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
           AND FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
          -- 2018.11.30 ChengYu 修正通知信銀行戶名顯示
          JOIN FAS.FIS_BRANCH FIS_BRANCH 
            ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
            ON V_FUND_CRNCY.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN ECS.ECS_OPTION ECS_OPTION
            ON SOURCE_TYPE = '022'
           AND TEXT_VALUE = WSHOP_TYPE
         WHERE RSP.ID = WID
           AND RSP.ID_SEQ= WID_SEQ;

  END IF;

END s_GetShoppingCar;

/

  GRANT EXECUTE ON "ECS"."S_GETSHOPPINGCAR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSHOPPINGCARTMP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSHOPPINGCARTMP" 
(
     WACCOUNT_NO            INTEGER,           -- 受益人戶號
     OUTDT                  OUT SYS_REFCURSOR  -- MASTER
) IS

XID VARCHAR2(10);          -- 受益人ID

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID
      INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  OPEN OUTDT FOR
      SELECT SHOP_CART.SHOP_CART_DATA
        FROM ECS.SHOP_CART SHOP_CART
       WHERE SHOP_CART.ID = XID;

END s_GetShoppingCarTmp;

/

  GRANT EXECUTE ON "ECS"."S_GETSHOPPINGCARTMP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSRNO2
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSRNO2" /*****************************************************************************************
**Stored Procedure Name: s_GetSrNo2.sql
**Desciption:取系統內部序號，需要參考取號原則檔的取號方式
**       新增功能：因需提供外部傳入字軌的功能，但是若修改原始s_GetSrNo，怕影響太大
**             所以另外提供一支s_GetSrNo2
*****************************************************************************************/
(v_striSrID        IN VARCHAR2 DEFAULT NULL,
 v_striSubSrID     IN VARCHAR2 DEFAULT NULL,
 v_striDynaParam   IN VARCHAR2 DEFAULT NULL,
 v_intiIsForceGet  IN NUMBER DEFAULT NULL, --若不存在，是否要產生一筆新的紀錄 0：不產生，出現錯誤訊息 1：產生,
 v_stroCurrentSrNo OUT VARCHAR2) AS
  --SP內所需宣告
  v_strSubSrID        VARCHAR2(20) := v_striSubSrID;
  m_v_striSrID        VARCHAR2(10) := v_striSrID;
  m_v_striSubSrID     VARCHAR2(20) := v_striSubSrID;
  m_v_striDynaParam   VARCHAR2(20) := v_striDynaParam;
  m_v_intiIsForceGet  number := v_intiIsForceGet;
  m_v_stroCurrentSrNo VARCHAR2(30) := ' ';
  --------------------------------------------
  CURSOR Cur_SrNoSetting IS
    SELECT Setting.SrID,
           Setting.SubSrID,
           Setting.SrNoS,
           Setting.SrNoLen,
           SettingDtl.OrdNo,
           SettingDtl.DataType,
           NVL(SettingDtl.DataText, '') DataText
      FROM ECS.AA_SrNosSet Setting
      LEFT JOIN ECS.AA_SrNosSetDtl SettingDtl
        ON Setting.SrID = SettingDtl.SrID
       AND Setting.SubSrID = SettingDtl.SubSrID
     WHERE Setting.SrID = m_v_striSrID
       AND Setting.SubSrID = v_strSubSrID
     ORDER BY Setting.SrID, Setting.SubSrID, SettingDtl.OrdNo;
  --Cursor 所需變數宣告
  v_intPreviousSrNo NUMBER(10, 0);
  v_intCurrentSrNo  NUMBER(10, 0);
  v_strFixParam    --固定值
  VARCHAR2(10);
  v_strDynaParam   --字軌
  VARCHAR2(10);

  v_strdataid   VARCHAR2(38);
  v_strYMDRule  VARCHAR2(8);
  v_strTmpSrNo  VARCHAR2(255);
  v_curSrID     VARCHAR2(10);
  v_curSubSrID  VARCHAR2(20);
  v_curSrNoS    NUMBER(10, 0);
  v_curSrNoLen  NUMBER(5, 0);
  v_curOrdNo    NUMBER(10, 0);
  v_curDataType VARCHAR2(6);
  v_curDataText VARCHAR2(10);
  v_intCount    NUMBER(10, 0);
  v_intSrCount  NUMBER(10, 0);
  --with encryption

BEGIN

  v_stroCurrentSrNo := ' ';
  v_strYMDRule      := ' ';
  --檢核預設值
  IF v_striSrID IS NULL THEN
    m_v_striSrID := ' ';
  END IF;
  IF v_striSubSrID IS NULL THEN
    m_v_striSubSrID := ' ';
  END IF;
  IF v_striDynaParam IS NULL THEN
    m_v_striDynaParam := ' ';
  END IF;
  IF v_intiIsForceGet IS NULL THEN
    m_v_intiIsForceGet := 0;
  END IF;

  -- 20150626 Grace
  -- 檢查流水號設定是否存在
  SELECT COUNT(*) INTO v_intSrCount
  FROM ECS.AA_SrNosSet
  WHERE SrID = m_v_striSrID;

  IF v_intSrCount = 0 THEN
    BEGIN
        raise_application_error(-20002,'s_GetSrNo2：此類別流水號不存在，請檢查');
        RETURN;
    END;
  END IF;

  --SQL Statement
  --至原則檔，取用原則
  --宣告Cursor
  SELECT COUNT(*)

    INTO v_intCount
    FROM ECS.AA_SrNosSet Setting
    LEFT JOIN ECS.AA_SrNosSetDtl SettingDtl
      ON Setting.SrID = SettingDtl.SrID
     AND Setting.SubSrID = SettingDtl.SubSrID
   WHERE Setting.SrID = m_v_striSrID
     AND Setting.SubSrID = m_v_striSubSrID;
  IF v_intCount = 0 THEN
    -- 2005/08/24
    -- Erin要求，把SubSrID原始預設值由''改成'00'
    -- SET @strSubSrID = '00'
    v_strSubSrID := '00';
  ELSE
    v_strSubSrID := m_v_striSubSrID;
  END IF;
  --Open Cursor
  OPEN Cur_SrNoSetting;
  WHILE 1 = 1 LOOP

    BEGIN
      FETCH Cur_SrNoSetting
        INTO v_curSrID,
             v_curSubSrID,
             v_curSrNoS,
             v_curSrNoLen,
             v_curOrdNo,
             v_curDataType,
             v_curDataText;
      IF Cur_SrNoSetting%Rowcount = 0 THEN
        EXIT;
      END IF;
      IF v_curDataType = '001' THEN

        --001：字軌
        BEGIN
          --      SET @stroCurrentSrNo = LTRIM(@stroCurrentSrNo) +LTRIM( @curDataText)
          IF v_striDynaParam IS NULL THEN
            v_strDynaParam := v_curDataText;
          ELSE
            v_strDynaParam := m_v_striDynaParam;
          END IF;
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               LTRIM(v_strDynaParam);
        END;
      END IF;
      IF v_curDataType = '002' THEN

        --002：固定值
        BEGIN
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               LTRIM(v_curDataText);
          v_strFixParam     := LTRIM(v_curDataText);
        END;
      END IF;
      IF v_curDataType = '003' THEN

        --年編
        BEGIN
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4);
          v_strYMDRule      := substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4);
        END;
      END IF;
      IF v_curDataType = '004' THEN

        --月編
        BEGIN
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 6, 2);
          v_strYMDRule      := substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 6, 2);
        END;
      END IF;
      IF v_curDataType = '005' THEN

        --日編
        BEGIN
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 6, 2) ||
                               substr(to_char(sysdate, 'yyyy/mm/dd'), 9, 2);
          --Joseph Modify in  2009/03/09
          --                CONVERT(nvarchar(04),YEAR(GETDATE())) +
          --                RIGHT('00'+CONVERT(nvarchar(02),MONTH(GETDATE())),2) +

          v_strYMDRule := substr(to_char(sysdate, 'yyyy/mm/dd'), 1, 4) ||
                          substr(to_char(sysdate, 'yyyy/mm/dd'), 6, 2) ||
                          substr(to_char(sysdate, 'yyyy/mm/dd'), 9, 2);
          --Joseph Modify in 2009/03/09
          --                CONVERT(nvarchar(04),YEAR(GETDATE())) +
          --                RIGHT('00'+CONVERT(nvarchar(02),MONTH(GETDATE())),2) +

        END;
      END IF;
      --整理資料
      IF v_strFixParam IS NULL THEN
        v_strFixParam := ' ';
      END IF;
      IF v_strDynaParam IS NULL THEN
        v_strDynaParam := ' ';
      END IF;
      IF v_curDataType = '006' THEN

        --流水號
        BEGIN

        --先累加一號
         UPDATE ECS.AA_SrNos
           SET FixParam    = NVL(v_strFixParam, ''),
               SrNo        = SrNo + 1,
               STATUS      = '102',
               CreateID    = 'sysAdmin',
               CreateDate  = SYSDATE,
               UpdateID    = 'sysAdmin',
               UpdateDate  = SYSDATE,
               VerifyID    = 'sysAdmin',
               VerifyDate  = SYSDATE,
               ApproveID   = 'sysAdmin',
               ApproveDate = SYSDATE
         WHERE SrID = m_v_striSrID
           AND SubSrID = m_v_striSubSrID
           AND YMDRule = v_strYMDRule;

          --查詢目前的序號
          SELECT Count(*)
            INTO v_intcount
            FROM ECS.AA_SrNos
           WHERE SrID = m_v_striSrID
             AND SubSrID = m_v_striSubSrID
             AND YMDRule = v_strYMDRule;

          if v_intcount > 0 Then
            SELECT SrNo
              INTO v_intPreviousSrNo
              FROM ECS.AA_SrNos
             WHERE SrID = m_v_striSrID
               AND SubSrID = m_v_striSubSrID
               AND YMDRule = v_strYMDRule;
          else

            v_intPreviousSrNo := null;
          end if;

          --取出目前的序號
          IF v_intPreviousSrNo IS NULL AND m_v_intiIsForceGet = 0 THEN

            BEGIN
              raise_application_error(-20002,
                                      's_GetSrNo2：此類別流水號不存在，請檢查');
              EXIT;
            END;
          ELSE
            IF v_intPreviousSrNo IS NULL AND m_v_intiIsForceGet = 1 THEN

              BEGIN
                IF (v_curSrNoS = 0) THEN

                  BEGIN
                    v_intCurrentSrNo := 1;
                  END;
                ELSE

                  BEGIN
                    v_intCurrentSrNo := v_curSrNoS;
                  END;
                END IF;
                v_strdataid := SYS_GUID();
                INSERT INTO ECS.AA_SrNos
                  (dataid,
                   SrID,
                   SubSrID,
                   YMDRule,
                   FixParam,
                   SrNo,
                   STATUS,
                   EntryID,
                   EntryDate,
                   CreateID,
                   CreateDate,
                   UpdateID,
                   UpdateDate,
                   VerifyID,
                   VerifyDate,
                   ApproveID,
                   ApproveDate,
                   RejectID,
                   RejectDate,
                   DataFlag)
                VALUES
                  (v_strdataid,
                   m_v_striSrID,
                   m_v_striSubSrID,
                   v_strYMDRule,
                   v_strFixParam,
                   v_intCurrentSrNo,
                   '102',
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   utl_raw.cast_to_raw('9i'));
                INSERT INTO ECS.AA_SrNosLog
                  (dataid,
                   LogID,
                   LogDateTime,
                   LogType,
                   SrID,
                   SubSrID,
                   YMDRule,
                   FixParam,
                   SrNo,
                   STATUS,
                   EntryID,
                   EntryDate,
                   CreateID,
                   CreateDate,
                   UpdateID,
                   UpdateDate,
                   VerifyID,
                   VerifyDate,
                   ApproveID,
                   ApproveDate,
                   RejectID,
                   RejectDate,
                   DataFlag)
                VALUES
                  (v_strdataid,
                   AA_SRNOSLOG_LOGID_SEQ.NEXTVAL,
                   SYSDATE,
                   'A',
                   m_v_striSrID,
                   m_v_striSubSrID,
                   v_strYMDRule,
                   v_strFixParam,
                   v_intCurrentSrNo,
                   '102',
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   'sysAdmin',
                   SYSDATE,
                   utl_raw.cast_to_raw('9i'));
              END;
            ELSE

              BEGIN
                v_intCurrentSrNo := v_intPreviousSrNo;
                /*
                v_intCurrentSrNo := v_intPreviousSrNo + 1;
                UPDATE ECS.AA_SrNos
                   SET FixParam    = NVL(v_strFixParam, ''),
                       SrNo        = v_intCurrentSrNo,
                       STATUS      = '102',
                       CreateID    = 'sysAdmin',
                       CreateDate  = SYSDATE,
                       UpdateID    = 'sysAdmin',
                       UpdateDate  = SYSDATE,
                       VerifyID    = 'sysAdmin',
                       VerifyDate  = SYSDATE,
                       ApproveID   = 'sysAdmin',
                       ApproveDate = SYSDATE
                 WHERE SrID = m_v_striSrID
                   AND SubSrID = m_v_striSubSrID
                   AND YMDRule = v_strYMDRule;
                   */

/*                INSERT INTO ECS.AA_SrNosLog
                  (dataid,
                   LogDateTime,
                   LogType,
                   LogID,
                   SrID,
                   SubSrID,
                   YMDRule,
                   FixParam,
                   SrNo,
                   STATUS,
                   EntryID,
                   EntryDate,
                   CreateID,
                   CreateDate,
                   UpdateID,
                   UpdateDate,
                   VerifyID,
                   VerifyDate,
                   ApproveID,
                   ApproveDate,
                   RejectID,
                   RejectDate,
                   DataFlag)
                  (SELECT dataid,
                          SYSDATE,
                          'U',
                          AA_SRNOSLOG_LOGID_SEQ.NEXTVAL,
                          SrID,
                          SubSrID,
                          YMDRule,
                          FixParam,
                          SrNo,
                          STATUS,
                          EntryID,
                          EntryDate,
                          CreateID,
                          CreateDate,
                          UpdateID,
                          UpdateDate,
                          VerifyID,
                          VerifyDate,
                          ApproveID,
                          ApproveDate,
                          RejectID,
                          RejectDate,
                          DataFlag
                     FROM ECS.AA_SrNos
                    WHERE SrID = m_v_striSrID
                      AND SubSrID = m_v_striSubSrID
                      AND YMDRule = v_strYMDRule);*/
              END;
            END IF;
          END IF;
          --v_curSrNoLen := v_curSrNoLen - LENGTH(v_stroCurrentSrNo); --+1
          -- 20141229 根據憶萍抓到如果流水編號在沒有字軌的情況下會少取一碼的BUG，子毅提供的修正方式如下列這行
          v_curSrNoLen := v_curSrNoLen - NVL(LENGTH(TRIM(v_stroCurrentSrNo)), 0);
          IF v_curSrNoLen <= 0 THEN

            BEGIN
              raise_application_error(-20002, '序號長度設定不足，請檢查');
              RETURN;
            END;
          END IF;
          v_stroCurrentSrNo := LTRIM(v_stroCurrentSrNo) ||
                               SUBSTR(
                               '00000000000000000000' ||CAST(v_intCurrentSrNo AS VARCHAR2),
                               LENGTH('00000000000000000000' ||CAST(v_intCurrentSrNo AS VARCHAR2))-v_curSrNoLen +1,
                                      v_curSrNoLen
                                      );
          RETURN;

        END;
      END IF;
    END;
  END LOOP;
  --SET @strTmpSrNo = @stroCurrentSrNo + RIGHT('0000000000'+CONVERT(varchar(10),@intCurrentSrNo),@curSrNoLen)
  --SET @stroCurrentSrNo = Convert(nvarchar(30),LTRIM(@strTmpSrNo))
  -- end of while
  CLOSE Cur_SrNoSetting;
END;

/

  GRANT EXECUTE ON "ECS"."S_GETSRNO2" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSRNO3
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSRNO3" 
/*****************************************************************************************
**Stored Procedure Name: s_GetSrNo3.sql
**Desciption:取系統內部序號，需參考取號原則檔的取號方式
**		     不同於s_GetSrNo2之處，不傳入FixParam(字軌)
*****************************************************************************************/
(
  v_striSrID IN NVARCHAR2 DEFAULT NULL ,
  v_striSubSrID IN NVARCHAR2 DEFAULT NULL ,
  v_intiIsForceGet IN NUMBER DEFAULT NULL, --若不存在，是否要產生一筆新的紀錄 0：不產生，出現錯誤訊息 1：產生,
  v_stroCurrentSrNo OUT NVARCHAR2
)
AS

BEGIN

   ECS.s_GetSrNo2(v_striSrID,
                  v_striSubSrID,
                  '',
                  v_intiIsForceGet,
                  v_stroCurrentSrNo);
END;

/

  GRANT EXECUTE ON "ECS"."S_GETSRNO3" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSTATEMENTPDF
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSTATEMENTPDF" 
-- =============================================
-- Author:      tingting
-- Create date: 2020/07/09
-- Description: 取得對帳單PDF
-- =============================================
(
    WREFERENCE_NO   INTEGER,                --參考索引
    OUTDT           OUT SYS_REFCURSOR       --回傳的 TABLEDATA
) IS
BEGIN

    OPEN OUTDT FOR
    SELECT  FILENAME AS PDF_FILENAME        --檔案名稱
           ,PATHNAME AS PDF_PATHNAME        --檔案路徑
      FROM FAS.E_ATTACHMENTS    --Email 寄送附件
     WHERE REFERENCE_NO = WREFERENCE_NO
     ORDER BY SER_NO DESC;

END s_GetStatementPDF;

/

  GRANT EXECUTE ON "ECS"."S_GETSTATEMENTPDF" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSTATEMENTYM
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSTATEMENTYM" 
-- =============================================
-- Author:      tingting
-- Create date: 2020/07/08
-- Description: 取得對帳單執行年月
-- 2020.11.06 by Chengyu 新增條件(產檔的單位或系統(MATTER)='OPERATIONS')限制對帳單資料
-- 2021.05.18 JIANXIN 因應ES廠商調整 
--            HANDLE：Null 還沒處理；0：處理中或檔案有問題；大於0：處理結束；
-- =============================================
(
    WACCOUNT_NO     INTEGER,                --受益人戶號
    WDATA_CNT       INTEGER,                --對帳單近N筆
    OUTDT           OUT SYS_REFCURSOR       --回傳的 TABLEDATA
) IS
    XID             VARCHAR2(10);           --受益人ID
BEGIN

    --取得受益人ID
    BEGIN

        SELECT ID INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    OPEN OUTDT FOR
    SELECT  REFERENCE_NO        --參考索引
           ,DATE_FROM           --對帳單執行範圍日期(起)
           ,DATE_TO             --對帳單執行範圍日期(迄)
      FROM FAS.E_DOCUMENTS      --Email 寄送文件紀錄檔
     WHERE FUNC_CODE = '624'    --作業代碼
       AND SYS_CODE = 'FAS'     --系統代碼
       AND TR_TYPE = 'E'        --作業型態 E:Email F:Fax
       -- 2020.11.06 by Chengyu 新增條件(產檔的單位或系統(MATTER)='OPERATIONS')限制對帳單資料
       AND MATTER = 'OPERATIONS'--產檔的單位或系統
       AND ID = XID
       AND ROWNUM <= WDATA_CNT
       -- 2021.05.18 JIANXIN 因應ES廠商調整 
       -- HANDLE：Null 還沒處理；0：處理中或檔案有問題；大於0：處理結束；
       AND HANDLE > 0
     ORDER BY REFERENCE_NO DESC;

END s_GetStatementYM;

/

  GRANT EXECUTE ON "ECS"."S_GETSTATEMENTYM" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSWITCHDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSWITCHDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/05/21
-- Description: 取得轉申購委託交易資料
-- 2018.10.31 JIANXIN MOD BY 因應手續費率有小數位以下2位，進行調整
-- 2018.11.29 ChengYu 新增傳出參數 買回基金幣別、買回基金幣別名稱
-- 2018.12.03 ChengYu 新增回傳欄位交易幣別
-- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
-- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
--                     調整「生日優惠」名稱改為促銷活動的名稱
-- =============================================
(
    WFUND_NO_OUT   VARCHAR2,               -- 基金代碼
    WTX_DATE       DATE,                   -- 交易日期
    WSER_NO        VARCHAR2,               -- 交易序號
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS

XBROKER_NO VARCHAR2(3):= '999' ;
XBRANCH_NO VARCHAR2(4):= '8300' ;

BEGIN

    OPEN OUTDT FOR
        SELECT  REDEMPTION.FUND_NO AS FUND_NO_OUT
                -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
               ,REPLACE(FUND_NO_OUT.NAME,'&','＆') AS FUND_NAME_OUT
               ,FUND_NO_OUT.DIVIDEND_DESC AS FUND_MEMO_OUT
               ,FUND_NO_OUT.ISIN_CODE AS ISIN_CODE_OUT
               ,REDEMPTION.TX_DATE
               ,REDEMPTION.APPLICATION_SHARE
               ,REDEMPTION.AC_DATE
               ,REDEMPTION.FUND_NO_IN
                -- 2018.12.05 JIANXIN MOD BY 修正基金名稱中的 & 造成組信錯誤，替代成＆
               ,REPLACE(FUND_NO_IN.NAME,'&','＆') AS FUND_NAME_IN
               ,FUND_NO_IN.DIVIDEND_DESC AS FUND_MEMO_IN
               ,FUND_NO_IN.ISIN_CODE AS ISIN_CODE_IN
               ,FUND_NO_IN.SHARE_CLASS
               ,SHARE_CLASS_IN.NAME AS SHARE_CLASS_NAME
               ,FUND_NO_IN.CURRENCY_NO
               ,V_FUND_CRNCY_IN.NAME AS CURRENCY_NAME
               ,REDEMPTION.SWITCH_DATE
               -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
               --                     調整「生日優惠」名稱改為促銷活動的名稱
               ,CASE WHEN REDEMPTION.FEE_CHOICE IS NULL THEN '網路費率'
                     WHEN REDEMPTION.FEE_CHOICE = '1' OR REDEMPTION.FEE_CHOICE = '4' THEN
                       --因TABLE尚未開，先寫死
                       --SELECT PROJECT_NAME FROM FAS.PROJECT WHERE PROJECT_CODE = REDEMPTION.PROJECT_CODE
                       '全民大富翁'
                     WHEN REDEMPTION.FEE_CHOICE = '2' THEN '優惠券' || REDEMPTION.COUPON_ID
                     WHEN REDEMPTION.FEE_CHOICE = '3' THEN '紅利折抵：' || REDEMPTION.USED_POINT || '點，轉申購手續費：' || REDEMPTION.SERVICE_CHARGE
                     WHEN REDEMPTION.FEE_CHOICE = '5' THEN CAMPAIGN.CAMPAIGN_SHNM
                     END AS FEE_CHOICE
               -- 2018.10.31 JIANXIN MOD BY 因應手續費率有小數位以下2位，進行調整
               ,REDEMPTION.SC_RATE AS SC_RATE
               ,FUND_NO_OUT.SHARE_DECIMAL
               -- 2018.11.29 ChengYu 新增傳出參數 買回基金幣別、買回基金幣別名稱
               ,FUND_NO_OUT.CURRENCY_NO AS CURRENCY_NO_OUT
               ,V_FUND_CRNCY_OUT.NAME AS CURRENCY_NAME_OUT
               -- 2018.12.03 ChengYu 新增回傳欄位交易幣別
               ,REDEMPTION.CURRENCY_NO AS TRADE_CRNCY
               ,V_TRADE_CRNCY.NAME AS TRADE_CRNCY_NM
          FROM ECS.REDEMPTION REDEMPTION
          JOIN FAS.FUND FUND_NO_OUT
            ON FUND_NO_OUT.FUND_NO = REDEMPTION.FUND_NO
          JOIN FAS.FUND FUND_NO_IN
            ON FUND_NO_IN.FUND_NO = REDEMPTION.FUND_NO_IN
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_IN
            ON V_FUND_CRNCY_IN.CURRENCY_NO = FUND_NO_IN.CURRENCY_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS SHARE_CLASS_IN
            ON SHARE_CLASS_IN.SHARE_CLASS = FUND_NO_IN.SHARE_CLASS
           AND SHARE_CLASS_IN.AMC_NO = FUND_NO_IN.AMC_NO
          -- 2018.12.06 tingting 調整「網路優惠費率」名稱改為「網路費率」
          --                     調整「生日優惠」名稱改為促銷活動的名稱
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN
            ON CAMPAIGN.CAMPAIGN_CODE = REDEMPTION.PROJECT_CODE
          JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_OUT
            ON V_FUND_CRNCY_OUT.CURRENCY_NO = FUND_NO_OUT.CURRENCY_NO
          -- 2018.12.03 ChengYu 新增回傳欄位交易幣別
          JOIN ECS.V_FUND_CRNCY V_TRADE_CRNCY
            ON V_TRADE_CRNCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
         WHERE REDEMPTION.FUND_NO = WFUND_NO_OUT
           AND REDEMPTION.TX_DATE = TRUNC(WTX_DATE)
           AND REDEMPTION.SER_NO = WSER_NO
           AND REDEMPTION.BROKER_NO = XBROKER_NO
           AND REDEMPTION.BRANCH_NO = XBRANCH_NO;

END s_GetSwitchData;

/

  GRANT EXECUTE ON "ECS"."S_GETSWITCHDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSWITCHFEETYPELIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSWITCHFEETYPELIST" 
-- =============================================
-- Author     : PAN
-- Create date: 2018/08/13
-- Description: API048 取得轉申購手續費收取方式
-- 2018.08.28 JIANXIN 若沒有紅利則以0處理，回傳至前端必須要有紅利點數才回傳
-- 2018.09.19 JIANXIN 暫時移除優惠券的選項
-- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
-- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
-- 2018.10.02 JIANXIN 調整「網路優惠費率」名稱改為「網路費率」
-- 2018.10.19 JIANXIN 促銷活動顯示條件調整
-- 2018.11.01 JIANXIN 調整紅利積點計算方式
-- 2018.12.06 tingting 調整紅利折抵，在取預扣點數的取法
-- 2020.03.20 ChengYu 新增優惠券的選項
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- =============================================
(
    WACCOUNT_NO               INTEGER,                 -- 受益人戶號 --171619 A101202303 / 171625  G110220333
    WSHOPLIST                 VARCHAR2,                -- 傳入字串 ShopList(SHOP_TYPE;FUND_NO;TX_CURRENCY_NO;TX_DATE;REDEM_FUND;REDEM_DATE)
                                                       --                  (購物車類別-1.轉申購;轉入基金;交易幣別;轉申購日期;轉出基金;買回日期)
                                                       --          範例    ('1;M14;NTD;20180806;M25;20180803,1;M22;NTD;20180806;M25;20180803')
    OUTDT                     OUT SYS_REFCURSOR,       -- 傳出TABLE ShopList(手續費收取方式列表)
    OUTDT2                    OUT SYS_REFCURSOR        -- 傳出TABLE CouponList(該客戶持有的優惠券代碼列表)
) IS
    --變數
    XID           FAS.HOLDER.ID%TYPE;
    XBIRTH_DATE   FAS.HOLDER.BIRTH_DATE%TYPE;

BEGIN
    BEGIN
  	    --取得 ID / 出生日期
        SELECT ID,BIRTH_DATE
          INTO XID,XBIRTH_DATE
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                 RAISE_APPLICATION_ERROR(-20000,'無法取得受益人ID，請檢查！');
    END;

    --轉申購手續費方案
    --2.1	同母基金互轉,無手續費率
    --2.2	新的檔案【基金轉申購優惠費率(FAS.FUND_EXCHANGE_RATE)】，為網路優惠費率的一種，無”專案代碼”
    --2.2.1	A母基金 轉換成 B母基金(適用項下全部子基金)，於活動期間，享優惠費率
    --2.2.2	若為永久活動，截止日期為空白
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    --牌告手續費率
    SELECT  FUND_LIST.FUND_NO                --基金代碼
           ,'' AS FEE_CHOICE                 --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           -- 2018.10.02 JIANXIN 調整「網路優惠費率」名稱改為「網路費率」
           ,'網路費率' AS PROJECT_NAME       --促銷活動名稱
           ,FUND_LIST.SC_RATE                --優惠手續費率
           ,0 AS USED_POINT                  --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,FUND_LIST.AMOUNT                 --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,9 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (SELECT FUND_NO, SC_RATE, AMOUNT, TX_CURRENCY_NO
              FROM (SELECT T.FUND_NO, SC_RATE , 999999999999 AMOUNT,T.TX_CURRENCY_NO 
                      FROM FAS.FUND_EXCHANGE_RATE A
                     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                ) T
                      JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                      JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                     WHERE A.FUND_MASTER_OUT = B.FUND_MASTER_NO
                       AND A.FUND_MASTER_IN = C.FUND_MASTER_NO
                       AND To_Date(T.TX_DATE,'yyyymmdd') >= A.START_DATE
                       AND (A.END_DATE IS NULL OR To_Date(T.TX_DATE,'yyyymmdd') < A.END_DATE )
                    UNION ALL
                    --不存在 基金轉申購優惠費率(FAS.FUND_EXCHANGE_RATE) 則抓取原牌告費率
                    SELECT A.FUND_NO, CASE WHEN B.FUND_MASTER_NO = C.FUND_MASTER_NO THEN 0 ELSE A.ECS_SWITCH END AS SC_RATE, 
                           A.AMOUNT, A.CURRENCY_NO AS TX_CURRENCY_NO 
                      FROM FAS.SALES_CHARGE A
                     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                ) T
                      JOIN (SELECT A.FUND_NO 
                              FROM FAS.SALES_CHARGE A
                             CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                           FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                        ) T
                             WHERE A.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                               AND A.CURRENCY_NO = T.TX_CURRENCY_NO
                               AND A.FUND_NO = T.FUND_NO
                            MINUS
                            SELECT T.FUND_NO 
                              FROM FAS.FUND_EXCHANGE_RATE A
                             CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                           FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                        ) T
                              JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                              JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                             WHERE A.FUND_MASTER_OUT = B.FUND_MASTER_NO
                               AND A.FUND_MASTER_IN = C.FUND_MASTER_NO   
                               AND To_Date(T.TX_DATE,'yyyymmdd') >= A.START_DATE
                               AND (A.END_DATE IS NULL OR To_Date(T.TX_DATE,'yyyymmdd') < A.END_DATE )
                           ) W
                        ON W.FUND_NO = T.FUND_NO   
                      JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                      JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                     WHERE A.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                       AND A.CURRENCY_NO = T.TX_CURRENCY_NO
                       AND A.FUND_NO = T.FUND_NO
                   ) 
           ) FUND_LIST
    -- 2018.09.19 JIANXIN 暫時移除優惠券的選項
    -- 2020.03.20 ChengYu 新增優惠券的選項
    UNION
    --2：優惠券 : 一律給予此項目,由投資人填寫 優惠券代碼
    SELECT  FUND_LIST.FUND_NO                --基金代碼
           ,'2' AS FEE_CHOICE                --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           ,'優惠券' AS PROJECT_NAME         --促銷活動名稱
           ,0 AS SC_RATE                     --優惠手續費率
           ,0 AS USED_POINT                  --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,999999999999 AS AMOUNT           --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,3 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO ,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
              FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
           ) FUND_LIST
    UNION
    --3：紅利折抵 : 若客戶帳上仍有紅利點數,則給予此項目,由投資人填寫 紅利點數
    SELECT  FUND_LIST.FUND_NO                --基金代碼
           ,'3' AS FEE_CHOICE                --優惠方案
           ,'' AS PROJECT_CODE               --促銷活動代碼
           ,'紅利折抵' AS PROJECT_NAME       --促銷活動名稱
           ,FUND_LIST.SC_RATE                --優惠手續費率\此為牌告費率
           ,REWARD_POINT.USED_POINT          --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO         --申購幣別
           ,FUND_LIST.AMOUNT                 --申購金額上限\此為牌告費率金額
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,NULL AS CAMPAIGN_BNG_DATE        --活動起始日期
           ,NULL AS CAMPAIGN_END_DATE        --活動終止日期
           ,2 DATA_ORDER                     --排序
           ,'' AS CAMPAIGN_TYPE              --促銷類別
      FROM (
            -- ===========2018.11.01 JIANXIN 調整紅利積點計算方式 BNG===========
            -- 2018.12.06 tingting 調整紅利折抵，在取預扣點數的取法
              SELECT SUM(REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0)) AS USED_POINT     --可使用點數(紅利點數 - 使用點數 - 預扣點數)
                FROM FAS.REWARD_POINT
                LEFT JOIN (
							-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
							--還沒真正被使用的預扣點數
							SELECT  REWARD_POINT.REWARD_NO
							       ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
							  FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
							  JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
							    ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
							   AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
							  JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
							    ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
							 WHERE REWARD_HISTORY.ID = XID
							   AND REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
							 GROUP BY REWARD_POINT.REWARD_NO
							 ORDER BY REWARD_POINT.REWARD_NO
						  ) REWARD_POINT_W         --紅利配發資料(預扣)
                  ON REWARD_POINT_W.REWARD_NO = REWARD_POINT.REWARD_NO
               CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                             FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                          ) TRADE_LIST
               WHERE To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
                 AND REWARD_POINT.ID  = XID
                 AND REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) > 0
             -- ===========2018.11.01 JIANXIN 調整紅利積點計算方式 END===========
           ) REWARD_POINT
     CROSS JOIN 
           (SELECT FUND_NO, SC_RATE, AMOUNT, TX_CURRENCY_NO
              FROM (SELECT T.FUND_NO, SC_RATE , 999999999999 AMOUNT,T.TX_CURRENCY_NO 
                      FROM FAS.FUND_EXCHANGE_RATE A
                     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                ) T
                      JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                      JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                     WHERE A.FUND_MASTER_OUT = B.FUND_MASTER_NO
                       AND A.FUND_MASTER_IN = C.FUND_MASTER_NO
                       AND To_Date(T.TX_DATE,'yyyymmdd') >= A.START_DATE
                       AND (A.END_DATE IS NULL OR To_Date(T.TX_DATE,'yyyymmdd') < A.END_DATE )
                    UNION ALL
                    --不存在 基金轉申購優惠費率(FAS.FUND_EXCHANGE_RATE) 則抓取原牌告費率
                    SELECT A.FUND_NO, CASE WHEN B.FUND_MASTER_NO = C.FUND_MASTER_NO THEN 0 ELSE A.ECS_SWITCH END AS SC_RATE, 
                           A.AMOUNT, A.CURRENCY_NO AS TX_CURRENCY_NO 
                      FROM FAS.SALES_CHARGE A
                     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                ) T
                      JOIN (SELECT A.FUND_NO 
                              FROM FAS.SALES_CHARGE A
                             CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                           FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                        ) T
                             WHERE A.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                               AND A.CURRENCY_NO = T.TX_CURRENCY_NO
                               AND A.FUND_NO = T.FUND_NO
                            MINUS
                            SELECT T.FUND_NO 
                              FROM FAS.FUND_EXCHANGE_RATE A
                             CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND
                                           FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                                        ) T
                              JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                              JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                             WHERE A.FUND_MASTER_OUT = B.FUND_MASTER_NO
                               AND A.FUND_MASTER_IN = C.FUND_MASTER_NO   
                               AND To_Date(T.TX_DATE,'yyyymmdd') >= A.START_DATE
                               AND (A.END_DATE IS NULL OR To_Date(T.TX_DATE,'yyyymmdd') < A.END_DATE )
                           ) W
                        ON W.FUND_NO = T.FUND_NO   
                      JOIN FAS.FUND B ON B.FUND_NO = T.REDEM_FUND
                      JOIN FAS.FUND C ON C.FUND_NO = T.FUND_NO
                     WHERE A.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                       AND A.CURRENCY_NO = T.TX_CURRENCY_NO
                       AND A.FUND_NO = T.FUND_NO
                   )
           ) FUND_LIST
     -- 2018.08.28 JIANXIN 若沒有紅利則以0處理，回傳至前端必須要有紅利點數才回傳
     WHERE REWARD_POINT.USED_POINT > 0
    UNION
    --5：生日優惠
    SELECT  FUND_LIST.FUND_NO                       --基金代碼
           ,'5' AS FEE_CHOICE                       --優惠方案
           ,CAMPAIGN.CAMPAIGN_CODE AS PROJECT_CODE  --促銷活動代碼
           ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME  --促銷活動名稱
           ,CAMPAIGN.FIXED_RATE AS SC_RATE          --優惠手續費率
           ,0 AS USED_POINT                         --紅利點數
           ,FUND_LIST.TX_CURRENCY_NO                --申購幣別
           ,999999999999 AS AMOUNT                  --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,CAMPAIGN.CAMPAIGN_BNG_DATE              --活動起始日期
           ,CAMPAIGN.CAMPAIGN_END_DATE              --活動終止日期
           ,1 DATA_ORDER                            --排序
           ,'' AS CAMPAIGN_TYPE                     --促銷類別
      FROM ECS.CAMPAIGN
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO ,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE5 REDEM_FUND,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) FUND_LIST
     WHERE FUND_LIST.SHOP_TYPE  = '1'  
       AND CAMPAIGN.CAMPAIGN_TYPE = 'B'
       AND CAMPAIGN.PROMT_TYPE = '2'  -- 壽星優惠
       AND TO_CHAR(XBIRTH_DATE,'MM') = TO_CHAR(To_Date(FUND_LIST.REDEM_DATE,'yyyymmdd'),'MM');

    --促銷活動(B：基本) : 所有基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND(S.ECS_SWITCH * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
     CROSS JOIN FAS.FUND C
     -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_SWITCH , AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '1'
       AND A.CAMPAIGN_TYPE IN('B')            --促銷類別\B：基本
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'2',1,1) > 0    --活動項目\2：轉申購
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --促銷活動(B：基本) : 基金種類
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND(S.ECS_SWITCH * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_CATEGORY = D.FUND_TYPE_DTL
     -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO, ECS_SWITCH, AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '2'
       AND A.CAMPAIGN_TYPE IN('B')            --促銷類別\B：基本
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'2',1,1) > 0    --活動項目\2：轉申購
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.REDEM_DATE,'yyyymmdd')
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND A.CAMPAIGN_END_DATE >= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           );

    --促銷活動(B：基本) : 基金公司
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND(S.ECS_SWITCH * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.AMC_NO = D.FUND_TYPE_DTL
     -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_SWITCH, AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '3'
       AND A.CAMPAIGN_TYPE IN('B')            --促銷類別\B：基本
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'2',1,1) > 0    --活動項目\2：轉申購
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           );

    --促銷活動(B：基本) : 系列主基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND(S.ECS_SWITCH * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_MASTER_NO = D.FUND_TYPE_DTL
     -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_SWITCH, AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '4'
       AND A.CAMPAIGN_TYPE IN('B')            --促銷類別\B：基本
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'2',1,1) > 0    --活動項目\2：轉申購
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           );

    --促銷活動(B：基本) : 個別基金
    INSERT INTO ECS.CAMPAIGN_LIST_TEMP
    (SHOP_TYPE,FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,DATA_ORDER,CAMPAIGN_TYPE)
    SELECT  T.SHOP_TYPE                             --購物車類別
           ,C.FUND_NO                               --基金代碼
           ,'1' AS FEE_CHOICE                       --優惠方案
           ,A.CAMPAIGN_CODE AS PROJECT_CODE         --促銷活動代碼
           ,A.CAMPAIGN_SHNM AS PROJECT_NAME         --促銷活動名稱
           --優惠手續費率
           ,CASE A.FEE_TYPE WHEN 'F' THEN A.FIXED_RATE 
            ELSE ROUND(S.ECS_SWITCH * A.DISC_RATE/100,2) END AS SC_RATE  
           ,0 AS USED_POINT                         --紅利點數
           ,T.TX_CURRENCY_NO                        --申購幣別
           ,S.AMOUNT                                --申購金額上限
           -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
           ,A.CAMPAIGN_BNG_DATE                     --活動起始日期
           ,A.CAMPAIGN_END_DATE                     --活動終止日期
           ,4 DATA_ORDER                            --排序
           ,A.CAMPAIGN_TYPE                         --促銷類別
      FROM ECS.CAMPAIGN A
      JOIN ECS.CAMPAIGN_FUND B ON A.CAMPAIGN_CODE = B.CAMPAIGN_CODE
      JOIN ECS.CAMPAIGN_FUNDDTL D 
        ON D.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND D.FUND_TYPE = B.FUND_TYPE  
      JOIN FAS.FUND C ON C.FUND_NO = D.FUND_TYPE_DTL
     -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
     CROSS JOIN (SELECT VALUE1 SHOP_TYPE,VALUE2 FUND_NO,VALUE3 TX_CURRENCY_NO,VALUE4 TX_DATE,VALUE6 REDEM_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                ) T
      JOIN (SELECT FUND_NO , ECS_SWITCH, AMOUNT ,CURRENCY_NO
              FROM FAS.SALES_CHARGE
             WHERE EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
           ) S
        ON S.FUND_NO = C.FUND_NO   
       AND S.CURRENCY_NO =  T.TX_CURRENCY_NO
      LEFT JOIN ECS.CAMPAIGN_MKT M
        ON M.CAMPAIGN_CODE = B.CAMPAIGN_CODE
       AND M.MKT_ID IN (SELECT MKT_ID 
                          FROM (SELECT MKT_ID FROM ECS.MARKET_GROUP WHERE ID = XID 
                                UNION 
                                SELECT PREFERENTIAL FROM FAS.HOLDER WHERE ID = XID
                               ) 
                       )          
     WHERE B.FUND_TYPE = '5'
       AND A.CAMPAIGN_TYPE IN('B')            --促銷類別\B：基本
       AND A.PROMT_TYPE = '1'                 --活動類別\1：CAMPAIG
       AND INSTR(A.PROMT_ITEM,'2',1,1) > 0    --活動項目\2：轉申購
       --活動對象\1：所有受益人；2：身分群組
       AND (   (A.CAMPAIGN_OBJ = '1')
            OR (A.CAMPAIGN_OBJ = '2' AND M.CAMPAIGN_CODE IS NOT NULL)
           )
       -- 2018.09.20 JIANXIN 促銷活動活動日期判斷從轉入日期改為轉出日期
       AND A.CAMPAIGN_BNG_DATE <= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND A.CAMPAIGN_END_DATE >= To_Date(T.REDEM_DATE,'yyyymmdd')
       AND T.FUND_NO = C.FUND_NO  
       -- 2018.10.19 JIANXIN 促銷活動顯示條件調整
       AND (   (A.FEE_TYPE = 'F' AND S.AMOUNT = 999999999999) 
            OR (A.FEE_TYPE = 'D')
           ); 

    --回傳資料
    -- 2018.09.26 tingting ShopList增加傳出欄位：活動起始日期、活動終止日期
    OPEN OUTDT FOR
    SELECT FUND_NO,FEE_CHOICE,PROJECT_CODE,PROJECT_NAME,SC_RATE,USED_POINT,TX_CURRENCY_NO,AMOUNT,CAMPAIGN_BNG_DATE,CAMPAIGN_END_DATE,CAMPAIGN_TYPE,DATA_ORDER
      FROM ECS.CAMPAIGN_LIST_TEMP;

    OPEN OUTDT2 FOR
    SELECT  COUPON_ID        --優惠券代碼
      FROM ECS.COUPON_DATA
     CROSS JOIN (SELECT DISTINCT VALUE4 TX_DATE
                   FROM TABLE(ECS.F_FormatStringListToTable(WSHOPLIST))
                 ) TRADE_LIST
     WHERE ID = XID
       AND IS_EFFECT = 'Y'  --必須是有效
        --在有效日期內
       AND To_Date(TRADE_LIST.TX_DATE,'yyyymmdd') BETWEEN VALID_FROM AND VALID_THRU
       AND INSTR(TX_TYPE,'2',1,1) > 0 ;

    DELETE FROM ECS.CAMPAIGN_LIST_TEMP;

END s_GetSwitchFeeTypeList;

/

  GRANT EXECUTE ON "ECS"."S_GETSWITCHFEETYPELIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETSWITCHFUNDDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETSWITCHFUNDDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/07/02
-- Description: 取得可轉申購入基金列表
-- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
-- 2018.11.08 PAN MOD 改寫"轉申購日期",改由 ECS.F_GetSwitchDate 取得
-- 2018.12.11 ChengYu 修正轉申購同一基金的錯誤
-- 2023.10.07 JIANXIN 境內基金保持原本的作法，境外基金處理方式如下：
--                    甲、	FUND_CATEGORY (境內外識別碼) = 2 境外
--                    乙、	AMC_NO (買回基金公司代碼) = 贖回基金 (被轉申購基金) 公司代碼
--                    丙、	CURRENCY_NO (買回基金計價幣別) = 贖回基金 (被轉申購基金) CURRENCY_NO (買回基金計價幣別)
-- 2023.12.15 JIANXIN 境外基金外幣轉申購，僅處理原幣，台幣走原本的模式
-- =============================================
(
    WFUND_CATEGORY  VARCHAR2,           --境內外識別碼
    WFUND_NO        VARCHAR2,           --買回基金代碼
    WTX_DATE        DATE,               --買回交易日期
    WPAY_DATE       DATE,               --預計買回入帳日期
    WTX_CURRENCY    VARCHAR2,           --買回基金交易幣別
    OUTDT           OUT SYS_REFCURSOR   --投資類型基金列表
)
IS
BEGIN

    OPEN OUTDT FOR
    SELECT  FUND_IN.INVESTMENT_TYPE
           ,FUND_EXCHANGE.FUND_NO_IN
           ,FUND_IN.NAME
           ,FUND_IN.DIVIDEND_DESC
           ,FUND_IN.ISIN_CODE
           ,FUND_IN.SHARE_CLASS
           ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME
           ,FUND_IN.FUND_CATEGORY
           ,FUND_IN.AMC_NO AS AMC_NO_IN
           ,FUND_IN.CURRENCY_NO AS CURRENCY_NO_IN
           ,V_FUND_CRNCY.NAME AS CURRENCY_NAME
           ,SYSTEM_SETTINGS1.VALUE AS DOWNLOADFUNDDOC
           ,SYSTEM_SETTINGS2.VALUE AS OFF_SHORE_CHANNEL_EXPOSE
           ,SYSTEM_SETTINGS3.VALUE AS DOWNLOADINVESTORNOTICE
           ,FUND_IN.RISK_CATEGORY
           ,FUND_IN.IS_EC
           ,FUND_IN.IS_EC_SWITCH_IN AS IS_SWITCH_IN
           ,FUND_IN.LAUNCH_DATE AS LAUNCH_DATE_IN
           ,FUND_IN.SALES_DATE AS SALES_DATE_IN
           ,FUND_IN.CLEAR_DATE AS CLEAR_DATE_IN
           ,FUND_IN.ELIMINATION_DATE AS ELIMINATION_DATE_IN
           ,FUND_IN.AC_DATE AS AC_DATE_IN
           ,SUBSTR(FUND_IN.CURRENCY_NO,0,2) AS PAY_CALENDAR_IN
           --2018.11.08 PAN MOD 改寫"轉申購日期",改由 ECS.F_GetSwitchDate 取得
           --,CASE WHEN WFUND_CATEGORY = '1' AND CALENDAR.HOLIDAY IS NOT NULL THEN ECS.F_GETBEFAFTDATE(FUND_IN.FUND_NO,'3',ECS.F_GETBEFAFTDATE(FUND_OUT.FUND_NO,'3',WTX_DATE,1),1)
           --      WHEN WFUND_CATEGORY = '1' AND CALENDAR.HOLIDAY IS NULL THEN ECS.F_GETBEFAFTDATE(FUND_OUT.FUND_NO,'3',WTX_DATE,1)
           --      WHEN WFUND_CATEGORY = '2' THEN ECS.F_GETPAYDATE(FUND_OUT.FUND_NO,WPAY_DATE)
           --      ELSE TO_DATE('19000101','YYYYMMDD')
           -- END AS SWITCH_DATE
           ,ECS.F_GetSwitchDate(WTX_DATE,FUND_EXCHANGE.FUND_NO_OUT,FUND_OUT.FUND_CATEGORY,WPAY_DATE,NVL(FUND_EXCHANGE.TX_DAYS,0),FUND_NO_IN) AS SWITCH_DATE
      　　 ,FUND_IN.SITCA_FUND_TYPE
           ,FUND_IN_MASTER.ORDINAL
           ,DECODE(FUND_IN.SHARE_CLASS,NULL,'1',FUND_IN.SHARE_CLASS) AS SHARE_CLASS_ORDER
      FROM FAS.FUND_EXCHANGE   --基金轉申購入帳日
      LEFT JOIN FAS.FUND FUND_OUT
        ON FUND_OUT.FUND_NO = FUND_EXCHANGE.FUND_NO_OUT
      LEFT JOIN FAS.FUND FUND_IN
        ON FUND_IN.FUND_NO = FUND_EXCHANGE.FUND_NO_IN
      -- 2018.10.14 JIANXIN 新增基金排序規則(境內外、基金公司、投信顧公會基金類型、母基金排序、基金級別、子基金排序)
      LEFT JOIN (SELECT DISTINCT FUND.FUND_NO, FUND_MASTER.ORDINAL
                   FROM FAS.FUND
                   JOIN FAS.FUND FUND_MASTER
                     ON FUND.FUND_MASTER_NO = FUND_MASTER.FUND_NO
                ) FUND_IN_MASTER
        ON FUND_IN_MASTER.FUND_NO = FUND_IN.FUND_NO
      --2018.11.08 PAN MOD 改寫"轉申購日期",改由 ECS.F_GetSwitchDate 取得
      --LEFT JOIN FAS.CALENDAR CALENDAR
      --  ON CALENDAR.CALENDAR_CODE = FUND_IN.TX_CALENDAR_CODE
      -- AND CALENDAR.HOLIDAY = ECS.F_GETBEFAFTDATE(FUND_OUT.FUND_NO,'3',WTX_DATE,1)
      LEFT JOIN ECS.FUND_SHARE_CLASS
        ON FUND_SHARE_CLASS.AMC_NO = FUND_IN.AMC_NO
       AND FUND_SHARE_CLASS.SHARE_CLASS = FUND_IN.SHARE_CLASS
      LEFT JOIN ECS.V_FUND_CRNCY
        ON V_FUND_CRNCY.CURRENCY_NO = FUND_IN.CURRENCY_NO
      LEFT JOIN ECS.SYSTEM_SETTINGS SYSTEM_SETTINGS1
        ON SYSTEM_SETTINGS1.NAME='DOWNLOADFUNDDOC'
      LEFT JOIN ECS.SYSTEM_SETTINGS SYSTEM_SETTINGS2
        ON SYSTEM_SETTINGS2.NAME='OFF_SHORE_CHANNEL_EXPOSE'
      LEFT JOIN ECS.SYSTEM_SETTINGS SYSTEM_SETTINGS3
        ON SYSTEM_SETTINGS3.NAME='DOWNLOADINVESTORNOTICE'
     WHERE FUND_EXCHANGE.FUND_NO_OUT = WFUND_NO
       -- 2018.12.11 ChengYu 修正轉申購同一基金的錯誤
       AND FUND_IN.FUND_NO != WFUND_NO
       --2023.12.21 begin modified by richard.hu 開放台幣可跨基金公司轉申購V2
       and (FUND_OUT.FUND_CATEGORY = '1'        
            or ( FUND_OUT.FUND_CATEGORY = '2' and 
                 ( NVL(WTX_CURRENCY,FUND_OUT.CURRENCY_NO) = 'NTD' 
                   OR (NVL(WTX_CURRENCY,FUND_OUT.CURRENCY_NO) <> 'NTD' 
                       AND FUND_OUT.CURRENCY_NO  = FUND_IN.CURRENCY_NO
                       AND FUND_OUT.AMC_NO  = FUND_IN.AMC_NO
                      )
                 )
               )
           )
        --2023.12.21 end modified by richard.hu 開放台幣可跨基金公司轉申購V2
     ORDER BY FUND_CATEGORY,AMC_NO_IN,SITCA_FUND_TYPE,ORDINAL, SHARE_CLASS_ORDER, ORDINAL;

END s_GetSwitchFundData;

/

  GRANT EXECUTE ON "ECS"."S_GETSWITCHFUNDDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETTAXATIONTYPE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETTAXATIONTYPE" 
-- =============================================
-- Author:      tingting
-- Create date: 2019/03/22
-- Description: API823 取得無法提供稅籍編號理由
-- =============================================
(
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS
BEGIN

    OPEN OUTDT FOR
    SELECT  HOLDER_TAXATION_TYPE.TYPE AS TAXATION_TYPE                  --CRS 代碼
           ,HOLDER_TAXATION_TYPE.DESCRIPTION AS TAXATION_DESCRIPTION    --CRS 無法取得稅籍原因
           ,HOLDER_TAXATION_TYPE.FLAG AS TAXATION_FLAG                  --稅籍原因說明欄位是否打開 Y/N
      FROM FAS.HOLDER_TAXATION_TYPE         --受益人無法取得稅籍原因
     ORDER BY HOLDER_TAXATION_TYPE.TYPE;

END s_GetTaxationType;

/

  GRANT EXECUTE ON "ECS"."S_GETTAXATIONTYPE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETTDCCACCOUNTNO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETTDCCACCOUNTNO" 
-- =============================================
-- Author:      tingting
-- Create date: 2020/06/12
-- Description: API825 取得集保戶號
-- 2020.11.03 by Chengyu 調整集保戶號產生邏輯、存入ECS.HOLDER_TMP檔
-- 2021.09.10 by Chengyu 修正舊戶加開時，ACCOUNT_NO取號錯誤問題
-- 2021.09.24 by Chengyu 戶號不足6碼則前面補0
-- 2021.11.04 by Chengyu 修正取集保戶號失敗問題
-- EXEC ECS.s_GetTdccAccountNo 'A195228006'
-- =============================================
(
    WID            VARCHAR2,
    OUTDT          OUT SYS_REFCURSOR       -- 回傳的 TABLEDATA
) IS
XACCOUNT_NO NUMBER(7,0); --戶號
XACCOUNT_NO_STR VARCHAR2(7); --戶號字串
XCHECK_NUM INT;     --集保戶號權重加總
XCHECK_ID INT;      --集保戶號檢查碼
BEGIN

    BEGIN

    -- 2021.09.10 by Chengyu 修正舊戶加開時，ACCOUNT_NO取號錯誤問題
    -- 2021.11.04 by Chengyu 修正取集保戶號失敗問題
    SELECT ACCOUNT_NO
      INTO XACCOUNT_NO
      FROM FAS.HOLDER
     WHERE HOLDER.ID = WID;
    EXCEPTION WHEN NO_DATA_FOUND THEN
      XACCOUNT_NO := FAS.SEQ_ACCOUNT_NO.NEXTVAL;
    END;

    -- 2021.09.24 by Chengyu 戶號不足6碼則前面補0
    XACCOUNT_NO_STR := LPAD(CAST(XACCOUNT_NO AS VARCHAR2),6,'0');

    --檢查碼計算方式：10-MOD(SUM(戶號各數字*權重),10)
    XCHECK_NUM := MOD((SUBSTR(XACCOUNT_NO_STR,1,1) * 1 ) +    --戶號第一碼(權重為1)
                      (SUBSTR(XACCOUNT_NO_STR,2,1) * 3 ) +    --戶號第二碼(權重為3)
                      (SUBSTR(XACCOUNT_NO_STR,3,1) * 7 ) +    --戶號第三碼(權重為7)
                      (SUBSTR(XACCOUNT_NO_STR,4,1) * 1 ) +    --戶號第四碼(權重為1)
                      (SUBSTR(XACCOUNT_NO_STR,5,1) * 3 ) +    --戶號第五碼(權重為3)
                      (SUBSTR(XACCOUNT_NO_STR,6,1) * 7 ),10); --戶號第六碼(權重為7)

    XCHECK_ID := CASE WHEN  MOD(XCHECK_NUM,10) = 0 THEN 0 ELSE 10 - MOD(XCHECK_NUM,10) END;


    UPDATE ECS.HOLDER_TMP
       SET  ACCOUNT_NO = XACCOUNT_NO
           ,TDCC_ACCT_NO = CASE WHEN OPEN_TYPE = '1' AND IS_ES_ACCOUNT = 'N' THEN '' --集保戶號 新戶且為預約開戶時由後台寫入
                                ELSE 'A00070000' || XACCOUNT_NO_STR || XCHECK_ID END --集保戶號 "A00070000" +『受益人戶號(XACCOUNT_NO)』 + 『檢查碼(XCHECKNUM)』，共 16碼
     WHERE ID = WID;

    OPEN OUTDT FOR
    SELECT TDCC_ACCT_NO  --集保戶號
      FROM ECS.HOLDER_TMP
     WHERE ID = WID;

END s_GetTdccAccountNo;

/

  GRANT EXECUTE ON "ECS"."S_GETTDCCACCOUNTNO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETTODODATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETTODODATA" 
-- =============================================
-- Author:		CK Kuo
-- Create date: 2009/04/28
-- Description:	取得待辦事項資料
-- Update: 
-- 20151030 待辦事項所呈現之UserID，全改為中文姓名呈現，故新增了六個對應的中文姓名欄位
-- =============================================

(
  -- Add the parameters for the stored procedure here
  v_striUserID IN NVARCHAR2 DEFAULT NULL ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS

BEGIN

   --檢核傳入參數
   IF ( v_striUserID IS NULL ) THEN

   BEGIN
      raise_application_error( -20002, 's_GetUserPermission：UserID不可為NULL，請檢查' );
      RETURN;
   END;
   END IF;
   IF ( v_striUserID IS NULL ) THEN

   BEGIN
      raise_application_error( -20002, 's_GetUserPermission：UserID不可為空白，請檢查' );
      RETURN;
   END;
   END IF;
   OPEN cv_1 FOR
      SELECT DISTINCT ToFunctionID,
                      Message,
                      ToDoDataID,
                      EVAAction,
                      ToDoCreateID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoCreateID), ' ' ) ) ToDoCreateUserName,
                      ToDoCreateDate,
                      ToDoUpdateID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoUpdateID), ' ' ) ) ToDoUpdateUserName,
                      ToDoUpdateDate,
                      ToDoEntryID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoEntryID), ' ' ) ) ToDoEntryUserName,
                      ToDoEntryDate,
                      ToDoVerifyID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoVerifyID), ' ' ) ) ToDoVerifyUserName,
                      ToDoVerifyDate,
                      ToDoApproveID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoApproveID), ' ' ) ) ToDoApproveUserName,
                      ToDoApproveDate,
                      ToDoRejectID,
                      ( NVL( (SELECT USERCNAME FROM AA_USER WHERE USERID = ToDo.ToDoRejectID), ' ' ) ) ToDoRejectUserName,
                      ToDoRejectDate,
                      ToDoFlag,
                      ( SELECT NodeID
                        FROM AA_TreePattern 
                         WHERE FunctionID = ToDo.ToFunctionID AND ROWNUM <= 1 ) NodeID,
                      ( SELECT NodeText
                        FROM AA_TreePattern 
                         WHERE FunctionID = ToDo.ToFunctionID AND ROWNUM <= 1 ) NodeText
        FROM ToDo 
       WHERE ToGroupID IN ( SELECT GroupID
                            FROM TABLE(FN_GetLoginGroup(v_striUserID))  )

               -- And ([ToDo].[EVAAction] Not In ('V','A','R') OR [ToDo].[FromUserID] <> @striUserID)
               AND ( EVAAction NOT IN ( 'V','A' ) 
                     OR-- 自己可以重送自己退回的資料
                     ( ( EVAAction = 'V' AND ( ToDoEntryID <> v_striUserID ) )
                       OR ( EVAAction = 'A' AND ( ( ( ( ToDoUpdateDate = ToDoVerifyDate )
                                                  AND ( ToDoEntryDate <> ToDoVerifyDate ) )
                                                  AND ( ToDoUpdateID <> v_striUserID )--最後修改者動作為驗證
                                                  )
                                                  OR 
                                                  ( ( ( ToDoUpdateDate <> ToDoVerifyDate ) OR ( ToDoEntryDate = ToDoVerifyDate ) ) )--最後修改者動作不為驗證(為輸入或重送)，因為要可以看到自己送件待覆核的資料，故不排除EntryID為自己              
                                                 ) 
                           ) 
                      ) 
                    );
END;

/

  GRANT EXECUTE ON "ECS"."S_GETTODODATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETTODOGROUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETTODOGROUP" 
-- =============================================
  -- Author:    blake
  -- Create date: 2007/08/22
  -- Description: 新增待辦事項資料時,取得有權限做驗證或覆核動作的群組
  -- =============================================

(v_striUserID     IN NVARCHAR2 DEFAULT NULL,
 v_striFunctionID IN NVARCHAR2 DEFAULT NULL,
 v_striEVAAction  IN NVARCHAR2 DEFAULT NULL,
 v_striStatus     IN NVARCHAR2 DEFAULT NULL,
 P_RESULTSET      OUT SYS_REFCURSOR) AS

BEGIN

  OPEN P_RESULTSET FOR
    SELECT DISTINCT AA_DeptGroup.GroupID, ' ' DeptID, ' ' GroupType
      FROM AA_DeptGroup
      JOIN (SELECT DISTINCT GroupID, DeptID, GroupType -- Entry 者在那些部門有對此程式的 Entry 權限 

              FROM (SELECT *
                      FROM TABLE(FN_GetEVA(v_striUserID, v_striFunctionID))
                     WHERE IsE = 1) UG) EntryDept ON AA_DeptGroup.DeptID =
                                                     EntryDept.DeptID
      JOIN AA_GroupRight GRToDo ON AA_DeptGroup.GroupID = GRToDo.GroupID
                               AND GRToDo.FunctionID = v_striFunctionID
                               AND ((v_striEVAAction = 'V' AND
                                   AA_DeptGroup.GroupType = 'V' AND
                                   GRToDo.IsVerify = 1) OR
                                   (v_striEVAAction = 'A' AND
                                   AA_DeptGroup.GroupType = 'A' AND
                                   GRToDo.IsApprove = 1) OR
                                   (v_striEVAAction = 'R' AND
                                   AA_DeptGroup.GroupType = 'E'))

    --            ( @striEVAAction = 'R' And AA_DeptGroup.GroupType = 'E'  And Substring(@striStatus,3,1) = '1' And GRToDo.IsAdd = 1 )OR
    --            ( @striEVAAction = 'R' And AA_DeptGroup.GroupType = 'E'  And Substring(@striStatus,3,1) = '2' And GRToDo.IsUpdate = 1 )OR
    --            ( @striEVAAction = 'R' And AA_DeptGroup.GroupType = 'E'  And Substring(@striStatus,3,1) = '3' And GRToDo.IsDelete = 1 )OR
    --            ( @striEVAAction = 'R' And AA_DeptGroup.GroupType = 'E'  And Substring(@striStatus,3,1) = '4' And GRToDo.IsDelete = 1 )
     WHERE (v_striEVAAction = 'V' AND AA_DeptGroup.GroupType = 'V')
        OR (v_striEVAAction = 'A' AND AA_DeptGroup.GroupType = 'A')
        OR (v_striEVAAction = 'R' AND AA_DeptGroup.GroupType = 'E');
END;

/

  GRANT EXECUTE ON "ECS"."S_GETTODOGROUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETTRADEDATE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETTRADEDATE" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/30
-- Description: 取得一般交易功能(單筆、(不)定額、(不)定額異動、買回、轉換出)之交易日期
-- 2018.04.12 Jim 系統日期改為AP Server 取得
-- 2018.05.31 Jim 取消FAS.FUND.EC_DIFF的計算規則
-- 2018.07.02 tingting INSERT INTO 指定欄位
-- 2018.09.14 JIANXIN 因為資料庫初始預設都是用 2000/01/01 所以要改為2000/01/01
-- 2018.09.17 JIANXIN 因為資料庫初始預設有時不太一樣，所以調整以系統存入為主
-- 2018.09.18 JIANXIN 因為資料庫初始預設有時不太一樣，所以調整以系統存入為主
-- 2018.10.03 JIANXIN 調整cutofftime取錯問題
-- 2020.01.30 ChengYu 調整境外基金申購關帳時間
-- 2020.02.05 ChengYu 新增外幣關帳時間檢核，如未取得關帳時間則回傳錯誤訊息
-- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
-- 2022.02.10 Chengyu 交易時限截止檢查時間使用DBSrver時間(PRD APServer與DBServer時間不同導致檢核通過)
-- =============================================
(
    WTX_TYPE        VARCHAR2,                  -- 交易類型
    WFUND_NO        VARCHAR2,                  -- 基金代碼
    WTX_DATE        DATE,                      -- 交易日期
    WTX_CURRENCY_NO VARCHAR2,                  -- 幣別
    OUTDT           OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

-- 傳出參數
XFUND_ID      VARCHAR2(5);                    -- 基金代碼
XTX_DATE      DATE;                           -- 交易日期 / 異動日期
XIS_SUCCESS   VARCHAR2(1);                    -- 取得資料成功否
XWARNS_TYPE   VARCHAR2(1);                    -- 警示方式
XERROR_MSG    VARCHAR2(250);                  -- 錯誤訊息

--變數
XAPPLY_DATE   DATE;                           --系統日期
XAPPLY_TIME   DATE;                           --系統時間
XTX_CALENDAR_CODE VARCHAR2(5);                -- 行事曆類別
XSALES_DATE   DATE;                           -- 開賣日
XCUT_OFF      DATE;                           -- 交易截止時限
XLAUNCH_DATE  DATE;                           -- 開始募集日
XFIRST_RED_DATE DATE;                         -- 開始買回日
XCLEAR_DATE     DATE;                         -- 停止交易日
XELIMINATION_DATE DATE;                       -- 販售終止日
XCHECK_BUS        INTEGER;                    -- 檢查是否為營業日
XCHECK_VALUE    VARCHAR2(5);                  -- 檢查是否有資料
-- 2020.02.05 ChengYu 新增外幣關帳時間檢核，如未取得關帳時間則回傳錯誤訊息
EX_ERROR        EXCEPTION;                    -- 自訂錯誤檢核
-- 2022.02.10 Chengyu 交易時限截止檢查時間使用DBSrver時間(PRD APServer與DBServer時間不同導致檢核通過)
XDB_DATE        DATE;                         -- DB系統時間

BEGIN

  DELETE FROM ECS.TRADEDATE_TEMP;             --清除TEMPTABLE
  -- 2022.02.10 Chengyu 交易時限截止檢查時間使用DBSrver時間(PRD APServer與DBServer時間不同導致檢核通過)
  XDB_DATE := SYSDATE;
  XAPPLY_DATE := TRUNC(XDB_DATE);             --取得交易日期  

  FOR X IN (    SELECT REGEXP_SUBSTR(WFUND_NO,'[^,]+', 1, LEVEL) AS FUND_NO                             --將傳入的參數以","分開
                FROM DUAL
                CONNECT BY REGEXP_SUBSTR(WFUND_NO, '[^,]+', 1, LEVEL) IS NOT NULL )
  LOOP

    --初始化
    XFUND_ID := X.FUND_NO;
    XTX_DATE := NULL;
    XIS_SUCCESS := NULL;
    XWARNS_TYPE := NULL;
    XERROR_MSG := NULL;
    XTX_CALENDAR_CODE := NULL;
    XSALES_DATE := NULL;
    XCUT_OFF := NULL;
    XLAUNCH_DATE := NULL;
    XFIRST_RED_DATE := NULL;
    XCLEAR_DATE := NULL;
    XELIMINATION_DATE := NULL;
    XCHECK_BUS := NULL;
    XCHECK_VALUE := NULL;

    -- 2020.02.05 ChengYu 新增外幣關帳時間檢核，如未取得關帳時間則回傳錯誤訊息 BEGIN
    BEGIN    
    --從FAS.FUND 取得基本資料
    SELECT FUND.TX_CALENDAR_CODE              -- 行事曆類別
           ,CASE WTX_TYPE
           WHEN '2' THEN
             FUND.EC_RED_CUT_OFF
           ELSE
             -- 2020.01.30 ChengYu 調整境外基金申購關帳時間
             -- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
             CASE WHEN FUND.FUND_CATEGORY = '1' AND WTX_CURRENCY_NO = 'NTD' THEN FUND.EC_PUR_CUT_OFF
                  WHEN FUND.FUND_CATEGORY = '1' AND WTX_CURRENCY_NO <> 'NTD' THEN ECS_FUND.EC_PUR_CUT_OFF_FCY
          WHEN FUND.FUND_CATEGORY = '2' AND WTX_CURRENCY_NO = 'NTD' THEN FUND.EC_PUR_CUT_OFF
          WHEN FUND.FUND_CATEGORY = '2' AND WTX_CURRENCY_NO <> 'NTD' THEN ECS_FUND.EC_PUR_CUT_OFF_FCY
                  ELSE ECS_FUND.EC_PUR_CUT_OFF_FCY END 
           END CUT_OFF                        -- 交易截止時限
           ,FUND.LAUNCH_DATE                  -- 開始募集日
           ,FUND.SALES_DATE                   -- 開賣日
           ,FUND.FIRST_RED_DATE               -- 開始買回日
           ,FUND.CLEAR_DATE                   -- 停止交易日
           ,FUND.ELIMINATION_DATE             -- 販售終止日
           INTO
           XTX_CALENDAR_CODE
           ,XCUT_OFF
           ,XLAUNCH_DATE
           ,XSALES_DATE
           ,XFIRST_RED_DATE
           ,XCLEAR_DATE
           ,XELIMINATION_DATE
     FROM FAS.FUND FUND
     LEFT JOIN ECS.FUND ECS_FUND
       ON ECS_FUND.FUND_NO = FUND.FUND_NO
    WHERE FUND.FUND_NO = XFUND_ID;

    IF XCUT_OFF IS NULL THEN
      RAISE EX_ERROR;
    END IF;

    EXCEPTION
    WHEN EX_ERROR THEN
      RAISE_APPLICATION_ERROR(-20000, '無法取得基金關帳時間，請檢查！');

    END;
    -- 2020.02.05 ChengYu 新增外幣關帳時間檢核，如未取得關帳時間則回傳錯誤訊息 END

    --例外處理狀況
    --1.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T001
    BEGIN

      SELECT DISTINCT CALENDAR_CODE
        INTO XCHECK_VALUE
        FROM FAS.CALENDAR
       WHERE CALENDAR_CODE = XTX_CALENDAR_CODE;

      EXCEPTION
          WHEN NO_DATA_FOUND THEN
            XIS_SUCCESS := 'N';

            SELECT MSGTYPE, MSGCONTENT
              INTO XWARNS_TYPE, XERROR_MSG
              FROM ECS.MSGINFO
             WHERE MSGID = 'T001';

       XTX_DATE := TO_DATE('1900/01/01','YYYY/MM/DD');

       GOTO TO_END;

       CONTINUE;

    END;    

    -- 2018.09.18 JIANXIN 因為資料庫初始預設有時不太一樣，所以調整以系統存入為主
    -- 2018.10.03 JIANXIN 調整cutofftime取錯問題
    -- 2020.01.30 ChengYu 調整境外基金申購關帳時間
    -- 2020.02.26 yunchu s_GetTradeDate(取得一般交易功能之交易日期)增加幣別參數
    -- 2022.02.10 Chengyu 交易時限截止檢查時間使用DBSrver時間(PRD APServer與DBServer時間不同導致檢核通過)
    SELECT TO_DATE(TO_CHAR(CASE WHEN WTX_TYPE = '1' THEN CASE WHEN FUND.FUND_CATEGORY = '1' AND WTX_CURRENCY_NO = 'NTD' THEN FUND.EC_PUR_CUT_OFF 
                                                            WHEN FUND.FUND_CATEGORY = '1' AND WTX_CURRENCY_NO <> 'NTD' THEN ECS_FUND.EC_PUR_CUT_OFF_FCY
                                                              WHEN FUND.FUND_CATEGORY = '2' AND WTX_CURRENCY_NO = 'NTD' THEN FUND.EC_PUR_CUT_OFF
                                                              WHEN FUND.FUND_CATEGORY = '2' AND WTX_CURRENCY_NO <> 'NTD' THEN ECS_FUND.EC_PUR_CUT_OFF_FCY
                                                            ELSE ECS_FUND.EC_PUR_CUT_OFF_FCY END 
                                ELSE EC_RED_CUT_OFF END ,'YYYY/MM/DD') || TO_CHAR(XDB_DATE,'HH24:MI:SS'),'YYYY/MM/DD HH24:MI:SS')
      INTO XAPPLY_TIME
      FROM FAS.FUND
      LEFT JOIN ECS.FUND ECS_FUND
        ON ECS_FUND.FUND_NO = FUND.FUND_NO
     WHERE FUND.FUND_NO = XFUND_ID;

    -- 判斷是否為營業日
    XTX_DATE := XAPPLY_DATE;
    SELECT COUNT(HOLIDAY)
      INTO XCHECK_BUS
      FROM FAS.CALENDAR
     WHERE HOLIDAY = XTX_DATE
       AND CALENDAR_CODE = XTX_CALENDAR_CODE;

    --是營業日則判斷是否已超過交易截止時限
    IF XCHECK_BUS = 0 THEN

       --超過交易截止時限
       IF XAPPLY_TIME > XCUT_OFF THEN

         XCHECK_BUS := 1;

       END IF;

    END IF;

    --不是營業日則往下找大於『申請日期(XAPPLY_DATE)』的次一個營業日當『交易日(XTX_DATE)』
    WHILE XCHECK_BUS = 1
      LOOP

       XTX_DATE := XTX_DATE+1;

       SELECT COUNT(HOLIDAY)
        INTO XCHECK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XTX_DATE
         AND CALENDAR_CODE = XTX_CALENDAR_CODE;

      END LOOP;

    --若傳入參數『交易類型(XTX_TYPE) 』為”1.購物車”且『交易日期(XTX_DATE)』小於『開始募集日(XLAUNCH_DATE) 』時，表示要重新取得交易日期(XTX_DATE)
    --依『基金代碼(XFUND_ID) 』及『行事曆類別(XTX_CALENDAR_CODE) 』至【行事曆檔(FAS.CALENDAR)】取得大於等於『開始募集日(XLAUNCH_DATE)』的最近的營業日，作為該基金的(新)交易日期(XTX_DATE)
    IF WTX_TYPE = '1' AND XTX_DATE < XLAUNCH_DATE THEN

       XTX_DATE := XLAUNCH_DATE;

       SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XTX_DATE
          AND CALENDAR_CODE = XTX_CALENDAR_CODE;

       --不是營業日，繼續往下+1找，直接找到營業日
        WHILE XCHECK_BUS = 1
          LOOP

          XTX_DATE := XTX_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XTX_DATE
               AND CALENDAR_CODE = XTX_CALENDAR_CODE;

         END LOOP;
    END IF;

    --若傳入參數『交易類型(WTX_TYPE) 』為”1.購物車”且『交易日期(@TX_DATE)』小於『開賣日(XSALES_DATE) 』時，表示要重新取得交易日期(XTX_DATE)
    --依『基金代碼(XFUND_ID) 』及『行事曆類別(XTX_CALENDAR_CODE) 』至【行事曆檔(FAS.CALENDAR)】取得大於等於『開賣日(XSALES_DATE)』的最近的營業日，作為該基金的(新)交易日期(XTX_DATE)
    IF WTX_TYPE = '1' AND XTX_DATE < XSALES_DATE THEN

       XTX_DATE := XSALES_DATE;

       SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XTX_DATE
          AND CALENDAR_CODE = XTX_CALENDAR_CODE;

       --不是營業日，繼續往下+1找，直接找到營業日
        WHILE XCHECK_BUS = 1
          LOOP

          XTX_DATE := XTX_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XTX_DATE
               AND CALENDAR_CODE = XTX_CALENDAR_CODE;

         END LOOP;
    END IF;

    --若傳入參數『交易類型(XTX_TYPE) 』為”2. 買回(含轉換出)” 且『交易日期(XTX_DATE)』小於『開始買回日(XFIRST_RED_DATE)』時，表示要重新取得交易日期(XTX_DATE)
    --依『基金代碼(XFUND_ID) 』及『行事曆類別(XTX_CALENDAR_CODE) 』至【行事曆檔(FAS.CALENDAR)】取得大於等於『開始買回日(XFIRST_RED_DATE)』的最近的營業日，作為該基金的(新)交易日期(XTX_DATE)
    IF WTX_TYPE = '2' AND XTX_DATE < XFIRST_RED_DATE THEN

       XTX_DATE := XFIRST_RED_DATE;

       SELECT COUNT(HOLIDAY)
         INTO XCHECK_BUS
         FROM FAS.CALENDAR
        WHERE HOLIDAY = XTX_DATE
          AND CALENDAR_CODE = XTX_CALENDAR_CODE;

       --不是營業日，繼續往下+1找，直接找到營業日
        WHILE XCHECK_BUS = 1
          LOOP

          XTX_DATE := XTX_DATE+1;

           SELECT COUNT(HOLIDAY)
               INTO XCHECK_BUS
               FROM FAS.CALENDAR
              WHERE HOLIDAY = XTX_DATE
               AND CALENDAR_CODE = XTX_CALENDAR_CODE;

         END LOOP;
    END IF;

    --例外處理狀況
    --2.若傳入參數『交易類型(WTX_TYPE) 』為”1.購物車”且『交易日期(XTX_DATE)』大於『停止交易日(XCLEAR_DATE)』且『停止交易日(XCLEAR_DATE)』不為空白時，則回傳錯誤代碼T002
    IF WTX_TYPE = '1' AND XTX_DATE > XCLEAR_DATE AND XCLEAR_DATE IS NOT NULL THEN

      XIS_SUCCESS := 'N';

      SELECT MSGTYPE, MSGCONTENT
        INTO XWARNS_TYPE, XERROR_MSG
        FROM ECS.MSGINFO
       WHERE MSGID = 'T002';


      XTX_DATE := TO_DATE('1900/01/01','YYYY/MM/DD');

      GOTO TO_END;

      CONTINUE;

    END IF;

    --3.若傳入參數『交易類型(WTX_TYPE) 』為”1.購物車”且『交易日期(XTX_DATE)』大於『販售終止日(XELIMINATION_DATE)』且『販售終止日(XELIMINATION_DATE)』不為空白時，則回傳錯誤代碼T003
    IF WTX_TYPE = '1' AND XTX_DATE > XELIMINATION_DATE AND XELIMINATION_DATE IS NOT NULL THEN

      XIS_SUCCESS := 'N';

      SELECT MSGTYPE, MSGCONTENT
        INTO XWARNS_TYPE, XERROR_MSG
        FROM ECS.MSGINFO
       WHERE MSGID = 'T003';


      XTX_DATE := TO_DATE('1900/01/01','YYYY/MM/DD');

      GOTO TO_END;

      CONTINUE;

    END IF;

    --4.若傳入參數『交易類型(WTX_TYPE) 』為”2. 買回(含轉換出)” 且『交易日期(XTX_DATE)』大於『停止交易日(XCLEAR_DATE)』且『停止交易日(XCLEAR_DATE)』不為空白時，則回傳錯誤代碼T004
    IF WTX_TYPE = '2' AND XTX_DATE > XCLEAR_DATE AND XCLEAR_DATE IS NOT NULL THEN

      XIS_SUCCESS := 'N';

      SELECT MSGTYPE, MSGCONTENT
        INTO XWARNS_TYPE, XERROR_MSG
        FROM ECS.MSGINFO
       WHERE MSGID = 'T004';

      XTX_DATE := TO_DATE('1900/01/01','YYYY/MM/DD');

      GOTO TO_END;

      CONTINUE;

    END IF;

    XIS_SUCCESS := 'Y';
    XWARNS_TYPE := '';
    XERROR_MSG  := '';

    GOTO TO_END;

    <<TO_END>>
    INSERT INTO ECS.TRADEDATE_TEMP
    (
         FUND_NO
        ,TX_DATE
        ,IS_SUCCESS
        ,WARNS_TYPE
        ,ERROR_MSG
    )
     SELECT XFUND_ID AS FUND_NO
            ,XTX_DATE AS TX_DATE
            ,XIS_SUCCESS AS IS_SUCCESS
            ,XWARNS_TYPE AS WARNS_TYPE
            ,XERROR_MSG AS ERROR_MSG
         FROM DUAL;

  END LOOP;

  OPEN OUTDT FOR
   SELECT *
       FROM ECS.TRADEDATE_TEMP;

END s_GetTradeDate;

/

  GRANT EXECUTE ON "ECS"."S_GETTRADEDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0101RPT_1_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0101RPT_1_DATA" (
    notloginday      IN NUMBER DEFAULT NULL,
    laststopdates    IN DATE DEFAULT NULL,
    laststopdatee    IN DATE DEFAULT NULL,
    lastlogindates   IN DATE DEFAULT NULL,
    lastlogindatee   IN DATE DEFAULT NULL,
    sgroupid         IN VARCHAR2 DEFAULT NULL,
    susercname       IN VARCHAR2 DEFAULT NULL,
    cv_1 IN OUT SYS_REFCURSOR
)
    AS
BEGIN
    OPEN cv_1 FOR SELECT
        c.*,
        CASE c.banmark
                WHEN 0   THEN '未啟用'
                WHEN 1   THEN '啟用'
                WHEN 2   THEN '停用'
                ELSE ''
            END
        banmark,
        CASE c.stopreason
                WHEN 1   THEN '超過60天未登入'
                WHEN 2   THEN '密碼超過錯誤次數'
                WHEN 3   THEN '由UC0101設為停用'
                WHEN 4   THEN '新創使用者超過天數未登入'
                ELSE ''
            END
        stopreason,
        aa_user.usercname,
        aa_usergroup.groupid,
        aa_group.groupname
                  FROM
        (
            SELECT
                b.*,
                trunc(SYSDATE) - trunc(b.lastlogindate) notloginday
            FROM
                (
                    SELECT
                        MAX(rk) rk,
                        userid
                    FROM
                        aa_user_disable_log
                    GROUP BY
                        userid
                ) a
                LEFT JOIN aa_user_disable_log b ON a.rk = b.rk
                                                   AND a.userid = b.userid
        ) c
        LEFT JOIN aa_user ON c.userid = aa_user.userid
        LEFT JOIN aa_usergroup ON c.userid = aa_usergroup.userid
        LEFT JOIN aa_group ON aa_usergroup.groupid = aa_group.groupid
                  WHERE
        1 = 1
        AND   (
            notloginday IS NULL
            OR    c.notloginday >= notloginday
        )
        AND   (
            laststopdates IS NULL
            OR    c.laststopdate >= laststopdates
        )
        AND   (
            laststopdatee IS NULL
            OR    c.laststopdate < laststopdatee
        )
        AND   (
            lastlogindates IS NULL
            OR    c.lastlogindate >= lastlogindates
        )
        AND   (
            lastlogindatee IS NULL
            OR    c.lastlogindate < lastlogindatee
        )
        AND   (
            sgroupid IS NULL
            OR    aa_usergroup.groupid = sgroupid
        )
        AND   (
            susercname IS NULL
            OR    aa_user.usercname = susercname
        );

END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0101RPT_1_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0102RPT_1_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0102RPT_1_DATA" 
(
  v_striGroupType IN VARCHAR2 DEFAULT '' ,
  v_striDeptID IN VARCHAR2 DEFAULT NULL ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS
   v_GroupType VARCHAR2(1);
   v_DeptID VARCHAR2(20);

BEGIN

      IF v_striDeptID IS NULL
     OR v_striDeptID IS NULL THEN
      v_DeptID := '' ;
   ELSE
      v_DeptID := v_striDeptID ;
   END IF;
   IF v_striGroupType <> ' ' THEN
      v_GroupType := v_striGroupType ;
   ELSE
      v_GroupType := '' ;
   END IF;

   OPEN cv_1 FOR
      WITH DeptMap AS ( SELECT A.DeptID,
                               A.DeptName,
                               A.DeptLevel,
                               B.DeptID SubDeptID,
                               B.DeptName SubDeptName,
                               B.DeptLevel SubDeptLevel
     FROM AA_DEPT A
            JOIN AA_DEPT B
             ON A.DeptID = Trim(B.ParentDeptID)
    WHERE A.DeptLevel = B.DeptLevel - 1 ),
   cteDeptGroupMap AS ( SELECT A.*,
                               B.GroupID,
                               C.GroupName,
                               B.GroupType,
                               D.UserID,
                               E.UserCName,
                               CASE E.BanMark
                                     WHEN 0 THEN u'\672a\555f\7528'
                                     WHEN 1 THEN u'\5df2\555f\7528'
                                     WHEN 2 THEN u'\7981\7528'
									 --2020.08.03 by ChengYu 修復報表顯示離職狀態名稱
                                     WHEN 3 THEN u'\96e2\8077'
                                     END BanMark,
                               CASE GroupType
                                             WHEN to_char('E') THEN u'1'
                                             WHEN to_char('V') THEN u'2'
                                             WHEN to_char('A') THEN u'3'
                               ELSE u'4'
                                  END GroupTypeOrder
     FROM DeptMap A
            LEFT JOIN AA_DEPTGROUP B
             ON A.SubDeptID = B.DeptID
            LEFT JOIN AA_GROUP C
             ON B.GroupID = C.GroupID
            LEFT JOIN AA_USERGROUP D
             ON B.GroupID = D.GroupID
            JOIN AA_USER E
             ON D.UserID = E.UserID
   UNION
   SELECT A.DeptID,
          A.DeptName,
          A.DeptLevel,
          A.DeptID,
          A.DeptName,
          1,
          B.GroupID,
          C.GroupName,
          B.GroupType,
          D.UserID,
          E.UserCName,
          CASE E.BanMark
               WHEN 0 THEN u'\672a\555f\7528'
               WHEN 1 THEN u'\5df2\555f\7528'
               WHEN 2 THEN u'\7981\7528'
			   --2020.08.03 by ChengYu 修復報表顯示離職狀態名稱
               WHEN 3 THEN u'\96e2\8077'
               END BanMark,
          CASE GroupType
                        WHEN to_char('E') THEN u'1'
                        WHEN to_char('V') THEN u'2'
                        WHEN to_char('A') THEN u'3'
          ELSE u'4'
             END GroupTypeOrder
     FROM AA_DEPT A
            LEFT JOIN AA_DEPTGROUP B
             ON A.DeptID = B.DeptID
            LEFT JOIN AA_GROUP C
             ON B.GroupID = C.GroupID
            LEFT JOIN AA_USERGROUP D
             ON B.GroupID = D.GroupID
            JOIN AA_USER E
             ON D.UserID = E.UserID
    WHERE A.ParentDeptID = ' ' )
      SELECT DeptID,
             DeptName,
             DeptLevel,
             SubDeptID,
             SubDeptName,
             SubDeptLevel,
             NVL(GroupID, '') GroupID,
             NVL(GroupName, '') GroupName,
             NVL(GroupType, '') GroupType,
             UserID,
             UserCName,
             BanMark
        FROM cteDeptGroupMap
       WHERE ( v_GroupType IS NULL
               OR GroupType = v_GroupType )
               AND ( v_DeptID IS NULL
               OR SubDeptID = v_DeptID )
        ORDER BY DeptLevel,
                 SubDeptLevel,
                 GroupTypeOrder;
END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0102RPT_1_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0102RPT_2_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0102RPT_2_DATA" 
(
  v_striGroupType IN VARCHAR2 DEFAULT '' ,
  v_striGroupID IN VARCHAR2 DEFAULT NULL ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS
   v_GroupType VARCHAR2(1);
   v_GroupID VARCHAR2(20);

BEGIN

   IF v_striGroupID IS NULL
     OR v_striGroupID = ' ' THEN
      v_GroupID := '' ;
   ELSE
      v_GroupID := v_striGroupID ;
   END IF;
   IF v_striGroupType <> ' ' THEN
      v_GroupType := v_striGroupType ;
   ELSE
      v_GroupType := '' ;
   END IF;
   OPEN cv_1 FOR
      WITH DeptMap AS ( SELECT A.DeptID,
                               A.DeptName,
                               A.DeptLevel,
                               B.DeptID SubDeptID,
                               B.DeptName SubDeptName,
                               B.DeptLevel SubDeptLevel
     FROM AA_Dept A
            JOIN AA_Dept B
             ON A.DeptID = B.ParentDeptID
    WHERE A.DeptLevel = B.DeptLevel - 1 ),
   cteDeptGroupMap AS ( SELECT A.*,
                               B.GroupID GroupID,
                               C.GroupName,
                               B.GroupType,
                               CASE B.GroupType
                                               WHEN to_char('E') THEN u'1'
                                               WHEN to_char('V') THEN u'2'
                                               WHEN to_char('A') THEN u'3'
                               ELSE u'4'
                                  END GroupTypeOrder
     FROM DeptMap A
            LEFT JOIN AA_DeptGroup B
             ON A.SubDeptID = B.DeptID
            LEFT JOIN AA_Group C
             ON B.GroupID = C.GroupID
   UNION 
   SELECT A.DeptID,
          A.DeptName,
          A.DeptLevel,
          A.DeptID,
          A.DeptName,
          1,
          B.GroupID,
          C.GroupName,
          B.GroupType,
          CASE GroupType
                        WHEN to_char('E') THEN u'1'
                        WHEN to_char('V') THEN u'2'
                        WHEN to_char('A') THEN u'3'
          ELSE u'4'
             END GroupTypeOrder
     FROM AA_Dept A
            LEFT JOIN AA_DeptGroup B
             ON A.DeptID = B.DeptID
            LEFT JOIN AA_Group C
             ON B.GroupID = C.GroupID
    WHERE A.ParentDeptID = ' ' ) 
      SELECT DeptID,
             DeptName,
             DeptLevel,
             SubDeptID,
             SubDeptName,
             SubDeptLevel,
             NVL(GroupID, ' ') GroupID,
             NVL(GroupName, ' ') GroupName,
             NVL(GroupType, ' ') GroupType
        FROM cteDeptGroupMap 
       WHERE ( v_GroupType IS NULL
               OR GroupType = v_GroupType )
               AND ( ( v_GroupID IS NULL
               OR GroupID = v_GroupID )
               AND GroupID <> ' ' )
        ORDER BY GroupTypeOrder;
END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0102RPT_2_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0106RPT
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0106RPT" 
(
  -- Add the parameters for the stored procedure here
  v_strProductID IN NVARCHAR2 DEFAULT NULL 
)
AS

BEGIN

   NULL;
-- SET NOCOUNT ON added to prevent extra result sets from
-- interfering with SELECT statements.
-- Insert statements for procedure here
/*Limitation:Syntax Not Recognized:*/
/*Limitation:Syntax Not Recognized:. GroupID = unpvt . GroupID ) permission ON fun . FunctionID = permission . FunctionID WHERE permission . GroupID <> '' AND fun . ProductID IN ( 'PTPF' , 'FTAS' , @strProductID ) UNION */
END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0106RPT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0117RPT_1_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0117RPT_1_DATA" 
(
       v_striDateTime_ST  IN VARCHAR2 DEFAULT '',
       v_striDateTime_END IN VARCHAR2 DEFAULT '',
       cv_1               IN OUT SYS_REFCURSOR
) AS
  v_UserID           VARCHAR2(80);
  v_UserCName        VARCHAR2(80);
  v_HostName         VARCHAR2(80);
  v_LoginType        VARCHAR2(80);
  v_LoginDateTime    DATE;
  v_PreLoginDateTime DATE;
  v_PreLoginType     VARCHAR2(80);
  v_PreHostName      VARCHAR2(80);

  CURSOR GetUserID IS       
  SELECT DISTINCT UserID FROM AA_LoginLog
  WHERE TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= LoginDateTime 
  AND   LoginDateTime < TO_DATE(v_striDateTime_END,'yyyy/mm/dd');

  CURSOR LoginAndLogout IS
  SELECT  B.UserCName, A.HostName, A.LoginType, A.LoginDateTime
  FROM AA_LoginLog A                                                                 
  LEFT JOIN AA_User B ON A.UserID = B.UserID
  WHERE TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= A.LoginDateTime 
  AND   A.LoginDateTime < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
  AND   ((LoginType BETWEEN 0 AND 1) OR LoginType = 4)
  AND   A.UserID = v_UserID
  ORDER BY LoginDateTime;

BEGIN

  DELETE FROM GETUC0117RPT_TEMP;

  OPEN GetUserID;
  FETCH GetUserID INTO v_Userid;
  WHILE Sqlserver_Utilities.fetch_status(GetUserID%FOUND) = 0 
  LOOP 
    BEGIN
      v_UserCName     := '';
      v_HostName      := '';
      v_LoginType     := 2;
      v_LoginDateTime := TO_DATE(v_striDateTime_END, 'yyyy/mm/dd');

      OPEN LoginAndLogout;
      FETCH LoginAndLogout INTO v_UserCName, v_HostName, v_LoginType, v_LoginDateTime;
      v_PreLoginType     := 0;
      v_PreLoginDateTime := '';
      v_PreHostName      := '';

      BEGIN
        SELECT LoginType, LoginDateTime, HostName
        INTO v_PreLoginType, v_PreLoginDateTime, v_PreHostName
        FROM (SELECT LoginType, LoginDateTime, HostName
                FROM AA_LOGINLOG
               WHERE UserID = v_UserID
                 AND v_LoginDateTime > LoginDateTime
                 AND ((LoginType BETWEEN 0 AND 1) OR LoginType = 4)
               ORDER BY LoginDateTime DESC)
        WHERE ROWNUM = 1;

      EXCEPTION
      WHEN NO_DATA_FOUND THEN
        BEGIN
          v_PreLoginType     := 0;
          v_PreLoginDateTime := '';
          v_PreHostName      := '';
        END;
      END;

      WHILE Sqlserver_Utilities.fetch_status(LoginAndLogout%FOUND) = 0 
      LOOP
      BEGIN
        IF v_LoginType = 0 THEN
          INSERT INTO Getuc0117rpt_Temp
            (UserID, UserCName, HostName, LoginDateTime, LogoutDateTime)
          VALUES
            (v_UserID,
             v_UserCName,
             v_PreHostName,
             TO_CHAR(v_PreLoginDateTime, 'yyyy-mm-dd HH24:MI:SS'),
             TO_CHAR(v_LoginDateTime, 'yyyy-mm-dd HH24:MI:SS'));
        END IF;

        IF (v_LoginType = 1 OR v_LoginType = 4) THEN

          IF ((v_PreLoginType = 1 OR v_PreLoginType = 4) AND
             v_PreLoginDateTime > TO_DATE(v_striDateTime_ST, 'yyyy/mm/dd')) THEN

            INSERT INTO Getuc0117rpt_Temp
              (UserID, UserCName, HostName, LoginDateTime, LogoutDateTime)
            VALUES
              (v_UserID,
               v_UserCName,
               v_PreHostName,
               TO_CHAR(v_PreLoginDateTime, 'yyyy-mm-dd HH24:MI:SS'),
               '');
          END IF;
        END IF;

        v_PreLoginType     := v_LoginType;
        v_PreLoginDateTime := v_LoginDateTime;
        v_PreHostName      := v_HostName;
        FETCH LoginAndLogout INTO v_UserCName, v_HostName, v_LoginType, v_LoginDateTime;
      END;
      END LOOP;

      v_LoginType := 1;

      BEGIN
        SELECT LoginType, LoginDateTime, HostName
          INTO v_LoginType, v_LoginDateTime, v_HostName
          FROM (SELECT LoginType, LoginDateTime, HostName
                  FROM AA_LOGINLOG
                 WHERE v_UserID = UserID
                   AND v_PreLoginDateTime < LoginDateTime
                   AND ((LoginType BETWEEN 0 AND 1) OR LoginType = 4)
                 ORDER BY LoginDateTime DESC)
         WHERE ROWNUM = 1;

      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          BEGIN
             v_LoginType := 1;
          END;
      END;

      IF (v_LoginType = 0) THEN    
        INSERT INTO Getuc0117rpt_Temp
          (UserID, UserCName, HostName, LoginDateTime, LogoutDateTime)
        VALUES
          (v_UserID,
           v_UserCName,
           v_PreHostName,
           TO_CHAR(v_PreLoginDateTime, 'yyyy-mm-dd HH24:MI:SS'),
           TO_CHAR(v_LoginDateTime, 'yyyy-mm-dd HH24:MI:SS'));
      END IF;

      IF (v_LoginType <> 2) THEN
        IF ((v_PreLoginType = 1 OR v_PreLoginType = 4) AND
           v_PreLoginDateTime > TO_DATE(v_striDateTime_ST, 'yyyy/mm/dd')) THEN
          INSERT INTO Getuc0117rpt_Temp
            (UserID, UserCName, HostName, LoginDateTime, LogoutDateTime)
          VALUES
            (v_UserID,
             v_UserCName,
             v_PreHostName,
             TO_CHAR(v_PreLoginDateTime, 'yyyy-mm-dd HH24:MI:SS'),
             '');
        END IF;
      END IF;      

      CLOSE LoginAndLogout;        
      FETCH GetUserID INTO v_UserID;     
    END; 
  END LOOP;
  CLOSE GetUserID;

  OPEN cv_1 FOR
    SELECT UserID, UserCName, HostName, LoginDateTime, LogoutDateTime
      FROM GETUC0117RPT_TEMP;
  DELETE FROM GETUC0117RPT_TEMP;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0117RPT_1_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0117RPT_2_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0117RPT_2_DATA" 
(
  v_striDateTime_ST IN VARCHAR2 DEFAULT '' ,
  v_striDateTime_END IN VARCHAR2 DEFAULT '' ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS

BEGIN
   OPEN cv_1 FOR
   SELECT A.UserID, 
    B.UserCName,
    A.HostName,
    TO_CHAR(A.LoginDateTime, 'yyyy-mm-dd HH24:MI:SS') LoginDateTime,
    CASE A.BanMark WHEN 2 THEN '是' ELSE '否' END BanMark,
    CASE 
    WHEN A.LoginType = 18 OR A.ErrorTimes = -1 THEN '-' 
    ELSE TO_CHAR(A.ErrorTimes) END ErrorTimes,
    CASE LoginType 
    WHEN 2 THEN '系統已關帳'
    WHEN 3 THEN '密碼已過期'
    WHEN 5 THEN '帳戶被禁用'
    WHEN 6 THEN '帳戶被代理'
    WHEN 7 THEN '帳戶被使用'
    WHEN 8 THEN '密碼錯誤'
    WHEN 9 THEN '密碼錯誤超過限制'
    WHEN 10 THEN '其他錯誤'
    WHEN 11 THEN '帳戶未生效'
    WHEN 14 THEN '登入者未設定所屬部門'
    WHEN 18 THEN '無此使用者'
    WHEN 98 THEN 'Ldap登入帳號密碼錯誤'
    WHEN 99 THEN 'Ldap登入失敗'
    END LoginType
    FROM AA_LoginLog A
    LEFT JOIN AA_User B ON A.UserID = B.UserID
    WHERE TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= LoginDateTime 
    AND   LoginDateTime < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
    AND LoginType IN (2,3,5,6,7,8,9,10,11,14,18,98,99)
    ORDER BY LoginDateTime;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0117RPT_2_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0117RPT_3_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0117RPT_3_DATA" 
(
  v_striDateTime_ST IN VARCHAR2 DEFAULT '' ,
  v_striDateTime_END IN VARCHAR2 DEFAULT '' ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS
    CURSOR cur_GetAccountStatusUserID IS
    SELECT DISTINCT UserID                
    FROM   AA_AccountStatus 
    WHERE TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= UpdateDate
    AND UpdateDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd');

    CURSOR cur_GetPwdHistoryUserID IS
    SELECT DISTINCT UserID               
    FROM    AA_UserPwdHistory ;

    v_UserID VARCHAR2(80);
    v_UserCName VARCHAR2(80);
    v_UpdateID VARCHAR2(80);
    v_UpdateCName VARCHAR2(80);
    v_BanMark VARCHAR2(80);
    v_PreBanMark VARCHAR2(80);
    v_UpdateDate DATE;
    v_HostName VARCHAR2(80);

    CURSOR cur_GetUnLock IS
    SELECT  A.UpdateID ,
            B.UserCName ,
            C.UserCName ,
            A.HostName ,
            A.UpdateDate ,
            A.BanMark
    FROM    AA_AccountStatus A
    LEFT JOIN AA_User B ON A.UpdateID = B.UserID
    LEFT JOIN AA_User C ON A.UserID = C.UserID
    WHERE   A.UserID = v_UserID
            AND TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= A.UpdateDate
            AND A.UpdateDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
    ORDER BY A.UpdateDate;  

    CURSOR cur_GetPwdHistory IS    
    SELECT  A.UpdateID ,
            B.UserCName ,
            C.UserCName ,
            A.HostName ,
            A.UpdateDate             
    FROM    AA_UserPwdHistory A
    LEFT JOIN AA_User B ON A.UpdateID = B.UserID
    LEFT JOIN AA_User C ON A.UserID = C.UserID
    WHERE   A.UserID = v_UserID
            AND TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= A.UpdateDate
            AND A.UpdateDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
    ORDER BY A.PwdChgDate;

BEGIN
    DELETE FROM GETUC0117RPT_TEMP;

    OPEN cur_GetAccountStatusUserID;
    FETCH cur_GetAccountStatusUserID INTO v_UserID;
    WHILE Sqlserver_Utilities.fetch_status(cur_GetAccountStatusUserID%FOUND) = 0
    LOOP
      BEGIN                      
        OPEN cur_GetUnLock;
        FETCH cur_GetUnLock INTO v_UpdateID, v_UpdateCName, v_UserCName, v_HostName, v_UpdateDate, v_BanMark;

        v_PreBanMark := 1;

        BEGIN
        SELECT BanMark                         
        INTO   v_PreBanMark
        FROM   (SELECT BanMark 
                FROM AA_AccountStatus
                WHERE UserID = v_UserID
                      AND v_UpdateDate > UpdateDate
                ORDER BY UpdateDate DESC)                      
        WHERE   ROWNUM = 1;                  

        EXCEPTION
          WHEN NO_DATA_FOUND THEN
          v_PreBanMark := 1;
        END;

        WHILE Sqlserver_Utilities.fetch_status(cur_GetUnLock%FOUND) = 0
          LOOP
            BEGIN                            
              IF ( v_PreBanMark = 2 AND v_BanMark = 1 ) THEN                                                  
              BEGIN
                 INSERT  INTO GETUC0117RPT_TEMP
                              ( UpdateID ,
                                UpdateCName ,
                                UserID ,
                                UserCName ,
                                HostName ,
                                UpdateDate ,
                                ChangeItem
                               )
                       VALUES ( v_UpdateID ,
                                v_UpdateCName ,
                                v_UserID ,
                                v_UserCName ,
                                v_HostName ,
                                TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),
                                '解除鎖定'
                               );
              END;
              END IF;

              v_PreBanMark := v_BanMark;

              FETCH cur_GetUnLock INTO v_UpdateID, v_UpdateCName, v_UserCName, v_HostName, v_UpdateDate, v_BanMark;
            END;
          END LOOP;
        CLOSE cur_GetUnLock;
        FETCH cur_GetAccountStatusUserID INTO v_UserID;
      END;
    END LOOP;
    CLOSE cur_GetAccountStatusUserID;

    OPEN cur_GetPwdHistoryUserID;
    FETCH cur_GetPwdHistoryUserID INTO v_UserID;
    WHILE Sqlserver_Utilities.fetch_status(cur_GetPwdHistoryUserID%FOUND) = 0
    LOOP
      BEGIN                      
        OPEN cur_GetPwdHistory;
        FETCH cur_GetPwdHistory INTO v_UpdateID, v_UpdateCName, v_UserCName, v_HostName, v_UpdateDate;                               
        WHILE Sqlserver_Utilities.fetch_status(cur_GetPwdHistory%FOUND) = 0
          LOOP
            BEGIN
                 INSERT  INTO GETUC0117RPT_TEMP
                              ( UpdateID ,
                                UpdateCName ,
                                UserID ,
                                UserCName ,
                                HostName ,
                                UpdateDate ,
                                ChangeItem
                               )
                       VALUES ( v_UpdateID ,
                                v_UpdateCName ,
                                v_UserID ,
                                v_UserCName ,
                                v_HostName ,
                                TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),
                                '變更密碼'
                               );                  

              FETCH cur_GetPwdHistory INTO v_UpdateID, v_UpdateCName, v_UserCName, v_HostName, v_UpdateDate;
            END;
          END LOOP;
        CLOSE cur_GetPwdHistory;
        FETCH cur_GetPwdHistoryUserID INTO v_UserID;
      END;
    END LOOP;
    CLOSE cur_GetPwdHistoryUserID;

    OPEN cv_1 FOR
    SELECT UpdateID
           ,UpdateCName
           ,UserID
           ,UserCName
           ,HostName
           ,UpdateDate
           ,ChangeItem
    FROM   GETUC0117RPT_TEMP
    ORDER BY UpdateDate;
    DELETE FROM GETUC0117RPT_TEMP;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0117RPT_3_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUC0117RPT_4_DATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUC0117RPT_4_DATA" 
(
  v_striDateTime_ST IN VARCHAR2 DEFAULT '' ,
  v_striDateTime_END IN VARCHAR2 DEFAULT '' ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS
    CURSOR cur_GetUserID IS
    SELECT DISTINCT UserID              
    FROM AA_User_Log 
    WHERE TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= LogDate
    AND LogDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd');        

    v_UserID VARCHAR2(80);
    v_UserCName VARCHAR2(80);
    v_UserEName VARCHAR2(80);
    v_UpdateID VARCHAR2(80);
    v_UpdateCName VARCHAR2(80);
    v_BanMark VARCHAR2(80);
    v_PreBanMark VARCHAR2(80);
    v_UpdateDate DATE;
    v_Email VARCHAR2(80);
    v_TelNo VARCHAR2(80);
    v_ID VARCHAR2(80);
    v_PreUserCName VARCHAR2(80);
    v_PreUserEName VARCHAR2(80);
    v_PreEmail VARCHAR2(80);
    v_PreTelNo VARCHAR2(80);
    v_PreID VARCHAR2(80);
    v_LogType VARCHAR2(80);
    v_LoginHostName VARCHAR2(80);
    v_IsForceChangePwd VARCHAR2(80);
    v_PreIsForceChangePwd VARCHAR2(80);
    v_Pwd VARCHAR2(80);
    v_PrePwd VARCHAR2(80);
    v_CustomLogin VARCHAR2(80);
    v_PreCustomLogin VARCHAR2(80);

    CURSOR cur_GetData IS
    SELECT A.UpdateID,B.UserCName,A.LoginHostName,A.LogDate,LogType,A.UserCName,
            A.UserEName,A.TelNo,A.BanMark,A.IsForceChangePwd,A.ID,A.Email,A.Pwd, A.CustomLogin
    FROM AA_User_Log A
    LEFT OUTER JOIN AA_User B ON A.UpdateID = B.UserID 
    WHERE v_UserID = A.UserID
          AND TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= A.LogDate 
          AND A.LogDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
    ORDER BY LogDate;

BEGIN
    DELETE FROM GETUC0117RPT_TEMP;

    OPEN cur_GetUserID;
    FETCH cur_GetUserID INTO v_UserID;
    WHILE Sqlserver_Utilities.fetch_status(cur_GetUserID%FOUND) = 0
    LOOP
      BEGIN                      
        OPEN cur_GetData;
        FETCH cur_GetData INTO v_UpdateID,v_UpdateCName,v_LoginHostName,v_UpdateDate,v_LogType
              ,v_UserCName,v_UserEName,v_TelNo,v_BanMark,v_IsForceChangePwd,v_ID,v_Email,v_Pwd, v_customlogin;

        v_PreUserCName := '';
        v_PreUserEName := '';        
        v_PreTelNo := '';
        v_PreBanMark := '0';       
        v_PreIsForceChangePwd := '1';        
        v_PreID := '';   
        v_PreEmail := '';  
        v_PrePwd := '';     
        v_CustomLogin := '';

        BEGIN
        SELECT UserCName
               ,UserEName               
               ,TelNo
               ,BanMark               
               ,IsForceChangePwd               
               ,ID
               ,Email 
               ,Pwd 
               ,customlogin
        INTO   v_PreUserCName
               ,v_PreUserEName               
               ,v_PreTelNo
               ,v_PreBanMark
               ,v_PreIsForceChangePwd
               ,v_PreID
               ,v_PreEmail               
               ,v_PrePwd
               ,v_PreCustomLogin
        FROM 
          (SELECT UserCName
                  ,UserEName               
                  ,TelNo
                  ,BanMark               
                  ,IsForceChangePwd               
                  ,ID
                  ,Email 
                  ,Pwd 	     
                  ,CustomLogin
          FROM   AA_User_Log    
          WHERE  v_UserID = UserID
          AND   v_UpdateDate > LogDate
          ORDER BY LogDate DESC)
        WHERE   ROWNUM = 1;

        EXCEPTION
          WHEN NO_DATA_FOUND THEN
          BEGIN
            v_PreUserCName := '';
            v_PreUserEName := '';        
            v_PreTelNo := '';
            v_PreBanMark := '0';       
            v_PreIsForceChangePwd := '1';              
            v_PreID := '';   
            v_PreEmail := '';   
            v_PrePwd := ''; 
            v_PreCustomLogin := '';
          END;
        END;        

        WHILE Sqlserver_Utilities.fetch_status(cur_GetData%FOUND) = 0
          LOOP
            BEGIN                            
              v_LogType := CASE v_LogType WHEN 'A' THEN '新增' WHEN 'U' THEN '修改' WHEN 'D' THEN '刪除' ELSE '未知動作' END; 
              IF(v_PreUserCName <> v_UserCName ) THEN
              BEGIN
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '中文姓名' , v_PreUserCName , v_UserCName );
              END;
              END IF;

              IF(v_PreUserEName <> v_UserEName) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '英文姓名' , v_PreUserEName , v_UserEName );
              END;
              END IF;                        

              IF(v_PreTelNo <> v_TelNo) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '聯絡電話' , v_PreTelNo , v_TelNo );
              END;
              END IF;

              IF(v_PreBanMark <> v_BanMark) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '帳號狀況' , 
                              CASE v_PreBanMark WHEN '1' THEN '啟用' WHEN '2' THEN '停用' ELSE '未啟用' END , 
                              CASE v_BanMark WHEN '1' THEN '啟用' WHEN '2' THEN '停用' ELSE '未啟用' END  );
              END;
              END IF;      		             

              IF(v_PreIsForceChangePwd <> v_IsForceChangePwd) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '下次登入變更密碼' , 
                              CASE v_PreIsForceChangePwd WHEN '1' THEN '是' ELSE '否' END , 
                              CASE v_IsForceChangePwd WHEN '1' THEN '是' ELSE '否' END  ); 
              END;
              END IF;

              IF(v_PreID <> v_ID) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '身分證號' , v_PreID, v_ID  ); 
              END;
              END IF;

              IF(v_PreEmail <> v_Email) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '電子郵件信箱' , v_PreEmail, v_Email ); 
              END;
              END IF;

              IF(v_PrePwd <> v_Pwd) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '密碼' , v_PrePwd, v_Pwd ); 
              END;
              END IF;

              IF(v_PreCustomLogin<> v_CustomLogin) THEN
              BEGIN 
                  INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
                   VALUES ( v_UpdateID,v_UpdateCName,v_UserID,v_UserCName,v_LoginHostName,TO_CHAR(v_UpdateDate, 'yyyy-mm-dd HH24:MI:SS'),v_LogType , '自定義登入方式' , 
                              CASE v_PreCustomLogin WHEN '1' THEN '資料庫驗證模式' ELSE 'LDAP驗證模式' END , 
                              CASE v_CustomLogin WHEN '1' THEN '資料庫驗證模式' ELSE 'LDAP驗證模式' END  ); 
              END;
              END IF;


              v_PreUserCName := v_UserCName; 
              v_PreUserEName := v_UserEName;
              v_PreID := v_ID;
              v_PreTelNo := v_TelNo;
              v_PreBanMark := v_BanMark;
              v_PreEmail := v_Email;
              v_PreIsForceChangePwd := v_IsForceChangePwd;
              v_PrePwd := v_Pwd;	
              v_PreCustomLogin := v_CustomLogin;

              FETCH cur_GetData INTO v_UpdateID,v_UpdateCName,v_LoginHostName,v_UpdateDate,v_LogType
                    ,v_UserCName,v_UserEName,v_TelNo,v_BanMark,v_IsForceChangePwd,v_ID,v_Email,v_Pwd, v_CustomLogin;
            END;
          END LOOP;
        CLOSE cur_GetData;
        FETCH cur_GetUserID INTO v_UserID;
      END;
    END LOOP;
    CLOSE cur_GetUserID;   

    INSERT INTO GETUC0117RPT_TEMP ( UpdateID,UpdateCName,UserID,UserCName,HostName,UpdateDate, LogType , ChangeItem , BeforeChange , AfterChange )
    SELECT A.UpdateID,B.UserCName,A.UserID,C.UserCName,A.HostName,TO_CHAR(A.LogDate, 'yyyy-mm-dd HH24:MI:SS')
    ,CASE LogType WHEN 'A' THEN '新增' ELSE '刪除' END LogType
    ,'群組'
    ,CASE LogType WHEN 'A' THEN '' ELSE A.GroupID END BeforeChange
    ,CASE LogType WHEN 'A' THEN A.GroupID ELSE '' END AfterChange
    FROM AA_UserGroup_Log A
    LEFT OUTER JOIN AA_User B ON A.UpdateID = B.UserID 
    LEFT OUTER JOIN AA_User C ON A.UserID = C.UserID 
    WHERE (LogType = 'D' OR LogType = 'A')
    AND   TO_DATE(v_striDateTime_ST,'yyyy/mm/dd') <= LogDate 
      AND   LogDate < TO_DATE(v_striDateTime_END,'yyyy/mm/dd')
    ORDER BY LogDate DESC;

    OPEN cv_1 FOR
    SELECT UpdateID
           ,UpdateCName
           ,UserID
           ,UserCName
           ,HostName
           ,UpdateDate
           ,LogType
           ,ChangeItem
           ,BeforeChange
           ,AfterChange
    FROM   GETUC0117RPT_TEMP
    ORDER BY UpdateDate;
    DELETE FROM GETUC0117RPT_TEMP;

END;

/

  GRANT EXECUTE ON "ECS"."S_GETUC0117RPT_4_DATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETUSERPERMISSION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETUSERPERMISSION" 
(
       STRUSERID     IN VARCHAR2,
       STRFUNCTIONID IN VARCHAR2,
       P_RESULTSET   OUT SYS_REFCURSOR
) AS
       m_ReviewLevel Number(1) :=2;
BEGIN
  OPEN P_RESULTSET FOR
    SELECT DISTINCT STRUSERID AS UserID,
                    STRFUNCTIONID AS FunctionID, 
                    NVL((SELECT FormName
                          FROM SWProductsDetail
                         WHERE FunctionID = STRFUNCTIONID),
                        '') As FunctionName,

                       case 
                       when  sum(                                                                                                                                                                        
                                          Decode(NVL(GR.IsAdd,0),1,1,0)
                                          *
                                          Decode(UG.GroupType, 'E', 1, 0)
                                 ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsAdd

                        ,
                        case
                        when  sum(
                                     Decode(NVL(GR.IsUpdate, 0),1,1,0)
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsUpdate                       
                        ,                                                       
                        case
                        when  sum(
                                     Decode(NVL(GR.IsDelete,0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        as IsDelete
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsPrint, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsPrint                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExport, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsExport                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsVerify, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsVerify                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsApprove, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsApprove                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsPreviewPrint, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                       As IsPreviewPrint                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsQuery, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                       As IsQuery                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsRecover, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                        As IsRecover
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExecute, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                       As IsExecute                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExp1, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                      As IsExp1                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExp2, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                      As IsExp2                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExp3, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                      As IsExp3                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExp4, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                      As IsExp4                        
                        ,
                        case
                        when  sum(
                                  Decode(NVL(GR.IsExp5, 0),1,1,0)                        
                                  ) > 0
                        Then  cast(1 as number(1))
                        Else  cast(0 as number(1))
                        END 
                      As IsExp5    
                      ,
                      m_ReviewLevel 
                      as ReviewLevel   -- 此欄位暫無用                    




      FROM table(FN_GetLoginGroup(STRUSERID)) UG, AA_GroupRight GR
     where UG.GroupID = GR.GroupID(+)
       AND GR.FunctionID = STRFUNCTIONID
       Group by FunctionID;
       --,FunctionName,STRUSERID

END S_GETUSERPERMISSION;

/

  GRANT EXECUTE ON "ECS"."S_GETUSERPERMISSION" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETZIP3A
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETZIP3A" 
(
  -- Add the parameters for the stored procedure here
  v_addr IN VARCHAR2 DEFAULT '' ,
  cv_1 IN OUT SYS_REFCURSOR
)
AS
   -- SET NOCOUNT ON added to prevent extra result sets from
   -- interfering with SELECT statements.
   v_index NUMBER(10,0);
   v_tempAddr VARCHAR2(255);
   v_condition VARCHAR2(100);
 	 v_count NUMBER(10,0);  

BEGIN

   v_tempAddr := v_addr ;
   <<Search>>
   --最後字元：市/區/島/鎮/鄉/台
   --市
   v_index := INSTR(v_addr, '市') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   --區
   v_index := INSTR(v_addr, '區') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   --島
   v_index := INSTR(v_addr, '島') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   ----特殊案例-海南島東沙群島...等
   --SET @index=@index+CHARINDEX('島',RIGHT(@addr,len(@addr)-@index))
   --IF (@index<>0 AND @index > 3) GOTO GetZIP
   --鎮
   v_index := INSTR(v_addr, '鎮') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   --鄉
   v_index := INSTR(v_addr, '鄉') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   --台
   v_index := INSTR(v_addr, '釣魚台') ;
   IF ( v_index <> 0
     AND v_index > 3 ) THEN
      GOTO GetZIP;
   END IF;
   IF ( v_index <= 3
     AND v_index <> 0 ) THEN
      GOTO Search;
   END IF;
   <<GetZIP>>
	/*	20160129 updated by Grace 
		當路名包含關鍵字'市'、'區'、'島'、'鎮'、'鄉'、'台'時，
		會造成誤判，導致在CityArea查詢不到對應的郵遞區號，
		因此改與RALL的ROAD(路名)進行比對，取得對應的郵遞區號 
	*/

  SELECT COUNT(*) INTO v_count FROM CityArea WHERE CityArea = SUBSTR(v_addr, 1, v_index);
	IF (v_count = 0) THEN
    OPEN cv_1 FOR
		SELECT         ZIP3A ZIP_CODE, '' AREA
		FROM           RALL
		WHERE	( ROAD LIKE u'%\5e02%' OR ROAD LIKE u'%\5340%' OR  ROAD LIKE u'%\5cf6%' OR  ROAD LIKE u'%\93ae%' OR  ROAD LIKE u'%\9109%' OR  ROAD LIKE u'%\53f0%' ) 
		AND v_addr LIKE +'%'+ROAD+'%';
	ELSE
    OPEN cv_1 FOR
    SELECT ZipCode ZIP_CODE,
           '' AREA
    FROM CityArea--vw_CityArea                
    WHERE CityArea = SUBSTR(v_addr, 1, v_index);
	END IF;


/*   OPEN cv_1 FOR
      SELECT ZipCode ZIP_CODE,
             '' AREA
        FROM CityArea--vw_CityArea

       WHERE CityArea = SUBSTR(v_addr, 1, v_index);*/
END;

/

  GRANT EXECUTE ON "ECS"."S_GETZIP3A" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETZIPCODE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETZIPCODE" 
(
  --縣市
  v_city IN VARCHAR2 DEFAULT NULL ,
  --鄉鎮市
  v_area IN VARCHAR2 ,
  --路
  v_road IN VARCHAR2 DEFAULT NULL  ,
  --鄰
  v_village IN VARCHAR2 DEFAULT NULL ,
  --巷
  v_allay IN VARCHAR2 DEFAULT NULL ,
  --弄
  v_lane IN VARCHAR2 DEFAULT NULL ,
  --號
  v_no IN VARCHAR2 DEFAULT NULL ,
  --之幾號
  v_no_1 IN VARCHAR2 DEFAULT NULL ,
  --樓
  v_floor IN VARCHAR2 DEFAULT NULL ,
  
  -- OUTPUT 參數
  cv_1 IN OUT SYS_REFCURSOR 

)
AS
  /*
  Author:       Grace
  Create date:  20150423
  Description:  地址控制項使用，取得5碼郵遞區號
  Notes:
  1. Oracle版的CMP.Condition 紀錄的SQL Command不完全正確，
     因此參考MAASQL版的處理流程，將SQL Command寫在此Procedure當中，

  2. 當MSSQL的CMP.Condition有新增或是異動，必須同步調整此Procedure
  */

	--宣告CURSOR
	CURSOR cur_CMP
	 IS SELECT 
 		RALL.ZIPCODE
		,RALL.CITY
		,RALL.AREA
		,RALL.VILLAGE
		,RALL.ROAD
		,RALL.EVEN
		,RALL.CMP_LABLE
		,CAST(RALL.LANE AS VARCHAR2(4)) LANE
		,CAST(RALL.ALLEY AS VARCHAR2(4)) ALLEY
		,RALL.NO_BGN
		,RALL.NO_BGN1
		,RALL.NO_END
		,RALL.NO_END1
		,RALL.FLOOR
		,CMP.Condition
	 FROM RALL 
	 LEFT JOIN CMP 
	  ON RTRIM(CMP.NO) = RTRIM(RALL.CMP_LABLE)
	WHERE RALL.CITY = v_city
	 AND RALL.AREA LIKE v_area || '%'
	 AND RALL.ROAD = v_road;


	--for CURSOR FETCH使用
	v_cur_zipcode VARCHAR2(5);
	v_cur_city VARCHAR2(10);
	v_cur_area VARCHAR2(10);
	v_cur_village VARCHAR2(10);
	v_cur_road VARCHAR2(22);
	v_cur_even VARCHAR2(1);
	v_cur_cmp_lable VARCHAR2(1);
	v_cur_lane VARCHAR2(10);
	v_cur_alley VARCHAR2(10);
	v_cur_no_bgn VARCHAR2(10);
	v_cur_no_bgn1 VARCHAR2(10);
	v_cur_no_end VARCHAR2(10);
	v_cur_no_end1 VARCHAR2(10);
	v_cur_floor VARCHAR2(40);
	v_cur_check VARCHAR2(4000);

	--取得5碼的郵遞區號
	v_out_zipcode VARCHAR2(5);

BEGIN


	--整理傳入參數
	--縣市
	IF ( v_city IS NULL OR v_city = '' ) THEN	
	BEGIN
	  raise_application_error( -20002, '縣市不得為空白' );
	  RETURN;
	END;
	END IF;



	--區、路必須擇一存在
	IF ( v_area IS NULL AND v_road IS NULL ) THEN
	BEGIN
	  raise_application_error( -20002, '區或路必須擇一存在' );
	  RETURN;
	END;
	END IF;

	--清除暫存資料表資料
	EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_tempZipCode '; 

	IF ( v_area IS NOT NULL ) THEN	
	BEGIN

 	  INSERT INTO tt_tempZipCode
	    ( SELECT DISTINCT ZIP3A,
	                      CITY,
	                      AREA,
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      '',
	                      ''
	      FROM RALL 
	       WHERE CITY = v_city
	               AND AREA = v_area );           
	END;
	ELSE
	  IF ( v_road IS NOT NULL ) THEN	  
	  BEGIN
	     INSERT INTO tt_tempZipCode
	       ( SELECT DISTINCT ZIP3A,
	                         CITY,
	                         AREA,
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         '',
	                         ''
	         FROM RALL 
	          WHERE CITY = v_city
	                  AND ROAD = v_road );            
	  END;
	  END IF;
	END IF;


	--若沒有路，就回傳三碼郵遞區號(多筆則取第1筆)
	IF ( v_road IS NULL AND v_area IS NOT NULL ) THEN
	BEGIN
	  SELECT ZIPCODE	INTO v_out_zipcode	FROM tt_tempZipCode 
	   WHERE CITY = v_city	AND AREA = v_area AND ROWNUM <= 1;

	  OPEN cv_1 FOR
	  SELECT v_out_zipcode ZIP_CODE, v_area AREA FROM DUAL ;
	  RETURN;
	END;
	END IF;

  --開始CURSOR
  OPEN cur_CMP;

	FETCH cur_CMP INTO v_cur_zipcode,v_cur_city,v_cur_area,v_cur_village,v_cur_road,v_cur_even,v_cur_cmp_lable,v_cur_lane,v_cur_alley,v_cur_no_bgn,v_cur_no_bgn1,v_cur_no_end,v_cur_no_end1,v_cur_floor,v_cur_check;
	WHILE cur_CMP%FOUND 
	LOOP	
			DECLARE
			v_chk_city VARCHAR2(10);
			v_chk_area VARCHAR2(10);
			v_chk_road VARCHAR2(20);
			v_chk_village VARCHAR2(10);
			v_chk_lane VARCHAR2(10);
			v_chk_allay VARCHAR2(10);
			v_chk_no VARCHAR2(10);
			v_chk_no1 VARCHAR2(10);
			v_chk_floor VARCHAR2(40);
			v_chk_zipcode VARCHAR2(5);

   	   BEGIN

			v_chk_city		:= v_city;
			v_chk_area		:= v_cur_area;
			v_chk_road		:= v_road;
			v_chk_village	:= v_village;
			v_chk_lane		:= v_lane;
			v_chk_allay		:= v_allay;
			v_chk_no		:= v_no;
			v_chk_no1		:= v_no_1;
			v_chk_floor		:= v_floor;
			v_chk_zipcode	:= '';

			-- 取得的CMP.Condition若不為空值，則開始判斷v_cur_cmp_lable 的值，執行SQL Command取得5碼郵遞區號
			IF ( v_cur_check IS NOT NULL ) THEN
         	BEGIN      			   
			   -- v_cur_cmp_lable ='0'(全號)
			   IF ( v_cur_cmp_lable = '0' ) THEN 
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	= :v_in_city 
										AND AREA 	= :v_in_area 
										AND ROAD 	= :v_in_road 
										AND CMP_LABLE = ''0''' 
					INTO v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='!'(文字巷內全號)
			   ELSIF ( v_cur_cmp_lable ='!' ) THEN 
			   BEGIN 
			   		EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
			   							WHERE CITY 	= :v_in_city 
			   							AND AREA 	= :v_in_area 
			   							AND ROAD 	= :v_in_road 
			   							AND CMP_LABLE = ''!''' 
			   		INTO v_chk_zipcode 
			   		USING v_chk_city, v_chk_area, v_chk_road;

			   		EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='1'(單號全部), '巷'為空值，以號判斷
			   ELSIF ( v_cur_cmp_lable ='1' AND v_chk_allay IS NULL ) THEN 
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 1
		     							AND   CMP_LABLE = ''1''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
 			   -- v_cur_cmp_lable ='1'(單號全部), '巷'不為空值，以巷判斷
			   ELSIF ( v_cur_cmp_lable ='1' AND v_chk_allay IS NOT NULL ) THEN
			   BEGIN	   
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   MOD( TO_NUMBER( :v_in_allay ), 2 ) = 1
		     							AND   CMP_LABLE = ''1''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='2'(雙號全部), '巷'為空值，以號判斷
			   ELSIF ( v_cur_cmp_lable ='2' AND v_chk_allay IS NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 0
		     							AND   CMP_LABLE = ''2''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='2'(雙號全部), '巷'不為空值，以巷判斷
		 	   ELSIF ( v_cur_cmp_lable ='2' AND v_chk_allay IS NOT NULL ) THEN
		 	   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   MOD( TO_NUMBER( :v_in_allay ), 2 ) = 0
		     							AND   CMP_LABLE = ''2''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='3'(單一門牌號)
			   ELSIF ( v_cur_cmp_lable ='3' ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	= :v_in_city 
										AND AREA 	= :v_in_area 
										AND ROAD 	= :v_in_road
										AND NO_BGN	= :v_chk_no 
										AND CMP_LABLE = ''3''' 
					INTO v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='5'(起迄均門牌號(連號))
			   ELSIF ( v_cur_cmp_lable ='5' ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   CMP_LABLE = ''5''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='6'(起迄均門牌號(單號)), '巷'為空值，以號判斷	
			   ELSIF ( v_cur_cmp_lable ='6' AND v_chk_allay IS NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 1
		     							AND   CMP_LABLE = ''6''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;					
			   -- v_cur_cmp_lable ='6'(起迄均門牌號(單號)), '巷'不為空值，以巷判斷
			   ELSIF ( v_cur_cmp_lable ='6' AND v_chk_allay IS NOT NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   NO_BGN  <= :v_in_allay  
		     							AND   NO_END  >= :v_in_allay  
		     							AND   MOD( TO_NUMBER( :v_in_allay ), 2 ) = 1
		     							AND   CMP_LABLE = ''6''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_allay, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;	
			   -- v_cur_cmp_lable ='7'(起迄均門牌號(雙號)), '巷'為空值，以號判斷
			   ELSIF ( v_cur_cmp_lable ='7' AND v_chk_allay IS NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 0
		     							AND   CMP_LABLE = ''7''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;	
			   -- v_cur_cmp_lable ='7'(起迄均門牌號(雙號)), '巷'不為空值，以巷判斷
			   ELSIF ( v_cur_cmp_lable ='7' AND v_chk_allay IS NOT NULL ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   MOD( TO_NUMBER( :v_in_allay ), 2 ) = 0
		     							AND   CMP_LABLE = ''7''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_allay, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;	   	   
			   -- v_cur_cmp_lable ='O'(起巷號迄門牌號(單號)), '巷'為空值，以號判斷
			   ELSIF ( v_cur_cmp_lable ='O' AND v_chk_allay IS NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   LANE	  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 1
		     							AND   CMP_LABLE = ''O''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;		
			   -- v_cur_cmp_lable ='O'(起巷號迄門牌號(單號)), '巷'不為空值，以巷判斷
			   ELSIF ( v_cur_cmp_lable ='O' AND v_chk_allay IS NOT NULL ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road   
		     							AND   LANE	  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   MOD( TO_NUMBER( :v_in_allay ), 2 ) = 1
		     							AND   CMP_LABLE = ''O''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_allay, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;		  
			   -- v_cur_cmp_lable ='P'(起巷號迄門牌號(雙號)), '巷'為空值，以號判斷
			   ELSIF ( v_cur_cmp_lable ='P' AND v_chk_allay IS NULL ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road  
		     							AND   LANE    <= :v_in_no  
		     							AND   NO_END  >= :v_in_no
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 0  
		     							AND   CMP_LABLE = ''P''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_no, v_chk_no, v_chk_no;	  

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;			   
			   -- v_cur_cmp_lable ='W'('巷內全號')
			   ELSIF ( v_cur_cmp_lable ='W' ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	= :v_in_city 
										AND AREA 	= :v_in_area 
										AND ROAD 	= :v_in_road
										AND LANE	= :v_in_allay 
										AND CMP_LABLE = ''W''' 
					INTO v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;					
			   -- v_cur_cmp_lable ='X'(巷內單號全)
			   ELSIF ( v_cur_cmp_lable ='X' ) THEN
			   BEGIN
					EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	= :v_in_city 
										AND AREA 	= :v_in_area 
										AND ROAD 	= :v_in_road
										AND LANE	= :v_in_allay
										AND MOD( TO_NUMBER( :v_in_no ), 2 ) = 1 
										AND CMP_LABLE = ''X''' 
					INTO v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;		
			   -- v_cur_cmp_lable ='Y'(巷內雙號全)
			   ELSIF ( v_cur_cmp_lable ='Y' ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	= :v_in_city 
										AND AREA 	= :v_in_area 
										AND ROAD 	= :v_in_road
										AND LANE	= :v_in_allay
										AND MOD( TO_NUMBER( :v_in_no ), 2 ) = 0 
										AND CMP_LABLE = ''Y''' 
					INTO v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_no; 

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;		
			   -- v_cur_cmp_lable ='b'(巷內起迄均門牌號(連))
			   ELSIF ( v_cur_cmp_lable ='b' ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road
		     							AND	  LANE	  = :v_in_allay   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no  
		     							AND   CMP_LABLE = ''b''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;		     	   
			   -- v_cur_cmp_lable ='c'(巷內起迄均門牌號(單))	   
			   ELSIF ( v_cur_cmp_lable ='c' ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road
		     							AND	  LANE	  = :v_in_allay   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 1  
		     							AND   CMP_LABLE = ''c''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_no, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   -- v_cur_cmp_lable ='d'(巷內起迄均門牌號(雙))
			   ELSIF ( v_cur_cmp_lable ='d' ) THEN
			   BEGIN
		 			EXECUTE IMMEDIATE 'SELECT ZIPCODE FROM RALL 
										WHERE CITY 	  = :v_in_city   
		     							AND   AREA    = :v_in_area   
		     							AND   ROAD    = :v_in_road
		     							AND	  LANE	  = :v_in_allay   
		     							AND   NO_BGN  <= :v_in_no  
		     							AND   NO_END  >= :v_in_no
		     							AND   MOD( TO_NUMBER( :v_in_no ), 2 ) = 0  
		     							AND   CMP_LABLE = ''d''' 
					INTO  v_chk_zipcode 
					USING v_chk_city, v_chk_area, v_chk_road, v_chk_allay, v_chk_no, v_chk_no, v_chk_no;

					EXCEPTION 
					WHEN NO_DATA_FOUND THEN
					BEGIN
						v_chk_zipcode := '';
					END;
			   END;
			   END IF;

        --如果有找到5碼郵遞區號，就結束CURSOR
				IF ( v_chk_zipcode IS NOT NULL ) THEN            
				BEGIN
					v_out_zipcode := v_chk_zipcode;
					CLOSE cur_CMP;

					OPEN cv_1 FOR
					SELECT v_out_zipcode ZIP_CODE, v_area AREA FROM DUAL ;
					RETURN;
				END;
				END IF;				   

         	END;
         	END IF;  

	   FETCH cur_CMP INTO v_cur_zipcode,v_cur_city,v_cur_area,v_cur_village,v_cur_road,v_cur_even,v_cur_cmp_lable,v_cur_lane,v_cur_alley,v_cur_no_bgn,v_cur_no_bgn1,v_cur_no_end,v_cur_no_end1,v_cur_floor,v_cur_check;   
	   END;
   END LOOP;
   CLOSE cur_CMP;

	--找不到五碼資料時，回傳三碼郵遞區號
	--多筆時，回傳第一筆
  IF ( v_out_zipcode IS NULL ) THEN
  BEGIN
    SELECT ZIPCODE	INTO v_out_zipcode	FROM tt_tempZipCode 
     WHERE CITY = v_city	AND AREA = v_area AND ROWNUM <= 1;

    OPEN cv_1 FOR
    SELECT v_out_zipcode ZIP_CODE, v_area AREA FROM DUAL ;
    RETURN;		
  END;
  END IF;  

END;

/

  GRANT EXECUTE ON "ECS"."S_GETZIPCODE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_GETZIPCODE1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_GETZIPCODE1" 
(
  v_striCT_NM IN NVARCHAR2 DEFAULT NULL ,
  v_striSEC_NM IN NVARCHAR2 DEFAULT NULL ,
  v_striROAD IN NVARCHAR2 DEFAULT NULL ,
  v_numiLANE IN NUMBER DEFAULT NULL ,
  v_numiALLEY IN NUMBER DEFAULT NULL ,
  v_striNO IN NVARCHAR2 DEFAULT NULL ,
  cv_1 IN OUT SYS_REFCURSOR,
  cv_2 IN OUT SYS_REFCURSOR,
  cv_3 IN OUT SYS_REFCURSOR,
  cv_4 IN OUT SYS_REFCURSOR,
  cv_5 IN OUT SYS_REFCURSOR,
  cv_6 IN OUT SYS_REFCURSOR
)
AS
   --SET NOCOUNT ON
   v_intMOD--餘數
    NUMBER(10,0);
   v_strATTR--號碼為奇數或偶數
    CHAR(1);
   v_zip3A NUMBER(10,0);
   v_temp NUMBER(1, 0) := 0;
--	@intCount 	int	OUTPUT

--,
BEGIN

   --整理傳入參數
   --縣市
   IF ( v_striCT_NM IS NULL
     OR v_striCT_NM IS NULL ) THEN

   BEGIN
      raise_application_error( -20002, '縣市不得為空白' );
      RETURN;
   END;
   END IF;
   --區
   IF ( v_striSEC_NM IS NULL
     OR v_striSEC_NM IS NULL ) THEN

   BEGIN
      raise_application_error( -20002, '鄉鎮不得為空白' );
      RETURN;
   END;
   END IF;
   --刪除暫存 Table
   IF NULL/*TODO:OBJECT_ID('tempdb..#tempZipCode')*/ IS NOT NULL THEN
      EXECUTE IMMEDIATE ' TRUNCATE TABLE tt_tempZipCode_2 ';
   END IF;
   --產生暫存 Table
   DELETE FROM tt_tempZipCode_2;

   INSERT INTO tt_tempZipCode_2 ( 
      SELECT ZIP_CODE,
             CT_NM,
             SEC_NM,
             ROAD,
             LANE,
             ALLEY,
             NO_BGN,
             NO_END,
             ATTR
        FROM ZipCode 
       WHERE 1 = 2 );
   --先取得三碼郵遞區號3碼
   INSERT INTO tt_tempZipCode_2
     ( SELECT ZIP_CODE,
              CT_NM,
              SEC_NM,
              ROAD,
              LANE,
              ALLEY,
              NO_BGN,
              NO_END,
              ATTR
       FROM ZipCode 
        WHERE CT_NM = v_striCT_NM
                AND SEC_NM = v_striSEC_NM
                AND ROAD IS NULL
                AND LENGTH(ZIP_CODE) = 3 );
   --若沒有路，就回傳三碼郵遞區號
   IF ( v_striROAD IS NULL
     OR v_striROAD IS NULL ) THEN

   BEGIN
      OPEN cv_1 FOR
         SELECT ZIP_CODE,
                CT_NM,
                SEC_NM,
                ROAD,
                LANE,
                ALLEY,
                NO_BGN,
                NO_END,
                ATTR
           FROM tt_tempZipCode_2 ;
      RETURN;
   END;
   END IF;
   --進行五碼的拆解
   INSERT INTO tt_tempZipCode_2
     ( SELECT ZIP_CODE,
              CT_NM,
              SEC_NM,
              ROAD,
              LANE,
              ALLEY,
              NO_BGN,
              NO_END,
              ATTR
       FROM ZipCode 
        WHERE CT_NM = v_striCT_NM
                AND SEC_NM = v_striSEC_NM
                AND ROAD = v_striROAD );
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE NOT EXISTS ( SELECT ZIP_CODE,
                                 CT_NM,
                                 SEC_NM,
                                 ROAD,
                                 LANE,
                                 ALLEY,
                                 NO_BGN,
                                 NO_END,
                                 ATTR
                          FROM ZipCode 
                           WHERE CT_NM = v_striCT_NM
                                   AND SEC_NM = v_striSEC_NM
                                   AND ROAD = v_striROAD );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN

   BEGIN
      --找不到五碼的資料，直接回傳3碼郵遞區號
      OPEN cv_2 FOR
         SELECT ZIP_CODE,
                CT_NM,
                SEC_NM,
                ROAD,
                LANE,
                ALLEY,
                NO_BGN,
                NO_END,
                ATTR
           FROM tt_tempZipCode_2 
          WHERE LENGTH(ZIP_CODE) = 3;
      RETURN;
   END;
   END IF;
   --若存在「全」的資料，則不用再進行其它判斷
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE EXISTS ( SELECT ZIP_CODE,
                             CT_NM,
                             SEC_NM,
                             ROAD,
                             LANE,
                             ALLEY,
                             NO_BGN,
                             NO_END,
                             ATTR
                      FROM tt_tempZipCode_2 
                       WHERE ATTR = '0' );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN

   BEGIN
      --RAISERROR('若存在「全」的資料，則不用再進行其它判斷',16,1)
      --若存在「全」的資料，則不用再進行其它判斷
      OPEN cv_3 FOR
         SELECT ZIP_CODE,
                CT_NM,
                SEC_NM,
                ROAD,
                LANE,
                ALLEY,
                NO_BGN,
                NO_END,
                ATTR
           FROM tt_tempZipCode_2 
          WHERE ATTR = '0' AND ROWNUM <= 1;
      RETURN;
   END;
   END IF;
   --進行單、雙號的判斷
   IF ( v_striNO IS NULL
     OR v_striNO = 0 ) THEN

   BEGIN
      --傳入：縣市、鄉鎮及路街的資料
      --資料庫中沒有全的資料
      --沒有傳入：號
      --故回傳：有5碼先傳5碼，最後3碼郵遞區號
      OPEN cv_4 FOR
         SELECT * 
           FROM ( SELECT ZIP_CODE,
                         CT_NM,
                         SEC_NM,
                         ROAD,
                         LANE,
                         ALLEY,
                         NO_BGN,
                         NO_END,
                         ATTR
           FROM tt_tempZipCode_2 
           ORDER BY 
                    --		WHERE LEN(ZIP_CODE) = 3
                    ZIP_CODE DESC )
           WHERE ROWNUM <= 1;
      RETURN;
   END;
   END IF;
   v_intMOD := MOD(v_striNO, 2) ;
   IF v_intMOD <> 0 THEN
      --奇數
      v_strATTR := '1' ;
   ELSE
      --偶數
      v_strATTR := '2' ;
   END IF;
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE EXISTS ( SELECT ZIP_CODE,
                             CT_NM,
                             SEC_NM,
                             ROAD,
                             LANE,
                             ALLEY,
                             NO_BGN,
                             NO_END,
                             ATTR
                      FROM tt_tempZipCode_2 
                       WHERE ATTR = v_strATTR );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN

   BEGIN
      --有單、雙的資料
      --目前沒有加上號的判斷，故一律只取第一筆顯示
      OPEN cv_5 FOR
         SELECT ZIP_CODE,
                CT_NM,
                SEC_NM,
                ROAD,
                LANE,
                ALLEY,
                NO_BGN,
                NO_END,
                ATTR
           FROM tt_tempZipCode_2 
          WHERE ATTR = v_strATTR AND ROWNUM <= 1;
      RETURN;
   END;
   END IF;
   --其餘沒有判斷的條件，一律回傳3碼郵遞區號
   OPEN cv_6 FOR
      SELECT ZIP_CODE,
             CT_NM,
             SEC_NM,
             ROAD,
             LANE,
             ALLEY,
             NO_BGN,
             NO_END,
             ATTR
        FROM tt_tempZipCode_2 
       WHERE LENGTH(ZIP_CODE) = 3;--INSERT INTO #tempZipCode
   --	SELECT 																				
   --		ZIP_CODE,                                     
   --		CT_NM,                                        
   --		SEC_NM,                                       
   --		ROAD,                                         
   --		LANE,                                         
   --		ALLEY,                                        
   --		NO_BGN,                                       
   --		NO_END,                                       
   --		ATTR                                          
   --	FROM ZipCode                                    
   --	WHERE CT_NM = @striCT_NM                       
   --	AND (SEC_NM = @striSEC_NM OR @striSEC_NM IS NULL)	
   --	AND (ROAD = @striROAD OR @striROAD = '')
   --	AND (LANE = @numiLANE OR @numiLANE IS NULL)
   --	AND (ALLEY = @numiALLEY OR @numiALLEY IS NULL)
   --	--	 AND ATTR = @strATTR                            
   --	AND ((NO_BGN <= @striNO AND NO_END >= @striNO ) 
   --		OR (NO_BGN >= @striNO AND NO_END = 0 ) 
   --		OR (NO_BGN = 0 AND NO_END = 0)
   --		OR @striNO IS NULL)
   --DECLARE @intCount int
   --SET @intCount = 0
   ----依單/雙號取郵遞區號
   --SELECT 
   --	@intCount = COUNT(*)
   --FROM #tempZipCode
   --WHERE ATTR = @strATTR -- 0 / 1 / 2
   ----若依單/雙號取不到郵遞區號，則忽略這個條件
   --IF (@intCount = 0 OR @intCount>1)
   --	BEGIN
   ----		SET @strATTR = '0'
   --		SELECT 	
   --			TOP 1  																			
   --			ZIP_CODE,                                     
   --			CT_NM,                                        
   --			SEC_NM,                                       
   --			ROAD,                                         
   --			LANE,                                         
   --			ALLEY,                                        
   --			NO_BGN,                                       
   --			NO_END,                                       
   --			ATTR                                          
   --		FROM ZipCode                                    
   --		WHERE CT_NM = @striCT_NM                       
   --		AND  SEC_NM = @striSEC_NM 
   --		AND  ROAD = '' 
   --	END
   --   ELSE
   --	BEGIN
   --   		SELECT 		
   --			TOP 1																		
   --			ZIP_CODE,                                     
   --			CT_NM,                                        
   --			SEC_NM,                                       
   --			ROAD,                                         
   --			LANE,                                         
   --			ALLEY,                                        
   --			NO_BGN,                                       
   --			NO_END,                                       
   --			ATTR 
   --		FROM #tempZipCode
   --		WHERE ATTR = @strATTR
   --		ORDER BY LANE, ALLEY, NO_BGN, NO_END
   --	END
END;

/

  GRANT EXECUTE ON "ECS"."S_GETZIPCODE1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_INSERTSWMAILMESSAGE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_INSERTSWMAILMESSAGE" (v_SendDateTime  IN DATE DEFAULT sysdate,
                                                  v_To_Name IN VARCHAR2 DEFAULT '',
                                                  v_To_Addr IN VARCHAR2 DEFAULT '',
                                                  v_MailClassID IN VARCHAR2 DEFAULT '',
                                                  v_AttachName IN VARCHAR2 DEFAULT '',
                                                  v_Attach IN LONG RAW DEFAULT '',
                                                  v_MailBody IN LONG DEFAULT '', 
                                                  v_OriginSendNo IN NUMBER DEFAULT NULL, 
                                                  v_IsAtt     IN NUMBER DEFAULT NULL
                                                  ) AS
  v_intIsAtt           NUMBER(1);
  v_SendNo             NUMBER(12);
  v_CC 				   NVARCHAR2(1500) DEFAULT '';

BEGIN
  v_intIsAtt := 0;

  IF (v_Attach IS NOT NULL AND v_AttachName <> '') THEN
      v_intIsAtt := 1;
  END IF;
  SELECT CC_Addr INTO v_CC FROM SWMailMessage WHERE SendNo = v_OriginSendNo;
  INSERT INTO SWMAILMESSAGE
           (SENDDATETIME
           ,TO_NAME
           ,TO_ADDR
           ,MAILCLASSID
           ,MAILBODY
           ,ISATT
           ,CC_ADDR
           )
           VALUES
           (v_SendDateTime,
            v_To_Name   ,
            v_To_Addr    ,
            v_MailClassID,
            v_MailBody,
            v_IsAtt, 
            v_cc 
            )
            returning SENDNO into v_SendNo;

  IF (v_intIsAtt = 1) THEN
      INSERT INTO SWATTACHMENT
           (SENDNO
           ,FILENMAE
           ,FILEOBJECT)
       VALUES
          (v_SendNo,
           v_AttachName,
           v_Attach );
  END IF;
END;

/

  GRANT EXECUTE ON "ECS"."S_INSERTSWMAILMESSAGE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_MEMBER_CHECKFORGETACCKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_MEMBER_CHECKFORGETACCKEY" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/12/20
-- Description: 會員驗證密碼有效性
-- =============================================
(
    WSOCIAL_TYPE            VARCHAR2,               -- 社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
    WSOCIAL_ID              VARCHAR2,               -- 社群登入帳號
    WBIRTH_DATE             DATE,                   -- 生日
    WSEND_FORGET_DATE       DATE,                   -- 寄發忘記密碼日期時間
    OUTDT                   OUT SYS_REFCURSOR       -- MASTER
) IS

    XCOUNT                  INTEGER;                -- 檢查資料是否存在

BEGIN

    SELECT COUNT(*)
      INTO XCOUNT
      FROM ECS.POTENTIAL
     WHERE SOCIAL_TYPE = WSOCIAL_TYPE
       AND SOCIAL_ID = WSOCIAL_ID;

    OPEN OUTDT FOR
    SELECT  CASE WHEN XCOUNT <> 1 THEN 'N' ELSE 'Y' END AS IS_SUCCESS           -- 取得資料成功否
           ,CASE WHEN XCOUNT <> 1 THEN '3' ELSE '' END AS WARNS_TYPE            -- 警示方式
           ,CASE WHEN XCOUNT <> 1 THEN '查無此受益人' ELSE '' END AS ERROR_MSG    -- 錯誤訊息
      FROM DUAL;

END;

/

  GRANT EXECUTE ON "ECS"."S_MEMBER_CHECKFORGETACCKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_MEMBER_LOGIN
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_MEMBER_LOGIN" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/11/20
-- Description: 會員登入
-- =============================================
(
     WSOCIAL_TYPE       VARCHAR2            --社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
    ,WSOCIAL_ID         VARCHAR2            --社群登入帳號
    ,WIS_SAME_KAY       VARCHAR2            --密碼相同否(Y/N)
    ,WIP_ADR            VARCHAR2            --IP位址
    ,OUTDT              OUT SYS_REFCURSOR   --回傳的 TABLEDATA
) IS
    --變數
    XPOTENTIAL_ID       NUMBER(10);         --潛在客戶代碼
    XDATA_COUNT         INTEGER;            --是否有資料
    XSYS_DTTM           DATE := SYSDATE;    --系統時間(含時分秒)
    XIP_A               VARCHAR2(3);        --第一段IP
    XIP_B               VARCHAR2(3);        --第二段IP
    XIP_C               VARCHAR2(3);        --第三段IP
    XIP_D               VARCHAR2(3);        --第四段IP
BEGIN

    IF WSOCIAL_TYPE = 4 THEN
    BEGIN

        --IP分成四段
        XIP_A := SUBSTR(WIP_ADR, 1, INSTR(WIP_ADR, '.', 1, 1) - 1);
        XIP_B := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 1) + 1, INSTR(WIP_ADR, '.', 1, 2) - INSTR(WIP_ADR, '.', 1, 1) - 1);
        XIP_C := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 2) + 1, INSTR(WIP_ADR, '.', 1, 3) - INSTR(WIP_ADR, '.', 1, 2) - 1);
        XIP_D := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 3) + 1, 4);

        --取得潛在客戶代碼
        SELECT POTENTIAL.POTENTIAL_ID       --潛在客戶代碼
          INTO XPOTENTIAL_ID
          FROM ECS.POTENTIAL POTENTIAL      --潛在客戶檔
         WHERE POTENTIAL.SOCIAL_TYPE = WSOCIAL_TYPE
           AND POTENTIAL.SOCIAL_ID = WSOCIAL_ID;

        --檢查潛在客戶是否登入過(有登入過才有資料)
        SELECT COUNT(*)
          INTO XDATA_COUNT
          FROM ECS.POTENTIAL_LOGIN          --潛在客戶登入資料
         WHERE POTENTIAL_ID = XPOTENTIAL_ID;

        IF XDATA_COUNT = 0 THEN
        BEGIN
            --寫入潛在客戶登入資料
            INSERT INTO ECS.POTENTIAL_LOGIN
            (
                    POTENTIAL_ID                --潛在客戶代碼
                   ,LOGIN_FAILED                --登入失敗次數
                   ,LAST_LOGIN                  --最後登錄時間
                   ,IP_A                        --IP A
                   ,IP_B                        --IP B
                   ,IP_C                        --IP C
                   ,IP_D                        --IP D
            )
            SELECT  POTENTIAL.POTENTIAL_ID      --潛在客戶代碼
                   ,CASE WHEN WIS_SAME_KAY = 'Y' THEN 0 
                         ELSE 1
                         END AS LOGIN_FAILED    --登入失敗次數
                   ,XSYS_DTTM AS LAST_LOGIN     --最後登錄時間
                   ,XIP_A                       --IP A
                   ,XIP_B                       --IP B
                   ,XIP_C                       --IP C
                   ,XIP_D                       --IP D
              FROM ECS.POTENTIAL POTENTIAL      --潛在客戶檔
             WHERE POTENTIAL.POTENTIAL_ID = XPOTENTIAL_ID;
        END;
        ELSE
        BEGIN
            --更新潛在客戶登入資料
            UPDATE ECS.POTENTIAL_LOGIN
               SET  LOGIN_FAILED = CASE WHEN WIS_SAME_KAY = 'Y' THEN 0 
                                        ELSE LOGIN_FAILED + 1 
                                        END     --登入失敗次數
                   ,LAST_LOGIN = XSYS_DTTM      --最後登錄時間
                   ,IP_A = XIP_A                --IP A
                   ,IP_B = XIP_B                --IP B
                   ,IP_C = XIP_C                --IP C
                   ,IP_D = XIP_D                --IP D
             WHERE POTENTIAL_ID = XPOTENTIAL_ID;
        END;
        END IF;

        --寫入潛在客戶登入紀錄
        INSERT INTO ECS.POTENTIAL_LOGIN_LOG
        (
                POTENTIAL_ID                --潛在客戶代碼
               ,STATUS                      --登入狀態(S:成功/F:失敗)
               ,LOG_TIME                    --登入時間
               ,IP_A                        --IP A
               ,IP_B                        --IP B
               ,IP_C                        --IP C
               ,IP_D                        --IP D
        )
        SELECT  XPOTENTIAL_ID               --潛在客戶代碼
               ,CASE WHEN WIS_SAME_KAY = 'Y' THEN 'S' 
                     ELSE 'F' 
                     END AS WSTATUS         --登入狀態(S:成功/F:失敗)
               ,XSYS_DTTM AS LOG_TIME       --登入時間
               ,XIP_A                       --IP A
               ,XIP_B                       --IP B
               ,XIP_C                       --IP C
               ,XIP_D                       --IP D
          FROM DUAL;

    END;
    END IF;

    --資料輸出
    OPEN OUTDT FOR
    SELECT POTENTIAL.POTENTIAL_ID       --潛在客戶代碼
      FROM ECS.POTENTIAL POTENTIAL      --潛在客戶檔
     WHERE POTENTIAL.SOCIAL_TYPE = WSOCIAL_TYPE
       AND POTENTIAL.SOCIAL_ID = WSOCIAL_ID;

END;

/

  GRANT EXECUTE ON "ECS"."S_MEMBER_LOGIN" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_MEMBER_SENDFORGETACCKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_MEMBER_SENDFORGETACCKEY" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/12/20
-- Description: 會員寄發忘記密碼信件
-- =============================================
(
    WSOCIAL_TYPE            VARCHAR2,               -- 社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
    WSOCIAL_ID              VARCHAR2,               -- 社群登入帳號
    WBIRTH_DATE             DATE,                   -- 生日
    OUTDT                   OUT SYS_REFCURSOR       -- MASTER
) IS

    XCOUNT	                INTEGER;                -- 檢查資料是否存在
    XIS_SUCCESS             VARCHAR2(1);            -- 取得資料成功否
    XWARNS_TYPE             VARCHAR2(1);            -- 警示方式
    XERROR_MSG              VARCHAR2(250);          -- 錯誤訊息

BEGIN

    SELECT COUNT(*)
      INTO XCOUNT
      FROM ECS.POTENTIAL
     WHERE SOCIAL_TYPE = WSOCIAL_TYPE
       AND SOCIAL_ID = WSOCIAL_ID
       AND BIRTH_DATE = WBIRTH_DATE;

    IF XCOUNT > 0 THEN

        XIS_SUCCESS := 'Y';
        XWARNS_TYPE := '';
        XERROR_MSG  := '';

    ELSE

        XIS_SUCCESS := 'N';

        SELECT  MSGTYPE
               ,MSGCONTENT
          INTO  XWARNS_TYPE
               ,XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'KEY001';

    END IF;

    OPEN OUTDT FOR
    SELECT  XIS_SUCCESS AS IS_SUCCESS            -- 是否成功
           ,XWARNS_TYPE AS WARNS_TYPE            -- 警示方式
           ,XERROR_MSG  AS ERROR_MSG             -- 錯誤訊息
      FROM DUAL;

END;

/

  GRANT EXECUTE ON "ECS"."S_MEMBER_SENDFORGETACCKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_RESEAL_PROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_RESEAL_PROCESS" 
-- =============================================
-- Author       : PhotoRGB
-- Create date  : 2009/08/20
-- Description  : 核印重送
-- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
-- 2019.09.06 tingting 調整為ORACLE版本
-- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增UPDATE欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號)
-- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- =============================================
(
    WSEAL_TYPE          VARCHAR2,       --核印方式 1：一般；2：ACH；3：財金
    WSOURCE_CD          VARCHAR2,       --資料來源 1：定期定額契約；2：定期定額契約變更；3：授權約定書；4：授權約定書變更 (CTL014：236)
    WSUB_BANK_CODE      VARCHAR2,       --扣款行
    WSUB_ACC_NO         VARCHAR2,       --扣款帳號
    WSUB_ID_NO          VARCHAR2,       --扣款人ID
    WVOUCH_NO           VARCHAR2,       --申請書號
    WVOUCH_SRNO         INT,            --申請書序號
    WRELATIVE_NO        VARCHAR2,       --相關書號
    WRELATIVE_SRNO      INT,            --申請書序號
    WBATCH_ID           VARCHAR2,       --送核批號
    WTRADE_NO           VARCHAR2,       --交易序號
    WSEAL_USER_NO       VARCHAR2,       --用戶號碼
    WACC_SUB_ID         VARCHAR2,       --帳號用途碼
    WSEAL_STATUS        VARCHAR2,       --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
    WSEAL_FAIL_ID_CO    VARCHAR2,       --核印失敗原因碼(公司)
    WSEAL_FAIL_ID_BK    VARCHAR2,       --核印失敗原因碼(銀行)
    WSEAL_DATE          DATE,           --送核日期
    WSEAL_RTN_DATE      Date,           --回覆日期
    WUpdateID           VARCHAR2,       --更新人員
    WUpdateDate         DATE            --更新日期時間
)
IS
    --XRELATIVE_NO        varchar(1);
    XRELATIVE_NO        VARCHAR2(20);
    XNullDate           DATE;
    -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
    XRSP_SEAL_TYPE      VARCHAR2(6);
BEGIN

    XNullDate := TO_DATE('19000101','YYYYMMDD');
    XRELATIVE_NO := CASE WHEN WRELATIVE_NO IS NULL THEN 'ALL' ELSE WRELATIVE_NO END;
    --SELECT TOP 1 XRSP_SEAL_TYPE = RSP_SEAL_TYPE FROM CTL015;

    --一般
    IF (WSEAL_TYPE = '1') THEN
    BEGIN
        --更新核印檔
        UPDATE ECS.OFD701
           SET SEAL_STATUS = '0',
               UpdateID = WUpdateID,
               UpdateDate = WUpdateDate
         WHERE SEAL_TYPE = '1'
           AND ACC_SUB_ID = WACC_SUB_ID
           AND SUB_BANK_CODE = WSUB_BANK_CODE
           AND SUB_ACC_NO = WSUB_ACC_NO
           AND SUB_ID_NO = WSUB_ID_NO
           -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
           -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
           AND RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN WVOUCH_NO ELSE XRELATIVE_NO END) END)
           AND RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN WVOUCH_SRNO ELSE WRELATIVE_SRNO END) END)
           AND RSP_CHG_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN 'ALL' ELSE WVOUCH_NO END) END)
           AND RSP_CHG_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE (CASE WHEN WSOURCE_CD IN ('3','4') THEN 0 ELSE WVOUCH_SRNO END) END);

        /*
        --契約異動
        IF (WSOURCE_CD = '2') THEN
        BEGIN
            --SET XRELATIVE_NO = 'N';

            UPDATE RSP013
               SET RSP013.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   RSP013.SEAL_DATE = '1900/1/1',
                   RSP013.SEAL_RTN_DATE = '1900/1/1',
                   RSP013.SEAL_FAIL_ID_CO = '',
                   RSP013.SEAL_FAIL_ID_BK = '',
                   RSP013.BATCH_ID = '',
                   RSP013.TRADE_NO = '',
                   RSP013.SEAL_USER_NO = OFD701.SEAL_USER_NO
              FROM RSP013
              JOIN OFD020V
                ON OFD020V.BANK_BRH = [dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)
              JOIN OFD701
                ON [dbo].[f_Nvl](RSP013.AFT_SEAL_TYPE ,RSP013.BEF_SEAL_TYPE) = OFD701.SEAL_TYPE
               AND OFD701.ACC_SUB_ID = 'ALL'
               AND [dbo].[f_Nvl](RSP013.AFT_SUB_ID_NO,RSP013.BEF_SUB_ID_NO)= OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' or OFD020V.BANK_TYPE = '05') THEN [dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)
                        ELSE dbo.f_GetBankHQ(CONVERT(VARCHAR,[dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)))
                        END = OFD701.SUB_BANK_CODE
               AND [dbo].[f_Nvl](RSP013.AFT_SUB_ACCOUNT_NO,RSP013.BEF_SUB_ACCOUNT_NO) = OFD701.SUB_ACC_NO
               AND OFD701.BATCH_ID = WBATCH_ID
             -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
             WHERE (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP013.RSP_NO END)= OFD701.RSP_NO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP013.RSP_SRNO END) = OFD701.RSP_SRNO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP013.RSP_CHG_NO END) = OFD701.RSP_CHG_NO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP013.RSP_CHG_SRNO END) = OFD701.RSP_CHG_SRNO
               AND RSP013.RSP_NO = XRELATIVE_NO
               AND RSP013.RSP_SRNO = WRELATIVE_SRNO
               AND RSP013.RSP_CHG_NO = WVOUCH_NO
               AND RSP013.RSP_CHG_SRNO = WVOUCH_SRNO;
               --AND RSP013.CHG_UPD_DTTM = '1900/1/1';

            --IF (@@ROWCOUNT <> 0)
            --BEGIN
            --    SET XRELATIVE_NO = 'Y';
            --END;
        END;
        END IF;
        */

        /*
        --契約書或異動轉入
        IF (WSOURCE_CD = '1' OR WSOURCE_CD = '2') THEN
        BEGIN
            UPDATE RSP006
               SET RSP006.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   RSP006.SEAL_DATE = '1900/1/1',
                   RSP006.SEAL_RTN_DATE = '1900/1/1',
                   RSP006.SEAL_FAIL_ID_CO = '',
                   RSP006.SEAL_FAIL_ID_BK = '',
                   RSP006.BATCH_ID = '',
                   RSP006.TRADE_NO = '',
                   RSP006.SEAL_USER_NO = OFD701.SEAL_USER_NO
                   --RSP006.DFT_BNG_SUB_DATE = CASE WHEN FIRST_SUS_DATE = '1900/1/1' THEN '1900/1/1' ELSE DFT_BNG_SUB_DATE END
              FROM RSP006
              JOIN OFD020V
                ON OFD020V.BANK_BRH = RSP006.SUB_BANK_CODE
              JOIN OFD701
                ON RSP006.SEAL_TYPE = OFD701.SEAL_TYPE
               AND OFD701.ACC_SUB_ID = 'ALL'
               AND RSP006.SUB_ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN RSP006.SUB_BANK_CODE
                        ELSE dbo.f_GetBankHQ(RSP006.SUB_BANK_CODE)
                        END = OFD701.SUB_BANK_CODE
               AND RSP006.SUB_ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.BATCH_ID = WBATCH_ID
             -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
             WHERE (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP006.RSP_NO END) = OFD701.RSP_NO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP006.RSP_SRNO END) = OFD701.RSP_SRNO
               AND RSP006.RSP_NO = CASE WSOURCE_CD WHEN '1' THEN WVOUCH_NO ELSE XRELATIVE_NO END
               AND RSP006.RSP_SRNO = CASE WSOURCE_CD WHEN '1' THEN WVOUCH_SRNO ELSE WRELATIVE_SRNO END;
        END;
        END IF;
        */

        /*
        --授權書異動
        IF (WSOURCE_CD = '4') THEN
        BEGIN
            --SET XRELATIVE_NO = 'N';

            UPDATE BMS005CHG
               SET BMS005CHG.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   BMS005CHG.SEAL_DATE = '1900/1/1',
                   BMS005CHG.SEAL_RTN_DATE = '1900/1/1',
                   BMS005CHG.SEAL_FAIL_ID_CO = '',
                   BMS005CHG.SEAL_FAIL_ID_BK = '',
                   BMS005CHG.BATCH_ID = '',
                   BMS005CHG.TRADE_NO = ''
              FROM BMS005CHG
              JOIN BMS001CHG
                ON BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
              JOIN OFD020V
                ON OFD020V.BANK_BRH = BMS005CHG.AFT_BANK_BRH
              JOIN OFD701
                ON BMS005CHG.AFT_SEAL_TYPE = OFD701.SEAL_TYPE
               AND BMS001CHG.AFT_ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN BMS005CHG.AFT_BANK_BRH
                        ELSE dbo.f_GetBankHQ(BMS005CHG.AFT_BANK_BRH) END = OFD701.SUB_BANK_CODE
               AND BMS005CHG.AFT_ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.ACC_SUB_ID = CASE BMS005CHG.AFT_SEAL_TYPE WHEN '1' THEN BMS005CHG.AFT_ACC_SUB_ID ELSE 'ALL' END
               AND OFD701.BATCH_ID = WBATCH_ID
             -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
             WHERE (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE BMS005CHG.BF_CHG_NO END) = OFD701.RSP_CHG_NO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE BMS005CHG.DATA_SEQ END) = OFD701.RSP_CHG_SRNO
               AND BMS005CHG.AFT_REMIT_CFM_NO = XRELATIVE_NO
               AND BMS005CHG.AFT_DATA_SEQ = WRELATIVE_SRNO
               AND BMS005CHG.BF_CHG_NO = WVOUCH_NO
               AND BMS005CHG.DATA_SEQ = WVOUCH_SRNO;
               --AND BMS001CHG.CHG_UPD_DTTM = '1900/1/1';

            --IF (@@ROWCOUNT <> 0)
            --BEGIN
            --    SET XRELATIVE_NO = 'Y';
            --END;
        END;
        END IF;
        */

        /*
        --授權書或異動轉入
        IF (WSOURCE_CD = '3' OR WSOURCE_CD = '4') THEN
        BEGIN
            UPDATE BMS005
               SET BMS005.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   BMS005.SEAL_DATE = '1900/1/1',
                   BMS005.SEAL_RTN_DATE = '1900/1/1',
                   BMS005.SEAL_FAIL_ID_CO = '',
                   BMS005.SEAL_FAIL_ID_BK = '',
                   BMS005.BATCH_ID = '',
                   BMS005.TRADE_NO = ''
              FROM BMS005
              JOIN BMS001
                ON BMS005.BF_NO=BMS001.BF_NO
              JOIN OFD020V
                ON OFD020V.BANK_BRH = BMS005.BANK_BRH
              JOIN OFD701
                ON BMS005.SEAL_TYPE=OFD701.SEAL_TYPE
               AND BMS001.ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE='04' OR OFD020V.BANK_TYPE = '05') THEN BMS005.BANK_BRH
                        ELSE dbo.f_GetBankHQ(BMS005.BANK_BRH)
                   END = OFD701.SUB_BANK_CODE
               AND BMS005.ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.ACC_SUB_ID = CASE BMS005.SEAL_TYPE WHEN '1' THEN BMS005.ACC_SUB_ID ELSE 'ALL' END
               AND OFD701.BATCH_ID = WBATCH_ID
             -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
             WHERE (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE BMS005.REMIT_CFM_NO END) = OFD701.RSP_NO
               AND (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE BMS005.DATA_SEQ END) = OFD701.RSP_SRNO
               AND BMS005.REMIT_CFM_NO = CASE WSOURCE_CD WHEN '3' THEN WVOUCH_NO ELSE XRELATIVE_NO END
               AND BMS005.DATA_SEQ = CASE WSOURCE_CD WHEN '3' THEN WVOUCH_SRNO ELSE WRELATIVE_SRNO END;
       END;
       END IF;
       */
    END;
    ELSE
    --ACH/FIS
    BEGIN
        --重送時將筆數加一
        --若為失敗則更新核印狀態為未送
        UPDATE ECS.OFD701
           SET DATA_COUNT = DATA_COUNT + 1,
               SEAL_STATUS = CASE SEAL_STATUS WHEN '3' THEN '0' ELSE SEAL_STATUS END,
               UpdateID = WUpdateID,
               UpdateDate = WUpdateDate
         WHERE ACC_SUB_ID = 'ALL'
           AND SUB_BANK_CODE = WSUB_BANK_CODE
           AND SUB_ACC_NO = WSUB_ACC_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE;

        /*
        --契約書
        IF (WSOURCE_CD = '1') THEN
        BEGIN
            UPDATE RSP006
               SET RSP006.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   RSP006.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.SEAL_DATE END,
                   RSP006.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.RETURN_DATE END,
                   RSP006.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                   RSP006.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                   RSP006.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                   RSP006.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END,
                   RSP006.SEAL_USER_NO = OFD701.SEAL_USER_NO,
                   RSP006.DFT_BNG_SUB_DATE = CASE WHEN OFD701.SEAL_STATUS = '2' AND DFT_BNG_SUB_DATE = '1900/1/1'
                                                  THEN dbo.f_GetBusinessDay(OFD701.RETURN_DATE,'1',(SELECT SEAL_DAY FROM CTL015))
                                                  ELSE DFT_BNG_SUB_DATE
                                                  END
              FROM RSP006
              JOIN OFD020V
                ON OFD020V.BANK_BRH = RSP006.SUB_BANK_CODE
              JOIN OFD701
                ON RSP006.SEAL_TYPE = OFD701.SEAL_TYPE
               -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
               AND OFD701.ACC_SUB_ID = (CASE WHEN RSP006.SEAL_TYPE = '1' AND XRSP_SEAL_TYPE = 'C' THEN '0' ELSE 'ALL' END)
               AND RSP006.SUB_ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN RSP006.SUB_BANK_CODE
                        ELSE dbo.f_GetBankHQ(RSP006.SUB_BANK_CODE) END = OFD701.SUB_BANK_CODE
               AND RSP006.SUB_ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.RSP_NO = 'ALL' AND OFD701.RSP_SRNO = 0
               AND OFD701.RSP_CHG_NO = 'ALL' AND OFD701.RSP_CHG_SRNO = 0
               AND OFD701.ACC_SUB_ID = 'ALL'
             WHERE RSP006.RSP_NO = WVOUCH_NO
               AND RSP006.RSP_SRNO = WVOUCH_SRNO;
        END;
        ELSE
        --契約書異動
        IF (WSOURCE_CD = '2')
        BEGIN
            UPDATE RSP013
               SET RSP013.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   RSP013.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.SEAL_DATE END,
                   RSP013.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.RETURN_DATE END,
                   RSP013.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                   RSP013.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                   RSP013.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                   RSP013.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END,
                   RSP013.SEAL_USER_NO = OFD701.SEAL_USER_NO
              FROM RSP013
              JOIN OFD020V
                ON OFD020V.BANK_BRH = [dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)
              JOIN OFD701
                ON [dbo].[f_Nvl](RSP013.AFT_SEAL_TYPE ,RSP013.BEF_SEAL_TYPE) = OFD701.SEAL_TYPE
               -- 2015.09.15 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
               AND OFD701.ACC_SUB_ID = ( CASE WHEN [dbo].[f_Nvl](RSP013.AFT_SEAL_TYPE ,RSP013.BEF_SEAL_TYPE) = '1' AND XRSP_SEAL_TYPE = 'C' THEN '0' ELSE 'ALL' END)
               AND [dbo].[f_Nvl](RSP013.AFT_SUB_ID_NO,RSP013.BEF_SUB_ID_NO) = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN [dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)
                        ELSE dbo.f_GetBankHQ(CONVERT(VARCHAR,[dbo].[f_Nvl](RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE)))
                        END = OFD701.SUB_BANK_CODE
               AND [dbo].[f_Nvl](RSP013.AFT_SUB_ACCOUNT_NO,RSP013.BEF_SUB_ACCOUNT_NO) = OFD701.SUB_ACC_NO
               AND OFD701.RSP_NO = 'ALL' AND OFD701.RSP_SRNO = 0
               AND OFD701.RSP_CHG_NO = 'ALL' AND OFD701.RSP_CHG_SRNO = 0
               AND OFD701.ACC_SUB_ID = 'ALL'
             WHERE RSP013.RSP_NO = XRELATIVE_NO
               AND RSP013.RSP_SRNO = WRELATIVE_SRNO
               AND RSP013.RSP_CHG_NO = WVOUCH_NO
               AND RSP013.RSP_CHG_SRNO = WVOUCH_SRNO;
        END;
        ELSE
        */
        --授權書
        IF (WSOURCE_CD = '3') THEN
        BEGIN
            MERGE INTO FAS.HOLDER_BANK_EC
            USING (
                    SELECT HOLDER_BANK_EC.ID,
                           HOLDER_BANK_EC.AC_BANK,
                           HOLDER_BANK_EC.AC_CODE,
                           HOLDER_BANK_EC.DEPOSITORY_NO,
                           HOLDER_BANK_EC.CURRENCY_NO,
                           OFD701.*
                      FROM FAS.HOLDER_BANK_EC
                      JOIN FAS.HOLDER
                        ON HOLDER.ID = HOLDER_BANK_EC.ID
                      JOIN FAS.FIS_BANK
                        ON FIS_BANK.BANK_NO = HOLDER_BANK_EC.AC_BANK
                      JOIN ECS.OFD701
                        ON OFD701.SEAL_TYPE = '3'
                       AND OFD701.SUB_ID_NO = HOLDER.ID
                       AND OFD701.SUB_BANK_CODE = HOLDER_BANK_EC.AC_BANK
                       AND OFD701.SUB_ACC_NO = HOLDER_BANK_EC.AC_CODE
                       AND OFD701.RSP_NO = 'ALL'
                       AND OFD701.RSP_SRNO = 0
                       AND OFD701.RSP_CHG_NO = 'ALL'
                       AND OFD701.RSP_CHG_SRNO = 0
                       AND OFD701.ACC_SUB_ID = 'ALL'
                     WHERE HOLDER_BANK_EC.ID = WSUB_ID_NO
                       AND HOLDER_BANK_EC.AC_BANK = WSUB_BANK_CODE
                       AND HOLDER_BANK_EC.AC_CODE = WSUB_ACC_NO
                       AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
                       AND HOLDER_BANK_EC.CURRENCY_NO <> 'NTD'
                  ) OFD701
               ON (HOLDER_BANK_EC.ID = OFD701.ID
              AND HOLDER_BANK_EC.AC_BANK = OFD701.AC_BANK
              AND HOLDER_BANK_EC.AC_CODE = OFD701.AC_CODE
              AND HOLDER_BANK_EC.DEPOSITORY_NO = OFD701.DEPOSITORY_NO
              AND HOLDER_BANK_EC.CURRENCY_NO = OFD701.CURRENCY_NO)
            WHEN MATCHED THEN
                UPDATE
                   SET HOLDER_BANK_EC.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                       HOLDER_BANK_EC.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.SEAL_DATE END,
                       HOLDER_BANK_EC.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.RETURN_DATE END,
                       HOLDER_BANK_EC.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                       HOLDER_BANK_EC.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                       HOLDER_BANK_EC.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                       HOLDER_BANK_EC.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END,
                       -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增UPDATE欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號)
                       HOLDER_BANK_EC.VOUCH_NO = WVOUCH_NO,
                       HOLDER_BANK_EC.VOUCH_SRNO = WVOUCH_SRNO,
                       -- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
                       -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                       HOLDER_BANK_EC.REJECTED = CASE OFD701.SEAL_STATUS WHEN '0' THEN NULL ELSE OFD701.RETURN_DATE END,
                       HOLDER_BANK_EC.REJECT_CODE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END;

            /*翻成上列寫法
            UPDATE BMS005
               SET BMS005.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   BMS005.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.SEAL_DATE END,
                   BMS005.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.RETURN_DATE END,
                   BMS005.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                   BMS005.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                   BMS005.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                   BMS005.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END
              FROM BMS005
              JOIN BMS001
                ON BMS005.BF_NO = BMS001.BF_NO
              JOIN OFD020V
                ON OFD020V.BANK_BRH = BMS005.BANK_BRH
              JOIN OFD701
                ON BMS005.SEAL_TYPE = OFD701.SEAL_TYPE
               AND BMS001.ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN BMS005.BANK_BRH
                        ELSE dbo.f_GetBankHQ(BMS005.BANK_BRH) END = OFD701.SUB_BANK_CODE
               AND BMS005.ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.RSP_NO = 'ALL'
               AND OFD701.RSP_SRNO = 0
               AND OFD701.RSP_CHG_NO = 'ALL'
               AND OFD701.RSP_CHG_SRNO = 0
               AND OFD701.ACC_SUB_ID = 'ALL'
               AND BMS005.REMIT_CFM_NO = WVOUCH_NO
               AND BMS005.DATA_SEQ = WVOUCH_SRNO;
            */
        END;

        --授權書異動
        -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
        ELSIF (WSOURCE_CD = '4') THEN
        BEGIN
           -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
           MERGE INTO FAS.HOLDER_BANK_EC_CHANGE
           USING (
                   SELECT HOLDER_BANK_EC_CHANGE.ID,
                          NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) NEW_AC_BANK ,
                          NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) NEW_AC_CODE,
                          NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) DEPOSITORY_NO,
                          NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) CURRENCY_NO,
                          OFD701.*
                     FROM FAS.HOLDER_BANK_EC_CHANGE
                     JOIN FAS.HOLDER
                       ON HOLDER.ID = HOLDER_BANK_EC_CHANGE.ID
                     JOIN FAS.FIS_BANK
                       ON FIS_BANK.BANK_NO = HOLDER_BANK_EC_CHANGE.AC_BANK
                     JOIN ECS.OFD701
                       ON OFD701.SEAL_TYPE = '3'
                      AND OFD701.SUB_ID_NO = HOLDER.ID
                      AND OFD701.SUB_BANK_CODE = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK)
                      AND OFD701.SUB_ACC_NO = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE)
                      AND OFD701.RSP_NO = 'ALL'
                      AND OFD701.RSP_SRNO = 0
                      AND OFD701.RSP_CHG_NO = 'ALL'
                      AND OFD701.RSP_CHG_SRNO = 0
                      AND OFD701.ACC_SUB_ID = 'ALL'
                    WHERE HOLDER_BANK_EC_CHANGE.ID = WSUB_ID_NO
                      AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = WSUB_BANK_CODE
                      AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = WSUB_ACC_NO
                      AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
                      AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) <> 'NTD'
                 ) OFD701
              ON (HOLDER_BANK_EC_CHANGE.ID = OFD701.ID
             AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = OFD701.NEW_AC_BANK
             AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = OFD701.NEW_AC_CODE
             AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = OFD701.DEPOSITORY_NO
             AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) = OFD701.CURRENCY_NO)
           WHEN MATCHED THEN
               UPDATE
                  SET HOLDER_BANK_EC_CHANGE.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                      HOLDER_BANK_EC_CHANGE.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.SEAL_DATE END,
                      HOLDER_BANK_EC_CHANGE.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE OFD701.RETURN_DATE END,
                      HOLDER_BANK_EC_CHANGE.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                      HOLDER_BANK_EC_CHANGE.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                      HOLDER_BANK_EC_CHANGE.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                      HOLDER_BANK_EC_CHANGE.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END,
                      -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增UPDATE欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號)
                      HOLDER_BANK_EC_CHANGE.VOUCH_NO = WVOUCH_NO,
                      HOLDER_BANK_EC_CHANGE.VOUCH_SRNO = WVOUCH_SRNO,
                      -- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
                      -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                      HOLDER_BANK_EC_CHANGE.REJECTED = CASE OFD701.SEAL_STATUS WHEN '0' THEN NULL ELSE OFD701.RETURN_DATE END,
                      HOLDER_BANK_EC_CHANGE.REJECT_CODE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END;
        /*
            UPDATE BMS005CHG
               SET BMS005CHG.SEAL_STATUS = CASE OFD701.SEAL_STATUS WHEN '0' THEN '9' ELSE OFD701.SEAL_STATUS END,
                   BMS005CHG.SEAL_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.SEAL_DATE END,
                   BMS005CHG.SEAL_RTN_DATE = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '1900/1/1' ELSE OFD701.RETURN_DATE END,
                   BMS005CHG.SEAL_FAIL_ID_CO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_CO END,
                   BMS005CHG.SEAL_FAIL_ID_BK = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.SEAL_FAIL_ID_BK END,
                   BMS005CHG.BATCH_ID = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.BATCH_ID END,
                   BMS005CHG.TRADE_NO = CASE WHEN OFD701.SEAL_STATUS = '0' THEN '' ELSE OFD701.TRADE_NO END
              FROM BMS005CHG
              JOIN BMS001CHG
                ON BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
              JOIN OFD020V
                ON OFD020V.BANK_BRH = BMS005CHG.AFT_BANK_BRH
              JOIN OFD701
                ON BMS005CHG.AFT_SEAL_TYPE = OFD701.SEAL_TYPE
               AND BMS001CHG.AFT_ID_NO = OFD701.SUB_ID_NO
               AND CASE WHEN (OFD020V.BANK_TYPE = '04' OR OFD020V.BANK_TYPE = '05') THEN BMS005CHG.AFT_BANK_BRH
                        ELSE dbo.f_GetBankHQ(BMS005CHG.AFT_BANK_BRH)
                        END = OFD701.SUB_BANK_CODE
               AND BMS005CHG.AFT_ACCOUNT_NO = OFD701.SUB_ACC_NO
               AND OFD701.RSP_NO= 'ALL' AND OFD701.RSP_SRNO= 0
               AND OFD701.RSP_CHG_NO='ALL' AND OFD701.RSP_CHG_SRNO=0
               AND OFD701.ACC_SUB_ID = 'ALL'
             WHERE BMS005CHG.AFT_REMIT_CFM_NO = XRELATIVE_NO
               AND BMS005CHG.AFT_DATA_SEQ = WRELATIVE_SRNO
               AND BMS005CHG.BF_CHG_NO = WVOUCH_NO
               AND BMS005CHG.DATA_SEQ = WVOUCH_SRNO;
        */
        END;

        END IF;

    END;
    END IF;

    --寫入重送記錄檔
    INSERT INTO ECS.OFD707
         (dataid, VOUCH_NO, VOUCH_SRNO, RELATIVE_NO, RELATIVE_SRNO, BATCH_ID, SEAL_TYPE, SUB_BANK_CODE,
         SUB_ACC_NO, SUB_ID_NO, SOURCE_CD, SEAL_USER_NO, SEAL_STATUS, SEAL_DATE, SEAL_RTN_DATE,
         SEAL_FAIL_ID_CO, SEAL_FAIL_ID_BK, TRADE_NO, BATCH_SRNO,
         Status, CreateID, CreateDate, EntryID, EntryDate, UpdateID, UpdateDate,
         VerifyID, VerifyDate, ApproveID, ApproveDate, RejectID, RejectDate)
    VALUES(CAST(SYS_GUID() AS VARCHAR2(38)), WVOUCH_NO, WVOUCH_SRNO, XRELATIVE_NO,
         WRELATIVE_SRNO, NVL(WBATCH_ID,' '), WSEAL_TYPE, WSUB_BANK_CODE,
         WSUB_ACC_NO, WSUB_ID_NO, WSOURCE_CD, NVL(WSEAL_USER_NO,' '), WSEAL_STATUS, WSEAL_DATE, WSEAL_RTN_DATE,
         NVL(WSEAL_FAIL_ID_CO,' '), NVL(WSEAL_FAIL_ID_BK,' '), WTRADE_NO, 0,
         '301', WUpdateID, WUpdateDate, WUpdateID, WUpdateDate, WUpdateID, WUpdateDate,
         WUpdateID, WUpdateDate, WUpdateID, WUpdateDate, ' ', XNullDate);

END s_ReSeal_Process;

/

  GRANT EXECUTE ON "ECS"."S_RESEAL_PROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVECANCELDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVECANCELDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/07
-- Description: 寫入委託取消資訊
-- 2018.06.19 ChengYu 新增 ECS.PURCHASE_LOG、ECS.REDEMPTION_LOG 時對應欄位
-- 2018.08.02 JIANXIN 調整優惠券恢復方式
-- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
-- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
-- 2018.09.06 YungLong 刪除前取出欲刪除資料
-- 2018.11.21 tingting 單筆申購 增加傳出欄位：委託交易類別、交易幣別小數位數
--                     買回、轉申購 增加傳出欄位：委託交易類別、單位數小數位數
--                     定期定額、定期不定額 增加傳出欄位：委託交易類別、交易幣別小數位數
-- 2018.11.28 ChengYu 調整通知信樣板
-- 2018.11.29 ChengYu 修正轉申購幣別欄位
-- 2018.11.30 ChengYu 修正通知信日期
-- =============================================
(
    WACCOUNT_NO            INTEGER,                 -- 受益人帳戶
    WIP_A                  VARCHAR2,                -- IP_A
    WIP_B                  VARCHAR2,                -- IP_B
    WIP_C                  VARCHAR2,                -- IP_C
    WIP_D                  VARCHAR2,                -- IP_D
    WCANCELLIST            VARCHAR2,                -- 資料字串(委託交易類別;基金代碼;交易日期;交易序號,)
    OUTDT                  OUT SYS_REFCURSOR,       -- MASTER
    OUTDT2                 OUT SYS_REFCURSOR,       -- CancelErrList
    -- 2018.09.06 YungLong回傳刪除前取出欲刪除資料   
    OUTDT3                 OUT SYS_REFCURSOR        -- ReturnDeleteList
) IS

    XID                VARCHAR2(10);           -- 受益人ID
    XERROR_MSG         VARCHAR2(100);          -- 回傳的錯誤訊息
    XSYS_DTTM          DATE:=SYSDATE;          -- 系統日期時間
    XDATACOUNT         INTEGER;                -- 資料筆數
    XTX_TYPE           VARCHAR2(1);            -- 委託交易類別 1：單筆申購；2：買回；3：轉申購；4：定期定額；5：定期不定額
    XFUND_NO           VARCHAR2(5);            -- 基金代碼
    XTX_DATE           DATE;                   -- 交易日期
    -- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
    XSER_NO            VARCHAR2(4);            -- 交易序號
    XP_TYPE            VARCHAR2(2);        	   -- 產品類別
    XFEE_CHOICE        VARCHAR2(1);            -- 優惠方案
    XTRANSACTION_NO    INTEGER;                -- 交易編號
    XCOUPON_ID         VARCHAR2(20);           -- COUPON ID
    XREMARK            VARCHAR2(500);          -- 備註
    XBRANCH_NO         VARCHAR2(4);            -- 代銷分公司碼
    XBROKER_NO         VARCHAR2(3):= '999';    -- 代銷單位
    XSTATUS            VARCHAR2(1):= 'O';      -- 交易狀態
    -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
    XRSP_STATUS        VARCHAR2(1):= '1';      -- 交易狀態(RSP)

BEGIN

    -- 取得受益人ID
    BEGIN

        SELECT HOLDER.ID
          INTO XID
          FROM FAS.HOLDER HOLDER
         WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    -- 取資料筆數
    SELECT COUNT(1)
      INTO XDATACOUNT
      FROM (SELECT REGEXP_SUBSTR(WCANCELLIST,'[^,]+', 1, LEVEL) AS STR
              FROM DUAL
           CONNECT BY REGEXP_SUBSTR(WCANCELLIST, '[^,]+', 1, LEVEL) IS NOT NULL
           )LINE;

    -- 基金代碼是否存在
    FOR I IN 1..XDATACOUNT LOOP
        SELECT CASE WHEN FUND.FUND_NO IS NULL THEN TRIM(CONCAT(XERROR_MSG,SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,1)+1,INSTR(LINE.STR,';',1,2)-INSTR(LINE.STR,';',1,1)-1)))||';' -- 基金代碼
                    ELSE XERROR_MSG
               END AS ERROR_MSG
          INTO XERROR_MSG
          FROM (SELECT  REGEXP_SUBSTR(WCANCELLIST,'[^,]+', 1, LEVEL) AS STR
                       ,ROWNUM AS NUM
                  FROM DUAL
               CONNECT BY REGEXP_SUBSTR(WCANCELLIST, '[^,]+', 1, LEVEL) IS NOT NULL
               )LINE
          LEFT JOIN FAS.FUND FUND
            ON FUND.FUND_NO = SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,1)+1,INSTR(LINE.STR,';',1,2)-INSTR(LINE.STR,';',1,1)-1)
         WHERE LINE.NUM = I;
    END LOOP;

    IF XERROR_MSG IS NULL THEN
    BEGIN
        -- 資料字串轉TABLE後放入各變數
        FOR I IN 1..XDATACOUNT LOOP
            SELECT  SUBSTR(LINE.STR,0,INSTR(LINE.STR,';',1,1)-1) AS TX_TYPE                                                           -- 委託交易類別
                   ,SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,1)+1,INSTR(LINE.STR,';',1,2)-INSTR(LINE.STR,';',1,1)-1) AS FUND_NO           -- 基金代碼
                   ,TO_DATE(SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,2)+1,INSTR(LINE.STR,';',1,3)-INSTR(LINE.STR,';',1,2)-1),'YYYYMMDD') AS TX_DATE    -- 交易日期
                    -- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
                   ,SUBSTR(LINE.STR,INSTR(LINE.STR,';',1,3)+1,LENGTH(LINE.STR)-INSTR(LINE.STR,';',1,3)) AS SER_NO      -- 交易序號
              INTO  XTX_TYPE
                   ,XFUND_NO
                   ,XTX_DATE
                   ,XSER_NO
              FROM (SELECT  REGEXP_SUBSTR(WCANCELLIST,'[^,]+', 1, LEVEL) AS STR
                           ,ROWNUM AS NUM
                      FROM DUAL
                   CONNECT BY REGEXP_SUBSTR(WCANCELLIST, '[^,]+', 1, LEVEL) IS NOT NULL
                   )LINE
             WHERE LINE.NUM = I;

            -- 取得產品類別或代銷分公司碼
            CASE

                WHEN XTX_TYPE = '1' OR XTX_TYPE = '2' THEN

                    XBRANCH_NO := '8000';

                WHEN XTX_TYPE = '3' THEN

                    XBRANCH_NO := '8300';

                WHEN XTX_TYPE = '4' THEN

                    XP_TYPE := 'P8';

                WHEN XTX_TYPE = '5' THEN

                    XP_TYPE := 'P9';

            END CASE;

            IF XTX_TYPE = '1' THEN
            BEGIN

                -- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
                BEGIN

                    -- 取得優惠方案及交易編號
                    SELECT  FEE_CHOICE
                           ,TRANSACTION_NO
                      INTO  XFEE_CHOICE
                           ,XTRANSACTION_NO
                      FROM ECS.PURCHASE PURCHASE
                     WHERE PURCHASE.FUND_NO = XFUND_NO
                       AND PURCHASE.TX_DATE = XTX_DATE
                       AND PURCHASE.BROKER_NO = XBROKER_NO
                       AND PURCHASE.BRANCH_NO = XBRANCH_NO
                       AND PURCHASE.STATUS = XSTATUS
                       AND PURCHASE.SER_NO = XSER_NO;

                    EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            XFEE_CHOICE := ' ';
                            XTRANSACTION_NO := 0;
                END;

                -- 將【EC申購(ECS.PURCHASE)】檔刪除的資料寫入【EC申購紀錄(ECS.PURCHASE_LOG)】檔
                -- 2018.06.19 ChengYu 新增 ECS.PURCHASE_LOG、ECS.REDEMPTION_LOG 時對應欄位
                INSERT INTO ECS.PURCHASE_LOG
                (
                       FUND_NO
                      ,ID
                      ,TX_DATE
                      ,BROKER_NO
                      ,BRANCH_NO

                      ,SER_NO
                      ,AMOUNT
                      ,SERVICE_CHARGE
                      ,PAY_TYPE
                      ,REMARK

                      ,BANK_NO
                      ,AC_CODE
                      ,PROJECT_CODE
                      ,ACTION_TYPE
                      ,REVISION_DATE

                      ,AC_DATE
                      ,AC_BRANCH
                      ,CURRENCY_NO
                      ,PROSPECTUS
                      ,TRANSACTION_NO

                      ,USED_POINT
                      ,IP_A
                      ,IP_B
                      ,IP_C
                      ,IP_D

                      ,INVESTMENT_RISK
                      ,CHANNEL_EXPOSE
                      ,ONSHORE_SHORT_TRADE
                      ,ROBO_CONTRACT_NO
                      ,ROBO_SER_NO

                      ,FEE_CHOICE                   
                      ,COUPON_ID
                      ,SC_RATE 
                      ,ROBO_BATCH_NO                   
                      ,AC_CNT
                )
                SELECT FUND_NO                   --基金別
                      ,ID                       --ID
                      ,TX_DATE                  --交易日期
                      ,BROKER_NO                --代銷單位
                      ,BRANCH_NO                --代銷分公司碼

                      ,SER_NO                   --交易序號
                      ,AMOUNT                   --申購價金
                      ,SERVICE_CHARGE           --手續費
                      ,PAY_TYPE                 --付款方式
                      ,REMARK                   --備註

                      ,BANK_NO                  --銀行代號
                      ,AC_CODE                  --銀行帳號
                      ,PROJECT_CODE             --專案碼
                      ,'D'                      --交易動作(A:新增/M:修改/D:刪除)
                      ,XSYS_DTTM                --最後修改日期

                      ,AC_DATE                  --淨值日
                      ,AC_BRANCH                --扣款分行代碼
                      ,CURRENCY_NO              --幣別
                      ,PROSPECTUS               --公開說明書
                      ,USED_POINT               --使用紅利

                      ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
                      ,WIP_A                     --IP A
                      ,WIP_B                     --IP B
                      ,WIP_C                     --IP C
                      ,WIP_D                     --IP D

                      ,INVESTMENT_RISK          --投資風險評估
                      ,CHANNEL_EXPOSE           --通路報酬揭露
                      ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
                      ,ROBO_CONTRACT_NO         --ROBO契約書號
                      ,ROBO_SER_NO              --ROBO交易書號

                      ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
                      ,COUPON_ID                --優惠券號碼
                      ,SC_RATE                  --申購手續費率
                      ,ROBO_BATCH_NO            --ROBO再平衡批次編號
                      ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
                 FROM ECS.PURCHASE PURCHASE
                WHERE PURCHASE.FUND_NO = XFUND_NO
                  AND PURCHASE.TX_DATE = XTX_DATE
                  AND PURCHASE.BROKER_NO = XBROKER_NO
                  AND PURCHASE.BRANCH_NO = XBRANCH_NO
                  AND PURCHASE.STATUS = XSTATUS
                  AND PURCHASE.SER_NO = XSER_NO;

                -- 2018.09.06 YungLong回傳刪除前取出欲刪除資料 申購
                -- 2018.11.21 tingting 單筆申購 增加傳出欄位：委託交易類別、交易幣別小數位數
                --                     買回、轉申購 增加傳出欄位：委託交易類別、單位數小數位數
                --                     定期定額、定期不定額 增加傳出欄位：委託交易類別、交易幣別小數位數
                OPEN OUTDT3 FOR
                SELECT XTX_TYPE AS TX_TYPE
                      ,XTX_DATE AS TX_DATE
                      ,FUND.NAME AS FUND_NAME
                      ,FUND.CURRENCY_NO AS FUND_CURRENCY_NO
                      ,FUND_CRNCY.NAME AS FUND_CURRENCY_NAME
                      ,PURCHASE.AMOUNT AS AMOUNT
                      ,PURCHASE.CURRENCY_NO AS TRADE_CURRENCY_NO
                      ,PURCHASE_CRNCY.NAME AS TRADE_CURRENCY_NAME
                      ,PURCHASE_CRNCY.AMT_DECIMAL AS TRADE_CURRENCY_DECIMAL
                      ,PURCHASE.SERVICE_CHARGE AS SERVICE_CHARGE
                  FROM ECS.PURCHASE PURCHASE
                  LEFT JOIN FAS.FUND FUND
                    ON FUND.FUND_NO = PURCHASE.FUND_NO
                  LEFT JOIN ECS.V_FUND_CRNCY FUND_CRNCY
                    ON FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
                  LEFT JOIN ECS.V_FUND_CRNCY PURCHASE_CRNCY
                    ON PURCHASE_CRNCY.CURRENCY_NO = PURCHASE.CURRENCY_NO
                 WHERE PURCHASE.BROKER_NO = XBROKER_NO
                   AND PURCHASE.BRANCH_NO = XBRANCH_NO
                   AND PURCHASE.FUND_NO = XFUND_NO
                   AND PURCHASE.TX_DATE = XTX_DATE
                   AND PURCHASE.SER_NO = XSER_NO;

                -- 刪除資料
                DELETE FROM ECS.PURCHASE PURCHASE
                 WHERE PURCHASE.BROKER_NO = XBROKER_NO
                   AND PURCHASE.BRANCH_NO = XBRANCH_NO
                   AND PURCHASE.STATUS = XSTATUS
                   AND PURCHASE.FUND_NO = XFUND_NO
                   AND PURCHASE.TX_DATE = XTX_DATE
                   AND PURCHASE.SER_NO = XSER_NO;

                IF XFEE_CHOICE = '3' THEN
                BEGIN

                    -- 刪除 紅利使用點數
                    DELETE FROM FAS.REWARD_DETAILS REWARD_DETAILS
                     WHERE REWARD_DETAILS.TRANSACTION_NO = XTRANSACTION_NO
                       AND REWARD_DETAILS.USE_TYPE = '1';

                    -- 刪除 紅利歷史使用明細
                    DELETE FROM FAS.REWARD_HISTORY REWARD_HISTORY
                     WHERE REWARD_HISTORY.TRANSACTION_NO = XTRANSACTION_NO
                       AND REWARD_HISTORY.USE_TYPE = '1';
                END;
                ELSIF XFEE_CHOICE = '2' THEN
                BEGIN

                    -- 2018.08.02 JIANXIN 調整優惠券恢復方式
                    --取得 此次需要恢復的優惠券
                    SELECT COUPON_ID
                      INTO XCOUPON_ID
                      FROM ECS.COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO;

                    -- 刪除 優惠券
                    DELETE FROM ECS.COUPON_DETAILS COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_DETAILS.USE_TYPE = '1';

                    -- 刪除 優惠券
                    DELETE FROM ECS.COUPON_HISTORY COUPON_HISTORY
                     WHERE COUPON_HISTORY.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_HISTORY.USE_TYPE = '1';

                    -- 優惠券恢復
                    UPDATE ECS.COUPON_DATA COUPON_DATA
                       SET  IS_EFFECT = 'Y'
                           ,USED_DATE = ''
                           ,USE_TYPE = ''
                           ,UPDATEID = 'ECS'
                           ,UPDATEDATE = XSYS_DTTM
                     WHERE COUPON_DATA.ID =XID
                       AND COUPON_DATA.COUPON_ID = XCOUPON_ID;

                END;
                END IF;

            END;
            END IF;

            IF XTX_TYPE = '2' OR XTX_TYPE = '3' THEN
            BEGIN

                -- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
                BEGIN
                    --取得優惠方案及交易編號
                    SELECT  FEE_CHOICE
                           ,TRANSACTION_NO
                      INTO  XFEE_CHOICE
                           ,XTRANSACTION_NO
                      FROM ECS.REDEMPTION REDEMPTION
                     WHERE REDEMPTION.FUND_NO = XFUND_NO
                       AND REDEMPTION.TX_DATE = XTX_DATE
                       AND REDEMPTION.BROKER_NO = XBROKER_NO
                       AND REDEMPTION.BRANCH_NO = XBRANCH_NO
                       AND REDEMPTION.STATUS = XSTATUS
                       AND REDEMPTION.SER_NO = XSER_NO;

                    EXCEPTION
                        WHEN NO_DATA_FOUND THEN
                            XFEE_CHOICE := ' ';
                            XTRANSACTION_NO := 0;
                END;

                -- 2018.06.19 ChengYu 新增 ECS.PURCHASE_LOG、ECS.REDEMPTION_LOG 時對應欄位
                INSERT INTO ECS.REDEMPTION_LOG
                (
                        FUND_NO
                       ,ID
                       ,TX_DATE
                       ,BROKER_NO
                       ,BRANCH_NO

                       ,SER_NO
                       ,REDEMPTION_TYPE
                       ,APPLICATION_SHARE
                       ,AC_BANK
                       ,AC_BRANCH

                       ,AC_FIS_SNAME
                       ,AC_CODE
                       ,FUND_NO_IN
                       ,ACTION_TYPE
                       ,REVISION_DATE

                       ,AC_NAME
                       ,AC_DATE
                       ,CURRENCY_NO
                       ,BANK_CURRENCY_NO
                       ,PROSPECTUS

                       ,IP_A
                       ,IP_B
                       ,IP_C
                       ,IP_D
                       ,INVESTMENT_RISK

                       ,CHANNEL_EXPOSE
                       ,ONSHORE_SHORT_TRADE
                       ,PAY_DATE
                       ,SWITCH_DATE                   
                       ,FEE_CHOICE

                       ,SC_RATE
                       ,PROJECT_CODE
                       ,USED_POINT
                       ,TRANSACTION_NO
                       ,ROBO_CONTRACT_NO                   
                       ,ROBO_SER_NO

                       ,COUPON_ID
                       ,SERVICE_CHARGE
                       ,ROBO_BATCH_NO
                )
                SELECT  FUND_NO                   --基金別
                       ,ID                       --ID
                       ,TX_DATE                  --交易日期
                       ,BROKER_NO                --代銷單位
                       ,BRANCH_NO                --代銷分公司碼

                       ,SER_NO                   --交易序號
                       ,REDEMPTION_TYPE          --買回方式(W:全贖/S:部份)
                       ,APPLICATION_SHARE        --買回單位數
                       ,AC_BANK                  --買回銀行
                       ,AC_BRANCH                --買回分行

                       ,AC_FIS_SNAME             --買回銀行簡稱
                       ,AC_CODE                  --買回帳號
                       ,FUND_NO_IN               --轉申購基金別
                       ,'D'                      --交易動作(A:新增/M:修改/D:刪除)
                       ,XSYS_DTTM                --修改日期(含時分秒)

                       ,AC_NAME                  --戶名
                       ,AC_DATE                  --淨值日
                       ,CURRENCY_NO              --幣別
                       ,BANK_CURRENCY_NO         --銀行幣別
                       ,PROSPECTUS               --公開說明書

                       ,WIP_A                     --IP A
                       ,WIP_B                     --IP B
                       ,WIP_C                     --IP C
                       ,WIP_D                     --IP D
                       ,INVESTMENT_RISK          --投資風險評估

                       ,CHANNEL_EXPOSE           --通路報酬揭露
                       ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
                       ,PAY_DATE                 --預計買回入帳日期
                       ,SWITCH_DATE              --預計轉申購日期
                       ,FEE_CHOICE               --優惠方案(1：促銷活動；3：紅利折抵；4：身分別；5：生日優惠)

                       --,SERVICE_CHARGE_RATE
                       ,SC_RATE                  --轉申購手續費率
                       ,PROJECT_CODE             --專案碼
                       ,USED_POINT               --使用紅利
                       ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
                       ,ROBO_CONTRACT_NO         --ROBO契約書號
                       ,ROBO_SER_NO              --ROBO交易書號

                       ,COUPON_ID                --優惠券號碼
                       ,SERVICE_CHARGE           --轉申購手續費
                       ,ROBO_BATCH_NO            --ROBO再平衡批次編號
                  FROM ECS.REDEMPTION
                 WHERE REDEMPTION.FUND_NO = XFUND_NO
                   AND REDEMPTION.TX_DATE = XTX_DATE
                   AND REDEMPTION.BROKER_NO = XBROKER_NO
                   AND REDEMPTION.BRANCH_NO = XBRANCH_NO
                   AND REDEMPTION.STATUS = XSTATUS
                   AND REDEMPTION.SER_NO = XSER_NO;

                IF XFEE_CHOICE = '3' THEN
                BEGIN
                    --以「交易編號(@TRANSACTION_NO) 」至【紅利使用點數(FAS.REWARD_DETAILS)】檔取得「使用類別(USE_TYPE)」= “2.轉申購”的資料刪除
                    DELETE FROM FAS.REWARD_DETAILS
                     WHERE REWARD_DETAILS.TRANSACTION_NO = XTRANSACTION_NO
                       AND REWARD_DETAILS.USE_TYPE = '2';

                    --以「交易編號(@TRANSACTION_NO) 」至【紅利歷史使用明細(FAS.REWARD_HISTORY)】檔取得「使用類別(USE_TYPE)」= “2.轉申購”的資料刪除
                    DELETE FROM FAS.REWARD_HISTORY
                     WHERE REWARD_HISTORY.TRANSACTION_NO = XTRANSACTION_NO
                       AND REWARD_HISTORY.USE_TYPE = '2';

                END;
                ELSIF XFEE_CHOICE = '2' THEN
                BEGIN

                    --取得COUPON_ID
                    SELECT COUPON_ID
                      INTO XCOUPON_ID
                      FROM ECS.COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO;

                    --更新【優惠券配發資料(ECS.COUPON_DATA)】檔
                    UPDATE ECS.COUPON_DATA
                      SET IS_EFFECT = 'Y'            --有效否 Y：有效；N：無效
                          ,USED_DATE = ''            --使用日期
                          ,USE_TYPE = ''             --使用類別
                          ,UPDATEID = 'ECS'          --最後修改者
                          ,UPDATEDATE = XSYS_DTTM    --最後修改日期
                    WHERE COUPON_ID = XCOUPON_ID
                      AND ID = XID;

                    --以「交易編號(@TRANSACTION_NO) 」至【優惠券使用記錄(ECS.COUPON_DETAILS)】檔取得「使用類別(USE_TYPE)」= “4.轉申購”的資料刪除
                    DELETE FROM ECS.COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_DETAILS.USE_TYPE = '4';

                    --以「交易編號(@TRANSACTION_NO) 」至【優惠券使用明細(ECS.COUPON_HISTORY)】檔取得「使用類別(USE_TYPE)」= “4.轉申購”的資料刪除
                    DELETE FROM ECS.COUPON_HISTORY
                     WHERE COUPON_HISTORY.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_HISTORY.USE_TYPE = '4';

                END;
                END IF;

                -- 2018.09.06 YungLong回傳刪除前取出欲刪除資料 贖回 轉申購
                -- 2018.09.11 YungLong 贖回參數
                OPEN OUTDT3 FOR
                -- 2018.11.21 tingting 單筆申購 增加傳出欄位：委託交易類別、交易幣別小數位數
                --                     買回、轉申購 增加傳出欄位：委託交易類別、單位數小數位數
                --                     定期定額、定期不定額 增加傳出欄位：委託交易類別、交易幣別小數位數
                SELECT XTX_TYPE AS TX_TYPE
                      ,REDEMPTION.TX_DATE AS RE_TX_DATE
                      ,REDEMPTION.REDEMPTION_TYPE AS RE_REDEMPTION_TYPE
                      ,FUND.NAME AS RE_FUND_NAME
                      -- 2018.11.29 ChengYu 修正轉申購幣別欄位
                      ,FUND.CURRENCY_NO AS RE_FUND_CURRENCY_NO
                      ,FUND_CRNCY.NAME AS RE_FUND_CURRENCY_NAME
                      ,REDEMPTION.APPLICATION_SHARE AS RE_APPLICATION_SHARE
                      ,FUND.SHARE_DECIMAL AS RE_SHARE_DECIMAL
                      ,REDEMPTION.CURRENCY_NO AS RE_TRADE_CURRENCY_NO
                      ,REDEM_CRNCY.NAME AS RE_TRADE_CURRENCY_NAME
                      -- 2018.11.28 ChengYu 調整通知信樣板
                      ,REDEMPTION.BANK_CURRENCY_NO AS RE_BANK_CURRENCY_NO
                      ,BANK_CRNCY.NAME AS RE_BANK_CURRENCY_NAME
                      ,REDEMPTION.AC_NAME AS RE_AC_NAME
                      ,REDEMPTION.AC_FIS_SNAME AS RE_FIS_NAME
                      ,ECS.FN_STUFF_STR(REDEMPTION.AC_CODE,5,'*') AS RE_AC_CODE_5
                      ,REDEMPTION.PAY_DATE AS RE_PAY_DATE
                      -- 2018.09.11 YungLong 轉申購參數
                      -- 2018.11.30 ChengYu 修正通知信日期
                      ,REDEMPTION.TX_DATE AS SW_TX_DATE
                      ,FUND_IN.NAME AS SW_FUND_NO_IN
                      ,FUND_IN.CURRENCY_NO AS SW_FUND_CURRENCY_NO
                      -- 2018.11.29 ChengYu 修正轉申購幣別欄位
                      ,FUND_CRNCY_IN.NAME AS SW_FUND_CURRENCY_NAME
                      ,FUND.NAME AS SW_FUND_NO_OUT
                      ,FUND.CURRENCY_NO AS SW_CURRENCY_NO
                      -- 2018.11.29 ChengYu 修正轉申購幣別欄位
                      ,FUND_CRNCY.NAME AS SW_CURRENCY_NAME
                      ,REDEMPTION.APPLICATION_SHARE AS SW_APPLICATION_SHARE
                      ,FUND.SHARE_DECIMAL AS SW_SHARE_DECIMAL
                      ,REDEMPTION.SC_RATE AS SW_SC_RATE
                      ,REDEMPTION.SERVICE_CHARGE AS SW_SERVICE_CHARGE   
                      -- 2018.11.30 ChengYu 修正通知信日期
                      ,REDEMPTION.SWITCH_DATE AS SW_SWITCH_DATE
                  FROM ECS.REDEMPTION REDEMPTION
                  LEFT JOIN FAS.FUND FUND
                    ON FUND.FUND_NO = REDEMPTION.FUND_NO
                  LEFT JOIN ECS.V_FUND_CRNCY FUND_CRNCY
                    ON FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
                  LEFT JOIN FAS.FUND FUND_IN
                    ON FUND_IN.FUND_NO = REDEMPTION.FUND_NO_IN
                  LEFT JOIN ECS.V_FUND_CRNCY FUND_CRNCY_IN
                    ON FUND_CRNCY_IN.CURRENCY_NO = FUND_IN.CURRENCY_NO
                  LEFT JOIN ECS.V_FUND_CRNCY REDEM_CRNCY
                    ON REDEM_CRNCY.CURRENCY_NO = REDEMPTION.CURRENCY_NO
                  LEFT JOIN ECS.V_FUND_CRNCY BANK_CRNCY
                    ON BANK_CRNCY.CURRENCY_NO = REDEMPTION.BANK_CURRENCY_NO
                 WHERE REDEMPTION.FUND_NO = XFUND_NO
                   AND REDEMPTION.BROKER_NO = XBROKER_NO
                   AND REDEMPTION.BRANCH_NO = XBRANCH_NO
                   AND REDEMPTION.STATUS = XSTATUS
                   AND REDEMPTION.SER_NO = XSER_NO;

                DELETE FROM ECS.REDEMPTION REDEMPTION
                 WHERE REDEMPTION.FUND_NO = XFUND_NO
                   AND REDEMPTION.BROKER_NO = XBROKER_NO
                   AND REDEMPTION.BRANCH_NO = XBRANCH_NO
                   AND REDEMPTION.SER_NO = XSER_NO
                   AND REDEMPTION.STATUS = XSTATUS;
            END;
            END IF;

            IF XTX_TYPE = '4' OR XTX_TYPE = '5' THEN
            BEGIN

                -- 2018.08.15 JIANXIN 調整取消委託時，沒有刪除到正確的資料問題
                BEGIN

                    -- 取得優惠方案及交易編號
                    SELECT  FEE_CHOICE
                           ,TRANSACTION_NO
                      INTO  XFEE_CHOICE
                           ,XTRANSACTION_NO
                      FROM ECS.RSP RSP
                     WHERE RSP.FUND_NO = XFUND_NO
                       AND RSP.PRODUCT_TYPE = XP_TYPE
                       -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
                       AND RSP.STATUS = XRSP_STATUS
                       AND RSP.ID = XID
				       -- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
                       AND RSP.ID_SEQ = TO_NUMBER(XSER_NO);

                       EXCEPTION
                           WHEN NO_DATA_FOUND THEN
                                XFEE_CHOICE := ' ';
                                XTRANSACTION_NO := 0;
                END;

                -- 取得備註(未完)
                SELECT CASE WHEN XP_TYPE = 'P8'
                            THEN '定期定額取消;' ||
                                 FUND.FUND_NO ||
                                 FUND.NAME    ||
                                 ';每月'      || RSP.AC_DAY || '號交易日;' ||
                                 '扣款帳號'   || FIS_BANK.SNAME || RSP.AC_CODE || ';' ||
                                 '金額' || ROUND(RSP.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;'

                            WHEN XP_TYPE = 'P9'
                            THEN '定期不定額取消;' ||
                                 FUND.FUND_NO ||
                                 FUND.NAME    ||
                                 ';每月'      || RSP.AC_DAY || '號交易日;' ||
                                 '扣款帳號'   || FIS_BANK.SNAME || RSP.AC_CODE || ';' ||
                                 '基準扣款金額' || ROUND(RSP.AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;' ||
                                 '加碼' || ROUND(RSP.RAISE_ROI,1) || '%;' ||
                                 '加碼金額' || ROUND(RSP.RAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;' ||
                                 '減碼' || ROUND(RSP.REDUCE_ROI,1) || '%;' ||
                                 '減碼金額' || ROUND(RSP.REDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;'

                       END AS REMARK
                  INTO XREMARK
                  FROM ECS.RSP RSP
                  JOIN FAS.FUND FUND
                    ON FUND.FUND_NO = RSP.FUND_NO
                  JOIN FAS.FIS_BANK FIS_BANK
                    ON FIS_BANK.BANK_NO = RSP.BANK_NO
                  JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY
                    ON V_FUND_CRNCY.CURRENCY_NO = RSP.CURRENCY_NO
                 WHERE RSP.FUND_NO = XFUND_NO
                   AND RSP.PRODUCT_TYPE = XP_TYPE
                   -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
                   AND RSP.STATUS = XRSP_STATUS
                   AND RSP.ID = XID
			       -- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
                   AND RSP.ID_SEQ = TO_NUMBER(XSER_NO);

                --將【EC定額(ECS.RSP)】檔刪除的資料寫入【EC(不)定額異動紀錄(ECS.RSP_LOG)】檔
                INSERT INTO ECS.RSP_LOG
                (
                        ID                    --ID
                       ,ID_SEQ                --契約序號
                       ,FUND_NO               --基金別
                       ,AMOUNT                --申購價金
                       ,AC_DAY                --約定交易日

                       ,BANK_NO               --銀行代號
                       ,BRANCH_NO             --分行代號
                       ,AC_CODE               --銀行帳號
                       ,STATUS                --契約狀態 0：退件；1：收件；2：送交核印；3：核印完成；
                                              --4：有效；5：未核先轉；6：作廢；7：暫停扣款；8：停止扣款

                       ,REVISION_DATE         --修改日期(含時分秒)
                       ,REMARK                --備註
                       ,ACTION_TYPE           --交易動作(A:新增/M:修改/D:刪除)
                       ,EXPECTED_TX_DATE      --預計交易日期
                       ,CURRENCY_NO           --幣別
                       ,AC_NAME               --戶名

                       ,PROSPECTUS            --公開說明書
                       ,IP_A                  --IP A
                       ,IP_B                  --IP B
                       ,IP_C                  --IP C
                       ,IP_D                  --IP D

                       ,INVESTMENT_RISK       --投資風險評估
                       ,CHANNEL_EXPOSE        --通路報酬揭露
                       ,PROJECT_CODE          --專案碼
                       ,PRODUCT_TYPE          --產品類別 定額='P8'/不定額='P9'
                       ,RAISE_ROI             --加碼點(%)

                       ,RAISE_AMOUNT          --加碼金額
                       ,REDUCE_ROI            --減碼點(%)
                       ,REDUCE_AMOUNT         --減碼金額
                       ,ONSHORE_SHORT_TRADE   --境內短線交易(Y/N)
                       ,FEE_CHOICE            --優惠方案；1：促銷活動；2：優惠券； 4：身分別

                       ,SC_RATE               --契約手續費率
                )
                SELECT  ID                   --ID
                       ,ID_SEQ               --契約序號
                       ,FUND_NO              --基金別
                       ,AMOUNT               --申購價金
                       ,AC_DAY               --約定交易日

                       ,BANK_NO              --銀行代號
                       ,BRANCH_NO            --分行代號
                       ,AC_CODE              --銀行帳號
                       ,STATUS               --契約狀態 0：退件；1：收件；2：送交核印；3：核印完成；
                                             --4：有效；5：未核先轉；6：作廢；7：暫停扣款；8：停止扣款

                       ,XSYS_DTTM            --修改日期(含時分秒)
                       ,XREMARK              --備註
                       ,'D'                  --交易動作(A:新增/M:修改/D:刪除)
                       ,EXPECTED_TX_DATE     --預計交易日期
                       ,CURRENCY_NO          --幣別
                       ,AC_NAME              --戶名

                       ,PROSPECTUS           --公開說明書
                       ,WIP_A                --IP A
                       ,WIP_B                --IP B
                       ,WIP_C                --IP C
                       ,WIP_D                --IP D

                       ,INVESTMENT_RISK      --投資風險評估
                       ,CHANNEL_EXPOSE       --通路報酬揭露
                       ,PROJECT_CODE         --專案碼
                       ,XP_TYPE              --產品類別 定額='P8'/不定額='P9'
                       ,RAISE_ROI            --加碼點(%)

                       ,RAISE_AMOUNT         --加碼金額
                       ,REDUCE_ROI           --減碼點(%)
                       ,REDUCE_AMOUNT        --減碼金額
                       ,ONSHORE_SHORT_TRADE  --境內短線交易(Y/N)
                       ,FEE_CHOICE           --優惠方案；1：促銷活動；2：優惠券； 4：身分別

                       ,SC_RATE              --契約手續費率
                  FROM ECS.RSP RSP
                 WHERE RSP.FUND_NO = XFUND_NO
                   AND RSP.PRODUCT_TYPE = XP_TYPE
                   -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
                   AND RSP.STATUS = XRSP_STATUS
                   AND RSP.ID = XID
			       -- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
                   AND RSP.ID_SEQ = TO_NUMBER(XSER_NO);

                IF XFEE_CHOICE = '2' THEN
                BEGIN

                    --取得COUPON_ID
                    SELECT COUPON_ID
                      INTO XCOUPON_ID
                      FROM ECS.COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO;

                    --更新【優惠券配發資料(ECS.COUPON_DATA)】檔
                    UPDATE ECS.COUPON_DATA
                      SET IS_EFFECT = 'Y'            --有效否 Y：有效；N：無效
                          ,USED_DATE = ''            --使用日期
                          ,USE_TYPE = ''             --使用類別
                          ,UPDATEID = 'ECS'          --最後修改者
                          ,UPDATEDATE = XSYS_DTTM    --最後修改日期
                    WHERE COUPON_ID = XCOUPON_ID
                      AND ID = XID;

                    --以「交易編號(@TRANSACTION_NO) 」至【優惠券使用記錄(ECS.COUPON_DETAILS)】檔取得「使用類別(USE_TYPE)」= “2.定期定額或3.定期不定額”的資料刪除
                    DELETE FROM ECS.COUPON_DETAILS
                     WHERE COUPON_DETAILS.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_DETAILS.USE_TYPE = CASE WHEN XP_TYPE = 'P8' THEN '2'
                                                          WHEN XP_TYPE = 'P9' THEN '3'
                                                          END;
                    --以「交易編號(@TRANSACTION_NO) 」至【優惠券使用明細(ECS.COUPON_HISTORY)】檔取得「使用類別(USE_TYPE)」= “2.定期定額或3.定期不定額”的資料刪除                                      END;
                    DELETE FROM ECS.COUPON_HISTORY
                     WHERE COUPON_HISTORY.TRANSACTION_NO = XTRANSACTION_NO
                       AND COUPON_HISTORY.USE_TYPE = CASE WHEN XP_TYPE = 'P8' THEN '2'
                                                          WHEN XP_TYPE = 'P9' THEN '3'
                                                          END;

                END;
                END IF;

                -- 2018.09.06 YungLong回傳刪除前取出欲刪除資料
                -- 2018.11.21 tingting 單筆申購 增加傳出欄位：委託交易類別、交易幣別小數位數
                --                     買回、轉申購 增加傳出欄位：委託交易類別、單位數小數位數
                --                     定期定額、定期不定額 增加傳出欄位：委託交易類別、交易幣別小數位數
                OPEN OUTDT3 FOR
                SELECT XTX_TYPE AS TX_TYPE
                      ,RSP.EXPECTED_TX_DATE AS RSP_TX_DATE
                      ,CASE WHEN XTX_TYPE = '4' THEN '定期定額'
                            WHEN XTX_TYPE = '5' THEN '定期不定額'
                            END AS RSP_CONTRACT_TYPE
                      ,FUND.NAME AS RSP_FUND_NAME
                      ,FUND_CRNCY.CURRENCY_NO AS RSP_FUND_CURRENCY_NO
                      ,FUND_CRNCY.NAME AS RSP_FUND_CURRENCY_NAME
                      ,RSP.AC_DAY AS RSP_AC_DAY
                      ,RSP.ID_SEQ AS RSP_SER_NO
                      ,RSP.AMOUNT AS RSP_AMOUNT
                      ,RSP_CRNCY.CURRENCY_NO AS RSP_CURRENCY_NO
                      ,RSP_CRNCY.NAME AS RSP_CURRENCY_NAME
                      ,RSP_CRNCY.AMT_DECIMAL AS RSP_CURRENCY_DECIMAL
                      ,RSP.SC_RATE AS RSP_SC_RATE
                      ,RSP.AC_NAME AS RSP_AC_NAME
                      ,BANK.NAME AS RSP_BANK_NAME
                      ,RSP.AC_CODE AS RSP_AC_CODE
                      ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS RSP_AC_CODE_5
                      ,ROUND(RSP.AMOUNT * RSP.SC_RATE/100,RSP_CRNCY.AMT_DECIMAL) AS RSP_SERVICE_CHARGE         --申購手續費
                      ,ROUND(RSP.AMOUNT + RSP.AMOUNT * RSP.SC_RATE / 100, RSP_CRNCY.AMT_DECIMAL) AS RSP_TOT_AMOUNT    --申購總金額
                      ,RSP.RAISE_ROI AS DRSP_RAISE_ROI   -- 定期不定額加碼點
                      ,ROUND(RSP.RAISE_AMOUNT, RSP_CRNCY.AMT_DECIMAL) AS DRSP_RAISE_AMOUNT -- 定期不定額加碼金額
                      ,RSP.REDUCE_ROI AS DRSP_REDUCE_ROI -- 定期不定額減碼點
                      ,ROUND(RSP.REDUCE_AMOUNT, RSP_CRNCY.AMT_DECIMAL) AS DRSP_REDUCE_AMOUNT -- 定期不定額減碼金額
                  FROM ECS.RSP RSP
                  LEFT JOIN FAS.FUND FUND
                    ON FUND.FUND_NO = RSP.FUND_NO
                  LEFT JOIN ECS.V_FUND_CRNCY FUND_CRNCY
                    ON FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
                  LEFT JOIN ECS.V_FUND_CRNCY RSP_CRNCY
                    ON RSP_CRNCY.CURRENCY_NO = RSP.CURRENCY_NO
                  LEFT JOIN FAS.FIS_BANK BANK
                    ON BANK.BANK_NO = RSP.BANK_NO
                 WHERE RSP.FUND_NO = XFUND_NO
                   AND RSP.PRODUCT_TYPE = XP_TYPE
                       -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
                   AND RSP.STATUS = XRSP_STATUS
                   AND RSP.ID = XID
                       -- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
                   AND RSP.ID_SEQ = TO_NUMBER(XSER_NO);

                -- 刪除 EC定額
                DELETE FROM ECS.RSP RSP
                 WHERE RSP.FUND_NO = XFUND_NO
                   AND RSP.PRODUCT_TYPE = XP_TYPE
                   -- 2018.08.15 JIANXIN 因應RSP狀態不同，新增變數處理
                   AND RSP.STATUS = XRSP_STATUS
                   AND RSP.ID = XID
                   -- 2018.08.17 JIANXIN 調整取消委託時，沒有刪除到(RSP、DRSP)正確的資料問題
                   AND RSP.ID_SEQ = TO_NUMBER(XSER_NO);

            END;
            END IF;
        END LOOP;

        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS
          FROM DUAL;

        OPEN OUTDT2 FOR
        SELECT  '' AS WARNS_TYPE
               ,'' AS ERROR_MSG
          FROM DUAL;

    END;
    ELSE
    BEGIN

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
          FROM DUAL;

        OPEN OUTDT2 FOR
        SELECT  '3' AS WARNS_TYPE
               ,'FUND_NO：'||SUBSTR(XERROR_MSG,0,LENGTH(XERROR_MSG)-1)||'不存在基金主檔中' AS ERROR_MSG
          FROM DUAL;     

    END;
    END IF;

END s_SaveCancelData;

/

  GRANT EXECUTE ON "ECS"."S_SAVECANCELDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVECANCELROBO
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVECANCELROBO" 
(

   WACCOUNT_NO       INTEGER,             -- 受益人戶號
   WROBO_CONTRACT_NO VARCHAR2,            -- ROBO 契約書號
   OUTDT             OUT SYS_REFCURSOR    -- 回傳資料
) IS

XID         VARCHAR2(10);   -- 受益人ID
XSYS_DTTM   DATE:= SYSDATE; -- 系統日期時間
XIS_SUCCESS VARCHAR2(1);    -- 取得資料成功否
XWARNS_TYPE VARCHAR2(1);    -- 警示方式
XERROR_MSG  VARCHAR2(250);  -- 錯誤訊息
XCHECK      INTEGER;        -- 檢查ROBO契約書號是否存在
XSER_NO     VARCHAR2(4);

BEGIN

  -- 取得受益人ID
  BEGIN

    SELECT ID INTO XID
      FROM FAS.HOLDER
     WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

  END;

  -- 檢查是否有做過取消
  BEGIN

    SELECT COUNT(*)
      INTO XCHECK
      FROM ECS.ROBO_DISMISSAL
     WHERE ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

    IF XCHECK > 0 THEN

      XIS_SUCCESS := 'N';

      --ROB004：Robo 契約 取消重複，儲存失敗
      SELECT MSGTYPE, MSGCONTENT
        INTO XWARNS_TYPE, XERROR_MSG
        FROM ECS.MSGINFO
       WHERE MSGID = 'ROB004';

      GOTO TO_END;   

    END IF;        

  END;

  -- 檢查是否有此書號之憑證
  BEGIN

    SELECT COUNT(*)
      INTO XCHECK
      FROM FAS.CERTIFICATE
     WHERE ROBO_CONTRACT_NO = WROBO_CONTRACT_NO
       AND ID = XID
       AND STATUS = '8';    --8:鎖定

	-- 2018.11.28 JIANXIN MOD BY 調整ROBO 契約書號判斷
    IF XCHECK = 0 THEN

      XIS_SUCCESS := 'N';

      --ROB009：ROBO契約書號不可重複
      SELECT MSGTYPE, MSGCONTENT
        INTO XWARNS_TYPE, XERROR_MSG
        FROM ECS.MSGINFO
       WHERE MSGID = 'ROB009';

      GOTO TO_END;   

    END IF;        

  END;

  -- 若『資料檢核成功否(@IS_CHK_SUCCESS)』為”Y.成功”時，
  -- 新增一筆資料至【Robo契約解約資料(ECS.ROBO_DISMISSAL)】檔  
  -- 2018.07.15 JIANXIN 儲存Robo 取消契約欄位調整
  INSERT INTO ECS.ROBO_DISMISSAL
       (
            ID                    -- 受益人ID
           ,ROBO_CONTRACT_NO      -- ROBO契約書號
           ,CANCEL_DATE           -- 取消日期
           ,FAS_STATUS            -- FAS系統處理狀態\N：未處理；Y：已處理
           ,SER_NO                -- FAS處理序號\FAS處理完成後填入
           ,REVISED_BY            -- FAS系統處理人員
           ,REVISION_DATE         -- FAS系統處理日期
           ,CREATED_BY            -- 建檔人員
           ,CREATION_DATE         -- 建檔日期
       )
       VALUES
       (
            XID
           ,WROBO_CONTRACT_NO
           ,XSYS_DTTM
           ,'N'
           ,XSER_NO
           ,NULL
           ,NULL
           ,'ECS'
           ,XSYS_DTTM
       );

  XIS_SUCCESS := 'Y';
  XWARNS_TYPE := NULL;
  XERROR_MSG  := NULL;

  GOTO TO_END;

  <<TO_END>>
  OPEN OUTDT FOR
       SELECT XIS_SUCCESS  AS IS_SUCCESS  --資料寫入成功否
              ,XWARNS_TYPE AS WARNS_TYPE  --警示方式
              ,XERROR_MSG  AS ERROR_MSG   --錯誤訊息
         FROM DUAL;

END s_SaveCancelRobo;

/

  GRANT EXECUTE ON "ECS"."S_SAVECANCELROBO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVEDIVIDENDACCLIST
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVEDIVIDENDACCLIST" 
(
    WACCOUNT_NO          INTEGER,           -- 受益人戶號
    WDIV_AMC_NO          VARCHAR2,          -- 基金公司代碼(配息帳號)
    WDIV_BANK_NO         VARCHAR2,          -- 扣款總行代碼(配息帳號)
    WDIV_BRANCH_NO       VARCHAR2,          -- 扣款分行代碼(配息帳號)
    WDIV_FIS_SNAME       VARCHAR2,          -- 扣款銀行簡稱(配息帳號)
    WDIV_AC_CODE         VARCHAR2,          -- 扣款帳號(配息帳號)
    WDIV_AC_NAME         VARCHAR2,          -- 扣款帳號戶名(配息帳號)
    WDIV_CRNCY_NO        VARCHAR2,          -- 扣款帳戶幣別(配息帳號)
    WTRADE_TYPE          VARCHAR2           --交易類別(1.申購 2.轉申購)
) IS

XID         VARCHAR2(10);   --受益人ID
XCHECK      INTEGER;        --檢查是否有資料
XSYS_DTTM   DATE:=SYSDATE;  --系統日期時間

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  SELECT COUNT(*) INTO XCHECK
    FROM FAS.HOLDER_DIVIDEND
    WHERE ID = XID;

  --無資料時，將資料寫入至【受益人配息設定(FAS.HOLDER_DIVIDEND)】及【受益人配息設定變更(FAS.HOLDER_DIVIDEND_CHANGE)】檔
  IF XCHECK = 0 THEN

    INSERT INTO FAS.HOLDER_DIVIDEND
           (ID                  --受益人ID
           ,CREATED_BY          --建立人員
           ,CREATION_DATE       --建立日期
           ,REVISED_BY          --修改人員
           ,REVISION_DATE       --修改日期
           ,REVIEWED_BY         --覆核人員
           ,REVIEW_DATE         --覆核日期
           ,STATUS              --狀態('R'覆核確認)
           )
    SELECT XID
           ,'ECS'
           ,XSYS_DTTM
           ,'ECS'
           ,XSYS_DTTM
           ,'ECS'
           ,XSYS_DTTM
           ,'R'
      FROM DUAL;

    INSERT INTO FAS.HOLDER_DIVIDEND_CHANGE
           (ID                  --受益人ID
           ,CREATED_BY          --建立人員
           ,CREATION_DATE       --建立日期
           ,REVISED_BY          --修改人員
           ,REVISION_DATE       --修改日期
           ,REVIEWED_BY         --覆核人員
           ,REVIEW_DATE         --覆核日期
           ,STATUS              --狀態('R'覆核確認)
           )
    SELECT XID
           ,'ECS'
           ,XSYS_DTTM
           ,'ECS'
           ,XSYS_DTTM
           ,'ECS'
           ,XSYS_DTTM
           ,'R'
      FROM DUAL;

 END IF;

  SELECT COUNT(*) INTO XCHECK
    FROM FAS.HOLDER_DIVIDEND_AMC
    WHERE ID = XID
      AND HOLDER_DIVIDEND_AMC.AMC_NO = WDIV_AMC_NO;

  --無資料時，將資料寫入至【基金公司配息設定(FAS.HOLDER_DIVIDEND_AMC)】及【基金公司配息設定變更(FAS.HOLDER_DIVIDEND_AMC_CHANGE)】檔
  IF XCHECK = 0 THEN

    INSERT INTO FAS.HOLDER_DIVIDEND_AMC
           (ID                  --ID
           ,AMC_NO              --基金經理公司
           ,PAY_TYPE            --付款方式 1：郵寄支票；2：轉申購3：匯款；4：匯款 (不受最低金額限制)
           ,FUND_NO_IN          --轉申購基金
           ,PAY_ADDRESS         --郵寄支票地址
           ,OMIT                --缺件註記 (Y,N)
           )
    SELECT XID
           ,AMC_NO
           ,CASE WHEN DEPOSITORY_NO = '01' THEN '3'
                 WHEN DEPOSITORY_NO = '04' THEN '4'
           END PAY_TYPE
           ,NULL
           ,NULL
           ,'N'
      FROM FAS.AMC
      WHERE AMC.AMC_NO = WDIV_AMC_NO;

    INSERT INTO FAS.HOLDER_DIVIDEND_AMC_CHANGE
           (ID                  --ID
           ,AMC_NO              --基金經理公司
           ,PAY_TYPE            --付款方式 1：郵寄支票；2：轉申購3：匯款；4：匯款 (不受最低金額限制)
           ,FUND_NO_IN          --轉申購基金
           ,PAY_ADDRESS         --郵寄支票地址
           ,OMIT                --缺件註記 (Y,N)
           ,REVISED_BY          --修改人員
           ,REVISION_DATE       --修改日期
           )
    SELECT XID
           ,AMC_NO
           ,CASE WHEN DEPOSITORY_NO = '01' THEN '3'
                 WHEN DEPOSITORY_NO = '04' THEN '4'
           END PAY_TYPE
           ,NULL
           ,NULL
           ,'N'
           ,'ECS'
           ,XSYS_DTTM
      FROM FAS.AMC
      WHERE AMC.AMC_NO = WDIV_AMC_NO;

 END IF;

  SELECT COUNT(*) INTO XCHECK
    FROM FAS.HOLDER_DIVIDEND_BANK
    WHERE HOLDER_DIVIDEND_BANK.ID = XID
      AND HOLDER_DIVIDEND_BANK.BANK_NO = WDIV_BANK_NO
      AND HOLDER_DIVIDEND_BANK.AC_CODE = WDIV_AC_CODE
      AND HOLDER_DIVIDEND_BANK.AMC_NO = WDIV_AMC_NO;

  --無資料時，將傳入參數資料寫入【受益人配息帳號(FAS.HOLDER_DIVIDEND_BANK)】及【受益人配息帳號變更(FAS.HOLDER_DIVIDEND_BANK_CHANGE)】檔
  IF XCHECK = 0 THEN

    INSERT INTO FAS.HOLDER_DIVIDEND_BANK
           (ID              	    --受益人ID
           ,BANK_NO               --往來銀行
           ,BRANCH_NO             --往來分行
           ,AC_CODE               --往來帳號
           ,AC_NAME               --帳號名稱     
           ,FIS_SNAME             --往來銀行簡稱
           ,ONSHORE               --境內基金適用(Y,N)
           ,OFFSHORE              --境外基金適用(Y,N)
           ,CURRENCY_NO           --幣別
           ,ENAME                 --英文戶名
           ,IBAN_CODE             --IBAN
           ,REMARK                --附言欄
           ,AMC_NO                --基金經理公司
           )
    SELECT XID
           ,WDIV_BANK_NO
           ,WDIV_BRANCH_NO
           ,WDIV_AC_CODE
           ,WDIV_AC_NAME
           ,WDIV_FIS_SNAME
           ,CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'Y'
                 WHEN AMC.FUND_CATEGORY = '2' THEN 'N'
           END ONSHORE
           ,CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'N'
                 WHEN AMC.FUND_CATEGORY = '2' THEN 'Y'
           END OFFSHORE
           ,WDIV_CRNCY_NO
           ,NULL
           ,NULL
           ,NULL
           ,AMC.AMC_NO
      FROM FAS.AMC
      WHERE AMC.AMC_NO = WDIV_AMC_NO;

    INSERT INTO FAS.HOLDER_DIVIDEND_BANK_CHANGE
           (ID              	    --受益人ID
           ,BANK_NO               --往來銀行
           ,BRANCH_NO             --往來分行
           ,AC_CODE               --往來帳號
           ,AC_NAME               --帳號名稱     
           ,FIS_SNAME             --往來銀行簡稱
           ,ONSHORE               --境內基金適用(Y,N)
           ,OFFSHORE              --境外基金適用(Y,N)
           ,CURRENCY_NO           --幣別
           ,ENAME                 --英文戶名
           ,IBAN_CODE             --IBAN
           ,REMARK                --附言欄
           ,REVISED_BY            --修改人員
           ,REVISION_DATE         --修改日期
           ,REMARK1               --變更備註
           ,AMC_NO                --基金經理公司
           )
    SELECT XID
           ,WDIV_BANK_NO
           ,WDIV_BRANCH_NO
           ,WDIV_AC_CODE
           ,WDIV_AC_NAME
           ,WDIV_FIS_SNAME
           ,CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'Y'
                 WHEN AMC.FUND_CATEGORY = '2' THEN 'N'
           END ONSHORE
           ,CASE WHEN AMC.FUND_CATEGORY = '1' THEN 'N'
                 WHEN AMC.FUND_CATEGORY = '2' THEN 'Y'
           END OFFSHORE
           ,WDIV_CRNCY_NO
           ,NULL
           ,NULL
           ,NULL
           ,'ECS'
           ,XSYS_DTTM
           ,CASE WHEN AMC.FUND_CATEGORY = '1' AND WTRADE_TYPE = '1' THEN '境內網路申購交易，約定收益分配帳號'
                 WHEN AMC.FUND_CATEGORY = '2' AND WTRADE_TYPE = '1' THEN '境外網路申購交易，約定收益分配帳號'
                 WHEN AMC.FUND_CATEGORY = '1' AND WTRADE_TYPE = '2' THEN '境內網路轉申購交易，約定收益分配帳號'
                 WHEN AMC.FUND_CATEGORY = '2' AND WTRADE_TYPE = '2' THEN '境外網路轉申購交易，約定收益分配帳號'
           END REMARK1
           ,AMC.AMC_NO
      FROM FAS.AMC
      WHERE AMC.AMC_NO = WDIV_AMC_NO;

  END IF;


END s_SaveDividendAccList;

/

  GRANT EXECUTE ON "ECS"."S_SAVEDIVIDENDACCLIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVELOSSANDGAINSETUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVELOSSANDGAINSETUP" 
(
    WACCOUNT_NO        INTEGER,                   -- 受益人戶號
    WACTION_TYPE       VARCHAR2,                  -- 交易類別
    WFUND_NO           VARCHAR2,                  -- 基金代碼
    WISIN_CODE         VARCHAR2,                  -- 國際證券代碼
    WALERT_PRU         VARCHAR2,                  -- 到價提示單位
    WUPPER_LIMIT       INTEGER,                   -- 警示條件 - 報酬率停利(%)
    WLOWER_LIMIT       INTEGER,                   -- 警示條件 - 報酬率停損(%)
    WBUY_IN            DECIMAL,                   -- 警示條件 – 淨值停利價位
    WSELL_OUT          DECIMAL,                   -- 警示條件 – 淨值停損價位
    WALERT_TYPE_WEB    VARCHAR2,                  -- 通知方式(網頁)
    WALERT_FREQ_WEB    VARCHAR2,                  -- 通知方式(網頁) - 通知頻率
    WALERT_TYPE_EMAIL  VARCHAR2,                  -- 通知方式(信件)
    WALERT_FREQ_EMAIL  VARCHAR2,                  -- 通知方式(信件) - 通知頻率
    OUTDT              OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

XID      VARCHAR2(10);     	     --受益人ID
XFUND_NO VARCHAR2(5);            --基金代碼
XCOUNT   INTEGER;                --資料筆數

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  --取得基金代碼
  IF WFUND_NO IS NOT NULL THEN

    XFUND_NO := WFUND_NO;

  ELSIF WFUND_NO IS NULL AND WISIN_CODE IS NOT NULL THEN

    BEGIN

      SELECT FUND_NO
          INTO XFUND_NO
          FROM FAS.FUND
         WHERE ISIN_CODE = WISIN_CODE;

      EXCEPTION
        WHEN NO_DATA_FOUND THEN
          RAISE_APPLICATION_ERROR(-20000,
                                  WISIN_CODE || '無法取得基金代碼，請檢查！');

   END;

  END IF;

  --交易類別為新增時
  IF WACTION_TYPE = '1' THEN

    -- 2018.10.08 ChengYu 檢查資料是否重複 BEGIN
    SELECT COUNT(1)
      INTO XCOUNT
      FROM WPS.FUND_ALERT
     WHERE FUND_ALERT.ID = XID
       AND FUND_ALERT.FUND_NO = XFUND_NO
       AND FUND_ALERT.TYPE = '0';

    IF XCOUNT > 0 THEN

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO_T015.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T015.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T015
         WHERE MSGINFO_T015.MSGID = 'T015';

        RETURN;

    END IF;
    -- 2018.10.08 ChengYu 檢查資料是否重複 END

    --資料寫入【停損停利到價通知(WPS.FUND_ALERT)】
    INSERT INTO WPS.FUND_ALERT
      (ID           --受益人ID
      ,FUND_NO      --基金編號
      ,TYPE         --類別 0.我的投資組合；1.我的基金觀察
      ,ALERT_PRU    --到價提示單位 1.淨值 2.報酬率
      ,UPPER_LIMIT  --停利(%)
      ,LOWER_LIMIT  --停損(%)
      ,BUY_IN       --買進價位
      ,SELL_OUT     --賣出價位
      ,ALERT        --警示設定 Y.啟動通知；N.關閉通知
      )
      VALUES
      (XID
      ,XFUND_NO
      ,'0'
      ,WALERT_PRU
      ,WUPPER_LIMIT
      ,WLOWER_LIMIT
      ,WBUY_IN
      ,WSELL_OUT
      ,'Y'
      );

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_WEB)』為Ｙ時，則新增一筆資料
    IF WALERT_TYPE_WEB = 'Y' THEN

      -- 2018.10.08 ChengYu 檢查資料是否重複 BEGIN
      SELECT COUNT(1) AS COUNT
        INTO XCOUNT
        FROM WPS.FUND_ALERT_TYPE
       WHERE FUND_ALERT_TYPE.ID = XID
         AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
         AND FUND_ALERT_TYPE.TYPE = '0'
         AND FUND_ALERT_TYPE.ALERT_TYPE = '1';

      IF XCOUNT > 0 THEN 

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO_T013.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T013.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T013
         WHERE MSGINFO_T013.MSGID = 'T013';

        RETURN;

      END IF;
      -- 2018.10.08 ChengYu 檢查資料是否重複 END

      INSERT INTO WPS.FUND_ALERT_TYPE
        (ID           --受益人ID
        ,FUND_NO      --基金編號
        ,TYPE         --類別 0.我的投資組合；1.我的基金觀察
        ,ALERT_TYPE   --通知方式 1. 網頁通知；2. EMail通知
        ,ALERT_FREQ   --通知頻率 1. 通知我一次；E. 每次通知我
        ,ALERTED      --已通知 0. 未通知；1.已通知
        )
        VALUES
        (XID
        ,XFUND_NO
        ,'0'
        ,'1'
        ,WALERT_FREQ_WEB
        ,'0'
        );

    END IF;

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_EMAIL)』為Ｙ時，則新增一筆資料
    IF WALERT_TYPE_EMAIL = 'Y' THEN

      -- 2018.10.08 ChengYu 檢查資料是否重複 BEGIN
      SELECT COUNT(1) AS COUNT
        INTO XCOUNT
        FROM WPS.FUND_ALERT_TYPE
       WHERE FUND_ALERT_TYPE.ID = XID
         AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
         AND FUND_ALERT_TYPE.TYPE = '0'
         AND FUND_ALERT_TYPE.ALERT_TYPE = '2';

      IF XCOUNT > 0 THEN 

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO_T013.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T013.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T013
         WHERE MSGINFO_T013.MSGID = 'T013';

        RETURN;

      END IF;
      -- 2018.10.08 ChengYu 檢查資料是否重複 END

      INSERT INTO WPS.FUND_ALERT_TYPE
        (ID           --受益人ID
        ,FUND_NO      --基金編號
        ,TYPE         --類別 0.我的投資組合；1.我的基金觀察
        ,ALERT_TYPE   --通知方式 1. 網頁通知；2. EMail通知
        ,ALERT_FREQ   --通知頻率 1. 通知我一次；E. 每次通知我
        ,ALERTED      --已通知 0. 未通知；1.已通知
        )
        VALUES
        (XID
        ,XFUND_NO
        ,'0'
        ,'2'
        ,WALERT_FREQ_EMAIL
        ,'0'
        );

    END IF;

  END IF;

  --交易類別為修改時
  IF WACTION_TYPE = '2' THEN

    --停損停利到價通知(WPS.FUND_ALERT)
    UPDATE WPS.FUND_ALERT
       SET ALERT_PRU = WALERT_PRU
           ,UPPER_LIMIT = WUPPER_LIMIT
           ,LOWER_LIMIT = WLOWER_LIMIT
           ,BUY_IN = WBUY_IN
           ,SELL_OUT = WSELL_OUT
           ,ALERT = 'Y'
      WHERE FUND_ALERT.ID = XID
      	AND FUND_ALERT.FUND_NO = XFUND_NO
        AND FUND_ALERT.TYPE = '0';

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_WEB)』為Y時    
    IF WALERT_TYPE_WEB = 'Y' THEN

      --更新基金到價及停損停利設定(WPS.FUND_ALERT_TYPE)
      UPDATE WPS.FUND_ALERT_TYPE
         SET ALERT_FREQ = WALERT_FREQ_WEB
             ,ALERTED = '0'
        WHERE FUND_ALERT_TYPE.ID = XID
          AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
          AND FUND_ALERT_TYPE.TYPE = '0'
          AND FUND_ALERT_TYPE.ALERT_TYPE = '1';

    END IF;

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_EMAIL)』為Y時    
    IF WALERT_TYPE_EMAIL = 'Y' THEN

      --更新基金到價及停損停利設定(WPS.FUND_ALERT_TYPE)
      UPDATE WPS.FUND_ALERT_TYPE
         SET ALERT_FREQ = WALERT_FREQ_EMAIL
             ,ALERTED = '0'
        WHERE FUND_ALERT_TYPE.ID = XID
          AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
          AND FUND_ALERT_TYPE.TYPE = '0'
          AND FUND_ALERT_TYPE.ALERT_TYPE = '2';

    END IF;

  END IF;

  --交易類別為刪除時
  IF WACTION_TYPE = '3' THEN

    DELETE FROM WPS.FUND_ALERT 
     WHERE FUND_ALERT.ID = XID 
       AND FUND_ALERT.FUND_NO = XFUND_NO 
       AND FUND_ALERT.TYPE = '0';

    DELETE FROM WPS.FUND_ALERT_TYPE 
     WHERE FUND_ALERT_TYPE.ID = XID
       AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO 
       AND FUND_ALERT_TYPE.TYPE = '0';

  END IF;

  OPEN OUTDT FOR
  SELECT 'Y' AS IS_SUCCESS
         ,'' AS WARNS_TYPE
         ,'' AS ERROR_MSG
    FROM DUAL;

END s_SaveLossAndGainSetup;

/

  GRANT EXECUTE ON "ECS"."S_SAVELOSSANDGAINSETUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVEOBSERVATIONLGSETUP
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVEOBSERVATIONLGSETUP" 
(
    WACCOUNT_NO        INTEGER,                   -- 受益人戶號
    WACTION_TYPE       VARCHAR2,                  -- 交易類別
    WFUND_NO           VARCHAR2,                  -- 基金代碼
    WISIN_CODE         VARCHAR2,                  -- 國際證券代碼
    WBUY_IN            DECIMAL,                   -- 警示條件 – 淨值停利價位
    WSELL_OUT          DECIMAL,                   -- 警示條件 – 淨值停損價位
    WALERT_TYPE_WEB    VARCHAR2,                  -- 通知方式(網頁)
    WALERT_FREQ_WEB    VARCHAR2,                  -- 通知方式(網頁) - 通知頻率
    WALERT_TYPE_EMAIL  VARCHAR2,                  -- 通知方式(信件)
    WALERT_FREQ_EMAIL  VARCHAR2,                  -- 通知方式(信件) - 通知頻率
    OUTDT              OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

XID      VARCHAR2(10);           --受益人ID
XFUND_NO VARCHAR2(5);            --基金代碼
XCOUNT   INTEGER;                --資料筆數

BEGIN

  --取得受益人ID
  BEGIN

    SELECT ID INTO XID
       FROM FAS.HOLDER
       WHERE ACCOUNT_NO = WACCOUNT_NO;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        RAISE_APPLICATION_ERROR(-20000,
                                '無法取得受益人ID，請檢查！');

  END;

  --取得基金代碼
  -- 2018.05.31 ChengYu 基金代碼、國際證券代碼必須對應到基金主檔中的基金代碼才可使用 BEGIN
  BEGIN
    SELECT FUND.FUND_NO
      INTO XFUND_NO
      FROM FAS.FUND FUND
     WHERE FUND.FUND_NO = WFUND_NO;

    EXCEPTION
         WHEN NO_DATA_FOUND THEN
         BEGIN          
           SELECT FUND.FUND_NO
             INTO XFUND_NO
             FROM FAS.FUND FUND
            WHERE FUND.ISIN_CODE = WISIN_CODE;

           EXCEPTION
                WHEN NO_DATA_FOUND THEN
                BEGIN
                  RAISE_APPLICATION_ERROR(-20000,
                                  'FUND_NO：'||WFUND_NO||',ISIN_CODE：'||WISIN_CODE|| ' 無法取得基金代碼，請檢查！');
                END;
         END;
  END;
  -- 2018.05.31 ChengYu 基金代碼、國際證券代碼必須對應到基金主檔中的基金代碼才可使用 END

  --交易類別為新增時
  IF WACTION_TYPE = '1' THEN

    --停損停利到價通知(WPS.FUND_ALERT)
    UPDATE WPS.FUND_ALERT
       SET ALERT_PRU = '1'
           ,UPPER_LIMIT = NULL
           ,LOWER_LIMIT = NULL
           ,BUY_IN = WBUY_IN
           ,SELL_OUT = WSELL_OUT
           ,ALERT = 'Y'
      WHERE FUND_ALERT.ID = XID
        AND FUND_ALERT.FUND_NO = XFUND_NO
        AND FUND_ALERT.TYPE = '1';

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_WEB)』為Ｙ時，則新增一筆資料
    IF WALERT_TYPE_WEB = 'Y' THEN

      --2018.10.05 ChengYu 檢查WPS.FUND_ALERT_TYPE(基金到價及停損停利設定)是否已經有資料 BEGIN
      SELECT COUNT(1) AS COUNT
        INTO XCOUNT
        FROM WPS.FUND_ALERT_TYPE
       WHERE FUND_ALERT_TYPE.ID = XID
         AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
         AND FUND_ALERT_TYPE.TYPE = '1'
         AND FUND_ALERT_TYPE.ALERT_TYPE = '1';

      IF XCOUNT > 0 THEN 

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO_T013.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T013.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T013
         WHERE MSGINFO_T013.MSGID = 'T013';

        RETURN;

      END IF;

      -- 2018.05.31 ChengYu 基金代碼、國際證券代碼必須對應到基金主檔中的基金代碼才可使用 END

      INSERT INTO WPS.FUND_ALERT_TYPE
        (ID           --受益人ID
        ,FUND_NO      --基金編號
        ,TYPE         --類別 0.我的投資組合；1.我的基金觀察
        ,ALERT_TYPE   --通知方式 1. 網頁通知；2. EMail通知
        ,ALERT_FREQ   --通知頻率 1. 通知我一次；E. 每次通知我
        ,ALERTED      --已通知 0. 未通知；1.已通知
        )
        VALUES
        (XID
        ,XFUND_NO
        ,'1'
        ,'1'
        ,WALERT_FREQ_WEB
        ,'0'
        );

    END IF;

    --傳入參數『通知方式(信件) (@ALERT_TYPE_EMAIL)』為Ｙ時，則新增一筆資料
    IF WALERT_TYPE_EMAIL = 'Y' THEN

      --2018.10.05 ChengYu 檢查WPS.FUND_ALERT_TYPE(基金到價及停損停利設定)是否已經有資料 BEGIN

      SELECT COUNT(1) AS COUNT
        INTO XCOUNT
        FROM WPS.FUND_ALERT_TYPE
       WHERE FUND_ALERT_TYPE.ID = XID
         AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
         AND FUND_ALERT_TYPE.TYPE = '1'
         AND FUND_ALERT_TYPE.ALERT_TYPE = '2';

      IF XCOUNT > 0 THEN 

        OPEN OUTDT FOR
        SELECT  'N' AS IS_SUCCESS
               ,MSGINFO_T013.MSGTYPE AS WARNS_TYPE
               ,MSGINFO_T013.MSGCONTENT AS ERROR_MSG
          FROM ECS.MSGINFO MSGINFO_T013
         WHERE MSGINFO_T013.MSGID = 'T013';

        RETURN;

      END IF;

      --2018.10.05 ChengYu 檢查WPS.FUND_ALERT_TYPE(基金到價及停損停利設定)是否已經有資料 BEGIN

      INSERT INTO WPS.FUND_ALERT_TYPE
        (ID           --受益人ID
        ,FUND_NO      --基金編號
        ,TYPE         --類別 0.我的投資組合；1.我的基金觀察
        ,ALERT_TYPE   --通知方式 1. 網頁通知；2. EMail通知
        ,ALERT_FREQ   --通知頻率 1. 通知我一次；E. 每次通知我
        ,ALERTED      --已通知 0. 未通知；1.已通知
        )
        VALUES
        (XID
        ,XFUND_NO
        ,'1'
        ,'2'
        ,WALERT_FREQ_EMAIL
        ,'0'
        );

    END IF;

  END IF;

  --交易類別為修改時
  IF WACTION_TYPE = '2' THEN

    --停損停利到價通知(WPS.FUND_ALERT)
    UPDATE WPS.FUND_ALERT
       SET ALERT_PRU = '1'
           ,UPPER_LIMIT = NULL
           ,LOWER_LIMIT = NULL
           ,BUY_IN = WBUY_IN
           ,SELL_OUT = WSELL_OUT
           ,ALERT = 'Y'
      WHERE FUND_ALERT.ID = XID
        AND FUND_ALERT.FUND_NO = XFUND_NO
        AND FUND_ALERT.TYPE = '1';

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_WEB)』為Y時    
    IF WALERT_TYPE_WEB = 'Y' THEN

      --更新基金到價及停損停利設定(WPS.FUND_ALERT_TYPE)
      UPDATE WPS.FUND_ALERT_TYPE
         SET ALERT_FREQ = WALERT_FREQ_WEB
             ,ALERTED = '0'
        WHERE FUND_ALERT_TYPE.ID = XID
          AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
          AND FUND_ALERT_TYPE.TYPE = '1'
          AND FUND_ALERT_TYPE.ALERT_TYPE = '1';

    END IF;

    --傳入參數『通知方式(網頁) (@ALERT_TYPE_EMAIL)』為Y時    
    IF WALERT_TYPE_EMAIL = 'Y' THEN

      --更新基金到價及停損停利設定(WPS.FUND_ALERT_TYPE)
      UPDATE WPS.FUND_ALERT_TYPE
         SET ALERT_FREQ = WALERT_FREQ_EMAIL
             ,ALERTED = '0'
        WHERE FUND_ALERT_TYPE.ID = XID
          AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO
          AND FUND_ALERT_TYPE.TYPE = '1'
          AND FUND_ALERT_TYPE.ALERT_TYPE = '2';

    END IF;

  END IF;

  --交易類別為刪除時
  IF WACTION_TYPE = '3' THEN

    UPDATE WPS.FUND_ALERT
       SET ALERT_PRU = NULL
           ,UPPER_LIMIT = NULL
           ,LOWER_LIMIT = NULL
           ,BUY_IN = NULL
           ,SELL_OUT = NULL
           ,ALERT = NULL
      WHERE FUND_ALERT.ID = XID
        AND FUND_ALERT.FUND_NO = XFUND_NO
        AND FUND_ALERT.TYPE = '1';

    DELETE FROM WPS.FUND_ALERT_TYPE 
     WHERE FUND_ALERT_TYPE.ID = XID
       AND FUND_ALERT_TYPE.FUND_NO = XFUND_NO 
       AND FUND_ALERT_TYPE.TYPE = '1';

  END IF;

  OPEN OUTDT FOR
  SELECT 'Y' AS IS_SUCCESS
         ,'' AS WARNS_TYPE
         ,'' AS ERROR_MSG
    FROM DUAL;

END s_SaveObservationLGSetup;

/

  GRANT EXECUTE ON "ECS"."S_SAVEOBSERVATIONLGSETUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVEREDEMDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVEREDEMDATA" 
-- =============================================
-- Author:      Joseph
-- Create date: 2018/03/19
-- Description: 儲存買回委託交易資料
-- 2018.03.20 MOD BY JIM 修改SP的寫法
-- 2018.03.29 MOD BY JIM 補傳入ISIN_CODE的邏輯 
-- 2018.03.31 MOD BY JIM 修改日期格式
-- 2018.04.19 MOD BY JIM 調整轉申購手續費率
-- 2018.05.10 MOD BY JIM 新增ROBO_BATCH_NO參數，但是因為TABLE架構還沒改，所以還沒INSERT
-- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
-- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
-- =============================================
(      WACCOUNT_NO        IN INTEGER,   -- 受益人戶號
       WIP_ADR            IN VARCHAR2,  -- IP 位置
       WROBO_CONTRACT_NO  IN VARCHAR2,  -- ROBO 契約編號
       WROBO_SER_NO       IN VARCHAR2,  -- ROBO交易書號
       -- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
       WROBO_BATCH_NO     IN VARCHAR2,  -- ROBO再平衡批次編號
       WISIN_CODE         IN VARCHAR2,  -- 國際證券代碼
       WFUND_NO           IN VARCHAR2,  -- 基金代碼
       WTRADE_CRNCY       IN VARCHAR2,  -- 申購幣別
       WTX_DATE           IN DATE,      -- 買回交易日期
       WREDEMPTION_TYPE   IN VARCHAR2,  -- 買回方式
       WAPPLICATION_SHARE IN NUMBER,    -- 買回單位數
       WAC_DATE           IN DATE,      -- 買回計算淨值日期
       WPAY_DATE          IN DATE,      -- 預計買回入帳日期
       WBANK_NO           IN VARCHAR2,  -- 往來總行代碼
       WBRANCH_NO         IN VARCHAR2,  -- 往來分行代碼
       WFIS_SNAME         IN VARCHAR2,  -- 往來銀行簡稱
       WAC_CODE           IN VARCHAR2,  -- 往來帳號
       WAC_NAME           IN VARCHAR2,  -- 帳號戶名
       WCURRENCY_NO       IN VARCHAR2,  -- 往來帳戶幣別
       OUTDT              OUT SYS_REFCURSOR -- 回傳資料
) IS

XFUND_NO   VARCHAR2(5);    --基金代碼
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
XSER_NO    VARCHAR2(4);    -- 交易序號
XYEAR      NUMBER(4);      -- 取號需要用的年份
XID        VARCHAR2(10);   -- 身份證號

XIP_A      VARCHAR2(3);    -- IP 第一區段
XIP_B      VARCHAR2(3);    -- IP 第二區段
XIP_C      VARCHAR2(3);    -- IP 第三區段
XIP_D      VARCHAR2(3);    -- IP 第四區段

XBROKER_NO VARCHAR2(3) := '999';
XBRANCH_NO VARCHAR2(4);
XTX_DATE   DATE:= TRUNC(WTX_DATE);  --交易日(格式改為日期YYYY/MM/DD)
-- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
XTRADE_TYPE VARCHAR2(1) := '2';     --交易種類(1.申購 2:贖回)

BEGIN

  --2018.03.29 Jim 補ISIN_CODE邏輯
  --取得FUND_NO
  IF WFUND_NO IS NOT NULL THEN

    XFUND_NO := WFUND_NO;

  ELSIF WFUND_NO IS NULL AND WISIN_CODE IS NOT NULL THEN

    SELECT FUND_NO
        INTO XFUND_NO
        FROM FAS.FUND
       WHERE ISIN_CODE = WISIN_CODE;

  END IF;

  -- 取號：年份
  XYEAR := EXTRACT(YEAR FROM WTX_DATE);

  BEGIN
  -- 取得身份證號
  SELECT ID INTO XID 
    FROM FAS.HOLDER WHERE ACCOUNT_NO = WACCOUNT_NO;

  EXCEPTION

    WHEN NO_DATA_FOUND THEN
      RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
  END;

  --代銷分公司碼
  IF WROBO_CONTRACT_NO IS NULL THEN

    XBRANCH_NO := '8000';

  ELSE

    XBRANCH_NO :='8800';

  END IF;

  -- 取得交易序號
  -- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
  XSER_NO := ECS.F_GETTXNO(XYEAR, XBROKER_NO, XBRANCH_NO, XFUND_NO, XTRADE_TYPE);

  -- 拆解 ip address
  XIP_A := SUBSTR(WIP_ADR, 1, INSTR(WIP_ADR, '.', 1, 1) - 1);
  XIP_B := SUBSTR(WIP_ADR,
                  INSTR(WIP_ADR, '.', 1, 1) + 1,
                  INSTR(WIP_ADR, '.', 1, 2) - INSTR(WIP_ADR, '.', 1, 1) - 1);
  XIP_C := SUBSTR(WIP_ADR,
                  INSTR(WIP_ADR, '.', 1, 2) + 1,
                  INSTR(WIP_ADR, '.', 1, 3) - INSTR(WIP_ADR, '.', 1, 2) - 1);
  XIP_D := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 3) + 1, 4);

  -- todo : 未檢核交易日是否為營業日的問題

  BEGIN

    -- 寫入贖回檔
    INSERT INTO ECS.REDEMPTION
      (FUND_NO                --基金別
      ,ID                     --ID
      ,TX_DATE                --交易日期
      ,BROKER_NO              --代銷單位
      ,BRANCH_NO              --代銷分公司碼

      ,SER_NO                 --交易序號
      ,REDEMPTION_TYPE        --買回方式(W:全贖/S:部份)
      ,APPLICATION_SHARE      --買回單位數
      ,AC_BANK                --買回銀行
      ,AC_BRANCH              --買回分行

      ,AC_FIS_SNAME           --買回銀行簡稱
      ,AC_CODE                --買回帳號
      ,FUND_NO_IN             --轉申購基金別
      ,REVISION_DATE          --修改日期(含時分秒)
      ,IS_EMAIL               --是否已emal(N:尚未寄出/Y: 已寄出)

      ,STATUS                 --交易狀態(O: 委託中/C:已確認/P:已結帳)
      ,RESULT_CODE            --交易結果(00:成功/01:失敗)
      ,AC_NAME                --戶名
      ,AC_DATE                --淨值日
      ,CURRENCY_NO            --幣別

      ,BANK_CURRENCY_NO       --銀行幣別
      ,PROSPECTUS             --公開說明書
      ,IP_A                   --IP A
      ,IP_B                   --IP B
      ,IP_C                   --IP C

      ,IP_D                   --IP D
      ,INVESTMENT_RISK        --投資風險評估
      ,CHANNEL_EXPOSE         --通路報酬揭露
      ,ONSHORE_SHORT_TRADE    --境內短線交易(Y/N)
      ,ROBO_CONTRACT_NO       --ROBO契約書號
      ,ROBO_SER_NO            --ROBO交易書號
      ,PAY_DATE               --預計買回入帳日期

      ,SWITCH_DATE            --預計轉申購日期
      ,FEE_CHOICE             --優惠方案(1：促銷活動；3：紅利折抵；4：身分別；5：生日優惠)
      ,SC_RATE                --轉申購手續費率
      ,PROJECT_CODE           --專案碼
      ,USED_POINT             --使用紅利

      ,TRANSACTION_NO         --交易編號(FOR 紅利及優惠券使用)
      ,COUPON_ID              --優惠券號碼
      ,SERVICE_CHARGE         --轉申購手續費
      -- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
      ,ROBO_BATCH_NO          --ROBO再平衡批次編號
      )
      VALUES
      (XFUND_NO
       ,XID
       ,XTX_DATE
       ,XBROKER_NO
       ,XBRANCH_NO

       ,XSER_NO
       ,WREDEMPTION_TYPE
       ,WAPPLICATION_SHARE
       ,WBANK_NO
       ,WBRANCH_NO

       ,WFIS_SNAME
       ,WAC_CODE
       ,NULL
       ,SYSDATE
       ,'N'

       ,'O'
       ,'00'
       ,WAC_NAME
       ,WAC_DATE
       ,WTRADE_CRNCY

       ,WCURRENCY_NO
       ,NULL
       ,XIP_A
       ,XIP_B
       ,XIP_C

       ,XIP_D
       ,NULL
       ,NULL
       ,NULL
       ,WROBO_CONTRACT_NO
       ,WROBO_SER_NO
       ,WPAY_DATE

       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL

       ,NULL
       ,NULL
       ,NULL
       -- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
       ,WROBO_BATCH_NO
       );

    -- 寫入贖回紀錄檔
    INSERT INTO ECS.REDEMPTION_LOG
      (FUND_NO                  --基金別
      ,ID                       --ID
      ,TX_DATE                  --交易日期
      ,BROKER_NO                --代銷單位
      ,BRANCH_NO                --代銷分公司碼

      ,SER_NO                   --交易序號
      ,REDEMPTION_TYPE          --買回方式(W:全贖/S:部份)
      ,APPLICATION_SHARE        --買回單位數
      ,AC_BANK                  --買回銀行
      ,AC_BRANCH                --買回分行

      ,AC_FIS_SNAME             --買回銀行簡稱
      ,AC_CODE                  --買回帳號
      ,FUND_NO_IN               --轉申購基金別
      ,ACTION_TYPE              --交易動作(A:新增/M:修改/D:刪除)
      ,REVISION_DATE            --修改日期(含時分秒)

      ,AC_NAME                  --戶名
      ,AC_DATE                  --淨值日
      ,CURRENCY_NO              --幣別
      ,BANK_CURRENCY_NO         --銀行幣別
      ,PROSPECTUS               --公開說明書

      ,IP_A                     --IP A
      ,IP_B                     --IP B
      ,IP_C                     --IP C
      ,IP_D                     --IP D
      ,INVESTMENT_RISK          --投資風險評估

      ,CHANNEL_EXPOSE           --通路報酬揭露
      ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
      ,ROBO_CONTRACT_NO         --ROBO契約書號
      ,ROBO_SER_NO              --ROBO交易書號
      ,PAY_DATE                 --預計買回入帳日期
      ,SWITCH_DATE              --預計轉申購日期
      ,FEE_CHOICE               --優惠方案(1：促銷活動；3：紅利折抵；4：身分別；5：生日優惠)

      ,SC_RATE                  --轉申購手續費率
      ,PROJECT_CODE             --專案碼
      ,USED_POINT               --使用紅利
      ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
      ,COUPON_ID                --優惠券號碼
      ,SERVICE_CHARGE           --轉申購手續費
      -- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
      ,ROBO_BATCH_NO            --ROBO再平衡批次編號
      )     
      VALUES
      (XFUND_NO
       ,XID
       ,XTX_DATE
       ,XBROKER_NO
       ,XBRANCH_NO

       ,XSER_NO
       ,WREDEMPTION_TYPE
       ,WAPPLICATION_SHARE
       ,WBANK_NO
       ,WBRANCH_NO

       ,WFIS_SNAME
       ,WAC_CODE
       ,NULL
       ,'A'
       ,SYSDATE

       ,WAC_NAME
       ,WAC_DATE
       ,WTRADE_CRNCY
       ,WCURRENCY_NO
       ,NULL

       ,XIP_A
       ,XIP_B
       ,XIP_C
       ,XIP_D
       ,NULL

       ,NULL
       ,NULL
       ,WROBO_CONTRACT_NO
       ,WROBO_SER_NO
       ,WPAY_DATE
       ,NULL
       ,NULL

       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       ,NULL
       -- 2018.05.31 ChengYu 拿掉ROBO_BATCH_NO參數的註解
       ,WROBO_BATCH_NO
);

    -- 回傳資料 2018.03.20 Mod By Jim
    -- 增加別名 2018.03.21 Mod By Jim
    OPEN OUTDT FOR
         SELECT XSER_NO AS SER_NO
                ,XBROKER_NO AS BROKER_NO
                ,XBRANCH_NO AS BRANCH_NO
                ,XFUND_NO   AS FUND_NO
              FROM DUAL;

    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        Raise_application_error(-20000, '身份證號或是基金代碼查不到，請檢查！');
  END;

END s_SaveRedemData;

/

  GRANT EXECUTE ON "ECS"."S_SAVEREDEMDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVEROBOTXVERKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVEROBOTXVERKEY" 
(
     WACCOUNT_NO            INTEGER                     -- 受益人戶號
    ,WPWD                   VARCHAR2                    -- 交易密碼
    ,WROBO_CONTRACT_NO      VARCHAR2                    -- Robo契約書號
    ,WROBO_DATA             VARCHAR2                    -- Robo Json內容
    ,WIP_A                  VARCHAR2                    -- IP位址(A)
    ,WIP_B                  VARCHAR2                    -- IP位址(B)
    ,WIP_C                  VARCHAR2                    -- IP位址(C)
    ,WIP_D                  VARCHAR2                    -- IP位址(D)
    ,OUTDT                  OUT SYS_REFCURSOR           -- MASTER
   
) IS

BEGIN
  DECLARE XNOW_DATE DATE := SYSDATE;
          XID VARCHAR2(10);
          XDATA_NUM INTEGER;
  BEGIN

    BEGIN
      SELECT HOLDER.ID
        INTO XID
        FROM FAS.HOLDER HOLDER
       WHERE HOLDER.ACCOUNT_NO = WACCOUNT_NO;

      EXCEPTION
           WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000,
                                        '無法取得受益人ID，請檢查！');  
    END;

    SELECT COUNT(1)
      INTO XDATA_NUM
      FROM ECS.ROBO_PWD ROBO_PWD
     WHERE ROBO_PWD.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

    IF XDATA_NUM > 0 THEN 

       INSERT INTO ECS.ROBO_PWD_LOG
            (  
               ACTION_TYPE               -- 交易動作(A:新增/D:刪除)
              ,LOG_DATE                  -- Log 紀錄日期
              ,ROBO_CONTRACT_NO          -- Robo契約書號
              ,ROBO_DATA                 -- Robo Json內容
              ,TOKEN_ID                  -- Token Id
              ,IP_A                      -- IP A
              ,IP_B                      -- IP B
              ,IP_C                      -- IP C
              ,IP_D                      -- IP D
              ,CREATION_DATE             -- 建檔日期(含時分秒)
            )
       SELECT  'D'                       -- 交易動作(A:新增/D:刪除)
              ,XNOW_DATE                 -- Log 紀錄日期
              ,ROBO_PWD.ROBO_CONTRACT_NO -- Robo契約書號
              ,ROBO_PWD.ROBO_DATA        -- Robo Json內容
              ,ROBO_PWD.TOKEN_ID         -- Token Id
              ,WIP_A                     -- IP A
              ,WIP_B                     -- IP B
              ,WIP_C                     -- IP C
              ,WIP_D                     -- IP D
              ,XNOW_DATE                 -- 建檔日期(含時分秒)
         FROM ECS.ROBO_PWD ROBO_PWD
        WHERE ROBO_PWD.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

       DELETE FROM ECS.ROBO_PWD ROBO_PWD
        WHERE ROBO_PWD.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

    END IF;

    INSERT INTO ECS.ROBO_PWD
         (  
            ROBO_CONTRACT_NO   -- Robo契約書號
           ,ROBO_DATA          -- Robo Json內容
           ,TOKEN_ID           -- TOKEN_ID
           ,IP_A               -- IP A
           ,IP_B               -- IP B
           ,IP_C               -- IP C
           ,IP_D               -- IP D
           ,CREATION_DATE      -- 建檔日期(含時分秒)
         ) 
    SELECT  WROBO_CONTRACT_NO  -- Robo契約書號
           ,WROBO_DATA         -- Robo Json內容
           ,SYS_GUID()         -- TOKEN_ID
           ,WIP_A              -- IP A
           ,WIP_B              -- IP B
           ,WIP_C              -- IP C
           ,WIP_D              -- IP D
           ,XNOW_DATE          -- 建檔日期(含時分秒)
      FROM DUAL;

    INSERT INTO ECS.ROBO_PWD_LOG
         (  
            ACTION_TYPE               -- 交易動作(A:新增/D:刪除)
           ,LOG_DATE                  -- Log 紀錄日期
           ,ROBO_CONTRACT_NO          -- Robo契約書號
           ,ROBO_DATA                 -- Robo Json內容
           ,TOKEN_ID                  -- Token Id
           ,IP_A                      -- IP A
           ,IP_B                      -- IP B
           ,IP_C                      -- IP C
           ,IP_D                      -- IP D
           ,CREATION_DATE             -- 建檔日期(含時分秒)
         )
    SELECT  'A'                       -- 交易動作(A:新增/D:刪除)
           ,XNOW_DATE                 -- Log 紀錄日期
           ,ROBO_PWD.ROBO_CONTRACT_NO -- Robo契約書號
           ,ROBO_PWD.ROBO_DATA        -- Robo Json內容
           ,ROBO_PWD.TOKEN_ID         -- Token Id
           ,WIP_A                     -- IP A
           ,WIP_B                     -- IP B
           ,WIP_C                     -- IP C
           ,WIP_D                     -- IP D
           ,XNOW_DATE                 -- 建檔日期(含時分秒)
      FROM ECS.ROBO_PWD ROBO_PWD
     WHERE ROBO_PWD.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

    -- MASTER
    OPEN OUTDT FOR
        SELECT  ROBO_PWD.ROBO_CONTRACT_NO   -- Robo契約書號
               ,ROBO_PWD.TOKEN_ID	          -- Token Id
          FROM ECS.ROBO_PWD ROBO_PWD
         WHERE ROBO_PWD.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO;

  END;

END s_SaveRoboTxVerKey;

/

  GRANT EXECUTE ON "ECS"."S_SAVEROBOTXVERKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVERSPCHGCOMDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVERSPCHGCOMDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/04
-- Description: 儲存定額異動委託-一般異動
-- 2018.06.05 ChengYu 調整REMARK字串
-- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
-- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源、傳出參數契約來源、傳出參數契約來源名稱
-- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
-- 2018.11.22 JIANXIN MOD BY 調整寫入程式邏輯、加減碼百分比調整
-- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
-- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
-- 2021.10.20 Chengyu 儲存時書面資料手續費率必須/ 100
-- =============================================
(
    WACCOUNT_NO             INTEGER,                -- 受益人戶號
    WIP_A                   VARCHAR2,               -- IP位址A
    WIP_B                   VARCHAR2,               -- IP位址B
    WIP_C                   VARCHAR2,               -- IP位址C
    WIP_D                   VARCHAR2,               -- IP位址D
    -- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源
    WRSP_SOURCE             VARCHAR2,               -- 契約來源 1:臨櫃 2:網路
    WID_SEQ                 INTEGER,                -- 契約序號
    WEXPECTED_TX_DATE       DATE,                   -- 預計交易日期
    WAC_DAY                 INTEGER,                -- 每月扣款日
    WAMOUNT                 DECIMAL,                -- 扣款金額
    WRAISE_ROI              DECIMAL,                -- 加碼點(%)
    WRAISE_AMOUNT           DECIMAL,                -- 加碼金額
    WREDUCE_ROI             DECIMAL,                -- 減碼點(%)
    WREDUCE_AMOUNT          DECIMAL,                -- 減碼金額
    WPROJECT_CODE           VARCHAR2,               -- 優惠方案
    WFEE_CHOICE             VARCHAR2,               -- 促銷活動代碼
    WSC_RATE                DECIMAL,                -- 契約手續費率
    WCOUPON_ID              VARCHAR2,               -- 優惠券代碼
    WEXPECTED_TX_DATE_CHG   DATE,                   -- 異動後首次扣款日
    OUTDT                   OUT SYS_REFCURSOR       -- 回傳的TableData
) IS
    XID                     VARCHAR2(10);           -- 受益人ID
    XCHECK_DATA             VARCHAR2(10);           -- 是否有資料
    XSYS_DTTM               DATE := SYSDATE;        -- 系統時間(含時分秒)
    XIS_SAME_DATA           VARCHAR2(1);            -- 資料是否相同
    XREMARK                 VARCHAR2(500);          -- 備註
    XEMP_NO                 VARCHAR2(3) := 'ECS';   -- 修改人員
    -- 2018.11.22 JIANXIN MOD 加減碼百分比調整
    XRAISE_ROI2             DECIMAL(6,3);           -- 加碼點
    XREDUCE_ROI2            DECIMAL(6,3);           -- 減碼點
BEGIN

    -- 2018.11.22 JIANXIN MOD 加減碼百分比調整
    XRAISE_ROI2 := WRAISE_ROI * 0.01;
    XREDUCE_ROI2 := WREDUCE_ROI * 0.01;


    BEGIN
        -- 取受益人ID
        SELECT ID
          INTO XID
          FROM FAS.HOLDER -- 受益人基本資料
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    -- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
    -- 臨櫃定額
    IF WRSP_SOURCE = '1' THEN
    BEGIN
        BEGIN
            SELECT ID
              INTO XCHECK_DATA
              FROM FAS.PERIODIC RSP     -- 書面定額資料
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        BEGIN
            -- 檢查異動內容是否相同(只能做申購價金、約定交易日的異動)
            SELECT CASE WHEN COUNT(RSP.ID) > 0 THEN 'Y' ELSE 'N' END
              INTO XIS_SAME_DATA
              FROM FAS.PERIODIC RSP                         -- 書面定額資料
             WHERE RSP.ID_SEQ = WID_SEQ                     -- 受益人戶號
               AND RSP.ID = XID                             -- 契約序號
               AND RSP.AMOUNT = WAMOUNT                     -- 申購價金
               AND RSP.AC_DAY = WAC_DAY;                    -- 約定交易日

            IF XIS_SAME_DATA = 'Y' THEN
            BEGIN
                OPEN OUTDT FOR
                SELECT  'N' AS IS_SUCCESS                   -- 資料寫入成功否
                       ,MSGINFO.MSGTYPE AS WARNS_TYPE       -- 警示方式
                       ,MSGINFO.MSGCONTENT AS ERROR_MSG     -- 錯誤訊息：RSP契約資料並未被異動，儲存失敗
                  FROM ECS.MSGINFO MSGINFO                  -- 系統訊息資料檔
                 WHERE MSGINFO.MSGID = 'RSP003';

                RETURN;
            END;
            END IF;
        END;

        -- 取得備註用參數
        -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
        SELECT  '定期定額修改：' ||
                FUND.FUND_NO || FUND.NAME　|| '；' ||
                '每月' || WAC_DAY || '號交易日'　|| '；' ||
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE　|| '；' ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN '金額' || WAMOUNT|| '元'　|| '；'
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '基準扣款金額' || WAMOUNT || '元'　|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'加碼' || ROUND(0,1) || '%'　|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '加碼金額' || ROUND(WRAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元'　|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'減碼' || ROUND(0,1) || '%'　|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'減碼金額' || ROUND(0,V_FUND_CRNCY.AMT_DECIMAL) || '元'　|| '；'
                     ELSE ''
                 END 
          INTO XREMARK -- 備註               
          FROM FAS.PERIODIC RSP                     -- 書面定額資料
          LEFT JOIN FAS.FUND FUND
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.AC_BANK
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;


        -- 寫入書面定額變更紀錄，若同一筆同時變更2個項目：1.扣款日期、5.扣款金額，則分別寫入紀錄
        BEGIN
            -- 變更項目：1.扣款日期
            INSERT INTO FAS.PERIODIC_CHANGE
            (
                    ID                              -- ID
                   ,FUND_NO                         -- 基金別
                   ,CHANGE_DATE                     -- 變更日期
                   ,ITEM                            -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
                   ,REMARK                          -- 備註
                   ,ID_SEQ                          -- 契約序號
                   ,EMP_NO                          -- 修改人員
                   ,APPLY_TYPE                      -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
            )
            SELECT  XID                             -- ID
                   ,RSP.FUND_NO                     -- 基金別
                   ,XSYS_DTTM AS CHANGE_DATE        -- 變更日期
                   ,'1' AS ITEM                     -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
                   ,XREMARK AS REMARK               -- 備註
                   ,WID_SEQ AS ID_SEQ               -- 契約序號
                   ,XEMP_NO AS EMP_NO               -- 修改人員
                   ,'2' AS APPLY_TYPE               -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
              FROM FAS.PERIODIC RSP                 -- 書面定額資料
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ
               AND RSP.AC_DAY <> WAC_DAY;

            -- 變更項目：5.扣款金額
            INSERT INTO FAS.PERIODIC_CHANGE
            (
                    ID                              -- ID
                   ,FUND_NO                         -- 基金別
                   ,CHANGE_DATE                     -- 變更日期
                   ,ITEM                            -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
                   ,REMARK                          -- 備註
                   ,ID_SEQ                          -- 契約序號
                   ,EMP_NO                          -- 修改人員
                   ,APPLY_TYPE                      -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
            )
            SELECT  XID                             -- ID
                   ,RSP.FUND_NO                     -- 基金別
                   ,XSYS_DTTM AS CHANGE_DATE        -- 變更日期
                   ,'5' AS ITEM                     -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額';
                   ,XREMARK AS REMARK               -- 備註
                   ,WID_SEQ AS ID_SEQ               -- 契約序號
                   ,XEMP_NO AS EMP_NO               -- 修改人員
                   ,'2' AS APPLY_TYPE               -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
              FROM FAS.PERIODIC RSP                 -- 書面定額資料
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ
               AND RSP.AMOUNT <> WAMOUNT;
        END;

        -- 2021.10.20 Chengyu 儲存時書面資料手續費率必須/ 100
        -- 更新書面定額資料
        UPDATE FAS.PERIODIC
           SET  AMOUNT = WAMOUNT                    -- 申購價金
               ,AC_DAY = WAC_DAY                    -- 約定交易日
               ,REVISION_DATE = XSYS_DTTM           -- 修改日期(含時分秒)
               ,RAISE_AMOUNT = WRAISE_AMOUNT        -- 加碼金額
               ,PROJECT_CODE = WPROJECT_CODE        -- 專案碼
               ,SC_RATE = WSC_RATE / 100            -- 契約手續費率
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                                 END AS RSP_SOURCE_NAME         -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.AC_BANK AS BANK_NO                          -- 扣款總行代碼
               ,RSP.AC_BRANCH AS BRANCH_NO                      -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               ,0 RAISE_ROI                                     -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               ,0 REDUCE_ROI                                    -- 減碼點(%)
               ,0 REDUCE_AMOUNT                                 -- 減碼金額
               ,NULL FEE_CHOICE                                 -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 專案碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 活動簡稱
               ,RSP.SC_RATE * 100                               -- 契約手續費率
               ,NULL COUPON_ID                                  -- 優惠券代碼
          FROM FAS.PERIODIC RSP                                 -- 書面定額資料
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.AC_BANK
           AND FIS_BRANCH.BRANCH_NO = RSP.AC_BRANCH
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

    -- 網路定額
    IF WRSP_SOURCE = '2' THEN
    BEGIN
        BEGIN
            -- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
            -- 檢查是否能取到資料(無資料則跳錯誤訊息、有資料繼續)
            SELECT ID
              INTO XCHECK_DATA
              FROM ECS.RSP RSP  -- EC定額
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
               WHEN NO_DATA_FOUND THEN
                 RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        BEGIN
            -- 檢查異動內容是否相同
            SELECT CASE WHEN COUNT(RSP.ID) > 0 THEN 'Y' ELSE 'N' END
              INTO XIS_SAME_DATA
              FROM ECS.RSP RSP                              -- EC定額
             WHERE RSP.ID_SEQ = WID_SEQ                     -- 受益人戶號
               AND RSP.ID = XID                             -- 契約序號
               AND RSP.AMOUNT = WAMOUNT                     -- 申購價金
               AND RSP.AC_DAY = WAC_DAY                     -- 約定交易日
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               AND RSP.RAISE_ROI = XRAISE_ROI2              -- 加碼點(%)
               AND RSP.RAISE_AMOUNT = WRAISE_AMOUNT         -- 加碼金額
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               AND RSP.REDUCE_ROI = XREDUCE_ROI2            -- 減碼點(%)
               AND RSP.REDUCE_AMOUNT = WREDUCE_AMOUNT       -- 減碼金額
               AND RSP.PROJECT_CODE = WPROJECT_CODE         -- 專案碼
               AND RSP.FEE_CHOICE = WFEE_CHOICE             -- 優惠方案
               AND RSP.SC_RATE = WSC_RATE                   -- 契約手續費率
               AND RSP.COUPON_ID = WCOUPON_ID;              -- 優惠券號碼

            IF XIS_SAME_DATA = 'Y' THEN
            BEGIN
                -- MsgList
                OPEN OUTDT FOR
                SELECT  'N' AS IS_SUCCESS                   -- 資料寫入成功否
                       ,MSGINFO.MSGTYPE AS WARNS_TYPE       -- 警示方式
                       ,MSGINFO.MSGCONTENT AS ERROR_MSG     -- 錯誤訊息：RSP契約資料並未被異動，儲存失敗
                  FROM ECS.MSGINFO MSGINFO                  -- 系統訊息資料檔
                 WHERE MSGINFO.MSGID = 'RSP003';

                RETURN;
            END;
            END IF;
        END;

        -- 取得備註用參數
        -- 2018.06.05 ChengYu 調整REMARK字串
        -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
        SELECT  '定期定額修改：' ||
                FUND.FUND_NO || FUND.NAME || '；' ||
                '每月' || WAC_DAY || '號交易日'|| '；' ||
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE|| '；' ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN '金額' || WAMOUNT || '元'|| '；'
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '基準扣款金額' || WAMOUNT || '元'|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼' || ROUND(WRAISE_ROI,1) || '%'　|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼金額' || ROUND(WRAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元'|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼' || ROUND(WREDUCE_ROI,1) || '%'|| '；'
                     ELSE ''
                 END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼金額' || ROUND(WREDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元'|| '；'
                     ELSE ''
                 END
          INTO XREMARK -- 備註
          FROM ECS.RSP RSP                          -- EC定額
          LEFT JOIN FAS.FUND FUND
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        --新增EC定額異動紀錄
        -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
        INSERT INTO ECS.RSP_LOG
        (
                ID                                  -- ID
               ,ID_SEQ                              -- 契約序號
               ,FUND_NO                             -- 基金別
               ,AMOUNT                              -- 申購價金
               ,AC_DAY                              -- 約定交易日
               ,BANK_NO                             -- 銀行代號
               ,BRANCH_NO                           -- 分行代號
               ,AC_CODE                             -- 銀行帳號
               ,STATUS                              -- 契約狀態
               ,REVISION_DATE                       -- 修改日期(含時分秒)
               ,REMARK                              -- 備註
               ,ACTION_TYPE                         -- 交易動作(A:新增/M:修改/D:刪除)
               ,EXPECTED_TX_DATE                    -- 預計交易日期
               ,CURRENCY_NO                         -- 幣別
               ,AC_NAME                             -- 戶名
               ,PROSPECTUS                          -- 公開說明書
               ,IP_A                                -- IP A
               ,IP_B                                -- IP B
               ,IP_C                                -- IP C
               ,IP_D                                -- IP D
               ,INVESTMENT_RISK                     -- 投資風險評估
               ,CHANNEL_EXPOSE                      -- 通路報酬揭露
               ,PROJECT_CODE                        -- 專案碼
               ,PRODUCT_TYPE                        -- 產品類別
               ,RAISE_ROI                           -- 加碼點(%)
               ,RAISE_AMOUNT                        -- 加碼金額
               ,REDUCE_ROI                          -- 減碼點(%)
               ,REDUCE_AMOUNT                       -- 減碼金額
               ,ONSHORE_SHORT_TRADE                 -- 境內短線交易(Y/N)
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,FEE_CHOICE                          -- 優惠方案\1：促銷活動；2：優惠券；4：身分別
               ,SC_RATE                             -- 契約手續費率
               ,TRANSACTION_NO                      -- 交易編號\FOR 優惠券使用
               ,COUPON_ID                           -- 優惠券號碼
               ,EXPECTED_TX_DATE_CHG                -- 異動後首次扣款日
        )
        SELECT  XID                                 -- ID
               ,WID_SEQ AS ID_SEQ                   -- 契約序號
               ,RSP.FUND_NO                         -- 基金別
               ,WAMOUNT AS AMOUNT                   -- 申購價金
               ,WAC_DAY AS AC_DAY                   -- 約定交易日
               ,RSP.BANK_NO                         -- 銀行代號
               ,RSP.BRANCH_NO                       -- 分行代號
               ,RSP.AC_CODE                         -- 銀行帳號
               ,'4' AS STATUS                       -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               ,XSYS_DTTM AS REVISION_DATE          -- 修改日期(含時分秒)
               ,XREMARK AS REMARK                   -- 備註
               ,'M' AS ACTION_TYPE                  -- 交易動作(A:新增/M:修改/D:刪除)
               ,WEXPECTED_TX_DATE                   -- 預計交易日期
               ,RSP.CURRENCY_NO                     -- 幣別
               ,RSP.AC_NAME                         -- 戶名
               ,RSP.PROSPECTUS                      -- 公開說明書
               ,WIP_A                               -- IP A
               ,WIP_B                               -- IP B
               ,WIP_C                               -- IP C
               ,WIP_D                               -- IP D
               ,RSP.INVESTMENT_RISK                 -- 投資風險評估
               ,RSP.CHANNEL_EXPOSE                  -- 通路報酬揭露
               ,WPROJECT_CODE                       -- 專案碼
               ,RSP.PRODUCT_TYPE                    -- 產品類別
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XRAISE_ROI2 ELSE NULL END                          -- 加碼點(%)
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WRAISE_AMOUNT ELSE NULL END                        -- 加碼金額
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XREDUCE_ROI2 ELSE NULL END                         -- 減碼點(%)
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WREDUCE_AMOUNT ELSE NULL END                       -- 減碼金額
               ,RSP.ONSHORE_SHORT_TRADE             -- 境內短線交易(Y/N)
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,WFEE_CHOICE                         -- 優惠方案\1：促銷活動；2：優惠券；4：身分別
               ,WSC_RATE                            -- 契約手續費率
               ,RSP.TRANSACTION_NO                  -- 交易編號\FOR 優惠券使用
               ,WCOUPON_ID                          -- 優惠券號碼
               ,NVL(WEXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD'))  -- 異動後首次扣款日
          FROM ECS.RSP RSP
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        --更新EC定額
        -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
        UPDATE ECS.RSP RSP
           SET  AMOUNT = WAMOUNT                    -- 申購價金
               ,AC_DAY = WAC_DAY                    -- 約定交易日
               ,REVISION_DATE = XSYS_DTTM           -- 修改日期(含時分秒)
               ,IP_A = WIP_A                        -- IP A
               ,IP_B = WIP_B                        -- IP B
               ,IP_C = WIP_C                        -- IP C
               ,IP_D = WIP_D                        -- IP D
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,RAISE_ROI = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XRAISE_ROI2 ELSE NULL END              -- 加碼點(%)
               ,RAISE_AMOUNT = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WRAISE_AMOUNT ELSE NULL END         -- 加碼金額
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,REDUCE_ROI = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XREDUCE_ROI2 ELSE NULL END            -- 減碼點(%)
               ,REDUCE_AMOUNT = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WREDUCE_AMOUNT ELSE NULL END       -- 減碼金額
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,PROJECT_CODE = WPROJECT_CODE        -- 專案碼
               ,FEE_CHOICE = WFEE_CHOICE            -- 優惠方案
               ,SC_RATE = WSC_RATE                  -- 契約手續費率
               ,COUPON_ID = WCOUPON_ID              -- 優惠券號碼
               ,EXPECTED_TX_DATE_CHG = NVL(WEXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD')) -- 異動後首次扣款日
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               -- 2018.08.30 YUANLONG 增加欄位 傳出參數契約來源、傳出參數契約來源名稱
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                                 END AS RSP_SOURCE_NAME         -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.BANK_NO                                     -- 扣款總行代碼
               ,RSP.BRANCH_NO                                   -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.RAISE_ROI * 100 AS RAISE_ROI                -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.REDUCE_ROI * 100 AS REDUCE_ROI              -- 減碼點(%)
               ,RSP.REDUCE_AMOUNT                               -- 減碼金額
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,RSP.FEE_CHOICE                                  -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 專案碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 活動簡稱
               ,RSP.SC_RATE                                     -- 契約手續費率
               ,RSP.COUPON_ID                                   -- 優惠券代碼
          FROM ECS.RSP RSP                                      -- EC定額
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

END s_SaveRspChgComData;

/

  GRANT EXECUTE ON "ECS"."S_SAVERSPCHGCOMDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVERSPCHGRESUBDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVERSPCHGRESUBDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/05
-- Description: 儲存定額異動委託-恢復扣款
-- 2018.06.05 ChengYu 調整REMARK字串
-- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
-- 2018.06.12 ChengYu 備註(REMARK)新增字串其他(XOTHER)
-- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源(RSP_SOURCE)、傳出參數契約來源(RSP_SOURCE)、傳出參數契約來源名稱(RSP_SOURCE_NAME)
-- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
-- 2018.11.12 tingting 若促銷活動代碼等於指定促銷活動代碼時，則免契約手續費率
-- 2018.11.22 JIANXIN MOD BY 調整寫入程式邏輯、加減碼百分比調整
-- 2018.11.28 tingting 還原促銷活動代碼等於指定促銷活動代碼時，則免契約手續費率
-- 2018.12.10 tingting 若促銷活動代碼不等於指定促銷活動代碼時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券號碼(COUPON_ID)，並更新手續費率為牌告手續費率
-- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
-- 2019.01.03 tingting 調整臨櫃定額取牌告手續費率要除100
-- 2019.01.15 JIANXIN MOD BY 依據後台 fas241 程式，移除暫停日期與恢復日期(fas241 的程式更新狀況就會變成無作用)
-- 2019.01.18 JIANXIN MOD BY 專案代碼書面不做移除
-- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
-- 2021.10.20 Chengyu 查詢書面資料手續費率必須* 100
-- =============================================
(
    WACCOUNT_NO             INTEGER,                -- 受益人戶號
    WIP_A                   VARCHAR2,               -- IP位址A
    WIP_B                   VARCHAR2,               -- IP位址B
    WIP_C                   VARCHAR2,               -- IP位址C
    WIP_D                   VARCHAR2,               -- IP位址D
    -- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源(RSP_SOURCE)
    WRSP_SOURCE             VARCHAR2,               -- 契約來源
    WID_SEQ                 INTEGER,                -- 契約序號
    WEXPECTED_TX_DATE       DATE,                   -- 預計交易日期
    WAC_DAY                 INTEGER,                -- 每月扣款日
    WAMOUNT                 DECIMAL,                -- 扣款金額
    WRAISE_ROI              DECIMAL,                -- 加碼點(%)
    WRAISE_AMOUNT           DECIMAL,                -- 加碼金額
    WREDUCE_ROI             DECIMAL,                -- 減碼點(%)
    WREDUCE_AMOUNT          DECIMAL,                -- 減碼金額
    -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
    WPROJECT_CODE           VARCHAR2,               -- 促銷活動代碼
    WFEE_CHOICE             VARCHAR2,               -- 優惠方案
    WSC_RATE                DECIMAL,                -- 契約手續費率
    WCOUPON_ID              VARCHAR2,               -- 優惠券代碼
    -- 2018.12.10 tingting 若促銷活動代碼不等於指定促銷活動代碼時，清除促銷活動代碼，並更新為牌告手續費率
    WPROJECT_CODE_LIST      VARCHAR2,               -- 指定促銷活動代碼(讀config設定)
    WEXPECTED_TX_DATE_CHG   DATE,                   -- 異動後首次扣款日
    OUTDT                   OUT SYS_REFCURSOR       -- 回傳的TableData
) IS
    XID                     VARCHAR2(10);           -- 受益人ID
    XCHECK_DATA             VARCHAR2(10);           -- 是否有資料
    XIS_PROJECT_CODE_LIST   VARCHAR2(10);           -- 是否為指定促銷活動代碼
    XSYS_DTTM               DATE := SYSDATE;        -- 系統時間(含時分秒)
    XREMARK                 VARCHAR2(500);          -- 備註
    XEMP_NO                 VARCHAR2(3) := 'ECS';   -- 修改人員
    -- 2018.11.22 JIANXIN MOD 加減碼百分比調整
    XRAISE_ROI2             DECIMAL(6,3);           -- 加碼點
    XREDUCE_ROI2            DECIMAL(6,3);           -- 減碼點
BEGIN

    -- 2018.11.22 JIANXIN MOD 加減碼百分比調整
    XRAISE_ROI2 := WRAISE_ROI * 0.01;
    XREDUCE_ROI2 := WREDUCE_ROI * 0.01;

    BEGIN
        -- 取受益人ID
        SELECT ID
          INTO XID
          FROM FAS.HOLDER -- 受益人基本資料
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    --是否為指定促銷活動代碼
    SELECT CASE WHEN Count(VALUE1) > 0 THEN 'Y' ELSE 'N' END
      INTO XIS_PROJECT_CODE_LIST
      FROM TABLE(ECS.F_FormatStringListToTable(WPROJECT_CODE_LIST))
     WHERE VALUE1 = WPROJECT_CODE;

    -- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
    -- 臨櫃定額
    IF WRSP_SOURCE = '1' THEN
    BEGIN
        BEGIN
            SELECT ID
              INTO XCHECK_DATA
              FROM FAS.PERIODIC RSP     -- 書面定額資料
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        -- 取得備註用參數
        -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
        SELECT  '恢復扣款：' ||
                FUND.FUND_NO || FUND.NAME || '；' ||
                '每月' || WAC_DAY || '號交易日' || '；' ||
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE || '；' ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN '金額' || WAMOUNT || '元' || '；'
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '基準扣款金額' || WAMOUNT || '元' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'加碼' || ROUND(0,1) || '%'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'加碼金額' || ROUND(RSP.RAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'減碼' || ROUND(0,1) || '%'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'減碼金額' || ROUND(0,V_FUND_CRNCY.AMT_DECIMAL) || '元'
                     ELSE ''
                     END ||
                CASE WHEN RSP.CONT_FAIL >= 3 THEN REPLACE('並更新連續扣款失敗次數，原為｛Count｝次清空為0次','｛Count｝',RSP.CONT_FAIL) || '；'
                     ELSE ''
                     END
          INTO XREMARK  -- 備註
          FROM FAS.PERIODIC RSP                     -- 書面定額資料
          LEFT JOIN FAS.FUND FUND                   -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.AC_BANK
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 寫入書面定額變更紀錄
        INSERT INTO FAS.PERIODIC_CHANGE
        (
                ID                                  -- ID
               ,FUND_NO                             -- 基金別
               ,CHANGE_DATE                         -- 變更日期
               ,ITEM                                -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
               ,REMARK                              -- 備註
               ,ID_SEQ                              -- 契約序號
               ,EMP_NO                              -- 修改人員
               ,APPLY_TYPE                          -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
        )
        SELECT  XID                                 -- ID
               ,RSP.FUND_NO                         -- 基金別
               ,XSYS_DTTM AS CHANGE_DATE            -- 變更日期
               ,'3' AS ITEM                         -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
               ,XREMARK AS REMARK                   -- 備註
               ,WID_SEQ AS ID_SEQ                   -- 契約序號
               ,XEMP_NO AS EMP_NO                   -- 修改人員
               ,'2' AS APPLY_TYPE                   -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
          FROM FAS.PERIODIC RSP                     -- 書面定額資料
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 更新書面定額資料
        UPDATE FAS.PERIODIC RSP
           SET  AMOUNT = WAMOUNT                    -- 申購價金
               ,AC_DAY = WAC_DAY                    -- 約定交易日
               ,STATUS = '4'                        -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               -- 2019.01.15 JIANXIN MOD BY 依據後台 fas241 程式，移除暫停日期與恢復日期(fas241 的程式更新狀況就會變成無作用)
               ,PAUSED = NULL
               ,RESUMED = NULL
               ,REVISION_DATE = XSYS_DTTM           -- 修改日期(含時分秒)
               ,RAISE_AMOUNT = WRAISE_AMOUNT        -- 加碼金額
               -- 2018.12.10 tingting 若促銷活動代碼不等於指定促銷活動代碼時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券號碼(COUPON_ID)，並更新手續費率為牌告手續費率
               -- 2019.01.18 JIANXIN MOD BY 專案代碼書面不做移除
               --,PROJECT_CODE = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
               --                     THEN RSP.PROJECT_CODE
               --                     ELSE ''
               --                     END             -- 專案碼
               --,SC_RATE = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
               --                THEN RSP.SC_RATE
               --                ELSE (--牌告手續費率
               --                      SELECT SALES_CHARGE.FAS_RSP
               --                        FROM (-- 2019.01.03 tingting 調整臨櫃定額取牌告手續費率要除100
               --                              SELECT ROUND(SALES_CHARGE.FAS_RSP / 100, 4) AS FAS_RSP     --臨櫃RSP申購費率
               --                                FROM FAS.PERIODIC RSP
               --                                JOIN FAS.SALES_CHARGE
               --                                  ON SALES_CHARGE.FUND_NO = RSP.FUND_NO
               --                                 AND SALES_CHARGE.CURRENCY_NO = RSP.CURRENCY_NO
               --                                 AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
               --                                 AND SALES_CHARGE.AMOUNT >= WAMOUNT
               --                               WHERE RSP.ID = XID
               --                                 AND RSP.ID_SEQ = WID_SEQ
               --                               ORDER BY SALES_CHARGE.AMOUNT
               --                             ) SALES_CHARGE
               --                       WHERE ROWNUM = 1
               --                     )
               --                END                  -- 契約手續費率
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ;

        --更新連續扣款失敗次數
        UPDATE FAS.PERIODIC
           SET CONT_FAIL = 0
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ
           AND CONT_FAIL >= 3;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                                 END AS RSP_SOURCE_NAME         -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.AC_BANK                                     -- 扣款總行代碼
               ,RSP.BRANCH_NO                                   -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               ,0 RAISE_ROI                                     -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               ,0 REDUCE_ROI                                    -- 減碼點(%)
               ,0 REDUCE_AMOUNT                                 -- 減碼金額
               ,NULL FEE_CHOICE                                 -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 促銷活動代碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 活動簡稱
               -- 2021.10.20 Chengyu 查詢書面資料手續費率必須* 100
               ,RSP.SC_RATE * 100                               -- 契約手續費率
               ,NULL COUPON_ID                                  -- 優惠券號碼
          FROM FAS.PERIODIC RSP                                 -- 書面定額資料
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.AC_BANK
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

    -- 網路定額
    IF WRSP_SOURCE = '2' THEN
    BEGIN
        BEGIN
            -- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
            -- 檢查是否能取到資料(無資料則跳錯誤訊息、有資料繼續)
            SELECT ID
              INTO XCHECK_DATA
              FROM ECS.RSP RSP  -- EC定額
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        -- 2018.06.05 ChengYu 調整REMARK字串
        SELECT  '恢復扣款：' ||
                FUND.FUND_NO || FUND.NAME  || '；' ||
                '每月' || WAC_DAY || '號交易日'  || '；' ||
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE || '；' ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN '金額' || WAMOUNT || '元'  || '；'
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '基準扣款金額' || WAMOUNT || '元'  || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼' || ROUND(WRAISE_ROI,1) || '%' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼金額' || ROUND(WRAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼' || ROUND(WREDUCE_ROI,1) || '%' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼金額' || ROUND(WREDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END ||
                CASE WHEN EC_RSP.CONT_DISHONOR >= 3 THEN REPLACE('並更新連續扣款失敗次數，原為｛Count｝次清空為0次','｛Count｝',EC_RSP.CONT_DISHONOR)
                     ELSE ''
                     END
          INTO XREMARK -- 備註
          FROM ECS.RSP RSP                          -- EC定額
          LEFT JOIN FAS.FUND FUND                   -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN FAS.EC_RSP
            ON EC_RSP.ID = RSP.ID
           AND EC_RSP.ID_SEQ = RSP.ID_SEQ
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        --新增EC定額異動紀錄
        -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
        INSERT INTO ECS.RSP_LOG
        (
                ID                                  -- ID
               ,ID_SEQ                              -- 契約序號
               ,FUND_NO                             -- 基金別
               ,AMOUNT                              -- 申購價金
               ,AC_DAY                              -- 約定交易日
               ,BANK_NO                             -- 銀行代號
               ,BRANCH_NO                           -- 分行代號
               ,AC_CODE                             -- 銀行帳號
               ,STATUS                              -- 契約狀態
               ,REVISION_DATE                       -- 修改日期(含時分秒)
               ,REMARK                              -- 備註
               ,ACTION_TYPE                         -- 交易動作(A:新增/M:修改/D:刪除)
               ,EXPECTED_TX_DATE                    -- 預計交易日期
               ,CURRENCY_NO                         -- 幣別
               ,AC_NAME                             -- 戶名
               ,PROSPECTUS                          -- 公開說明書
               ,IP_A                                -- IP A
               ,IP_B                                -- IP B
               ,IP_C                                -- IP C
               ,IP_D                                -- IP D
               ,INVESTMENT_RISK                     -- 投資風險評估
               ,CHANNEL_EXPOSE                      -- 通路報酬揭露
               ,PROJECT_CODE                        -- 專案碼
               ,PRODUCT_TYPE                        -- 產品類別
               ,RAISE_ROI                           -- 加碼點(%)
               ,RAISE_AMOUNT                        -- 加碼金額
               ,REDUCE_ROI                          -- 減碼點(%)
               ,REDUCE_AMOUNT                       -- 減碼金額
               ,ONSHORE_SHORT_TRADE                 -- 境內短線交易(Y/N)
               ,FEE_CHOICE                          -- 優惠方案\1：促銷活動；2：優惠券；4：身分別
               ,SC_RATE                             -- 契約手續費率
               ,TRANSACTION_NO                      -- 交易編號\FOR 優惠券使用
               ,COUPON_ID                           -- 優惠券號碼
               ,EXPECTED_TX_DATE_CHG                -- 異動後首次扣款日               
        )
        SELECT  XID                                 -- ID
               ,WID_SEQ AS ID_SEQ                   -- 契約序號
               ,RSP.FUND_NO                         -- 基金別
               ,WAMOUNT AS AMOUNT                   -- 申購價金
               ,WAC_DAY AS AC_DAY                   -- 約定交易日
               ,RSP.BANK_NO                         -- 銀行代號
               ,RSP.BRANCH_NO                       -- 分行代號
               ,RSP.AC_CODE                         -- 銀行帳號
               ,'4' AS STATUS                       -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               ,XSYS_DTTM                           -- 修改日期(含時分秒)
               ,XREMARK AS REMARK                   -- 備註
               ,'M' AS ACTION_TYPE                  -- 交易動作(A:新增/M:修改/D:刪除)
               ,WEXPECTED_TX_DATE                   -- 預計交易日期
               ,RSP.CURRENCY_NO                     -- 幣別
               ,RSP.AC_NAME                         -- 戶名
               ,RSP.PROSPECTUS                      -- 公開說明書
               ,WIP_A                               -- IP A
               ,WIP_B                               -- IP B
               ,WIP_C                               -- IP C
               ,WIP_D                               -- IP D
               ,RSP.INVESTMENT_RISK                 -- 投資風險評估
               ,RSP.CHANNEL_EXPOSE                  -- 通路報酬揭露
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN WPROJECT_CODE
                     ELSE ''
                 END                       -- 專案碼
               ,RSP.PRODUCT_TYPE                    -- 產品類別
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XRAISE_ROI2 ELSE NULL END                          -- 加碼點(%)
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WRAISE_AMOUNT ELSE NULL END                        -- 加碼金額
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XREDUCE_ROI2 ELSE NULL END                         -- 減碼點(%)
               ,CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WREDUCE_AMOUNT ELSE NULL END                       -- 減碼金額
               ,RSP.ONSHORE_SHORT_TRADE             -- 境內短線交易(Y/N)
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN WFEE_CHOICE
                     ELSE ''
                 END                          -- 優惠方案\1：促銷活動；2：優惠券；4：身分別
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN WSC_RATE
                     ELSE (--牌告手續費率
                           SELECT SALES_CHARGE.ECS_RSP
                             FROM (SELECT SALES_CHARGE.ECS_RSP    --EC RSP申購費率
                                     FROM ECS.RSP RSP
                                     JOIN FAS.SALES_CHARGE
                                       ON SALES_CHARGE.FUND_NO = RSP.FUND_NO
                                      AND SALES_CHARGE.CURRENCY_NO = RSP.CURRENCY_NO
                                      AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                                      AND SALES_CHARGE.AMOUNT >= WAMOUNT
                                    WHERE RSP.ID = XID
                                      AND RSP.ID_SEQ = WID_SEQ
                                    ORDER BY SALES_CHARGE.AMOUNT
                                  ) SALES_CHARGE
                            WHERE ROWNUM = 1
                          )
                 END                                -- 契約手續費率
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN RSP.TRANSACTION_NO
                     ELSE 0
                 END                  -- 交易編號\FOR 優惠券使用
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN WCOUPON_ID
                     ELSE ''
                 END                          -- 優惠券號碼
               ,NVL(WEXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD'))  -- 異動後首次扣款日
          FROM ECS.RSP RSP
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        --更新EC定額
        -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
        UPDATE ECS.RSP
           SET  AMOUNT = WAMOUNT                    -- 申購價金
               ,AC_DAY = WAC_DAY                    -- 約定交易日
               ,STATUS = '4'                        -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               ,REVISION_DATE = XSYS_DTTM           -- 修改日期(含時分秒)
               ,IP_A = WIP_A                        -- IP A
               ,IP_B = WIP_B                        -- IP B
               ,IP_C = WIP_C                        -- IP C
               ,IP_D = WIP_D                        -- IP D
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,RAISE_ROI = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XRAISE_ROI2 ELSE NULL END              -- 加碼點(%)
               ,RAISE_AMOUNT = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WRAISE_AMOUNT ELSE NULL END         -- 加碼金額
               -- 2018.11.22 JIANXIN MOD 調整寫入程式邏輯
               ,REDUCE_ROI = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN XREDUCE_ROI2 ELSE NULL END            -- 減碼點(%)
               ,REDUCE_AMOUNT = CASE WHEN RSP.PRODUCT_TYPE = 'P9' THEN WREDUCE_AMOUNT ELSE NULL END       -- 減碼金額
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID) BEGIN
               -- 2018.12.10 tingting 若促銷活動代碼不等於指定促銷活動代碼時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、優惠券號碼(COUPON_ID)，並更新手續費率為牌告手續費率
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,PROJECT_CODE = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
                                    THEN WPROJECT_CODE
                                    ELSE ''
                                    END             -- 專案碼
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,FEE_CHOICE = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
                                  THEN WFEE_CHOICE
                                  ELSE ''
                                  END               -- 優惠方案
               -- 2018.12.10 tingting 若促銷活動代碼不等於指定促銷活動代碼時，清除促銷活動代碼，並更新為牌告手續費率
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,SC_RATE = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
                               THEN WSC_RATE
                               ELSE (--牌告手續費率
                                     SELECT SALES_CHARGE.ECS_RSP
                                       FROM (SELECT SALES_CHARGE.ECS_RSP    --EC RSP申購費率
                                               FROM ECS.RSP RSP
                                               JOIN FAS.SALES_CHARGE
                                                 ON SALES_CHARGE.FUND_NO = RSP.FUND_NO
                                                AND SALES_CHARGE.CURRENCY_NO = RSP.CURRENCY_NO
                                                AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('2000/01/01','yyyy/MM/dd')
                                                AND SALES_CHARGE.AMOUNT >= WAMOUNT
                                              WHERE RSP.ID = XID
                                                AND RSP.ID_SEQ = WID_SEQ
                                              ORDER BY SALES_CHARGE.AMOUNT
                                            ) SALES_CHARGE
                                      WHERE ROWNUM = 1
                                    )
                               END                  -- 契約手續費率
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,TRANSACTION_NO = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y' THEN RSP.TRANSACTION_NO
                                      ELSE 0
                                  END                  -- 交易編號\FOR 優惠券使用
               -- 2018.12.14 JIANXIN MOD BY 若促銷活動代碼不等於指定促銷活動代碼時，寫入Log時，清除優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、交易編號(TRANSACTION_NO)、優惠券號碼(COUPON_ID)
               ,COUPON_ID = CASE WHEN XIS_PROJECT_CODE_LIST = 'Y'
                                 THEN WCOUPON_ID
                                 ELSE ''
                                 END                -- 優惠券號碼
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID) END
               ,EXPECTED_TX_DATE_CHG = NVL(WEXPECTED_TX_DATE_CHG,TO_DATE(19000101,'YYYYMMDD'))  -- 異動後首次扣款日
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ;

        --更新連續扣款失敗次數
        UPDATE FAS.EC_RSP
           SET EC_RSP.CONT_DISHONOR = 0
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ
           AND EC_RSP.CONT_DISHONOR >= 3;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               -- 2018.08.30 YUANLONG 增加欄位 傳出參數契約來源、傳出參數契約來源名稱
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                END AS RSP_SOURCE_NAME                          -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.BANK_NO                                     -- 扣款總行代碼
               ,RSP.BRANCH_NO                                   -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.RAISE_ROI * 100 AS RAISE_ROI                -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.REDUCE_ROI  * 100 AS REDUCE_ROI             -- 減碼點(%)
               ,RSP.REDUCE_AMOUNT                               -- 減碼金額
               -- 2018.08.16 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,RSP.FEE_CHOICE                                  -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 促銷活動代碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 活動簡稱
               ,RSP.SC_RATE                                     -- 契約手續費率
               ,RSP.COUPON_ID                                   -- 優惠券號碼
          FROM ECS.RSP RSP                                      -- EC定額
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

END s_SaveRspChgReSubData;

/

  GRANT EXECUTE ON "ECS"."S_SAVERSPCHGRESUBDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVERSPCHGSTOPSUBDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVERSPCHGSTOPSUBDATA" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/06/05
-- Description:  儲存定額異動委託-停止扣款
-- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
-- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
-- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
-- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源(RSP_SOURCE)、傳出參數契約來源(RSP_SOURCE)、傳出參數契約來源名稱(RSP_SOURCE_NAME)
-- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
-- 2018.11.22 JIANXIN MOD BY 調整寫入程式邏輯、加減碼百分比調整
-- 2018.11.28 tingting 若促銷活動代碼等於指定促銷活動代碼時，停止扣款時，不清除促銷活動代碼
-- 2018.12.10 tingting 調整停止扣款時，不清除專案碼(PROJECT_CODE)、優惠方案(FEE_CHOICE)、優惠券號碼(COUPON_ID)
-- 2020.04.15 JIANXIN MOD BY 依據後台規則協助調整，增加更新暫停日期 
-- 2021.10.20 Chengyu 查詢書面資料手續費率必須* 100
-- =============================================
(
    WACCOUNT_NO             INTEGER,                -- 受益人戶號
    WIP_A                   VARCHAR2,               -- IP位址A
    WIP_B                   VARCHAR2,               -- IP位址B
    WIP_C                   VARCHAR2,               -- IP位址C
    WIP_D                   VARCHAR2,               -- IP位址D
    -- 2018.08.30 YUANLONG 增加欄位 傳入參數契約來源(RSP_SOURCE)
    WRSP_SOURCE             VARCHAR2,               -- 契約來源
    WID_SEQ                 INTEGER,                -- 契約序號
    WEXPECTED_TX_DATE       DATE,                   -- 預計交易日期
    OUTDT                   OUT SYS_REFCURSOR       -- 回傳的TableData
) IS
    XID                     VARCHAR2(10);           -- 受益人ID
    XCHECK_DATA             VARCHAR2(10);           -- 是否有資料
    XSYS_DTTM               DATE := SYSDATE;        -- 系統時間
    XREMARK                 VARCHAR2(600);          -- 備註
    XEMP_NO                 VARCHAR2(3) := 'ECS';   -- 修改人員
BEGIN

    BEGIN
        -- 取受益人ID
        SELECT ID
          INTO XID
          FROM FAS.HOLDER -- 受益人基本資料
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
           WHEN NO_DATA_FOUND THEN
             RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');
    END;

    -- 2018.10.12 tingting 增加書面定額異動功能(原本只有網路定額異動)
    -- 書面定額
    IF WRSP_SOURCE = '1' THEN
    BEGIN
        BEGIN
            SELECT ID
              INTO XCHECK_DATA
              FROM FAS.PERIODIC RSP     -- 書面定額資料
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        -- 取得備註用參數
        -- 2018.11.22 JIANXIN MOD BY 調整寫入程式邏輯
        SELECT  '暫停扣款：' ||
                FUND.FUND_NO || FUND.NAME || '；' ||
                '每月' || RSP.AC_DAY || '號交易日' || '；' ||
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE || '；' ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN '金額' || RSP.AMOUNT || '元' || '；' 
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '基準扣款金額' || RSP.AMOUNT || '元' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'加碼' || ROUND(0,1) || '%' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '加碼金額' || ROUND(RSP.RAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '' --'減碼' || ROUND(0,1) || '%' || '；'
                     ELSE ''
                     END ||
                CASE WHEN RSP.PRODUCT_TYPE = 'P1' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P3' THEN '減碼金額' || ROUND(0,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END
          INTO XREMARK  -- 備註
          FROM FAS.PERIODIC RSP                     -- 書面定額資料
          LEFT JOIN FAS.FUND FUND                   -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.AC_BANK
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 寫入書面定額變更紀錄
        INSERT INTO FAS.PERIODIC_CHANGE
        (
                ID                                  -- ID
               ,FUND_NO                             -- 基金別
               ,CHANGE_DATE                         -- 變更日期
               ,ITEM                                -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
               ,REMARK                              -- 備註
               ,ID_SEQ                              -- 契約序號
               ,EMP_NO                              -- 修改人員
               ,APPLY_TYPE                          -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
        )
        SELECT  XID                                 -- ID
               ,RSP.FUND_NO                         -- 基金別
               ,XSYS_DTTM AS CHANGE_DATE            -- 變更日期
               ,'2' AS ITEM                         -- 變更項目 1.扣款日期 2.停止扣款 3.恢復扣款 5.扣款金額
               ,XREMARK AS REMARK                   -- 備註
               ,WID_SEQ AS ID_SEQ                   -- 契約序號
               ,XEMP_NO AS EMP_NO                   -- 修改人員
               ,'2' AS APPLY_TYPE                   -- 申請變更方式 1:填寫申請書 2:網路申請 3:其他 4:系統產生
          FROM FAS.PERIODIC RSP                     -- 書面定額資料
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 更新書面定額資料
        UPDATE FAS.PERIODIC RSP
           SET  RSP.STATUS = '7'                    -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               -- 2020.04.15 JIANXIN MOD BY 依據後台規則協助調整，增加更新暫停日期
               ,PAUSED = TO_DATE(XSYS_DTTM,'YYYY/MM/DD')
               ,RSP.REVISION_DATE = XSYS_DTTM       -- 修改日期(含時分秒)               
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                END AS RSP_SOURCE_NAME                          -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.AC_BANK AS BANK_NO                          -- 扣款總行代碼
               ,RSP.BRANCH_NO                                   -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               -- 2018.11.22 JIANXIN MOD BY 調整程式取得邏輯
               ,0 RAISE_ROI                                     -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               ,0 REDUCE_ROI                                    -- 減碼點(%)
               ,0 REDUCE_AMOUNT                                 -- 減碼金額
               ,NULL FEE_CHOICE                                 -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 促銷活動代碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 促銷活動名稱
               -- 2021.10.20 Chengyu 查詢書面資料手續費率必須* 100
               ,RSP.SC_RATE * 100                               -- 契約手續費率
               ,NULL COUPON_ID                                  -- 優惠券代碼
          -- 2018.11.22 JIANXIN MOD BY 調整程式取得邏輯
          FROM FAS.PERIODIC RSP                                 -- 書面定額資料
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.AC_BANK
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

    -- 網路定額
    IF WRSP_SOURCE = '2' THEN
    BEGIN
        BEGIN
            -- 2018.06.06 ChengYu 檢查 ECS.RSP(EC定額)有無抓到資料
            SELECT ID
              INTO XCHECK_DATA
              FROM ECS.RSP RSP -- EC定額
             WHERE RSP.ID = XID
               AND RSP.ID_SEQ = WID_SEQ;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, 'ACCOUNT_NO:' || WACCOUNT_NO || ',ID_SEQ:' || WID_SEQ || ' 查無存在資料，請檢查！');
        END;

        -- 取得備註用參數
        -- 2018.11.22 JIANXIN MOD BY 調整寫入程式邏輯
        SELECT  '暫停扣款：' || 
                FUND.FUND_NO || FUND.NAME || '；' || 
                '每月' || RSP.AC_DAY || '號交易日' || '；' || 
                '扣款帳號' || FIS_BANK.SNAME || RSP.AC_CODE || '；' || 
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN '金額' || RSP.AMOUNT || '元' || '；'
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '基準扣款金額' || RSP.AMOUNT || '元' || '；'
                     ELSE ''
                     END || 
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼' || ROUND(RSP.RAISE_ROI * 100,1) || '%' || '；'
                     ELSE ''
                     END || 
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '加碼金額' || ROUND(RSP.RAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END || 
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼' || ROUND(RSP.REDUCE_ROI  * 100,1) || '%' || '；'
                     ELSE ''
                 END || 
                CASE WHEN RSP.PRODUCT_TYPE = 'P8' THEN ''
                     WHEN RSP.PRODUCT_TYPE = 'P9' THEN '減碼金額' || ROUND(RSP.REDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元' || '；'
                     ELSE ''
                     END 
          INTO XREMARK  -- 備註
          FROM ECS.RSP RSP                          -- EC定額
          LEFT JOIN FAS.FUND FUND                   -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN FAS.FIS_BANK FIS_BANK           -- 銀行總行
            ON FIS_BANK.BANK_NO = RSP.BANK_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY   -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY.CURRENCY_NO = FUND.CURRENCY_NO
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        --新增EC定額異動紀錄
        INSERT INTO ECS.RSP_LOG
        (
                ID                                  -- ID
               ,ID_SEQ                              -- 契約序號
               ,FUND_NO                             -- 基金別
               ,AMOUNT                              -- 申購價金
               ,AC_DAY                              -- 約定交易日
               ,BANK_NO                             -- 銀行代號
               ,BRANCH_NO                           -- 分行代號
               ,AC_CODE                             -- 銀行帳號
               ,STATUS                              -- 契約狀態
               ,REVISION_DATE                       -- 修改日期(含時分秒)
               ,REMARK                              -- 備註
               ,ACTION_TYPE                         -- 交易動作
               ,EXPECTED_TX_DATE                    -- 預計交易日期
               ,CURRENCY_NO                         -- 幣別
               ,AC_NAME                             -- 戶名
               ,PROSPECTUS                          -- 公開說明書
               ,IP_A                                -- IP A
               ,IP_B                                -- IP B
               ,IP_C                                -- IP C
               ,IP_D                                -- IP D
               ,INVESTMENT_RISK                     -- 投資風險評估
               ,CHANNEL_EXPOSE                      -- 通路報酬揭露
               ,PROJECT_CODE                        -- 專案碼
               ,PRODUCT_TYPE                        -- 產品類別
               ,RAISE_ROI                           -- 加碼點(%)
               ,RAISE_AMOUNT                        -- 加碼金額
               ,REDUCE_ROI                          -- 減碼點(%)
               ,REDUCE_AMOUNT                       -- 減碼金額
               ,ONSHORE_SHORT_TRADE                 -- 境內短線交易
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,FEE_CHOICE                          -- 優惠方案
               ,SC_RATE                             -- 契約手續費率
               ,TRANSACTION_NO                      -- 交易編號
               ,COUPON_ID                           -- 優惠券號碼
        )
        SELECT  XID                                 -- ID
               ,WID_SEQ                             -- 契約序號
               ,RSP.FUND_NO                         -- 基金別
               ,RSP.AMOUNT                          -- 申購價金
               ,RSP.AC_DAY                          -- 約定交易日
               ,RSP.BANK_NO                         -- 銀行代號
               ,RSP.BRANCH_NO                       -- 分行代號
               ,RSP.AC_CODE                         -- 銀行帳號
               ,'7' AS STATUS                       -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               ,XSYS_DTTM                           -- 修改日期(含時分秒)
               ,XREMARK                             -- 備註
               ,'M' AS ACTION_TYPE                  -- 交易動作
               ,WEXPECTED_TX_DATE                   -- 預計交易日期
               ,RSP.CURRENCY_NO                     -- 幣別
               ,RSP.AC_NAME                         -- 戶名
               ,RSP.PROSPECTUS                      -- 公開說明書
               ,WIP_A                               -- IP A
               ,WIP_B                               -- IP B
               ,WIP_C                               -- IP C
               ,WIP_D                               -- IP D
               ,RSP.INVESTMENT_RISK                 -- 投資風險評估
               ,RSP.CHANNEL_EXPOSE                  -- 通路報酬揭露
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.10 tingting 調整停止扣款時，不清除專案碼(PROJECT_CODE)、優惠方案(FEE_CHOICE)、優惠券號碼(COUPON_ID)
               ,RSP.PROJECT_CODE                    -- 專案碼
               ,RSP.PRODUCT_TYPE                    -- 產品類別
               ,RSP.RAISE_ROI                       -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                    -- 加碼金額
               ,RSP.REDUCE_ROI                      -- 減碼點(%)
               ,RSP.REDUCE_AMOUNT                   -- 減碼金額
               ,RSP.ONSHORE_SHORT_TRADE             -- 境內短線交易
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.10 tingting 調整停止扣款時，不清除專案碼(PROJECT_CODE)、優惠方案(FEE_CHOICE)、優惠券號碼(COUPON_ID)
               ,RSP.FEE_CHOICE                      -- 優惠方案
               ,RSP.SC_RATE                         -- 契約手續費率
               ,RSP.TRANSACTION_NO                  -- 交易編號
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.12.10 tingting 調整停止扣款時，不清除專案碼(PROJECT_CODE)、優惠方案(FEE_CHOICE)、優惠券號碼(COUPON_ID)
               ,RSP.COUPON_ID                       -- 優惠券號碼
          FROM ECS.RSP
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;

        -- 更新EC定額
        UPDATE ECS.RSP
           SET  RSP.STATUS = '7'                    -- 契約狀態 0:退件 1:收件 2:送交核印 3:核印完成 4:有效 5:未核先轉 6:作廢 7:暫停扣款 8:停止扣款
               ,RSP.REVISION_DATE = XSYS_DTTM       -- 修改日期(含時分秒)
               ,RSP.IP_A = WIP_A                    -- IP A
               ,RSP.IP_B = WIP_B                    -- IP B
               ,RSP.IP_C = WIP_C                    -- IP C
               ,RSP.IP_D = WIP_D                    -- IP D
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               -- 2018.11.28 tingting 若促銷活動代碼等於指定促銷活動代碼時，停止扣款時，不清除促銷活動代碼
               -- 2018.12.10 tingting 調整停止扣款時，不清除專案碼(PROJECT_CODE)、優惠方案(FEE_CHOICE)、優惠券號碼(COUPON_ID)
               ,PROJECT_CODE = RSP.PROJECT_CODE     -- 專案碼
               ,FEE_CHOICE = RSP.FEE_CHOICE         -- 優惠方案 
               ,COUPON_ID = RSP.COUPON_ID           -- 優惠券號碼
         WHERE ID = XID
           AND ID_SEQ = WID_SEQ;

        -- 資料輸出
        OPEN OUTDT FOR
        SELECT  'Y' AS IS_SUCCESS                               -- 資料寫入成功否
               ,'' AS WARNS_TYPE                                -- 警示方式
               ,'' AS ERROR_MSG                                 -- 錯誤訊息
               -- 2018.08.30 YUANLONG 增加欄位 傳出參數契約來源、傳出參數契約來源名稱
               ,WRSP_SOURCE AS RSP_SOURCE                       -- 契約來源
               ,CASE WRSP_SOURCE WHEN '1' THEN '臨櫃'
                                 WHEN '2' THEN '網路'
                                 ELSE ''
                END AS RSP_SOURCE_NAME                          -- 契約來源名稱
               ,RSP.ID_SEQ                                      -- 契約序號
               ,RSP.FUND_NO                                     -- 基金代碼
               ,FUND.NAME AS FUND_NAME                          -- 基金名稱
               ,FUND.SHARE_CLASS                                -- 基金級別
               ,FUND_SHARE_CLASS.NAME AS SHARE_CLASS_NAME       -- 基金級別名稱
               ,FUND.CURRENCY_NO                                -- 計價幣別代碼
               ,V_FUND_CRNCY_FUND.NAME AS CURRENCY_NAME         -- 計價幣別名稱
               ,RSP.AC_DAY                                      -- 每月扣款日
               ,RSP.AMOUNT                                      -- 扣款金額
               ,RSP.CURRENCY_NO AS TRADE_CRNCY                  -- 申購幣別
               ,V_FUND_CRNCY_RSP.NAME AS TRADE_CRNCY_NM         -- 申購幣別名稱
               ,RSP.BANK_NO                                     -- 扣款總行代碼
               ,RSP.BRANCH_NO                                   -- 扣款分行代碼
               ,FIS_BRANCH.SNAME AS BANK_SNAME                  -- 扣款銀行簡稱
               -- 2018.08.23 JIANXIN MOD BY 新增帳號隱碼函數
               ,ECS.FN_STUFF_STR(RSP.AC_CODE,5,'*') AS AC_CODE_5    -- 往來帳號後5碼
               ,RSP.STATUS                                      -- 契約狀態
               ,RSP_STATUS.NAME AS STATUS_NAME                  -- 契約狀態名稱
               ,V_FUND_CRNCY_RSP.AMT_DECIMAL AS TRADE_AMT_DECIMAL   -- 申購幣別小數位數
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.RAISE_ROI * 100 AS RAISE_ROI                -- 加碼點(%)
               ,RSP.RAISE_AMOUNT                                -- 加碼金額
               -- 2018.11.23 JIANXIN MOD BY 加減碼回傳必須* 100
               ,RSP.REDUCE_ROI * 100 AS REDUCE_ROI              -- 減碼點(%)
               ,RSP.REDUCE_AMOUNT                               -- 減碼金額
               -- 2018.08.15 ChengYu 增加欄位 優惠方案(FEE_CHOICE)、專案碼(PROJECT_CODE)、活動簡稱(CAMPAIGN_SHNM)、優惠券號碼(COUPON_ID)
               ,RSP.FEE_CHOICE                                  -- 優惠方案
               ,RSP.PROJECT_CODE                                -- 促銷活動代碼
               ,CAMPAIGN.CAMPAIGN_SHNM AS PROJECT_NAME          -- 促銷活動名稱
               ,RSP.SC_RATE                                     -- 契約手續費率
               ,RSP.COUPON_ID                                   -- 優惠券代碼
          FROM ECS.RSP RSP                                      -- EC定額
          LEFT JOIN FAS.FUND FUND                               -- 基金主檔
            ON FUND.FUND_NO = RSP.FUND_NO
          LEFT JOIN ECS.FUND_SHARE_CLASS FUND_SHARE_CLASS       -- 基金級別檔
            ON FUND_SHARE_CLASS.AMC_NO = FUND.AMC_NO
           AND FUND_SHARE_CLASS.SHARE_CLASS = FUND.SHARE_CLASS
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_FUND          -- 幣別檔(View)(計價幣別)
            ON V_FUND_CRNCY_FUND.CURRENCY_NO = FUND.CURRENCY_NO
          LEFT JOIN ECS.V_FUND_CRNCY V_FUND_CRNCY_RSP           -- 幣別檔(View)(申購幣別)
            ON V_FUND_CRNCY_RSP.CURRENCY_NO = RSP.CURRENCY_NO
          LEFT JOIN FAS.FIS_BRANCH FIS_BRANCH                   -- 銀行分行
            ON FIS_BRANCH.BANK_NO = RSP.BANK_NO
           AND FIS_BRANCH.BRANCH_NO = RSP.BRANCH_NO
          LEFT JOIN FAS.RSP_STATUS RSP_STATUS                   -- RSP狀態
            ON RSP_STATUS.STATUS = RSP.STATUS
          LEFT JOIN ECS.CAMPAIGN CAMPAIGN                       -- 預約開戶資料
            ON CAMPAIGN.CAMPAIGN_CODE = RSP.PROJECT_CODE
         WHERE RSP.ID = XID
           AND RSP.ID_SEQ = WID_SEQ;
    END;
    END IF;

END s_SaveRspChgStopSubData;

/

  GRANT EXECUTE ON "ECS"."S_SAVERSPCHGSTOPSUBDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVESHOPPINGCAR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVESHOPPINGCAR" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/19
-- Description: 儲存購物車交易資料
-- 2018.03.21 修改申購程式碼部分 MOD BY JIM
-- 2018.03.22 修改定期(不)定額部分、新增申購紅利部分 MOD BY JIM
-- 2018.03.28 修改申購紅利、定期定額REMARK MOD BY JIM
-- 2018.03.29 補傳入ISIN_CODE的邏輯 MOD BY JIM
-- 2018.03.31 修改日期格式 MOD BY JIM
-- 2018.04.17 整理SP程式碼及重新調整邏輯 MOD BY JIM
-- 2018.05.10 新增傳入參數ROBO_BATCH_NO(但因table架構還沒改，還沒insert) MOD BY JIM
-- 2018.05.21 補上ECS.COUPON_DATA的條件 MOD BY JIM
-- 2018.05.22 新增傳入參數AC_CNT(累計扣款次數\FOR Robo 交易使用) MOD BY JIM
-- 2018.05.24 如找不到原始手續費的話，手續費為0 MOD BY JIM
-- 2018.05.31 將STATUS從 4:有效 調整為 1:收件、FIRST_TX_DATA改為NULL MOD BY JIM
-- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
-- 2018.06.01 ChengYu 傳入參數基金代碼、國際證券代碼需先對應資料表才能使用
-- 2018.06.08 ChengYu 拿掉TX_STATUS(交易狀態\O: 委託中/C:已確認)
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
-- 2018.07.17 ChengYu 寫入【EC申購(ECS.PURCHASE)】的 IS_EMAIL(是否已emal)固定為X
-- 2018.08.11 JIANXIN 定額新件，最大號 + 1，若無資料時必須特殊處理，若有資料直接+1
-- 2018.08.20 ChengYu 自訂變數XPROSPECTUS(公開書名書) 加入預設值
-- 2018.10.09 yunchu 調整沖銷資料寫入紅利歷史使用明細檔因紅利折抵多筆造成PK重覆問題
-- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
-- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
-- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
--                     調整優惠券交易單號 由ECS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL 改從 ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL 取得
-- 2018.11.29 JIANXIN 調整手續費儲存資訊
-- 2018.12.10 JIANXIN 調整手續費率取得方式
-- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
-- 2019.01.04 JIANXIN MOD BY 新增寫入備註欄位
-- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
-- 2020.04.06 ChengYu 【優惠券配發資料(ECS.COUPON_DATA)】的欄位USED_DATE(使用日期)儲存值修改為系統日
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- =============================================
(
    WACCOUNT_NO             INTEGER,        --受益人戶號
    WIP_ADR                 VARCHAR2,       --IP位址
    WSHOP_TYPE              VARCHAR2,       --購物車類別
    WFUND_NO                VARCHAR2,       --基金代碼
    WISIN_CODE              VARCHAR2,       --國際證券代碼
    WTX_DATE                DATE,           --交易日期
    WAMOUNT                 INTEGER,        --申購金額
    WFEE_CHOICE             VARCHAR2,       --優惠方案
    WPROJECT_CODE           VARCHAR2,       --促銷活動代碼
    WSC_RATE                INTEGER,        --申購手續費率
    WSERVICE_CHARGE         INTEGER,        --申購手續費
    WBANK_NO                VARCHAR2,       --扣款總行代碼
    WAC_NAME                VARCHAR2,       --扣款帳號戶名
    WAC_CODE                VARCHAR2,       --扣款帳號
    WAC_BRANCH              VARCHAR2,       --扣款分行代碼
    WCURRENCY_NO            VARCHAR2,       --申購幣別
    WUSED_POINT             INTEGER,        --使用紅利點數
    WCOUPON_ID              VARCHAR2,       --優惠券代碼
    WPROSPECTUS             VARCHAR2,       --勾選公開說明書(及投資人須知)
    WINVESTMENT_RISK        VARCHAR2,       --勾選投資風險預告書
    WCHANNEL_EXPOSE         VARCHAR2,       --勾選境外基金通路報酬揭露
    WONSHORE_SHORT_TRADE    VARCHAR2,       --勾選境內基金短線交易
    WROBO_CONTRACT_NO       VARCHAR2,       --ROBO契約書號
    WROBO_SER_NO            VARCHAR2,       --ROBO交易書號
    WEXPECTED_TX_DATE       DATE,           --預計交易日期
    WRAISE_ROI              DECIMAL,        --加碼點(%)
    WRAISE_AMOUNT           DECIMAL,        --加碼金額
    WREDUCE_ROI             DECIMAL,        --減碼點(%)
    WREDUCE_AMOUNT          DECIMAL,        --減碼金額
    WAC_DAY                 INTEGER,        --扣款日
    WROBO_BATCH_NO          VARCHAR2,       --ROBO再平衡批次編號
    WAC_CNT                 INTEGER,        --累計扣款次數\FOR Robo 交易使用  2018.05.22 Jim 新增參數
    -- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
    WIS_INVEST_RISK         VARCHAR2,       --目標到期投資風險預告書
    OUTDT                   OUT SYS_REFCURSOR
) IS

--宣告變數
XSYS_DTTM                   DATE:=SYSDATE;           --系統日期時間
XFUND_NO                    VARCHAR2(5);             --基金代碼
XID                         VARCHAR2(10);            --受益人ID
XPROJECT_CODE               VARCHAR2(6);             --促銷活動代碼
-- 2018.08.20 ChengYu 自訂變數XPROSPECTUS(公開書名書) 加入預設值
XPROSPECTUS                 VARCHAR2(1):= ' ';       --勾選公開說明書
XTRANSACTION_NO             INTEGER;                 --交易編號(FOR 紅利及優惠券使用)
XIP_A                       VARCHAR2(3);             --第一段IP
XIP_B                       VARCHAR2(3);             --第二段IP
XIP_C                       VARCHAR2(3);             --第三段IP
XIP_D                       VARCHAR2(3);             --第四段IP
XNAV_DATE                   DATE;                    --淨值日期
XNAV_CALENDAR               VARCHAR2(5);             --淨值日行事曆類別
XPUR_NAV_DAY                NUMBER(1);               --申購淨值日參數
XCHECK_BUS                  INTEGER;                 --推算營業日
XTX_DATE                    DATE:= TRUNC(WTX_DATE);  --交易日(格式改為日期YYYY/MM/DD)
-- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
XTRADE_TYPE                 VARCHAR2(1) := '1';      --交易種類(1.申購 2:贖回)

BEGIN

    --取得受益人ID
    BEGIN

        SELECT ID INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    --2018.03.29 Jim 補ISIN_CODE邏輯
    -- 2018.06.01 ChengYu 傳入參數基金代碼、國際證券代碼需先對應資料表才能使用 BEGIN
    --取得FUND_NO
    BEGIN
        SELECT FUND.FUND_NO
          INTO XFUND_NO
          FROM FAS.FUND FUND
         WHERE FUND.FUND_NO = WFUND_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
            BEGIN
                SELECT FUND.FUND_NO
                  INTO XFUND_NO
                  FROM FAS.FUND FUND
                 WHERE FUND.ISIN_CODE = WISIN_CODE;

                EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                        RAISE_APPLICATION_ERROR(-20000, 'FUND_NO：' || WFUND_NO || ',ISIN_CODE：' || WISIN_CODE || ' 無法取得基金代碼，請檢查！');
            END;
    END;
    -- 2018.06.01 ChengYu 傳入參數基金代碼、國際證券代碼需先對應資料表才能使用 END

    --取得淨值日行事曆類別、申購淨值日參數
    BEGIN

        SELECT FUND.CALENDAR_CODE
              ,FUND.PUR_NAV_DAY
          INTO XNAV_CALENDAR
              ,XPUR_NAV_DAY
          FROM FAS.FUND
         WHERE FUND.FUND_NO = XFUND_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得淨值日行事曆類別或申購淨值日參數，請檢查！');

    END;

    --推算淨值日
    XNAV_DATE := XTX_DATE;
    WHILE XPUR_NAV_DAY > 0
    LOOP

        XNAV_DATE := XNAV_DATE+1;

        --判斷營業日+1是否為假日
        SELECT COUNT(HOLIDAY)
          INTO XCHECK_BUS
          FROM FAS.CALENDAR
         WHERE HOLIDAY = XNAV_DATE
           AND CALENDAR_CODE = XNAV_CALENDAR;

        --不是假日，申購淨值日參數(XPUR_NAV_DAY)-1
        IF XCHECK_BUS = 0 THEN
            XPUR_NAV_DAY := XPUR_NAV_DAY-1;

        --是假日，繼續往下+1找，直接找到營業日
        ELSE
            WHILE XCHECK_BUS = 1
            LOOP

                XNAV_DATE := XNAV_DATE+1;

                SELECT COUNT(HOLIDAY)
                  INTO XCHECK_BUS
                  FROM FAS.CALENDAR
                 WHERE HOLIDAY = XNAV_DATE
                   AND CALENDAR_CODE = XNAV_CALENDAR;

            END LOOP;

            --不是假日，申購淨值日參數(XPUR_NAV_DAY)-1
            XPUR_NAV_DAY := XPUR_NAV_DAY-1;

        END IF;

    END LOOP;

    --單筆申購
    IF WSHOP_TYPE = '1' THEN
    BEGIN

        DECLARE
        -- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
        XSER_NO                     VARCHAR2(4);    --交易序號
        XBRANCH_NO                  VARCHAR2(4);    --代銷分公司碼
        XYEAR                       NUMBER(4);      --年分
        XUSED_POINT                 INTEGER;        --使用紅利點數
        XORG_SERVICE_CHARGE         DECIMAL;        --原手續費

        BEGIN

            --代銷分公司碼
            IF WROBO_CONTRACT_NO IS NULL THEN

                XBRANCH_NO := '8000';

            ELSE

                XBRANCH_NO :='8800';

            END IF;

            XYEAR := EXTRACT(YEAR FROM WTX_DATE);

            --交易序號
            -- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
            XSER_NO := ECS.F_GETTXNO(XYEAR,'999',XBRANCH_NO,XFUND_NO,XTRADE_TYPE);

            --交易編號(XTRANSACTION_NO)：若傳入參數『優惠方案(FEE_CHOICE)』為”2.優惠券或3.紅利折抵”
            --取得系統「TRANSACTION_NO」自編流水號
            IF WFEE_CHOICE = '3' THEN

                -- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
                --                     調整優惠券交易單號 由ECS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL 改從 ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL 取得
                SELECT FAS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL AS TRANSACTION_NO
                  INTO XTRANSACTION_NO　
                  FROM DUAL;

            ELSIF WFEE_CHOICE = '2' THEN

                -- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
                --                     調整優惠券交易單號 由ECS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL 改從 ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL 取得
                SELECT ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL AS TRANSACTION_NO
                  INTO XTRANSACTION_NO　
                  FROM DUAL;

            END IF;

            --原手續費(目前測試資料最小為10萬才有資料)
            BEGIN

                -- 2018.11.29 JIANXIN 調整手續費儲存資訊
                SELECT ROUND(SALES_CHARGE.ECS_PURCHASE * WAMOUNT * 0.01,FUND_CRNCY.AMT_DECIMAL)
                  INTO XORG_SERVICE_CHARGE
                  FROM FAS.SALES_CHARGE SALES_CHARGE
         CROSS JOIN (SELECT AMT_DECIMAL FROM ECS.V_FUND_CRNCY WHERE CURRENCY_NO = WCURRENCY_NO) FUND_CRNCY
                 WHERE SALES_CHARGE.FUND_NO = XFUND_NO
                   AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('2000/01/01','YYYY/MM/DD')
                   AND SALES_CHARGE.AMOUNT = (SELECT MIN(SALES_CHARGE.AMOUNT)
                                                FROM FAS.SALES_CHARGE
                                               WHERE SALES_CHARGE.FUND_NO = XFUND_NO
                                                 AND SALES_CHARGE.EFFECTIVE_DATE = TO_DATE('2000/01/01','YYYY/MM/DD')
                                                 -- 2018.12.10 JIANXIN 調整手續費率取得方式
                                                 AND SALES_CHARGE.CURRENCY_NO = WCURRENCY_NO
                                                 AND SALES_CHARGE.AMOUNT >= WAMOUNT);
                EXCEPTION
                    WHEN NO_DATA_FOUND THEN
                        --2018.05.24 Jim 找不到的話手續會為0
                        XORG_SERVICE_CHARGE := 0;

            END;

            --專案碼
            IF WFEE_CHOICE = '1' OR WFEE_CHOICE = '4' OR WFEE_CHOICE = '5' THEN

                XPROJECT_CODE    := WPROJECT_CODE;

            ELSE

                XPROJECT_CODE    := '';

            END IF;

            --公開說明書
            IF WPROSPECTUS = 'Y' THEN

                XPROSPECTUS := '5';

            END IF;

            --使用紅利
            IF WFEE_CHOICE = '3' THEN

                XUSED_POINT := WUSED_POINT;

            ELSE

                XUSED_POINT := NULL;

            END IF;

            --IP分成四段
            XIP_A := SUBSTR(WIP_ADR, 1,INSTR(WIP_ADR, '.', 1, 1)-1);
            XIP_B := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 1)+1, INSTR(WIP_ADR, '.', 1, 2) - INSTR(WIP_ADR, '.', 1, 1)-1);
            XIP_C := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 2)+1, INSTR(WIP_ADR, '.', 1, 3) - INSTR(WIP_ADR, '.', 1, 2)-1);
            XIP_D := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 3)+1,4);

            --寫入【EC申購(ECS.PURCHASE)】檔
            INSERT INTO ECS.PURCHASE
            (FUND_NO                  --基金別
            ,ID                       --ID
            ,TX_DATE                  --交易日期
            ,BROKER_NO                --代銷單位
            ,BRANCH_NO                --代銷分公司碼

            ,SER_NO                   --交易序號
            ,PAY_TYPE                 --付款方式 1：現金 2：支票 3：匯款 4：扣款 5：ATM 轉帳 6：匯款轉帳 7：傳真扣款
            ,ORG_AMOUNT               --原申購價金
            ,ORG_SERVICE_CHARGE       --原手續費
            ,AMOUNT                   --申購價金

            ,SERVICE_CHARGE           --手續費
            ,REMARK                   --備註
            ,BANK_NO                  --銀行代號
            ,AC_CODE                  --銀行帳號
            ,PROJECT_CODE             --專案碼

            ,REVISED_BY               --最後修改人員
            ,REVISION_DATE            --最後修改日期(含時分秒)
            ,STATUS                   --交易狀態(O: 委託中/C:已確認/P:已結帳)
            ,RESULT_CODE              --交易結果(00:成功/01:失敗)
            ,IS_EMAIL                 --是否已emal(N:尚未寄出/Y: 已寄出)

            ,AC_DATE                  --淨值日
            ,REFERENCE_NO             --參考序號
            ,AC_BRANCH                --扣款分行代碼
            ,CURRENCY_NO              --幣別
            ,PROSPECTUS               --公開說明書

            ,USED_POINT               --使用紅利
            ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
            ,IP_A                     --IP A
            ,IP_B                     --IP B
            ,IP_C                     --IP C

            ,IP_D                     --IP D
            ,INVESTMENT_RISK          --投資風險評估
            ,CHANNEL_EXPOSE           --通路報酬揭露
            ,DEDUCT_DATE              --銀行扣款日期
            ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)

            ,ROBO_CONTRACT_NO         --ROBO契約書號
            ,ROBO_SER_NO              --ROBO交易書號
            ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
            ,COUPON_ID                --優惠券號碼
            ,SC_RATE                  --申購手續費率
            -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
            ,ROBO_BATCH_NO            --ROBO再平衡批次編號
            ,AC_CNT                   --扣款重送次數\FOR Robo 交易使用
            -- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
            ,IS_INVEST_RISK           --目標到期投資風險預告書
            )
            VALUES
            (XFUND_NO
            ,XID
            ,XTX_DATE
            ,'999'
            ,XBRANCH_NO

            ,XSER_NO
            ,'4'
            ,WAMOUNT
               ,XORG_SERVICE_CHARGE
            ,WAMOUNT

            ,WSERVICE_CHARGE
            -- 2019.01.04 JIANXIN MOD BY 新增寫入備註欄位
            ,CASE WHEN WIS_INVEST_RISK = 'Y' THEN '已簽屬投資風險預告書' ELSE '' END
            ,WBANK_NO
            ,WAC_CODE
            ,XPROJECT_CODE

            ,'ECS'
            ,XSYS_DTTM
            ,'O'
            ,'00'
            -- 2018.07.17 ChengYu 寫入【EC申購(ECS.PURCHASE)】的 IS_EMAIL(是否已emal)固定為X
            ,'X'

            ,XNAV_DATE
            ,NULL
            ,WAC_BRANCH
            ,WCURRENCY_NO
            ,XPROSPECTUS

            ,XUSED_POINT
            ,XTRANSACTION_NO
            ,XIP_A
            ,XIP_B
            ,XIP_C

            ,XIP_D
            ,WINVESTMENT_RISK
            ,WCHANNEL_EXPOSE
            ,NULL
            ,WONSHORE_SHORT_TRADE

            ,WROBO_CONTRACT_NO
            ,WROBO_SER_NO
            ,WFEE_CHOICE
            ,WCOUPON_ID
            ,WSC_RATE
            -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
            ,WROBO_BATCH_NO
            ,WAC_CNT
            -- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
            ,WIS_INVEST_RISK
            );

            --寫入【EC申購紀錄(ECS.PURCHASE_LOG)】檔
            INSERT INTO ECS.PURCHASE_LOG
            (FUND_NO                  --基金別
            ,ID                       --ID
            ,TX_DATE                  --交易日期
            ,BROKER_NO                --代銷單位
            ,BRANCH_NO                --代銷分公司碼

            ,SER_NO                   --交易序號
            ,AMOUNT                   --申購價金
            ,SERVICE_CHARGE           --手續費
            ,PAY_TYPE                 --付款方式
            ,REMARK                   --備註

            ,BANK_NO                  --銀行代號
            ,AC_CODE                  --銀行帳號
            ,PROJECT_CODE             --專案碼
            ,ACTION_TYPE              --交易動作(A:新增/M:修改/D:刪除)
            ,REVISION_DATE            --最後修改日期

            ,AC_DATE                  --淨值日
            ,AC_BRANCH                --扣款分行代碼
            ,CURRENCY_NO              --幣別
            ,PROSPECTUS               --公開說明書
            ,USED_POINT               --使用紅利

            ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
            ,IP_A                     --IP A
            ,IP_B                     --IP B
            ,IP_C                     --IP C
            ,IP_D                     --IP D

            ,INVESTMENT_RISK          --投資風險評估
            ,CHANNEL_EXPOSE           --通路報酬揭露
            ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
            ,ROBO_CONTRACT_NO         --ROBO契約書號
            ,ROBO_SER_NO              --ROBO交易書號

            ,FEE_CHOICE               --優惠方案；1：促銷活動；2：優惠券；3：紅利折抵；4：身分別；5：生日優惠
            ,COUPON_ID                --優惠券號碼
            ,SC_RATE                  --申購手續費率
            -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
            ,ROBO_BATCH_NO            --ROBO再平衡批次編號
            ,AC_CNT                   --累計扣款次數\FOR Robo 交易使用
            -- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
            ,IS_INVEST_RISK           --目標到期投資風險預告書
            )
            VALUES
            (XFUND_NO
            ,XID
            ,XTX_DATE
            ,'999'
            ,XBRANCH_NO

            ,XSER_NO
            ,WAMOUNT
            ,WSERVICE_CHARGE
            ,'4'
            -- 2019.01.04 JIANXIN MOD BY 新增寫入備註欄位
            ,CASE WHEN WIS_INVEST_RISK = 'Y' THEN '已簽屬投資風險預告書' ELSE '' END

            ,WBANK_NO
            ,WAC_CODE
            ,XPROJECT_CODE
            ,'A'
            ,XSYS_DTTM

            ,XNAV_DATE
            ,WAC_BRANCH
            ,WCURRENCY_NO
            ,XPROSPECTUS

            ,XUSED_POINT
            ,XTRANSACTION_NO
            ,XIP_A
            ,XIP_B
            ,XIP_C

            ,XIP_D
            ,WINVESTMENT_RISK
            ,WCHANNEL_EXPOSE
            ,WONSHORE_SHORT_TRADE
            ,WROBO_CONTRACT_NO

            ,WROBO_SER_NO
            ,WFEE_CHOICE
            ,WCOUPON_ID
            ,WSC_RATE
            -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
            ,WROBO_BATCH_NO
            ,WAC_CNT
            -- 2019.01.02 JIANXIN 新增【目標到期投資風險預告書】欄位
            ,WIS_INVEST_RISK
            );

            --若『優惠方案(FEE_CHOICE)』 = ”3.紅利折抵”，寫入紅利資料
            IF WFEE_CHOICE = '3' THEN
            BEGIN

                DECLARE CURSOR REWARDLIST IS
                        SELECT  REWARD_POINT.REWARD_NO
                               -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                               ,REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) AS CAN_USE_POINT     --可使用點數(紅利點數 - 使用點數 - 預扣點數)
                          FROM FAS.REWARD_POINT             --紅利配發資料
                          -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                          LEFT JOIN (
                                -- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
                                --還沒真正被使用的預扣點數
                                SELECT  REWARD_POINT.REWARD_NO
                                       ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
                                  FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
                                  JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
                                    ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
                                   AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
                                  JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
                                    ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
                                 WHERE REWARD_HISTORY.ID = XID
                                   AND REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
                                 GROUP BY REWARD_POINT.REWARD_NO
                                 ORDER BY REWARD_POINT.REWARD_NO
                               ) REWARD_POINT_W         --紅利配發資料(預扣)
                            ON REWARD_POINT_W.REWARD_NO = REWARD_POINT.REWARD_NO
                         WHERE REWARD_POINT.ID = XID
                           AND REWARD_POINT.VALID_FROM <= XTX_DATE
                           AND REWARD_POINT.VALID_THRU >= XTX_DATE
                           -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                           AND REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) > 0
                         ORDER BY REWARD_POINT.VALID_THRU
                                 ,REWARD_POINT.REWARD_NO;
                --沖銷紅利變數
                XNOT_USE_POINT      INTEGER := NVL(XUSED_POINT,0);      --待沖銷紅利點數
                XCAN_USE_POINT      INTEGER;                            --可沖銷紅利點數

                BEGIN

                    FOR ITEM IN REWARDLIST
                    LOOP

                        EXIT WHEN XNOT_USE_POINT = 0 ;

                        XCAN_USE_POINT := CASE WHEN XNOT_USE_POINT > ITEM.CAN_USE_POINT THEN ITEM.CAN_USE_POINT ELSE XNOT_USE_POINT END;

                        -- 將沖銷資料寫入【紅利使用點數(FAS.REWARD_DETAILS)】檔
                        INSERT INTO FAS.REWARD_DETAILS
                        (TRANSACTION_NO                --交易編號
                        ,REWARD_NO                     --紅利編號
                        ,USED_POINT                    --使用點數
                        ,USE_TYPE                      --交易類別 1：單筆申購；2：轉申購
                        )
                        VALUES
                        (XTRANSACTION_NO
                        ,ITEM.REWARD_NO
                        ,XCAN_USE_POINT
                        ,'1'
                        );

                        XNOT_USE_POINT := XNOT_USE_POINT - XCAN_USE_POINT;

                    END LOOP;

                    -- 2018.10.09 yunchu 調整沖銷資料寫入紅利歷史使用明細檔因紅利折抵多筆造成PK重覆問題
                    -- 將沖銷資料寫入【紅利歷史使用明細(FAS.REWARD_HISTORY)】檔
                    INSERT INTO FAS.REWARD_HISTORY
                    (ID                            --受益人ID
                    ,TX_DATE                       --交易日期
                    ,TX_TYPE                       --交易類別 C：新增；Ｗ：預扣；Ｕ：使用
                    ,USED_POINT                    --使用點數
                    ,TRANSACTION_NO                --交易編號
                    ,USE_TYPE                      --交易類別 1：單筆申購；2：轉申購
                    )
                    VALUES
                    (XID
                    ,XTX_DATE
                    ,'W'
                    ,NVL(XUSED_POINT,0)
                    ,XTRANSACTION_NO
                    ,'1'
                    );

                END;

            END;
            END IF;

            --若『優惠方案(FEE_CHOICE)』 = ”2.優惠券”，寫入優待券資料
            IF WFEE_CHOICE = '2' THEN

                --將優惠券號碼寫入【優惠券使用記錄(ECS.COUPON_DETAILS)】檔
                INSERT INTO ECS.COUPON_DETAILS
                (COUPON_ID         --優惠券號碼
                ,TRANSACTION_NO    --交易編號
                ,USE_TYPE          --使用類別
                )
                VALUES
                (WCOUPON_ID
                ,XTRANSACTION_NO
                ,'1'
                );

                --將優惠券號碼寫入【優惠券歷史使用明細(ECS.COUPON_HISTORY)】檔
                INSERT INTO ECS.COUPON_HISTORY
                (COUPON_ID         --優惠券號碼
                ,ID                --受益人ID
                ,TX_DATE           --交易日期
                ,TRANSACTION_NO    --交易編號
                ,USE_TYPE          --使用類別
                )
                VALUES
                (WCOUPON_ID
                ,XID
                ,XTX_DATE
                ,XTRANSACTION_NO
                ,'1'
                );

                --更新【優惠券配發資料(ECS.COUPON_DATA)】檔
                UPDATE ECS.COUPON_DATA
                   SET IS_EFFECT = 'N'            --有效否 Y：有效；N：無效
                       -- 2020.04.06 ChengYu 【優惠券配發資料(ECS.COUPON_DATA)】的欄位USED_DATE(使用日期)儲存值修改為系統日
                       ,USED_DATE = TRUNC(XSYS_DTTM) --使用日期
                       ,USE_TYPE = '1'            --使用類別
                       ,UPDATEID = 'ECS'          --最後修改者
                       ,UPDATEDATE = XSYS_DTTM    --最後修改日期
                 WHERE COUPON_ID = WCOUPON_ID
                   -- 2018.05.21 Jim 補上條件
                   AND ID = XID;

            END IF;

            -- 增加別名 2018.03.21 Mod By Jim
            OPEN OUTDT FOR
            SELECT XSER_NO AS SER_NO
                  ,XBRANCH_NO AS BRANCH_NO
                  ,XFUND_NO AS FUND_NO
              FROM DUAL;

        END;

    END;

    --定期(不)定額
    ELSE

        BEGIN

            DECLARE
            --定期(不)定額變數
            XID_SEQ                     NUMBER(3);        --契約序號
            XPRODUCT_TYPE               VARCHAR2(2);      --產品類別 定額='P8'/不定額='P9'
            XRAISE_ROI                  DECIMAL(6,3);     --加碼點(%)
            XRAISE_AMOUNT               DECIMAL;          --加碼金額
            XREDUCE_ROI                 DECIMAL(6,3);     --減碼點(%)
            XREDUCE_AMOUNT              DECIMAL;          --減碼金額
            XREMARK                     VARCHAR2(500);    --備註
            XUSE_TYPE                   VARCHAR2(1);      --使用類別
            XEXPECTED_TX_DATE           DATE:= TRUNC(WEXPECTED_TX_DATE);   --預計交易日期(格式改為日期YYYY/MM/DD)

            BEGIN

            --取得契約序號
            BEGIN

                -- 2018.08.11 JIANXIN 定額新件，最大號 + 1，若無資料時必須特殊處理，若有資料直接+1
                SELECT CASE WHEN MAX(ID_SEQ) IS NULL THEN 1 ELSE MAX(ID_SEQ) + 1 END
                  INTO XID_SEQ
                  FROM ECS.RSP
                 WHERE RSP.ID = XID;

                --XID_SEQ := XID_SEQ + 1;

                --EXCEPTION
                --  --如果沒有則設為1
                --  WHEN NO_DATA_FOUND THEN

                --    XID_SEQ := 1;

            END;

            --交易編號(XTRANSACTION_NO)：若傳入參數『優惠方案(FEE_CHOICE)』為”2.優惠券
            --取得系統「TRANSACTION_NO」自編流水號
            IF WFEE_CHOICE = '2' THEN

                -- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
                --                     調整優惠券交易單號 由ECS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL 改從 ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL 取得
                SELECT ECS.SEQ_COUPON_TRANSACTION_NO.NEXTVAL AS TRANSACTION_NO
                  INTO XTRANSACTION_NO　
                  FROM DUAL;

            END IF;

            --IP分成四段
            XIP_A := SUBSTR(WIP_ADR, 1,INSTR(WIP_ADR, '.', 1, 1)-1);
            XIP_B := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 1)+1, INSTR(WIP_ADR, '.', 1, 2) - INSTR(WIP_ADR, '.', 1, 1)-1);
            XIP_C := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 2)+1, INSTR(WIP_ADR, '.', 1, 3) - INSTR(WIP_ADR, '.', 1, 2)-1);
            XIP_D := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 3)+1,4);

            --公開說明書
            IF WPROSPECTUS = 'Y' THEN

                XPROSPECTUS := '5';

            END IF;

            --專案碼
            IF WFEE_CHOICE = '1' OR WFEE_CHOICE = '4' THEN

                XPROJECT_CODE    := WPROJECT_CODE;

            ELSE

                XPROJECT_CODE    := '';

            END IF;

            --2：定期定額
            IF WSHOP_TYPE = '2' THEN

                XPRODUCT_TYPE := 'P8';
                XRAISE_ROI := NULL;
                XRAISE_AMOUNT := NULL;
                XREDUCE_ROI := NULL;
                XREDUCE_AMOUNT := NULL;
                XUSE_TYPE := '2';

            END IF;

            --3：定期不定額
            IF WSHOP_TYPE = '3' THEN

                XPRODUCT_TYPE := 'P9';
                XRAISE_ROI := WRAISE_ROI * 0.01;
                XRAISE_AMOUNT := WRAISE_AMOUNT;
                XREDUCE_ROI := WREDUCE_ROI * 0.01;
                XREDUCE_AMOUNT := WREDUCE_AMOUNT;
                XUSE_TYPE := '3';

            END IF;

            --2018.03.27 MOD BY JIM 新增備註邏輯
            --備註
            SELECT '新委託;'    ||
                   FUND.FUND_NO ||
                   FUND.NAME    ||
                   ';每月'      || WAC_DAY || '號交易日;' ||
                   '扣款帳號'   || FIS_BANK.SNAME || WAC_CODE || ';' ||
                   CASE WHEN XPRODUCT_TYPE = 'P8' THEN '金額' || ROUND(WAMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;'
                        WHEN XPRODUCT_TYPE = 'P9' THEN '基準扣款金額' || ROUND(WAMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;' ||
                                                       '加碼' || ROUND(WRAISE_ROI,1) || '%;' ||
                                                       '加碼金額' || ROUND(WRAISE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;' ||
                                                       '減碼' || ROUND(WREDUCE_ROI,1) || '%;' ||
                                                       '減碼金額' || ROUND(WREDUCE_AMOUNT,V_FUND_CRNCY.AMT_DECIMAL) || '元;'
                   END AS AMOUNT
              INTO XREMARK
              FROM FAS.FUND
              JOIN FAS.FIS_BANK
                ON FIS_BANK.BANK_NO = WBANK_NO
              JOIN ECS.V_FUND_CRNCY
                ON V_FUND_CRNCY.CURRENCY_NO = WCURRENCY_NO
             WHERE FUND.FUND_NO = XFUND_NO;

            --寫入【EC定額(ECS.RSP)】檔
            -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
            INSERT INTO ECS.RSP
            (ID                   --ID
            ,ID_SEQ               --契約序號
            ,FUND_NO              --基金別
            ,AMOUNT               --申購價金
            ,AC_DAY               --約定交易日

            ,BANK_NO              --銀行代號
            ,BRANCH_NO            --分行代號
            ,AC_CODE              --銀行帳號
            ,STATUS               --契約狀態 0：退件；1：收件；2：送交核印；3：核印完成；
                                  --4：有效；5：未核先轉；6：作廢；7：暫停扣款；8：停止扣款

            ,CREATION_DATE        --建檔日期(含時分秒)
            ,REVISION_DATE        --修改日期(含時分秒)
            ,FIRST_TX_DATE         --第一次交易日期
            ,EXPECTED_TX_DATE     --預計交易日期
            ,CURRENCY_NO          --幣別
            ,AC_NAME              --戶名

            ,PROSPECTUS           --公開說明書
            ,IP_A                 --IP A
            ,IP_B                 --IP B
            ,IP_C                 --IP C
            ,IP_D                 --IP D

            ,INVESTMENT_RISK      --投資風險評估
            ,CHANNEL_EXPOSE       --通路報酬揭露
            ,PROJECT_CODE         --專案碼
            ,PRODUCT_TYPE         --產品類別 定額='P8'/不定額='P9'
            ,RAISE_ROI            --加碼點(%)

            ,RAISE_AMOUNT         --加碼金額
            ,REDUCE_ROI            --減碼點(%)
            ,REDUCE_AMOUNT         --減碼金額
            ,ONSHORE_SHORT_TRADE  --境內短線交易(Y/N)
            ,FEE_CHOICE           --優惠方案；1：促銷活動；2：優惠券； 4：身分別

            ,SC_RATE              --契約手續費率
            ,TRANSACTION_NO       --交易編號(FOR 優惠券使用)
            ,COUPON_ID            --優惠券號碼
            ,EXPECTED_TX_DATE_CHG --異動後首次扣款日
            )
            VALUES
            (XID
            ,XID_SEQ
            ,XFUND_NO
            ,WAMOUNT
            ,WAC_DAY

            ,WBANK_NO
            ,WAC_BRANCH
            ,WAC_CODE
            ,'1'                  -- 2018.05.31 Jim 從 4:有效 調整為 1:收件

            ,XSYS_DTTM
            ,XSYS_DTTM
            ,NULL                 -- 2018.05.31 Jim 改為NULL
            ,XEXPECTED_TX_DATE
            ,WCURRENCY_NO
            ,WAC_NAME

            ,XPROSPECTUS
            ,XIP_A
            ,XIP_B
            ,XIP_C
            ,XIP_D

            ,WINVESTMENT_RISK
            ,WCHANNEL_EXPOSE
            ,XPROJECT_CODE
            ,XPRODUCT_TYPE
            ,XRAISE_ROI

            ,XRAISE_AMOUNT
            ,XREDUCE_ROI
            ,XREDUCE_AMOUNT
            ,WONSHORE_SHORT_TRADE
            ,WFEE_CHOICE

            ,WSC_RATE
            ,XTRANSACTION_NO
            ,WCOUPON_ID
            ,NVL(TRUNC(WEXPECTED_TX_DATE),TO_DATE(19000101,'YYYYMMDD'))
            );

            --寫入【EC(不)定額異動紀錄(ECS.RSP_LOG)】檔
            -- 2019.01.25 yunchu 增加欄位(異動後首次扣款日)
            INSERT INTO ECS.RSP_LOG
            (ID                   --ID
            ,ID_SEQ               --契約序號
            ,FUND_NO              --基金別
            ,AMOUNT               --申購價金
            ,AC_DAY               --約定交易日

            ,BANK_NO              --銀行代號
            ,BRANCH_NO            --分行代號
            ,AC_CODE              --銀行帳號
            ,STATUS               --契約狀態 0：退件；1：收件；2：送交核印；3：核印完成；
                                  --4：有效；5：未核先轉；6：作廢；7：暫停扣款；8：停止扣款

            ,REVISION_DATE        --修改日期(含時分秒)
            ,REMARK               --備註
            ,ACTION_TYPE          --交易動作(A:新增/M:修改/D:刪除)
            ,EXPECTED_TX_DATE     --預計交易日期
            ,CURRENCY_NO          --幣別
            ,AC_NAME              --戶名

            ,PROSPECTUS           --公開說明書
            ,IP_A                 --IP A
            ,IP_B                 --IP B
            ,IP_C                 --IP C
            ,IP_D                 --IP D

            ,INVESTMENT_RISK      --投資風險評估
            ,CHANNEL_EXPOSE       --通路報酬揭露
            ,PROJECT_CODE         --專案碼
            ,PRODUCT_TYPE         --產品類別 定額='P8'/不定額='P9'
            ,RAISE_ROI            --加碼點(%)

            ,RAISE_AMOUNT         --加碼金額
            ,REDUCE_ROI           --減碼點(%)
            ,REDUCE_AMOUNT        --減碼金額
            ,ONSHORE_SHORT_TRADE  --境內短線交易(Y/N)
            ,FEE_CHOICE           --優惠方案；1：促銷活動；2：優惠券； 4：身分別

            ,SC_RATE              --契約手續費率
            ,TRANSACTION_NO       --交易編號(FOR 優惠券使用)
            ,COUPON_ID            --優惠券號碼
            ,EXPECTED_TX_DATE_CHG --異動後首次扣款日
            )
            VALUES
            (XID
            ,XID_SEQ
            ,XFUND_NO
            ,WAMOUNT
            ,WAC_DAY

            ,WBANK_NO
            ,WAC_BRANCH
            ,WAC_CODE
            ,'1'                  -- 2018.05.31 Jim 從 4:有效 調整為 1:收件

            ,XSYS_DTTM
            ,XREMARK
            ,'A'
            ,XEXPECTED_TX_DATE
            ,WCURRENCY_NO
            ,WAC_NAME

            ,XPROSPECTUS
            ,XIP_A
            ,XIP_B
            ,XIP_C
            ,XIP_D

            ,WINVESTMENT_RISK
            ,WCHANNEL_EXPOSE
            ,XPROJECT_CODE
            ,XPRODUCT_TYPE
            ,XRAISE_ROI

            ,XRAISE_AMOUNT
            ,XREDUCE_ROI
            ,XREDUCE_AMOUNT
            ,WONSHORE_SHORT_TRADE
            ,WFEE_CHOICE

            ,WSC_RATE
            ,XTRANSACTION_NO
            ,WCOUPON_ID
            ,NVL(TRUNC(WEXPECTED_TX_DATE),TO_DATE(19000101,'YYYYMMDD'))
            );

            --若『優惠方案(FEE_CHOICE)』 = ”2.優惠券”，寫入優待券資料
            IF WFEE_CHOICE = '2' THEN

                --將優惠券號碼寫入【優惠券使用記錄(ECS.COUPON_DETAILS)】檔
                INSERT INTO ECS.COUPON_DETAILS
                (COUPON_ID         --優惠券號碼
                ,TRANSACTION_NO    --交易編號
                ,USE_TYPE          --使用類別
                )
                VALUES
                (WCOUPON_ID
                ,XTRANSACTION_NO
                ,XUSE_TYPE
                );

                --將優惠券號碼寫入【優惠券歷史使用明細(ECS.COUPON_HISTORY)】檔
                INSERT INTO ECS.COUPON_HISTORY
                (COUPON_ID         --優惠券號碼
                ,ID                --受益人ID
                ,TX_DATE           --交易日期
                ,TRANSACTION_NO    --交易編號
                ,USE_TYPE          --使用類別
                )
                VALUES
                (WCOUPON_ID
                ,XID
                ,XTX_DATE
                ,XTRANSACTION_NO
                ,XUSE_TYPE
                );

                --更新【優惠券配發資料(ECS.COUPON_DATA)】檔
                UPDATE ECS.COUPON_DATA
                   SET IS_EFFECT = 'N'            --有效否 Y：有效；N：無效
                       -- 2020.04.06 ChengYu 【優惠券配發資料(ECS.COUPON_DATA)】的欄位USED_DATE(使用日期)儲存值修改為系統日
                       ,USED_DATE = TRUNC(XSYS_DTTM) --使用日期
                       ,USE_TYPE = XUSE_TYPE      --使用類別
                       ,UPDATEID = 'ECS'          --最後修改者
                       ,UPDATEDATE = XSYS_DTTM    --最後修改日期
                 WHERE COUPON_ID = WCOUPON_ID
                   -- 2018.05.21 Jim 補上條件
                   AND ID = XID;

            END IF;

            OPEN OUTDT FOR
            SELECT XID_SEQ AS ID_SEQ
                   ,XID    AS ID
              FROM DUAL;

        END;

    END;
    END IF;

END s_SaveShoppingCar;

/

  GRANT EXECUTE ON "ECS"."S_SAVESHOPPINGCAR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SAVESWITCHDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SAVESWITCHDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/04/23
-- Description: 儲存轉申購委託交易資料
-- 2018.05.10 MOD BY JIM 新增ROBO_BATCH_NO、COUPON_ID、USED_POINT、SERVICE_CHARGE，
-- 但ROBO_BATCH_NO因TABLE架構還沒改，所以尚未INSERT
-- 2018.05.21 MOD BY JIM 補上ECS.COUPON_DATA ID的條件
-- 2018.05.31 MOD BY JIM 解開註解傳入參數ROBO_BATCH_NO 
-- 2018.07.03 ChengYu SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由 FAS 改從ECS取得
-- 2018.07.03 ChengYu 抓取資料表 FAS.BROKER_ACCOUNT 時，加上 轉入基金計價幣別 來當塞選條件
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
-- 2018.07.17 ChengYu 寫入【EC買回(ECS.REDEMPTION)】欄位 IS_EMAIL(是否已emal) 固定為 X
-- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
-- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
-- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
-- 2019.04.29 tingting 調整使用紅利點數折抵時，則申購手續費=0
-- 2019.05.07 tingting 調整使用紅利點數折抵時，則申購手續費率=0(因瀚亞在執行轉申購的時候(FAS239)，手續費會抓取原手續費率重新做計算)
-- 2019.06.26 tingting 依據轉申購日期，調整交易日期、淨值日期
-- 2020.04.06 ChengYu 【優惠券配發資料(ECS.COUPON_DATA)】的欄位USED_DATE(使用日期)儲存值修改為系統日
-- 2020.05.04 因應Merge 重新調整寫法(之後再做復原)
-- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
-- =============================================
(
    WACCOUNT_NO             INTEGER,        --受益人戶號
    WIP_ADR                 VARCHAR2,       --IP位址
    WFUND_CATEGORY_OUT      VARCHAR2,       --買回基金境內外識別碼
    WFUND_NO_OUT            VARCHAR2,       --買回基金代碼
    WTRADE_CRNCY            VARCHAR2,       --買回基金申購幣別
    WTX_DATE                DATE,           --買回交易日期
    WAC_DATE                DATE,           --買回計算淨值日期
    WREDEMPTION_TYPE        VARCHAR2,       --轉申購方式
    WAPPLICATION_SHARE      DECIMAL,        --買回單位數
    WFUND_NO_IN             VARCHAR2,       --轉入基金代碼
    WCURRENCY_NO            VARCHAR2,       --轉入基金計價幣別
    WSWITCH_DATE            DATE,           --轉申購日期
    WFEE_CHOICE             VARCHAR2,       --優惠方案
    WPROJECT_CODE           VARCHAR2,       --促銷活動代碼
    WCOUPON_ID              VARCHAR2,       --優惠券代碼
    WUSED_POINT             INTEGER,        --使用紅利點數
    WSC_RATE                DECIMAL,        --申購手續費率
    WSERVICE_CHARGE         DECIMAL,        --轉申購手續費
    WPROSPECTUS             VARCHAR2,       --勾選公開說明書(及投資人須知)
    WCHANNEL_EXPOSE         VARCHAR2,       --勾選境外基金通路報酬揭露
    WONSHORE_SHORT_TRADE    VARCHAR2,       --勾選境內基金短線交易
    WINVESTMENT_RISK        VARCHAR2,       --勾選投資風險預告書
    OUTDT                   OUT SYS_REFCURSOR
) IS

    XSYS_DTTM        DATE:=SYSDATE;         --系統日期時間
    XID              VARCHAR2(10);          --受益人ID
    XFUND_MASTER_OUT VARCHAR2(5);           --買回基金主基金代碼
    XFUND_MASTER_IN  VARCHAR2(5);           --轉入基金主基金代碼
    -- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
    XSER_NO          VARCHAR2(4);           --交易序號
    XBROKER_NO       VARCHAR2(3):='999';    --代銷單位
    XBRANCH_NO       VARCHAR2(4):='8300';   --代銷分公司碼
    XYEAR            NUMBER(4);             --年分
    XTRANSACTION_NO  INTEGER;               --交易編號(FOR 紅利使用)
    XTX_DATE         DATE:=TRUNC(WTX_DATE);	--交易日期(YYYY/MM/DD)
    XAC_DATE         DATE;                  --轉申購日期
    XPROSPECTUS      VARCHAR2(1);           --公開說明書
    XIP_A            VARCHAR2(3);           --第一段IP
    XIP_B            VARCHAR2(3);           --第二段IP
    XIP_C            VARCHAR2(3);           --第三段IP
    XIP_D            VARCHAR2(3);           --第四段IP

    XAC_BANK_NO      VARCHAR2(3);           --買回銀行
    XAC_BRANCH_NO    VARCHAR2(4);           --買回分行
    XFIS_SNAME       VARCHAR2(15);          --買回銀行簡稱
    XAC_CODE         VARCHAR2(20);          --買回帳號
    XAC_NAME         VARCHAR2(100);         --買回帳號戶名
    XCURRENCY_NO     VARCHAR2(3);           --買回帳戶幣別
    XUSED_POINT      INTEGER;               --使用紅利
    XSC_RATE         DECIMAL := WSC_RATE;   --申購手續費率
    XSERVICE_CHARGE  NUMBER(12,2);          --轉申購手續費
    -- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
    XTRADE_TYPE      VARCHAR2(1) := '2';    --交易種類(1.申購 2:贖回)

BEGIN

    --取得受益人ID
    BEGIN

        SELECT ID INTO XID
          FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    --取得買回基金主基金代碼
    BEGIN

        SELECT FUND_MASTER_NO INTO XFUND_MASTER_OUT
          FROM FAS.FUND
         WHERE FUND_NO = WFUND_NO_OUT;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, WFUND_NO_OUT || '無法取得主基金別，請檢查！');

    END;

    --取得轉入基金主基金代碼
    BEGIN

        SELECT FUND_MASTER_NO INTO XFUND_MASTER_IN
          FROM FAS.FUND
         WHERE FUND_NO = WFUND_NO_IN;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN
                RAISE_APPLICATION_ERROR(-20000, WFUND_NO_IN || '無法取得主基金別，請檢查！');

    END;

    --取得年分
    XYEAR := EXTRACT(YEAR FROM WTX_DATE);

    --交易序號
    -- 2018.10.30 tingting 因應ECS.F_GETTXNO增加傳入參數進行調整
    XSER_NO := ECS.F_GETTXNO(XYEAR,XBROKER_NO,XBRANCH_NO,WFUND_NO_OUT,XTRADE_TYPE);

    --取得買回匯入帳戶相關欄位
    BEGIN

        IF WFUND_CATEGORY_OUT = '1' AND XFUND_MASTER_OUT = XFUND_MASTER_IN THEN
        BEGIN

            SELECT  FUND.RED_BANK_NO    --買回銀行
                   ,FUND.RED_BRANCH_NO  --買回分行
                   ,FIS_BANK.SNAME      --買回銀行簡稱
                   ,FUND.RED_AC_CODE    --買回帳號
                   ,FUND.AC_NAME        --買回帳號戶名
                   ,FUND.CURRENCY_NO    --買回帳戶幣別
              INTO  XAC_BANK_NO
                   ,XAC_BRANCH_NO
                   ,XFIS_SNAME
                   ,XAC_CODE
                   ,XAC_NAME
                   ,XCURRENCY_NO
              FROM FAS.FUND FUND
              JOIN FAS.FIS_BANK FIS_BANK
                ON FIS_BANK.BANK_NO = FUND.RED_BANK_NO
             WHERE FUND.FUND_NO = WFUND_NO_IN;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, WFUND_NO_IN || '無法取得買回匯入帳戶相關欄位，請檢查！');

        END;
        END IF;

        IF (WFUND_CATEGORY_OUT = '1' AND XFUND_MASTER_OUT != XFUND_MASTER_IN)
            OR (WFUND_CATEGORY_OUT = '2') THEN
        BEGIN

            SELECT  BROKER_ACCOUNT.BANK_NO	    --買回銀行
                   ,BROKER_ACCOUNT.BRANCH_NO    --買回分行
                   ,BROKER_ACCOUNT.FIS_SNAME    --買回銀行簡稱
                   ,BROKER_ACCOUNT.AC_CODE      --買回帳號
                   ,BROKER_ACCOUNT.AC_NAME      --買回帳號戶名
                   ,BROKER_ACCOUNT.CURRENCY_NO  --買回帳戶幣別
              INTO  XAC_BANK_NO
                   ,XAC_BRANCH_NO
                   ,XFIS_SNAME
                   ,XAC_CODE
                   ,XAC_NAME
                   ,XCURRENCY_NO
              FROM FAS.BROKER_ACCOUNT
             WHERE BROKER_ACCOUNT.FUND_NO = WFUND_NO_IN
               -- 2018.07.03 ChengYu 抓取資料表 FAS.BROKER_ACCOUNT 時，加上 轉入基金計價幣別 來當塞選條件
               AND BROKER_ACCOUNT.CURRENCY_NO = WCURRENCY_NO
               AND BROKER_ACCOUNT.BROKER_NO = '999';

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    RAISE_APPLICATION_ERROR(-20000, WFUND_NO_IN || '無法取得買回匯入帳戶相關欄位，請檢查！');

        END;
        END IF;

    END;

    --交易編號(XTRANSACTION_NO)：若傳入參數『優惠方案(FEE_CHOICE)』為”2.優惠券或或3.紅利折抵”
    --取得系統「TRANSACTION_NO」自編流水號
    IF WFEE_CHOICE = '2' OR WFEE_CHOICE = '3' THEN

        -- 2018.07.03 ChengYu SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由 FAS 改從ECS取得
        -- 2018.11.09 tingting 調整紅利交易單號 SEQ_REWARD_TRANSACTION_NO.NEXTVAL 由ECS改從FAS取得
        SELECT FAS.SEQ_REWARD_TRANSACTION_NO.NEXTVAL AS TRANSACTION_NO
          INTO XTRANSACTION_NO　
          FROM DUAL;

    END IF;

    --公開說明書
    IF WPROSPECTUS = 'Y' THEN

        XPROSPECTUS := '5';

    END IF;

    --優惠方案(@FEE_CHOICE)』=”3. 紅利折抵”
    IF WFEE_CHOICE = '3' THEN

        XUSED_POINT := WUSED_POINT;
        -- 2019.04.29 tingting 調整使用紅利點數折抵時，則申購手續費=0
        XSERVICE_CHARGE := 0;
        -- 2019.05.07 tingting 調整使用紅利點數折抵時，則申購手續費率=0(因瀚亞在執行轉申購的時候(FAS239)，手續費會抓取原手續費率重新做計算)
        XSC_RATE := 0;

    ELSE

        XUSED_POINT := NULL;
        XSERVICE_CHARGE := NULL;

    END IF;

    --IP分成四段
    XIP_A := SUBSTR(WIP_ADR, 1,INSTR(WIP_ADR, '.', 1, 1)-1);
    XIP_B := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 1)+1, INSTR(WIP_ADR, '.', 1, 2) - INSTR(WIP_ADR, '.', 1, 1)-1);
    XIP_C := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 2)+1, INSTR(WIP_ADR, '.', 1, 3) - INSTR(WIP_ADR, '.', 1, 2)-1);
    XIP_D := SUBSTR(WIP_ADR, INSTR(WIP_ADR, '.', 1, 3)+1,4);

    -- 2020.05.04 因應Merge 重新調整寫法(之後再做復原)
    XAC_DATE := WAC_DATE;
    -- 2019.06.26 tingting 依據轉申購日期，調整交易日期、淨值日期
    --IF WSWITCH_DATE IS NOT NULL AND XTX_DATE < WSWITCH_DATE THEN

    --    XTX_DATE := WSWITCH_DATE;

    --    SELECT ECS.F_GetNavDate_Redem(WFUND_NO_OUT,XTX_DATE) 
    --      INTO XAC_DATE
    --      FROM DUAL;

    --END IF;

	--傳入參數資料寫入【EC買回(ECS.REDEMPTION)】檔
    INSERT INTO ECS.REDEMPTION
    (FUND_NO                --基金別
    ,ID                     --ID
    ,TX_DATE                --交易日期
    ,BROKER_NO              --代銷單位
    ,BRANCH_NO              --代銷分公司碼

    ,SER_NO                 --交易序號
    ,REDEMPTION_TYPE        --買回方式(W:全贖/S:部份)
    ,APPLICATION_SHARE      --買回單位數
    ,AC_BANK                --買回銀行
    ,AC_BRANCH              --買回分行

    ,AC_FIS_SNAME           --買回銀行簡稱
    ,AC_CODE                --買回帳號
    ,FUND_NO_IN             --轉申購基金別
    ,REVISION_DATE          --修改日期(含時分秒)
    ,IS_EMAIL               --是否已emal(N:尚未寄出/Y: 已寄出)

    ,STATUS                 --交易狀態(O: 委託中/C:已確認/P:已結帳)
    ,RESULT_CODE            --交易結果(00:成功/01:失敗)
    ,AC_NAME                --戶名
    ,AC_DATE                --淨值日
    ,CURRENCY_NO            --幣別

    ,BANK_CURRENCY_NO       --銀行幣別
    ,PROSPECTUS             --公開說明書
    ,IP_A                   --IP A
    ,IP_B                   --IP B
    ,IP_C                   --IP C

    ,IP_D                   --IP D
    ,INVESTMENT_RISK        --投資風險評估
    ,CHANNEL_EXPOSE         --通路報酬揭露
    ,ONSHORE_SHORT_TRADE    --境內短線交易(Y/N)
    ,ROBO_CONTRACT_NO       --ROBO契約書號
    ,ROBO_SER_NO            --ROBO交易書號
    ,PAY_DATE               --預計買回入帳日期

    ,SWITCH_DATE            --預計轉申購日期
    ,FEE_CHOICE             --優惠方案(1：促銷活動；3：紅利折抵；4：身分別；5：生日優惠)
    ,SC_RATE                --轉申購手續費率
    ,PROJECT_CODE           --專案碼
    ,USED_POINT             --使用紅利

    ,TRANSACTION_NO         --交易編號(FOR 紅利及優惠券使用)
    ,COUPON_ID              --優惠券號碼
    ,SERVICE_CHARGE         --轉申購手續費
    -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
    ,ROBO_BATCH_NO          --ROBO再平衡批次編號
    )
    VALUES
    (WFUND_NO_OUT
    ,XID
    ,XTX_DATE
    ,XBROKER_NO
    ,XBRANCH_NO

    ,XSER_NO
    ,WREDEMPTION_TYPE
    ,WAPPLICATION_SHARE
    ,XAC_BANK_NO
    ,XAC_BRANCH_NO

    ,XFIS_SNAME
    ,XAC_CODE
    ,WFUND_NO_IN
    ,XSYS_DTTM
    --2018.07.17 ChengYu 寫入【EC買回(ECS.REDEMPTION)】欄位 IS_EMAIL(是否已emal) 固定為 X
    ,'X'

    ,'O'
    ,'00'
    ,XAC_NAME
    ,XAC_DATE
    ,WTRADE_CRNCY

    ,WCURRENCY_NO
    ,XPROSPECTUS
    ,XIP_A
    ,XIP_B
    ,XIP_C

    ,XIP_D
    ,WINVESTMENT_RISK
    ,WCHANNEL_EXPOSE
    ,WONSHORE_SHORT_TRADE
    ,NULL
    ,NULL
    ,NULL

    ,WSWITCH_DATE
    ,WFEE_CHOICE
    ,XSC_RATE
    ,WPROJECT_CODE
    ,XUSED_POINT

    ,XTRANSACTION_NO
    ,WCOUPON_ID
    ,XSERVICE_CHARGE
    -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
    ,NULL
    );

    --傳入參數資料寫入【EC買回異動紀錄(ECS.REDEMPTION_LOG)】檔
    INSERT INTO ECS.REDEMPTION_LOG
    (FUND_NO                  --基金別
    ,ID                       --ID
    ,TX_DATE                  --交易日期
    ,BROKER_NO                --代銷單位
    ,BRANCH_NO                --代銷分公司碼

    ,SER_NO                   --交易序號
    ,REDEMPTION_TYPE          --買回方式(W:全贖/S:部份)
    ,APPLICATION_SHARE        --買回單位數
    ,AC_BANK                  --買回銀行
    ,AC_BRANCH                --買回分行

    ,AC_FIS_SNAME             --買回銀行簡稱
    ,AC_CODE                  --買回帳號
    ,FUND_NO_IN               --轉申購基金別
    ,ACTION_TYPE              --交易動作(A:新增/M:修改/D:刪除)
    ,REVISION_DATE            --修改日期(含時分秒)

    ,AC_NAME                  --戶名
    ,AC_DATE                  --淨值日
    ,CURRENCY_NO              --幣別
    ,BANK_CURRENCY_NO         --銀行幣別
    ,PROSPECTUS               --公開說明書

    ,IP_A                     --IP A
    ,IP_B                     --IP B
    ,IP_C                     --IP C
    ,IP_D                     --IP D
    ,INVESTMENT_RISK          --投資風險評估

    ,CHANNEL_EXPOSE           --通路報酬揭露
    ,ONSHORE_SHORT_TRADE      --境內短線交易(Y/N)
    ,ROBO_CONTRACT_NO         --ROBO契約書號
    ,ROBO_SER_NO              --ROBO交易書號
    ,PAY_DATE                 --預計買回入帳日期
    ,SWITCH_DATE              --預計轉申購日期
    ,FEE_CHOICE               --優惠方案(1：促銷活動；3：紅利折抵；4：身分別；5：生日優惠)

    ,SC_RATE                  --轉申購手續費率
    ,PROJECT_CODE             --專案碼
    ,USED_POINT               --使用紅利

    ,TRANSACTION_NO           --交易編號(FOR 紅利及優惠券使用)
    ,COUPON_ID                --優惠券號碼
    ,SERVICE_CHARGE           --轉申購手續費
    -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
    ,ROBO_BATCH_NO          --ROBO再平衡批次編號
    )
    VALUES
    (WFUND_NO_OUT
    ,XID
    ,XTX_DATE
    ,XBROKER_NO
    ,XBRANCH_NO

    ,XSER_NO
    ,WREDEMPTION_TYPE
    ,WAPPLICATION_SHARE
    ,XAC_BANK_NO
    ,XAC_BRANCH_NO

    ,XFIS_SNAME
    ,XAC_CODE
    ,WFUND_NO_IN
    ,'A'
    ,XSYS_DTTM

    ,XAC_NAME
    ,XAC_DATE
    ,WTRADE_CRNCY
    ,WCURRENCY_NO
    ,XPROSPECTUS

    ,XIP_A
    ,XIP_B
    ,XIP_C
    ,XIP_D
    ,WINVESTMENT_RISK

    ,WCHANNEL_EXPOSE
    ,WONSHORE_SHORT_TRADE
    ,NULL
    ,NULL
    ,NULL
    ,WSWITCH_DATE
    ,WFEE_CHOICE

    ,XSC_RATE
    ,WPROJECT_CODE
    ,XUSED_POINT

    ,XTRANSACTION_NO
    ,WCOUPON_ID
    ,XSERVICE_CHARGE
    -- 2018.05.31 解開註解傳入參數ROBO_BATCH_NO MOD BY JIM
    ,NULL
    );

    --若『優惠方案(FEE_CHOICE)』 = ”3.紅利折抵”，寫入紅利資料
    IF WFEE_CHOICE = '3' THEN
    BEGIN

        DECLARE CURSOR REWARDLIST IS 
                SELECT  REWARD_POINT.REWARD_NO
                       -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                       ,REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) AS CAN_USE_POINT     --可使用點數(紅利點數 - 使用點數 - 預扣點數)
                  FROM FAS.REWARD_POINT
                  -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                  LEFT JOIN (
							 -- 2020.01.21 by Chengyu 修正紅利點數取得判斷式(使用紅利編號做Key)
							 --還沒真正被使用的預扣點數
							 SELECT  REWARD_POINT.REWARD_NO
							        ,SUM(REWARD_DETAILS.USED_POINT) USED_POINT
							   FROM FAS.REWARD_HISTORY REWARD_HISTORY    --紅利歷史使用明細
							   JOIN FAS.REWARD_DETAILS REWARD_DETAILS    --紅利使用點數
							     ON REWARD_DETAILS.TRANSACTION_NO = REWARD_HISTORY.TRANSACTION_NO
							    AND REWARD_DETAILS.USE_TYPE = REWARD_HISTORY.USE_TYPE
							   JOIN FAS.REWARD_POINT REWARD_POINT        --紅利配發資料
							     ON REWARD_POINT.REWARD_NO = REWARD_DETAILS.REWARD_NO
							  WHERE REWARD_HISTORY.ID = XID
							    AND REWARD_HISTORY.TX_TYPE = 'W'         --交易類別 C：新增 W：預扣 U：使用
							  GROUP BY REWARD_POINT.REWARD_NO
							  ORDER BY REWARD_POINT.REWARD_NO
                       ) REWARD_POINT_W         --紅利配發資料(預扣)
                    ON REWARD_POINT_W.REWARD_NO = REWARD_POINT.REWARD_NO
                 WHERE REWARD_POINT.ID = XID
                   AND REWARD_POINT.VALID_FROM <= XTX_DATE
                   AND REWARD_POINT.VALID_THRU >= XTX_DATE
                   -- 2018.11.07 tingting 調整紅利折抵，在取可使用點數時，要扣除預扣點數
                   AND REWARD_POINT.REWARD_POINT - REWARD_POINT.USED_POINT - NVL(REWARD_POINT_W.USED_POINT,0) > 0
                 ORDER BY REWARD_POINT.VALID_THRU
                         ,REWARD_POINT.REWARD_NO;
        --沖銷紅利變數
        XNOT_USE_POINT      INTEGER := NVL(XUSED_POINT,0);      --待沖銷紅利點數
        XCAN_USE_POINT      INTEGER;                            --可沖銷紅利點數

        BEGIN

            FOR ITEM IN REWARDLIST
            LOOP

                EXIT WHEN XNOT_USE_POINT = 0 ;

                XCAN_USE_POINT := CASE WHEN XNOT_USE_POINT > ITEM.CAN_USE_POINT THEN ITEM.CAN_USE_POINT ELSE XNOT_USE_POINT END; 

                -- 將沖銷資料寫入【紅利使用點數(FAS.REWARD_DETAILS)】檔
                INSERT INTO FAS.REWARD_DETAILS
                (TRANSACTION_NO                --交易編號
                ,REWARD_NO                     --紅利編號
                ,USED_POINT                    --使用點數
                ,USE_TYPE                      --交易類別 1：單筆申購；2：轉申購
                )
                VALUES
                (XTRANSACTION_NO
                ,ITEM.REWARD_NO
                ,XCAN_USE_POINT
                ,'2'
                );

                XNOT_USE_POINT := XNOT_USE_POINT - XCAN_USE_POINT;

            END LOOP;

            -- 2018.10.09 yunchu 調整沖銷資料寫入紅利歷史使用明細檔因紅利折抵多筆造成PK重覆問題
            -- 將沖銷資料寫入【紅利歷史使用明細(FAS.REWARD_HISTORY)】檔
            INSERT INTO FAS.REWARD_HISTORY
            (ID                            --受益人ID
            ,TX_DATE                       --交易日期
            ,TX_TYPE                       --交易類別 C：新增；Ｗ：預扣；Ｕ：使用
            ,USED_POINT                    --使用點數
            ,TRANSACTION_NO                --交易編號
            ,USE_TYPE                      --交易類別 1：單筆申購；2：轉申購
            )
            VALUES
            (XID
            ,XTX_DATE
            ,'W'
            ,NVL(XUSED_POINT,0)
            ,XTRANSACTION_NO
            ,'2'
            );

        END;

    END;
    END IF;

    --若『優惠方案(FEE_CHOICE)』 = ”2.優惠券”，寫入優待券資料
    IF WFEE_CHOICE = '2' THEN

        --將優惠券號碼寫入【優惠券使用記錄(ECS.COUPON_DETAILS)】檔
        INSERT INTO ECS.COUPON_DETAILS
        (COUPON_ID         --優惠券號碼
        ,TRANSACTION_NO    --交易編號
        ,USE_TYPE          --使用類別
        )
        VALUES
        (WCOUPON_ID
        ,XTRANSACTION_NO
        ,'4'
        );

        --將優惠券號碼寫入【優惠券歷史使用明細(ECS.COUPON_HISTORY)】檔
        INSERT INTO ECS.COUPON_HISTORY
        (COUPON_ID         --優惠券號碼
        ,ID                --受益人ID
        ,TX_DATE           --交易日期
        ,TRANSACTION_NO    --交易編號
        ,USE_TYPE          --使用類別
        )
        VALUES
        (WCOUPON_ID
        ,XID
        ,XTX_DATE
        ,XTRANSACTION_NO
        ,'4'
        );

        --更新【優惠券配發資料(ECS.COUPON_DATA)】檔

        UPDATE ECS.COUPON_DATA
           SET  IS_EFFECT = 'N'           --有效否 Y：有效；N：無效
               -- 2020.04.06 ChengYu 【優惠券配發資料(ECS.COUPON_DATA)】的欄位USED_DATE(使用日期)儲存值修改為系統日
               ,USED_DATE = TRUNC(XSYS_DTTM) --使用日期
               ,USE_TYPE = '4'            --使用類別
               ,UPDATEID = 'ECS'          --最後修改者
               ,UPDATEDATE = XSYS_DTTM    --最後修改日期
         WHERE COUPON_ID = WCOUPON_ID
           -- 2018.05.21 JIM 補上ID條件
           AND ID = XID;

    END IF;

    OPEN OUTDT FOR
    SELECT XSER_NO AS SER_NO
      FROM DUAL;

END s_SaveSwitchData;

/

  GRANT EXECUTE ON "ECS"."S_SAVESWITCHDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SEALPROOF_PROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SEALPROOF_PROCESS" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2019/08/22
-- Description: (新戶)核印處理
-- =============================================
(
    WEXEC_USERID     NVARCHAR2,  --執行人員
    WBATCH_ID        NVARCHAR2,  --批次識別碼(每批不可重覆)
    WJOB_ID          NVARCHAR2,  --工作別 1.核印  3.重出文字檔  5.取消該批送核
    WSEAL_TYPE       NVARCHAR2,  --扣款途徑 1.一般 2.ACH  3.財金
    WSEAL_DATE       DATE,       --核印日期
    WAGENT_BANK      NVARCHAR2,  --代理銀行(總行)
    WISAGENTBANK     NVARCHAR2,  --扣款銀行 1.是代理行  2.非代理行  9.指定  0.全部
    WMAX_FILE_COUNT  DECIMAL,    --文字檔筆數限制 (0 表示無限制)
    WNEW_OLD         NVARCHAR2,  --新戶或舊戶  N.新戶  O.舊戶
    WTRP_TYPE        NVARCHAR2,  --連外介面平台種類代碼
    WMEDIA_NO        NVARCHAR2,  --傳檔媒體編號
    WFILE_NAMING_WAY NVARCHAR2,  --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
    WIsSuccess       OUT NVARCHAR2,  --成功否：Y.成功  N.失敗
    WMSG             OUT NVARCHAR2   --訊息：存放錯誤訊息

) IS
BEGIN

  IF WJOB_ID = '1'  THEN --核印
    BEGIN 
    ECS.s_SealProof_Process_1 (WEXEC_USERID,
                               WBATCH_ID,
                               WSEAL_TYPE,
                               WSEAL_DATE,
                               WAGENT_BANK,
                               WISAGENTBANK,
                               WMAX_FILE_COUNT,
                               WNEW_OLD,
                               WTRP_TYPE,
                               WMEDIA_NO,
                               WFILE_NAMING_WAY,
                               WIsSuccess,
                               WMSG);      
    END;

  ELSIF WJOB_ID = '3'  THEN--重出文字檔
    BEGIN 
      WIsSuccess := 'Y';
      WMSG := '';
    END;

  ELSIF WJOB_ID = '5'   THEN--取消該批送核(該批中不可有核印狀態不為"核印中"的資料)
    BEGIN 
      ECS.s_SealProof_Process_5(WEXEC_USERID,WBATCH_ID,WSEAL_TYPE,WIsSuccess,WMSG);
    END;    
  END IF;
END s_SealProof_Process;

/

  GRANT EXECUTE ON "ECS"."S_SEALPROOF_PROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SEALPROOF_PROCESS_1
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SEALPROOF_PROCESS_1" 
-- =============================================
-- Author:stu
-- Create date: 2008/08/12
-- Description:(新戶)送核處理
-- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為3(外幣核印)
-- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號);調整ECS.OFD707【核印重送帳號資料原始檔】刪除條件抓取方式
-- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
-- 2019.11.12 ChengYu 修正ECS.OFD702【扣款帳號核印歷史記錄檔】ACC_SUB_ID(帳號用途碼)存取值
-- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
-- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
-- 2020.03.23 ChengYu 調整TRADE_NO(交易序號)取號條件，調整為每日重新取號
-- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
-- 2020.03.27 ChengYu 調整DELIVERED(送交核印日)儲存條件
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- =============================================
(
    WEXEC_USERID VARCHAR2,  --執行人員
    WBATCH_ID    VARCHAR2,  --批次識別碼(每批不可重覆)
    WSEAL_TYPE   VARCHAR2, --扣款途徑 1.一般 2.ACH  3.財金
    WSEAL_DATE   DATE,     --核印日期
    WAGENT_BANK  VARCHAR2,  --代理銀行(總行)
    WISAGENTBANK VARCHAR2, --扣款銀行 1.是代理行  2.非代理行  9.指定  0.全部
    WMAX_FILE_COUNT INT,  --文字檔筆數限制 (0 表示無限制)
    WNEW_OLD     VARCHAR2,  --新戶或舊戶  N.新戶  O.舊戶
    WTRP_TYPE    VARCHAR2,  --連外介面平台種類代碼
    WMEDIA_NO    VARCHAR2, --傳檔媒體編號
    WFILE_NAMING_WAY VARCHAR2,   --檔名命名方式\1.由前端指定  2.固定名稱(即FILE_ID)  3.變動名稱(即TRP00A檔)
    WIsSuccess   OUT VARCHAR2 ,  --成功否：Y.成功  N.失敗
    WMSG         OUT VARCHAR2       --訊息：存放錯誤訊息

) IS

--變數宣告
XMAX_TRADE_NO    DECIMAL(7);
XSUB_BANK_CODE   VARCHAR2(7);
XSUB_ACC_NO      VARCHAR2(20);
XSUB_ID_NO       VARCHAR2(10);
XRSP_NO          VARCHAR2(20);
XRSP_SRNO        INT;
XRSP_CHG_NO      VARCHAR2(20);
XRSP_CHG_SRNO    INT;
XTRADE_NO        VARCHAR2(16);
XSEAL_USER_NO    VARCHAR2(20);
XSOURCE_CD       VARCHAR2(6);
XISFC            VARCHAR2(1);
XBATCH_SRNO      DECIMAL(3,0);  --次批號
XCRNT_REC_COUNT  DECIMAL(5,0);  --目前處理資料的筆數
XTTL_REC_COUNT   DECIMAL(5,0);  --合乎條件的送核資料總筆數
XErr_Temp        NVARCHAR2(80);
XEFFECT_DATE     DATE;
XUpdateDate      DATE;
XDefaultDate     DATE;
XRSP_SEAL_TYPE   VARCHAR2(6);   --印核方式BY帳號或契約送核 A:帳號;C:契約
XDATE            DATE := SYSDATE;

BEGIN

  WIsSuccess := 'N';
  WMSG := '';
  XMAX_TRADE_NO := 0;
  XUpdateDate := SYSDATE;
  XDefaultDate := TO_DATE('1900/01/01','YYYY/MM/DD');
  --SELECT TOP 1 XRSP_SEAL_TYPE = RSP_SEAL_TYPE FROM CTL015
  XRSP_SEAL_TYPE := 'A';

  IF WSEAL_TYPE != '1' AND WSEAL_TYPE != '2' AND WSEAL_TYPE != '3' THEN
    BEGIN
      WMSG := '扣款途徑不是1.一般 2.ACH  3.財金';
      RETURN;
    END;
  ELSIF WSEAL_TYPE = '2' THEN --2.ACH
    BEGIN
      --找出ACH當日最大的交易序號,若無則為0
      --SELECT XMAX_TRADE_NO = ISNULL(MAX(TRADE_NO),0)
      --  FROM OFD701
      -- WHERE APPL_CFM_CD = 'Y'
      --   AND SEAL_DATE = WSEAL_DATE
      --   AND SEAL_TYPE = WSEAL_TYPE AND TRADE_NO  <>''
      --ACH每一批皆從1開始編
      XMAX_TRADE_NO := 0;
    END;
  ELSIF WSEAL_TYPE = '3' THEN --3.財金
    BEGIN
      --找出財金當年最大的交易序號,若無則為0
      -- 2020.03.23 ChengYu 調整TRADE_NO(交易序號)取號條件，調整為每日重新取號
      SELECT NVL(MAX(TRADE_NO),0)
        INTO XMAX_TRADE_NO
        FROM ECS.OFD701
       WHERE OFD701.APPL_CFM_CD = 'Y'
         AND TRUNC(SEAL_DATE) = TRUNC(WSEAL_DATE)
         AND SEAL_TYPE = WSEAL_TYPE
         AND TRADE_NO IS NOT NULL ;
    END;
  END IF;

  --將OFD701中合乎條件(OFD706)的未核印(含重送核)且確認的資料寫入OFD702中
  IF WSEAL_TYPE = '1' THEN --一般
    BEGIN

      INSERT INTO ECS.OFD702
            (DATA_SEQ,BATCH_ID,BATCH_SRNO,SUB_BANK_CODE,SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,SUB_ID_NO,
             NEW_OLD,SEAL_TYPE,TRADE_TYPE,TRADE_DATE,SEAL_STATUS,SEAL_USER_NO,TRADE_NO,AGENT_BANK,ISRETRY,ACC_SUB_ID,
             -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
             STATUS,CreateID,CreateDate,UpdateID,UpdateDate,
             -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
             -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
             EntryID, EntryDate, VerifyID, VerifyDate, ApproveID, ApproveDate,CRNCY_CD,SOURCE_CD)
      -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
      SELECT (SELECT NVL(MAX(DATA_SEQ),0) FROM ECS.OFD702) + ROWNUM,BATCH_ID,BATCH_SRNO,SUB_BANK_CODE,SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,SUB_ID_NO,
             NEW_OLD,SEAL_TYPE,TRADE_TYPE,TRADE_DATE,'1' SEAL_STATUS,SEAL_USER_NO,
             -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
             ECS.PADLeft(TRADE_NO + ROW_NUMBER() OVER (ORDER BY SEAL_USER_NO),6,'0') AS TRADE_NO,
             AGENT_BANK,ISRETRY,ACC_SUB_ID,
             STATUS,CreateID,CreateDate,UpdateID,UpdateDate,
             -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
             EntryID, EntryDate, VerifyID, VerifyDate, ApproveID, ApproveDate,CRNCY_CD,SOURCE_CD
        FROM (
                SELECT WBATCH_ID BATCH_ID,1 BATCH_SRNO,OFD701.SUB_BANK_CODE SUB_BANK_CODE,OFD701.SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,OFD701.SUB_ID_NO,
                       OFD701.NEW_OLD,WSEAL_TYPE SEAL_TYPE,'0' TRADE_TYPE,WSEAL_DATE TRADE_DATE,'1' SEAL_STATUS,SEAL_USER_NO,
                       -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
                       -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
                       XMAX_TRADE_NO TRADE_NO, --(財金)交易序號之起始序號為當年最大交易序號+1起算
                       -- 2019.11.12 ChengYu 修正ECS.OFD702【扣款帳號核印歷史記錄檔】ACC_SUB_ID(帳號用途碼)存取值
                       -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
                       OFD706.AGENT_BANK, 'N' ISRETRY, 'ALL' ACC_SUB_ID,'301' STATUS ,WEXEC_USERID CreateID,XUpdateDate CreateDate,WEXEC_USERID UpdateID,XUpdateDate UpdateDate,
                       WEXEC_USERID EntryID,XUpdateDate EntryDate,WEXEC_USERID VerifyID,XUpdateDate VerifyDate,WEXEC_USERID ApproveID,XUpdateDate ApproveDate,
                       -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
                       -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
                       CASE WHEN (HOLDER_BANK_EC.CURRENCY_NO = 'MMA' OR HOLDER_BANK_EC.CURRENCY_NO = 'FCY') THEN 'ALL' ELSE HOLDER_BANK_EC.CURRENCY_NO END CRNCY_CD,
                       '3' SOURCE_CD
                  FROM ECS.OFD701,FAS.HOLDER_BANK_EC,(SELECT DISTINCT SEAL_TYPE,SUB_BANK_CODE,SUB_ACC_NO,SUB_ID_NO,AGENT_BANK
                                                        FROM ECS.OFD706
                                                       WHERE BATCH_ID = WBATCH_ID) OFD706
                 WHERE OFD701.SUB_BANK_CODE = OFD706.SUB_BANK_CODE
                   AND OFD701.SUB_ACC_NO = OFD706.SUB_ACC_NO
                   AND OFD701.SUB_ID_NO = OFD706.SUB_ID_NO
                   AND OFD701.SEAL_TYPE = OFD706.SEAL_TYPE
                   AND HOLDER_BANK_EC.ID = OFD701.SUB_ID_NO
                   AND HOLDER_BANK_EC.AC_BANK = OFD701.SUB_BANK_CODE
                   AND HOLDER_BANK_EC.AC_CODE = OFD701.SUB_ACC_NO
                   AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
                   AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
                   AND OFD701.SEAL_STATUS IN ('0','9')
                 UNION ALL
                SELECT WBATCH_ID,1,OFD701.SUB_BANK_CODE,OFD701.SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,OFD701.SUB_ID_NO,
                       OFD701.NEW_OLD,WSEAL_TYPE,'0',WSEAL_DATE,'1',SEAL_USER_NO,
                       -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
                       XMAX_TRADE_NO TRADE_NO,
                       OFD706.AGENT_BANK, 'N', 'ALL','301',WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,
                       WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,
                       -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
                       CASE WHEN (HOLDER_BANK_EC_CHANGE.CURRENCY_NO = 'MMA' OR HOLDER_BANK_EC_CHANGE.CURRENCY_NO = 'FCY') THEN 'ALL' ELSE HOLDER_BANK_EC_CHANGE.CURRENCY_NO END CRNCY_CD,
                       '4' SOURCE_CD
                  FROM ECS.OFD701,FAS.HOLDER_BANK_EC_CHANGE,(SELECT DISTINCT SEAL_TYPE,SUB_BANK_CODE,SUB_ACC_NO,SUB_ID_NO,AGENT_BANK
                                                        FROM ECS.OFD706
                                                       WHERE BATCH_ID = WBATCH_ID) OFD706
                 WHERE OFD701.SUB_BANK_CODE = OFD706.SUB_BANK_CODE
                   AND OFD701.SUB_ACC_NO = OFD706.SUB_ACC_NO
                   AND OFD701.SUB_ID_NO = OFD706.SUB_ID_NO
                   AND OFD701.SEAL_TYPE = OFD706.SEAL_TYPE
                   AND HOLDER_BANK_EC_CHANGE.ID = OFD701.SUB_ID_NO
                   AND HOLDER_BANK_EC_CHANGE.NEW_AC_BANK = OFD701.SUB_BANK_CODE
                   AND HOLDER_BANK_EC_CHANGE.NEW_AC_CODE = OFD701.SUB_ACC_NO
                   AND HOLDER_BANK_EC_CHANGE.CURRENCY_NO != 'NTD'
                   AND HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO = '01'
                   AND OFD701.SEAL_STATUS IN ('0','9')
             );

    END;
  ELSE --ACH或財金
    BEGIN
      INSERT INTO ECS.OFD702
            (DATA_SEQ,BATCH_ID,BATCH_SRNO,SUB_BANK_CODE,SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,SUB_ID_NO,
             NEW_OLD,SEAL_TYPE,TRADE_TYPE,TRADE_DATE,SEAL_STATUS,SEAL_USER_NO,TRADE_NO,AGENT_BANK,ISRETRY,ACC_SUB_ID,
             -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
             STATUS,CreateID,CreateDate,UpdateID,UpdateDate,
             -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
             -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
             EntryID, EntryDate, VerifyID, VerifyDate, ApproveID, ApproveDate,CRNCY_CD,SOURCE_CD)
      -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
      SELECT (SELECT NVL(MAX(DATA_SEQ),0) FROM ECS.OFD702) + ROWNUM,BATCH_ID,BATCH_SRNO,SUB_BANK_CODE,SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,SUB_ID_NO,
             NEW_OLD,SEAL_TYPE,TRADE_TYPE,TRADE_DATE,'1' SEAL_STATUS,SEAL_USER_NO,
             -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
             ECS.PADLeft(TRADE_NO + ROW_NUMBER() OVER (ORDER BY SEAL_USER_NO),6,'0') TRADE_NO,
             AGENT_BANK,ISRETRY,ACC_SUB_ID,
             STATUS,CreateID,CreateDate,UpdateID,UpdateDate,
             -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
             EntryID, EntryDate, VerifyID, VerifyDate, ApproveID, ApproveDate,CRNCY_CD,SOURCE_CD
        FROM (
                SELECT WBATCH_ID BATCH_ID,1 BATCH_SRNO,OFD701.SUB_BANK_CODE SUB_BANK_CODE,OFD701.SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,OFD701.SUB_ID_NO,
                       OFD701.NEW_OLD,WSEAL_TYPE SEAL_TYPE,'0' TRADE_TYPE,WSEAL_DATE TRADE_DATE,'1' SEAL_STATUS,SEAL_USER_NO,
                       -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
                       -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
                       XMAX_TRADE_NO TRADE_NO, --(財金)交易序號之起始序號為當年最大交易序號+1起算
                       -- 2019.11.12 ChengYu 修正ECS.OFD702【扣款帳號核印歷史記錄檔】ACC_SUB_ID(帳號用途碼)存取值
                       -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
                       OFD706.AGENT_BANK, 'N' ISRETRY, 'ALL' ACC_SUB_ID,'301' STATUS ,WEXEC_USERID CreateID,XUpdateDate CreateDate,WEXEC_USERID UpdateID,XUpdateDate UpdateDate,
                       WEXEC_USERID EntryID,XUpdateDate EntryDate,WEXEC_USERID VerifyID,XUpdateDate VerifyDate,WEXEC_USERID ApproveID,XUpdateDate ApproveDate,
                       -- 2019.10.29 ChengYu 新增ECS.OFD702【扣款帳號核印歷史記錄檔】資料時寫入CRNCY_CD(幣別)、TRADE_NO(交易序號)固定為六碼
                       -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
                       CASE WHEN (HOLDER_BANK_EC.CURRENCY_NO = 'MMA' OR HOLDER_BANK_EC.CURRENCY_NO = 'FCY') THEN 'ALL' ELSE HOLDER_BANK_EC.CURRENCY_NO END CRNCY_CD,
                       '3' SOURCE_CD
                  FROM ECS.OFD701,FAS.HOLDER_BANK_EC,(SELECT DISTINCT SEAL_TYPE,SUB_BANK_CODE,SUB_ACC_NO,SUB_ID_NO,AGENT_BANK
                                                        FROM ECS.OFD706
                                                       WHERE BATCH_ID = WBATCH_ID) OFD706
                 WHERE OFD701.SUB_BANK_CODE = OFD706.SUB_BANK_CODE
                   AND OFD701.SUB_ACC_NO = OFD706.SUB_ACC_NO
                   AND OFD701.SUB_ID_NO = OFD706.SUB_ID_NO
                   AND OFD701.SEAL_TYPE = OFD706.SEAL_TYPE
                   AND HOLDER_BANK_EC.ID = OFD701.SUB_ID_NO
                   AND HOLDER_BANK_EC.AC_BANK = OFD701.SUB_BANK_CODE
                   AND HOLDER_BANK_EC.AC_CODE = OFD701.SUB_ACC_NO
                   AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
                   AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
                   AND HOLDER_BANK_EC.SEAL_STATUS IN ('0','9')
                 UNION ALL
                -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
                SELECT WBATCH_ID,1,OFD701.SUB_BANK_CODE,OFD701.SUB_ACC_NO,RSP_NO,RSP_SRNO,RSP_CHG_NO,RSP_CHG_SRNO,OFD701.SUB_ID_NO,
                       OFD701.NEW_OLD,WSEAL_TYPE,'0',WSEAL_DATE,'1',SEAL_USER_NO,
                       -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)、修正TRADE_NO(交易序號)取號
                       XMAX_TRADE_NO AS TRADE_NO,
                       OFD706.AGENT_BANK, 'N', 'ALL','301',WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,
                       WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,WEXEC_USERID,XUpdateDate,
                       -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
                       CASE WHEN (NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) = 'MMA' OR NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) = 'FCY') THEN 'ALL' ELSE NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) END CRNCY_CD,
                       '4' SOURCE_CD
                  FROM ECS.OFD701,FAS.HOLDER_BANK_EC_CHANGE,(SELECT DISTINCT SEAL_TYPE,SUB_BANK_CODE,SUB_ACC_NO,SUB_ID_NO,AGENT_BANK
                                                        FROM ECS.OFD706
                                                       WHERE BATCH_ID = WBATCH_ID) OFD706
                 WHERE OFD701.SUB_BANK_CODE = OFD706.SUB_BANK_CODE
                   AND OFD701.SUB_ACC_NO = OFD706.SUB_ACC_NO
                   AND OFD701.SUB_ID_NO = OFD706.SUB_ID_NO
                   AND OFD701.SEAL_TYPE = OFD706.SEAL_TYPE
                   AND HOLDER_BANK_EC_CHANGE.ID = OFD701.SUB_ID_NO
                   AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = OFD701.SUB_BANK_CODE
                   AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = OFD701.SUB_ACC_NO
                   AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
                   AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
                   AND HOLDER_BANK_EC_CHANGE.SEAL_STATUS IN ('0','9')
             );

    END;
  END IF;

  --將OFD701中合乎送核的資料設定為核印中
  XTTL_REC_COUNT := 0;
  XCRNT_REC_COUNT := 0;
  XBATCH_SRNO := 1;

  IF ((WMAX_FILE_COUNT != 0) OR  --有筆數限制
     (WFILE_NAMING_WAY = '3')) THEN   --變動檔名
    BEGIN
      -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為3(外幣核印)
      ECS.s_Create_Media_FileName(WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'3'); --編制媒體檔案名稱
    END;
  END IF;

  DECLARE CURSOR SealProof_cur IS
  SELECT SUB_BANK_CODE,
         SUB_ACC_NO,
         SUB_ID_NO,
         RSP_NO,RSP_SRNO,
         RSP_CHG_NO,RSP_CHG_SRNO,
         TRADE_NO,SEAL_USER_NO,
         SOURCE_CD,
         'N' ISFC
    FROM ECS.OFD702
    JOIN FAS.FIS_BANK
      ON FIS_BANK.BANK_NO = OFD702.SUB_BANK_CODE
   WHERE BATCH_ID = WBATCH_ID
     AND SEAL_TYPE = WSEAL_TYPE
     AND TRADE_DATE = WSEAL_DATE
     AND SEAL_STATUS = '1'
     AND TRADE_TYPE = '0'
   ORDER BY TRADE_NO;

  BEGIN

    FOR ROW IN SealProof_cur LOOP

      SELECT  ROW.SUB_BANK_CODE
             ,ROW.SUB_ACC_NO
             ,ROW.SUB_ID_NO
             ,ROW.RSP_NO
             ,ROW.RSP_SRNO
             ,ROW.RSP_CHG_NO
             ,ROW.RSP_CHG_SRNO
             ,ROW.TRADE_NO
             ,ROW.SEAL_USER_NO
             ,ROW.SOURCE_CD
             ,ROW.ISFC
        INTO  XSUB_BANK_CODE
             ,XSUB_ACC_NO
             ,XSUB_ID_NO
             ,XRSP_NO
             ,XRSP_SRNO
             ,XRSP_CHG_NO
             ,XRSP_CHG_SRNO
             ,XTRADE_NO
             ,XSEAL_USER_NO
             ,XSOURCE_CD
             ,XISFC
        FROM DUAL;

      --防止重送=>核印後，當DATACOUNT>2時，還可以取消重送的狀況
      DELETE ECS.OFD707
      WHERE EXISTS (SELECT 1
                      FROM ECS.OFD701 A
                      JOIN ECS.OFD706 B ON A.BATCH_ID = B.BATCH_ID AND A.SEAL_TYPE = B.SEAL_TYPE
                       AND A.SUB_ID_NO = B.SUB_ID_NO AND A.SUB_ACC_NO = B.SUB_ACC_NO
                       AND A.SUB_BANK_CODE = B.SUB_BANK_CODE
                      -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號);調整ECS.OFD707【核印重送帳號資料原始檔】刪除條件抓取方式
                      JOIN FAS.HOLDER_BANK_EC C
                        ON C.ID = A.SUB_ID_NO
                       AND C.AC_BANK = A.SUB_BANK_CODE
                       AND C.AC_CODE = A.SUB_ACC_NO
                       AND C.CURRENCY_NO != 'NTD'
                       AND C.DEPOSITORY_NO = '01'
                     WHERE A.SEAL_TYPE = WSEAL_TYPE
                       AND A.SUB_BANK_CODE = XSUB_BANK_CODE
                       AND A.SUB_ACC_NO = XSUB_ACC_NO
                       AND A.SUB_ID_NO = XSUB_ID_NO
                       AND A.RSP_NO = XRSP_NO
                       AND RSP_SRNO = XRSP_SRNO
                       AND A.RSP_CHG_NO = XRSP_CHG_NO
                       AND A.RSP_CHG_SRNO = XRSP_CHG_SRNO
                       -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號);調整ECS.OFD707【核印重送帳號資料原始檔】刪除條件抓取方式
                       AND OFD707.VOUCH_NO = C.VOUCH_NO
                       AND OFD707.VOUCH_SRNO = C.VOUCH_SRNO
                       AND OFD707.RELATIVE_NO = B.RELATIVE_NO
                       AND OFD707.RELATIVE_SRNO = B.RELATIVE_SRNO
                       AND OFD707.BATCH_ID = A.BATCH_ID);

      UPDATE ECS.OFD701
         SET SEAL_STATUS = '1',
             SEAL_DATE = WSEAL_DATE,
             TRADE_NO = XTRADE_NO,
             BATCH_ID = WBATCH_ID,
             RETURN_DATE = XDefaultDate,
             SEAL_FAIL_ID_CO = ' ',
             SEAL_FAIL_ID_BK = ' ',
             UpdateID = WEXEC_USERID,
             UpdateDate = XUpdateDate
       WHERE SEAL_TYPE = WSEAL_TYPE
         AND SUB_BANK_CODE = XSUB_BANK_CODE
         AND SUB_ACC_NO = XSUB_ACC_NO
         AND SUB_ID_NO = XSUB_ID_NO
         AND RSP_NO = XRSP_NO AND RSP_SRNO = XRSP_SRNO
         AND RSP_CHG_NO = XRSP_CHG_NO AND RSP_CHG_SRNO = XRSP_CHG_SRNO;

      IF SQL%ROWCOUNT = 0 THEN
        BEGIN
          WMSG := '無法將受益人扣款帳號核印檔(OFD701)中的資料註記為核印中';
          CLOSE SealProof_cur;
          RETURN;
        END;
      END IF;

      XTTL_REC_COUNT := XTTL_REC_COUNT + 1;
      IF WMAX_FILE_COUNT != 0 THEN --有筆數限制(處理次批號)
        BEGIN
          XCRNT_REC_COUNT := XCRNT_REC_COUNT + 1;
          IF XCRNT_REC_COUNT > WMAX_FILE_COUNT THEN
            BEGIN
              XBATCH_SRNO := XBATCH_SRNO + 1;   --由1編起，待滿足筆數限制時，再由2編起，以此類推……
              XCRNT_REC_COUNT := 1;
              -- 2019.10.07 ChengYu 調整呼叫ECS.s_Create_Media_FileName_FndCry(編制媒體檔案名稱)的參數Source(來源)為3(外幣核印)
              ECS.s_Create_Media_FileName(WTRP_TYPE,WMEDIA_NO,WBATCH_ID,XBATCH_SRNO,WSEAL_TYPE,WAGENT_BANK,'3'); --編制媒體檔案名稱
            END;
          END IF;
          IF XTTL_REC_COUNT > WMAX_FILE_COUNT THEN  --超過最大筆數限制後的Record之BATCH_SRNO才要再由2編起，以此類推……
            BEGIN
              UPDATE ECS.OFD702
                 SET BATCH_SRNO = XBATCH_SRNO,
                     UpdateID = WEXEC_USERID,
                     UpdateDate = XUpdateDate
               WHERE BATCH_ID = WBATCH_ID
                 AND TRADE_NO = XTRADE_NO;
            END;
          END IF;
        END;
      END IF;

      /*RSP
      IF WSEAL_TYPE = '2' OR WSEAL_TYPE = '3' THEN  --扣款途徑 2.ACH  3.財金
        BEGIN
           RSP
          --將定額契約書中該帳號的核印狀態改成核印中
          UPDATE RSP006
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = XTRADE_NO,
                 SEAL_STATUS = '1',
                 SEAL_DATE = WSEAL_DATE,
                 SEAL_RTN_DATE = '1900/01/01',
                 SEAL_FAIL_ID_CO = '',
                 SEAL_FAIL_ID_BK = '',
                 UpdateID = WEXEC_USERID,
                 UpdateDate = XUpdateDate
           WHERE SUB_BANK_CODE = XSUB_BANK_CODE
             AND SUB_ACCOUNT_NO = XSUB_ACC_NO
             AND SUB_ID_NO = XSUB_ID_NO
             AND SEAL_TYPE = WSEAL_TYPE
             AND SEAL_STATUS IN ('0','9')

          --將定額契約變更書中該帳號的核印狀態改成核印中
          UPDATE RSP013
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = XTRADE_NO,
                 SEAL_STATUS = '1',
                 SEAL_DATE = WSEAL_DATE,
                 SEAL_RTN_DATE = '1900/01/01',
                 SEAL_FAIL_ID_CO = '',
                 SEAL_FAIL_ID_BK = '',
                 UpdateID = WEXEC_USERID,
                 UpdateDate = XUpdateDate
           WHERE dbo.f_Nvl(AFT_SUB_BANK_CODE,BEF_SUB_BANK_CODE) = XSUB_BANK_CODE
             AND dbo.f_Nvl(AFT_SUB_ACCOUNT_NO,BEF_SUB_ACCOUNT_NO) = XSUB_ACC_NO
             AND dbo.f_Nvl(AFT_SUB_ID_NO,BEF_SUB_ID_NO) = XSUB_ID_NO
             AND dbo.f_Nvl(AFT_SEAL_TYPE,BEF_SEAL_TYPE) = WSEAL_TYPE
             AND IS_SEAL_YN = 'Y'  --變更扣款帳號相關欄位
             AND SEAL_STATUS IN ('0','9')
             AND CHG_UPD_DTTM = '1900/01/01'   --未生效更新

        END;
      END IF;
      */
      IF WSEAL_TYPE = '3' THEN  --扣款途徑 3.財金
        BEGIN
          /*
          UPDATE OFD607A
             SET PROCESS_YN = 'Y'
            FROM OFD607A
            JOIN OFD601 ON OFD601.BF_SRNO = OFD607A.BF_SRNO
            JOIN BMS005 ON BMS005.BF_NO = OFD601.BF_NO
            JOIN #BMS005_TMP A ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
                              AND A.DATA_SEQ = BMS005.DATA_SEQ;
          --20100517, Modify by rgb for 不過濾A2、B8
          -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')
          */
          --將授權帳號中該帳號的核印狀態改成核印中
          -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
          IF XSOURCE_CD = '3' THEN
          BEGIN

            UPDATE FAS.HOLDER_BANK_EC
               SET BATCH_ID = WBATCH_ID,
                   BATCH_SRNO = XBATCH_SRNO,
                   TRADE_NO = XTRADE_NO,
                   SEAL_STATUS = '1',
                   SEAL_DATE = WSEAL_DATE,
                   SEAL_RTN_DATE = XDefaultDate,
                   SEAL_FAIL_ID_CO = '',
                   SEAL_FAIL_ID_BK = '',
                   -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號);調整ECS.OFD707【核印重送帳號資料原始檔】刪除條件抓取方式
                   VOUCH_NO = '',
                   VOUCH_SRNO = '',
                   -- 2020.03.27 ChengYu 調整DELIVERED(送交核印日)儲存條件
                   DELIVERED = CASE WHEN SEAL_STATUS = '9' THEN XDATE ELSE DELIVERED END
                   --UpdateID = WEXEC_USERID,
                   --UpdateDate = XUpdateDate
             WHERE XSUB_BANK_CODE = AC_BANK
               AND AC_CODE = XSUB_ACC_NO
               AND HOLDER_BANK_EC.ID = XSUB_ID_NO
               -- AND SEAL_TYPE = WSEAL_TYPE
               AND SEAL_STATUS IN ('0','9')
               AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
               AND HOLDER_BANK_EC.DEPOSITORY_NO = '01';
          END;
          ELSIF XSOURCE_CD = '4' THEN
          BEGIN
            -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
            -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
            UPDATE FAS.HOLDER_BANK_EC_CHANGE
                 SET BATCH_ID = WBATCH_ID,
                     BATCH_SRNO = XBATCH_SRNO,
                     TRADE_NO = XTRADE_NO,
                     SEAL_STATUS = '1',
                     SEAL_DATE = WSEAL_DATE,
                     SEAL_RTN_DATE = XDefaultDate,
                     SEAL_FAIL_ID_CO = '',
                     SEAL_FAIL_ID_BK = '',
                     VOUCH_NO = '',
                     VOUCH_SRNO = '',
                     -- 2020.03.27 ChengYu 調整DELIVERED(送交核印日)儲存條件
                     DELIVERED = CASE WHEN SEAL_STATUS = '9' THEN XDATE ELSE DELIVERED END
               WHERE NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = XSUB_BANK_CODE
                 AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = XSUB_ACC_NO
                 AND HOLDER_BANK_EC_CHANGE.ID = XSUB_ID_NO
                 AND HOLDER_BANK_EC_CHANGE.SEAL_STATUS IN ('0','9')
                 AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
                 AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01';
          END;
          END IF;

          /*
          --20100504, Modify by rgb for 核印回覆時更新OFD607A
          SELECT BMS005CHG.BF_CHG_NO, BMS005CHG.DATA_SEQ INTO #BMS005CHG_TMP
            FROM BMS005CHG
            JOIN BMS001CHG ON BMS001CHG.BF_CHG_NO = BMS005CHG.BF_CHG_NO
           WHERE XSUB_BANK_CODE = (case XISFC when 'Y' then AFT_BANK_BRH else dbo.f_GetBankHQ(AFT_BANK_BRH) end)
             AND BMS005CHG.AFT_ACCOUNT_NO = XSUB_ACC_NO
             AND BMS001CHG.AFT_ID_NO = XSUB_ID_NO
             AND BMS005CHG.AFT_SEAL_TYPE = WSEAL_TYPE
             AND BMS005CHG.IS_SEAL_YN = 'Y' --變更扣款帳號相關欄位
             AND BMS005CHG.SEAL_STATUS IN ('0','9')
             AND BMS001CHG.CHG_UPD_DTTM = '1900/01/01'  --未生效更新

          UPDATE OFD607A
             SET PROCESS_YN = 'Y'
            FROM OFD607A
            JOIN OFD601 ON OFD601.BF_SRNO = OFD607A.BF_SRNO
            JOIN BMS005CHG ON BMS005CHG.BF_NO = OFD601.BF_NO
            JOIN #BMS005CHG_TMP A ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
                              AND A.DATA_SEQ = BMS005CHG.DATA_SEQ
          --20100517, Modify by rgb for 不過濾A2、B8
          -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

          --將授權帳號變更書中該帳號的核印狀態改成核印中
          UPDATE BMS005CHG
             SET BATCH_ID = WBATCH_ID,
                 BATCH_SRNO = XBATCH_SRNO,
                 TRADE_NO = XTRADE_NO,
                 SEAL_STATUS = '1',
                 SEAL_DATE = WSEAL_DATE,
                 SEAL_RTN_DATE = '1900/01/01',
                 SEAL_FAIL_ID_CO = '',
                 SEAL_FAIL_ID_BK = '',
                 UpdateID = WEXEC_USERID,
         UpdateDate = XUpdateDate
            FROM BMS005CHG
            JOIN #BMS005CHG_TMP A ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
                              AND A.DATA_SEQ = BMS005CHG.DATA_SEQ
          --  JOIN BMS001CHG ON BMS001CHG.BF_CHG_NO = BMS005CHG.BF_CHG_NO
          -- WHERE XSUB_BANK_CODE = (case XISFC when 'Y' then AFT_BANK_BRH else dbo.f_GetBankHQ(AFT_BANK_BRH) end)
          --   AND BMS005CHG.AFT_ACCOUNT_NO = XSUB_ACC_NO
          --   AND BMS001CHG.AFT_ID_NO = XSUB_ID_NO
          --   AND BMS005CHG.AFT_SEAL_TYPE = WSEAL_TYPE
          --   AND BMS005CHG.IS_SEAL_YN = 'Y' --變更扣款帳號相關欄位
          --   AND BMS005CHG.SEAL_STATUS IN ('0','9')
          --   AND BMS001CHG.CHG_UPD_DTTM = '1900/01/01'  --未生效更新
          DROP TABLE #BMS005CHG_TMP
          */
        END;
      ELSIF WSEAL_TYPE = '1' THEN  --扣款途徑 1.一般
        BEGIN
          /*RSP
          --將定額契約書中該帳號的核印狀態改成核印中
          IF XSOURCE_CD = '1' THEN
            BEGIN

              UPDATE RSP006
                 SET BATCH_ID = WBATCH_ID,
                     SEAL_STATUS = '1',
                     SEAL_DATE = WSEAL_DATE,
                     SEAL_RTN_DATE = '1900/01/01',
                     SEAL_FAIL_ID_CO = '',
                     SEAL_FAIL_ID_BK = '',
                     UpdateID = WEXEC_USERID,
                         UpdateDate = XUpdateDate
               -- 2015.09.14 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
               WHERE (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_NO = XRSP_NO))
                 AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_SRNO = XRSP_SRNO))
                 AND SUB_BANK_CODE = XSUB_BANK_CODE
                 AND SUB_ACCOUNT_NO = XSUB_ACC_NO
                 AND SUB_ID_NO = XSUB_ID_NO
                 AND SEAL_TYPE = WSEAL_TYPE
                 AND SEAL_STATUS IN ('0','9');

            END;
          END IF;

          --將定額契約變更書中該帳號的核印狀態改成核印中,若該變更書已生效,則須將原契約改成核印中
          IF XSOURCE_CD = '2' THEN
            BEGIN
              SELECT XEFFECT_DATE = CHG_UPD_DTTM,XRSP_NO = RSP_NO,XRSP_SRNO = XRSP_SRNO
                FROM RSP013
               WHERE RSP_CHG_NO = XRSP_CHG_NO AND RSP_CHG_SRNO = XRSP_CHG_SRNO

              UPDATE RSP013
                 SET BATCH_ID = WBATCH_ID,
                     SEAL_STATUS = '1',
                     SEAL_DATE = WSEAL_DATE,
                     SEAL_RTN_DATE = '1900/01/01',
                     SEAL_FAIL_ID_CO = '',
                     SEAL_FAIL_ID_BK = '',
                     UpdateID = WEXEC_USERID,
                         UpdateDate = XUpdateDate
               -- 2015.09.14 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
               WHERE (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_CHG_NO = XRSP_CHG_NO))
                 AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_CHG_SRNO = XRSP_CHG_SRNO))
                 AND dbo.f_Nvl(AFT_SUB_BANK_CODE,BEF_SUB_BANK_CODE) = XSUB_BANK_CODE
                 AND dbo.f_Nvl(AFT_SUB_ACCOUNT_NO,BEF_SUB_ACCOUNT_NO) = XSUB_ACC_NO
                 AND dbo.f_Nvl(AFT_SUB_ID_NO,BEF_SUB_ID_NO) = XSUB_ID_NO
                 AND dbo.f_Nvl(AFT_SEAL_TYPE,BEF_SEAL_TYPE) = WSEAL_TYPE
                 AND SEAL_STATUS IN ('0','9')
                 --AND CHG_UPD_DTTM = '1900/1/1'

              --IF XEFFECT_DATE <> '1900/01/01'  --該筆契約變更已生效,則須將原契約改成核印中
                --BEGIN
                  UPDATE RSP006
                     SET BATCH_ID = WBATCH_ID,
                         SEAL_STATUS = '1',
                         SEAL_DATE = WSEAL_DATE,
                         SEAL_RTN_DATE = '1900/01/01',
                         SEAL_FAIL_ID_CO = '',
                         SEAL_FAIL_ID_BK = '',
                         UpdateID = WEXEC_USERID,
                             UpdateDate = XUpdateDate
                   -- 2015.09.14 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
                   WHERE (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_NO = XRSP_NO))
                     AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND RSP_SRNO = XRSP_SRNO))
                     AND SUB_BANK_CODE = XSUB_BANK_CODE
                     AND SUB_ACCOUNT_NO = XSUB_ACC_NO
                     AND SUB_ID_NO = XSUB_ID_NO
                     AND SEAL_TYPE = WSEAL_TYPE
                     AND SEAL_STATUS IN ('0','9')
                --END
            END;
          END IF;
          */

          --將授權帳號中該帳號的核印狀態改成核印中
          IF XSOURCE_CD = '3' THEN
            BEGIN
              /*
                 UPDATE OFD607A
                    SET PROCESS_YN = 'Y'
                  FROM OFD607A
                  JOIN OFD601 ON OFD601.BF_SRNO = OFD607A.BF_SRNO
                  JOIN BMS005 ON BMS005.BF_NO = OFD601.BF_NO
                  JOIN #BMS005_TMP1 A ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
                                         AND A.DATA_SEQ = BMS005.DATA_SEQ
                 --20100517, Modify by rgb for 不過濾A2、B8
                 -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')
              */

            UPDATE FAS.HOLDER_BANK_EC
               SET BATCH_ID = WBATCH_ID,
                   SEAL_STATUS = '1',
                   SEAL_DATE = WSEAL_DATE,
                   SEAL_RTN_DATE = XDefaultDate,
                   SEAL_FAIL_ID_CO = '',
                   SEAL_FAIL_ID_BK = '',
                   -- 2019.10.22 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增清除欄位VOUCH_NO(申請書號)、VOUCH_SRNO(申請書序號);調整ECS.OFD707【核印重送帳號資料原始檔】刪除條件抓取方式
                   VOUCH_NO = '',
                   VOUCH_SRNO = '',
                   -- 2020.03.27 ChengYu 調整DELIVERED(送交核印日)儲存條件
                   DELIVERED = CASE WHEN SEAL_STATUS = '9' THEN XDATE ELSE DELIVERED END
                   --UpdateID = WEXEC_USERID,
                   --UpdateDate = XUpdateDate
             WHERE XSUB_BANK_CODE = AC_BANK
               AND AC_CODE = XSUB_ACC_NO
               AND HOLDER_BANK_EC.ID = XSUB_ID_NO
               AND SEAL_STATUS IN ('0','9')
               AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
               AND HOLDER_BANK_EC.DEPOSITORY_NO = '01';
               --AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND REMIT_CFM_NO = XRSP_NO))
               --AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND DATA_SEQ = XRSP_SRNO))
               -- AND SEAL_TYPE = WSEAL_TYPE

            END;
          END IF;

          --將授權帳號變更書中該帳號的核印狀態改成核印中,若該變更書已生效,則須將原契約改成核印中
          -- 2020.03.16 ChengYu ECS.OFD702新增儲存欄位SOURCE_CD(申請書來源)、幣別MMA與FCY皆轉換成ALL、調整成以SOURCE_CD(申請書來源)來區分更新Table
          IF XSOURCE_CD = '4' THEN
            BEGIN
              -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
              -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
              UPDATE FAS.HOLDER_BANK_EC_CHANGE
                 SET BATCH_ID = WBATCH_ID,
                     BATCH_SRNO = XBATCH_SRNO,
                     TRADE_NO = XTRADE_NO,
                     SEAL_STATUS = '1',
                     SEAL_DATE = WSEAL_DATE,
                     SEAL_RTN_DATE = XDefaultDate,
                     SEAL_FAIL_ID_CO = '',
                     SEAL_FAIL_ID_BK = '',
                     VOUCH_NO = '',
                     VOUCH_SRNO = '',
                     -- 2020.03.27 ChengYu 調整DELIVERED(送交核印日)儲存條件
                     DELIVERED = CASE WHEN SEAL_STATUS = '9' THEN XDATE ELSE DELIVERED END
               WHERE NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = XSUB_BANK_CODE
                 AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = XSUB_ACC_NO
                 AND HOLDER_BANK_EC_CHANGE.ID = XSUB_ID_NO
                 AND HOLDER_BANK_EC_CHANGE.SEAL_STATUS IN ('0','9')
                 AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
                 AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01';
          /*
              SELECT XEFFECT_DATE = BMS001CHG.CHG_UPD_DTTM,XRSP_NO = AFT_REMIT_CFM_NO,XRSP_SRNO = AFT_DATA_SEQ
                FROM BMS005CHG,BMS001CHG
               WHERE BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
                 AND BMS005CHG.BF_CHG_NO = XRSP_CHG_NO
                 AND BMS005CHG.DATA_SEQ = XRSP_CHG_SRNO

              --20100504, Modify by rgb for 核印回覆時更新OFD607A
              SELECT BF_CHG_NO, DATA_SEQ INTO #BMS005CHG_TMP1
                FROM BMS005CHG
               -- 2015.09.14 Joyce 依據CTL015控制檔決定By帳號或契約送核調整
               WHERE (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND BMS005CHG.BF_CHG_NO = XRSP_CHG_NO))
                 AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND BMS005CHG.DATA_SEQ = XRSP_CHG_SRNO))
                 AND XSUB_BANK_CODE = (case XISFC when 'Y' then AFT_BANK_BRH else dbo.f_GetBankHQ(AFT_BANK_BRH) end)
                 AND AFT_ACCOUNT_NO = XSUB_ACC_NO
                 AND (SELECT AFT_ID_NO FROM BMS001CHG WHERE BMS001CHG.BF_CHG_NO = BMS005CHG.BF_CHG_NO) = XSUB_ID_NO
                 AND AFT_SEAL_TYPE = WSEAL_TYPE
                 AND IS_SEAL_YN = 'Y' --變更扣款帳號相關欄位
                 AND SEAL_STATUS IN ('0','9')

                 UPDATE OFD607A
                    SET PROCESS_YN = 'Y'
                   FROM OFD607A
                   JOIN OFD601 ON OFD601.BF_SRNO = OFD607A.BF_SRNO
                   JOIN BMS005CHG ON BMS005CHG.BF_NO = OFD601.BF_NO
                   JOIN #BMS005CHG_TMP1 A ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
                                              AND A.DATA_SEQ = BMS005CHG.DATA_SEQ
                 --20100517, Modify by rgb for 不過濾A2、B8
                 -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

              UPDATE BMS005CHG
                 SET BATCH_ID = WBATCH_ID,
                     SEAL_STATUS = '1',
                     SEAL_DATE = WSEAL_DATE,
                     SEAL_RTN_DATE = '1900/01/01',
                     SEAL_FAIL_ID_CO = '',
                     SEAL_FAIL_ID_BK = '',
                     UpdateID = WEXEC_USERID,
                         UpdateDate = XUpdateDate
                    FROM BMS005CHG
                JOIN #BMS005CHG_TMP1 A ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
                                  AND A.DATA_SEQ = BMS005CHG.DATA_SEQ

              -- WHERE BMS005CHG.BF_CHG_NO = XRSP_CHG_NO AND BMS005CHG.DATA_SEQ = XRSP_CHG_SRNO
              --   AND XSUB_BANK_CODE = (case XISFC when 'Y' then AFT_BANK_BRH else dbo.f_GetBankHQ(AFT_BANK_BRH) end)
              --   AND AFT_ACCOUNT_NO = XSUB_ACC_NO
              --   AND (SELECT AFT_ID_NO FROM BMS001CHG WHERE BMS001CHG.BF_CHG_NO = BMS005CHG.BF_CHG_NO) = XSUB_ID_NO
              --   AND AFT_SEAL_TYPE = WSEAL_TYPE
              --   AND IS_SEAL_YN = 'Y' --變更扣款帳號相關欄位
              --   AND SEAL_STATUS IN ('0','9')
              --   AND XEFFECT_DATE = '1900/1/1'
              DROP TABLE #BMS005CHG_TMP1

              --IF XEFFECT_DATE <> '1900/01/01'  --該筆授權帳號變更已生效,則須將原授權帳號改成核印中
                --BEGIN
                  UPDATE FAS.HOLDER_BANK_EC
                     SET BATCH_ID = WBATCH_ID,
                         SEAL_STATUS = '1',
                         SEAL_DATE = WSEAL_DATE,
                         SEAL_RTN_DATE = '1900/01/01',
                         SEAL_FAIL_ID_CO = '',
                         SEAL_FAIL_ID_BK = '',
                         UpdateID = WEXEC_USERID,
                         UpdateDate = XUpdateDate
                   WHERE (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND REMIT_CFM_NO = XRSP_NO))
                     AND (XRSP_SEAL_TYPE = 'A' OR (XRSP_SEAL_TYPE = 'C' AND DATA_SEQ = XRSP_SRNO))
                     AND XSUB_BANK_CODE = (case XISFC when 'Y' then BANK_BRH else dbo.f_GetBankHQ(BANK_BRH) end)
                     AND ACCOUNT_NO = XSUB_ACC_NO
                     AND (SELECT ID_NO FROM BMS001 WHERE BMS001.BF_NO = BMS005.BF_NO) = XSUB_ID_NO
                     AND SEAL_TYPE = WSEAL_TYPE
                     AND SEAL_STATUS IN ('0','9');
                --END
            */
            END;
          END IF;

        END;
      END IF;
    END LOOP;
  END;

  WIsSuccess := 'Y';

END;

/

  GRANT EXECUTE ON "ECS"."S_SEALPROOF_PROCESS_1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SEALPROOF_PROCESS_5
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SEALPROOF_PROCESS_5" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2019/08/16
-- Description: 取消該批核印
-- 2020.03.06 ChengYu FAS.HOLDER_BANK_EC【受益人扣款帳號】新增更新欄位DELIVERED(送交核印日期)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
-- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- =============================================
(
    WEXEC_USERID VARCHAR2,      --執行人員
    WBATCH_ID    VARCHAR2,      --批次識別碼(每批不可重覆)
    WSEAL_TYPE   VARCHAR2,      --扣款途徑 1.一般 2.ACH  3.財金
    WIsSuccess   OUT VARCHAR2,  --成功否：Y.成功  N.失敗
    WMSG        OUT VARCHAR2  --訊息：存放錯誤訊息

) IS

--變數宣告
XTTL_REC_COUNT   DECIMAL(5,0);        --不為核印中的總筆數,
XDATUPDATEDATE   DATE;                --更新日期時間
XDATNULLDATE     DATE;                --空白日期時間
XRSP_SEAL_TYPE   VARCHAR2(6);         --印核方式BY帳號或契約送核 A:帳號;C:契約

BEGIN

  WIsSuccess := 'N';
  WMSG := ' ';
  XDATUPDATEDATE := SYSDATE;
  XDATNULLDATE := TO_DATE(19000101,'YYYYMMDD');
  --XRSP_SEAL_TYPE := 'Y';

/*無CTL015
  SELECT TOP 1 XRSP_SEAL_TYPE = RSP_SEAL_TYPE FROM CTL015;
*/

/*RSP資料檢核
  SELECT XTTL_REC_COUNT = COUNT(*)
    FROM RSP006
   WHERE BATCH_ID = WBATCH_ID
     AND SEAL_TYPE = WSEAL_TYPE
     AND SEAL_STATUS <> '1'
  IF XTTL_REC_COUNT > 0
    BEGIN
      SET WMSG = '在契約檔中有不是核印中的資料'
      RETURN
    END

  SELECT XTTL_REC_COUNT = COUNT(*)
    FROM RSP013
   WHERE BATCH_ID = WBATCH_ID
     AND AFT_SEAL_TYPE = WSEAL_TYPE
     AND SEAL_STATUS <> '1'
  IF XTTL_REC_COUNT > 0
    BEGIN
      SET WMSG = '在契約變更檔有不是核印中的資料'
      RETURN
    END
*/

  SELECT COUNT(1)
    INTO XTTL_REC_COUNT
    FROM FAS.HOLDER_BANK_EC
   WHERE HOLDER_BANK_EC.BATCH_ID = WBATCH_ID
     --AND HOLDER_BANK_EC.SEAL_TYPE = WSEAL_TYPE
     AND SEAL_STATUS <> '1'
     AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
     AND HOLDER_BANK_EC.DEPOSITORY_NO = '01';

  IF XTTL_REC_COUNT > 0 THEN
    BEGIN
      WMSG := '在授權帳號檔中有不是核印中的資料';
      RETURN;
    END;
  END IF;
  -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
  -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
  SELECT COUNT(1)
    INTO XTTL_REC_COUNT
    FROM FAS.HOLDER_BANK_EC_CHANGE
   WHERE HOLDER_BANK_EC_CHANGE.BATCH_ID = WBATCH_ID
     --AND HOLDER_BANK_EC_CHANGE.SEAL_TYPE = WSEAL_TYPE
     AND HOLDER_BANK_EC_CHANGE.SEAL_STATUS <> '1'
     AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
     AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
     AND (
         --BMS005CHG.BEF_SEAL_TYPE <> BMS005CHG.AFT_SEAL_TYPE   OR
         HOLDER_BANK_EC_CHANGE.AC_BANK <> HOLDER_BANK_EC_CHANGE.NEW_AC_BANK OR
         HOLDER_BANK_EC_CHANGE.AC_BRANCH <> HOLDER_BANK_EC_CHANGE.NEW_AC_BRANCH OR
         HOLDER_BANK_EC_CHANGE.AC_CODE <> HOLDER_BANK_EC_CHANGE.NEW_AC_CODE
         --OR (BMS005CHG.BEF_ACC_SUB_ID <> BMS005CHG.AFT_ACC_SUB_ID AND BMS005CHG.AFT_ACC_SUB_ID <> '2')
         );

  IF XTTL_REC_COUNT > 0 THEN
    BEGIN
      WMSG := '在授權帳號變更檔中有不是核印中的資料';
      RETURN;
    END;
  END IF;

  --將扣款帳號核印檔中該批的批次識別碼及送核日期清空,核印狀態改成未核印
  UPDATE ECS.OFD701
     SET BATCH_ID = ' ',
         --TRADE_NO = '',
         SEAL_STATUS = '0',
         --SEAL_DATE = XDATNULLDATE,
         UpdateID = WEXEC_USERID,
         UpdateDate = XDATUPDATEDATE
   WHERE OFD701.BATCH_ID = WBATCH_ID
     AND OFD701.SEAL_TYPE = WSEAL_TYPE
     AND OFD701.SEAL_STATUS='1';

/* RSP資料更新
  --將定額契約書中該批的批次識別碼及送核日期清空,核印狀態改成未核印
  UPDATE RSP006
     SET BATCH_ID = '',
         TRADE_NO = '',
         --若為重送，一般更新為重送，ACH/FIS無條件更新為未送
         SEAL_STATUS = ISNULL(CASE WHEN OFD702.SEAL_TYPE = '1' AND OFD702.ISRETRY = 'Y' THEN '9' ELSE '0' END,'0'),
         SEAL_DATE = XDATNULLDATE,
         UpdateID = WEXEC_USERID,
     UpdateDate = XDATUPDATEDATE
    FROM RSP006
    LEFT JOIN OFD702
      ON OFD702.BATCH_ID = RSP006.BATCH_ID
     AND OFD702.SUB_BANK_CODE = RSP006.SUB_BANK_CODE
     AND OFD702.SUB_ACC_NO = RSP006.SUB_ACCOUNT_NO
     --2015.09.16 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
     AND OFD702.RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP006.RSP_NO END)
     AND OFD702.RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP006.RSP_SRNO END)
     -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
     AND OFD702.RSP_CHG_NO = CASE WHEN OFD702.SOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 'ALL' ELSE OFD702.RSP_CHG_NO END
     AND OFD702.RSP_CHG_SRNO = CASE WHEN OFD702.SOURCE_CD IN ('3','4') OR XRSP_SEAL_TYPE = 'A' THEN 0 ELSE OFD702.RSP_CHG_SRNO END
     AND OFD702.SUB_ID_NO = RSP006.SUB_ID_NO
     AND OFD702.ACC_SUB_ID = 'ALL'
   WHERE RSP006.BATCH_ID = WBATCH_ID
     AND RSP006.SEAL_TYPE = WSEAL_TYPE
     AND RSP006.SEAL_STATUS='1'

  --將定額契約變更書中該批的批次識別碼及送核日期清空,核印狀態改成未核印
  UPDATE RSP013
     SET BATCH_ID = '',
         TRADE_NO = '',
         --若為重送，一般更新為重送，ACH/FIS無條件更新為未送
         SEAL_STATUS = ISNULL(CASE WHEN OFD702.SEAL_TYPE = '1' AND OFD702.ISRETRY = 'Y' THEN '9' ELSE '0' END,'0'),
         SEAL_DATE = XDATNULLDATE,
         UpdateID = WEXEC_USERID,
     UpdateDate = XDATUPDATEDATE
    FROM RSP013
    LEFT JOIN OFD702
      ON OFD702.BATCH_ID = RSP013.BATCH_ID
     AND OFD702.SUB_BANK_CODE = dbo.f_Nvl(RSP013.AFT_SUB_BANK_CODE, RSP013.BEF_SUB_BANK_CODE)
     AND OFD702.SUB_ACC_NO = dbo.f_Nvl(RSP013.AFT_SUB_ACCOUNT_NO, RSP013.BEF_SUB_ACCOUNT_NO)
     --2015.09.16 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整BEGIN
     AND OFD702.RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP013.RSP_NO END)
     AND OFD702.RSP_SRNO= (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP013.RSP_SRNO END)
     AND OFD702.RSP_CHG_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE RSP013.RSP_CHG_NO END)
     AND OFD702.RSP_CHG_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE RSP013.RSP_CHG_SRNO END)
     AND OFD702.SUB_ID_NO = dbo.f_Nvl(RSP013.AFT_SUB_ID_NO, RSP013.BEF_SUB_ID_NO)
     AND OFD702.ACC_SUB_ID = 'ALL'
   WHERE RSP013.BATCH_ID = WBATCH_ID
     AND dbo.f_Nvl(RSP013.AFT_SEAL_TYPE,RSP013.BEF_SEAL_TYPE) = WSEAL_TYPE
     AND RSP013.SEAL_STATUS='1'
     AND RSP013.IS_SEAL_YN='Y'
*/
  --將授權帳號中該批的批次識別碼及送核日期清空,核印狀態改成未核印
  MERGE INTO FAS.HOLDER_BANK_EC
  USING ( SELECT HOLDER_BANK_EC.ID
                 ,HOLDER_BANK_EC.AC_BANK
                 ,HOLDER_BANK_EC.AC_CODE
                 ,HOLDER_BANK_EC.DEPOSITORY_NO
                 ,HOLDER_BANK_EC.CURRENCY_NO
                 ,OFD702.SEAL_TYPE
                 ,OFD702.ISRETRY
            FROM FAS.HOLDER_BANK_EC
            LEFT JOIN FAS.HOLDER
              ON HOLDER.ID = HOLDER_BANK_EC.ID
            LEFT JOIN FAS.FIS_BANK
              ON FIS_BANK.BANK_NO = HOLDER_BANK_EC.AC_BANK
            LEFT JOIN ECS.OFD702
              ON OFD702.BATCH_ID = HOLDER_BANK_EC.BATCH_ID
             AND OFD702.SUB_BANK_CODE = FIS_BANK.BANK_NO
             AND OFD702.SUB_ACC_NO = HOLDER_BANK_EC.AC_CODE
             AND OFD702.RSP_NO = 'ALL'
             AND OFD702.RSP_SRNO= 0
             AND OFD702.RSP_CHG_NO = 'ALL'
             AND OFD702.RSP_CHG_SRNO = 0
             AND OFD702.SUB_ID_NO = HOLDER.ID
             AND OFD702.ACC_SUB_ID = 'ALL'
           WHERE HOLDER_BANK_EC.BATCH_ID = WBATCH_ID
             AND HOLDER_BANK_EC.SEAL_STATUS = '1'
             AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
             AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
             -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
             AND OFD702.SOURCE_CD = '3'
        )OFD702
     ON (HOLDER_BANK_EC.ID = OFD702.ID
    AND HOLDER_BANK_EC.AC_BANK = OFD702.AC_BANK
    AND HOLDER_BANK_EC.AC_CODE = OFD702.AC_CODE
    AND HOLDER_BANK_EC.DEPOSITORY_NO = OFD702.DEPOSITORY_NO
    AND HOLDER_BANK_EC.CURRENCY_NO = OFD702.CURRENCY_NO
        )
   WHEN MATCHED THEN
           UPDATE
              SET HOLDER_BANK_EC.BATCH_ID = '',
                  HOLDER_BANK_EC.TRADE_NO = '',
                  --若為重送，一般更新為重送，ACH/FIS無條件更新為未送
                  HOLDER_BANK_EC.SEAL_STATUS = NVL(CASE WHEN SEAL_TYPE = '1' AND ISRETRY = 'Y' THEN '9' ELSE '0' END,'0'),
                  HOLDER_BANK_EC.SEAL_DATE = XDATNULLDATE;
                  --HOLDER_BANK_EC.UpdateID = WEXEC_USERID,
                  --HOLDER_BANK_EC.UpdateDate = XDATUPDATEDATE;

  --將授權帳號變更書中該批的批次識別碼及送核日期清空,核印狀態改成未核印
  -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
  -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
  MERGE INTO FAS.HOLDER_BANK_EC_CHANGE
  USING ( SELECT  HOLDER_BANK_EC_CHANGE.ID
                 ,NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) NEW_AC_BANK
                 ,NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BRANCH,HOLDER_BANK_EC_CHANGE.AC_BRANCH) NEW_AC_BRANCH
                 ,NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) NEW_AC_CODE
                 ,HOLDER_BANK_EC_CHANGE.LAST_MODIFIED
                 ,NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD)DEPOSITORY_NO
                 ,OFD702.SEAL_TYPE
                 ,OFD702.ISRETRY
            FROM FAS.HOLDER_BANK_EC_CHANGE
            LEFT JOIN FAS.FIS_BANK
              ON FIS_BANK.BANK_NO = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK)
            LEFT JOIN ECS.OFD702
              ON OFD702.BATCH_ID = HOLDER_BANK_EC_CHANGE.BATCH_ID
             AND OFD702.SUB_BANK_CODE = FIS_BANK.BANK_NO
             AND OFD702.SUB_ACC_NO = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE)
             AND OFD702.RSP_NO = 'ALL'
             AND OFD702.RSP_SRNO = 0
             AND OFD702.RSP_CHG_NO = 'ALL'
             AND OFD702.RSP_CHG_SRNO = 0
             AND OFD702.SUB_ID_NO = HOLDER_BANK_EC_CHANGE.ID
             --AND OFD702.ACC_SUB_ID = BMS005CHG.AFT_ACC_SUB_ID
           WHERE HOLDER_BANK_EC_CHANGE.BATCH_ID = WBATCH_ID
             AND HOLDER_BANK_EC_CHANGE.SEAL_STATUS = '1'
             AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
             AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
             -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table
             AND OFD702.SOURCE_CD = '4'
             --AND HOLDER_BANK_EC_CHANGE.AFT_SEAL_TYPE = WSEAL_TYPE
             --AND HOLDER_BANK_EC_CHANGE.IS_SEAL_YN = 'Y'
        )OFD702
     ON (HOLDER_BANK_EC_CHANGE.ID = OFD702.ID
    AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = OFD702.NEW_AC_BANK
    AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BRANCH,HOLDER_BANK_EC_CHANGE.AC_BRANCH) = OFD702.NEW_AC_BRANCH
    AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = OFD702.NEW_AC_CODE
    AND HOLDER_BANK_EC_CHANGE.LAST_MODIFIED = OFD702.LAST_MODIFIED
    AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = OFD702.DEPOSITORY_NO
        )
   WHEN MATCHED THEN
           UPDATE
              -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
              SET HOLDER_BANK_EC_CHANGE.BATCH_ID = '',
                  HOLDER_BANK_EC_CHANGE.TRADE_NO = '',
                  --若為重送，一般更新為重送，ACH/FIS無條件更新為未送
                  HOLDER_BANK_EC_CHANGE.SEAL_STATUS = NVL(CASE WHEN SEAL_TYPE = '1' AND ISRETRY = 'Y' THEN '9' ELSE '0' END,'0'),
                  HOLDER_BANK_EC_CHANGE.SEAL_DATE = XDATNULLDATE;
                  --HOLDER_BANK_EC_CHANGE.UpdateID = WEXEC_USERID,
                  --HOLDER_BANK_EC_CHANGE.UpdateDate = XDATUPDATEDATE;

  --刪除該批扣款帳號送核記錄
  DELETE FROM ECS.OFD702
   WHERE BATCH_ID = WBATCH_ID
     AND SEAL_TYPE = WSEAL_TYPE
     AND TRADE_TYPE = '0'; --送核

  WIsSuccess := 'Y';

END;

/

  GRANT EXECUTE ON "ECS"."S_SEALPROOF_PROCESS_5" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SEALPROOF_RETURNPROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SEALPROOF_RETURNPROCESS" 
-- =============================================
-- Author       : PhotoRGB
-- Create date  : 2009/08/14
-- Description  : 核印回覆處理/核印狀態變更
--                異動相同ACH帳號為FIS的扣款方式
-- 2015.09.15 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
-- 2016.10.17 Mod By Joyce 取消異動相同ACH帳號為FIS的扣款方式處理
-- 2019.09.06 tingting 調整為ORACLE版本
-- 2019.09.11 ChengYu 新增FAS.HOLDER_BANK_EC(受益人扣款帳號)資料更新
-- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
-- 2020.03.06 ChengYu 和印完成時，更新【FAS.HOLDER_BANK_EC(受益人扣款帳號)】欄位 VERIFIED(核印完成日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
-- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
-- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
-- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
-- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)
-- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
-- 2021.03.30 Chnegyu 修正帳號異動檔更新至主檔條件、核印失敗也需要更新主檔
-- 2021.03.30 Chnegyu 修正帳號異動檔更新多筆問題
-- 2021.03.31 Chengyu 帳號異動檔更新至主檔時，需更新核印送件日
-- =============================================
(
    WBATCH_ID           VARCHAR2,       --批次識別碼  執行核印處理的第幾批號；  依核印途徑不同，各自編號  ACH："ACH"+YYYY+nnnnnn  FIS："FIS"+YYYY+nnnnnn  其他：扣款行前3碼+YYYY+nnnnnn
    WBANK_BRH           VARCHAR2,       --金融機構分行代碼  必須存在OFD020檔中
    WACCOUNT_NO         VARCHAR2,       --扣款帳號
    WSUB_ID_NO          VARCHAR2,       --扣款人身分證號
    WSEAL_TYPE          VARCHAR2,       --核印方式 1：一般；2：ACH；3：財金
    WSEAL_STATUS        VARCHAR2,       --核印狀態 0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
    WSEAL_FAIL_ID_CO    VARCHAR2,       --核印回覆代碼(公司)  必須存在OFD711檔中
    WSEAL_DATE          DATE,           --送核日期
    WRETURN_DATE        Date,           --回覆日期 若為核印狀態變更時傳入'1900/1/1'
    WSOURCE_CD          VARCHAR2,       --申請書來源 1：定期定額契約；2：定期定額契約變更；3：授權約定書；4：授權約定書變更 (CTL014：236)
    WVOUCH_NO           VARCHAR2,       --申請書號  為契約書號或契約變更書號或授權書號
    WVOUCH_SRNO         INT,            --申請書序號  為契約序號或契約變更序號或授權書資料流水號或授權書變更流水號
    WRELATIVE_NO        VARCHAR2,       --相關書號  即契約書號
    WRELATIVE_SRNO      INT,            --相關書序號  即契約序號或授權書資料流水號
    WUpdateID           VARCHAR2,       --更新人員
    MSG                 OUT VARCHAR2    --錯誤訊息
)
IS
    XRELATIVE_NO        VARCHAR2(20);   --相關書號  即契約書號
    XRSP_NO             VARCHAR2(20);   --契約書號  必須存在RSP006檔中；扣款途徑為一般時，才有值，其餘為'ALL'
    XRSP_SRNO           INT;            --契約序號  必須存在RSP006檔中；扣款途徑為一般時，才有值，其餘為'0'
    XRSP_CHG_NO         VARCHAR2(20);   --契約變更書號  必須存在RSP013檔中；扣款途徑為一般時，才有值，其餘為'ALL'
    XRSP_CHG_SRNO       INT;            --契約變更序號  必須存在RSP013檔中；扣款途徑為一般時，才有值，其餘為'0'
    XSEAL_USER_NO       VARCHAR2(20);   --用戶號碼  以"ACHNO"至 AA_SrNosSet 抓流水號，格式為：金融機構總行代碼+99999999  只適用ACH
    XTRADE_NO           VARCHAR2(16);   --交易序號  存放6或7位數字，位數不夠，則左補0,由1起日編；  若扣款途徑為ACH，則為6位；若扣款途徑為財金或一般，則為7位
    XAGENT_BANK         VARCHAR2(3);    --扣款行
    XACC_SUB_ID         VARCHAR2(6);    --扣款人身分證號
    XISRETRY            VARCHAR2(1);    --重送碼  Y：重送件；N：新件
    XUpdateDate         DATE;           --更新日期
    XUpdateDateTime     DATE;           --更新日期時間
    XON_LINE_DATE       DATE;           --系統上線日期FOR核印平台使用，判斷此日期前可收非SW交付的核印檔
    XSEAL_DAY           INT;            --For核印回報：帳號核印成功，RSP可開始扣款的天數
    -- 2015.09.15 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
    XRSP_SEAL_TYPE      VARCHAR2(6);    --點對點扣款帳號送核規則  A：帳號；C：契約
    XCOUNT              INT;            --筆數
    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
    XNEW_OLD            VARCHAR2(1);
    -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
    --帳號異動檔更新至帳號主檔變數
    CHG_AC_BANK         VARCHAR2(3);
    CHG_AC_BRANCH       VARCHAR2(4);
    CHG_AC_CODE         VARCHAR2(20);
    CHG_AC_NAME         VARCHAR2(100);
    CHG_FIS_SNAME       VARCHAR2(15);
    CHG_CURRENCY_NO     VARCHAR2(3);
    CHG_DEPOSITORY_NO   VARCHAR2(2);
    CHG_NEW_AC_BANK     VARCHAR2(3);
    CHG_NEW_AC_BRANCH   VARCHAR2(4);
    CHG_NEW_AC_CODE     VARCHAR2(20);
    CHG_NEW_AC_NAME     VARCHAR2(100);
    CHG_NEW_FIS_SNAME   VARCHAR2(15);
    CHG_CURRENCY_NO_OLD   VARCHAR2(3);
    CHG_DEPOSITORY_NO_OLD VARCHAR2(2);
    -- 2021.03.30 Chnegyu 修正帳號異動檔更新至主檔條件、核印失敗也需要更新主檔
    CHG_ORG_NEW_AC_BANK  VARCHAR2(3);
    CHG_DELIVERED        DATE;
    CHG_REJECTED         DATE;
    CHG_REJECT_CODE      VARCHAR2(3);

BEGIN

    /*
    SELECT XON_LINE_DATE = ISNULL(MIN(ON_LINE_DATE),'1900/1/1'),
           XSEAL_DAY = ISNULL(MIN(SEAL_DAY),0),
           XRSP_SEAL_TYPE = ISNULL(MIN(RSP_SEAL_TYPE),'Y')
      FROM CTL015;
    */

    --XRELATIVE_NO := CASE WRELATIVE_NO WHEN '' THEN 'ALL' ELSE WRELATIVE_NO END;
    XUpdateDate := NVL(WRETURN_DATE, TRUNC(SYSDATE));
    XUpdateDateTime := SYSDATE;

    /*
    IF (WSEAL_TYPE = '1' AND XRSP_SEAL_TYPE = 'C') THEN
    BEGIN
        --有批次轉入的資料也要一同更新
        IF (WSOURCE_CD IN ('1','2')) --RSP006
        BEGIN
            IF WSOURCE_CD = '1'
            BEGIN
                SET XRSP_NO = WVOUCH_NO;
                SET XRSP_SRNO = WVOUCH_SRNO;
                SET XRSP_CHG_NO = 'ALL';
                SET XRSP_CHG_SRNO = 0;
            END
            ELSE
            BEGIN
                SET XRSP_NO = XRELATIVE_NO;
                SET XRSP_SRNO = WRELATIVE_SRNO;
            END;

            UPDATE dbo.RSP006
               SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                  ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
                  ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                          CASE WHEN SEAL_RTN_DATE <> '1900/1/1' THEN SEAL_RTN_DATE
                                          ELSE XUpdateDate END
                                        END
                  ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                  ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
                  ,DFT_BNG_SUB_DATE = CASE WHEN WSEAL_STATUS = '2' AND DFT_BNG_SUB_DATE = '1900/1/1'
                                             THEN CAST(dbo.f_Nvl(DFT_BNG_SUB_DATE,dbo.f_GetBusinessDay(cast(dbo.f_Nvl(SEAL_RTN_DATE,XUpdateDate) as datetime),'1',XSEAL_DAY)) as DATETIME)
                                             ELSE DFT_BNG_SUB_DATE
                                           END  --可開始扣款日 = 核印回覆日 + CTL015.SEAL_DAY個公司營業日
             WHERE SUB_BANK_CODE = WBANK_BRH
               AND SUB_ACCOUNT_NO = WACCOUNT_NO
               AND SUB_ID_NO = WSUB_ID_NO
               AND SEAL_TYPE = WSEAL_TYPE
               AND RSP_NO = XRSP_NO
               AND RSP_SRNO = XRSP_SRNO
               AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1'))
               AND ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE);
        END;

        IF (WSOURCE_CD = '2') THEN --RSP013
        BEGIN
            SET XRSP_NO = XRELATIVE_NO;
            SET XRSP_SRNO = WRELATIVE_SRNO;
            SET XRSP_CHG_NO = WVOUCH_NO;
            SET XRSP_CHG_SRNO = WVOUCH_SRNO;

            UPDATE dbo.RSP013
               SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                  ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
                  ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                          CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                          ELSE XUpdateDate END
                                        END
                  ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                  ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
             WHERE dbo.f_Nvl(RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE) = WBANK_BRH
               AND dbo.f_Nvl(RSP013.AFT_SUB_ACCOUNT_NO, RSP013.BEF_SUB_ACCOUNT_NO) = WACCOUNT_NO
               AND dbo.f_Nvl(AFT_SUB_ID_NO, BEF_SUB_ID_NO) = WSUB_ID_NO
               AND dbo.f_Nvl(AFT_SEAL_TYPE, BEF_SEAL_TYPE) = WSEAL_TYPE
               AND RSP_CHG_NO = XRSP_CHG_NO
               AND RSP_CHG_SRNO = XRSP_CHG_SRNO
               AND IS_SEAL_YN = 'Y'
               AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1'))
               AND ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE);
        END;
        END IF;

        --有批次轉入的資料也要一同更新
        IF (WSOURCE_CD IN ('3','4')) THEN --BMS005
        BEGIN
            IF WSOURCE_CD = '3' THEN
            BEGIN
                SET XRSP_NO = WVOUCH_NO;
                SET XRSP_SRNO = WVOUCH_SRNO;
                SET XRSP_CHG_NO = 'ALL';
                SET XRSP_CHG_SRNO = 0;
            END
            ELSE
            BEGIN
                SET XRSP_NO = XRELATIVE_NO;
                SET XRSP_SRNO = WRELATIVE_SRNO;
            END;
            END IF;

            --20100504, Modify by rgb for 核印回覆時更新OFD607A
            SELECT REMIT_CFM_NO, DATA_SEQ
              INTO #BMS005_TMP
              FROM dbo.BMS005
             INNER JOIN BMS001
                ON dbo.BMS005.BF_NO = BMS001.BF_NO
             INNER JOIN OFD020V
                ON dbo.BMS005.BANK_BRH = OFD020V.BANK_BRH
             WHERE WBANK_BRH = CASE WHEN OFD020V.BANK_TYPE IN ('04', '05') THEN BMS005.BANK_BRH
                                    ELSE dbo.f_GetBankHQ(BMS005.BANK_BRH) END
               AND ACCOUNT_NO = WACCOUNT_NO
               AND BMS001.ID_NO = WSUB_ID_NO
               AND SEAL_TYPE = WSEAL_TYPE
               AND REMIT_CFM_NO = XRSP_NO
               AND DATA_SEQ = XRSP_SRNO
               AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1' AND
                    ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE)));

            UPDATE OFD607A
               SET PROCESS_YN = 'Y'
              FROM OFD607A
              JOIN OFD601 ON OFD601.BF_SRNO = OFD607A.BF_SRNO
              JOIN BMS005 ON BMS005.BF_NO = OFD601.BF_NO
              JOIN #BMS005_TMP A
                ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
               AND A.DATA_SEQ = BMS005.DATA_SEQ;
            --20100517, Modify by rgb for 不過濾A2、B8
            -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

            UPDATE dbo.BMS005
               SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                  ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
                  ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                          CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                          ELSE XUpdateDate END
                                        END
                  ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                  ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
              FROM dbo.BMS005
              JOIN #BMS005_TMP A
                ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
               AND A.DATA_SEQ = BMS005.DATA_SEQ;
            DROP TABLE #BMS005_TMP;
        END;
        END IF;

        IF (WSOURCE_CD = '4') THEN --BMS005CHG
        BEGIN
            SET XRSP_NO = XRELATIVE_NO;
            SET XRSP_SRNO = WRELATIVE_SRNO;
            SET XRSP_CHG_NO = WVOUCH_NO;
            SET XRSP_CHG_SRNO = WVOUCH_SRNO;

            --20100504, Modify by rgb for 核印回覆時更新OFD607A
            SELECT BMS005CHG.BF_CHG_NO, BMS005CHG.DATA_SEQ
              INTO #BMS005CHG_TMP
              FROM dbo.BMS005CHG
             INNER JOIN BMS001CHG
                ON dbo.BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
             INNER JOIN OFD020V
                ON dbo.BMS005CHG.AFT_BANK_BRH = OFD020V.BANK_BRH
             WHERE BATCH_ID = WBATCH_ID
               AND WBANK_BRH = CASE WHEN OFD020V.BANK_TYPE IN ('04', '05')
                                    THEN dbo.f_Nvl(BMS005CHG.AFT_BANK_BRH, BMS005CHG.BEF_BANK_BRH)
                                    ELSE dbo.f_GetBankHQ(CONVERT(varchar(10),dbo.f_Nvl(BMS005CHG.AFT_BANK_BRH, BMS005CHG.BEF_BANK_BRH))) END
               AND dbo.f_Nvl(BMS005CHG.AFT_ACCOUNT_NO, BMS005CHG.BEF_ACCOUNT_NO) = WACCOUNT_NO
               AND dbo.f_Nvl(BMS005CHG.AFT_SEAL_TYPE, BMS005CHG.BEF_SEAL_TYPE) = WSEAL_TYPE
               AND BMS001CHG.AFT_ID_NO = WSUB_ID_NO
               AND BMS005CHG.BF_CHG_NO = WVOUCH_NO
               AND DATA_SEQ = WVOUCH_SRNO
               AND IS_SEAL_YN = 'Y'
               AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1' AND
                    ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE)));

            UPDATE OFD607A
               SET PROCESS_YN = 'Y'
              FROM OFD607A
              JOIN OFD601
                ON OFD601.BF_SRNO = OFD607A.BF_SRNO
              JOIN BMS005CHG
                ON BMS005CHG.BF_NO = OFD601.BF_NO
              JOIN #BMS005CHG_TMP A
                ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
               AND A.DATA_SEQ = BMS005CHG.DATA_SEQ
            --20100517, Modify by rgb for 不過濾A2、B8
            -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8');

            UPDATE dbo.BMS005CHG
               SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                  ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
                  ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                          CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                          ELSE XUpdateDate END
                                      END
                  ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                  ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
              FROM dbo.BMS005CHG
              JOIN #BMS005CHG_TMP A
                ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
               AND A.DATA_SEQ = BMS005CHG.DATA_SEQ;
            DROP TABLE #BMS005CHG_TMP;
        END;
        END IF;

        BEGIN
            SELECT COUNT(*)
              INTO XCOUNT
              FROM ECS.OFD701
             WHERE SUB_BANK_CODE = WBANK_BRH
               AND SUB_ACC_NO = WACCOUNT_NO
               AND SUB_ID_NO = WSUB_ID_NO
               AND SEAL_TYPE = WSEAL_TYPE
               AND RSP_NO = XRSP_NO
               AND RSP_SRNO = XRSP_SRNO
               AND RSP_CHG_NO = XRSP_CHG_NO
               AND RSP_CHG_SRNO = XRSP_CHG_SRNO
               AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1' AND
                    ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE)));

            EXCEPTION
                WHEN NO_DATA_FOUND THEN
                    MSG := '扣款帳號 (' || WBANK_BRH || ')' || WACCOUNT_NO || ' 已有核印回覆資料，請重新查詢';
                    RETURN;
        END;

        -- Insert statements for procedure here
        UPDATE ECS.OFD701
           SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
              ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
              ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
              ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
              ,RETURN_DATE = CASE WSEAL_STATUS WHEN '1' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE
                                    CASE WHEN RETURN_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') THEN RETURN_DATE
                                    ELSE XUpdateDate END
                                  END--核印回覆日期  送核時會清空
              ,RECEIPT_DOC_ID1 = CASE WHEN WSEAL_STATUS = '2' THEN 'N' ELSE RECEIPT_DOC_ID1 END
              ,RECEIPT_DOC_ID2 = CASE WHEN WSEAL_STATUS = '3' THEN 'N' ELSE RECEIPT_DOC_ID2 END
              ,UpdateID = WUpdateID
              ,UpdateDate = XUpdateDateTime
         WHERE SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND RSP_NO = XRSP_NO
           AND RSP_SRNO = XRSP_SRNO
           AND RSP_CHG_NO = XRSP_CHG_NO
           AND RSP_CHG_SRNO = XRSP_CHG_SRNO
           AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1' AND
                ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE)));

        --取得寫入核印回覆檔的資料
        SELECT '',
               TRADE_NO,
               SUB_BANK_CODE,
               ACC_SUB_ID,
               'N'
          INTO XSEAL_USER_NO,
               XTRADE_NO,
               XAGENT_BANK,
               XACC_SUB_ID,
               XISRETRY
          FROM ECS.OFD701
         WHERE BATCH_ID = WBATCH_ID
           AND SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND RSP_NO = XRSP_NO
           AND RSP_SRNO = XRSP_SRNO
           AND RSP_CHG_NO = XRSP_CHG_NO
           AND RSP_CHG_SRNO = XRSP_CHG_SRNO;

        SELECT ISRETRY
          INTO XISRETRY
          FROM ECS.OFD702
         WHERE BATCH_ID = WBATCH_ID
           AND SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND RSP_NO = XRSP_NO
           AND RSP_SRNO = XRSP_SRNO
           AND RSP_CHG_NO = XRSP_CHG_NO
           AND RSP_CHG_SRNO = XRSP_CHG_SRNO
           AND TRADE_TYPE = '0';
    END;
    END IF;
    */

    IF (WSEAL_TYPE = '2' OR WSEAL_TYPE = '3' OR XRSP_SEAL_TYPE = 'A') THEN
    BEGIN

        SELECT COUNT(*)
          INTO XCOUNT
          FROM ECS.OFD701
         WHERE SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND (WRETURN_DATE = TO_DATE('1900/1/1','YYYY/MM/DD') OR (SEAL_STATUS = '1' AND WRETURN_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') AND
               /*((XON_LINE_DATE <= WSEAL_DATE AND*/ BATCH_ID = WBATCH_ID) /*OR XON_LINE_DATE > WSEAL_DATE ))*/);

        IF XCOUNT = 0 THEN
        BEGIN
            MSG := '扣款帳號 (' || WBANK_BRH || ')' || WACCOUNT_NO || ' 已有核印回覆資料，請重新查詢';
            RETURN;
        END;
        END IF;

        -- Insert statements for procedure here
        UPDATE ECS.OFD701
           SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
              ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE ' ' END --核印失敗代碼(公司)  必須存在OFD711檔中
              ,SEAL_FAIL_ID_BK = ' ' --核印失敗代碼(銀行)  必須存在OFD712檔中
              ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
              ,RETURN_DATE = CASE WSEAL_STATUS WHEN '1' THEN TO_DATE('1900/1/1','YYYY/MM/DD') ELSE
                                    CASE WHEN RETURN_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') THEN RETURN_DATE
                                    ELSE XUpdateDate END
                                  END--核印回覆日期  送核時會清空
              ,RECEIPT_DOC_ID1 = CASE WHEN WSEAL_STATUS = '2' THEN 'N' ELSE RECEIPT_DOC_ID1 END
              ,RECEIPT_DOC_ID2 = CASE WHEN WSEAL_STATUS = '3' THEN 'N' ELSE RECEIPT_DOC_ID2 END
              ,UpdateID = WUpdateID
              ,UpdateDate = XUpdateDateTime
         WHERE SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND (WRETURN_DATE = TO_DATE('1900/1/1','YYYY/MM/DD') OR (SEAL_STATUS = '1' AND WRETURN_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') AND
               /*((XON_LINE_DATE <= WSEAL_DATE AND*/ BATCH_ID = WBATCH_ID) /*OR XON_LINE_DATE > WSEAL_DATE ))*/);

        /*
        --20100504, Modify by rgb for 核印回覆時更新OFD607A
        SELECT REMIT_CFM_NO, DATA_SEQ
          INTO #BMS005_TMP1
          FROM dbo.BMS005
         INNER JOIN BMS001
            ON dbo.BMS005.BF_NO = BMS001.BF_NO
         INNER JOIN OFD020V
            ON dbo.f_GetBankHQ(dbo.BMS005.BANK_BRH) = OFD020V.BANK_BRH
         WHERE WBANK_BRH = CASE WHEN OFD020V.BANK_TYPE IN ('04','05') THEN BMS005.BANK_BRH ELSE dbo.f_GetBankHQ(BMS005.BANK_BRH) END
           AND ACCOUNT_NO = WACCOUNT_NO
           AND BMS001.ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           AND (WRETURN_DATE = '1900/1/1' OR
                (WRETURN_DATE <> '1900/1/1' AND (SEAL_STATUS IN ('0','1','9') OR
                                                  (SEAL_STATUS = '3' AND WSEAL_STATUS = '2' AND TERMINATE_DATE = '1900/01/01'))
                )
               );

        UPDATE OFD607A
           SET PROCESS_YN = 'Y'
          FROM OFD607A
          JOIN OFD601
            ON OFD601.BF_SRNO = OFD607A.BF_SRNO
          JOIN BMS005
            ON BMS005.BF_NO = OFD601.BF_NO
          JOIN #BMS005_TMP1 A
            ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
           AND A.DATA_SEQ = BMS005.DATA_SEQ;
        --20100517, Modify by rgb for 不過濾A2、B8
        -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')
        */

        -- 2019.09.11 ChengYu 新增FAS.HOLDER_BANK_EC(受益人扣款帳號)資料更新
        -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
        IF WSOURCE_CD = '3' THEN
        BEGIN
          MERGE INTO FAS.HOLDER_BANK_EC
          USING ( SELECT HOLDER_BANK_EC.ID
                           ,HOLDER_BANK_EC.AC_BANK
                           ,HOLDER_BANK_EC.AC_CODE
                           ,HOLDER_BANK_EC.DEPOSITORY_NO
                           ,HOLDER_BANK_EC.CURRENCY_NO
                      FROM FAS.HOLDER_BANK_EC
                     INNER JOIN FAS.HOLDER
                        ON HOLDER.ID = HOLDER_BANK_EC.ID
                     INNER JOIN FAS.FIS_BANK
                        ON FIS_BANK.BANK_NO = HOLDER_BANK_EC.AC_BANK
                     WHERE WBANK_BRH = HOLDER_BANK_EC.AC_BANK
                       AND HOLDER_BANK_EC.AC_CODE = WACCOUNT_NO
                       AND HOLDER_BANK_EC.ID = WSUB_ID_NO
                       AND HOLDER_BANK_EC.BATCH_ID = WBATCH_ID
                       AND HOLDER_BANK_EC.CURRENCY_NO != 'NTD'
                       AND HOLDER_BANK_EC.DEPOSITORY_NO = '01'
                          )BANK
                       ON (HOLDER_BANK_EC.ID = BANK.ID
                      AND HOLDER_BANK_EC.AC_BANK = BANK.AC_BANK
                      AND HOLDER_BANK_EC.AC_CODE = BANK.AC_CODE
                      AND HOLDER_BANK_EC.DEPOSITORY_NO = BANK.DEPOSITORY_NO
                      AND HOLDER_BANK_EC.CURRENCY_NO = BANK.CURRENCY_NO
                      AND ( WRETURN_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR
                           (WRETURN_DATE <> TO_DATE('1900/01/01','YYYY/MM/DD') AND (SEAL_STATUS IN ('0','1','9') OR (SEAL_STATUS = '3' AND WSEAL_STATUS = '2')))
                          )
                  )
             WHEN MATCHED THEN
                     UPDATE
                        SET  SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                            ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE
                                                           ELSE CASE WHEN WRETURN_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') THEN SEAL_DATE
                                                                     ELSE WSEAL_DATE
                                                                 END
                                          END
                            ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
                                                               ELSE CASE WHEN SEAL_RTN_DATE<>TO_DATE('1900/01/01','YYYY/MM/DD') THEN SEAL_RTN_DATE
                                                                         ELSE XUpdateDate
                                                                     END
                                              END
                            ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                            ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
                            -- 2020.03.06 ChengYu 和印完成時，更新【FAS.HOLDER_BANK_EC(受益人扣款帳號)】欄位 VERIFIED(核印完成日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
                            -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                            -- 2020.03.26 ChengYu 移除更新欄位DELIVERED(送交核印日期)
                            ,VERIFIED = CASE WSEAL_STATUS WHEN '3' THEN NULL ELSE SYSDATE END
                            ,REJECT_CODE = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END
                            ,REJECTED = CASE WSEAL_STATUS WHEN '3' THEN SYSDATE ELSE NULL END;
        END;
        ELSIF WSOURCE_CD = '4' THEN
        BEGIN
          -- 2020.03.11 ChengYu 修復外幣扣款帳號修改時核印功能
          -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
          MERGE INTO FAS.HOLDER_BANK_EC_CHANGE
          USING ( SELECT HOLDER_BANK_EC_CHANGE.ID
                         ,NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) NEW_AC_BANK
                         ,NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) NEW_AC_CODE
                         ,NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) DEPOSITORY_NO
                         ,NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) CURRENCY_NO
                    FROM FAS.HOLDER_BANK_EC_CHANGE
                   INNER JOIN FAS.HOLDER
                      ON HOLDER.ID = HOLDER_BANK_EC_CHANGE.ID
                   INNER JOIN FAS.FIS_BANK
                      ON FIS_BANK.BANK_NO = NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK)
                   WHERE NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = WBANK_BRH
                     AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = WACCOUNT_NO
                     AND HOLDER_BANK_EC_CHANGE.ID = WSUB_ID_NO
                     AND HOLDER_BANK_EC_CHANGE.BATCH_ID = WBATCH_ID
                     AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) != 'NTD'
                     AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = '01'
                )BANK
                     ON (HOLDER_BANK_EC_CHANGE.ID = BANK.ID
                    AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_BANK,HOLDER_BANK_EC_CHANGE.AC_BANK) = BANK.NEW_AC_BANK
                    AND NVL(HOLDER_BANK_EC_CHANGE.NEW_AC_CODE,HOLDER_BANK_EC_CHANGE.AC_CODE) = BANK.NEW_AC_CODE
                    AND NVL(HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO,HOLDER_BANK_EC_CHANGE.DEPOSITORY_NO_OLD) = BANK.DEPOSITORY_NO
                    AND NVL(HOLDER_BANK_EC_CHANGE.CURRENCY_NO,HOLDER_BANK_EC_CHANGE.CURRENCY_NO_OLD) = BANK.CURRENCY_NO
                    -- 2021.03.30 Chnegyu 修正帳號異動檔更新多筆問題
                    AND HOLDER_BANK_EC_CHANGE.BATCH_ID = WBATCH_ID
                    AND ( WRETURN_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') OR
                         (WRETURN_DATE <> TO_DATE('1900/01/01','YYYY/MM/DD') AND (SEAL_STATUS IN ('0','1','9') OR (SEAL_STATUS = '3' AND WSEAL_STATUS = '2')))
                        )
                )
           WHEN MATCHED THEN
                   UPDATE
                      SET  SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
                          ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE
                                                         ELSE CASE WHEN WRETURN_DATE = TO_DATE('1900/01/01','YYYY/MM/DD') THEN SEAL_DATE
                                                                   ELSE WSEAL_DATE
                                                               END
                                        END
                          ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN TO_DATE('1900/01/01','YYYY/MM/DD')
                                                             ELSE CASE WHEN SEAL_RTN_DATE<>TO_DATE('1900/01/01','YYYY/MM/DD') THEN SEAL_RTN_DATE
                                                                       ELSE XUpdateDate
                                                                   END
                                            END
                          ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
                          ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
                          -- 2020.03.06 ChengYu 和印完成時，更新【FAS.HOLDER_BANK_EC(受益人扣款帳號)】欄位 VERIFIED(核印完成日期)、REJECTED(退件日期)、REJECT_CODE(退件原因)
                          -- 2020.03.23 ChengYu 調整FAS.HOLDER_BANK_EC【受益人扣款帳號】與FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】中欄位DELIVERED(送交核印日期)、VERIFIED(核印完成日期)、REJECTED(退件日期)儲存值
                          ,VERIFIED = CASE WSEAL_STATUS WHEN '3' THEN NULL ELSE SYSDATE END
                          ,REJECT_CODE = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END
                          ,REJECTED = CASE WSEAL_STATUS WHEN '3' THEN SYSDATE ELSE NULL END;
           -- 2021.03.10 Chengyu 修正FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】對應條件、FAS.HOLDER_BANK_EC_CHANGE【EC往來銀行帳戶資料LOG】核印成功後更新資料至FAS.HOLDER_BANK_EC【受益人扣款帳號】
           IF WSEAL_STATUS = '2' THEN
           BEGIN
              SELECT  AC_BANK
                     ,AC_BRANCH
                     ,AC_CODE
                     ,AC_NAME
                     ,FIS_SNAME
                     ,CURRENCY_NO_OLD
                     ,DEPOSITORY_NO_OLD
                     ,NVL(NEW_AC_BANK,AC_BANK)
                     ,NVL(NEW_AC_BRANCH,AC_BRANCH)
                     ,NVL(NEW_AC_CODE,AC_CODE)
                     ,NVL(NEW_AC_NAME,AC_NAME)
                     ,NVL(NEW_FIS_SNAME,FIS_SNAME)
                     ,NVL(CURRENCY_NO,CURRENCY_NO_OLD)
                     ,NVL(DEPOSITORY_NO,DEPOSITORY_NO_OLD)
                     -- 2021.03.31 Chengyu 帳號異動檔更新至主檔時，需更新核印送件日
                     ,DELIVERED
                INTO  CHG_AC_BANK
                     ,CHG_AC_BRANCH
                     ,CHG_AC_CODE
                     ,CHG_AC_NAME
                     ,CHG_FIS_SNAME
                     ,CHG_CURRENCY_NO_OLD
                     ,CHG_DEPOSITORY_NO_OLD
                     ,CHG_NEW_AC_BANK
                     ,CHG_NEW_AC_BRANCH
                     ,CHG_NEW_AC_CODE
                     ,CHG_NEW_AC_NAME
                     ,CHG_NEW_FIS_SNAME
                     ,CHG_CURRENCY_NO
                     ,CHG_DEPOSITORY_NO
                     -- 2021.03.31 Chengyu 帳號異動檔更新至主檔時，需更新核印送件日
                     ,CHG_DELIVERED
                FROM FAS.HOLDER_BANK_EC_CHANGE
               WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
                 AND ID = WSUB_ID_NO
                 -- 2021.03.30 Chnegyu 修正帳號異動檔更新至主檔條件、核印失敗也需要更新主檔
                 AND BATCH_ID = WBATCH_ID
                 AND NVL(NEW_AC_BANK,AC_BANK) = WBANK_BRH
                 AND NVL(NEW_AC_CODE,AC_CODE) = WACCOUNT_NO
                 AND NVL(CURRENCY_NO,CURRENCY_NO_OLD) != 'NTD';

                 UPDATE FAS.HOLDER_BANK_EC
                   SET  HOLDER_BANK_EC.AC_BANK = NVL(CHG_NEW_AC_BANK,CHG_AC_BANK)
                       ,HOLDER_BANK_EC.AC_BRANCH = NVL(CHG_NEW_AC_BRANCH,CHG_AC_BRANCH)
                       ,HOLDER_BANK_EC.AC_CODE = NVL(CHG_NEW_AC_CODE,CHG_AC_CODE)
                       ,HOLDER_BANK_EC.AC_NAME = NVL(CHG_NEW_AC_NAME,CHG_AC_NAME)
                       ,HOLDER_BANK_EC.FIS_SNAME = NVL(CHG_NEW_FIS_SNAME,CHG_FIS_SNAME)
                       ,HOLDER_BANK_EC.CURRENCY_NO = NVL(CHG_CURRENCY_NO,CHG_CURRENCY_NO_OLD)
                       ,HOLDER_BANK_EC.DEPOSITORY_NO = NVL(CHG_DEPOSITORY_NO,CHG_DEPOSITORY_NO_OLD)
                       ,HOLDER_BANK_EC.SEAL_STATUS = '2'
                       ,HOLDER_BANK_EC.SEAL_DATE = WSEAL_DATE
                       ,HOLDER_BANK_EC.SEAL_RTN_DATE = XUpdateDate
                       -- 2021.03.31 Chengyu 帳號異動檔更新至主檔時，需更新核印送件日
                       ,HOLDER_BANK_EC.DELIVERED = CHG_DELIVERED
                       ,HOLDER_BANK_EC.VERIFIED = SYSDATE
                       ,HOLDER_BANK_EC.REJECTED = ''
                       ,HOLDER_BANK_EC.SEAL_FAIL_ID_CO = ' '
                       ,HOLDER_BANK_EC.SEAL_FAIL_ID_BK = ' '
                       ,HOLDER_BANK_EC.REJECT_CODE = ''
                       ,HOLDER_BANK_EC.BATCH_ID = WBATCH_ID
                       ,HOLDER_BANK_EC.TRADE_NO = XTRADE_NO
                 WHERE ID = WSUB_ID_NO
                   AND HOLDER_BANK_EC.AC_BANK = CHG_AC_BANK
                   AND HOLDER_BANK_EC.AC_CODE = CHG_AC_CODE
                   AND HOLDER_BANK_EC.CURRENCY_NO = CHG_CURRENCY_NO_OLD
                   AND HOLDER_BANK_EC.DEPOSITORY_NO = CHG_DEPOSITORY_NO_OLD;

           END;
           -- 2021.03.30 Chnegyu 修正帳號異動檔更新至主檔條件、核印失敗也需要更新主檔
           ELSIF WSEAL_STATUS = '3' THEN
           BEGIN
              SELECT  AC_BANK
                     ,AC_BRANCH
                     ,AC_CODE
                     ,AC_NAME
                     ,FIS_SNAME
                     ,CURRENCY_NO_OLD
                     ,DEPOSITORY_NO_OLD
                     ,NVL(NEW_AC_BANK,AC_BANK)
                     ,NVL(NEW_AC_BRANCH,AC_BRANCH)
                     ,NVL(NEW_AC_CODE,AC_CODE)
                     ,NVL(NEW_AC_NAME,AC_NAME)
                     ,NVL(NEW_FIS_SNAME,FIS_SNAME)
                     ,NVL(CURRENCY_NO,CURRENCY_NO_OLD)
                     ,NVL(DEPOSITORY_NO,DEPOSITORY_NO_OLD)
                     ,NEW_AC_BANK
                     ,DELIVERED
                     ,REJECTED       
                     ,REJECT_CODE    
                INTO  CHG_AC_BANK
                     ,CHG_AC_BRANCH
                     ,CHG_AC_CODE
                     ,CHG_AC_NAME
                     ,CHG_FIS_SNAME
                     ,CHG_CURRENCY_NO_OLD
                     ,CHG_DEPOSITORY_NO_OLD
                     ,CHG_NEW_AC_BANK
                     ,CHG_NEW_AC_BRANCH
                     ,CHG_NEW_AC_CODE
                     ,CHG_NEW_AC_NAME
                     ,CHG_NEW_FIS_SNAME
                     ,CHG_CURRENCY_NO
                     ,CHG_DEPOSITORY_NO
                     ,CHG_ORG_NEW_AC_BANK
                     ,CHG_DELIVERED
                     ,CHG_REJECTED
                     ,CHG_REJECT_CODE
                FROM FAS.HOLDER_BANK_EC_CHANGE
               WHERE DEPOSITORY_NO = '01'   --帳戶保管平台代號 01：財金；02：其他銀行；04：集保
                 AND ID = WSUB_ID_NO
                 AND BATCH_ID = WBATCH_ID
                 AND NVL(NEW_AC_BANK,AC_BANK) = WBANK_BRH
                 AND NVL(NEW_AC_CODE,AC_CODE) = WACCOUNT_NO
                 AND NVL(CURRENCY_NO,CURRENCY_NO_OLD) != 'NTD';

                 UPDATE FAS.HOLDER_BANK_EC
                   SET  HOLDER_BANK_EC.SEAL_STATUS = '3'
                       ,HOLDER_BANK_EC.SEAL_DATE = WSEAL_DATE
                       ,HOLDER_BANK_EC.SEAL_RTN_DATE = XUpdateDate
                       ,HOLDER_BANK_EC.VERIFIED = ''
                       ,HOLDER_BANK_EC.DELIVERED = CHG_DELIVERED
                       ,HOLDER_BANK_EC.REJECTED = CHG_REJECTED
                       ,HOLDER_BANK_EC.SEAL_FAIL_ID_CO = CHG_REJECT_CODE
                       ,HOLDER_BANK_EC.SEAL_FAIL_ID_BK = ' '
                       ,HOLDER_BANK_EC.REJECT_CODE = CHG_REJECT_CODE
                       ,HOLDER_BANK_EC.BATCH_ID = WBATCH_ID
                       ,HOLDER_BANK_EC.TRADE_NO = XTRADE_NO
                 WHERE ID = WSUB_ID_NO
                   AND HOLDER_BANK_EC.AC_BANK = CHG_AC_BANK
                   AND HOLDER_BANK_EC.AC_CODE = CHG_AC_CODE
                   AND HOLDER_BANK_EC.CURRENCY_NO = CHG_CURRENCY_NO_OLD
                   AND HOLDER_BANK_EC.DEPOSITORY_NO = CHG_DEPOSITORY_NO_OLD
                   AND CHG_ORG_NEW_AC_BANK IS NULL; --再送核印條件
           END;
           END IF;

        END;
        END IF;

        /*翻成上列寫法
        UPDATE dbo.BMS005
           SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
              ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE
                                  CASE WHEN WRETURN_DATE = '1900/1/1' THEN SEAL_DATE ELSE WSEAL_DATE END
                                END
              ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                      CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                      ELSE XUpdateDate END
                                    END
              ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
              ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
          FROM dbo.BMS005
          JOIN #BMS005_TMP1 A
            ON A.REMIT_CFM_NO = BMS005.REMIT_CFM_NO
           AND A.DATA_SEQ = BMS005.DATA_SEQ;
        DROP TABLE #BMS005_TMP1;
        */

        /*
        --20100504, Modify by rgb for 核印回覆時更新OFD607A
        SELECT BMS005CHG.BF_CHG_NO, BMS005CHG.DATA_SEQ
          INTO #BMS005_TMP2
          FROM dbo.BMS005CHG
         INNER JOIN BMS001CHG
            ON dbo.BMS005CHG.BF_CHG_NO = BMS001CHG.BF_CHG_NO
         INNER JOIN OFD020V
            ON dbo.BMS005CHG.AFT_BANK_BRH = OFD020V.BANK_BRH
         WHERE WBANK_BRH = CASE WHEN OFD020V.BANK_TYPE IN ('04', '05')
                                THEN dbo.f_Nvl(BMS005CHG.AFT_BANK_BRH, BMS005CHG.BEF_BANK_BRH)
                                ELSE dbo.f_GetBankHQ(CONVERT(varchar(10),dbo.f_Nvl(BMS005CHG.AFT_BANK_BRH, BMS005CHG.BEF_BANK_BRH))) END
           AND dbo.f_Nvl(BMS005CHG.AFT_ACCOUNT_NO, BMS005CHG.BEF_ACCOUNT_NO) = WACCOUNT_NO
           AND dbo.f_Nvl(BMS005CHG.AFT_SEAL_TYPE, BMS005CHG.BEF_SEAL_TYPE) = WSEAL_TYPE
           AND BMS001CHG.AFT_ID_NO = WSUB_ID_NO
           --AND BMS001CHG.CHG_UPD_DTTM = '1900/1/1'
           AND BMS005CHG.IS_SEAL_YN = 'Y'
           AND ((SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1') OR WRETURN_DATE = '1900/1/1');

        UPDATE OFD607A              --境內基金網路交易受益人權限記錄檔
           SET PROCESS_YN = 'Y'     --是否需要處理，Y：需要，N：不需要
          FROM OFD607A
          JOIN OFD601
            ON OFD601.BF_SRNO = OFD607A.BF_SRNO
          JOIN BMS005CHG
            ON BMS005CHG.BF_NO = OFD601.BF_NO
          JOIN #BMS005_TMP2 A
            ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
           AND A.DATA_SEQ = BMS005CHG.DATA_SEQ;
        --20100517, Modify by rgb for 不過濾A2、B8
        -- WHERE OFD607A.PROGRESS NOT IN ('A2','B8')

        UPDATE dbo.BMS005CHG
           SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
              ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
              ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                      CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                      ELSE XUpdateDate END
                                    END
              ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
              ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
          FROM dbo.BMS005CHG
          JOIN #BMS005_TMP2 A
            ON A.BF_CHG_NO = BMS005CHG.BF_CHG_NO
           AND A.DATA_SEQ = BMS005CHG.DATA_SEQ;
        DROP TABLE #BMS005_TMP2;
        */

        /*
        UPDATE dbo.RSP006
           SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
              ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
              ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                      CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                      ELSE XUpdateDate END
                                    END
              ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
              ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
              ,DFT_BNG_SUB_DATE = CASE WHEN WSEAL_STATUS = '2' AND DFT_BNG_SUB_DATE = '1900/1/1'
                                         THEN CAST(dbo.f_Nvl(DFT_BNG_SUB_DATE,dbo.f_GetBusinessDay(cast(dbo.f_Nvl(SEAL_RTN_DATE,XUpdateDate) as datetime),'1',XSEAL_DAY)) as DATETIME)
                                         ELSE DFT_BNG_SUB_DATE
                                       END  --可開始扣款日 = 核印回覆日 + CTL015.SEAL_DAY個公司營業日
        WHERE SUB_BANK_CODE = WBANK_BRH
          AND SUB_ACCOUNT_NO = WACCOUNT_NO
          AND SUB_ID_NO = WSUB_ID_NO
          AND SEAL_TYPE = WSEAL_TYPE
          AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1'))
          AND ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE);
       */

       /*
       UPDATE dbo.RSP013
          SET SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
             ,SEAL_DATE = CASE WSEAL_STATUS WHEN '1' THEN WSEAL_DATE ELSE SEAL_DATE END
             ,SEAL_RTN_DATE = CASE WSEAL_STATUS WHEN '1' THEN '1900/1/1' ELSE
                                     CASE WHEN SEAL_RTN_DATE<>'1900/1/1' THEN SEAL_RTN_DATE
                                     ELSE XUpdateDate END
                                   END
             ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
             ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
        WHERE dbo.f_Nvl(RSP013.AFT_SUB_BANK_CODE,RSP013.BEF_SUB_BANK_CODE) = WBANK_BRH
          AND dbo.f_Nvl(RSP013.AFT_SUB_ACCOUNT_NO, RSP013.BEF_SUB_ACCOUNT_NO) = WACCOUNT_NO
          AND dbo.f_Nvl(RSP013.AFT_SUB_ID_NO, RSP013.BEF_SUB_ID_NO) = WSUB_ID_NO
          AND dbo.f_Nvl(RSP013.AFT_SEAL_TYPE, RSP013.BEF_SEAL_TYPE) = WSEAL_TYPE
          --AND RSP013.CHG_UPD_DTTM = '1900/1/1'
          AND RSP013.IS_SEAL_YN = 'Y'
          AND (WRETURN_DATE = '1900/1/1' OR (SEAL_STATUS = '1' AND WRETURN_DATE <> '1900/1/1'))
          AND ((XON_LINE_DATE <= WSEAL_DATE AND BATCH_ID = WBATCH_ID) OR XON_LINE_DATE > WSEAL_DATE);
       */

        --取得寫入核印回覆檔的資料
        SELECT SEAL_USER_NO,
               TRADE_NO,
               ACC_SUB_ID,
               'ALL',
               0,
               'ALL',
               0,
               'N',
               -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
               NEW_OLD
          INTO XSEAL_USER_NO,
               XTRADE_NO,
               XACC_SUB_ID,
               XRSP_NO,
               XRSP_SRNO,
               XRSP_CHG_NO,
               XRSP_CHG_SRNO,
               XISRETRY,
               -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
               XNEW_OLD
          FROM ECS.OFD701
         WHERE BATCH_ID = WBATCH_ID
           AND SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE;

        --for各核印方式只有一家代理行的情況下
        SELECT DATA_CENTER
          INTO XAGENT_BANK
          FROM ECS.OFD074
         WHERE BANK_HQ = SUBSTR(WBANK_BRH,1,3)
           AND SEAL_TYPE = WSEAL_TYPE
           AND BANK_SUB_TYPE IN ('1','2','4','5')
           AND ROWNUM = 1;

    END;
    END IF;

    --更新核印回覆檔
    --核印中則刪除核印回覆資料
    IF (WSEAL_STATUS = '1') THEN
    BEGIN
        DELETE FROM ECS.OFD702
         WHERE (BATCH_ID = WBATCH_ID OR BATCH_ID = 'OLD9999999999')
           AND SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           -- 2015.09.15 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
           AND RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE XRSP_NO END)
           AND RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_SRNO END)
           AND RSP_CHG_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE XRSP_CHG_NO END)
           AND RSP_CHG_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_CHG_SRNO END)
           AND TRADE_TYPE = '1';
    END;
    ELSE
    --成功或失敗同步更新回覆狀態
    BEGIN
        UPDATE  ECS.OFD702
           SET  SEAL_STATUS = WSEAL_STATUS --核印狀態  0：未送；1：核印中；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核  (CTL014：232)
               ,SEAL_FAIL_ID_CO = CASE WSEAL_STATUS WHEN '3' THEN WSEAL_FAIL_ID_CO ELSE '' END --核印失敗代碼(公司)  必須存在OFD711檔中
               ,SEAL_FAIL_ID_BK = '' --核印失敗代碼(銀行)  必須存在OFD712檔中
               ,TRADE_DATE = CASE WHEN TRADE_DATE <> TO_DATE('1900/1/1','YYYY/MM/DD') THEN TRADE_DATE ELSE XUpdateDate END
               ,UpdateID = WUpdateID
               ,UpdateDate = XUpdateDateTime
         WHERE (BATCH_ID = WBATCH_ID OR BATCH_ID = 'OLD9999999999')
           AND SUB_BANK_CODE = WBANK_BRH
           AND SUB_ACC_NO = WACCOUNT_NO
           AND SUB_ID_NO = WSUB_ID_NO
           AND SEAL_TYPE = WSEAL_TYPE
           -- 2015.09.15 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
           AND RSP_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE  XRSP_NO END)
           AND RSP_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_SRNO END)
           AND RSP_CHG_NO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE XRSP_CHG_NO END)
           AND RSP_CHG_SRNO = (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_CHG_SRNO END)
           AND TRADE_TYPE = '1';

        IF (SQL%ROWCOUNT = 0) THEN
        BEGIN
            INSERT INTO ECS.OFD702
                   (DATA_SEQ,
                    BATCH_ID, BATCH_SRNO, SUB_BANK_CODE, SUB_ACC_NO, SEAL_TYPE,
                    TRADE_TYPE, TRADE_DATE,
                    SEAL_STATUS, SEAL_FAIL_ID_BK, SEAL_FAIL_ID_CO, SEAL_USER_NO,TRADE_NO,AGENT_BANK,
                    SUB_ID_NO, ACC_SUB_ID, SOURCE_CD,
                    RSP_NO,
                    RSP_SRNO,
                    RSP_CHG_NO,
                    RSP_CHG_SRNO,
                    ISRETRY,
                    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
                    NEW_OLD,
                    -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
                    STATUS,CreateID ,CreateDate ,UpdateID ,UpdateDate ,EntryID ,EntryDate ,VerifyID ,VerifyDate , ApproveID, ApproveDate)
            VALUES ((SELECT NVL(MAX(DATA_SEQ),0) + 1 FROM ECS.OFD702),
                    NVL(WBATCH_ID, 'OLD9999999999'), 1, WBANK_BRH, WACCOUNT_NO,
                    WSEAL_TYPE, '1', XUpdateDate,
                    WSEAL_STATUS, '', WSEAL_FAIL_ID_CO, XSEAL_USER_NO, XTRADE_NO, XAGENT_BANK,
                    -- 2015.09.15 Joyce Mod 依據CTL015控制檔決定By帳號或契約送核調整
                    WSUB_ID_NO, XACC_SUB_ID, WSOURCE_CD,
                    (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE XRSP_NO END),
                    (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_SRNO END),
                    (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 'ALL' ELSE XRSP_CHG_NO END),
                    (CASE XRSP_SEAL_TYPE WHEN 'A' THEN 0 ELSE XRSP_CHG_SRNO END),
                    XISRETRY,
                    -- 2020.03.16 ChengYu 調整成以SOURCE_CD(申請書來源)來區分更新Table、ECS.OFD702新增儲存欄位NEW_OLD、CreateDate、UpdateDate、EntryDate、VerifyDate、ApproveDate
                    XNEW_OLD,
                    -- 2019.11.12 ChengYu 寫入ECS.OFD702【扣款帳號核印歷史記錄檔】增加欄位STATUS(資料狀態碼)
                    '301', WUpdateID, XUpdateDateTime, WUpdateID, XUpdateDateTime, WUpdateID, XUpdateDateTime, WUpdateID, XUpdateDateTime, WUpdateID, XUpdateDateTime);
        END;
        END IF;
    END;
    END IF;

END s_SealProof_ReturnProcess;

/

  GRANT EXECUTE ON "ECS"."S_SEALPROOF_RETURNPROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SENDEMAIL
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SENDEMAIL" 
(
     WMAIL_CLASS_NO         VARCHAR2,                -- Mail 類別碼
     OUTDT                  OUT SYS_REFCURSOR        -- 回傳的 TABLEDATA
) IS

XCHECK	    INTEGER;        -- 檢查資料是否存在
XIS_SUCCESS VARCHAR2(1);    --取得資料成功否
XWARNS_TYPE VARCHAR2(1);    --警示方式
XERROR_MSG  VARCHAR2(250);  --錯誤訊息

BEGIN

  SELECT COUNT(*) INTO XCHECK
    FROM ECS.SWMAILCLASS
   WHERE MAILCLASSID = WMAIL_CLASS_NO;

  IF XCHECK > 0 THEN

    XIS_SUCCESS := 'Y';
    XWARNS_TYPE := '';
    XERROR_MSG  := '';

  ELSE

    XIS_SUCCESS := 'N';

    SELECT MSGTYPE, MSGCONTENT
            INTO XWARNS_TYPE, XERROR_MSG
            FROM ECS.MSGINFO
           WHERE MSGID = 'A005';

  END IF;

  OPEN OUTDT FOR
     SELECT  XIS_SUCCESS AS IS_SUCCESS             -- 是否成功
             ,XWARNS_TYPE AS WARNS_TYPE            -- 警示方式
             ,XERROR_MSG  AS ERROR_MSG             -- 錯誤訊息
             FROM DUAL;

END s_SendEMail;

/

  GRANT EXECUTE ON "ECS"."S_SENDEMAIL" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SENDFORGETACCKEY
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SENDFORGETACCKEY" 
-- =============================================
-- Author:      YungLong
-- Create date: 2018/08/28
-- Description: 寄發忘記密碼信件
-- 2018.09.07 JIANXIN 驗證登入帳號與生日是否正確
-- 2019.05.08 tingting 增加傳出欄位：Email顯示前三碼
-- 2020.05.28 Chengyu 新增EMAIL是否有效檢核
-- =============================================
(
     WID                    VARCHAR2              -- 登入帳號
    ,WBIRTH_DATE            DATE                  -- 生日
    ,OUTDT                  OUT SYS_REFCURSOR     -- MASTER
) IS

XCHECK	    INTEGER;        -- 檢查資料是否存在
XEMAIL_3    VARCHAR2(60);   -- Email 顯示前三碼
XIS_SUCCESS VARCHAR2(1);    --取得資料成功否
XWARNS_TYPE VARCHAR2(1);    --警示方式
XERROR_MSG  VARCHAR2(250);  --錯誤訊息
XEMAIL_VALID VARCHAR2(1);   --是否通過EMAIL驗證

BEGIN

    SELECT COUNT(*) 
      INTO XCHECK
      FROM FAS.HOLDER
     WHERE ID = WID
       AND BIRTH_DATE = WBIRTH_DATE;

    IF XCHECK > 0 THEN

        SELECT  ECS.FN_STUFF_STR(HOLDER.EMAIL,3,'○','ER')
               ,EMAIL_VALID
          INTO  XEMAIL_3
               ,XEMAIL_VALID
          FROM FAS.HOLDER
         WHERE ID = WID
           AND BIRTH_DATE = WBIRTH_DATE;

        IF XEMAIL_VALID = 'Y' THEN

           XIS_SUCCESS := 'Y';
           XWARNS_TYPE := '';
           XERROR_MSG  := '';

        ELSE
           -- 2020.05.28 Chengyu 新增EMAIL是否有效檢核
           XIS_SUCCESS := 'N';

           SELECT MSGTYPE, MSGCONTENT
             INTO XWARNS_TYPE, XERROR_MSG
             FROM ECS.MSGINFO
            WHERE MSGID = 'KEY002';

        END IF;
    ELSE

        XIS_SUCCESS := 'N';

        SELECT MSGTYPE, MSGCONTENT
          INTO XWARNS_TYPE, XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'KEY001';

    END IF;

    OPEN OUTDT FOR
    SELECT  XEMAIL_3    AS EMAIL_3               -- Email 顯示前三碼
           ,XIS_SUCCESS AS IS_SUCCESS            -- 是否成功
           ,XWARNS_TYPE AS WARNS_TYPE            -- 警示方式
           ,XERROR_MSG  AS ERROR_MSG             -- 錯誤訊息
      FROM DUAL;

END;

/

  GRANT EXECUTE ON "ECS"."S_SENDFORGETACCKEY" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SENDFORGETUSERALIAS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SENDFORGETUSERALIAS" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2023/12/03
-- Description: 寄發忘記使用者代碼信件
-- =============================================
(
     WID                    VARCHAR2              -- 登入帳號
    ,WBIRTH_DATE            DATE                  -- 生日
    ,OUTDT                  OUT SYS_REFCURSOR     -- MASTER
) IS

XCHECK	    INTEGER;        -- 檢查資料是否存在
XEMAIL_3    VARCHAR2(60);   -- Email 顯示前三碼
XIS_SUCCESS VARCHAR2(1);    --取得資料成功否
XWARNS_TYPE VARCHAR2(1);    --警示方式
XERROR_MSG  VARCHAR2(250);  --錯誤訊息
XEMAIL_VALID VARCHAR2(1);   --是否通過EMAIL驗證

BEGIN

    SELECT COUNT(*) 
      INTO XCHECK
      FROM FAS.HOLDER
     WHERE ID = WID
       AND BIRTH_DATE = WBIRTH_DATE;

    IF XCHECK > 0 THEN

        SELECT  ECS.FN_STUFF_STR(HOLDER.EMAIL,3,'○','ER')
               ,EMAIL_VALID
          INTO  XEMAIL_3
               ,XEMAIL_VALID
          FROM FAS.HOLDER
         WHERE ID = WID
           AND BIRTH_DATE = WBIRTH_DATE;

        IF XEMAIL_VALID = 'Y' THEN

           XIS_SUCCESS := 'Y';
           XWARNS_TYPE := '';
           XERROR_MSG  := '';

        ELSE
           XIS_SUCCESS := 'N';

           SELECT MSGTYPE, MSGCONTENT
             INTO XWARNS_TYPE, XERROR_MSG
             FROM ECS.MSGINFO
            WHERE MSGID = 'KEY002';

        END IF;
    ELSE

        XIS_SUCCESS := 'N';

        SELECT MSGTYPE, MSGCONTENT
          INTO XWARNS_TYPE, XERROR_MSG
          FROM ECS.MSGINFO
         WHERE MSGID = 'KEY001';

    END IF;

    OPEN OUTDT FOR
    SELECT  XEMAIL_3    AS EMAIL_3               -- Email 顯示前三碼
           ,XIS_SUCCESS AS IS_SUCCESS            -- 是否成功
           ,XWARNS_TYPE AS WARNS_TYPE            -- 警示方式
           ,XERROR_MSG  AS ERROR_MSG             -- 錯誤訊息
      FROM DUAL;

END;

/

  GRANT EXECUTE ON "ECS"."S_SENDFORGETUSERALIAS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SETTABLE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SETTABLE" IS
tmpVar NUMBER;
/******************************************************************************
   NAME:       S_SETTABLE
   PURPOSE:    

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        2010/2/11          1. Created this procedure.

   NOTES:

   Automatically available Auto Replace Keywords:
      Object Name:     S_SETTABLE
      Sysdate:         2010/2/11
      Date and Time:   2010/2/11, 下午 06:23:58, and 2010/2/11 下午 06:23:58
      Username:         (set in TOAD Options, Procedure Editor)
      Table Name:      AA_DEPT (set in the "New PL/SQL Object" dialog)

******************************************************************************/
BEGIN
   tmpVar := 0;
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END S_SETTABLE;

/

  GRANT EXECUTE ON "ECS"."S_SETTABLE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_SETUPUSERID
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_SETUPUSERID" 
(
  -- Add the parameters for the stored procedure here
  v_LogID_Update IN VARCHAR2 DEFAULT '' ,
  v_LogID_Approve IN VARCHAR2 DEFAULT '' ,
  v_DBUpdateDate IN DATE DEFAULT NULL 
)
AS
   v_temp NUMBER(1, 0) := 0;

BEGIN

   -- SET NOCOUNT ON added to prevent extra result sets from
   -- interfering with SELECT statements.
   --SET NOCOUNT ON;  -- blake : 若加 SET NOCOUNT ON 指令 , 則 DAAB 的 ExecuteNonQuery 指令 得到的回傳值永遠會是 -1 
   NULL/*TODO:SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED*/;
   BEGIN
      SELECT 1 INTO v_temp
        FROM DUAL
       WHERE EXISTS ( SELECT *
                      FROM DBLoginUser 
                       WHERE SPID = UID
                               AND UpdateDate = v_DBUpdateDate );
   EXCEPTION
      WHEN OTHERS THEN
         NULL;
   END;

   IF v_temp = 1 THEN
      DELETE DBLoginUser

       WHERE SPID = UID
               AND UpdateDate = v_DBUpdateDate;
   END IF;
   -- Insert statements for procedure here
   INSERT INTO DBLoginUser
     VALUES (DBLOGINUSER_SRNO_SEQ.Nextval ,UID, v_LogID_Update, v_LogID_Approve, v_DBUpdateDate );
   NULL/*TODO:SET TRANSACTION ISOLATION LEVEL READ COMMITTED*/;
END;

/

  GRANT EXECUTE ON "ECS"."S_SETUPUSERID" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_UPDATEBATCHJOBPROCESS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_UPDATEBATCHJOBPROCESS" (
  BATCHNO IN NUMBER,
  JOBSTATUS IN NUMBER,
  JOBENDTIME IN DATE DEFAULT NULL,
  JOBACTRECORDS IN NUMBER DEFAULT NULL,
  JOBMSG IN NCLOB DEFAULT NULL,
  PROCESSSTATUS IN CHAR DEFAULT '0',
  PROCESSCONTENT IN NCLOB DEFAULT NULL
)
IS
  V_SQL VARCHAR2(1000);
  V_CONDITIONSQL VARCHAR2(500) := '';
BEGIN

V_CONDITIONSQL := V_CONDITIONSQL || ',JOBENDTIME=:JOBENDTIME';
V_CONDITIONSQL := V_CONDITIONSQL || ',JOBACTRECORDS=:JOBACTRECORDS';
V_CONDITIONSQL := V_CONDITIONSQL || ',JOBMSG=:JOBMSG';


V_SQL := 'UPDATE BATCHJOBPROCESS
          SET JOBSTATUS = :JOBSTATUS ' || V_CONDITIONSQL || ' WHERE BATCHNO = :BATCHNO';

EXECUTE IMMEDIATE V_SQL USING JOBSTATUS,JOBENDTIME,JOBACTRECORDS,JOBMSG,BATCHNO;

S_CREATEBATCHJOBLOG(BATCHNO,PROCESSSTATUS,PROCESSCONTENT,'');

END S_UPDATEBATCHJOBPROCESS;

/

  GRANT EXECUTE ON "ECS"."S_UPDATEBATCHJOBPROCESS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_UPDATEBFDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_UPDATEBFDATA" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/27
-- Description: 變更受益人基本資料
-- 2018.03.28 Jim 補IP_ADR
-- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
-- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
-- 2018.08.13 tingting 加入API024-UpdateKYCData需使用的欄位
-- 2018.08.15 JIANXIN 調整API024 傳入傳出參數
-- 2018.09.27 tingting 加入API-SaveRoboSign需使用的欄位
-- 2018.10.03 JIANXIN 更新KYC 到期日期必須-1 天
-- 2018.10.08 JIANXIN KYC 變更狀態要改為 "1. 已交付"
-- 2018.10.18 JIANXIN 弱勢族群增加判斷
-- 2018.10.21 JIANXIN 弱勢族群增加異動內容
-- 2018.10.24 ChengYu 不新增、更新弱勢族群評估欄位(VULNERABLE_GROUP)
-- 2018.10.25 JIANXIN 密碼異動新增 寄送方式 欄位
-- 2018.10.26 JIANXIN 移除弱勢族群增加異動內容
-- 2018.11.19 JIANXIN 新增KYC 異動 服務單位名稱
-- 2018.12.06 JIANXIN 異動地址與郵遞區號，必須是全形
-- 2019.01.23 yunchu 調整ECCSB014變更ID，LDAP執行後更新【變更ID記錄(ECS.ID_CHANGE_LOG)】檔
-- 2019.07.23 JIANXIN 增加寫入檔案AML_HOLDER的資料
-- 2019.07.24 JIANXIN 對應法人與自然人職業別
-- 2019.07.25 ChengYu 調整新增AML_HOLDER資料
-- 2019.07.29 JIANXIN 調整職業別欄位對應錯誤問題
-- 2019.07.30 tingting 調整API-UpdateKYCData呼叫，才取職業別是否為高風險
-- 2020.09.05 JIANXIN 因網頁沒有更新姓名，所以直接寫入原本的姓名
-- 2021.03.24 JIANXIN 新增受益人異動備註
-- 2021.03.26 JIANXIN 新增受益人異動備註-通訊地址、調整Null無法判斷的問題
-- 2021.04.23 Chengyu 修正NEW_RISK_WRITE_DATE欄位寫入邏輯，若無異動KYC寫入FAS.HOLDER欄位RISK_WRITE_DATE
-- 2022.08.04 JIANXIN 新增KYC 題目內容
-- 2022.09.27 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
-- 2023.01.03 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
-- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
-- 2023.05.22 JIANXIN 更新欄位增加更新EMP_NO
-- 2023.12.02 JIANXIN 新增使用者代碼
-- 2023.12.05 JIANXIN 調整異動別代碼 A.使用者代碼 變成 a.使用者代碼
-- 2024.03.07 JIANXIN 當使用者代碼=null，代表是透過延長使用者代碼進來
-- 2024.03.19 RICHARD 修改 TX_TYPE = 'L' 時更新FAS.HOLDER 的RISK_WRITE_DATE / RISK_MAT_DATE , 有機率性為null 
-- =============================================
(
    WACCOUNT_NO                         INTEGER,        -- 戶號
    WTX_PWD                             VARCHAR2,       -- 交易密碼
    -- 2018.03.28 Jim 補IP_ADR
    WIP_ADR                             VARCHAR2,       -- IP位址
    WNAME                               VARCHAR2,       -- 受益人名稱
    WMOBILE_COUNTRY                     VARCHAR2,       -- 行動電話-國家碼
    WMOBILE                             VARCHAR2,       -- 行動電話-電話碼
    WTEL_O_COUNTRY                      VARCHAR2,       -- 聯絡電話(公)- 國家碼
    WTEL_O_AREA                         VARCHAR2,       -- 聯絡電話(公)-區域碼
    WTEL_O_NO                           VARCHAR2,       -- 電話(公) – 電話
    WTEL_O_EXT                          VARCHAR2,       -- 電話(公) – 分機
    WTEL_H_COUNTRY                      VARCHAR2,       -- 電話(宅) – 國碼
    WTEL_H_AREA                         VARCHAR2,       -- 電話(宅) – 區碼
    WTEL_H_NO                           VARCHAR2,       -- 電話(宅) – 電話
    WTEL_H_EXT                          VARCHAR2,       -- 電話(宅) – 分機
    WFAX_COUNTRY                        VARCHAR2,       -- 傳真1 – 國碼
    WFAX_AREA                           VARCHAR2,       -- 傳真1 – 區碼
    WFAX_NO                             VARCHAR2,       -- 傳真1 – 電話
    WFAX_EXT                            VARCHAR2,       -- 傳真1 – 分機
    WEMAIL                              VARCHAR2,       -- EMAIL
    WCONTACT_ADDRESS_COUNTRY            VARCHAR2,       -- 地址國碼
    --通訊地址-城市
    --通訊地址-區域
    WPOST_CODE                          VARCHAR2,       -- 郵遞區號
    WCONTACT_ADDRESS                    VARCHAR2,       -- 通訊地址
    -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
    WEDM_ACCEPTED                       VARCHAR2,       -- 訂閱瀚亞電子報
    WNAV_EPAPER                         VARCHAR2,       -- 訂閱淨值電子報
    -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
    WTX_TYPE                            VARCHAR2,       -- 異動別 7：網路交易　L：風險等級　Q：密碼補發/變更  G：綜合開戶　b：ROBO簽署 a：使用者代碼
    -- ====================KYC 異動參數 ==============================
    -- 2022.09.27 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
    WRISK_LEVEL                         VARCHAR2,       -- 客戶風險屬性 1:保守 2:穩健 3:積極
    WEMPLOYER                           VARCHAR2,       -- 服務單位名稱
    WCUST_FAMILY_STATUS                 VARCHAR2,       -- 家庭狀況 1:單身 2:已婚 3:其他
    WCUST_FAMILY_STATUS_OTHERS          VARCHAR2,       -- 家庭狀況 其他(說明)
    WCUST_CHILD_STATUS                  VARCHAR2,       -- 家庭狀況1:無(小孩) 2:有(小孩)
    WCUST_CHILD_STATUS_TXT              VARCHAR2,       -- 家庭狀況_小孩人數
    WPROFESSION                         VARCHAR2,       -- 職業別(KYC) 目前分類，請參閱FAS.PROFESSION
    WPROFESSION_OTHERS_NEW              VARCHAR2,       -- 職業別_其他_新(KYC)
    WPOSITION                           VARCHAR2,       -- 職務(KYC) 01:企業負責人 02:中/高階主管 03:基層主管 04:專業人員 05:一般職員 06:業務 07:其他
    WPOSITION_OTHERS                    VARCHAR2,       -- 職務_其他(KYC)
    WINV_ORI                            VARCHAR2,       -- 投資資金來源(可複選)\1：薪資/執業所得或其他經常性收入；2：休金/保險年金；3：租賃所得；4：遺產餽贈；5：投資所得(資本所得、利息收入)；6：閒置資金；7：其他 複選時，填入範例：1,3,5
    WINV_ORI_OTHERS                     VARCHAR2,       -- 投資資金來源_其他
    WCUST_INV_FINSOURCE                 VARCHAR2,       -- 投資理財資訊來源(可複選) 1：證券商或投顧公司等專業機構提供；2：書報雜誌；3：網際網路；4：其他 複選時，填入範例：1,3,5
    WCUST_INV_FINSOURCE_OTHERS          VARCHAR2,       -- 投資理財資訊來源_其他
    WCUST_INV_ESTAMT                    VARCHAR2,       -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
    WCUST_RESIDENCE_STATUS              VARCHAR2,       -- 目前居住及照護狀態
    WCUST_RESIDENCE_STATUS_OTHERS       VARCHAR2,       -- 目前居住及照護狀態_其他
    WCUST_MIND_STATUS                   VARCHAR2,       -- 目前身心狀態
    WMAJOR_ILLNESS                      VARCHAR2,       -- 重大傷病證明 Y:有 N:無 D:無勾選
    WMAJOR_ILLNESS_REMARK               VARCHAR2,       -- 重大傷病備註

    WCUST_RISK_AGE                      VARCHAR2,       -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
    WEDUCATION                          VARCHAR2,       -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
    WCUST_RISK_INVTOOL                  VARCHAR2,       -- 常使用的投資理財工具  1:定存 2:倩券 3:基金 4:股票 5:期貨
    WCUST_RISK_INVEXP                   VARCHAR2,       -- 投資經驗  1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
    WCUST_RISK_INVPURPOSE               VARCHAR2,       -- 最主要投資目的  1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值
    WFAMILY_INCOME                      VARCHAR2,       -- 個人或家庭平均年收入 A:50萬以下 B:20~100萬 C:100~300萬 D:300~500萬 E:500萬以上
    WCUST_RISK_INVPROFIT                VARCHAR2,       -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
    WCUST_RISK_FUNDING                  VARCHAR2,       -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
    WCUST_RISK_FLUIDITY                 VARCHAR2,       -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
    WCUST_RISK_PRICEVOL                 VARCHAR2,       -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

    -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
    WVULNERABLE_CLAIM                   VARCHAR2,       -- 自主申購聲明\1：空值；2：同意；3：不同意
    WKYC_SCROE                          INT,            -- KYC 分數

    --2023.12.02 JIANXIN 新增使用者代碼
    WUSER_ALIAS                         VARCHAR2        -- 使用者代碼
) IS

--宣告變數
XID                   VARCHAR2(10);   -- 受益人ID
XDATE	                DATE := SYSDATE;  -- 修改日期
-- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
XECS                  VARCHAR2(6) := 'ECS';  -- 修改人員
XROBO_AGREEMENT       VARCHAR2(1) := 'Y';    -- ROBO同意書\Y:是  N:否
-- 2019.07.23 JIANXIN 增加寫入檔案AML_HOLDER的資料
XP_RISK               VARCHAR2(1) ;          -- 是否為高風險\Y:是  N:否
/*2024.03.19 RICHARD 紀錄原資料日期與改後資料日期 begin */
XRISK_WRITE_DATE      DATE;
XRISK_MAT_DATE        DATE;
XRISK_WRITE_DATE_OLD  DATE;
XRISK_MAT_DATE_OLD    DATE;
XRISK_DATE_MISS       EXCEPTION;
/*2024.03.19 RICHARD 紀錄原資料日期與改後資料日期 end */

BEGIN

  BEGIN

    BEGIN
      --取得受益人ID
      SELECT ID INTO XID
         FROM FAS.HOLDER
         WHERE ACCOUNT_NO = WACCOUNT_NO;

      EXCEPTION
        WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得受益人ID，請檢查！');

    END;

    -- 2019.07.30 tingting 調整API-UpdateKYCData呼叫，才取職業別是否為高風險
    IF WTX_TYPE = 'L' THEN
    BEGIN

        SELECT P_RISK INTO XP_RISK
          FROM FAS.PROFESSION
          -- 2019.07.29 JIANXIN 調整職業別欄位對應錯誤問題
         WHERE PROFESSION = WPROFESSION
           -- 2019.07.24 JIANXIN 對應法人與自然人職業別
           AND IR_CODE = (SELECT CASE WHEN C_TYPE IN ('2','4','6','7') THEN 'I' ELSE 'R' END
                            FROM FAS.HOLDER
                           WHERE ID = XID);
        /*2024.03.19 RICHARD 將日期去除時:分:秒 , 取得修改前RISK_WRITE_DATE,RISK_MAT_DATE */
        SELECT RISK_WRITE_DATE,RISK_MAT_DATE INTO XRISK_WRITE_DATE_OLD,XRISK_MAT_DATE_OLD FROM FAS.HOLDER WHERE ID = XID;
        /*2024.03.19 RICHARD 將日期去除時:分:秒 end */

      EXCEPTION
        WHEN NO_DATA_FOUND THEN RAISE_APPLICATION_ERROR(-20000, '無法取得職業別是否為高風險，請檢查！');

    END;
    END IF;

    INSERT INTO FAS.HOLDER_CHANGE
          (--舊資料
            ID                                  -- 受益人ID
            -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
           ,TX_TYPE                             -- 異動別 7：網路交易　L：風險等級　Q：密碼補發/變更  G：綜合開戶　b：ROBO簽署
           ,NAME                                -- 戶名
           ,MOBILE_COUNTRY                      -- 行動電話 – 國碼
           ,MOBILE                              -- 行動電話
           ,TEL_O_COUNTRY                       -- 電話(公) – 國碼
           ,TEL_O_AREA                          -- 電話(公) – 區碼
           ,TEL_O_NO                            -- 電話(公) – 電話
           ,TEL_O_EXT                           -- 電話(公) – 分機
           ,TEL_H_COUNTRY                       -- 電話(宅) – 國碼
           ,TEL_H_AREA                          -- 電話(宅) – 區碼
           ,TEL_H_NO                            -- 電話(宅) – 電話
           ,TEL_H_EXT                           -- 電話(宅) – 分機
           ,FAX_COUNTRY                         -- 傳真1 – 國碼
           ,FAX_AREA                            -- 傳真1 – 區碼
           ,FAX_NO                              -- 傳真1 – 電話
           ,FAX_EXT                             -- 傳真1 – 分機
           ,EMAIL                               -- EMAIL
           ,CONTACT_ADDRESS_COUNTRY             -- 地址國碼
           --通訊地址-城市
           --通訊地址-區域
           ,POST_CODE                           -- 郵遞區號
           ,CONTACT_ADDRESS                     -- 通訊地址
           -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
           ,EDM_ACCEPTED                        -- 訂閱瀚亞電子報\Y:是 N:否
           ,NAV_EPAPER                          -- 訂閱淨值電子報，Y/N
           --新資料
           ,NEW_NAME       	  	                -- 新戶名
           ,NEW_MOBILE_COUNTRY                  -- 新行動電話 – 國碼
           ,NEW_MOBILE                          -- 新行動電話
           ,NEW_TEL_O_COUNTRY                   -- 新電話(公) – 國碼
           ,NEW_TEL_O_AREA                      -- 新電話(公) – 區碼
           ,NEW_TEL_O_NO                        -- 新電話(公) – 電話
           ,NEW_TEL_O_EXT                       -- 新電話(公) – 分機
           ,NEW_TEL_H_COUNTRY                   -- 新電話(宅) – 國碼
           ,NEW_TEL_H_AREA                      -- 新電話(宅) – 區碼
           ,NEW_TEL_H_NO                        -- 新電話(宅) – 電話
           ,NEW_TEL_H_EXT                       -- 新電話(宅) – 分機
           ,NEW_FAX_COUNTRY                     -- 新傳真1 – 國碼
           ,NEW_FAX_AREA                        -- 新傳真1 – 區碼
           ,NEW_FAX_NO                          -- 新傳真1 – 電話
           ,NEW_FAX_EXT                         -- 新傳真1 – 分機
           ,NEW_EMAIL                           -- 新EMAIL
           ,NEW_CONTACT_ADDRESS_COUNTRY         -- 新地址國碼
           --通訊地址-城市
           --通訊地址-區域
           ,NEW_POST_CODE                       -- 新郵遞區號
           ,NEW_CONTACT_ADDRESS                 -- 新通訊地址
           -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
           ,NEW_EDM_ACCEPTED                    -- (新)訂閱瀚亞電子報\Y:是 N:否
           ,NEW_NAV_EPAPER                      -- 新-訂閱淨值電子報，Y/N
           -- 2018.08.08 tingting 加入API024- UpdateKYCData需使用的欄位
           ,RISK_LEVEL                          -- 客戶風險屬性 1:保守 2:穩健 3:積極
           ,NEW_RISK_LEVEL                      -- (新)新客戶風險屬性 1:保守 2:穩健 3:積極

           ,IS_KYC                              -- 法人KYC評估
           ,NEW_IS_KYC                          -- (新)法人KYC評估
           ,RISK_STATUS                         -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
           ,NEW_RISK_STATUS                     -- 新適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
           ,RISK_WRITE_DATE                     -- 適合度分析表最後一次填寫日
           ,NEW_RISK_WRITE_DATE                 -- 新適合度分析表最後一次填寫日
           ,RISK_MAT_DATE                       -- 適合度分析表最後一次填寫到期日
           ,NEW_RISK_MAT_DATE                   -- 新適合度分析表最後一次填寫到期日
           ,RISK_OTHER_PAPER                    -- 交付其他文件類型 1:財報
           ,NEW_RISK_OTHER_PAPER                -- 新交付其他文件類型 1:財報
           -- 2022.08.04 JIANXIN 新增KYC 題目內容
           ,FS_YEAR                             -- FS_YEAR
           ,NEW_FS_YEAR                         -- (新)FS_YEAR
           -- 2018.09.27 tingting 加入API-SaveRoboSign需使用的欄位
           ,ROBO_AGREEMENT                      -- ROBO同意書\Y:是  N:否
           ,NEW_ROBO_AGREEMENT                  -- (新)ROBO同意書\Y:是  N:否
           ,ROBO_DATE                           -- ROBO同意書簽署日期
           ,NEW_ROBO_DATE                       -- (新)ROBO同意書簽署日期
           -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
           ,CREATED_BY                          -- 建檔人員
           ,CREATION_DATE                       -- 建檔日期
           ,REVISED_BY                          -- 修改人員
           ,REVISION_DATE                       -- 修改日期
           ,REVIEWED_BY                         -- 覆核人員
           ,REVIEW_DATE                         -- 覆核日期
           ,EMP_NO                              -- 員工代碼
           ,LAST_MODIFIED                       -- 最後修改日期
           ,STATUS                              -- 狀態  O:資料開放 C:資料確認 E:資料錯誤
           ,APPLY_TYPE                          -- 申請變更方式  1:填寫申請書 2:網路申請
           -- 2018.10.25 JIANXIN 密碼異動新增 寄送方式 欄位
           ,SEND_TYPE                           -- 補發 EC 密碼方式  1:Email 2:SMS
           -- 2021.03.24 JIANXIN 新增受益人異動備註
           ,REMARK                              -- 備註

           -- =================KYC 題目異動=========================
           -- 2022.09.27 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
           ,EMPLOYER                            -- 服務單位名稱
           ,NEW_EMPLOYER                        -- (新)服務單位名稱
           ,CUST_FAMILY_STATUS                  -- 家庭狀況1:單身 2:已婚 3:其他
           ,NEW_CUST_FAMILY_STATUS              -- (新)家庭狀況1:單身 2:已婚 3:其他
           ,CUST_FAMILY_STATUS_TXT              -- 家庭狀況_其他(說明)
           ,NEW_CUST_FAMILY_STATUS_TXT          -- (新)家庭狀況_其他(說明)
           ,CUST_CHILD_STATUS                   -- 家庭狀況1:無(小孩) 2:有(小孩)
           ,NEW_CUST_CHILD_STATUS               -- (新)家庭狀況1:無(小孩) 2:有(小孩)
           ,CUST_CHILD_STATUS_TXT               -- 家庭狀況_小孩人數
           ,NEW_CUST_CHILD_STATUS_TXT           -- (新)家庭狀況_小孩人數
           ,PROFESSION                          -- 職業別(KYC) 目前分類，請參閱FAS.PROFESSION
           ,NEW_PROFESSION                      -- (新)職業別(KYC)
           ,PROFESSION_OTHERS_NEW               -- 職業別_其他_新(KYC)
           ,NEW_PROFESSION_OTHERS_NEW           -- (新)職業別_其他_新(KYC)
           ,POSITION                            -- 職務(KYC) 01:企業負責人 02:中/高階主管 03:基層主管 04:專業人員 05:一般職員 06:業務 07:其他
           ,NEW_POSITION                        -- (新)職務(KYC)
           ,POSITION_OTHERS                     -- 職務_其他(KYC)
           ,NEW_POSITION_OTHERS                 -- (新)職務_其他(KYC)
           ,CUST_INV_FUNDS_1                　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
           ,NEW_CUST_INV_FUNDS_1                -- 新投資資金來源(複選)(薪資/執業所得或其他經常性收入)
           ,CUST_INV_FUNDS_2                　　-- 投資資金來源(複選)(退休金/保險年金)
           ,NEW_CUST_INV_FUNDS_2                -- 新投資資金來源(複選)(退休金/保險年金)
           ,CUST_INV_FUNDS_3                　　-- 投資資金來源(複選)(租賃所得)
           ,NEW_CUST_INV_FUNDS_3                -- 新投資資金來源(複選)(租賃所得)
           ,CUST_INV_FUNDS_4                　　-- 投資資金來源(複選)(遺產餽贈)
           ,NEW_CUST_INV_FUNDS_4                -- 新投資資金來源(複選)(遺產餽贈)
           ,CUST_INV_FUNDS_5                　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
           ,NEW_CUST_INV_FUNDS_5                -- 新投資資金來源(複選)(投資所得(資本所得、利息收入))
           ,CUST_INV_FUNDS_6                　　-- 投資資金來源(複選)(閒置資金)
           ,NEW_CUST_INV_FUNDS_6                -- 新投資資金來源(複選)(閒置資金)
           ,CUST_INV_FUNDS_7                　　-- 投資資金來源(複選)(其他)
           ,NEW_CUST_INV_FUNDS_7                -- 新投資資金來源(複選)(其他)
           ,CUST_INV_FUNDS_7_TXT                -- 投資資金來源_其他(說明)
           ,NEW_CUST_INV_FUNDS_7_TXT            -- 新投資資金來源_其他(說明)
           ,CUST_INV_FINSOURCE_1                -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
           ,NEW_CUST_INV_FINSOURCE_1            -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
           ,CUST_INV_FINSOURCE_2                -- 投資理財資訊來源(可複選)書報雜誌
           ,NEW_CUST_INV_FINSOURCE_2            -- (新)投資理財資訊來源(可複選)書報雜誌
           ,CUST_INV_FINSOURCE_3                -- 投資理財資訊來源(可複選)網際網路
           ,NEW_CUST_INV_FINSOURCE_3            -- (新)投資理財資訊來源(可複選)網際網路
           ,CUST_INV_FINSOURCE_4                -- 投資理財資訊來源(可複選)其他
           ,NEW_CUST_INV_FINSOURCE_4            -- (新)投資理財資訊來源(可複選)其他
           ,CUST_INV_FINSOURCE_4_TXT            -- 投資理財資訊來源(可複選)其他(說明)
           ,NEW_CUST_INV_FINSOURCE_4_TXT        -- (新)投資理財資訊來源(可複選)其他(說明)
           ,CUST_INV_ESTAMT                     -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
           ,NEW_CUST_INV_ESTAMT                 -- (新)預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
           ,CUST_RESIDENCE_STATUS               -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
           ,NEW_CUST_RESIDENCE_STATUS           -- 新目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
           ,CUST_RESIDENCE_STATUS_TXT           -- 目前居住及照護狀態(說明)
           ,NEW_CUST_RESIDENCE_STATUS_TXT       -- 新目前居住及照護狀態(說明)
           ,CUST_MIND_STATUS                　　-- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
           ,NEW_CUST_MIND_STATUS                -- 新目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
           ,MAJOR_ILLNESS                       -- 重大傷病證明 Y:有 N:無 D:無勾選
           ,NEW_MAJOR_ILLNESS                   -- (新)重大傷病證明 Y:有 N:無 D:無勾選
           ,MAJOR_ILLNESS_REMARK                -- 重大傷病備註
           ,NEW_MAJOR_ILLNESS_REMARK            -- (新)重大傷病備註
           ,CUST_RISK_AGE                       -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
           ,NEW_CUST_RISK_AGE                   -- (新)客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
           ,EDUCATION                           -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
           ,NEW_EDUCATION                       -- (新)學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
           ,CUST_RISK_INVTOOL                   -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
           ,NEW_CUST_RISK_INVTOOL               -- (新)常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
           ,CUST_RISK_INVEXP                    -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
           ,NEW_CUST_RISK_INVEXP                -- (新)投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
           ,CUST_RISK_INVPURPOSE                -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值
           ,NEW_CUST_RISK_INVPURPOSE            -- (新)最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值           
           ,FAMILY_INCOME                       -- 個人或家庭平均年收入
           ,NEW_FAMILY_INCOME                   -- (新)個人或家庭平均年收入
           ,CUST_RISK_INVPROFIT                 -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
           ,NEW_CUST_RISK_INVPROFIT             -- (新)投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
           ,CUST_RISK_FUNDING                   -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
           ,NEW_CUST_RISK_FUNDING               -- (新)重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
           ,CUST_RISK_FLUIDITY                  -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
           ,NEW_CUST_RISK_FLUIDITY              -- (新)流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
           ,CUST_RISK_PRICEVOL                  -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動
           ,NEW_CUST_RISK_PRICEVOL              -- (新)價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

           -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
           ,VULNERABLE_CLAIM                    -- 自主申購聲明\1：空值；2：同意；3：不同意
           ,NEW_VULNERABLE_CLAIM                -- (新)自主申購聲明\1：空值；2：同意；3：不同意
           ,KYC_SCROE                           -- KYC 分數
           ,NEW_KYC_SCROE                       -- (新)KYC 分數
           -- ========== 舊欄位 目前不使用  ==========
           ,JOB_ROLE                            -- 職業別 - 第一版,已不使用
           ,NEW_JOB_ROLE                        -- (新)職業別 - 第一版,已不使用
           ,PERSONAL_INCOME                     -- 個人平均收人
           ,NEW_PERSONAL_INCOME                 -- (新)個人平均收人
           ,PROFESSION_OTHERS                   -- 職業別_其他(KYC)
           ,NEW_PROFESSION_OTHERS               -- (新)職業別_其他(KYC)

           ,USER_ALIAS                          -- 使用者代碼
           ,NEW_USER_ALIAS                      -- (新)使用者代碼
           ,USER_ALIAS_CHG_DATE                 -- 使用者代碼變更日期
           ,NEW_USER_ALIAS_CHG_DATE             -- (新)使用者代碼變更日期
           )
           --舊資料
    SELECT  ID
            -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
           ,WTX_TYPE
           ,NAME
           ,MOBILE_COUNTRY
           ,MOBILE
           ,TEL_O_COUNTRY
           ,TEL_O_AREA
           ,TEL_O_NO
           ,TEL_O_EXT
           ,TEL_H_COUNTRY
           ,TEL_H_AREA
           ,TEL_H_NO
           ,TEL_H_EXT
           ,FAX_COUNTRY
           ,FAX_AREA
           ,FAX_NO
           ,FAX_EXT
           ,EMAIL
           ,CONTACT_ADDRESS_COUNTRY
           --通訊地址-城市
           --通訊地址-區域
           ,POST_CODE
           ,CONTACT_ADDRESS
           -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
           ,EDM_ACCEPTED
           ,NAV_EPAPER
           --新資料
           -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
           -- 2020.09.05 JIANXIN 因網頁沒有更新姓名，所以直接寫入原本的姓名
           ,NAME
           ,CASE WHEN WTX_TYPE = '7' THEN WMOBILE_COUNTRY ELSE MOBILE_COUNTRY END
           ,CASE WHEN WTX_TYPE = '7' THEN WMOBILE ELSE MOBILE END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_O_COUNTRY ELSE TEL_O_COUNTRY END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_O_AREA ELSE TEL_O_AREA END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_O_NO ELSE TEL_O_NO END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_O_EXT ELSE TEL_O_EXT END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_H_COUNTRY ELSE TEL_H_COUNTRY END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_H_AREA ELSE TEL_H_AREA END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_H_NO ELSE TEL_H_NO END
           ,CASE WHEN WTX_TYPE = '7' THEN WTEL_H_EXT ELSE TEL_H_EXT END
           ,CASE WHEN WTX_TYPE = '7' THEN WFAX_COUNTRY ELSE FAX_COUNTRY END
           ,CASE WHEN WTX_TYPE = '7' THEN WFAX_AREA ELSE FAX_AREA END
           ,CASE WHEN WTX_TYPE = '7' THEN WFAX_NO ELSE FAX_NO END
           ,CASE WHEN WTX_TYPE = '7' THEN WFAX_EXT ELSE FAX_EXT END
           ,CASE WHEN WTX_TYPE = '7' THEN WEMAIL ELSE EMAIL END
           ,CASE WHEN WTX_TYPE = '7' THEN WCONTACT_ADDRESS_COUNTRY ELSE CONTACT_ADDRESS_COUNTRY END
           --通訊地址-城市
           --通訊地址-區域
           -- 2018.12.06 JIANXIN 異動地址與郵遞區號，必須是全形
           ,CASE WHEN WTX_TYPE = '7' THEN TO_MULTI_BYTE(WPOST_CODE) ELSE POST_CODE END
           ,CASE WHEN WTX_TYPE = '7' THEN TO_MULTI_BYTE(WCONTACT_ADDRESS) ELSE CONTACT_ADDRESS END
           -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
           ,CASE WHEN WTX_TYPE = '7' THEN WEDM_ACCEPTED ELSE EDM_ACCEPTED END
           ,CASE WHEN WTX_TYPE = '7' THEN WNAV_EPAPER ELSE NAV_EPAPER END
           -- 2018.08.08 tingting 加入API024- UpdateKYCData需使用的欄位
           -- 2018.08.15 JIANXIN 調整API024 傳入傳出參數
           ,RISK_LEVEL                                                                                                      -- 客戶風險屬性 1:保守 2:穩健 3:積極
           ,CASE WHEN WTX_TYPE = 'L' THEN WRISK_LEVEL ELSE RISK_LEVEL END NEW_RISK_LEVEL                                    -- (新)新客戶風險屬性 1:保守 2:穩健 3:積極

           ,IS_KYC                                                                                                          -- 法人KYC評估
           ,IS_KYC NEW_IS_KYC                                                                                               -- (新)法人KYC評估
           ,RISK_STATUS                                                                                                     -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
           -- 2018.10.08 JIANXIN KYC 變更狀態要改為 "1. 已交付"
           ,CASE WHEN WTX_TYPE = 'L' THEN '1' ELSE RISK_STATUS END NEW_RISK_STATUS                                          -- 新適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
           ,RISK_WRITE_DATE                                                                                                 -- 適合度分析表最後一次填寫日
           ,CASE WHEN WTX_TYPE = 'L' THEN XDATE ELSE RISK_WRITE_DATE END NEW_RISK_WRITE_DATE                                -- 新適合度分析表最後一次填寫日
           ,RISK_MAT_DATE                                                                                                   -- 適合度分析表最後一次填寫到期日
           -- 2021.04.23 Chengyu 修正NEW_RISK_WRITE_DATE欄位寫入邏輯，若無異動KYC寫入FAS.HOLDER欄位RISK_WRITE_DATE
           ,CASE WHEN WTX_TYPE = 'L' THEN ADD_MONTHS(XDATE,12) ELSE RISK_MAT_DATE END NEW_RISK_MAT_DATE                     -- 新適合度分析表最後一次填寫到期日 
           ,RISK_OTHER_PAPER                                                                                                -- 交付其他文件類型 1:財報
           ,RISK_OTHER_PAPER NEW_RISK_OTHER_PAPER                                                                           -- 新交付其他文件類型 1:財報


           ,FS_YEAR                                                                                                         -- FS_YEAR
           ,FS_YEAR NEW_FS_YEAR                                                                                             -- (新)FS_YEAR
           -- 2018.09.27 tingting 加入API-SaveRoboSign需使用的欄位
           ,ROBO_AGREEMENT                                                                                                  -- ROBO同意書\Y:是  N:否
           ,CASE WHEN WTX_TYPE = 'b' THEN XROBO_AGREEMENT ELSE ROBO_AGREEMENT END NEW_ROBO_AGREEMENT                        -- (新)ROBO同意書\Y:是  N:否
           ,ROBO_DATE                                                                                                       -- ROBO同意書簽署日期
           ,CASE WHEN WTX_TYPE = 'b' THEN XDATE ELSE ROBO_DATE END NEW_ROBO_DATE                                            -- (新)ROBO同意書簽署日期
           -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
           ,XECS
           ,XDATE
           ,XECS
           ,XDATE
           ,XECS
           ,XDATE
           ,XECS
           ,XDATE
           ,'R'
           ,'2'
           -- 2018.10.25 JIANXIN 密碼異動新增 寄送方式 欄位
           ,'1' AS SEND_TYPE                           -- 補發 EC 密碼方式  1:Email 2:SMS
           -- 2021.03.24 JIANXIN 新增受益人異動備註
           -- 2021.03.26 JIANXIN 新增受益人異動備註-通訊地址
           ,SUBSTR(CASE WHEN WTX_TYPE = '7' THEN CASE WHEN NVL(WMOBILE_COUNTRY,' ') <> NVL(HOLDER.MOBILE_COUNTRY,' ') OR NVL(WMOBILE,' ') <> NVL(HOLDER.MOBILE,' ') THEN '行動電話 ' ELSE '' END ||
                                                 CASE WHEN NVL(WTEL_O_COUNTRY,' ') <> NVL(HOLDER.TEL_O_COUNTRY,' ') OR NVL(WTEL_O_AREA,' ') <> NVL(HOLDER.TEL_O_AREA,' ') OR NVL(WTEL_O_NO,' ') <> NVL(HOLDER.TEL_O_NO,' ') OR NVL(WTEL_O_EXT,' ') <> NVL(HOLDER.TEL_O_EXT,' ') THEN '電話(公) ' ELSE '' END ||
                                                 CASE WHEN NVL(WTEL_H_COUNTRY,' ') <> NVL(HOLDER.TEL_H_COUNTRY,' ') OR NVL(WTEL_H_AREA,' ') <> NVL(HOLDER.TEL_H_AREA,' ') OR NVL(WTEL_H_NO,' ') <> NVL(HOLDER.TEL_H_NO,' ') OR NVL(WTEL_H_EXT,' ') <> NVL(HOLDER.TEL_H_EXT,' ') THEN '電話(宅) ' ELSE '' END ||
                                                 CASE WHEN NVL(WFAX_COUNTRY,' ') <> NVL(HOLDER.FAX_COUNTRY,' ') OR NVL(WFAX_AREA,' ') <> NVL(HOLDER.FAX_AREA,' ') OR NVL(WFAX_NO,' ') <> NVL(HOLDER.FAX_NO,' ')  OR NVL(WFAX_EXT,' ') <> NVL(HOLDER.FAX_EXT,' ') THEN '傳真電話 ' ELSE '' END ||
                                                 CASE WHEN NVL(TO_MULTI_BYTE(WCONTACT_ADDRESS),' ') <> NVL(HOLDER.CONTACT_ADDRESS,' ') OR NVL(WCONTACT_ADDRESS_COUNTRY,' ') <> NVL(HOLDER.CONTACT_ADDRESS_COUNTRY,' ') THEN '通訊地址 ' ELSE '' END ||
                                                 CASE WHEN NVL(WEMAIL,' ') <> NVL(HOLDER.EMAIL,' ') THEN '電郵 ' ELSE '' END ||
                                                 CASE WHEN NVL(WEDM_ACCEPTED,' ') <> NVL(HOLDER.EDM_ACCEPTED,' ') THEN CASE WHEN NVL(WEDM_ACCEPTED,' ') = 'Y' THEN '訂閱EDM '
                                                                                                          WHEN NVL(WEDM_ACCEPTED,' ') = 'N' THEN '不訂閱EDM '
                                                                                                          ELSE '' END
                                                                                                ELSE '' END
                        ELSE '' END ,1,30) AS REMARK

           -- =================KYC 題目異動=========================
           -- 2022.09.27 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
           ,EMPLOYER                                                                                                                      -- 服務單位名稱
           ,CASE WHEN WTX_TYPE = 'L' THEN WEMPLOYER ELSE EMPLOYER END NEW_EMPLOYER                                                        -- (新)服務單位名稱
           ,CUST_FAMILY_STATUS                                                                                                            -- 家庭狀況1:單身 2:已婚 3:其他
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_FAMILY_STATUS ELSE CUST_FAMILY_STATUS END NEW_CUST_FAMILY_STATUS                          -- (新)家庭狀況1:單身 2:已婚 3:其他
           ,CUST_FAMILY_STATUS_TXT                                                                                                        -- 家庭狀況_其他(說明)
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_FAMILY_STATUS_OTHERS ELSE CUST_FAMILY_STATUS_TXT END NEW_CUST_FAMILY_STATUS_TXT           -- (新)家庭狀況_其他(說明)           
            -- 2023.01.03 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
           ,CASE WHEN TRIM(CUST_CHILD_STATUS) = 'N' THEN '1' ELSE '2' END                                                                 -- 家庭狀況1:無(小孩) 2:有(小孩)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN TRIM(WCUST_CHILD_STATUS) = 'N' THEN '1' ELSE '2' END 
                 ELSE CASE WHEN TRIM(CUST_CHILD_STATUS) = 'N' THEN '1' ELSE '2' END END NEW_CUST_CHILD_STATUS                             -- (新)家庭狀況1:無(小孩) 2:有(小孩)
           ,CUST_CHILD_STATUS_TXT                                                                                                         -- 家庭狀況_小孩人數
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_CHILD_STATUS_TXT ELSE CUST_CHILD_STATUS_TXT END NEW_CUST_CHILD_STATUS_TXT                 -- (新)家庭狀況_小孩人數
           ,PROFESSION                                                                                                                    -- 職業別(KYC) 目前分類，請參閱FAS.PROFESSION
           ,CASE WHEN WTX_TYPE = 'L' THEN WPROFESSION ELSE PROFESSION END NEW_PROFESSION                                                  -- (新)職業別(KYC)
           ,PROFESSION_OTHERS_NEW                                                                                                         -- 職業別_其他_新(KYC)
           ,CASE WHEN WTX_TYPE = 'L' THEN WPROFESSION_OTHERS_NEW ELSE PROFESSION_OTHERS_NEW END NEW_PROFESSION_OTHERS_NEW                 -- (新)職業別_其他_新(KYC)
           ,POSITION                                                                                                                      -- 職務(KYC) 01:企業負責人 02:中/高階主管 03:基層主管 04:專業人員 05:一般職員 06:業務 07:其他
           ,CASE WHEN WTX_TYPE = 'L' THEN WPOSITION ELSE POSITION END NEW_POSITION                                                        -- (新)職務(KYC)
           ,POSITION_OTHERS                                                                                                               -- 職務_其他(KYC)
           ,CASE WHEN WTX_TYPE = 'L' THEN WPOSITION_OTHERS ELSE POSITION_OTHERS END NEW_POSITION_OTHERS                                   -- (新)職務_其他(KYC)

           ,CUST_INV_FUNDS_1                　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_1 END                -- 新投資資金來源(複選)(薪資/執業所得或其他經常性收入)
           ,CUST_INV_FUNDS_2                　　-- 投資資金來源(複選)(退休金/保險年金)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_2 END                -- 新投資資金來源(複選)(退休金/保險年金)
           ,CUST_INV_FUNDS_3                　　-- 投資資金來源(複選)(租賃所得)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_3 END                -- 新投資資金來源(複選)(租賃所得)
           ,CUST_INV_FUNDS_4                　　-- 投資資金來源(複選)(遺產餽贈)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_4 END                -- 新投資資金來源(複選)(遺產餽贈)
           ,CUST_INV_FUNDS_5                　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '5' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_5 END                -- 新投資資金來源(複選)(投資所得(資本所得、利息收入))
           ,CUST_INV_FUNDS_6                　　-- 投資資金來源(複選)(閒置資金)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '6' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_6 END                -- 新投資資金來源(複選)(閒置資金)
           ,CUST_INV_FUNDS_7                　　-- 投資資金來源(複選)(其他)
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '7' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_7 END                -- 新投資資金來源(複選)(其他)
           ,CUST_INV_FUNDS_7_TXT                -- 投資資金來源_其他(說明)
           ,CASE WHEN WTX_TYPE = 'L' THEN WINV_ORI_OTHERS　ELSE　CUST_INV_FUNDS_7_TXT END　NEW_CUST_INV_FUNDS_7_TXT            -- 新投資資金來源_其他(說明)

           ,CUST_INV_FINSOURCE_1                -- 投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_1 END NEW_CUST_INV_FINSOURCE_1            -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
           ,CUST_INV_FINSOURCE_2                -- 投資理財資訊來源(可複選)書報雜誌
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_2 END NEW_CUST_INV_FINSOURCE_2            -- (新)投資理財資訊來源(可複選)書報雜誌
           ,CUST_INV_FINSOURCE_3                -- 投資理財資訊來源(可複選)網際網路
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_3 END NEW_CUST_INV_FINSOURCE_3            -- (新)投資理財資訊來源(可複選)網際網路
           ,CUST_INV_FINSOURCE_4                -- 投資理財資訊來源(可複選)其他
           ,CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_4 END NEW_CUST_INV_FINSOURCE_4            -- (新)投資理財資訊來源(可複選)其他
           ,CUST_INV_FINSOURCE_4_TXT            -- 投資理財資訊來源(可複選)其他(說明)
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_INV_FINSOURCE_OTHERS ELSE　CUST_INV_FINSOURCE_4_TXT END NEW_CUST_INV_FINSOURCE_4_TXT        -- (新)投資理財資訊來源(可複選)其他(說明)

           ,CUST_INV_ESTAMT                     -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_INV_ESTAMT ELSE CUST_INV_ESTAMT END NEW_CUST_INV_ESTAMT                 -- (新)預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上

           ,CUST_RESIDENCE_STATUS               -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RESIDENCE_STATUS　ELSE　CUST_RESIDENCE_STATUS END　NEW_CUST_RESIDENCE_STATUS           -- 新目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
           ,CUST_RESIDENCE_STATUS_TXT           -- 目前居住及照護狀態(說明)
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RESIDENCE_STATUS_OTHERS　ELSE　CUST_RESIDENCE_STATUS_TXT END　NEW_CUST_RESIDENCE_STATUS       -- 新目前居住及照護狀態(說明)
           ,CUST_MIND_STATUS                　　-- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_MIND_STATUS　ELSE　CUST_MIND_STATUS END　NEW_CUST_RESIDENCE_STATUS                -- 新目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)

           ,MAJOR_ILLNESS                                                                                                                 -- 重大傷病證明 Y:有 N:無 D:無勾選
           ,CASE WHEN WTX_TYPE = 'L' THEN WMAJOR_ILLNESS ELSE MAJOR_ILLNESS END NEW_MAJOR_ILLNESS                                         -- (新)重大傷病證明 Y:有 N:無 D:無勾選
           ,MAJOR_ILLNESS_REMARK                                                                                                          -- 重大傷病備註
           ,CASE WHEN WTX_TYPE = 'L' THEN WMAJOR_ILLNESS_REMARK ELSE MAJOR_ILLNESS_REMARK END NEW_MAJOR_ILLNESS_REMARK                    -- (新)重大傷病備註

           ,CUST_RISK_AGE                       -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_AGE ELSE CUST_RISK_AGE END NEW_CUST_RISK_AGE                   -- (新)客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲

           ,EDUCATION                                                                                                       -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
           ,CASE WHEN WTX_TYPE = 'L' THEN WEDUCATION ELSE EDUCATION END NEW_EDUCATION                                       -- (新)學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上

           ,CUST_RISK_INVTOOL                   -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVTOOL ELSE CUST_RISK_INVTOOL END NEW_CUST_RISK_INVTOOL               -- (新)常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨
           ,CUST_RISK_INVEXP                    -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVEXP ELSE CUST_RISK_INVEXP END NEW_CUST_RISK_INVEXP                -- (新)投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上
           ,CUST_RISK_INVPURPOSE                -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVPURPOSE ELSE CUST_RISK_INVPURPOSE END NEW_CUST_RISK_INVPURPOSE            -- (新)最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值           
           ,FAMILY_INCOME                                                                                                   -- 個人或家庭平均年收入
           ,CASE WHEN WTX_TYPE = 'L' THEN WFAMILY_INCOME ELSE FAMILY_INCOME END NEW_FAMILY_INCOME                           -- (新)個人或家庭平均年收入
           ,CUST_RISK_INVPROFIT                 -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVPROFIT ELSE CUST_RISK_INVPROFIT END NEW_CUST_RISK_INVPROFIT             -- (新)投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼
           ,CUST_RISK_FUNDING                   -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_FUNDING ELSE CUST_RISK_FUNDING END NEW_CUST_RISK_FUNDING               -- (新)重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後
           ,CUST_RISK_FLUIDITY                  -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_FLUIDITY ELSE CUST_RISK_FLUIDITY END NEW_CUST_RISK_FLUIDITY              -- (新)流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上
           ,CUST_RISK_PRICEVOL                  -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動
           ,CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_PRICEVOL ELSE CUST_RISK_PRICEVOL END NEW_CUST_RISK_PRICEVOL              -- (新)價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

           -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
           ,VULNERABLE_CLAIM                    -- 自主申購聲明\1：空值；2：同意；3：不同意
           ,CASE WHEN WTX_TYPE = 'L' THEN WVULNERABLE_CLAIM ELSE VULNERABLE_CLAIM END NEW_VULNERABLE_CLAIM                  -- (新)自主申購聲明\1：空值；2：同意；3：不同意
           ,KYC_SCROE                                                                                                       -- KYC 分數
           ,CASE WHEN WTX_TYPE = 'L' THEN WKYC_SCROE ELSE KYC_SCROE END NEW_KYC_SCROE                                       -- (新)KYC 分數
           ,JOB_ROLE                                                                                                        -- 職業別 - 第一版,已不使用
           ,JOB_ROLE NEW_JOB_ROLE                                                                                           -- (新)職業別 - 第一版,已不使用
           ,PERSONAL_INCOME                                                                                                 -- 個人平均收人
           ,PERSONAL_INCOME NEW_PERSONAL_INCOME                                                                             -- (新)個人平均收人
           ,PROFESSION_OTHERS                                                                                               -- 職業別_其他(KYC)
           ,PROFESSION_OTHERS NEW_PROFESSION_OTHERS                                                                         -- (新)職業別_其他(KYC)

           -- 2023.12.02 JIANXIN 新增使用者代碼
           -- 2023.12.05 JIANXIN 調整異動別代碼 A.使用者代碼 變成 a.使用者代碼
           -- 2024.03.07 JIANXIN 當使用者代碼=null，代表是透過延長使用者代碼進來
           ,USER_ALIAS                                                                                                      -- 使用者代碼
           ,CASE WHEN WTX_TYPE = 'a' AND WUSER_ALIAS IS NOT NULL THEN ECS.CRYPT(WUSER_ALIAS) ELSE USER_ALIAS END NEW_USER_ALIAS                         -- (新)使用者代碼
           ,USER_ALIAS_CHG_DATE                                                                                                      -- 使用者代碼
           ,CASE WHEN WTX_TYPE = 'a' THEN XDATE ELSE USER_ALIAS_CHG_DATE END NEW_USER_ALIAS_CHG_DATE                         -- (新)使用者代碼

      FROM FAS.HOLDER
     WHERE ID = XID;

    -- 更新受益人基本資料
    UPDATE FAS.HOLDER
            -- 2018.08.04 JIANXIN 合併受益人更新密碼並增加異動別及異動相關欄位
       SET  MOBILE_COUNTRY = CASE WHEN WTX_TYPE = '7' THEN WMOBILE_COUNTRY ELSE MOBILE_COUNTRY END                              -- 行動電話 – 國碼
           ,MOBILE = CASE WHEN WTX_TYPE = '7' THEN WMOBILE ELSE MOBILE END                                                      -- 行動電話
           ,TEL_O_COUNTRY = CASE WHEN WTX_TYPE = '7' THEN WTEL_O_COUNTRY ELSE TEL_O_COUNTRY END                                 -- 電話(公) – 國碼
           ,TEL_O_AREA = CASE WHEN WTX_TYPE = '7' THEN WTEL_O_AREA ELSE TEL_O_AREA END                                          -- 電話(公) – 區碼
           ,TEL_O_NO = CASE WHEN WTX_TYPE = '7' THEN WTEL_O_NO ELSE TEL_O_NO END                                                -- 電話(公) – 電話
           ,TEL_O_EXT = CASE WHEN WTX_TYPE = '7' THEN WTEL_O_EXT ELSE TEL_O_EXT END                                             -- 電話(公) – 分機
           ,TEL_H_COUNTRY = CASE WHEN WTX_TYPE = '7' THEN WTEL_H_COUNTRY ELSE TEL_H_COUNTRY END                                 -- 電話(宅) – 國碼
           ,TEL_H_AREA = CASE WHEN WTX_TYPE = '7' THEN WTEL_H_AREA ELSE TEL_H_AREA END                                          -- 電話(宅) – 區碼
           ,TEL_H_NO = CASE WHEN WTX_TYPE = '7' THEN WTEL_H_NO ELSE TEL_H_NO END                                                -- 電話(宅) – 電話
           ,TEL_H_EXT = CASE WHEN WTX_TYPE = '7' THEN WTEL_H_EXT ELSE TEL_H_EXT END                                             -- 電話(宅) – 分機
           ,FAX_COUNTRY = CASE WHEN WTX_TYPE = '7' THEN WFAX_COUNTRY ELSE FAX_COUNTRY END                                       -- 傳真1 – 國碼
           ,FAX_AREA = CASE WHEN WTX_TYPE = '7' THEN WFAX_AREA ELSE FAX_AREA END                                                -- 傳真1 – 區碼
           ,FAX_NO = CASE WHEN WTX_TYPE = '7' THEN WFAX_NO ELSE FAX_NO END                                                      -- 傳真1 – 電話
           ,FAX_EXT = CASE WHEN WTX_TYPE = '7' THEN WFAX_EXT ELSE FAX_EXT END                                                   -- 傳真1 – 分機
           ,EMAIL = CASE WHEN WTX_TYPE = '7' THEN WEMAIL ELSE EMAIL END                                                         -- EMAIL
           ,CONTACT_ADDRESS_COUNTRY = CASE WHEN WTX_TYPE = '7' THEN WCONTACT_ADDRESS_COUNTRY ELSE CONTACT_ADDRESS_COUNTRY END   -- 地址國碼
           --通訊地址-城市
           --通訊地址-區域
           -- 2018.12.06 JIANXIN 異動地址與郵遞區號，必須是全形
           ,POST_CODE = CASE WHEN WTX_TYPE = '7' THEN TO_MULTI_BYTE(WPOST_CODE) ELSE POST_CODE END                                             -- 郵遞區號
           ,CONTACT_ADDRESS = CASE WHEN WTX_TYPE = '7' THEN TO_MULTI_BYTE(WCONTACT_ADDRESS) ELSE CONTACT_ADDRESS END                           -- 通訊地址
           -- 2018.05.29 ChengYu 新增 訂閱瀚亞電子報(EDM_ACCEPTED)、訂閱淨值電子報(NAV_EPAPER) 欄位
           ,EDM_ACCEPTED = CASE WHEN WTX_TYPE = '7' THEN WEDM_ACCEPTED ELSE EDM_ACCEPTED END                                    -- 訂閱瀚亞電子報\Y:是 N:否
           ,NAV_EPAPER = CASE WHEN WTX_TYPE = '7' THEN WNAV_EPAPER ELSE NAV_EPAPER END                                          -- 訂閱淨值電子報，Y/N

           -- 2018.09.27 tingting 加入API-SaveRoboSign需使用的欄位
           ,ROBO_AGREEMENT = CASE WHEN WTX_TYPE = 'b' THEN XROBO_AGREEMENT ELSE ROBO_AGREEMENT END                              -- ROBO同意書\Y:是  N:否
           ,ROBO_DATE = CASE WHEN WTX_TYPE = 'b' THEN XDATE ELSE ROBO_DATE END                                                  -- ROBO同意書簽署日期
           -- 2023.05.22 JIANXIN 更新欄位增加更新EMP_NO
           ,EMP_NO = XECS                                                                                                       -- 員工代碼(修改人員)                                                
           ,LAST_MODIFIED = XDATE                                                                                               -- 最後修改日期

           -- =================KYC 題目異動=========================
           -- 2022.09.27 JIANXIN 將KYC題目之答案全部寫入，並且重新整理傳入參數順序
           ,EMPLOYER = CASE WHEN WTX_TYPE = 'L' THEN WEMPLOYER ELSE EMPLOYER END                                                              -- 服務單位名稱 
           ,CUST_FAMILY_STATUS = CASE WHEN WTX_TYPE = 'L' THEN WCUST_FAMILY_STATUS ELSE CUST_FAMILY_STATUS END                                -- 家庭狀況1:單身 2:已婚 3:其他
           ,CUST_FAMILY_STATUS_TXT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_FAMILY_STATUS_OTHERS ELSE CUST_FAMILY_STATUS_TXT END                 -- 家庭狀況_其他(說明)
           -- 2023.01.03 JIANXIN 調整因應子女有無拋轉至FAS時，要由N：無、Y：有改為1：無、2：有
           ,CUST_CHILD_STATUS = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN TRIM(WCUST_CHILD_STATUS) = 'N' THEN '1' ELSE '2' END
                                     ELSE CUST_CHILD_STATUS END                                                                               -- 家庭狀況1:無(小孩) 2:有(小孩)
           ,CUST_CHILD_STATUS_TXT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_CHILD_STATUS_TXT ELSE CUST_CHILD_STATUS_TXT END                       -- 家庭狀況_小孩人數 
           ,PROFESSION = CASE WHEN WTX_TYPE = 'L' THEN WPROFESSION ELSE PROFESSION END                                                        -- 職業別(KYC)
           ,PROFESSION_OTHERS_NEW = CASE WHEN WTX_TYPE = 'L' THEN WPROFESSION_OTHERS_NEW ELSE PROFESSION_OTHERS_NEW END                       -- 職業別_其他_新(KYC)
           ,POSITION = CASE WHEN WTX_TYPE = 'L' THEN WPOSITION ELSE POSITION END                                                              -- 職務(KYC)
           ,POSITION_OTHERS = CASE WHEN WTX_TYPE = 'L' THEN WPOSITION_OTHERS ELSE POSITION_OTHERS END                                         -- 職務_其他(KYC)
           ,CUST_INV_FUNDS_1 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_1 END                　　-- 投資資金來源(複選)(薪資/執業所得或其他經常性收入)
           ,CUST_INV_FUNDS_2 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_2 END                　　-- 投資資金來源(複選)(退休金/保險年金)
           ,CUST_INV_FUNDS_3 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_3 END                　　-- 投資資金來源(複選)(租賃所得)
           ,CUST_INV_FUNDS_4 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_4 END                　　-- 投資資金來源(複選)(遺產餽贈)
           ,CUST_INV_FUNDS_5 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '5' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_5 END                　　-- 投資資金來源(複選)(投資所得(資本所得、利息收入))
           ,CUST_INV_FUNDS_6 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '6' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_6 END                　　-- 投資資金來源(複選)(閒置資金)
           ,CUST_INV_FUNDS_7 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WINV_ORI,',')) WHERE COLUMN_VALUE  = '7' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FUNDS_7 END                　　-- 投資資金來源(複選)(其他)
           ,CUST_INV_FUNDS_7_TXT = CASE WHEN WTX_TYPE = 'L' THEN WINV_ORI_OTHERS ELSE CUST_INV_FUNDS_7_TXT END                                -- 投資資金來源_其他(說明)
           ,CUST_INV_FINSOURCE_1 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '1' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_1 END             -- (新)投資理財資訊來源(可複選)證券商或投顧公司等專業機構提供
           ,CUST_INV_FINSOURCE_2 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '2' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_2 END             -- (新)投資理財資訊來源(可複選)書報雜誌
           ,CUST_INV_FINSOURCE_3 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '3' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_3 END             -- (新)投資理財資訊來源(可複選)網際網路
           ,CUST_INV_FINSOURCE_4 = CASE WHEN WTX_TYPE = 'L' THEN CASE WHEN (SELECT COUNT(1) FROM TABLE(ECS.FN_split(WCUST_INV_FINSOURCE,',')) WHERE COLUMN_VALUE  = '4' ) > 0 THEN 'Y' ELSE 'N' END ELSE CUST_INV_FINSOURCE_4 END             -- (新)投資理財資訊來源(可複選)其他
           ,CUST_INV_FINSOURCE_4_TXT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_INV_FINSOURCE_OTHERS ELSE　CUST_INV_FINSOURCE_4_TXT END            -- 投資理財資訊來源(可複選)其他(說明)
           ,CUST_INV_ESTAMT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_INV_ESTAMT ELSE CUST_INV_ESTAMT END                                         -- 預估投資金額 1:100萬以下 2:100~500萬 3:500~1000萬 4:1000萬以上 
           ,CUST_RESIDENCE_STATUS = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RESIDENCE_STATUS ELSE CUST_RESIDENCE_STATUS END                       -- 目前居住及照護狀態(1:獨居 2:與親友同住 3:需由專人照護 4:其他)
           ,CUST_RESIDENCE_STATUS_TXT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RESIDENCE_STATUS_OTHERS ELSE CUST_RESIDENCE_STATUS_TXT END        -- 目前居住及照護狀態(說明)
           ,CUST_MIND_STATUS = CASE WHEN WTX_TYPE = 'L' THEN WCUST_MIND_STATUS ELSE CUST_MIND_STATUS END                　　                  -- 目前身心狀態(1:身體健康 2:僅有慢性病,但身體仍感覺健康 3:有重大傷病證明 4:有身心障礙證明 5:需由監護人或輔助人代為行使權利)
           ,MAJOR_ILLNESS = CASE WHEN WTX_TYPE = 'L' THEN WMAJOR_ILLNESS ELSE MAJOR_ILLNESS END                                               -- 重大傷病證明 Y:有 N:無 D:無勾選
           ,MAJOR_ILLNESS_REMARK = CASE WHEN WTX_TYPE = 'L' THEN WMAJOR_ILLNESS_REMARK ELSE MAJOR_ILLNESS_REMARK END                          -- 重大傷病備註

           ,CUST_RISK_AGE = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_AGE ELSE CUST_RISK_AGE END                                               -- 客戶年齡層 1:65歲(含)以上 2:60~64歲 3:50~59/未滿20歲 4:20~29歲 5:30~49歲 
           ,EDUCATION = CASE WHEN WTX_TYPE = 'L' THEN WEDUCATION ELSE EDUCATION END                                                           -- 學歷 a:國小以下 A:國中 B:高中職 C:大學/專科 D:碩士以上
           ,CUST_RISK_INVTOOL = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVTOOL ELSE CUST_RISK_INVTOOL END                                   -- 常使用的投資理財工具 1:定存 2:倩券 3:基金 4:股票 5:期貨 
           ,CUST_RISK_INVEXP = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVEXP ELSE CUST_RISK_INVEXP END                                      -- 投資經驗 1:新手 2:1年以下 3:1~3年 4:3~10年 5:10年以上 
           ,CUST_RISK_INVPURPOSE = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVPURPOSE ELSE CUST_RISK_INVPURPOSE END                          -- 最主要投資目的 1:只願投資較保守的產品 2:儲蓄退休金 3:儲蓄子女教育基金 4:短期投資計畫 5:追求資產增值 
           ,FAMILY_INCOME = CASE WHEN WTX_TYPE = 'L' THEN WFAMILY_INCOME ELSE FAMILY_INCOME END                                               -- 個人或家庭平均年收入
           ,CUST_RISK_INVPROFIT = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_INVPROFIT ELSE CUST_RISK_INVPROFIT END                             -- 投資損益忍受度 1:全部/部分贖回,持有現金 2:全部/部分贖回並轉至風險較低的基金 3:暫時觀望,不採取行動 4:考慮加碼,攤低投資成本 5:積極逢低加碼 
           ,CUST_RISK_FUNDING = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_FUNDING ELSE CUST_RISK_FUNDING END                                   -- 重大資金需求 1:1年內 2:1~2年 3:2~5年 4:5~10年 5:10年後 
           ,CUST_RISK_FLUIDITY = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_FLUIDITY ELSE CUST_RISK_FLUIDITY END                                -- 流動性資金需求 1:1個月(含)以下 2:1~3個月 3:3~6個月 4:6~12個月 5:12個月以上 
           ,CUST_RISK_PRICEVOL = CASE WHEN WTX_TYPE = 'L' THEN WCUST_RISK_PRICEVOL ELSE CUST_RISK_PRICEVOL END                                -- 價格波動承受度 1:無法承受波動 2:可承受最高5%的波動 3:可承受最高15%的波動 4:可承受最高30%的波動 5:可承受30%以上的波動

           -- 2023.03.19 JIANXIN 新增自主申購聲明\1：空值；2：同意；3：不同意
           ,VULNERABLE_CLAIM = CASE WHEN WTX_TYPE = 'L' THEN WVULNERABLE_CLAIM ELSE VULNERABLE_CLAIM END                                      -- 自主申購聲明\1：空值；2：同意；3：不同意
           ,RISK_LEVEL = CASE WHEN WTX_TYPE = 'L' THEN WRISK_LEVEL ELSE RISK_LEVEL END                                                        -- 新客戶風險屬性 1:保守 2:穩健 3:積極
           ,KYC_SCROE = CASE WHEN WTX_TYPE = 'L' THEN WKYC_SCROE ELSE KYC_SCROE END                                                           -- KYC 分數

           ,RISK_STATUS = CASE WHEN WTX_TYPE = 'L' THEN '1' ELSE RISK_STATUS END                                                              -- 適合度分析表交付狀態 0:未交付 1:已交付 2:不需交付 3:交付其他文件
           ,RISK_WRITE_DATE = CASE WHEN WTX_TYPE = 'L' THEN XDATE ELSE RISK_WRITE_DATE END                                                    -- 適合度分析表最後一次填寫日
           ,RISK_MAT_DATE = CASE WHEN WTX_TYPE = 'L' THEN ADD_MONTHS(XDATE,12)-1 ELSE RISK_MAT_DATE END                                       -- 適合度分析表最後一次填寫到期日

           -- 2023.12.02 JIANXIN 新增使用者代碼
           -- 2023.12.05 JIANXIN 調整異動別代碼 A.使用者代碼 變成 a.使用者代碼
           -- 2024.03.07 JIANXIN 當使用者代碼=null，代表是透過延長使用者代碼進來
           ,USER_ALIAS = CASE WHEN WTX_TYPE = 'a' AND WUSER_ALIAS IS NOT NULL　THEN ECS.CRYPT(WUSER_ALIAS) ELSE USER_ALIAS END                                             -- 使用者代碼
           ,USER_ALIAS_CHG_DATE = CASE WHEN WTX_TYPE = 'a' THEN XDATE ELSE USER_ALIAS_CHG_DATE END                                            -- 使用者代碼變更日期

     WHERE ID = XID;

     -- 2019.01.23 yunchu 調整ECCSB014變更ID，LDAP執行後更新【變更ID記錄(ECS.ID_CHANGE_LOG)】檔
     UPDATE ECS.ID_CHANGE_LOG
        SET  IS_UPDATE_LDAP = 'Y'
            ,UPDATEID = XECS
            ,UPDATEDATE = XDATE
      WHERE NEW_ID = XID;

      -- 2019.07.23 JIANXIN 增加寫入檔案AML_HOLDER的資料
      IF WTX_TYPE = 'L' AND XP_RISK= 'Y' THEN

          UPDATE FAS.AML_HOLDER
             SET  AML_CATEGORY = 'O'
                 ,CREATED_BY = XECS
                 ,CREATION_DATE = XDATE
                 ,REVISED_BY = XECS
                 ,REVISION_DATE = XDATE
                 ,STATUS = 'B'
                 ,REMARK = XP_RISK
           WHERE ID = XID;

           IF SQL%NOTFOUND THEN

             -- 2019.07.25 ChengYu 調整新增AML_HOLDER資料
             INSERT INTO FAS.AML_HOLDER
               (  ID , AML_CATEGORY , CREATED_BY, CREATION_DATE , REVISED_BY , REVISION_DATE , STATUS , REMARK   )
             SELECT XID , 'O' , XECS, XDATE , XECS , XDATE , 'B' , NAME REMARK
               FROM FAS.PROFESSION
               --2019.07.29 JIANXIN 調整職業別欄位對應錯誤問題
              WHERE PROFESSION = WPROFESSION
                AND IR_CODE = (SELECT CASE WHEN C_TYPE IN ('2','4','6','7') THEN 'I' ELSE 'R' END
                                 FROM FAS.HOLDER
                                WHERE ID = XID);

           END IF;
      END IF;
      /*2024.03.19 RICHARD 重新確認FAS.HOLDER RISK_WRITE_DATE / RISK_MAT_DATE 是否真為NULL , 若為NULL 則強制發出錯誤訊息or重新針對二個欄位在更新一次 begin */
      IF WTX_TYPE = 'L' THEN
         SELECT RISK_WRITE_DATE,RISK_MAT_DATE INTO XRISK_WRITE_DATE,XRISK_MAT_DATE FROM FAS.HOLDER WHERE ID = XID;
         IF ((XRISK_WRITE_DATE IS NULL) AND (XRISK_MAT_DATE IS NULL)) OR (XRISK_WRITE_DATE = XRISK_WRITE_DATE_OLD) OR (XRISK_MAT_DATE = XRISK_MAT_DATE_OLD) THEN            
            /*UPDATE FAS.HOLDER 
               SET RISK_WRITE_DATE = TO_DATE(TO_CHAR(CASE WHEN XDATE IS NOT NULL THEN XDATE ELSE SYSDATE END,'YYYY/MM/DD'))
                  ,RISK_MAT_DATE = ADD_MONTHS(TO_DATE(TO_CHAR(CASE WHEN XDATE IS NOT NULL THEN XDATE ELSE SYSDATE END,'YYYY/MM/DD'),'YYYY/MM/DD'),12)-1
             WHERE ID = XID;*/
             RAISE XRISK_DATE_MISS;
         END IF;
      END IF;
      /*2024.03.19 RICHARD 將日期去除時:分:秒 end */
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        ROLLBACK;
        Raise_application_error(-20000, '更新失敗');
    /*2024.03.19 RICHARD 將日期去除時:分:秒 begin */
      WHEN XRISK_DATE_MISS THEN
        ROLLBACK;
        Raise_application_error(-2000,'系統忙碌中，請重新操作！');
    /*2024.03.19 RICHARD 將日期去除時:分:秒 end*/

  END;
END s_UpdateBFData;

/

  GRANT EXECUTE ON "ECS"."S_UPDATEBFDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_UPDATEBFNOTICE
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_UPDATEBFNOTICE" 
-- =============================================
-- Author:      ChengYu
-- Create date: 2018/10/17
-- Description: 更新受益人通知內容
-- =============================================
(
    WACCOUNT_NO       INTEGER,                   -- 受益人戶號
    WINPUT_DATE       DATE,                      -- 執行日期
    WFUND_NO          VARCHAR2,                  -- 基金代碼
    WTYPE             VARCHAR2,                  -- 類別

    OUTDT             OUT SYS_REFCURSOR          -- 回傳的 TABLEDATA
) IS

XID VARCHAR2(10);  --受益人ID
BEGIN

  SELECT ID 
    INTO XID
    FROM FAS.HOLDER
   WHERE ACCOUNT_NO = WACCOUNT_NO;

    UPDATE ECS.PRICE_LOG
       SET PRICE_LOG.IS_READ = 'Y'
     WHERE PRICE_LOG.ID = XID
       AND TRUNC(PRICE_LOG.INPUT_DATE) = TRUNC(WINPUT_DATE)
       AND PRICE_LOG.FUND_NO = WFUND_NO
       AND PRICE_LOG.TYPE = WTYPE;

    OPEN OUTDT FOR
    SELECT  'Y' AS IS_SUCCESS
           ,'' AS WARNS_TYPE
           ,'' AS ERROR_MSG
      FROM DUAL;
END;

/

  GRANT EXECUTE ON "ECS"."S_UPDATEBFNOTICE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_UPDATEFMQDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_UPDATEFMQDATA" 
(
     WACCOUNT_NO      INTEGER                     -- 受益人戶號
    ,WMARRIAGE        VARCHAR2                    -- 婚姻狀況
    ,WCHILDREN        VARCHAR2                    -- 子女數
    ,WEDUCATION       VARCHAR2                    -- 教育程度
    ,WPROFESSION_CODE VARCHAR2                    -- 行業別
    ,WIN_COME         VARCHAR2                    -- 家庭年收入
    ,WLIVE_STATUS     VARCHAR2                    -- 居住狀況
    ,WINVESTMENT      VARCHAR2                    -- 投資金額
    ,WINVEST_TYPE     VARCHAR2                    -- 投資理財工具
    ,WINVEST_OTHER    VARCHAR2                    -- 投資理財工具–其他
    ,WINVEST_STAND_ON VARCHAR2                    -- 投資依據
    ,WINVEST_INFO     VARCHAR2                    -- 投資訊息
    ,OUTDT            OUT SYS_REFCURSOR           -- 回傳的 TABLEDATA
) IS
BEGIN
   DECLARE XID            VARCHAR2(10);
           XDATA_NUM      INTEGER;
           XDATE          DATE := SYSDATE;
   BEGIN

     BEGIN
           SELECT HOLDER.ID   -- 受益人ID
             INTO XID
             FROM FAS.HOLDER HOLDER
            WHERE ACCOUNT_NO = WACCOUNT_NO;

        -- 2018.03.28 ChengYu 新增錯誤訊息
        EXCEPTION
          WHEN NO_DATA_FOUND THEN
            RAISE_APPLICATION_ERROR(-20000,
                                  '無法取得受益人ID，請檢查！');
      END;

   -- 檢查資料表是否有該ID資料
   SELECT COUNT(1)
     INTO XDATA_NUM
     FROM ECS.FIN_QNAIRE FIN_QNAIRE
    WHERE FIN_QNAIRE.ID = XID;

   IF XDATA_NUM > 0 THEN

   DELETE FROM ECS.FIN_QNAIRE FIN_QNAIRE
    WHERE FIN_QNAIRE.ID = XID;

   END IF;

   INSERT INTO ECS.FIN_QNAIRE
        (  ID                 -- 受益人ID
          ,LIVE_STATUS        -- 居住狀況
          ,MARRIAGE           -- 婚姻狀況
          ,CHILDREN           -- 子女數
          ,EDUCATION          -- 教育程度
          ,PROFESSION_CODE    -- 行業別
          ,IN_COME            -- 家庭年收入
          ,INVESTMENT         -- 投資金額
          ,INVEST_TYPE        -- 投資理財工具
          ,INVEST_OTHER       -- 投資理財工具–其他
          ,INVEST_STAND_ON    -- 投資依據
          ,INVEST_INFO        -- 投資訊息
          ,LAST_MODIFIED      -- 最後日期修改時間
        )
   SELECT  XID
          ,WLIVE_STATUS
          ,WMARRIAGE
          ,WCHILDREN
          ,WEDUCATION
          ,WPROFESSION_CODE
          ,WIN_COME
          ,WINVESTMENT
          ,WINVEST_TYPE
          ,WINVEST_OTHER
          ,WINVEST_STAND_ON
          ,WINVEST_INFO
          ,XDATE
     FROM DUAL;



   OPEN OUTDT FOR
   SELECT FIN_QNAIRE.LIVE_STATUS         -- 居住狀況
          ,FIN_QNAIRE.MARRIAGE           -- 婚姻狀況
          ,FIN_QNAIRE.CHILDREN           -- 子女數
          ,FIN_QNAIRE.EDUCATION          -- 教育程度
          ,FIN_QNAIRE.PROFESSION_CODE    -- 行業別
          ,FIN_QNAIRE.IN_COME            -- 家庭年收入
          ,FIN_QNAIRE.INVESTMENT         -- 投資金額
          ,FIN_QNAIRE.INVEST_TYPE        -- 投資理財工具
          ,FIN_QNAIRE.INVEST_OTHER       -- 投資理財工具–其他
          ,FIN_QNAIRE.INVEST_STAND_ON    -- 投資依據
          ,FIN_QNAIRE.INVEST_INFO        -- 投資訊息
     FROM ECS.FIN_QNAIRE FIN_QNAIRE
    WHERE FIN_QNAIRE.ID = XID;

   END;
END s_UpdateFMQData;

/

  GRANT EXECUTE ON "ECS"."S_UPDATEFMQDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Procedure S_UPDATEMEMBERDATA
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "ECS"."S_UPDATEMEMBERDATA" 
-- =============================================
-- Author:      tingting
-- Create date: 2018/12/20
-- Description: 變更會員基本資料
-- =============================================
(
    WPOTENTIAL_ID           INTEGER,                -- 潛在客戶代碼
    --WIP_ADR                 VARCHAR2,               -- IP位址
    WTX_PWD                 VARCHAR2,               -- 交易密碼
    WTX_TYPE                VARCHAR2,               -- 異動別 Q：密碼補發/變更
    WMEMBER_KEY             VARCHAR2                -- 密碼
) IS

    XDATE	                DATE := SYSDATE;        -- 修改日期(含時分秒)

BEGIN

    -- 潛在客戶資料異動檔
    INSERT INTO ECS.POTENTIAL_CHANGE
    (
            LAST_MODIFIED                       -- 最後修改日期
           ,TX_TYPE                             -- 異動別 Q：密碼補發/變更
           ,SEND_TYPE                           -- 補發EC密碼方式\1：Email；2：SMS
           ,SOCIAL_TYPE                         -- 社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
           ,SOCIAL_ID                           -- 社群登入帳號
           /*
           ,SOCIAL_EMAIL                        -- 用戶的電子郵件
           ,NEW_SOCIAL_EMAIL                    -- (新)用戶的電子郵件
           */
           ,POTENTIAL_ID                        -- 潛在客戶代碼
           /*
           ,FIRST_NAME                          -- 姓
           ,NEW_FIRST_NAME                      -- (新)姓
           ,LAST_NAME                           -- 名
           ,NEW_LAST_NAME                       -- (新)名
           */
           ,MEMBER_KEY                          -- 密碼
           ,NEW_MEMBER_KEY                      -- (新)密碼
           /*
           ,GENDER                              -- 性別 F：女生 M：男生 C：公司
           ,NEW_GENDER                          -- (新)性別 F：女生 M：男生 C：公司
           ,BIRTH_DATE                          -- 生日
           ,NEW_BIRTH_DATE                      -- (新)生日
           ,MOBILE                              -- 手機
           ,NEW_MOBILE                          -- (新)手機
           */
           ,CREATE_DATE                         -- 建立日期
    )
    SELECT  XDATE AS LAST_MODIFIED              -- 最後修改日期
           ,WTX_TYPE AS TX_TYPE                 -- 異動別 Q：密碼補發/變更
           ,CASE WHEN WTX_TYPE = 'Q' THEN '1' ELSE '' END SEND_TYPE     -- 補發EC密碼方式\1：Email；2：SMS
           ,SOCIAL_TYPE                         -- 社群登入種類 1：Facebook 2：Twitter 3：Google+ 4：Email 註冊
           ,SOCIAL_ID                           -- 社群登入帳號
           /*
           ,SOCIAL_EMAIL                        -- 用戶的電子郵件
           ,NEW_SOCIAL_EMAIL                    -- (新)用戶的電子郵件
           */
           ,POTENTIAL_ID                        -- 潛在客戶代碼
           /*
           ,FIRST_NAME                          -- 姓
           ,NEW_FIRST_NAME                      -- (新)姓
           ,LAST_NAME                           -- 名
           ,NEW_LAST_NAME                       -- (新)名
           */
           ,MEMBER_KEY                          -- 密碼
           ,CASE WHEN WTX_TYPE = 'Q' THEN WTX_PWD ELSE MEMBER_KEY END NEW_MEMBER_KEY        -- (新)密碼
           /*
           ,GENDER                              -- 性別 F：女生 M：男生 C：公司
           ,NEW_GENDER                          -- (新)性別 F：女生 M：男生 C：公司
           ,BIRTH_DATE                          -- 生日
           ,NEW_BIRTH_DATE                      -- (新)生日
           ,MOBILE                              -- 手機
           ,NEW_MOBILE                          -- (新)手機
           */
           ,CREATE_DATE                         -- 建立日期
      FROM ECS.POTENTIAL        -- 潛在客戶資料檔
     WHERE POTENTIAL_ID = WPOTENTIAL_ID;

    BEGIN

        -- 更新潛在客戶資料檔
        UPDATE ECS.POTENTIAL        --潛在客戶資料檔
           SET  MEMBER_KEY = CASE WHEN WTX_TYPE = 'Q' THEN WTX_PWD ELSE MEMBER_KEY END          -- 密碼
         WHERE POTENTIAL_ID = WPOTENTIAL_ID;

        EXCEPTION
            WHEN NO_DATA_FOUND THEN 
                ROLLBACK;
                RAISE_APPLICATION_ERROR(-20000, '更新失敗');

    END;

    -- 清除密碼鎖定(有登入過才會有資料)
    UPDATE ECS.POTENTIAL_LOGIN
       SET LOGIN_FAILED = 0
     WHERE POTENTIAL_ID = WPOTENTIAL_ID
       AND WTX_TYPE = 'Q';

END;

/

  GRANT EXECUTE ON "ECS"."S_UPDATEMEMBERDATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function CRYPT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."CRYPT" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2023/12/02
-- Description: Oracle加密方法
-- =============================================
-- SELECT ECS.CRYPT('Admin123'))  FROM DUAL;
(
    PassStr  VARCHAR

)  RETURN VARCHAR
IS

  iLoop      Number;
  ResultTmp  Varchar2(30);
/* 為密碼編碼 */
BEGIN

  iLoop := 1;
  ResultTmp := '';

  while iLoop <= Length(PassStr) Loop
    --登入密碼及匯款戶交易密碼編碼規則:
    --1.長度需8字元
    --2.前後英文，中間英數，但最少一個數字
    --3.區分大小寫，且大小寫不同視為不重覆
    IF (ASCii(SUBSTR(PASSSTR,ILOOP,1)) > 47) AND (ASCii(SUBSTR(PASSSTR,ILOOP,1)) < 58) THEN
      ResultTmp := Chr(ASCii(SubStr(PassStr,iLoop,1))-8) || ResultTmp ;
    ELSE
      ResultTmp := Chr(ASCii(SubStr(PassStr,iLoop,1))-8) || ResultTmp ;
    END IF;
    iLoop := iLoop + 1;
  end Loop;
  Return ResultTmp;
END;

/

  GRANT EXECUTE ON "ECS"."CRYPT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function DECRYPT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."DECRYPT" 
-- =============================================
-- Author:      JIANXIN
-- Create date: 2023/12/02
-- Description: Oracle解密方法
-- =============================================
-- SELECT ECS.DECRYPT('Admin123'))  FROM DUAL;
(
    PassStr  VARCHAR

)  RETURN VARCHAR
IS

  iLoop      Number;
  ResultTmp  Varchar2(30);
/* 為密碼解碼 */
BEGIN

  iLoop := 1;
  ResultTmp := '';

  while iLoop <= Length(PassStr) Loop
    --登入密碼及匯款戶交易密碼編碼規則:
    --1.長度需8字元
    --2.前後英文，中間英數，但最少一個數字
    --3.區分大小寫，且大小寫不同視為不重覆

    If (ASCii(SUBSTR(PASSSTR,ILOOP,1)) > 50) Then
      ResultTmp := CHR(ASCII(SubStr(PassStr,iLoop,1)) + 8) || ResultTmp ;
    Else
    	ResultTmp := CHR(ASCII(SubStr(PassStr,iLoop,1)) + 8) || ResultTmp ;
    End If;
    --modify by sfour 2006.07.15 end
    iLoop := iLoop + 1;

  end Loop;

  Return ResultTmp;

END;

/

  GRANT EXECUTE ON "ECS"."DECRYPT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FISR11TMP_F1
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FISR11TMP_F1" 
-- =============================================
-- Author:      stu
-- Create date: 2007/11/27
-- Description:	財金外幣扣款回覆資料顯示內容
-- 2011.08.19 MOD BY PAN FOR 收檔回覆訊息整合
-- 2019.08.15 tingting 調整為ORACLE版本
-- =============================================
(
  -- Add the parameters for the function here
  XDATALIST IN VARCHAR2,
  XONLY_KEY IN VARCHAR2
)
RETURN TYPE_FISR11TMP_F1_TABLE AS v_ret TYPE_FISR11TMP_F1_TABLE;
--with encryption
BEGIN
/*
HOLDER  受益人營業基本資料檔 → FAS.HOLDER
OFD620A 境內基金網路交易申購主檔 → ECS.PURCHASE
OFD621A 境內基金網路交易申購明細檔 → ECS.PURCHASE
*/
        v_ret := TYPE_FISR11TMP_F1_TABLE();

        FOR rec IN 
        (
                SELECT * FROM
                    (/*
                     SELECT FISR11TMP.CP_DATAID,
                            SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            (CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                                  WHEN '1' THEN '定額扣款' 
                                  WHEN '2' THEN '約定扣款' 
                                  WHEN '3' THEN 'E/C扣款' 
                                  WHEN '4' THEN 'IVR扣款' 
                                  END) SOURCE_NAME,
                            RSP008.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM FISR11TMP,
                            RSP008,
                            (SELECT TOP 1 CP_BATCH FROM FISR11FST  WHERE FISR11FST.ONLY_KEY = XONLY_KEY ) FISR11FST
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'ALL'
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '1'  --定期定額
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = RSP008.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = RSP008.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = RSP008.TRADE_NO
                        AND RSP008.SUB_STATUS = '1'  --扣款中
                        AND RSP008.UNIT_CODE = FISR11TMP.CP_RBANK
                        AND ECS.PADLeft(SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT
                        AND TRIM(FISR11TMP.CP_ID)=RSP008.SUB_ID--扣款ID
                        AND FISR11TMP.CP_AMT/100=RSP008.TOT_SUB_AMT--扣款金額
                     UNION ALL
                     */
                     /*
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            OFD221A.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM FISR11TMP,
                            OFD221A,
                            (SELECT TOP 1 CP_BATCH FROM FISR11FST WHERE FISR11FST.ONLY_KEY = XONLY_KEY ) FISR11FST,
                            FAS.HOLDER,
                            OFD220A 
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'ALL'
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '2'  --傳真委扣
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = OFD221A.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = OFD221A.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = OFD221A.TRADE_NO
                        AND OFD221A.SUB_STATUS = '1'  --扣款中
                        AND OFD221A.ALLOT_NO=OFD220A.ALLOT_NO
                        --AND ECS.PADRight(OFD220A.SUB_BANK_CODE,7,'0') = FISR11TMP.CP_RBANK --扣款行
                        AND ECS.PADLeft(OFD220A.SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT --扣款帳號
                        AND OFD221A.BF_NO=HOLDER.BF_NO
                        AND TRIM(FISR11TMP.CP_ID)=HOLDER.ID--扣款ID
                        AND FISR11TMP.CP_AMT/100=OFD221A.SUM_AMT--扣款金額
                     UNION ALL
                     */
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            PURCHASE.FUND_NO AS FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM ECS.FISR11TMP,
                            ECS.PURCHASE,
                            (SELECT CP_BATCH FROM ECS.FISR11FST WHERE FISR11FST.ONLY_KEY = XONLY_KEY AND ROWNUM = 1) FISR11FST,
                            FAS.HOLDER--,
                            --OFD620A
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'ALL'
                        --AND SUBSTR(FISR11TMP.CP_SEQ,1,1) IN ('3','4')  --E/C扣款或IVR扣款
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = PURCHASE.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = PURCHASE.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = PURCHASE.TRADE_NO
                        AND PURCHASE.SUB_STATUS = '1'  --扣款中
                        --AND PURCHASE.EC_ALLOT_NO=OFD620A.EC_ALLOT_NO
                        --AND ECS.PADRight(OFD620A.SUB_BANK_CODE,7,'0') = FISR11TMP.CP_RBANK --扣款行
                        --AND ECS.PADLeft(OFD620A.SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT --扣款帳號
                        AND PURCHASE.ID = HOLDER.ID
                        AND TRIM(FISR11TMP.CP_ID) = HOLDER.ID--扣款ID
                        AND FISR11TMP.CP_AMT/100 = PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE--扣款金額
                     UNION ALL
                     /*
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            RSP008.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM FISR11TMP,
                            RSP008,
                            (SELECT TOP 1 CP_BATCH FROM FISR11FST WHERE FISR11FST.ONLY_KEY = XONLY_KEY ) FISR11FST
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'DUP'  --已扣款
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '1'  --定期定額
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = RSP008.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = RSP008.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = RSP008.TRADE_NO
                        AND RSP008.SUB_STATUS in ('2','3')  --扣款成功或失敗
                        AND RSP008.UNIT_CODE = FISR11TMP.CP_RBANK
                        AND ECS.PADLeft(SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT
                        AND TRIM(FISR11TMP.CP_ID)=RSP008.SUB_ID--扣款ID
                        AND FISR11TMP.CP_AMT/100=RSP008.TOT_SUB_AMT--扣款金額
                     UNION ALL
                     */
                     /*
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            OFD221A.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM FISR11TMP,
                            OFD221A,(SELECT TOP 1 CP_BATCH FROM FISR11FST WHERE FISR11FST.ONLY_KEY = XONLY_KEY ) FISR11FST,
                            FAS.HOLDER,
                            OFD220A
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'DUP'  --已扣款
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '2'  --傳真委扣
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = OFD221A.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = OFD221A.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = OFD221A.TRADE_NO
                        AND OFD221A.SUB_STATUS in ('2','3')  --扣款成功或失敗
                        AND OFD221A.ALLOT_NO=OFD220A.ALLOT_NO
                        --AND ECS.PADRight(OFD220A.SUB_BANK_CODE,7,'0') = FISR11TMP.CP_RBANK --扣款行
                        AND ECS.PADLeft(OFD220A.SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT --扣款帳號
                        AND OFD221A.BF_NO=HOLDER.BF_NO
                        AND TRIM(FISR11TMP.CP_ID)=HOLDER.ID--扣款ID
                        AND FISR11TMP.CP_AMT/100=OFD221A.SUM_AMT--扣款金額
                     UNION ALL
                     */
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            PURCHASE.FUND_NO AS FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            ECS.f_GetDdctResultMsg('ALL','3',FISR11TMP.CP_RCODE) AS MSG
                       FROM ECS.FISR11TMP,
                            ECS.PURCHASE,
                            (SELECT CP_BATCH FROM ECS.FISR11FST WHERE FISR11FST.ONLY_KEY = XONLY_KEY AND ROWNUM = 1) FISR11FST,
                            FAS.HOLDER--,
                            --OFD620A
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'DUP'  --已扣款
                        --AND SUBSTR(FISR11TMP.CP_SEQ,1,1) IN ('3','4')  --E/C扣款或IVR扣款
                        AND SUBSTR(FISR11FST.CP_BATCH,10,10) = PURCHASE.BATCH_ID
                        AND CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) = PURCHASE.BATCH_SRNO
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = PURCHASE.TRADE_NO
                        AND PURCHASE.SUB_STATUS in ('2','3')  --扣款成功或失敗
                        --AND PURCHASE.EC_ALLOT_NO=OFD620A.EC_ALLOT_NO
                        --AND ECS.PADRight(OFD620A.SUB_BANK_CODE,7,'0') = FISR11TMP.CP_RBANK --扣款行
                        --AND ECS.PADLeft(OFD620A.SUB_ACCOUNT_NO,16,'0') = FISR11TMP.CP_OACCOUNT --扣款帳號
                        AND PURCHASE.ID = HOLDER.ID
                        AND TRIM(FISR11TMP.CP_ID) = HOLDER.ID--扣款ID
                        AND FISR11TMP.CP_AMT/100 = PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE--扣款金額
                     UNION ALL
                     /*
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            RSP008.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            --20110819 收檔回覆訊息整合
                            --(CASE WHEN NVL(RSP008.BATCH_ID,' ')=' ' THEN '找不到定期定額扣款資料'
                            --      WHEN SUBSTR(UNIT_CODE,1,3) <> SUBSTR(FISR11TMP.CP_RBANK,1,3) THEN '收檔扣款行與原資料不一致'
                            --      WHEN ECS.PADLeft(SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致'
                            --      WHEN TRIM(FISR11TMP.CP_ID)<>RSP008.SUB_ID THEN '收檔扣款ID與原資料不一致'
                            --      WHEN FISR11TMP.CP_AMT/100<>RSP008.TOT_SUB_AMT THEN '收檔扣款金額與原資料不一致'
                            --      WHEN RSP008.SUB_STATUS = '0' THEN '此扣款資料還未送扣款行'
                            --      ELSE '筆數超過一筆' END) MSG

                            CASE WHEN NVL(RSP008.BATCH_ID,' ')=' ' THEN '找不到定期定額扣款資料 ' ELSE '' END +
                            CASE WHEN SUBSTR(UNIT_CODE,1,3) <> SUBSTR(FISR11TMP.CP_RBANK,1,3) THEN '收檔扣款行與原資料不一致 ' ELSE '' END +
                            CASE WHEN ECS.PADLeft(SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致 ' ELSE '' END +
                            CASE WHEN TRIM(FISR11TMP.CP_ID)<>RSP008.SUB_ID THEN '收檔扣款ID與原資料不一致 ' ELSE '' END +
                            CASE WHEN FISR11TMP.CP_AMT/100<>RSP008.TOT_SUB_AMT THEN '收檔扣款金額與原資料不一致 ' ELSE '' END +
                            CASE WHEN RSP008.SUB_STATUS = '0' THEN '此扣款資料還未送扣款行 ' ELSE '' END MSG
                       FROM FISR11TMP 
                       LEFT JOIN FISR11FST 
                         ON FISR11TMP.ONLY_KEY = FISR11FST.ONLY_KEY
                       LEFT JOIN RSP008 
                         ON SUBSTR(FISR11FST.CP_BATCH,10,10) = RSP008.BATCH_ID
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = RSP008.TRADE_NO 
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY
                        AND XDATALIST = 'ERR'
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '1'  --定期定額
                        AND (RSP008.BATCH_ID IS NULL OR RSP008.SUB_STATUS = '0' OR 
                             SUBSTR(UNIT_CODE,1,3) <> SUBSTR(FISR11TMP.CP_RBANK,1,3) OR
                             ECS.PADLeft(SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT OR
                             TRIM(FISR11TMP.CP_ID)<>RSP008.SUB_ID OR--扣款ID
                             FISR11TMP.CP_AMT/100<>RSP008.TOT_SUB_AMT )--扣款金額
                     UNION ALL
                     */
                     /*
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            OFD221A.FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(int,SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            --20110819 收檔回覆訊息整合
                            --CASE NVL(OFD221A.BATCH_ID,' ') WHEN ' ' THEN '找不到一般申購傳真委扣資料' ELSE
                            --(CASE NVL(OFD221A.SUB_STATUS,'X') WHEN 'X' THEN '找不到一般申購傳真委扣資料'
                            --                                     WHEN '0' THEN '此扣款資料還未送扣款行' ELSE 
                            --(CASE --WHEN ECS.PADRight(OFD220A.SUB_BANK_CODE,7,'0') <> FISR11TMP.CP_RBANK THEN '收檔扣款行與原資料不一致'
                            --     WHEN ECS.PADLeft(OFD220A.SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致'
                            --     WHEN TRIM(FISR11TMP.CP_ID)<>HOLDER.ID THEN '收檔扣款ID與原資料不一致'
                            --     WHEN FISR11TMP.CP_AMT/100<>OFD221A.SUM_AMT THEN  '收檔扣款金額與原資料不一致'
                            --     ELSE '' END)
                            --                                     END) END MSG
                            CASE WHEN NVL(OFD221A.BATCH_ID,' ') = ' ' OR NVL(OFD221A.SUB_STATUS,'X') = 'X' THEN '找不到一般申購傳真委扣資料 ' ELSE '' END+
                            CASE WHEN NVL(OFD221A.SUB_STATUS,'X') = '0' THEN '此扣款資料還未送扣款行 ' ELSE '' END + 
                            CASE WHEN ECS.PADLeft(OFD220A.SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致 ' ELSE '' END +
                            CASE WHEN TRIM(FISR11TMP.CP_ID)<>HOLDER.ID THEN '收檔扣款ID與原資料不一致 ' ELSE '' END +
                            CASE WHEN FISR11TMP.CP_AMT/100<>OFD221A.SUM_AMT THEN  '收檔扣款金額與原資料不一致 'ELSE '' END MSG
                       FROM FISR11TMP 
                       LEFT JOIN FISR11FST 
                         ON FISR11TMP.ONLY_KEY = FISR11FST.ONLY_KEY
                       LEFT JOIN OFD221A 
                         ON SUBSTR(FISR11FST.CP_BATCH,10,10) = OFD221A.BATCH_ID
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = OFD221A.TRADE_NO 
                       LEFT JOIN FAS.HOLDER 
                         ON OFD221A.BF_NO = HOLDER.BF_NO
                       LEFT JOIN OFD220A 
                         ON OFD221A.ALLOT_NO = OFD220A.ALLOT_NO
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY
                        AND XDATALIST = 'ERR'
                        AND SUBSTR(FISR11TMP.CP_SEQ,1,1) = '2'  --傳真委扣
                        AND ((OFD221A.BATCH_ID IS NULL OR OFD221A.SUB_STATUS = '0')
                       -- OR ECS.PADRight(OFD220A.SUB_BANK_CODE,7,'0') <> FISR11TMP.CP_RBANK --扣款行
                        OR ECS.PADLeft(OFD220A.SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT --扣款帳號
                        OR TRIM(FISR11TMP.CP_ID)<>HOLDER.ID--扣款ID
                        OR FISR11TMP.CP_AMT/100<>OFD221A.SUM_AMT )--扣款金額
                     UNION ALL
                     */
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            PURCHASE.FUND_NO AS FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            SUBSTR(FISR11FST.CP_BATCH,10,10) BATCH_ID,
                            CAST(SUBSTR(FISR11FST.CP_BATCH,20,1) AS INT) BATCH_SRNO,
                            --20110819 收檔回覆訊息整合
                            --CASE NVL(PURCHASE.BATCH_ID,' ') WHEN ' ' THEN '找不到一般申購傳真委扣資料' ELSE
                            --(CASE NVL(PURCHASE.SUB_STATUS,'X') WHEN 'X' THEN '找不到一般申購傳真委扣資料'
                            --                                     WHEN '0' THEN '此扣款資料還未送扣款行' ELSE 
                            --(CASE --WHEN ECS.PADRight(OFD620A.SUB_BANK_CODE,7,'0') <> FISR11TMP.CP_RBANK THEN '收檔扣款行與原資料不一致'
                            --      WHEN ECS.PADLeft(OFD620A.SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致'
                            --      WHEN TRIM(FISR11TMP.CP_ID)<>HOLDER.ID THEN '收檔扣款ID與原資料不一致'
                            --      WHEN FISR11TMP.CP_AMT/100<>PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE THEN  '收檔扣款金額與原資料不一致'
                            --      ELSE '' END)
                            --                                     END) END MSG
                            CASE WHEN NVL(PURCHASE.BATCH_ID,' ')  =' ' OR NVL(PURCHASE.SUB_STATUS,'X') = 'X' THEN '找不到E/C申購扣款資料 ' ELSE '' END || 
                            CASE WHEN NVL(PURCHASE.SUB_STATUS,'X') ='0' THEN '此扣款資料還未送扣款行 '  ELSE '' END || 
                            CASE WHEN ECS.PADLeft(PURCHASE.AC_CODE,16,'0') <> FISR11TMP.CP_OACCOUNT THEN '收檔扣款帳號與原資料不一致 '  ELSE '' END || 
                            CASE WHEN TRIM(FISR11TMP.CP_ID)<>HOLDER.ID THEN '收檔扣款ID與原資料不一致 '  ELSE '' END || 
                            CASE WHEN FISR11TMP.CP_AMT/100<>PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE THEN  '收檔扣款金額與原資料不一致 '  ELSE '' END MSG
                       FROM ECS.FISR11TMP
                       LEFT JOIN ECS.FISR11FST 
                         ON FISR11TMP.ONLY_KEY = FISR11FST.ONLY_KEY
                       LEFT JOIN ECS.PURCHASE 
                         ON SUBSTR(FISR11FST.CP_BATCH,10,10) = PURCHASE.BATCH_ID
                        AND SUBSTR(FISR11TMP.CP_SEQ,2,7) = PURCHASE.TRADE_NO 
                       --LEFT JOIN OFD620A 
                       --  ON PURCHASE.EC_ALLOT_NO=OFD620A.EC_ALLOT_NO
                       LEFT JOIN FAS.HOLDER 
                         ON PURCHASE.ID = HOLDER.ID
                      WHERE FISR11TMP.ONLY_KEY = XONLY_KEY  
                        AND XDATALIST = 'ERR'
                        --AND SUBSTR(FISR11TMP.CP_SEQ,1,1) IN ('3','4')  --E/C扣款或IVR扣款
                        AND ((PURCHASE.BATCH_ID IS NULL OR PURCHASE.SUB_STATUS = '0')
                        --OR ECS.PADRight(OFD620A.SUB_BANK_CODE,7,'0') <> FISR11TMP.CP_RBANK --扣款行
                        --OR ECS.PADLeft(OFD620A.SUB_ACCOUNT_NO,16,'0') <> FISR11TMP.CP_OACCOUNT --扣款帳號
                        OR TRIM(FISR11TMP.CP_ID)<>HOLDER.ID--扣款ID
                        OR FISR11TMP.CP_AMT/100<>PURCHASE.AMOUNT + PURCHASE.SERVICE_CHARGE )--扣款金額
                     UNION ALL
                     SELECT FISR11TMP.CP_DATAID,
                            --SUBSTR(FISR11TMP.CP_SEQ,1,1) SOURCE_ID,
                            --(CASE SUBSTR(FISR11TMP.CP_SEQ,1,1) 
                            --      WHEN '1' THEN '定額扣款' 
                            --      WHEN '2' THEN '約定扣款' 
                            --      WHEN '3' THEN 'E/C扣款' 
                            --      WHEN '4' THEN 'IVR扣款' 
                            --      END) SOURCE_NAME,
                            '' FUND_ID,
                            SUBSTR(FISR11TMP.CP_SEQ,2,7) CP_SEQ,
                            FISR11TMP.CP_CODE,
                            FISR11TMP.CP_CURRENCY,
                            FISR11TMP.CP_AMT/100 CP_AMT,
                            FISR11TMP.CP_OBANK,
                            FISR11TMP.CP_OACCOUNT,
                            FISR11TMP.CP_OID,
                            FISR11TMP.CP_OENAME,
                            FISR11TMP.CP_ENOTE,
                            FISR11TMP.CP_IBANK,
                            FISR11TMP.CP_IACCOUNT,
                            FISR11TMP.CP_IENAME,
                            FISR11TMP.CP_ID,
                            FISR11TMP.CP_COUNTRY,
                            FISR11TMP.CP_KIND,
                            FISR11TMP.CP_RESIDENT,
                            FISR11TMP.CP_NOTE,
                            FISR11TMP.CP_RCODE,
                            FISR11TMP.CP_RDATE,
                            FISR11TMP.CP_SPARE,
                            FISR11TMP.CREATEID,
                            '' BATCH_ID,
                            0 BATCH_SRNO,
                            '' MSG
                       FROM ECS.FISR11TMP 
                      WHERE FISR11TMP.ONLY_KEY = ''
                 	AND (XDATALIST<>'ERR' AND XDATALIST<>'ALL' AND XDATALIST<>'DUP')
                    ) FISR11TMP
        )
        LOOP
            v_ret.EXTEND;
            v_ret(v_ret.COUNT) := TYPE_FISR11TMP_F1_ROW
            (
                 rec.CP_DATAID
                ,rec.FUND_ID
                ,rec.CP_SEQ
                ,rec.CP_CODE
                ,rec.CP_CURRENCY
                ,rec.CP_AMT
                ,rec.CP_OBANK
                ,rec.CP_OACCOUNT
                ,rec.CP_OID
                ,rec.CP_OENAME
                ,rec.CP_ENOTE
                ,rec.CP_IBANK
                ,rec.CP_IACCOUNT
                ,rec.CP_IENAME
                ,rec.CP_ID
                ,rec.CP_COUNTRY
                ,rec.CP_KIND
                ,rec.CP_RESIDENT
                ,rec.CP_NOTE
                ,rec.CP_RCODE
                ,rec.CP_RDATE
                ,rec.CP_SPARE
                ,rec.CREATEID
                ,rec.BATCH_ID
                ,rec.BATCH_SRNO
                ,rec.MSG
            );
        END LOOP;

    RETURN v_ret;

END;

/

  GRANT EXECUTE ON "ECS"."FISR11TMP_F1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FISR12TMP_F1
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FISR12TMP_F1" 
-- =============================================
-- Author:		stu
-- Create date: 2007/11/09
-- Description:	財金外幣核印回覆收檔的資料顯示的內容
-- 2011.08.19 MOD BY PAN FOR 收檔回覆訊息整合
-- 2019.09.06 tingting 調整為ORACLE版本
-- 2019.10.29 ChengYu 修正收檔日期條件判斷式
-- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
-- =============================================
(
    -- Add the parameters for the function here
    XDATALIST IN NVARCHAR2,
    XONLY_KEY IN NVARCHAR2
)
RETURN TYPE_FISR12TMP_F1_TABLE AS v_ret TYPE_FISR12TMP_F1_TABLE;
--with encryption
BEGIN
/*
FAS.FIS_BANK → FAS.FIS_BANK
*/
        v_ret := TYPE_FISR12TMP_F1_TABLE();

        FOR rec IN 
        (
                SELECT * FROM
                    (SELECT  FISR12TMP.ONLY_KEY
                            ,FISR12TMP.CP_TYPE
                            ,FISR12TMP.CP_SEQ
                            ,FISR12TMP.CP_CID
                            ,FISR12TMP.CP_PBANK
                            ,FISR12TMP.CP_DATE
                            ,FISR12TMP.CP_TIX
                            ,FISR12TMP.CP_CURTYPE
                            ,FISR12TMP.CP_RBANK
                            -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
                            ,OFD701.SUB_ACC_NO CP_RCLNO
                            ,OFD701.SUB_ID_NO CP_RID
                            ,FISR12TMP.CP_USERNO
                            ,FISR12TMP.CP_ADMARK
                            ,FISR12TMP.CP_NOTE
                            ,FISR12TMP.CP_ENDDATE
                            ,FISR12TMP.CP_RCODE
                            ,FISR12TMP.CP_NAT
                            ,FISR12TMP.CP_BIC
                            ,FISR12TMP.CP_LIMITCUR
                            ,FISR12TMP.CP_LIMITAMT
                            ,FISR12TMP.CP_NOTEB
                            ,FISR12TMP.FILLER
                            ,FISR12TMP.CREATEID
                            ,ECS.f_GetSealResultMsg('ALL','3',FISR12TMP.CP_RCODE) /*||
                             --(CASE WHEN FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN '--JP' ELSE '' END)*/ AS MSG
                       FROM ECS.FISR12TMP, 
                            ECS.OFD701, 
                            FAS.FIS_BANK
                      WHERE FISR12TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'ALL' 
                        AND FAS.FIS_BANK.BANK_NO = OFD701.SUB_BANK_CODE
                        --AND FISR12TMP.CP_RBANK = CASE WHEN FAS.FIS_BANK.BANK_TYPE IN ('04','05') THEN OFD701.SUB_BANK_CODE ELSE ECS.f_GetBankHQ(OFD701.SUB_BANK_CODE)+'0000' END
                        AND FISR12TMP.CP_RBANK = (SELECT UNIT_CODE FROM ECS.OFD074 WHERE BANK_HQ = OFD701.SUB_BANK_CODE AND SEAL_TYPE = '3' AND ROWNUM = 1)
                        AND FISR12TMP.CP_RCLNO = ECS.PADLeft(OFD701.SUB_ACC_NO,16,'0')
                        AND FISR12TMP.CP_RID = ECS.PADRight(OFD701.SUB_ID_NO,10,' ')
                        AND OFD701.SEAL_TYPE = '3'      --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                        --AND OFD701.SEAL_STATUS = case when FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) then '1' else OFD701.SEAL_STATUS end
                        AND OFD701.SEAL_STATUS = '1'    --核印狀態 0：未送核印/不用送核；1：已送核印；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核 (CTL014：232)
                        --AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') = CASE WHEN FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN OFD701.SEAL_DATE ELSE TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') END
                        -- 2019.10.29 ChengYu 修正收檔日期條件判斷式
                        AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') >= TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD')
                        AND (
                             (OFD701.TRADE_NO = FISR12TMP.CP_SEQ /*AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)*/)
                             --OR
                             --FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)
                            )
                        AND TRIM(FISR12TMP.CP_RCODE) IS NOT NULL
                     UNION ALL
                     SELECT FISR12TMP.ONLY_KEY
                            ,FISR12TMP.CP_TYPE
                            ,FISR12TMP.CP_SEQ
                            ,FISR12TMP.CP_CID
                            ,FISR12TMP.CP_PBANK
                            ,FISR12TMP.CP_DATE
                            ,FISR12TMP.CP_TIX
                            ,FISR12TMP.CP_CURTYPE
                            ,FISR12TMP.CP_RBANK
                            -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
                            ,OFD701.SUB_ACC_NO CP_RCLNO
                            ,OFD701.SUB_ID_NO CP_RID
                            ,FISR12TMP.CP_USERNO
                            ,FISR12TMP.CP_ADMARK
                            ,FISR12TMP.CP_NOTE
                            ,FISR12TMP.CP_ENDDATE
                            ,FISR12TMP.CP_RCODE
                            ,FISR12TMP.CP_NAT
                            ,FISR12TMP.CP_BIC
                            ,FISR12TMP.CP_LIMITCUR
                            ,FISR12TMP.CP_LIMITAMT
                            ,FISR12TMP.CP_NOTEB
                            ,FISR12TMP.FILLER
                            ,FISR12TMP.CREATEID
                            ,ECS.f_GetSealResultMsg('ALL','3',FISR12TMP.CP_RCODE) /*||
                             --(CASE WHEN FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN '--JP' ELSE '' END)*/ AS MSG
                       FROM ECS.FISR12TMP, 
                            ECS.OFD701, 
                            FAS.FIS_BANK 
                      WHERE FISR12TMP.ONLY_KEY = XONLY_KEY 
                        AND XDATALIST = 'DUP'  --已核印
                        AND FAS.FIS_BANK.BANK_NO = OFD701.SUB_BANK_CODE
                        --AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)  --TA 產生的資料
                        --AND FISR12TMP.CP_RBANK = CASE WHEN FAS.FIS_BANK.BANK_TYPE IN ('04','05') THEN OFD701.SUB_BANK_CODE ELSE ECS.f_GetBankHQ(OFD701.SUB_BANK_CODE)+'0000' END
                        AND FISR12TMP.CP_RBANK = (SELECT UNIT_CODE FROM ECS.OFD074 WHERE BANK_HQ = OFD701.SUB_BANK_CODE AND SEAL_TYPE = '3' AND ROWNUM = 1)
                        AND FISR12TMP.CP_RCLNO = ECS.PADLeft(OFD701.SUB_ACC_NO,16,'0')
                        AND FISR12TMP.CP_RID = ECS.PADRight(OFD701.SUB_ID_NO,10,' ')
                        AND OFD701.SEAL_TYPE = '3'  --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                        AND OFD701.SEAL_STATUS IN ('2','3')     --核印狀態 0：未送核印/不用送核；1：已送核印；2：核印成功；3：核印失敗；9：重新送核；D：暫不送核 (CTL014：232)
                        --AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') = CASE WHEN FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN OFD701.SEAL_DATE ELSE TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') END
                        -- 2019.10.29 ChengYu 修正收檔日期條件判斷式
                        AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') >= TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD')
                        AND (
                             (OFD701.TRADE_NO = FISR12TMP.CP_SEQ /*AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)*/)
                             --OR
                             --FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)
                            )
                        AND TRIM(FISR12TMP.CP_RCODE) IS NOT NULL
                     UNION ALL
                     SELECT  FISR12TMP.ONLY_KEY
                            ,FISR12TMP.CP_TYPE
                            ,FISR12TMP.CP_SEQ
                            ,FISR12TMP.CP_CID
                            ,FISR12TMP.CP_PBANK
                            ,FISR12TMP.CP_DATE
                            ,FISR12TMP.CP_TIX
                            ,FISR12TMP.CP_CURTYPE
                            ,FISR12TMP.CP_RBANK
                            -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
                            ,OFD701.SUB_ACC_NO CP_RCLNO
                            ,OFD701.SUB_ID_NO CP_RID
                            ,FISR12TMP.CP_USERNO
                            ,FISR12TMP.CP_ADMARK
                            ,FISR12TMP.CP_NOTE
                            ,FISR12TMP.CP_ENDDATE
                            ,FISR12TMP.CP_RCODE
                            ,FISR12TMP.CP_NAT
                            ,FISR12TMP.CP_BIC
                            ,FISR12TMP.CP_LIMITCUR
                            ,FISR12TMP.CP_LIMITAMT
                            ,FISR12TMP.CP_NOTEB
                            ,FISR12TMP.FILLER
                            ,FISR12TMP.CREATEID
                            --2011.08.19 MOD BY PAN FOR 收檔回覆訊息整合
                            --CASE WHEN NVL(OFD701.SUB_BANK_CODE,' ') =' ' THEN '找不到扣款帳號' 
                            --     WHEN FISR12TMP.CP_RCODE = '' THEN '回覆碼為空白' 
                            --     WHEN ( OFD701.TRADE_NO <> FISR12TMP.CP_SEQ AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) ) THEN '收檔與送檔的交易序號不符' ELSE
                            --(CASE NVL(OFD701.SEAL_STATUS,'X') WHEN 'X' THEN '此扣款帳號不屬財金'
                            --                                     WHEN '0' THEN '此扣款帳號還未送核'
                            --                                     WHEN '9' THEN '此扣款帳號還未送核' ELSE '' END) END+(case when FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN '--JP' ELSE '' END) MSG

                            ,CASE WHEN NVL(OFD701.SUB_BANK_CODE,' ') = ' ' THEN '找不到扣款帳號 ' ELSE '' END ||
                             CASE WHEN TRIM(FISR12TMP.CP_RCODE) IS NULL THEN '回覆碼為空白 ' ELSE '' END ||
                             CASE WHEN (OFD701.TRADE_NO <> FISR12TMP.CP_SEQ /*AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)*/) THEN '收檔與送檔的交易序號不符 ' ELSE '' END ||
                             CASE NVL(OFD701.SEAL_STATUS,'X') WHEN 'X' THEN '此扣款帳號不屬財金 '
                                                              WHEN '0' THEN '此扣款帳號還未送核 '
                                                              WHEN '9' THEN '此扣款帳號還未送核 ' ELSE '' END /*||
                             --CASE WHEN FISR12TMP.CP_DATE < (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN '--JP' ELSE '' END*/ MSG
                       FROM ECS.FISR12TMP 
                       LEFT JOIN FAS.FIS_BANK 
                         ON FAS.FIS_BANK.BANK_NO = CASE SUBSTR(FISR12TMP.CP_RBANK,4,4) WHEN '0000' THEN SUBSTR(FISR12TMP.CP_RBANK,1,3) ELSE FISR12TMP.CP_RBANK END
                       --LEFT JOIN OFD701 ON FISR12TMP.CP_RBANK = CASE WHEN FAS.FIS_BANK.BANK_TYPE IN ('04','05') THEN OFD701.SUB_BANK_CODE ELSE ECS.f_GetBankHQ(OFD701.SUB_BANK_CODE)+'0000' END
                       LEFT JOIN ECS.OFD701
                         ON FISR12TMP.CP_RBANK = (SELECT UNIT_CODE FROM ECS.OFD074 WHERE BANK_HQ = OFD701.SUB_BANK_CODE AND SEAL_TYPE = '3' AND ROWNUM = 1)
                        AND FISR12TMP.CP_RCLNO = ECS.PADLeft(OFD701.SUB_ACC_NO,16,'0')
                        AND FISR12TMP.CP_RID = ECS.PADRight(OFD701.SUB_ID_NO,10,' ') 
                        --AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') = CASE WHEN FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN OFD701.SEAL_DATE ELSE TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') END
                        -- 2019.10.29 ChengYu 修正收檔日期條件判斷式
                        AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') >= TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD')
                        AND OFD701.SEAL_TYPE = '3'  --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                      WHERE FISR12TMP.ONLY_KEY = XONLY_KEY
                        AND XDATALIST = 'ERR'
                        AND (OFD701.SUB_BANK_CODE IS NULL OR OFD701.SEAL_STATUS IN ('X','0','9') OR TRIM(FISR12TMP.CP_RCODE) IS NULL OR 
                             (OFD701.TRADE_NO <> FISR12TMP.CP_SEQ /*AND FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015)*/)) 
                     UNION ALL
                     SELECT  FISR12TMP.ONLY_KEY
                            ,FISR12TMP.CP_TYPE
                            ,FISR12TMP.CP_SEQ
                            ,FISR12TMP.CP_CID
                            ,FISR12TMP.CP_PBANK
                            ,FISR12TMP.CP_DATE
                            ,FISR12TMP.CP_TIX
                            ,FISR12TMP.CP_CURTYPE
                            ,FISR12TMP.CP_RBANK
                            -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
                            ,OFD701.SUB_ACC_NO CP_RCLNO
                            ,OFD701.SUB_ID_NO CP_RID
                            ,FISR12TMP.CP_USERNO
                            ,FISR12TMP.CP_ADMARK
                            ,FISR12TMP.CP_NOTE
                            ,FISR12TMP.CP_ENDDATE
                            ,FISR12TMP.CP_RCODE
                            ,FISR12TMP.CP_NAT
                            ,FISR12TMP.CP_BIC
                            ,FISR12TMP.CP_LIMITCUR
                            ,FISR12TMP.CP_LIMITAMT
                            ,FISR12TMP.CP_NOTEB
                            ,FISR12TMP.FILLER
                            ,FISR12TMP.CREATEID
                            ,'' MSG
                       FROM ECS.FISR12TMP 
                       -- 2019.11.12 ChengYu 修正收檔時，寫入ECS.OFD702【扣款帳號核印歷史記錄檔】SUB_ACC_NO(扣款帳號)存取值
                       LEFT JOIN ECS.OFD701
                         ON FISR12TMP.CP_RBANK = (SELECT UNIT_CODE FROM ECS.OFD074 WHERE BANK_HQ = OFD701.SUB_BANK_CODE AND SEAL_TYPE = '3' AND ROWNUM = 1)
                        AND FISR12TMP.CP_RCLNO = ECS.PADLeft(OFD701.SUB_ACC_NO,16,'0')
                        AND FISR12TMP.CP_RID = ECS.PADRight(OFD701.SUB_ID_NO,10,' ') 
                        --AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') = CASE WHEN FISR12TMP.CP_DATE >= (SELECT NVL(MIN(ON_LINE_DATE),'1900/1/1') FROM CTL015) THEN OFD701.SEAL_DATE ELSE TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') END
                        AND TO_DATE(FISR12TMP.CP_DATE,'YYYYMMDD') >= TO_DATE(TO_CHAR(OFD701.SEAL_DATE,'YYYYMMDD'),'YYYYMMDD')
                        AND OFD701.SEAL_TYPE = '3'  --核印扣款方式  1：一般；2：ACH；3：財金  (CTL014：100)
                      WHERE FISR12TMP.ONLY_KEY IS NULL
                       AND (XDATALIST <> 'ERR' AND XDATALIST <> 'ALL' AND XDATALIST <> 'DUP')
                    ) FISR12TMP
        )
        LOOP
            v_ret.EXTEND;
            v_ret(v_ret.COUNT) := TYPE_FISR12TMP_F1_ROW
            (
                 rec.ONLY_KEY
                ,rec.CP_TYPE
                ,rec.CP_SEQ
                ,rec.CP_CID
                ,rec.CP_PBANK
                ,rec.CP_DATE
                ,rec.CP_TIX
                ,rec.CP_CURTYPE
                ,rec.CP_RBANK
                ,rec.CP_RCLNO
                ,rec.CP_RID
                ,rec.CP_USERNO
                ,rec.CP_ADMARK
                ,rec.CP_NOTE
                ,rec.CP_ENDDATE
                ,rec.CP_RCODE
                ,rec.CP_NAT
                ,rec.CP_BIC
                ,rec.CP_LIMITCUR
                ,rec.CP_LIMITAMT
                ,rec.CP_NOTEB
                ,rec.FILLER
                ,rec.CREATEID
                ,rec.MSG
            );
        END LOOP;

    RETURN v_ret;

END;

/

  GRANT EXECUTE ON "ECS"."FISR12TMP_F1" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_API_GET_RUNIT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_API_GET_RUNIT" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/08
-- Description: 取得可買回單位數
-- 2018.03.31 MOD BY JIM 修改日期格式
-- 2018.04.03 MOD BY JIM 修改邏輯
-- 2018.05.10 ChengYu 修改抓取買回單位數條件
-- 2018.07.05 JIANXIN MOD 可買回單位數扣除 ROBO 單，條件增加  PRODUCT_TYPE = 'L7'
-- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
-- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
-- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
-- 2018.10.03 JIANXIN MOD 贖回中的單位數要依據ROBO 單與E-trade排除
-- 2018.10.04 JIANXIN MOD 如果是境外的基金，可贖回要比設定大於一天
-- 2018.11.07 PAN MOD FAS.FUND.AC_DATE 為下一個要結帳的日期，非最新結帳日
-- 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
-- 2018.11.16 JIANXIN MOD 經與Lisa、ES 稽核確認調整定期定額鎖定天數由30天改為60天
-- 2018.11.16 JIANXIN MOD 經與Lisa、Ada、ES 稽核確認調整定期定額鎖定天數由60天改為30天
-- 2018.11.19 JIANXIN MOD 經與Ada、Jessie確認，ROBO 單不控制員工交易
-- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
-- 2019.01.02 JIANXIN MOD 調整境外基金可贖回單位數日期判斷
-- 2019.07.09 JIANXIN MOD 調整境內基金配息再申購不可鎖定員工交易
-- 2020.05.26 JIANXIN MOD 調整贖回中的單位數取得方式
-- 2021.05.03 Chengyu 排除贖回資料ECS轉入FAS後單位數重複計算錯誤
-- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
-- =============================================
(
   WID             VARCHAR2, --受益人ID
   WTX_DATE        DATE,     --交易日期
   WFUND_NO        VARCHAR2, --基金代碼
   WCRNCY_NO       VARCHAR2, --幣別
   WQUERY_TYPE     VARCHAR2, --查詢幣別
   -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
   WSTATUS         VARCHAR2 := '1',  --庫存狀態 1:有效 2:質設 3:掛失 4:註銷 5:作廢 6:待領 7:待繳 8:鎖定(e-TRADE 傳入1.有效，Robo 傳入8.鎖定)
   -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
   WROBO_CONTRACT_NO VARCHAR2 :=NULL -- ROBO 契約書號
)
-- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
RETURN NUMBER
IS

  --宣告變數
  XFUND_CATEGORY  VARCHAR2(1);    --境內外識別碼
  XFUND_TYPE      VARCHAR2(3);    --基金種類
  XNAV_CALENDAR   VARCHAR2(5);    --淨值日行事曆類別
  XPAY_CALENDAR   VARCHAR2(2);    --付款日行事曆類別
  XTX_CALENDAR    VARCHAR2(5);    --交易日行事曆類別
  XPAY_DAY        INTEGER;        --買回付款日參數
  XAC_DATE        DATE;           --最新結帳日
  XIS_CONTROL     VARCHAR2(1);    --員工交易控管\Y：要控制；N：不控制
  XIS_EMP         VARCHAR2(1);    --員工否
  XPUR_DATE       DATE;
  XPUR_DATE1      DATE;
  XPUR_DATE2      DATE;
  XPRE_NAV_DATE   DATE;            --前一個基金淨值日
  XPRE_PAY_DATE   DATE;            --付款前置日
  XPAY_DATE       DATE;            --付款日
  XCEHCK_BUS      INTEGER;         --檢查是否為營業日
  -- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
  -- 2021.07.06 Chengyu 因應瀚亞調整Shares欄位大小
  XTRADE_SHARES   NUMBER(18,6);    --可交易單位數
  XR_SHARES       NUMBER(18,6);    --可買回單位數
  XON_REDEM_SHARES NUMBER(18,6);   --買回單位數
  --2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
  --XPUR_DATE3      DATE;            --基金前 N(PAN_DAY) 個交易日

BEGIN
  --取得基金基本資料
  SELECT  FUND.CALENDAR_CODE AS NAV_CALENDAR
         ,FUND.TX_CALENDAR_CODE AS TX_CALENDAR
         ,SUBSTR(FUND.CURRENCY_NO,1,2) AS PAY_CALENDAR
         ,FUND.PAY_DAY
         ,FUND.FUND_CATEGORY
         ,FUND.FUND_TYPE2
         ,FUND.AC_DATE
    INTO  XNAV_CALENDAR
         ,XTX_CALENDAR
         ,XPAY_CALENDAR
         ,XPAY_DAY
         ,XFUND_CATEGORY
         ,XFUND_TYPE
         ,XAC_DATE
    FROM FAS.FUND FUND
   WHERE FUND.FUND_NO = WFUND_NO;

  --取得員工交易控管
  SELECT AMC.EMP_CTL_CODE
    INTO XIS_CONTROL
    FROM FAS.FUND FUND
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
   WHERE FUND.FUND_NO = WFUND_NO;

  --取得員工否
  SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END IS_EMP
    INTO XIS_EMP
    FROM FAS.RELATIVE RELATIVE
    -- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
    JOIN FAS.EMP ON EMP.ID = RELATIVE.EMP_ID
   WHERE RELATIVE.ID = WID
     -- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
     AND EMP.STATUS = 'A'
     AND (RELATIVE.RELATIONSHIP = 'S' OR
          RELATIVE.RELATIONSHIP = 'P' OR
          RELATIVE.RELATIONSHIP = 'C');

  --dbms_output.put_line('XIS_CONTROL：' || XIS_CONTROL);
  --dbms_output.put_line('XIS_EMP：' || XIS_EMP);
  -- 2018.11.19 JIANXIN MOD 經與Ada、Jessie確認，ROBO 單不控制員工交易
  IF WROBO_CONTRACT_NO IS NOT NULL THEN

    XIS_CONTROL := 'N';
    XIS_EMP := 'N';

  END IF;
  --dbms_output.put_line(' ');
  --dbms_output.put_line('XIS_CONTROL：' || XIS_CONTROL);
  --dbms_output.put_line('XIS_EMP：' || XIS_EMP);

  --BEGIN 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
  --若『員工交易控管(@IS_CONTROL)』為N或『員工否(@IS_EMP)』為N時
  IF XIS_CONTROL = 'N' OR XIS_EMP = 'N' THEN
    --前一個基金淨值日(@PRE_NAV_DATE)：以『下次結帳日(@AC_DATE) 』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --  『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止．
    --取得前一個基金淨值日
    XPRE_NAV_DATE := XAC_DATE - 1;

    --先判斷前一天是否為營業日
    SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
         AND CALENDAR_CODE = XNAV_CALENDAR;

    --如果不是營業日，則繼續往前推
    WHILE XCEHCK_BUS = 1 LOOP
      XPRE_NAV_DATE := XPRE_NAV_DATE-1;

      SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
        AND CALENDAR_CODE = XNAV_CALENDAR;
    END LOOP;
  END IF;
  --END 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期

  --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
  IF XFUND_CATEGORY = '2' THEN
    --1.  前一個基金淨值日(@PRE_NAV_DATE)：以『交易日期(@TX_DATE) 』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --  『淨值日行事曆類別(@NAV_CALENDAR)』及『付款日行事曆類別(@PAY_CALENDAR)』，需皆無資料(表示該日期在二個行事曆類別中，皆為營業日)；
    --若有抓到資料，再減一個日曆日重新推算，直到該日期皆無資料為止．
    --取得前一個基金淨值日
    XPRE_NAV_DATE := WTX_DATE - 1;

    --XPRE_NAV_DATE := XAC_DATE - 1;

    --先判斷前一天是否為營業日
    SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
         AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);

    --如果不是營業日，則繼續往前推
    WHILE XCEHCK_BUS = 1 LOOP
      XPRE_NAV_DATE := XPRE_NAV_DATE-1;

      SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
        AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);
    END LOOP;


  --dbms_output.put_line('XPRE_NAV_DATE：' || XPRE_NAV_DATE);

    --2  付款前置日(@PRE_PAY_DATE)：以『前一個基金淨值日(@PRE_NAV_DATE)』加上『買回付款日參數(@PAY_DAY) 』推算
    --2.1  以『付款日前置日(@PRE_PAY_DATE)』+1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --    『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止．
    --2.2  需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
    --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    -- 2019.01.02 JIANXIN MOD 調整境外基金可贖回單位數日期判斷
    XPRE_PAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'2',XPRE_NAV_DATE,(XPAY_DAY)*-1);

    --3  付款日(@PAY_DATE) ：以『付款前置日(@PRE_PAY_DATE)』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『交易日行事曆類別(@TX_CALENDAR)』，是否有資料；若有抓到資料，則再減一個日曆日重新推算，直到該日期無資料為止
    -- 2019.01.02 JIANXIN MOD 調整境外基金可贖回單位數日期判斷
    XPAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'1',XPRE_PAY_DATE+1,-1);

  END IF; --IF XFUND_CATEGORY = '2' THEN

  --dbms_output.put_line('XPRE_PAY_DATE：' || XPRE_PAY_DATE);
  --dbms_output.put_line('XPAY_DATE：' || XPAY_DATE);

  --若『員工交易控管(@IS_CONTROL)』為Y且『員工否(@IS_EMP)』為Y時
  IF XIS_CONTROL = 'Y' AND XIS_EMP = 'Y' THEN

    --若『基金種類(@FUND_TYPE)』為”B3.貨幣型基金”時
    IF XFUND_TYPE = 'B3' THEN
      XPUR_DATE := WTX_DATE-7;
    ELSE
      XPUR_DATE  := WTX_DATE-60;
      -- 2018.11.16 JIANXIN MOD 經與Lisa、ES 稽核確認調整定期定額鎖定天數由30天改為60天
      -- 2018.11.16 JIANXIN MOD 經與Lisa、Ada、ES 稽核確認調整定期定額鎖定天數由60天改為30天
      XPUR_DATE2 := WTX_DATE-30;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”1.境內”時
    IF XFUND_CATEGORY = '1' THEN
      XPUR_DATE1 := XPUR_DATE;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
    IF XFUND_CATEGORY = '2' THEN
      XPUR_DATE1 := XPAY_DATE;
    END IF; 

    --取得可交易單位數
    SELECT NVL(SUM(C.SHARES),0) AS TRADE_SHARES --可買回單位數
      INTO XTRADE_SHARES
      FROM FAS.CERTIFICATE C,
           FAS.FUND F
     WHERE C.FUND_NO = F.FUND_NO
       AND C.CANCEL_DATE IS NULL
       -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
       AND C.STATUS = WSTATUS
       AND C.FUND_NO = WFUND_NO
       AND C.ID = WID
       AND C.CER_TYPE <> 'C'
       -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
       AND (C.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL)
       AND DECODE(WQUERY_TYPE,'1',NVL(C.CURRENCY_NO,F.CURRENCY_NO),F.CURRENCY_NO) = WCRNCY_NO
       -- 2019.07.09 JIANXIN MOD 調整境內基金配息再申購不可鎖定員工交易
       AND (   ( C.PUR_DATE <= WTX_DATE AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') = '9997000')
            OR ( C.PUR_DATE <= XPUR_DATE1 AND C.PRODUCT_TYPE IN ('L2','L3','L4','L5'))
            -- 2018.07.05 JIANXIN MOD 可買回單位數扣除 ROBO 單，條件增加  PRODUCT_TYPE = 'L7'
            OR ( C.PUR_DATE <= XPUR_DATE  AND C.PRODUCT_TYPE IN ('L1','L7')
                                          AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') <> '9997000')
            OR ( C.PUR_DATE <= XPUR_DATE2 AND SUBSTR(C.PRODUCT_TYPE,1,1) = 'P')
           );
  END IF; -- IF XIS_CONTROL = 'Y' AND XIS_EMP = 'Y'

  --若『員工交易控管(@IS_CONTROL)』為N或『員工否(@IS_EMP)』為N時
  IF XIS_CONTROL = 'N' OR XIS_EMP = 'N' THEN
    XPUR_DATE := WTX_DATE - 1;

    --境內外識別碼(@FUND_CATEGORY)為”1.境內”時
    IF XFUND_CATEGORY = '1' THEN
      XPUR_DATE1 := XPUR_DATE;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
    IF XFUND_CATEGORY = '2' THEN
      XPUR_DATE1 := XPAY_DATE;
    END IF; 

    --dbms_output.put_line( ' XPUR_DATE:' || XPUR_DATE);
    --dbms_output.put_line( ' XPUR_DATE1:' || XPUR_DATE1);

    --取得可交易單位數
    SELECT NVL(SUM(C.SHARES),0) AS TRADE_SHARES --可買回單位數
      INTO XTRADE_SHARES
      FROM FAS.CERTIFICATE C,
           FAS.FUND F
     WHERE C.FUND_NO = F.FUND_NO
       AND C.CANCEL_DATE IS NULL
       -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
       AND C.STATUS = WSTATUS
       -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
       AND (C.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL)
       AND C.FUND_NO = WFUND_NO
       AND C.ID = WID
       AND C.CER_TYPE <> 'C'
       AND DECODE(WQUERY_TYPE,'1',NVL(C.CURRENCY_NO,F.CURRENCY_NO),F.CURRENCY_NO) = WCRNCY_NO
       --2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
       AND ( ( C.PUR_DATE <= XPUR_DATE1 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') 
            --   ( C.PUR_DATE <= XPUR_DATE1 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') AND F.FUND_CATEGORY = '1'
            --OR ( C.PUR_DATE <= XPUR_DATE3 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') AND F.FUND_CATEGORY = '2'
            OR ( C.PUR_DATE <= XPUR_DATE  AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') = '9997000') );

  END IF; --IF XIS_CONTROL = 'N' OR XIS_EMP = 'N'

  --取得買回中單位數
  SELECT NVL(SUM(V_ALL_REDEMPTION.APPLICATION_SHARE),0)
    INTO XON_REDEM_SHARES
    FROM (SELECT DISTINCT FUND_NO
                          ,ID
                          ,AC_DATE
                          ,BROKER_NO 
                          ,BRANCH_NO
                          -- 2020.05.26 JIANXIN MOD 調整贖回中的單位數取得方式
                          ,TX_DATE
                          ,SER_NO
                          ,APPLICATION_SHARE
                          ,ROBO_CONTRACT_NO 
                          -- 2021.05.03 Chengyu 排除贖回資料ECS轉入FAS後單位數重複計算錯誤
                          ,SOURCE_CD
                          ,STATUS                          
            FROM FAS.V_ALL_REDEMPTION   )V_ALL_REDEMPTION
    WHERE V_ALL_REDEMPTION.FUND_NO = WFUND_NO
      AND V_ALL_REDEMPTION.ID = WID
      -- 2018.05.10 ChengYu 修改抓取買回單位數條件
      -- 2018.11.07 PAN MOD FAS.FUND.AC_DATE 為下一個要結帳的日期，非最新結帳日
      --AND V_ALL_REDEMPTION.AC_DATE > XAC_DATE
      AND V_ALL_REDEMPTION.AC_DATE >= XAC_DATE
      -- 2018.10.03 JIANXIN MOD 贖回中的單位數要依據ROBO 單與E-trade排除
      AND (V_ALL_REDEMPTION.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL)
      -- 2021.05.03 Chengyu 排除贖回資料ECS轉入FAS後單位數重複計算錯誤
      -- 資料來源為ECS只取得委託中之資料(STATUS = 'O')
      AND (  (V_ALL_REDEMPTION.SOURCE_CD = 'ECS' AND V_ALL_REDEMPTION.STATUS = 'O')
          OR             
              V_ALL_REDEMPTION.SOURCE_CD = 'FAS'
          ); 

  --如有的話要扣除
  IF XON_REDEM_SHARES != 0 THEN
    XR_SHARES := XTRADE_SHARES - XON_REDEM_SHARES;
  ELSE
    XR_SHARES := XTRADE_SHARES;
  END IF;

  RETURN XR_SHARES;
END;

/

  GRANT EXECUTE ON "ECS"."FN_API_GET_RUNIT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_API_GET_RUNIT_TEST
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_API_GET_RUNIT_TEST" 
-- =============================================
-- Author:      Jim
-- Create date: 2018/03/08
-- Description: 取得可買回單位數
-- 2018.03.31 MOD BY JIM 修改日期格式
-- 2018.04.03 MOD BY JIM 修改邏輯
-- 2018.05.10 ChengYu 修改抓取買回單位數條件
-- 2018.07.05 JIANXIN MOD 可買回單位數扣除 ROBO 單，條件增加  PRODUCT_TYPE = 'L7'
-- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
-- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
-- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
-- 2018.10.03 JIANXIN MOD 贖回中的單位數要依據ROBO 單與E-trade排除
-- 2018.10.04 JIANXIN MOD 如果是境外的基金，可贖回要比設定大於一天
-- 2018.11.07 PAN MOD FAS.FUND.AC_DATE 為下一個要結帳的日期，非最新結帳日
-- 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
-- 2018.11.16 JIANXIN MOD 經與Lisa、ES 稽核確認調整定期定額鎖定天數由30天改為60天
-- 2018.11.16 JIANXIN MOD 經與Lisa、Ada、ES 稽核確認調整定期定額鎖定天數由60天改為30天
-- 2018.11.19 JIANXIN MOD 經與Ada、Jessie確認，ROBO 單不控制員工交易
-- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
-- =============================================
(
   WID             VARCHAR2, --受益人ID
   WTX_DATE        DATE,     --交易日期
   WFUND_NO        VARCHAR2, --基金代碼
   WCRNCY_NO       VARCHAR2, --幣別
   WQUERY_TYPE     VARCHAR2, --查詢幣別
   -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
   WSTATUS         VARCHAR2 := '1',  --庫存狀態 1:有效 2:質設 3:掛失 4:註銷 5:作廢 6:待領 7:待繳 8:鎖定(e-TRADE 傳入1.有效，Robo 傳入8.鎖定)
   -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
   WROBO_CONTRACT_NO VARCHAR2 :=NULL -- ROBO 契約書號
)
-- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
RETURN NUMBER
IS

  --宣告變數
  XFUND_CATEGORY  VARCHAR2(1);    --境內外識別碼
  XFUND_TYPE      VARCHAR2(3);    --基金種類
  XNAV_CALENDAR   VARCHAR2(5);    --淨值日行事曆類別
  XPAY_CALENDAR   VARCHAR2(2);    --付款日行事曆類別
  XTX_CALENDAR    VARCHAR2(5);    --交易日行事曆類別
  XPAY_DAY        INTEGER;        --買回付款日參數
  XAC_DATE        DATE;           --最新結帳日
  XIS_CONTROL     VARCHAR2(1);    --員工交易控管\Y：要控制；N：不控制
  XIS_EMP         VARCHAR2(1);    --員工否
  XPUR_DATE       DATE;
  XPUR_DATE1      DATE;
  XPUR_DATE2      DATE;
  XPRE_NAV_DATE   DATE;            --前一個基金淨值日
  XPRE_PAY_DATE   DATE;            --付款前置日
  XPAY_DATE       DATE;            --付款日
  XCEHCK_BUS      INTEGER;         --檢查是否為營業日
  -- 2018.08.24 JIANXIN MOD 原型態為Decimal，因會將小數位數自動進位，故將型態改為Number
  XTRADE_SHARES   NUMBER(15,3);    --可交易單位數
  XR_SHARES       NUMBER(15,3);    --可買回單位數
  XON_REDEM_SHARES NUMBER(15,3);   --買回單位數
  --2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
  --XPUR_DATE3      DATE;            --基金前 N(PAN_DAY) 個交易日

BEGIN
  --取得基金基本資料
  SELECT  FUND.CALENDAR_CODE AS NAV_CALENDAR
         ,FUND.TX_CALENDAR_CODE AS TX_CALENDAR
         ,SUBSTR(FUND.CURRENCY_NO,1,2) AS PAY_CALENDAR
         ,FUND.PAY_DAY
         ,FUND.FUND_CATEGORY
         ,FUND.FUND_TYPE2
         ,FUND.AC_DATE
    INTO  XNAV_CALENDAR
         ,XTX_CALENDAR
         ,XPAY_CALENDAR
         ,XPAY_DAY
         ,XFUND_CATEGORY
         ,XFUND_TYPE
         ,XAC_DATE
    FROM FAS.FUND FUND
   WHERE FUND.FUND_NO = WFUND_NO;

  --取得員工交易控管
  SELECT AMC.EMP_CTL_CODE
    INTO XIS_CONTROL
    FROM FAS.FUND FUND
    JOIN FAS.AMC AMC
      ON AMC.AMC_NO = FUND.AMC_NO
   WHERE FUND.FUND_NO = WFUND_NO;

  --取得員工否
  SELECT CASE WHEN COUNT(*) > 0 THEN 'Y' ELSE 'N' END IS_EMP
    INTO XIS_EMP
    FROM FAS.RELATIVE RELATIVE
    -- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
    JOIN FAS.EMP ON EMP.ID = RELATIVE.EMP_ID
   WHERE RELATIVE.ID = WID
     -- 2018.12.20 JIANXIN MOD 調整員工邏輯判斷
     AND EMP.STATUS = 'A'
     AND (RELATIVE.RELATIONSHIP = 'S' OR
          RELATIVE.RELATIONSHIP = 'P' OR
          RELATIVE.RELATIONSHIP = 'C');

  --dbms_output.put_line('XIS_CONTROL：' || XIS_CONTROL);
  --dbms_output.put_line('XIS_EMP：' || XIS_EMP);
  -- 2018.11.19 JIANXIN MOD 經與Ada、Jessie確認，ROBO 單不控制員工交易
  IF WROBO_CONTRACT_NO IS NOT NULL THEN

    XIS_CONTROL := 'N';
    XIS_EMP := 'N';

  END IF;
  --dbms_output.put_line(' ');
  --dbms_output.put_line('XIS_CONTROL：' || XIS_CONTROL);
  --dbms_output.put_line('XIS_EMP：' || XIS_EMP);

  --BEGIN 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
  --若『員工交易控管(@IS_CONTROL)』為N或『員工否(@IS_EMP)』為N時
  IF XIS_CONTROL = 'N' OR XIS_EMP = 'N' THEN
    --前一個基金淨值日(@PRE_NAV_DATE)：以『下次結帳日(@AC_DATE) 』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --  『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止．
    --取得前一個基金淨值日
    XPRE_NAV_DATE := XAC_DATE - 1;

    --先判斷前一天是否為營業日
    SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
         AND CALENDAR_CODE = XNAV_CALENDAR;

    --如果不是營業日，則繼續往前推
    WHILE XCEHCK_BUS = 1 LOOP
      XPRE_NAV_DATE := XPRE_NAV_DATE-1;

      SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
        AND CALENDAR_CODE = XNAV_CALENDAR;
    END LOOP;
  END IF;
  --END 2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期

  --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
  IF XFUND_CATEGORY = '2' THEN
    --1.  前一個基金淨值日(@PRE_NAV_DATE)：以『交易日期(@TX_DATE) 』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --  『淨值日行事曆類別(@NAV_CALENDAR)』及『付款日行事曆類別(@PAY_CALENDAR)』，需皆無資料(表示該日期在二個行事曆類別中，皆為營業日)；
    --若有抓到資料，再減一個日曆日重新推算，直到該日期皆無資料為止．
    --取得前一個基金淨值日
    XPRE_NAV_DATE := WTX_DATE - 1;

    --XPRE_NAV_DATE := XAC_DATE - 1;

    --先判斷前一天是否為營業日
    SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
         AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);

    --如果不是營業日，則繼續往前推
    WHILE XCEHCK_BUS = 1 LOOP
      XPRE_NAV_DATE := XPRE_NAV_DATE-1;

      SELECT COUNT(DISTINCT HOLIDAY)
        INTO XCEHCK_BUS
        FROM FAS.CALENDAR
       WHERE HOLIDAY = XPRE_NAV_DATE
        AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);
    END LOOP;


  --dbms_output.put_line('XPRE_NAV_DATE：' || XPRE_NAV_DATE);

    --2  付款前置日(@PRE_PAY_DATE)：以『前一個基金淨值日(@PRE_NAV_DATE)』加上『買回付款日參數(@PAY_DAY) 』推算
    --2.1  以『付款日前置日(@PRE_PAY_DATE)』+1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的
    --    『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止．
    --2.2  需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
    --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    XPRE_PAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'2',XPRE_NAV_DATE,(XPAY_DAY)*-1);

    --3  付款日(@PAY_DATE) ：以『付款前置日(@PRE_PAY_DATE)』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『交易日行事曆類別(@TX_CALENDAR)』，是否有資料；若有抓到資料，則再減一個日曆日重新推算，直到該日期無資料為止
    XPAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'1',XPRE_PAY_DATE+1,-1);

  END IF; --IF XFUND_CATEGORY = '2' THEN

  --dbms_output.put_line('XPRE_PAY_DATE：' || XPRE_PAY_DATE);
  --dbms_output.put_line('XPAY_DATE：' || XPAY_DATE);

  --若『員工交易控管(@IS_CONTROL)』為Y且『員工否(@IS_EMP)』為Y時
  IF XIS_CONTROL = 'Y' AND XIS_EMP = 'Y' THEN

    --若『基金種類(@FUND_TYPE)』為”B3.貨幣型基金”時
    IF XFUND_TYPE = 'B3' THEN
      XPUR_DATE := WTX_DATE-7;
    ELSE
      XPUR_DATE  := WTX_DATE-60;
      -- 2018.11.16 JIANXIN MOD 經與Lisa、ES 稽核確認調整定期定額鎖定天數由30天改為60天
      -- 2018.11.16 JIANXIN MOD 經與Lisa、Ada、ES 稽核確認調整定期定額鎖定天數由60天改為30天
      XPUR_DATE2 := WTX_DATE-30;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”1.境內”時
    IF XFUND_CATEGORY = '1' THEN
      XPUR_DATE1 := XPUR_DATE;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
    IF XFUND_CATEGORY = '2' THEN
      XPUR_DATE1 := XPAY_DATE;
    END IF; 

    --取得可交易單位數
    SELECT NVL(SUM(C.SHARES),0) AS TRADE_SHARES --可買回單位數
      INTO XTRADE_SHARES
      FROM FAS.CERTIFICATE C,
           FAS.FUND F
     WHERE C.FUND_NO = F.FUND_NO
       AND C.CANCEL_DATE IS NULL
       -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
       AND C.STATUS = WSTATUS
       AND C.FUND_NO = WFUND_NO
       AND C.ID = WID
       AND C.CER_TYPE <> 'C'
       -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
       AND (C.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL)
       AND DECODE(WQUERY_TYPE,'1',NVL(C.CURRENCY_NO,F.CURRENCY_NO),F.CURRENCY_NO) = WCRNCY_NO
       AND (   ( C.PUR_DATE <= XPUR_DATE1 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') = '9997000')
            OR ( C.PUR_DATE <= XPUR_DATE1 AND C.PRODUCT_TYPE IN ('L2','L3','L4','L5'))
            -- 2018.07.05 JIANXIN MOD 可買回單位數扣除 ROBO 單，條件增加  PRODUCT_TYPE = 'L7'
            OR ( C.PUR_DATE <= XPUR_DATE  AND C.PRODUCT_TYPE IN ('L1','L7')
                                          AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') <> '9997000')
            OR ( C.PUR_DATE <= XPUR_DATE2 AND SUBSTR(C.PRODUCT_TYPE,1,1) = 'P')
           );
  END IF; -- IF XIS_CONTROL = 'Y' AND XIS_EMP = 'Y'

  --若『員工交易控管(@IS_CONTROL)』為N或『員工否(@IS_EMP)』為N時
  IF XIS_CONTROL = 'N' OR XIS_EMP = 'N' THEN
    XPUR_DATE := WTX_DATE - 1;

    --境內外識別碼(@FUND_CATEGORY)為”1.境內”時
    IF XFUND_CATEGORY = '1' THEN
      XPUR_DATE1 := XPUR_DATE;
    END IF;

    --境內外識別碼(@FUND_CATEGORY)為”2.境外”時
    IF XFUND_CATEGORY = '2' THEN
      XPUR_DATE1 := XPAY_DATE;
    END IF; 

    --dbms_output.put_line( ' XPUR_DATE:' || XPUR_DATE);
    --dbms_output.put_line( ' XPUR_DATE1:' || XPUR_DATE1);

    --取得可交易單位數
    SELECT NVL(SUM(C.SHARES),0) AS TRADE_SHARES --可買回單位數
      INTO XTRADE_SHARES
      FROM FAS.CERTIFICATE C,
           FAS.FUND F
     WHERE C.FUND_NO = F.FUND_NO
       AND C.CANCEL_DATE IS NULL
       -- 2018.07.16 JIANXIN MOD 調整可買回單位數判斷是否為Robo 單
       AND C.STATUS = WSTATUS
       -- 2018.08.29 JIANXIN MOD 調整可買回單位數依據契約單回傳可贖回單位數
       AND (C.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL)
       AND C.FUND_NO = WFUND_NO
       AND C.ID = WID
       AND C.CER_TYPE <> 'C'
       AND DECODE(WQUERY_TYPE,'1',NVL(C.CURRENCY_NO,F.CURRENCY_NO),F.CURRENCY_NO) = WCRNCY_NO
       --2018.11.14 PAN MOD 境外申購單有 N 天閉鎖期
       AND ( ( C.PUR_DATE <= XPUR_DATE1 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') 
            --   ( C.PUR_DATE <= XPUR_DATE1 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') AND F.FUND_CATEGORY = '1'
            --OR ( C.PUR_DATE <= XPUR_DATE3 AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000')<> '9997000') AND F.FUND_CATEGORY = '2'
            OR ( C.PUR_DATE <= XPUR_DATE  AND NVL(C.BROKER_NO,'999')||NVL(C.BRANCH_NO,'0000') = '9997000') );

  END IF; --IF XIS_CONTROL = 'N' OR XIS_EMP = 'N'

  --取得買回中單位數
  SELECT NVL(SUM(V_ALL_REDEMPTION.APPLICATION_SHARE),0)
    INTO XON_REDEM_SHARES
    FROM (SELECT DISTINCT FUND_NO
                          ,ID
                          ,AC_DATE
                          ,BROKER_NO 
                          ,BRANCH_NO
                          ,APPLICATION_SHARE
                          ,ROBO_CONTRACT_NO 
            FROM FAS.V_ALL_REDEMPTION   )V_ALL_REDEMPTION
    WHERE V_ALL_REDEMPTION.FUND_NO = WFUND_NO
      AND V_ALL_REDEMPTION.ID = WID
      -- 2018.05.10 ChengYu 修改抓取買回單位數條件
      -- 2018.11.07 PAN MOD FAS.FUND.AC_DATE 為下一個要結帳的日期，非最新結帳日
      --AND V_ALL_REDEMPTION.AC_DATE > XAC_DATE
      AND V_ALL_REDEMPTION.AC_DATE >= XAC_DATE
      -- 2018.10.03 JIANXIN MOD 贖回中的單位數要依據ROBO 單與E-trade排除
      AND (V_ALL_REDEMPTION.ROBO_CONTRACT_NO = WROBO_CONTRACT_NO OR WROBO_CONTRACT_NO IS NULL);

  --如有的話要扣除
  IF XON_REDEM_SHARES != 0 THEN
    XR_SHARES := XTRADE_SHARES - XON_REDEM_SHARES;
  ELSE
    XR_SHARES := XTRADE_SHARES;
  END IF;

  RETURN XR_SHARES;
END;
--/
--GRANT EXECUTE ON ECS.FN_API_GET_RUNIT_TEST TO ECROBO;

/

  GRANT EXECUTE ON "ECS"."FN_API_GET_RUNIT_TEST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_DIAGRAMOBJECTS
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_DIAGRAMOBJECTS" 
RETURN NUMBER
AUTHID DEFINER
AS
   v_id_upgraddiagrams NUMBER(10,0);
   v_id_sysdiagrams NUMBER(10,0);
   v_id_helpdiagrams NUMBER(10,0);
   v_id_helpdiagramdefinition NUMBER(10,0);
   v_id_creatediagram NUMBER(10,0);
   v_id_renamediagram NUMBER(10,0);
   v_id_alterdiagram NUMBER(10,0);
   v_id_dropdiagram NUMBER(10,0);
   v_InstalledObjects NUMBER(10,0);

BEGIN
   v_InstalledObjects := 0 ;
   v_id_upgraddiagrams := NULL/*TODO:object_id(N'dbo.sp_upgraddiagrams')*/ ;
   v_id_sysdiagrams := NULL/*TODO:object_id(N'dbo.sysdiagrams')*/ ;
   v_id_helpdiagrams := NULL/*TODO:object_id(N'dbo.sp_helpdiagrams')*/ ;
   v_id_helpdiagramdefinition := NULL/*TODO:object_id(N'dbo.sp_helpdiagramdefinition')*/ ;
   v_id_creatediagram := NULL/*TODO:object_id(N'dbo.sp_creatediagram')*/ ;
   v_id_renamediagram := NULL/*TODO:object_id(N'dbo.sp_renamediagram')*/ ;
   v_id_alterdiagram := NULL/*TODO:object_id(N'dbo.sp_alterdiagram')*/ ;
   v_id_dropdiagram := NULL/*TODO:object_id(N'dbo.sp_dropdiagram')*/ ;
   IF v_id_upgraddiagrams IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 1 ;
   END IF;
   IF v_id_sysdiagrams IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 2 ;
   END IF;
   IF v_id_helpdiagrams IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 4 ;
   END IF;
   IF v_id_helpdiagramdefinition IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 8 ;
   END IF;
   IF v_id_creatediagram IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 16 ;
   END IF;
   IF v_id_renamediagram IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 32 ;
   END IF;
   IF v_id_alterdiagram IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 64 ;
   END IF;
   IF v_id_dropdiagram IS NOT NULL THEN
      v_InstalledObjects := v_InstalledObjects + 128 ;
   END IF;
   RETURN v_InstalledObjects;
END;

/

  GRANT EXECUTE ON "ECS"."FN_DIAGRAMOBJECTS" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_GETDEPTGROUPRIGHT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_GETDEPTGROUPRIGHT" (
  strUserID in varchar2,
  strFunctionID in varchar2
)
RETURN T_FN_GetDeptGroupRight_TABLE as
  v_ret   T_FN_GetDeptGroupRight_TABLE;
begin
  select
  cast(
  multiset(
  select
   Decode(UG.GroupType, 'E', 1, 0) as IsE,
   Decode(UG.GroupType, 'V', 1, 0) as IsV,
   Decode(UG.GroupType, 'A', 1, 0) as IsA, 
   Decode(UG.GroupType, 'E', 1, 0) * GR.IsAdd as IsAdd,
   Decode(UG.GroupType, 'E', 1, 0) * GR.Isupdate as IsUpdate,
   Decode(UG.GroupType, 'E', 1, 0) * GR.Isdelete as IsDelete,
   Decode(UG.GroupType, 'V', 1, 0) * GR.Isverify as IsVerify,
   Decode(UG.GroupType, 'A', 1, 0) * GR.IsApprove as IsApprove,
   UG.GroupID,UG.DeptID,UG.GroupType,UG.IsValidateEntry  
     FROM table(FN_GetLoginGroup(strUserID)) UG, AA_GroupRight GR
     where UG.GroupID = GR.GroupID(+)
       AND GR.FunctionID = STRFUNCTIONID                             
                 )
      as T_FN_GetDeptGroupRight_TABLE)
    into
      v_ret
    from
      dual;

  return v_ret;

end FN_GetDeptGroupRight;

/

  GRANT EXECUTE ON "ECS"."FN_GETDEPTGROUPRIGHT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_GETEVA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_GETEVA" (
  strUserID in varchar2,
  strFunctionID in varchar2
)
RETURN T_FN_GetEVA_TABLE as
  v_ret   T_FN_GetEVA_TABLE;
begin
  select
  cast(
  multiset(
  select
   Decode(UG.GroupType, 'E', 1, 0) as IsE,
   Decode(UG.GroupType, 'V', 1, 0) as IsV,
   Decode(UG.GroupType, 'A', 1, 0) as IsA,
   UG.GroupID,UG.DeptID,UG.GroupType
     FROM table(
          cast(FN_GetLoginGroup(strUserID)
           as T_FUNCTIONPERMISSION_TABLE)) UG,
      AA_GroupRight GR
     where      UG.GroupID 
     = GR.GroupID(+)
       AND GR.FunctionID = STRFUNCTIONID
                 )
      as T_FN_GetEVA_TABLE)
    into
      v_ret
    from
      dual;

  return v_ret;

end FN_GetEVA;

/

  GRANT EXECUTE ON "ECS"."FN_GETEVA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_GETLOGINGROUP
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_GETLOGINGROUP" (
  strUserID in varchar2
)
RETURN T_FUNCTIONPERMISSION_TABLE as
  v_ret   T_FUNCTIONPERMISSION_TABLE;
begin
  select 
  cast(
  multiset(
    SELECT DISTINCT AA_DeptGroup.GroupID,AA_DeptGroup.DeptID,AA_DeptGroup.GroupType,AA_Group.IsValidateEntry
      FROM AA_UserGroup
      INNER JOIN  AA_DeptGroup
              ON  AA_DeptGroup.GroupID = AA_UserGroup.GroupID
      INNER JOIN  AA_Group
              ON  AA_DeptGroup.GroupID = AA_Group.GroupID
         WHERE AA_UserGroup.UserID IN              
         					   (
								SELECT AA_User.UserID
								  FROM AA_User
								 WHERE DeputyID = strUserID
								   AND BanMark=1
								) ) 
      as T_FUNCTIONPERMISSION_TABLE)
    into
      v_ret
    from 
      dual;

  return v_ret;

end FN_GETLOGINGROUP;

/

  GRANT EXECUTE ON "ECS"."FN_GETLOGINGROUP" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_GETMSG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_GETMSG" (V_MSGID in VARCHAR2)
  return varchar2 is
  X_Result varchar2(2000);
begin
  X_Result := '';
  SELECT MSGCONTENT INTO X_Result FROM ECS.MSGINFO WHERE MSGID = V_MSGID;

  return(X_Result);
end FN_GETMSG;

/

  GRANT EXECUTE ON "ECS"."FN_GETMSG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_GET_IS_ES_ACCOUNT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_GET_IS_ES_ACCOUNT" (V_ID in varchar2)
  return varchar2 is
  X_IS_ES_ACCOUNT VARCHAR2(1);
  X_IS_HAS_HOLDER VARCHAR2(1);
  X_HOLDER_AMC_CNT INT;
  X_HOLDER_EC_DATE DATE;
  X_EC_DATE DATE;  
begin
  X_IS_ES_ACCOUNT := 'N';
  X_IS_HAS_HOLDER := 'N';
  X_HOLDER_AMC_CNT := 0;
  X_HOLDER_EC_DATE := NULL;

   --判斷HAS.HOLDER是否有資料
    BEGIN
      SELECT 'Y' ,EC_DATE
      INTO X_IS_HAS_HOLDER,X_EC_DATE 
      FROM FAS.HOLDER 
      WHERE ID = V_ID;
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_IS_HAS_HOLDER := 'N';        
    END;

    --判斷FAS.HOLDER_DIVIDEND_AMC是否有四筆資料，若有表示基金公司已完成核印
    BEGIN
      SELECT COUNT(*)
        INTO X_HOLDER_AMC_CNT
        FROM FAS.HOLDER_AMC
       WHERE ID = V_ID
       GROUP BY ID;   
    EXCEPTION
      WHEN NO_DATA_FOUND THEN
        X_HOLDER_AMC_CNT := 0;        
    END;     

    --判斷HAS.HOLDER是否有資料，若有表示已開戶或者為舊戶
    IF X_IS_HAS_HOLDER = 'Y' THEN
      BEGIN
        --判斷FAS.HOLDER_DIVIDEND_AMC是否有四筆資料，若有表示基金公司已完成核印
         IF X_HOLDER_AMC_CNT = 4 THEN
          BEGIN
            --EC_DATE = Null表示客戶尚未啟用EC交易戶，為舊戶升級(當作新開戶)
            IF X_HOLDER_EC_DATE IS NULL THEN
              BEGIN
                  X_IS_ES_ACCOUNT := 'Y';
              END;
            END IF;
          END;
        ELSE
        --沒有表示，此客戶四家基金公司尚未齊全,為舊戶升級(當作新開戶)
          BEGIN
             X_IS_ES_ACCOUNT := 'Y';          
          END;
        END IF;
      END;
    END IF;  

  return(X_IS_ES_ACCOUNT);
end FN_GET_IS_ES_ACCOUNT;

/

  GRANT EXECUTE ON "ECS"."FN_GET_IS_ES_ACCOUNT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_LOGID_APPROVE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_LOGID_APPROVE" 
RETURN NVARCHAR2
AS
   -- Declare the return variable here
   v_Result VARCHAR2(11);
-- Add the parameters for the function here
--@UserID nvarchar(11)

BEGIN
   -- Add the T-SQL statements to compute the return value here
   SELECT ( SELECT * 
              FROM ( SELECT LogID_Approve
            FROM DBLoginUser 
             WHERE SPID = UID
              ORDER BY UpdateDate DESC )
              WHERE ROWNUM <= 1 )

     INTO v_Result
     FROM DUAL ;
   IF ( v_Result IS NULL ) THEN
      v_Result := SYS_CONTEXT('USERENV','OS_USER') ;
   END IF;
   -- Return the result of the function
   RETURN v_Result;
END;

/

  GRANT EXECUTE ON "ECS"."FN_LOGID_APPROVE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_LOGID_UPDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_LOGID_UPDATE" 
RETURN NVARCHAR2
AS
   -- Declare the return variable here
   v_Result VARCHAR2(11);
-- Add the parameters for the function here
--@UserID nvarchar(11)

BEGIN
   -- Add the T-SQL statements to compute the return value here
   SELECT ( SELECT * 
              FROM ( SELECT LogID_Update
            FROM DBLoginUser 
             WHERE SPID = UID
              ORDER BY UpdateDate DESC )
              WHERE ROWNUM <= 1 )

     INTO v_Result
     FROM DUAL ;
   IF ( v_Result IS NULL ) THEN
      v_Result := SYS_CONTEXT('USERENV','OS_USER') ;
   END IF;
   -- Return the result of the function
   RETURN v_Result;
END;

/

  GRANT EXECUTE ON "ECS"."FN_LOGID_UPDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_SPLIT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_SPLIT" (p_string IN VARCHAR2, p_delimiter IN VARCHAR2)
    RETURN type_string_split_tab
IS
    int_j                  INT := 0;
    int_i                  INT := 1;
    int_string_length      INT := 0;
    int_delimiter_length   INT := 0;

    v_string               VARCHAR2 (4000);
    v_string_split         type_string_split_tab;
BEGIN
    v_string_split := type_string_split_tab ();
    int_string_length := LENGTH (p_string);
    int_delimiter_length := LENGTH (p_delimiter);

    WHILE int_j < int_string_length
    LOOP
        int_j := INSTR (p_string, p_delimiter, int_i);

        IF int_j = 0
        THEN
            int_j := int_string_length;
            v_string := SUBSTR (p_string, int_i);
            v_string_split.EXTEND;
            v_string_split (v_string_split.COUNT) := v_string;

            IF int_i >= int_string_length
            THEN
                EXIT;
            END IF;
        ELSE
            v_string := SUBSTR (p_string, int_i, int_j - int_i);
            int_i := int_j + int_delimiter_length;
            v_string_split.EXTEND;
            v_string_split (v_string_split.COUNT) := v_string;
        END IF;
    END LOOP;

    RETURN v_string_split;
END;

/

  GRANT EXECUTE ON "ECS"."FN_SPLIT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_STRING_FORMAT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_STRING_FORMAT" (p_stringformat   IN VARCHAR2,
                                 p_stringvalue    IN VARCHAR2)
    RETURN VARCHAR2
IS
 
    int_i                 INT := 0;
    int_totalvalue        INT := 0;
    v_stringvalue_split   type_string_split_tab;
    v_repalcestring       VARCHAR2 (1000);
BEGIN
    v_stringvalue_split := fn_split (p_stringvalue, ',');
    int_totalvalue := v_stringvalue_split.COUNT;
    v_repalcestring := p_stringformat;

    FOR i IN 0 .. int_totalvalue - 1
    LOOP
        v_repalcestring :=
            REPLACE (v_repalcestring,
                     '{' || TO_CHAR (i) || '}',
                     v_stringvalue_split (i + 1));
    END LOOP;

    RETURN v_repalcestring;
END;

/

  GRANT EXECUTE ON "ECS"."FN_STRING_FORMAT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function FN_STUFF_STR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."FN_STUFF_STR" 
-- =============================================
-- Author:      Jianxin
-- Create date: 2018/08/23
-- Description: 字串隱碼
-- 2019.05.08 tingting 增加支援隱藏右邊文字方式、隱藏EMAIL帳號右邊文字方式
-- 2019.05.09 JIANXIN 調整email 隱碼的方式，若隱碼的長度小於傳入Email 的長度，則全部隱碼
-- =============================================
(
    WSTR            VARCHAR2,           --要隱碼的字串
    WLEN            INT,                --要顯示的字串長度
    WSIGN           VARCHAR2,           --要取代的字串
    -- 2019.05.08 tingting 增加支援隱藏右邊文字方式、隱藏EMAIL帳號右邊文字方式
    WTYPE           VARCHAR2 := 'L'     --隱碼方式 L.隱藏左邊文字 R.隱藏右邊文字 ER.隱藏EMAIL帳號右邊文字
)
RETURN VARCHAR2
IS

    XSTR            VARCHAR2(1000);     --回傳字串最大數為1000
    XINDEX          INT := 1;           --字串位置
    XEMAIL          VARCHAR2(1000);     --EMAIL帳號(不包含@後面字串)
    XINSTR          INT;                --取特定字串位置

BEGIN      

    -- L.隱藏左邊文字
    IF WTYPE = 'L' THEN 
    BEGIN 

        -- 前面字串隱碼
        WHILE XINDEX <= LENGTH(WSTR) - WLEN
        LOOP

            XSTR := XSTR || WSIGN;

            XINDEX := XINDEX + 1;

        END LOOP;

        -- 前面字串隱碼 + 後面要顯示的字串
        XSTR := XSTR || SUBSTR(WSTR, XINDEX, WLEN);

    END;
    -- R.隱藏右邊文字
    -- 2019.05.08 tingting 增加支援隱藏右邊文字方式、隱藏EMAIL帳號右邊文字方式
    ELSIF WTYPE = 'R' THEN
    BEGIN

        -- 取得前面要顯示的字串
        XSTR := XSTR || SUBSTR(WSTR, 1, WLEN);

        XINDEX := WLEN + 1;

        -- 後面字串隱碼
        WHILE  XINDEX <= LENGTH(WSTR)
        LOOP

            XSTR := XSTR || WSIGN;

            XINDEX := XINDEX + 1;

        END LOOP;

    END;
    -- ER.隱藏EMAIL帳號右邊文字
    -- 2019.05.08 tingting 增加支援隱藏右邊文字方式、隱藏EMAIL帳號右邊文字方式
    ELSIF WTYPE = 'ER' THEN
    BEGIN

        -- 取得@位置
        XINSTR := INSTR(WSTR,'@',1,1);

        -- 取得EMAIL帳號(@前面字串)
        XEMAIL := SUBSTR(WSTR, 1, XINSTR - 1);

        -- 取得EMAIL帳號前面要顯示的字串
        -- 2019.05.09 JIANXIN 調整email 隱碼的方式，若隱碼的長度小於傳入Email 的長度，則全部隱碼
        XSTR := CASE WHEN LENGTH(XEMAIL) <= WLEN THEN '' ELSE SUBSTR(XEMAIL, 1, WLEN) END;

        -- 取得字串位置
        XINDEX := CASE WHEN LENGTH(XSTR) >= WLEN THEN WLEN ELSE NVL(LENGTH(XSTR),0) END + 1;

        -- EMAIL帳號後面字串隱碼
        WHILE  XINDEX <= LENGTH(XEMAIL)
        LOOP

            XSTR := XSTR || WSIGN;

            XINDEX := XINDEX + 1;

        END LOOP;

        -- EMAIL帳號 + @後面字串
        XSTR := XSTR || SUBSTR(WSTR, XINDEX, LENGTH(WSTR));

    END;
    END IF;

    RETURN XSTR;

END;

/

  GRANT EXECUTE ON "ECS"."FN_STUFF_STR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_ECSB007_GETBANKA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_ECSB007_GETBANKA" 
-- =============================================
-- Author:      Chengyu
-- Create date: 2021/08/03
-- Description: 傳出新增至FAS.HOLDER_BANK_EC資料(扣款帳號)
-- =============================================
(
    WID    IN VARCHAR2            --客戶ID
)
RETURN TYPE_BANKLIST_TABLE pipelined AS
    TDCC_TWD_CNT INT;
BEGIN

    FOR CUR IN (SELECT * FROM ECS.HOLDER WHERE ID = WID)
    LOOP      

       --確認集保台幣銀行是否有檢查MMA
       SELECT COUNT(1) 
          INTO TDCC_TWD_CNT
          FROM FAS.FIS_BANK 
         WHERE MMA_CHECKED = 'Y' 
           AND BANK_NO = CUR.TDCC_BANK_NO;

      --財金台外幣資料都要新增
      --財金台幣
      IF LTRIM(CUR.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN  

            PIPE ROW(TYPE_BANKLIST_ROW('A',
                                       '1',
                                       CUR.ID,
                                       CUR.FIS_BANK_NO_TWD,
                                       CUR.FIS_BRANCH_NO_TWD,
                                       CUR.FIS_AC_CODE_TWD,
                                       CUR.FIS_CURRENCY_NO_TWD,
                                       ''
                                      )
            ); 

      END IF;

      --財金外幣
      IF LTRIM(CUR.FIS_CURRENCY_NO_FCY) IS NOT NULL THEN  

            PIPE ROW(TYPE_BANKLIST_ROW('A',
                                       '2',
                                       CUR.ID,
                                       CUR.FIS_BANK_NO_TWD_FCY,
                                       CUR.FIS_BRANCH_NO_TWD_FCY,
                                       CUR.FIS_AC_CODE_TWD_FCY,
                                       CUR.FIS_CURRENCY_NO_FCY,
                                       ''
                                      )
            ); 

      END IF;

      --集保台外幣資料若相同則為MMA帳號
      --集保台幣
      IF LTRIM(CUR.TDCC_CURRENCY_NO) IS NOT NULL THEN  

            PIPE ROW(TYPE_BANKLIST_ROW('A',
                                       '3',
                                       CUR.ID,
                                       CUR.TDCC_BANK_NO,
                                       CUR.TDCC_BRANCH_NO,
                                       CUR.TDCC_AC_CODE,
                                       CASE WHEN NVL(LTRIM(CUR.TDCC_BANK_NO_TWD_FCY),' ') = NVL(LTRIM(CUR.TDCC_BANK_NO),' ')
                                             AND NVL(LTRIM(CUR.TDCC_BRANCH_NO_TWD_FCY),' ') = NVL(LTRIM(CUR.TDCC_BRANCH_NO),' ')
                                             AND NVL(LTRIM(CUR.TDCC_AC_CODE_TWD_FCY),' ') = NVL(LTRIM(CUR.TDCC_AC_CODE),' ')
                                             AND TDCC_TWD_CNT > 0
                                            THEN 'MMA'
                                            ELSE LTRIM(CUR.TDCC_CURRENCY_NO)
                                        END,
                                       ''
                                      )
            ); 

      END IF;

      --集保外幣
      IF LTRIM(CUR.TDCC_CURRENCY_NO_FCY) IS NOT NULL 
         AND (
               NVL(LTRIM(CUR.TDCC_BANK_NO_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_BANK_NO),' ')
            OR NVL(LTRIM(CUR.TDCC_BRANCH_NO_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_BRANCH_NO),' ')
            OR NVL(LTRIM(CUR.TDCC_AC_CODE_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_AC_CODE),' ')
            OR TDCC_TWD_CNT = 0
             ) THEN  

            PIPE ROW(TYPE_BANKLIST_ROW('A',
                                       '4',
                                       CUR.ID,
                                       CUR.TDCC_BANK_NO_TWD_FCY,
                                       CUR.TDCC_BRANCH_NO_TWD_FCY,
                                       CUR.TDCC_AC_CODE_TWD_FCY,
                                       CUR.TDCC_CURRENCY_NO_FCY,
                                       ''
                                      )
            ); 

      END IF;
    END LOOP;



    RETURN;

END F_ECSB007_GetBankA;

/

  GRANT EXECUTE ON "ECS"."F_ECSB007_GETBANKA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_ECSB007_GETBANKD
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_ECSB007_GETBANKD" 
-- =============================================
-- Author:      Chengyu
-- Create date: 2021/08/03
-- Description: 傳出新增至FAS.HOLDER_DIVIDEND_BANK資料(分配帳號)
-- 2021.08.10 Chengyu 若無集保外幣資料，則用財金外幣資料寫入
-- =============================================
(
    WID    IN VARCHAR2            --客戶ID
)
RETURN TYPE_BANKLIST_TABLE pipelined AS
    FIS_TWD_CNT INT;
    IS_MMA VARCHAR2(1):='N';
BEGIN

    FOR CUR IN (SELECT * FROM ECS.HOLDER WHERE ID = WID)
    LOOP

       --確認財金台幣銀行是否有檢查MMA
       SELECT COUNT(1) 
          INTO FIS_TWD_CNT
          FROM FAS.FIS_BANK 
         WHERE MMA_CHECKED = 'Y' 
           AND BANK_NO = CUR.FIS_BANK_NO_TWD; 

      --檢查是否為新增MMA資料(財金與集保台外幣資料皆相同才是MMA資料)
      --瀚亞特殊規則：開戶時若無寫入集保外幣資料 且 其他資料符合MMA條件，買回帳號與分配帳號同MMA資料，扣款帳號只核印集保台幣
      SELECT CASE WHEN COUNT(1) = 1 THEN 'Y' ELSE 'N'END
        INTO IS_MMA
        FROM ( SELECT  CUR.FIS_BANK_NO_TWD 
                      ,CUR.FIS_BRANCH_NO_TWD 
                      ,CUR.FIS_AC_CODE_TWD 
                 FROM DUAL
                UNION 
               SELECT  CUR.FIS_BANK_NO_TWD_FCY
                      ,CUR.FIS_BRANCH_NO_TWD_FCY
                      ,CUR.FIS_AC_CODE_TWD_FCY
                 FROM DUAL
                UNION 
               SELECT  CUR.TDCC_BANK_NO
                      ,CUR.TDCC_BRANCH_NO
                      ,CUR.TDCC_AC_CODE
                 FROM DUAL
                UNION 
               SELECT  CUR.TDCC_BANK_NO_TWD_FCY
                      ,CUR.TDCC_BRANCH_NO_TWD_FCY
                      ,CUR.TDCC_AC_CODE_TWD_FCY
                 FROM DUAL
             ) DATA
       WHERE LTRIM(CUR.FIS_CURRENCY_NO_TWD) IS NOT NULL
         AND LTRIM(CUR.FIS_BANK_NO_TWD_FCY) IS NOT NULL
         AND LTRIM(CUR.TDCC_CURRENCY_NO) IS NOT NULL
         AND FIS_TWD_CNT > 0;           

      --若IS_MMA為Y，則新增一筆MMA資料至買回帳號
      IF IS_MMA = 'Y' THEN

        --財金台幣
        --AMC_NO = '01' 基金經理公司01.瀚亞投信(境內)
        PIPE ROW(TYPE_BANKLIST_ROW('D',
                                   '1',
                                   CUR.ID,
                                   CUR.FIS_BANK_NO_TWD,
                                   CUR.FIS_BRANCH_NO_TWD,
                                   CUR.FIS_AC_CODE_TWD,
                                   'MMA',
                                   '01'
                                  )
        ); 
        --AMC_NO = '02' 基金經理公司02.瀚亞投資(新加坡)
        PIPE ROW(TYPE_BANKLIST_ROW('D',
                                   '1',
                                   CUR.ID,
                                   CUR.FIS_BANK_NO_TWD,
                                   CUR.FIS_BRANCH_NO_TWD,
                                   CUR.FIS_AC_CODE_TWD,
                                   'MMA',
                                   '02'
                                  )
        ); 
        --AMC_NO = '03' 基金經理公司03.MG(新加坡)
        PIPE ROW(TYPE_BANKLIST_ROW('D',
                                   '1',
                                   CUR.ID,
                                   CUR.FIS_BANK_NO_TWD,
                                   CUR.FIS_BRANCH_NO_TWD,
                                   CUR.FIS_AC_CODE_TWD,
                                   'MMA',
                                   '03'
                                  )
        );     

        --集保        
        --AMC_NO = '04' 基金經理公司04.瑞萬通博(TDCC)
        PIPE ROW(TYPE_BANKLIST_ROW('D',
                                   '4',
                                   CUR.ID,
                                   CUR.TDCC_BANK_NO,
                                   CUR.TDCC_BRANCH_NO,
                                   CUR.TDCC_AC_CODE,
                                   'MMA',
                                   '04'
                                  )
        ); 

      ELSE

        --財金台幣
        IF LTRIM(CUR.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN  

          --AMC_NO = '01' 基金經理公司01.瀚亞投信(境內)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '1',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD,
                                     CUR.FIS_BRANCH_NO_TWD,
                                     CUR.FIS_AC_CODE_TWD,
                                     CUR.FIS_CURRENCY_NO_TWD,
                                     '01'
                                    )
          ); 
          --AMC_NO = '02' 基金經理公司02.瀚亞投資(新加坡)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '1',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD,
                                     CUR.FIS_BRANCH_NO_TWD,
                                     CUR.FIS_AC_CODE_TWD,
                                     CUR.FIS_CURRENCY_NO_TWD,
                                     '02'
                                    )
          ); 
          --AMC_NO = '03' 基金經理公司03.MG(新加坡)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '1',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD,
                                     CUR.FIS_BRANCH_NO_TWD,
                                     CUR.FIS_AC_CODE_TWD,
                                     CUR.FIS_CURRENCY_NO_TWD,
                                     '03'
                                    )
          ); 

        END IF;

        --財金外幣
        IF LTRIM(CUR.FIS_CURRENCY_NO_FCY) IS NOT NULL THEN 
          --AMC_NO = '01' 基金經理公司01.瀚亞投信(境內)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '2',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD_FCY,
                                     CUR.FIS_BRANCH_NO_TWD_FCY,
                                     CUR.FIS_AC_CODE_TWD_FCY,
                                     CUR.FIS_CURRENCY_NO_FCY,
                                     '01'
                                    )
          ); 
          --AMC_NO = '02' 基金經理公司02.瀚亞投資(新加坡)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '2',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD_FCY,
                                     CUR.FIS_BRANCH_NO_TWD_FCY,
                                     CUR.FIS_AC_CODE_TWD_FCY,
                                     CUR.FIS_CURRENCY_NO_FCY,
                                     '02'
                                    )
          ); 
          --AMC_NO = '03' 基金經理公司03.MG(新加坡)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '2',
                                     CUR.ID,
                                     CUR.FIS_BANK_NO_TWD_FCY,
                                     CUR.FIS_BRANCH_NO_TWD_FCY,
                                     CUR.FIS_AC_CODE_TWD_FCY,
                                     CUR.FIS_CURRENCY_NO_FCY,
                                     '03'
                                    )
          ); 

        END IF;

        --集保台幣
        IF LTRIM(CUR.TDCC_CURRENCY_NO) IS NOT NULL THEN  

          --AMC_NO = '04' 基金經理公司04.瑞萬通博(TDCC)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '3',
                                     CUR.ID,
                                     CUR.TDCC_BANK_NO,
                                     CUR.TDCC_BRANCH_NO,
                                     CUR.TDCC_AC_CODE,
                                     CUR.TDCC_CURRENCY_NO,
                                     '04'
                                    )
          ); 

        END IF;

        -- 2021.08.10 Chengyu 若無集保外幣資料，則用財金外幣資料寫入
        --集保外幣
        IF LTRIM(CUR.TDCC_CURRENCY_NO_FCY) IS NOT NULL THEN  

          --AMC_NO = '04' 基金經理公司04.瑞萬通博(TDCC)
          PIPE ROW(TYPE_BANKLIST_ROW('D',
                                     '4',
                                     CUR.ID,
                                     CUR.TDCC_BANK_NO_TWD_FCY,
                                     CUR.TDCC_BRANCH_NO_TWD_FCY,
                                     CUR.TDCC_AC_CODE_TWD_FCY,
                                     CUR.TDCC_CURRENCY_NO_FCY,
                                     '04'
                                    )
          ); 

        ELSE

          IF LTRIM(CUR.FIS_CURRENCY_NO_FCY) IS NOT NULL THEN 

             --AMC_NO = '04' 基金經理公司04.瑞萬通博(TDCC)
             PIPE ROW(TYPE_BANKLIST_ROW('D',
                                        '4',
                                        CUR.ID,
                                        CUR.FIS_BANK_NO_TWD_FCY,
                                        CUR.FIS_BRANCH_NO_TWD_FCY,
                                        CUR.FIS_AC_CODE_TWD_FCY,
                                        CUR.FIS_CURRENCY_NO_FCY,
                                        '04'
                                       )
             ); 

          END IF;

        END IF;

      END IF;    

    END LOOP;

    RETURN;

END F_ECSB007_GetBankD;

/

  GRANT EXECUTE ON "ECS"."F_ECSB007_GETBANKD" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_ECSB007_GETBANKR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_ECSB007_GETBANKR" 
-- =============================================
-- Author:      Chengyu
-- Create date: 2021/08/03
-- Description: 傳出新增至FAS.HOLDER_BANK資料(贖回帳號)
-- 2021.08.10 Chengyu 1.財金與集保，若"台幣資料"或"外幣資料相同" 則只新增集保資料
--                    2.若無集保外幣資料，則用財金外幣資料寫入
-- 2021.12.23 Chengyu 修正"若無集保外幣資料，則用財金外幣資料寫入"邏輯錯誤
-- =============================================
(
    WID    IN VARCHAR2            --客戶ID
)
RETURN TYPE_BANKLIST_TABLE pipelined AS
    FIS_TWD_CNT INT;
    IS_MMA VARCHAR2(1):='N';
BEGIN

    FOR CUR IN (SELECT * FROM ECS.HOLDER WHERE ID = WID)
    LOOP

       --確認財金台幣銀行是否有檢查MMA
       SELECT COUNT(1) 
          INTO FIS_TWD_CNT
          FROM FAS.FIS_BANK 
         WHERE MMA_CHECKED = 'Y' 
           AND BANK_NO = CUR.FIS_BANK_NO_TWD;      

      --檢查是否為新增MMA資料(財金與集保台外幣資料皆相同才是MMA資料)
      --瀚亞特殊規則：開戶時若無寫入集保外幣資料 且 其他資料符合MMA條件，買回帳號與分配帳號同MMA資料，扣款帳號只核印集保台幣
      SELECT CASE WHEN COUNT(1) = 1 THEN 'Y' ELSE 'N'END
        INTO IS_MMA
        FROM ( SELECT  CUR.FIS_BANK_NO_TWD 
                      ,CUR.FIS_BRANCH_NO_TWD 
                      ,CUR.FIS_AC_CODE_TWD 
                 FROM DUAL
                UNION 
               SELECT  CUR.FIS_BANK_NO_TWD_FCY
                      ,CUR.FIS_BRANCH_NO_TWD_FCY
                      ,CUR.FIS_AC_CODE_TWD_FCY
                 FROM DUAL
                UNION 
               SELECT  CUR.TDCC_BANK_NO
                      ,CUR.TDCC_BRANCH_NO
                      ,CUR.TDCC_AC_CODE
                 FROM DUAL
                UNION 
               SELECT  CUR.TDCC_BANK_NO_TWD_FCY
                      ,CUR.TDCC_BRANCH_NO_TWD_FCY
                      ,CUR.TDCC_AC_CODE_TWD_FCY
                 FROM DUAL
             ) DATA
       WHERE LTRIM(CUR.FIS_CURRENCY_NO_TWD) IS NOT NULL
         AND LTRIM(CUR.FIS_BANK_NO_TWD_FCY) IS NOT NULL
         AND LTRIM(CUR.TDCC_CURRENCY_NO) IS NOT NULL
         AND FIS_TWD_CNT > 0;

      --若IS_MMA為Y，則新增一筆MMA資料至買回帳號
      IF IS_MMA = 'Y' THEN

         PIPE ROW(TYPE_BANKLIST_ROW('R',
                                    '3',
                                    CUR.ID,
                                    CUR.TDCC_BANK_NO,
                                    CUR.TDCC_BRANCH_NO,
                                    CUR.TDCC_AC_CODE,
                                    'MMA',
                                    ''
                                   )
         ); 

      ELSE

        --財金台幣
        IF LTRIM(CUR.FIS_CURRENCY_NO_TWD) IS NOT NULL THEN  

           -- 2021.08.10 Chengyu 1.財金與集保，若"台幣資料"或"外幣資料相同" 則只新增集保資料
           --若 財金台幣資料 與 集保台幣資料 相同則只新增 集保台幣資料
           IF (   NVL(LTRIM(CUR.FIS_BANK_NO_TWD),' ') <> NVL(LTRIM(CUR.TDCC_BANK_NO),' ')
               OR NVL(LTRIM(CUR.FIS_BRANCH_NO_TWD),' ') <> NVL(LTRIM(CUR.TDCC_BRANCH_NO),' ')
               OR NVL(LTRIM(CUR.FIS_AC_CODE_TWD),' ') <> NVL(LTRIM(CUR.TDCC_AC_CODE),' ')
              ) THEN

              PIPE ROW(TYPE_BANKLIST_ROW('R',
                                         '1',
                                         CUR.ID,
                                         CUR.FIS_BANK_NO_TWD,
                                         CUR.FIS_BRANCH_NO_TWD,
                                         CUR.FIS_AC_CODE_TWD,
                                         CUR.FIS_CURRENCY_NO_TWD,
                                         ''
                                        )
              ); 

           END IF;

        END IF;

        --財金外幣
        IF LTRIM(CUR.FIS_BANK_NO_TWD_FCY) IS NOT NULL THEN  

           -- 2021.08.10 Chengyu 1.財金與集保，若"台幣資料"或"外幣資料相同" 則只新增集保資料
           --若 財金外幣資料 與 集保外幣 資料 相同則只新增集保外幣資料
           IF (   NVL(LTRIM(CUR.FIS_BANK_NO_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_BANK_NO_TWD_FCY),' ')
               OR NVL(LTRIM(CUR.FIS_BRANCH_NO_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_BRANCH_NO_TWD_FCY),' ')
               OR NVL(LTRIM(CUR.FIS_AC_CODE_TWD_FCY),' ') <> NVL(LTRIM(CUR.TDCC_AC_CODE_TWD_FCY),' ')
              ) THEN

                   PIPE ROW(TYPE_BANKLIST_ROW('R',
                                              '2',
                                              CUR.ID,
                                              CUR.FIS_BANK_NO_TWD_FCY,
                                              CUR.FIS_BRANCH_NO_TWD_FCY,
                                              CUR.FIS_AC_CODE_TWD_FCY,
                                              CUR.FIS_CURRENCY_NO_FCY,
                                              ''
                                             )
                   );            

           END IF;

        END IF;

        --集保台幣
        IF LTRIM(CUR.TDCC_CURRENCY_NO) IS NOT NULL THEN  

           PIPE ROW(TYPE_BANKLIST_ROW('R',
                                      '3',
                                      CUR.ID,
                                      CUR.TDCC_BANK_NO,
                                      CUR.TDCC_BRANCH_NO,
                                      CUR.TDCC_AC_CODE,
                                      LTRIM(CUR.TDCC_CURRENCY_NO),
                                      ''
                                     )
           ); 

        END IF;

        --集保外幣
        IF LTRIM(CUR.TDCC_CURRENCY_NO_FCY) IS NOT NULL THEN  

           PIPE ROW(TYPE_BANKLIST_ROW('R',
                                      '4',
                                      CUR.ID,
                                      CUR.TDCC_BANK_NO_TWD_FCY,
                                      CUR.TDCC_BRANCH_NO_TWD_FCY,
                                      CUR.TDCC_AC_CODE_TWD_FCY,
                                      LTRIM(CUR.TDCC_CURRENCY_NO_FCY),
                                      ''
                                     )
           );    
        ELSE

           -- 2021.08.10 Chengyu 2.若無集保外幣資料，則用財金外幣資料寫入
           -- 2021.12.23 Chengyu 修正"若無集保外幣資料，則用財金外幣資料寫入"邏輯錯誤
           IF LTRIM(CUR.FIS_BANK_NO_TWD_FCY) IS NOT NULL THEN

              PIPE ROW(TYPE_BANKLIST_ROW('R',
                                         '4',
                                         CUR.ID,
                                         CUR.FIS_BANK_NO_TWD_FCY,
                                         CUR.FIS_BRANCH_NO_TWD_FCY,
                                         CUR.FIS_AC_CODE_TWD_FCY,
                                         CUR.FIS_CURRENCY_NO_FCY,
                                         ''
                                        )
              );
           END IF;        

        END IF;

      END IF;

    END LOOP;

    RETURN;

END F_ECSB007_GetBankR;

/

  GRANT EXECUTE ON "ECS"."F_ECSB007_GETBANKR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_FORMATSTRINGLISTTOTABLE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_FORMATSTRINGLISTTOTABLE" 
-- =============================================
-- Author:      Jason
-- Create date: 2018/07/17
-- Description: 將字串拆分成表格
-- 2019.03.15 tingting 修正資料筆數上限只能30筆問題
-- 2019.04.01 tingting 1.調整傳入字串若為空字串，不要回傳資料列
--                     2.調整若傳入字串的最後一碼，為不同組資料的區別碼，則去掉
-- =============================================
--select * from table(ECS.F_FormatStringListToTable('A1;A2;A3,B1;B2;B3;B4,C1;C2,'));
--select * from table(ECS.F_FormatStringListToTable('A1;A2;A3;A4;A5;A6;A7;A8;A9;A10;A11;A12;A13;A14;A15;A16;A17;A18;A19;A20;A21;A22;A23;A24;A25;A26;A27;A28;A29;A30;A31;A32,B1;B2;B3;B4,C1;C2,D1'));
(
    W_StringList    IN VARCHAR2,            --字串(最多4000個字元)
    W_RecordSym     IN VARCHAR2 := ',',     --不同組資料的區別碼
    W_delimiter     IN VARCHAR2 := ';'      --同一組資料不同欄位的區別碼
)
RETURN TYPE_STRING_LIST_TABLE AS v_ret TYPE_STRING_LIST_TABLE;

    v_DataList      TYPE_STRING_SPLIT_TAB;  --不同組資料的集合
    v_Temp_String   VARCHAR2(4000);         --剩餘資料字串
    v_Item_String   VARCHAR2(4000);         --單組資料字串
    v_Index         INT;                    --不同組資料區別碼的位置

BEGIN

    -- 2019.04.01 tingting 1.調整傳入字串若為空字串，不要回傳資料列
    --                     2.調整若傳入字串的最後一碼，為不同組資料的區別碼，則去掉
    IF W_StringList IS NULL OR W_StringList = '' THEN
        GOTO FINISH;
    END IF;

    --拆分不同組資料
    BEGIN

        v_DataList := TYPE_STRING_SPLIT_TAB();

        -- 2019.04.01 tingting 1.調整傳入字串若為空字串，不要回傳資料列
        --                     2.調整若傳入字串的最後一碼，為不同組資料的區別碼，則去掉
        IF SUBSTR(W_StringList, LENGTH(W_StringList), 1) = W_RecordSym THEN
            v_Temp_String := SUBSTR(W_StringList, 0, LENGTH(W_StringList)-1);
        ELSE
            v_Temp_String := W_StringList;
        END IF;

        v_Index := INSTR(v_Temp_String, W_RecordSym);

        WHILE NOT(v_Index = 0)
        LOOP
            v_Item_String := SUBSTR(v_Temp_String, 1, v_Index - 1);

            v_DataList.EXTEND;
            v_DataList(v_DataList.LAST) := v_Item_String;

            v_Temp_String := SUBSTR(v_Temp_String, v_Index + 1, LENGTH(v_Temp_String) - v_Index);
            v_Index := INSTR(v_Temp_String, W_RecordSym);
        END LOOP;

        v_DataList.EXTEND;
        v_DataList(v_DataList.LAST) := v_Temp_String;

    END;

    --拆分同一組資料的各個欄位
    BEGIN

        v_ret := TYPE_STRING_LIST_TABLE();

        FOR rec IN 
        (
            SELECT  SUBSTR(VarcharData, 0, CASE WHEN Index01 > 0 THEN Index01 - 1 ELSE LENGTH(VarcharData) END) AS VALUE1
                   ,CASE WHEN Index01 = 0 THEN '' ELSE SUBSTR(VarcharData, Index01 + 1, CASE WHEN Index02 > 0 THEN Index02 - 1 - Index01 ELSE LENGTH(VarcharData) END) END AS VALUE2
                   ,CASE WHEN Index02 = 0 THEN '' ELSE SUBSTR(VarcharData, Index02 + 1, CASE WHEN Index03 > 0 THEN Index03 - 1 - Index02 ELSE LENGTH(VarcharData) END) END AS VALUE3
                   ,CASE WHEN Index03 = 0 THEN '' ELSE SUBSTR(VarcharData, Index03 + 1, CASE WHEN Index04 > 0 THEN Index04 - 1 - Index03 ELSE LENGTH(VarcharData) END) END AS VALUE4
                   ,CASE WHEN Index04 = 0 THEN '' ELSE SUBSTR(VarcharData, Index04 + 1, CASE WHEN Index05 > 0 THEN Index05 - 1 - Index04 ELSE LENGTH(VarcharData) END) END AS VALUE5
                   ,CASE WHEN Index05 = 0 THEN '' ELSE SUBSTR(VarcharData, Index05 + 1, CASE WHEN Index06 > 0 THEN Index06 - 1 - Index05 ELSE LENGTH(VarcharData) END) END AS VALUE6
                   ,CASE WHEN Index06 = 0 THEN '' ELSE SUBSTR(VarcharData, Index06 + 1, CASE WHEN Index07 > 0 THEN Index07 - 1 - Index06 ELSE LENGTH(VarcharData) END) END AS VALUE7
                   ,CASE WHEN Index07 = 0 THEN '' ELSE SUBSTR(VarcharData, Index07 + 1, CASE WHEN Index08 > 0 THEN Index08 - 1 - Index07 ELSE LENGTH(VarcharData) END) END AS VALUE8
                   ,CASE WHEN Index08 = 0 THEN '' ELSE SUBSTR(VarcharData, Index08 + 1, CASE WHEN Index09 > 0 THEN Index09 - 1 - Index08 ELSE LENGTH(VarcharData) END) END AS VALUE9
                   ,CASE WHEN Index09 = 0 THEN '' ELSE SUBSTR(VarcharData, Index09 + 1, CASE WHEN Index10 > 0 THEN Index10 - 1 - Index09 ELSE LENGTH(VarcharData) END) END AS VALUE10
                   ,CASE WHEN Index10 = 0 THEN '' ELSE SUBSTR(VarcharData, Index10 + 1, CASE WHEN Index11 > 0 THEN Index11 - 1 - Index10 ELSE LENGTH(VarcharData) END) END AS VALUE11
                   ,CASE WHEN Index11 = 0 THEN '' ELSE SUBSTR(VarcharData, Index11 + 1, CASE WHEN Index12 > 0 THEN Index12 - 1 - Index11 ELSE LENGTH(VarcharData) END) END AS VALUE12
                   ,CASE WHEN Index12 = 0 THEN '' ELSE SUBSTR(VarcharData, Index12 + 1, CASE WHEN Index13 > 0 THEN Index13 - 1 - Index12 ELSE LENGTH(VarcharData) END) END AS VALUE13
                   ,CASE WHEN Index13 = 0 THEN '' ELSE SUBSTR(VarcharData, Index13 + 1, CASE WHEN Index14 > 0 THEN Index14 - 1 - Index13 ELSE LENGTH(VarcharData) END) END AS VALUE14
                   ,CASE WHEN Index14 = 0 THEN '' ELSE SUBSTR(VarcharData, Index14 + 1, CASE WHEN Index15 > 0 THEN Index15 - 1 - Index14 ELSE LENGTH(VarcharData) END) END AS VALUE15
                   ,CASE WHEN Index15 = 0 THEN '' ELSE SUBSTR(VarcharData, Index15 + 1, CASE WHEN Index16 > 0 THEN Index16 - 1 - Index15 ELSE LENGTH(VarcharData) END) END AS VALUE16
                   ,CASE WHEN Index16 = 0 THEN '' ELSE SUBSTR(VarcharData, Index16 + 1, CASE WHEN Index17 > 0 THEN Index17 - 1 - Index16 ELSE LENGTH(VarcharData) END) END AS VALUE17
                   ,CASE WHEN Index17 = 0 THEN '' ELSE SUBSTR(VarcharData, Index17 + 1, CASE WHEN Index18 > 0 THEN Index18 - 1 - Index17 ELSE LENGTH(VarcharData) END) END AS VALUE18
                   ,CASE WHEN Index18 = 0 THEN '' ELSE SUBSTR(VarcharData, Index18 + 1, CASE WHEN Index19 > 0 THEN Index19 - 1 - Index18 ELSE LENGTH(VarcharData) END) END AS VALUE19
                   ,CASE WHEN Index19 = 0 THEN '' ELSE SUBSTR(VarcharData, Index19 + 1, CASE WHEN Index20 > 0 THEN Index20 - 1 - Index19 ELSE LENGTH(VarcharData) END) END AS VALUE20
                   ,CASE WHEN Index20 = 0 THEN '' ELSE SUBSTR(VarcharData, Index20 + 1, CASE WHEN Index21 > 0 THEN Index21 - 1 - Index20 ELSE LENGTH(VarcharData) END) END AS VALUE21
                   ,CASE WHEN Index21 = 0 THEN '' ELSE SUBSTR(VarcharData, Index21 + 1, CASE WHEN Index22 > 0 THEN Index22 - 1 - Index21 ELSE LENGTH(VarcharData) END) END AS VALUE22
                   ,CASE WHEN Index22 = 0 THEN '' ELSE SUBSTR(VarcharData, Index22 + 1, CASE WHEN Index23 > 0 THEN Index23 - 1 - Index22 ELSE LENGTH(VarcharData) END) END AS VALUE23
                   ,CASE WHEN Index23 = 0 THEN '' ELSE SUBSTR(VarcharData, Index23 + 1, CASE WHEN Index24 > 0 THEN Index24 - 1 - Index23 ELSE LENGTH(VarcharData) END) END AS VALUE24
                   ,CASE WHEN Index24 = 0 THEN '' ELSE SUBSTR(VarcharData, Index24 + 1, CASE WHEN Index25 > 0 THEN Index25 - 1 - Index24 ELSE LENGTH(VarcharData) END) END AS VALUE25
                   ,CASE WHEN Index25 = 0 THEN '' ELSE SUBSTR(VarcharData, Index25 + 1, CASE WHEN Index26 > 0 THEN Index26 - 1 - Index25 ELSE LENGTH(VarcharData) END) END AS VALUE26
                   ,CASE WHEN Index26 = 0 THEN '' ELSE SUBSTR(VarcharData, Index26 + 1, CASE WHEN Index27 > 0 THEN Index27 - 1 - Index26 ELSE LENGTH(VarcharData) END) END AS VALUE27
                   ,CASE WHEN Index27 = 0 THEN '' ELSE SUBSTR(VarcharData, Index27 + 1, CASE WHEN Index28 > 0 THEN Index28 - 1 - Index27 ELSE LENGTH(VarcharData) END) END AS VALUE28
                   ,CASE WHEN Index28 = 0 THEN '' ELSE SUBSTR(VarcharData, Index28 + 1, CASE WHEN Index29 > 0 THEN Index29 - 1 - Index28 ELSE LENGTH(VarcharData) END) END AS VALUE29
                   ,CASE WHEN Index29 = 0 THEN '' ELSE SUBSTR(VarcharData, Index29 + 1, LENGTH(VarcharData)) END AS VALUE30
              FROM (
                    SELECT  VarcharData
                           ,INSTR(VarcharData, W_delimiter, 1, 1) AS Index01
                           ,INSTR(VarcharData, W_delimiter, 1, 2) AS Index02
                           ,INSTR(VarcharData, W_delimiter, 1, 3) AS Index03
                           ,INSTR(VarcharData, W_delimiter, 1, 4) AS Index04
                           ,INSTR(VarcharData, W_delimiter, 1, 5) AS Index05
                           ,INSTR(VarcharData, W_delimiter, 1, 6) AS Index06
                           ,INSTR(VarcharData, W_delimiter, 1, 7) AS Index07
                           ,INSTR(VarcharData, W_delimiter, 1, 8) AS Index08
                           ,INSTR(VarcharData, W_delimiter, 1, 9) AS Index09
                           ,INSTR(VarcharData, W_delimiter, 1, 10) AS Index10
                           ,INSTR(VarcharData, W_delimiter, 1, 11) AS Index11
                           ,INSTR(VarcharData, W_delimiter, 1, 12) AS Index12
                           ,INSTR(VarcharData, W_delimiter, 1, 13) AS Index13
                           ,INSTR(VarcharData, W_delimiter, 1, 14) AS Index14
                           ,INSTR(VarcharData, W_delimiter, 1, 15) AS Index15
                           ,INSTR(VarcharData, W_delimiter, 1, 16) AS Index16
                           ,INSTR(VarcharData, W_delimiter, 1, 17) AS Index17
                           ,INSTR(VarcharData, W_delimiter, 1, 18) AS Index18
                           ,INSTR(VarcharData, W_delimiter, 1, 19) AS Index19
                           ,INSTR(VarcharData, W_delimiter, 1, 20) AS Index20
                           ,INSTR(VarcharData, W_delimiter, 1, 21) AS Index21
                           ,INSTR(VarcharData, W_delimiter, 1, 22) AS Index22
                           ,INSTR(VarcharData, W_delimiter, 1, 23) AS Index23
                           ,INSTR(VarcharData, W_delimiter, 1, 24) AS Index24
                           ,INSTR(VarcharData, W_delimiter, 1, 25) AS Index25
                           ,INSTR(VarcharData, W_delimiter, 1, 26) AS Index26
                           ,INSTR(VarcharData, W_delimiter, 1, 27) AS Index27
                           ,INSTR(VarcharData, W_delimiter, 1, 28) AS Index28
                           ,INSTR(VarcharData, W_delimiter, 1, 29) AS Index29
                           ,LENGTH(VarcharData) AS VarcharLength
                      FROM (SELECT COLUMN_VALUE AS VarcharData FROM TABLE(v_DataList))
                   )
        )
        LOOP
            v_ret.EXTEND;
            v_ret(v_ret.COUNT) := TYPE_STRING_LIST_ROW
            (
                 rec.VALUE1
                ,rec.VALUE2
                ,rec.VALUE3
                ,rec.VALUE4
                ,rec.VALUE5
                ,rec.VALUE6
                ,rec.VALUE7
                ,rec.VALUE8
                ,rec.VALUE9
                ,rec.VALUE10
                ,rec.VALUE11
                ,rec.VALUE12
                ,rec.VALUE13
                ,rec.VALUE14
                ,rec.VALUE15
                ,rec.VALUE16
                ,rec.VALUE17
                ,rec.VALUE18
                ,rec.VALUE19
                ,rec.VALUE20
                ,rec.VALUE21
                ,rec.VALUE22
                ,rec.VALUE23
                ,rec.VALUE24
                ,rec.VALUE25
                ,rec.VALUE26
                ,rec.VALUE27
                ,rec.VALUE28
                ,rec.VALUE29
                ,rec.VALUE30
            );
        END LOOP;

    END;

    <<FINISH>>

    RETURN v_ret;

END F_FormatStringListToTable;

/

  GRANT EXECUTE ON "ECS"."F_FORMATSTRINGLISTTOTABLE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_FORMATSTRINGTOTABLE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_FORMATSTRINGTOTABLE" 
(
    wIN_String IN VARCHAR2
)
RETURN TYPE_STRING_TABLE
PIPELINED
AS
    xIN_STRING_TEMP     VARCHAR2(32767);
    xIN_STRING_ITEM_STR VARCHAR2(32767);	
    xPOSITION           INT;
BEGIN  
    xIN_STRING_TEMP := wIN_String;
    xPOSITION := INSTR(xIN_STRING_TEMP, ',');

    WHILE NOT(xPOSITION = 0)
    LOOP
        xIN_STRING_ITEM_STR := SUBSTR(xIN_STRING_TEMP, 1, xPOSITION - 1);
        xIN_STRING_TEMP := SUBSTR(xIN_STRING_TEMP, xPOSITION + 1, LENGTH(xIN_STRING_TEMP) - xPOSITION);
        PIPE ROW(TYPE_STRING_ROW(xIN_STRING_ITEM_STR));
        xPOSITION := INSTR(xIN_STRING_TEMP, ',');
    END LOOP;

    PIPE ROW(TYPE_STRING_ROW(xIN_STRING_TEMP));

    RETURN;
END F_FORMATSTRINGTOTABLE;

/

  GRANT EXECUTE ON "ECS"."F_FORMATSTRINGTOTABLE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETANYCALENDARDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETANYCALENDARDATE" --取得任一行事曆的日期之入口點
-- =============================================
-- Author:      STU
-- Create date: 
-- Description: 行事曆處理
-- 2019.07.18 JIANXIN MOD 新增申購交易種類，僅申購與RSP使用
-- 2019.07.18 JIANXIN MOD 調整參數順序、調整傳入參數有誤問題
-- =============================================
(
  WFUND_NO        IN varchar2, --基金代碼
  --WCALENDAR_TYPE  IN varchar2, --行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
  WDATE_TYPE      IN varchar2, --日期類別(TA:申購日期, TR:贖回/轉出日期,NA:申購淨值日期,NR:贖回/轉出淨值日期 PY:付款日期)
  WTRADE_DATE     IN date,     --交易日期
  WALLOT_TYPE     IN VARCHAR2  --申購交易種類(1.申購;2.EC RSP)
)
return date  --回傳日期
IS
  XDATE DATE;         --日期
  XMSGID VARCHAR2(6); --訊息流水號 

BEGIN
  IF WDATE_TYPE = 'TA' THEN --取得申購日期
    -- 2019.07.18 JIANXIN MOD 新增申購交易種類，僅申購與RSP使用
    XMSGID := ECS.F_GetTradeDate_Allot(WFUND_NO,WTRADE_DATE,WALLOT_TYPE,XDATE);
  ELSE
  IF WDATE_TYPE = 'TR' THEN --取得贖回日期
    XMSGID := ECS.F_GetTradeDate_Redem(WFUND_NO,WTRADE_DATE,XDATE);
  ELSE
  IF WDATE_TYPE = 'NA' THEN --取得申購淨值日期
    -- 2019.07.18 JIANXIN MOD 新增申購交易種類，僅申購與RSP使用
    -- 2019.07.18 JIANXIN MOD 調整傳入參數有誤問題
    XDATE := ECS.F_GetNavDate_Allot(WFUND_NO,WTRADE_DATE);
  ELSE
  IF WDATE_TYPE = 'NR' THEN --取得贖回/轉出淨值日期
    XDATE := ECS.F_GetNavDate_Redem(WFUND_NO,WTRADE_DATE);
  ELSE
  IF WDATE_TYPE = 'PY' THEN --取得買回付款日期
    XDATE := ECS.F_GetPayDate(WFUND_NO,WTRADE_DATE);
  ELSE
    XDATE := TO_DATE('2000/01/01','YYYY/MM/DD');
  END IF;   
  END IF;
  END IF;
  END IF;
  END IF;

  return XDATE;

END F_GetAnyCalendarDate;

/

  GRANT EXECUTE ON "ECS"."F_GETANYCALENDARDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETBEFAFTDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETBEFAFTDATE" 
-- =============================================
-- Author     : STU
-- Create date: 
-- Description: 取得指定日期之前後幾天的日期(指營業日)
-- 2018.12.04 JIANXIN MOD BY 若傳入天數  = 0 會回傳 2000/01/01，應該要回傳當天的日期
-- 2019.08.29 tingting 行事曆種類增加4.台灣銀行公會行事曆
-- =============================================
(
  WFUND_NO        IN varchar2, --基金代碼
  WCALENDAR_TYPE  IN varchar2, --行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆、4.台灣銀行公會行事曆)
  WDATE           IN date,     --日期(必須為營業日)
  WDAYS           IN NUMBER    --天數(負數:往前推, 正數:往後推)
)
return date  --回傳日期
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆

  XBEF_DAYS NUMBER(3);
  XAFT_DAYS NUMBER(3);
  XDATE DATE;               --傳回的日期

BEGIN
  --設定初始值
  IF WDAYS >=0 THEN 
    XBEF_DAYS := 30;
    XAFT_DAYS := 365;
  ELSE
    XBEF_DAYS := 365;
    XAFT_DAYS := 30;
  END IF;

  XDATE := WDATE;

  -- 2019.08.29 tingting 行事曆種類增加4.台灣銀行公會行事曆
  IF WCALENDAR_TYPE IN ('1','2','3') THEN
    --1.取得傳入日期前後數天的基金淨值行事曆
    SELECT CAST(MULTISET(
                          SELECT *
                            FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,WCALENDAR_TYPE,WDATE-XBEF_DAYS,WDATE+XAFT_DAYS) as CalendarTypes))
                         ) AS ECS.CalendarTypes) INTO FundCalendar
      FROM DUAL;
  ELSE
   SELECT CAST(MULTISET(
                         SELECT A.CALENDAR_DATE, --日期
                                A.YEAR_DAY,      --當年度的第幾天
                                A.QUARTER_ID,    --當年度的第幾季
                                A.WEEK_ID,       --第幾週
                                A.WEEK_DAY,      --星期幾(0表示星期日)
                                CASE WHEN B.CALENDAR_CODE IS NULL THEN 'W' ELSE 'H' END BUSS_ID, --是否為營業日(W:營業日, H:假日)
                                B.NAME REMARK    --備註
                           FROM Table( cast(ECS.F_SWS_GETDATELIST(WDATE-XBEF_DAYS,WDATE+XAFT_DAYS) as ECS.CalendarTypes)) A
                           LEFT JOIN FAS.CALENDAR B 
                             ON B.CALENDAR_CODE = 'B'   --台灣銀行公會營業日
                            AND B.HOLIDAY = A.CALENDAR_DATE
                          ORDER BY A.CALENDAR_DATE
                      ) AS ECS.CalendarTypes) INTO FundCalendar
      FROM DUAL;
  END IF;

  --2.以傳入的『日期』加上『天數』推算幾天後的日期
  BEGIN
    IF WDAYS >= 0 THEN --往後推算
      SELECT CALENDAR_DATE INTO XDATE
        FROM (
              -- 2018.12.04 JIANXIN MOD BY 若傳入天數  = 0 會回傳 2000/01/01，應該要回傳當天的日期
              SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE)  - 1 SRNO 
                FROM Table(FundCalendar)
               WHERE CALENDAR_DATE >= WDATE
                 AND BUSS_ID = 'W'
              ) Z
       WHERE SRNO = WDAYS;
    ELSE --往前推算
       SELECT CALENDAR_DATE INTO XDATE
        FROM (
              SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE DESC) SRNO 
                FROM Table(FundCalendar)
               WHERE CALENDAR_DATE < WDATE
                 AND BUSS_ID = 'W'
              ) Z
       WHERE SRNO = ABS(WDAYS);     

    END IF; 
  EXCEPTION
    WHEN no_data_found THEN
       XDATE := TO_DATE('2000/01/01','YYYY/MM/DD');
  END; 

  return XDATE;

END F_GetBefAftDate;

/

  GRANT EXECUTE ON "ECS"."F_GETBEFAFTDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETBEFAFTDATE_1
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETBEFAFTDATE_1" 
-- =============================================
-- Author     : STU
-- Create date: 
-- Description: 取得指定日期之前後幾天的日期(指營業日)
-- 2018.12.04 JIANXIN MOD BY 若傳入天數  = 0 會回傳 2000/01/01，應該要回傳當天的日期
-- 2019.08.29 tingting 行事曆種類增加4.台灣銀行公會行事曆
-- 2019.11.26 ChengYu 調整預計轉申購日推算方法
-- =============================================
(
  WFUND_NO        IN varchar2, --基金代碼(轉申購時顯示： 'D26;S14')
  WCALENDAR_TYPE  IN varchar2, --行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆、4.台灣銀行公會行事曆、5.推算轉申購日)
  WDATE           IN date,     --日期(必須為營業日)
  WDAYS           IN NUMBER    --天數(負數:往前推, 正數:往後推)
)
return date  --回傳日期
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆
  -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
  FundCalendar_IN ECS.CalendarTypes; --轉入基金行事曆
  XBEF_DAYS NUMBER(3);
  XAFT_DAYS NUMBER(3);
  XDATE DATE;               --傳回的日期
  -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
  XFUND_CATEGORY VARCHAR2(1);     --轉出基金境內外
  XFUND_CATEGORY_IN VARCHAR2(1);  --轉入基金境內外
  HaveHoliday VARCHAR2(1);        --確認是否含有特殊假日(推算轉申購日期使用)
  MAX_DATE DATE;   --最大假日日期(推算轉申購日期使用)
  DATA_COUNT INT;  --資料筆數

BEGIN
  --設定初始值
  IF WDAYS >=0 THEN 
    XBEF_DAYS := 30;
    XAFT_DAYS := 365;
  ELSE
    XBEF_DAYS := 365;
    XAFT_DAYS := 30;
  END IF;
  HaveHoliday := '1';
  XDATE := WDATE;

  -- 2019.08.29 tingting 行事曆種類增加4.台灣銀行公會行事曆
  IF WCALENDAR_TYPE IN ('1','2','3') THEN
    --1.取得傳入日期前後數天的基金淨值行事曆
    SELECT CAST(MULTISET(
                          SELECT *
                            FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,WCALENDAR_TYPE,WDATE-XBEF_DAYS,WDATE+XAFT_DAYS) as CalendarTypes))
                         ) AS ECS.CalendarTypes) INTO FundCalendar
      FROM DUAL;
  ELSIF WCALENDAR_TYPE = '4' THEN
   SELECT CAST(MULTISET(
                         SELECT A.CALENDAR_DATE, --日期
                                A.YEAR_DAY,      --當年度的第幾天
                                A.QUARTER_ID,    --當年度的第幾季
                                A.WEEK_ID,       --第幾週
                                A.WEEK_DAY,      --星期幾(0表示星期日)
                                CASE WHEN B.CALENDAR_CODE IS NULL THEN 'W' ELSE 'H' END BUSS_ID, --是否為營業日(W:營業日, H:假日)
                                B.NAME REMARK    --備註
                           FROM Table( cast(ECS.F_SWS_GETDATELIST(WDATE-XBEF_DAYS,WDATE+XAFT_DAYS) as ECS.CalendarTypes)) A
                           LEFT JOIN FAS.CALENDAR B 
                             ON B.CALENDAR_CODE = 'B'   --台灣銀行公會營業日
                            AND B.HOLIDAY = A.CALENDAR_DATE
                          ORDER BY A.CALENDAR_DATE
                      ) AS ECS.CalendarTypes) INTO FundCalendar
      FROM DUAL;
  -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
  ELSIF WCALENDAR_TYPE = '5' THEN

    --境內基金抓取交易行事曆;境外基金抓取淨值行事曆
    SELECT  FUND_OUT.FUND_CATEGORY
           ,FUND_IN.FUND_CATEGORY
      INTO  XFUND_CATEGORY
           ,XFUND_CATEGORY_IN
      FROM (TABLE(ECS.F_FormatStringListToTable(WFUND_NO))) TB_TEMP
      JOIN FAS.FUND FUND_OUT
        ON FUND_OUT.FUND_NO = TB_TEMP.VALUE1  --FUND_NO
      JOIN FAS.FUND FUND_IN
        ON FUND_IN.FUND_NO = TB_TEMP.VALUE2;  --FUND_NO_IN

    --取得轉出基金日曆
    SELECT CAST(MULTISET(
                          SELECT *
                            FROM Table( cast(ECS.F_GET_FUNDCALENDAR((SELECT TB_TEMP.VALUE1 AS FUND_NO
                                                                       FROM (TABLE(ECS.F_FormatStringListToTable(WFUND_NO))) TB_TEMP),XFUND_CATEGORY,SYSDATE-15,SYSDATE+90) as ECS.CalendarTypes))A
                        ) AS ECS.CalendarTypes) FUND_OUT
      INTO FundCalendar
      FROM DUAL;
    --取得轉入基金日曆
    SELECT CAST(MULTISET(
                          SELECT *
                            FROM Table( cast(ECS.F_GET_FUNDCALENDAR((SELECT TB_TEMP.VALUE2 AS FUND_NO_IN 
                                                                       FROM (TABLE(ECS.F_FormatStringListToTable(WFUND_NO))) TB_TEMP),XFUND_CATEGORY_IN,SYSDATE-15,SYSDATE+90) as ECS.CalendarTypes))A
                         ) AS ECS.CalendarTypes) FUND_IN
      INTO FundCalendar_IN
      FROM DUAL;

  END IF;

  --2.以傳入的『日期』加上『天數』推算幾天後的日期
  BEGIN
     IF WDAYS >= 0 THEN --往後推算
        IF WCALENDAR_TYPE IN ('1','2','3','4') THEN
          SELECT CALENDAR_DATE INTO XDATE
            FROM (
                  -- 2018.12.04 JIANXIN MOD BY 若傳入天數  = 0 會回傳 2000/01/01，應該要回傳當天的日期
                  SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE)  - 1 SRNO 
                    FROM Table(FundCalendar)
                   WHERE CALENDAR_DATE >= WDATE
                     AND BUSS_ID = 'W'
                  ) Z
           WHERE SRNO = WDAYS;
        -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
        ELSIF WCALENDAR_TYPE = '5' THEN

          --第一次執行時用交易日前一天去執行，之後都是最大假日日期
          MAX_DATE := WDATE;
          WHILE HaveHoliday = '1' 
            LOOP              
              --使用轉出基金與轉入基金皆為工作日的日曆來推算預計轉申購日期
              SELECT CALENDAR_DATE INTO XDATE
                FROM (SELECT A.CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY A.CALENDAR_DATE) - 1 SRNO 
                        FROM (
                              SELECT  CALENDAR_DATE
                                     ,BUSS_ID
                                FROM Table(FundCalendar) 
                               WHERE BUSS_ID = 'W'
                              UNION 
                              SELECT  CALENDAR_DATE
                                     ,BUSS_ID
                                FROM Table(FundCalendar_IN) 
                               WHERE BUSS_ID = 'W'
                             ) A
                       WHERE TRUNC(A.CALENDAR_DATE) > MAX_DATE                         
                      ) Z
               WHERE SRNO = WDAYS;  

               SELECT  COUNT(1)
                 INTO  DATA_COUNT 
                 FROM (
                       SELECT * 
                         FROM Table(FundCalendar)
                       UNION 
                       SELECT * 
                         FROM Table(FundCalendar_IN)
                      ) A
                WHERE TRUNC(A.CALENDAR_DATE) > MAX_DATE 
                  AND TRUNC(A.CALENDAR_DATE) <= XDATE
                  AND A.BUSS_ID = 'H' 
                  AND NVL(A.REMARK,' ') NOT IN ('星期六','星期日');

               --取轉出基金日曆 與 轉入基金日曆 檢查交易日 到 預計轉申購日期 最大的特殊假日日期。有則重新推算;無則回傳預計轉申購日
               SELECT  NVL(MAX(A.CALENDAR_DATE),TO_DATE('19000101','YYYYMMDD'))
                      ,CASE WHEN NVL(MAX(A.CALENDAR_DATE),TO_DATE('19000101','YYYYMMDD')) = TO_DATE('19000101','YYYYMMDD') THEN '0' ELSE '1' END
                 INTO  MAX_DATE 
                      ,HaveHoliday
                 FROM (
                       SELECT * 
                         FROM Table(FundCalendar)
                       UNION 
                       SELECT * 
                         FROM Table(FundCalendar_IN)
                      ) A
                WHERE TRUNC(A.CALENDAR_DATE) > MAX_DATE 
                  AND TRUNC(A.CALENDAR_DATE) <= XDATE
                  AND A.BUSS_ID = 'H' 
                  AND NVL(A.REMARK,' ') NOT IN ('星期六','星期日');

            END LOOP;            
        END IF;   
     ELSE --往前推算
         SELECT CALENDAR_DATE INTO XDATE
          FROM (
                SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE DESC) SRNO 
                  FROM Table(FundCalendar)
                 WHERE CALENDAR_DATE < WDATE
                   AND BUSS_ID = 'W'
                ) Z
         WHERE SRNO = ABS(WDAYS);     

     END IF; 
  EXCEPTION
    WHEN no_data_found THEN
       XDATE := TO_DATE('2000/01/01','YYYY/MM/DD');
  END; 

  return XDATE;

END F_GetBefAftDate_1;

/
--------------------------------------------------------
--  DDL for Function F_GETDDCTRESULTMSG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETDDCTRESULTMSG" 
-- =============================================
-- Author: stu
-- Create date: 
-- Description:	
-- 2019.08.15 tingting 調整為ORACLE版本
-- =============================================
(
  WBANK_HQ     IN VARCHAR2,
  WSEAL_TYPE   IN VARCHAR2,
  WR_CODE      IN VARCHAR2
)
RETURN VARCHAR2
IS
  XDESCRP VARCHAR2(100);
BEGIN

  SELECT COD006.CODE_DESCRP 
    INTO XDESCRP
    FROM ECS.OFD713
    LEFT JOIN ECS.COD006
      ON COD006.CODE = OFD713.SUB_SUS_CODE
     AND COD006.CODE_SORT = '17'
   WHERE OFD713.BANK_HQ = WBANK_HQ
     AND OFD713.SEAL_TYPE = WSEAL_TYPE
     AND OFD713.BANK_MEDIA_CODE = WR_CODE;

  RETURN XDESCRP;

END;

/

  GRANT EXECUTE ON "ECS"."F_GETDDCTRESULTMSG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETFUNCTIONLIST
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETFUNCTIONLIST" 
RETURN TYPE_GETFUNCTIONLIST_TABLE AS

result_Table TYPE_GETFUNCTIONLIST_TABLE;

BEGIN
select
  cast(
  multiset(
    select
      FunctionID
			,NodeID
			, NodeText
			, 1 AS TreeLevel
			, ParentNodeID
			, NodeType
      ,to_char( orders, '0000' ) as Row_Order
			, ProductID      
     FROM aa_treepattern
     WHERE ParentNodeID = ' '

                 )
      as TYPE_GETFUNCTIONLIST_TABLE)
    into
      result_Table
    from
      dual;

  RETURN result_Table;
END F_GETFUNCTIONLIST;

/

  GRANT EXECUTE ON "ECS"."F_GETFUNCTIONLIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETGROUPUSERCNAME
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETGROUPUSERCNAME" 
RETURN TYPE_GETGROUPUSERCNAME_TABLE AS

RESULT_TABLE TYPE_GETGROUPUSERCNAME_TABLE;

BEGIN
    SELECT
    CAST(MULTISET(

        SELECT GROUPID,LISTAGG(USERCNAME,'、')WITHIN GROUP(ORDER BY GROUPID) AS USERCNAME
        FROM(
            SELECT GROUPID,USERCNAME
            FROM AA_USERGROUP A
            LEFT JOIN AA_USER B ON A.USERID = B.USERID
        )
        GROUP BY GROUPID

    )AS TYPE_GETGROUPUSERCNAME_TABLE)
    INTO RESULT_TABLE
    FROM DUAL;

RETURN RESULT_TABLE;
END F_GETGROUPUSERCNAME;

/

  GRANT EXECUTE ON "ECS"."F_GETGROUPUSERCNAME" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETMAINMENU
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETMAINMENU" (UserID IN varchar2,ProductID in varchar2)
    RETURN TYPE_MainMenu_TABLE as

    m_Table TYPE_MainMenu_TABLE;
    m_UserID varchar2(20)  := UserID;
    m_ProductID varchar2(20) := ProductID;
   -- m_NodeID varchar2(20);

BEGIN
--Insert into TYPE_MainMenu_TABLE
SELECT
 cast(
 multiset(
  Select
         to_char(TREE.DATAID) as DATAID
         ,to_char(TREE.NODEID) as NODEID
         ,to_char(TREE.NODETEXT) as NODETEXT
         ,to_char(TREE.PARENTNODEID) as PARENTNODEID
         ,TREE.NODETYPE
         ,to_char(TREE.FUNCTIONID) as FUNCTIONID
         ,TREE.ORDERS
         ,to_char(TREE.STATUS) as STATUS

  FROM AA_TREEPATTERN TREE , SWPRODUCTSDETAIL,SWPRODUCTS
  where
  TREE.FUNCTIONID = SWPRODUCTSDETAIL.FUNCTIONID(+)
  and
  SWPRODUCTSDETAIL.PRODUCTID  = SWPRODUCTS.PRODUCTID (+)
   And
   SWPRODUCTS.IsActive = 1
   and
   swproductsdetail.isactive = 1
   And (SWPRODUCTSDETAIL.PRODUCTID In (u'PTPF',to_char(m_ProductID)) OR  m_ProductID =u' ')
   and
   TREE.FUNCTIONID IN (
    SELECT DISTINCT GROUPRIGHT.FUNCTIONID
    From AA_GROUPRIGHT GROUPRIGHT
    INNER JOIN (
       SELECT DISTINCT UserGroup.GroupID
       FROM AA_USER TMPUser
       INNER JOIN AA_USERGROUP UserGroup
       On TMPUser.UserID = UserGroup.UserID
       INNER JOIN AA_DeptGroup DeptGroup
       On DeptGroup.GroupID = USERGROUP.GROUPID
       Where TMPUser.DeputyID = m_UserID
    ) subGroup
    On GroupRight.GroupID = subGroup.GroupID

  ) )as TYPE_MainMenu_TABLE
  )
  into m_Table
  from Dual;
  return m_Table;

END f_GetMainMenu;
-----------------------

/

  GRANT EXECUTE ON "ECS"."F_GETMAINMENU" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETNAVDATE_ALLOT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETNAVDATE_ALLOT" --取得申購淨值日期
(
  WFUND_NO        IN varchar2, --基金代碼
  WALLOT_DATE     IN date      --申購日期
)
return date  --回傳申購淨值日期
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆

  XALLOT_DATE DATE;         --申購日期
  XALLOT_NAV_DATE DATE;     --申購淨值日期
  XPUR_NAV_DAY NUMBER(1);   --申購淨值日數(T+N)

BEGIN
  --設定初始值
  XALLOT_DATE := WALLOT_DATE;

  --1.準備事項
  --1.1 取得傳入日期前30後365天的基金淨值行事曆
  SELECT CAST(MULTISET(
                        SELECT *
                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'2',WALLOT_DATE-30,WALLOT_DATE+365) as CalendarTypes))
                       ) AS ECS.CalendarTypes) INTO FundCalendar
    FROM DUAL;

  --1.2 取得基金的申購淨值日數
  SELECT PUR_NAV_DAY
    INTO XPUR_NAV_DAY
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO;

  --2.以傳入的申購日期推算申購淨值日期
  --2.1 判斷傳入的申購日期是否為營業日
  --    若不是營業日，則取得該申購日期的次一個營業日，作為該基金的申購日期
  SELECT MIN(CALENDAR_DATE) INTO XALLOT_DATE
    FROM Table(FundCalendar)
   WHERE CALENDAR_DATE >= WALLOT_DATE
     AND BUSS_ID = 'W';

  --2.2 以上點的『申購日期』加上『申購淨值日參數(FUND.PUR_NAV_DAY)』推算申購淨值日期
  BEGIN
    SELECT CALENDAR_DATE INTO XALLOT_NAV_DATE
      FROM (
            SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE) SRNO 
              FROM Table(FundCalendar)
             WHERE CALENDAR_DATE >= WALLOT_DATE
               AND BUSS_ID = 'W'
            ) Z
     WHERE SRNO = XPUR_NAV_DAY+1; 
  EXCEPTION
    WHEN no_data_found THEN
       XALLOT_NAV_DATE := TO_DATE('2000/01/01','YYYY/MM/DD');
  END; 

  return XALLOT_NAV_DATE;

END F_GetNavDate_Allot;

/

  GRANT EXECUTE ON "ECS"."F_GETNAVDATE_ALLOT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETNAVDATE_REDEM
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETNAVDATE_REDEM" 
-- =============================================
-- Author:      
-- Create date: 2018/11/08
-- Description: 取得贖回淨值日期
-- 2018.11.08 PAN MOD 重新調整
-- =============================================
-- SELECT ECS.F_GetNavDate_Redem('D23',TO_DATE('20181107','YYYYMMDD')) FROM DUAL;
(
  WFUND_NO        IN varchar2, --基金代碼
  WREDEM_DATE     IN date      --贖回日期
)
return date  --回傳贖回淨值日期
IS
  FundCalendarA ECS.CalendarTypes; --基金（交易日）行事曆
  FundCalendarB ECS.CalendarTypes; --基金（淨值日）行事曆

  XREDEM_DATE DATE;         --贖回日期
  XREDEM_NAV_DATE DATE;     --贖回淨值日期
  XRED_NAV_DAY NUMBER(1);   --買回淨值日數(T+N)

BEGIN
  --設定初始值
  XREDEM_DATE := WREDEM_DATE;

  --1.準備事項
  --1.1 取得傳入日期前30後365天的基金淨值行事曆
  --1.1.1 基金（交易日）行事曆
  SELECT CAST(MULTISET(
                        SELECT *
                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'1',WREDEM_DATE-30,WREDEM_DATE+365) as CalendarTypes))
                       ) AS ECS.CalendarTypes) INTO FundCalendarA
    FROM DUAL;
  --1.1.2 基金（淨值日）行事曆
  SELECT CAST(MULTISET(
                        SELECT *
                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'2',WREDEM_DATE-15,WREDEM_DATE+90) as CalendarTypes))
                       ) AS ECS.CalendarTypes) INTO FundCalendarB
    FROM DUAL;

  --1.2 取得基金的贖回淨值日數
  SELECT RED_NAV_DAY
    INTO XRED_NAV_DAY
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO;

  --1.3 判斷傳入的贖回日期是否為營業日
  --    若不是營業日，則取得該贖回日期的次一個營業日，作為該基金的贖回日期
  SELECT MIN(CALENDAR_DATE) INTO XREDEM_DATE
    FROM Table(FundCalendarA)
   WHERE CALENDAR_DATE >= WREDEM_DATE
     AND BUSS_ID = 'W';

  --2	淨值日(@NAV_DATE) ：以傳入參數『交易日期(@TX_DATE)』加上『買回淨值日參數(@RED_NAV_DAY)』推算
  --2.1	以傳入參數『交易日期(@TX_DATE)』+1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
  --2.2	需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
  BEGIN
    SELECT CALENDAR_DATE INTO XREDEM_NAV_DATE
      FROM (
            SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE) SRNO 
              FROM Table(FundCalendarB)
             WHERE CALENDAR_DATE >= WREDEM_DATE
               AND BUSS_ID = 'W'
            ) Z
     WHERE SRNO = XRED_NAV_DAY+1; 
  EXCEPTION
    WHEN no_data_found THEN
       XREDEM_NAV_DATE := TO_DATE('2000/01/01','YYYY/MM/DD');
  END; 

  return XREDEM_NAV_DATE;

END F_GetNavDate_Redem;

/

  GRANT EXECUTE ON "ECS"."F_GETNAVDATE_REDEM" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETPAYDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETPAYDATE" 
-- =============================================
-- Author:      
-- Create date: 2018/11/08
-- Description: 取得買回付款日期
-- 2018.11.08 PAN MOD 重新調整
-- ESTWCORE-630 2024.06.14 Richard 整合基金計算規則 , 直接與核心系統計算規則一致
--                         瀚亞投信/瀚亞投資/M&G:fas.f_pay_date | 瑞萬:fas.f_pay_date5 function 即可
-- =============================================
-- SELECT ECS.F_GetPayDate('D23',TO_DATE('20181107','YYYYMMDD')) FROM DUAL;
(
  WFUND_NO        IN varchar2, --基金代碼
  WREDEM_DATE     IN date      --贖回日期
)
return date  --回傳買回付款日期
IS
  /*ESTWCORE-630 2024.06.14 begin modified by Richard*/
--  FundCalendar ECS.CalendarTypes; --基金（交易日）行事曆
--  XREDEM_DATE     DATE;           --贖回日期
  XPAY_DATE       DATE;           --買回付款日期
--  XFUND_CATEGORY  VARCHAR2(1);    --境內外識別碼
  XNAV_CALENDAR   VARCHAR2(5);    --淨值日行事曆類別
--  XPAY_CALENDAR   VARCHAR2(2);    --付款日行事曆類別
--  XTX_CALENDAR    VARCHAR2(5);    --交易日行事曆類別
--  XPAY_DAY        INTEGER;        --買回付款日參數
--  XPRE_TX_DATE    DATE;           --前一個基金交易日
--  XPRE_PAY_DATE   DATE;           --付款前置日
--  XCEHCK_BUS      INTEGER;        --檢查是否為營業日

  XAMC_NO         varchar(2);     --基金公司別 01-瀚亞投信 02-瀚亞投資 03-M&G 04-瑞萬
  /*ESTWCORE-630 2024.06.14 end modified by Richard*/

BEGIN
  --設定初始值
  /*ESTWCORE-630 2024.06.14 begin modified by Richard*/
--  XREDEM_DATE := WREDEM_DATE;

--  --1.準備事項
--  --1.1 取得傳入日期前15後90天的基金淨值行事曆
--  --1.1.1 基金（交易日）行事曆
--  SELECT CAST(MULTISET(
--                        SELECT *
--                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'1',WREDEM_DATE-15,WREDEM_DATE+90) as CalendarTypes))
--                       ) AS ECS.CalendarTypes) INTO FundCalendar
--    FROM DUAL;
  /*ESTWCORE-630 2024.06.14 end modified by Richard*/

  --1.2 取得基金基本資料
  SELECT  FUND.CALENDAR_CODE AS NAV_CALENDAR
         /*ESTWCORE-630 2024.06.14 begin modified by Richard*/
--         ,FUND.TX_CALENDAR_CODE AS TX_CALENDAR
--         ,SUBSTR(FUND.CURRENCY_NO,1,2) AS PAY_CALENDAR
--         ,FUND.PAY_DAY
--         ,FUND.FUND_CATEGORY

         ,FUND.AMC_NO
         /*ESTWCORE-630 2024.06.14 end modified by Richard*/
    INTO  XNAV_CALENDAR
         /*ESTWCORE-630 2024.06.14 begin modified by Richard*/
--         ,XTX_CALENDAR
--         ,XPAY_CALENDAR
--         ,XPAY_DAY
--         ,XFUND_CATEGORY

         ,XAMC_NO
         /*ESTWCORE-630 2024.06.14 end modified by Richard*/
    FROM FAS.FUND FUND
   WHERE FUND.FUND_NO = WFUND_NO;

  /*ESTWCORE-630 2024.06.14 begin modified by Richard*/
--  --1.3 判斷傳入的贖回日期是否為營業日
--  --    若不是營業日，則取得該贖回日期的次一個營業日，作為該基金的贖回日期
--  SELECT MIN(CALENDAR_DATE) INTO XREDEM_DATE
--    FROM Table(FundCalendar)
--   WHERE CALENDAR_DATE >= WREDEM_DATE
--     AND BUSS_ID = 'W';
--  
--  --2.若傳入參數『境內外識別碼(@FUND_CATEGORY)』為”1.境內” 時，以下述規則取得
--  IF XFUND_CATEGORY = '1' THEN --境內基金
--    --2.1  付款日(@PAY_DATE) ：以傳入參數『交易日期(@TX_DATE)』加上『買回付款日參數(@PAY_DAY)』推算
--    --2.1.1  以傳入參數『交易日期(@TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】
--    --       判斷「營業日系統(CALENDAR_CODE)」的『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；
--    --       若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
--    --2.1.2  需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，
--    --       再以推算後的第二個營業日，推算第三個營業日
--     --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
--    XPAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'2',XREDEM_DATE,XPAY_DAY);
--  END IF; --境內基金
--
--  --3.  若『境內外識別碼(@FUND_CATEGORY) 』為” 2.境外”時，以下述規則取得
--  IF XFUND_CATEGORY = '2' THEN --境外基金 
--    --3.1  買回交易前置日(@PRE_TX_DATE)：以傳入參數『交易日期(@TX_DATE)』至【行事曆(FAS.CALENDAR)】
--    --     判斷「營業日系統(CALENDAR_CODE)」的『淨值日行事曆類別(@NAV_CALENDAR)』及『付款日行事曆類別(@PAY_CALENDAR)』，
--    --     需皆無資料(表示該日期在二個行事曆類別中，皆為營業日)；若有抓到資料，再減一個日曆日重新推算，直到該日期皆無資料為止．
--    --取得前一個基金交易日
--    XPRE_TX_DATE := XREDEM_DATE;
--
--    --先判斷前一天是否為營業日
--    SELECT COUNT(DISTINCT HOLIDAY)
--      INTO XCEHCK_BUS
--      FROM FAS.CALENDAR
--     WHERE HOLIDAY = XPRE_TX_DATE
--       AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);
--
--    --如果不是營業日，則繼續往前推
--    WHILE XCEHCK_BUS = 1 LOOP
--      BEGIN
--        XPRE_TX_DATE := XPRE_TX_DATE-1;
--
--        SELECT COUNT(DISTINCT HOLIDAY)
--          INTO XCEHCK_BUS
--          FROM FAS.CALENDAR
--         WHERE HOLIDAY = XPRE_TX_DATE
--           AND CALENDAR_CODE IN (XNAV_CALENDAR,XPAY_CALENDAR);
--      END;
--    END LOOP;
--
--    --3.2  付款前置日(@PRE_PAY_DATE)：以『買回交易前置日(@PRE_TX_DATE)』加上『買回付款日參數(@PAY_DAY)』推算
--    --3.2.1  以『買回交易前置日(@PRE_TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『淨值日行事曆類別(@NAV_CALENDAR)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
--    --3.2.2  需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
--     --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
--    XPRE_PAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'2',XPRE_TX_DATE,XPAY_DAY+1);
--
--    --3.3  付款日(@PAY_DATE) ：以『付款前置日(@PRE_PAY_DATE)』－1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『交易日行事曆類別(@TX_CALENDAR)』，是否有資料；若有抓到資料，則再減一個日曆日重新推算，直到該日期無資料為止
--    XPAY_DATE := ECS.F_GetBefAftDate(WFUND_NO,'1',XPRE_PAY_DATE,-1); 
--  END IF; --境外基金
   if XAMC_NO = '04' then
      XPAY_DATE := FAS.F_PAY_DATE5(WFUND_NO,WREDEM_DATE);
   else
      XPAY_DATE := FAS.F_PAY_DATE(WFUND_NO,WREDEM_DATE);
   end if;
  /*ESTWCORE-630 2024.06.14 end modified by Richard*/
  return XPAY_DATE;

END F_GetPayDate;

/

  GRANT EXECUTE ON "ECS"."F_GETPAYDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETREALSUBDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETREALSUBDATE" --取得實際扣款日期
(
  WFUND_NO          IN varchar2, --基金代碼
  WTX_CALENDAR_CODE IN varchar2, --交易日行事曆類別
  WDEF_SUB_DATE     IN date      --預計扣款日
)
return date  --回傳實際扣款日期
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆
  XREAL_SUB_DATE DATE; --實際扣款日期
  XHOLIDAY DATE;

BEGIN
  BEGIN
    --1.判斷預計扣款日是否為營業日
    SELECT HOLIDAY INTO XHOLIDAY
      FROM FAS.CALENDAR
     WHERE CALENDAR_CODE = WTX_CALENDAR_CODE
       AND HOLIDAY = WDEF_SUB_DATE;

    --2.預計扣款日當天為非營業日 
    --    則依『基金代碼(@FUND_NO)』及『交易日行事曆類別(＠TX_CALENDAR_CODE)』至【行事曆檔(FAS.CALENDAR)】
    --    取得大於『預計扣款日(@DEF_SUB_DATE)』的次一個營業日，作為該基金的『實際扣款日期(@REAL_SUB_DATE)』  
    --2.1 取得傳入預計扣款日前15後90天的基金交易行事曆
    SELECT CAST(MULTISET(
                          SELECT *
                            FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'1',WDEF_SUB_DATE-15,WDEF_SUB_DATE+90) as CalendarTypes))
                         ) AS ECS.CalendarTypes) INTO FundCalendar
      FROM DUAL;

    --2.2 
    BEGIN
      SELECT CALENDAR_DATE INTO XREAL_SUB_DATE
        FROM (
              SELECT CALENDAR_DATE,ROW_NUMBER() OVER (ORDER BY CALENDAR_DATE) SRNO
                FROM Table(FundCalendar)
               WHERE CALENDAR_DATE > WDEF_SUB_DATE
                 AND BUSS_ID = 'W'
              ) Z
       WHERE SRNO = 1;
    EXCEPTION
      WHEN no_data_found THEN
         XREAL_SUB_DATE := TO_DATE('2000/01/01','YYYY/MM/DD');
    END;    

  EXCEPTION
    WHEN no_data_found THEN --預計扣款日當天為營業日
       XREAL_SUB_DATE := WDEF_SUB_DATE;
  END;

  return XREAL_SUB_DATE;

END F_GetRealSubDate;

/

  GRANT EXECUTE ON "ECS"."F_GETREALSUBDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETSEALRESULTMSG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETSEALRESULTMSG" 
-- =============================================
-- Author: stu
-- Create date: 
-- Description:	
-- 2019.09.06 tingting 調整為ORACLE版本
-- =============================================
(
  WBANK_HQ    IN VARCHAR2,
  WSEAL_TYPE  IN VARCHAR2,
  WR_CODE     IN NVARCHAR2
)
RETURN VARCHAR2
IS
  XDESCRP NVARCHAR2(50);
BEGIN

  SELECT OFD711.SEAL_RTN_DESCRP
    INTO XDESCRP 
    FROM ECS.OFD712
    LEFT JOIN ECS.OFD711
      ON OFD712.SUB_SUS_CODE = OFD711.SEAL_RTN_CD
   WHERE OFD712.BANK_HQ = WBANK_HQ
     AND OFD712.SEAL_TYPE = WSEAL_TYPE
     AND OFD712.BANK_MEDIA_CODE = WR_CODE;

  RETURN XDESCRP;

END;

/

  GRANT EXECUTE ON "ECS"."F_GETSEALRESULTMSG" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETSWITCHDATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETSWITCHDATE" 
-- =============================================
-- Author:      PAN
-- Create date: 2018/11/08
-- Description: --取得轉申購日期
-- =============================================
-- SELECT ECS.F_GetSwitchDate(TO_DATE('20181107','YYYYMMDD'),'D11','1',TO_DATE('20181107','YYYYMMDD'),1,'D4') FROM DUAL;
(
  WTX_DATE        DATE        --買回交易日期
 ,WFUND_NO_OUT    VARCHAR2    --買回基金代碼
 ,WFUND_CATEGORY  VARCHAR2    --境內外識別碼(買回基金)
 ,WPAY_DATE       DATE        --預計買回入帳日期(買回基金)
 ,WTX_DAYS        NUMBER      --轉入天數
 ,WFUND_NO_IN     VARCHAR2    --轉換基金代碼
)
return date  --回傳轉申購日期
IS
  FundCalendarA ECS.CalendarTypes; --轉入基金（交易日）行事曆
  FundCalendarB ECS.CalendarTypes; --轉入基金（淨值日）行事曆
  XSWITCH_DATE      DATE;          --轉申購日期
  XTX_CALENDAR_OUT  VARCHAR2(5);   --買回基金交易日行事曆類別
  XNAV_CALENDAR_OUT VARCHAR2(5);   --買回基金淨值日行事曆類別
  XPAY_CALENDAR_OUT VARCHAR2(2);   --買回基金付款日行事曆類別
  XPAY_DAY          NUMBER(1);     --買回付款日參數(T+N)
  XPRE_SWITCH_DATE  DATE;          --轉申購前置日期
  XPAY_DATE_A       DATE;          --預計買回入帳日期A
  XPAY_DATE_B       DATE;          --預計買回入帳日期B
  XPAY_DATE_B1      DATE;          --預計買回入帳日期B1
  XPAY_DATE_B2      DATE;          --預計買回入帳日期B2
  XCNT_1            NUMBER(1);     --轉入天數1
  XCNT_2            NUMBER(1);     --轉入天數2
  XCEHCK_BUS        INTEGER;       --檢查是否為營業日
  XWEEK_DAY         VARCHAR2(1);   --星期幾?(1表示星期日,7表示星期六)
  XCNT_TOT          NUMBER(2);     --轉入總天數
  I                 NUMBER(2);     --迴圈變數

BEGIN
  --設定初始值
  XCNT_1 := 0;
  XCNT_2 := 0;

  --1.準備事項
  --1.1.取得傳入日期前15後90天的基金淨值行事曆
  IF WFUND_CATEGORY = '1' THEN --境內基金
    --1.1.1 轉入基金（交易日）行事曆
    SELECT CAST(MULTISET(SELECT *
                           FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO_IN,'1',WTX_DATE-15,WTX_DATE+90) as CalendarTypes))
                        ) AS ECS.CalendarTypes)
      INTO FundCalendarA
      FROM DUAL;
  END IF;
  IF WFUND_CATEGORY = '2' THEN --境外基金
    --1.1.2 轉入基金（淨值日）行事曆
    SELECT CAST(MULTISET(SELECT *
                           FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO_IN,'2',WTX_DATE-15,WTX_DATE+90) as CalendarTypes))
                        ) AS ECS.CalendarTypes)
      INTO FundCalendarB
      FROM DUAL;
  END IF;

  --1.2以 傳入參數『買回基金代碼』至【基金主檔(FAS.FUND)】取得以下欄位
  SELECT TX_CALENDAR_CODE,CALENDAR_CODE,SUBSTRB(CURRENCY_NO,1,2) PAY_CALENDAR,PAY_DAY
    INTO XTX_CALENDAR_OUT,XNAV_CALENDAR_OUT,XPAY_CALENDAR_OUT,XPAY_DAY
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO_OUT;

  --2.若傳入參數『境內外識別碼(@FUND_CATEGORY)』為”1.境內” 時，以下述規則取得
  IF WFUND_CATEGORY = '1' THEN --境內基金
    --2.1 轉申購前置日期(@PRE_SWITCH_DATE) ：以傳入參數『買回交易日期(@TX_DATE)』加上『轉入天數(@TX_DAYS)』推算
    --2.1.1 以傳入參數『買回交易日期(@TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金交易日行事曆類別(@TX_CALENDAR_OUT)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
	   --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    XPRE_SWITCH_DATE := ECS.F_GetBefAftDate(WFUND_NO_OUT,'1',WTX_DATE,WTX_DAYS);

    --2.2 轉申購日期(@SWITCH_DATE) ：以『轉申購前置日期(@PRE_SWITCH_DATE)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『轉入基金交易日行事曆類別(@TX_CALENDAR_IN)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --2.2.1 判斷傳入的轉申購前置日期是否為營業日
    --      若不是營業日，則取得該轉申購前置日期的次一個營業日，作為該基金的轉申購日期
    SELECT MIN(CALENDAR_DATE) INTO XSWITCH_DATE
      FROM Table(FundCalendarA)
     WHERE CALENDAR_DATE >= XPRE_SWITCH_DATE
       AND BUSS_ID = 'W';
  END IF;

  --3 若傳入參數『境內外識別碼(@FUND_CATEGORY)』為”2.境外”時，以下述規則取得
  IF WFUND_CATEGORY = '2' THEN --境外基金
    --3.1 付款日A(@PAY_DATE_A) ：『預計買回入帳日期(@PAY_DATE)』
    XPAY_DATE_A := WPAY_DATE;
    --3.2 付款日B(@PAY_DATE_B) ：以傳入參數『買回基金代碼(@FUND_ NO)』、『買回交易日期(@TX_DATE)』加上『買回付款日參數(@PAY_DAY)』推算
    --3.2.1 以『買回交易日期(@TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金淨值日行事曆類別(@NAV_CALENDAR_OUT)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --3.2.2 需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
	   --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    XPAY_DATE_B := ECS.F_GetBefAftDate(WFUND_NO_OUT,'2',WTX_DATE,XPAY_DAY);

    --3.3 轉入天數1(@CNT_1)：以下述規則取得
    --3.3.1 若『付款日A(@PAY_DATE_A)』等於『付款日B(@PAY_DATE_B)』，則『轉入天數1(@CNT_1)』等於０
    IF XPAY_DATE_A = XPAY_DATE_B THEN
      XCNT_1 := 0;
    END IF;
    --3.3.2 若『付款日B(@PAY_DATE_B)』小於等於『付款日A(@PAY_DATE_A)』時，計算二個日期相差的天數(不含星期六、星期日)
    --3.3.2.1 付款日B1(@PAY_DATE_B1)：以『付款日B(@PAY_DATE_B)』為起始值，逐日判斷”1.3.6.3.2.2”的計算規則
    --3.3.2.1.1 若『付款日B1(@PAY_DATE_B1)』為”星期六或星期日”時，則再加一個日曆日重新推算，直到該日期不是”星期六或星期日”
    --3.3.2.2 以『付款日B1(@PAY_DATE_B1)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金交易日行事曆類別(@TX_CALENDAR_OUT)』及『買回基金付款日行事曆類別(@PAY_CALENDAR_OUT)』，是否有資料(有資料表示該日期為假日)
    --3.3.2.2.1 若為假日，且『付款日B1(@PAY_DATE_B1)』不是”星期六或星期日”時，則『轉入天數1(@CNT_1)』加１
    IF XPAY_DATE_B <= XPAY_DATE_A THEN
      XCNT_1 := 0;
	     XCEHCK_BUS := 0;
	     XWEEK_DAY := '';
      XPAY_DATE_B1 := XPAY_DATE_B;

      WHILE XPAY_DATE_B1<= XPAY_DATE_A LOOP
        BEGIN
          --判斷『付款日B1(@PAY_DATE_B1)』是否為營業日
          SELECT COUNT(DISTINCT HOLIDAY)
            INTO XCEHCK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XPAY_DATE_B1
             AND CALENDAR_CODE IN (XTX_CALENDAR_OUT,XPAY_CALENDAR_OUT);
          IF XCEHCK_BUS > 0 THEN
            BEGIN
              --星期幾? 星期日為1,星期六為7
              SELECT to_char(XPAY_DATE_B1,'d')
                INTO XWEEK_DAY
                FROM DUAL;
              IF XWEEK_DAY = '1' OR XWEEK_DAY = '7' THEN
                XCNT_1 := XCNT_1 + 1;
              END IF;
            END;
          END IF;
          XPAY_DATE_B1 := XPAY_DATE_B1 +1;
        END;
      END LOOP;
    END IF; -- IF XPAY_DATE_B <= XPAY_DATE_A THEN

    --3.4	轉入天數2(@CNT_2) ：以下述規則取得
    --3.4.1	若『買回交易日期(@TX_DATE)』等於『付款日B(@PAY_DATE_B)』，則『轉入天數2(@CNT_2)』等於０
	   IF WTX_DATE = XPAY_DATE_B THEN
	     XCNT_2 := 0;
	   END IF;
    --3.4.2	若『買回交易日期(@TX_DATE)』小於等於『付款日B(@PAY_DATE_B)』時，計算二個日期相差的天數(不含星期六、星期日)
    --3.4.2.1	付款日B2(@PAY_DATE_B2)：以『買回交易日期(@TX_DATE)』為起始值，逐日判斷”1.3.6.4.2.2”的計算規則
    --3.4.2.1.1	若『付款日B2(@PAY_DATE_B2)』為”星期六或星期日”時，則再加一個日曆日重新推算，直到該日期不是”星期六或星期日”
    --3.4.2.2	以『付款日B2(@PAY_DATE_B1)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金淨值日行事曆類別(@NAV_CALENDAR_OUT)』，是否有資料(有資料表示該日期為假日)
    --3.4.2.2.1	若為假日，且『付款日B1(@PAY_DATE_B1)』不是”星期六或星期日”時，則『轉入天數2(@CNT_2)』加１
    IF WTX_DATE <= XPAY_DATE_B THEN
	     XCEHCK_BUS := 0;
	     XWEEK_DAY := '';
      XPAY_DATE_B2 := WTX_DATE;

      WHILE XPAY_DATE_B2<= XPAY_DATE_B LOOP
        BEGIN
          --判斷『付款日B2(@PAY_DATE_B2)』是否為營業日
          SELECT COUNT(DISTINCT HOLIDAY)
            INTO XCEHCK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XPAY_DATE_B1
             AND CALENDAR_CODE = XNAV_CALENDAR_OUT;
          IF XCEHCK_BUS > 0 THEN
            BEGIN
              --星期幾? 星期日為1,星期六為7
              SELECT to_char(XPAY_DATE_B2,'d')
                INTO XWEEK_DAY
                FROM DUAL;
              IF XWEEK_DAY = '1' OR XWEEK_DAY = '7' THEN
                XCNT_2 := XCNT_2 + 1;
              END IF;
            END;
          END IF;
          XPAY_DATE_B2 := XPAY_DATE_B2 +1;
        END;
      END LOOP;
    END IF; --IF WTX_DATE <= XPAY_DATE_B THEN

    --3.5 轉入總天數(@CNT_TOT)：『轉入天數(@TX_DAYS)』＋『轉入天數1(@CNT_1)』＋『轉入天數2(@CNT_2)』
	   XCNT_TOT := WTX_DAYS + XCNT_1 + XCNT_2;

    --3.6 轉申購前置日期(@PRE_SWITCH_DATE)：以『買回交易日期(@TX_DATE)』加上『轉入總天數(@CNT_TOT)』，以日曆日推算(不含星期六、星期日)
	   I := 0;
    XPRE_SWITCH_DATE := WTX_DATE;

    WHILE I <= XCNT_TOT LOOP
      BEGIN
        SELECT to_char(XPRE_SWITCH_DATE,'d')
	  	    INTO XWEEK_DAY
          FROM DUAL;

        WHILE XWEEK_DAY = '1' OR XWEEK_DAY = '7' LOOP
          BEGIN
            XPRE_SWITCH_DATE := XPRE_SWITCH_DATE+1;

  		      SELECT to_char(XPRE_SWITCH_DATE,'d')
	  	        INTO XWEEK_DAY
              FROM DUAL;
          END;    
        END LOOP;
        IF I > 0 THEN
          XPRE_SWITCH_DATE := XPRE_SWITCH_DATE+1;
        END IF;
        I := I+1;
      END;
    END LOOP;

    --3.7 轉申購日期(@SWITCH_DATE)：以『轉申購前置日期(@PRE_SWITCH_DATE)』，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『轉入基金淨值日行事曆類別(@NAV_CALENDAR_IN)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --3.7.1 判斷傳入的轉申購前置日期是否為營業日
    --      若不是營業日，則取得該轉申購前置日期的次一個營業日，作為該基金的轉申購日期
    SELECT MIN(CALENDAR_DATE) INTO XSWITCH_DATE
      FROM Table(FundCalendarB)
     WHERE CALENDAR_DATE >= XPRE_SWITCH_DATE
       AND BUSS_ID = 'W';
  END IF;

  return XSWITCH_DATE;

END F_GetSwitchDate;

/

  GRANT EXECUTE ON "ECS"."F_GETSWITCHDATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETSWITCHDATE_1
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETSWITCHDATE_1" 
-- =============================================
-- Author:      PAN
-- Create date: 2018/11/08
-- Description: --取得轉申購日期
-- 2019.11.26 ChengYu 調整預計轉申購日推算方法
-- =============================================
-- SELECT ECS.F_GetSwitchDate(TO_DATE('20181107','YYYYMMDD'),'D11','1',TO_DATE('20181107','YYYYMMDD'),1,'D4') FROM DUAL;
(
  WTX_DATE        DATE        --買回交易日期
 ,WFUND_NO_OUT    VARCHAR2    --買回基金代碼
 ,WFUND_CATEGORY  VARCHAR2    --境內外識別碼(買回基金)
 ,WPAY_DATE       DATE        --預計買回入帳日期(買回基金)
 ,WTX_DAYS        NUMBER      --轉入天數
 ,WFUND_NO_IN     VARCHAR2    --轉換基金代碼
)
return date  --回傳轉申購日期
IS
  FundCalendarA ECS.CalendarTypes; --轉入基金（交易日）行事曆
  FundCalendarB ECS.CalendarTypes; --轉入基金（淨值日）行事曆
  XSWITCH_DATE      DATE;          --轉申購日期
  XTX_CALENDAR_OUT  VARCHAR2(5);   --買回基金交易日行事曆類別
  XNAV_CALENDAR_OUT VARCHAR2(5);   --買回基金淨值日行事曆類別
  XPAY_CALENDAR_OUT VARCHAR2(2);   --買回基金付款日行事曆類別
  XPAY_DAY          NUMBER(1);     --買回付款日參數(T+N)
  XPRE_SWITCH_DATE  DATE;          --轉申購前置日期
  XPAY_DATE_A       DATE;          --預計買回入帳日期A
  XPAY_DATE_B       DATE;          --預計買回入帳日期B
  XPAY_DATE_B1      DATE;          --預計買回入帳日期B1
  XPAY_DATE_B2      DATE;          --預計買回入帳日期B2
  XCNT_1            NUMBER(1);     --轉入天數1
  XCNT_2            NUMBER(1);     --轉入天數2
  XCEHCK_BUS        INTEGER;       --檢查是否為營業日
  XWEEK_DAY         VARCHAR2(1);   --星期幾?(1表示星期日,7表示星期六)
  XCNT_TOT          NUMBER(2);     --轉入總天數
  I                 NUMBER(2);     --迴圈變數

BEGIN
  --設定初始值
  XCNT_1 := 0;
  XCNT_2 := 0;

  --1.準備事項
  --1.1.取得傳入日期前15後90天的基金淨值行事曆
  IF WFUND_CATEGORY = '1' THEN --境內基金
    --1.1.1 轉入基金（交易日）行事曆
    SELECT CAST(MULTISET(SELECT *
                           FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO_IN,'1',WTX_DATE-15,WTX_DATE+90) as CalendarTypes))
                        ) AS ECS.CalendarTypes)
      INTO FundCalendarA
      FROM DUAL;
  END IF;
  IF WFUND_CATEGORY = '2' THEN --境外基金
    --1.1.2 轉入基金（淨值日）行事曆
    SELECT CAST(MULTISET(SELECT *
                           FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO_IN,'2',WTX_DATE-15,WTX_DATE+90) as CalendarTypes))
                        ) AS ECS.CalendarTypes)
      INTO FundCalendarB
      FROM DUAL;
  END IF;

  --1.2以 傳入參數『買回基金代碼』至【基金主檔(FAS.FUND)】取得以下欄位
  SELECT TX_CALENDAR_CODE,CALENDAR_CODE,SUBSTRB(CURRENCY_NO,1,2) PAY_CALENDAR,PAY_DAY
    INTO XTX_CALENDAR_OUT,XNAV_CALENDAR_OUT,XPAY_CALENDAR_OUT,XPAY_DAY
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO_OUT;

  --2.若傳入參數『境內外識別碼(@FUND_CATEGORY)』為”1.境內” 時，以下述規則取得
  IF WFUND_CATEGORY = '1' THEN --境內基金
    --2.1 轉申購前置日期(@PRE_SWITCH_DATE) ：以傳入參數『買回交易日期(@TX_DATE)』加上『轉入天數(@TX_DAYS)』推算
    --2.1.1 以傳入參數『買回交易日期(@TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金交易日行事曆類別(@TX_CALENDAR_OUT)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
	   --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
    XPRE_SWITCH_DATE := ECS.F_GetBefAftDate_1(WFUND_NO_OUT||';'||WFUND_NO_IN,'5',WTX_DATE,WTX_DAYS);

    --2.2 轉申購日期(@SWITCH_DATE) ：以『轉申購前置日期(@PRE_SWITCH_DATE)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『轉入基金交易日行事曆類別(@TX_CALENDAR_IN)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --2.2.1 判斷傳入的轉申購前置日期是否為營業日
    --      若不是營業日，則取得該轉申購前置日期的次一個營業日，作為該基金的轉申購日期
    SELECT MIN(CALENDAR_DATE) INTO XSWITCH_DATE
      FROM Table(FundCalendarA)
     WHERE CALENDAR_DATE >= XPRE_SWITCH_DATE
       AND BUSS_ID = 'W';
  END IF;

  --3 若傳入參數『境內外識別碼(@FUND_CATEGORY)』為”2.境外”時，以下述規則取得
  IF WFUND_CATEGORY = '2' THEN --境外基金
    --3.1 付款日A(@PAY_DATE_A) ：『預計買回入帳日期(@PAY_DATE)』
    XPAY_DATE_A := WPAY_DATE;
    --3.2 付款日B(@PAY_DATE_B) ：以傳入參數『買回基金代碼(@FUND_ NO)』、『買回交易日期(@TX_DATE)』加上『買回付款日參數(@PAY_DAY)』推算
    --3.2.1 以『買回交易日期(@TX_DATE)』＋1個日曆日後，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金淨值日行事曆類別(@NAV_CALENDAR_OUT)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --3.2.2 需逐日推算營業日，假設參數日為３，則需１天天推算，先抓到第一個營業日，再以推算後的第一個營業日推算第二個營業日，再以推算後的第二個營業日，推算第三個營業日
	   --      ECS.F_GetBefAftDate : 行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
    -- 2019.11.26 ChengYu 調整預計轉申購日推算方法
    XPAY_DATE_B := ECS.F_GetBefAftDate_1(WFUND_NO_OUT||';'||WFUND_NO_IN,'5',WTX_DATE,XPAY_DAY);

    --3.3 轉入天數1(@CNT_1)：以下述規則取得
    --3.3.1 若『付款日A(@PAY_DATE_A)』等於『付款日B(@PAY_DATE_B)』，則『轉入天數1(@CNT_1)』等於０
    IF XPAY_DATE_A = XPAY_DATE_B THEN
      XCNT_1 := 0;
    END IF;
    --3.3.2 若『付款日B(@PAY_DATE_B)』小於等於『付款日A(@PAY_DATE_A)』時，計算二個日期相差的天數(不含星期六、星期日)
    --3.3.2.1 付款日B1(@PAY_DATE_B1)：以『付款日B(@PAY_DATE_B)』為起始值，逐日判斷”1.3.6.3.2.2”的計算規則
    --3.3.2.1.1 若『付款日B1(@PAY_DATE_B1)』為”星期六或星期日”時，則再加一個日曆日重新推算，直到該日期不是”星期六或星期日”
    --3.3.2.2 以『付款日B1(@PAY_DATE_B1)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金交易日行事曆類別(@TX_CALENDAR_OUT)』及『買回基金付款日行事曆類別(@PAY_CALENDAR_OUT)』，是否有資料(有資料表示該日期為假日)
    --3.3.2.2.1 若為假日，且『付款日B1(@PAY_DATE_B1)』不是”星期六或星期日”時，則『轉入天數1(@CNT_1)』加１
    IF XPAY_DATE_B <= XPAY_DATE_A THEN
      XCNT_1 := 0;
	     XCEHCK_BUS := 0;
	     XWEEK_DAY := '';
      XPAY_DATE_B1 := XPAY_DATE_B;

      WHILE XPAY_DATE_B1<= XPAY_DATE_A LOOP
        BEGIN
          --判斷『付款日B1(@PAY_DATE_B1)』是否為營業日
          SELECT COUNT(DISTINCT HOLIDAY)
            INTO XCEHCK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XPAY_DATE_B1
             AND CALENDAR_CODE IN (XTX_CALENDAR_OUT,XPAY_CALENDAR_OUT);
          IF XCEHCK_BUS > 0 THEN
            BEGIN
              --星期幾? 星期日為1,星期六為7
              SELECT to_char(XPAY_DATE_B1,'d')
                INTO XWEEK_DAY
                FROM DUAL;
              IF XWEEK_DAY = '1' OR XWEEK_DAY = '7' THEN
                XCNT_1 := XCNT_1 + 1;
              END IF;
            END;
          END IF;
          XPAY_DATE_B1 := XPAY_DATE_B1 +1;
        END;
      END LOOP;
    END IF; -- IF XPAY_DATE_B <= XPAY_DATE_A THEN

    --3.4	轉入天數2(@CNT_2) ：以下述規則取得
    --3.4.1	若『買回交易日期(@TX_DATE)』等於『付款日B(@PAY_DATE_B)』，則『轉入天數2(@CNT_2)』等於０
	   IF WTX_DATE = XPAY_DATE_B THEN
	     XCNT_2 := 0;
	   END IF;
    --3.4.2	若『買回交易日期(@TX_DATE)』小於等於『付款日B(@PAY_DATE_B)』時，計算二個日期相差的天數(不含星期六、星期日)
    --3.4.2.1	付款日B2(@PAY_DATE_B2)：以『買回交易日期(@TX_DATE)』為起始值，逐日判斷”1.3.6.4.2.2”的計算規則
    --3.4.2.1.1	若『付款日B2(@PAY_DATE_B2)』為”星期六或星期日”時，則再加一個日曆日重新推算，直到該日期不是”星期六或星期日”
    --3.4.2.2	以『付款日B2(@PAY_DATE_B1)』至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『買回基金淨值日行事曆類別(@NAV_CALENDAR_OUT)』，是否有資料(有資料表示該日期為假日)
    --3.4.2.2.1	若為假日，且『付款日B1(@PAY_DATE_B1)』不是”星期六或星期日”時，則『轉入天數2(@CNT_2)』加１
    IF WTX_DATE <= XPAY_DATE_B THEN
	     XCEHCK_BUS := 0;
	     XWEEK_DAY := '';
      XPAY_DATE_B2 := WTX_DATE;

      WHILE XPAY_DATE_B2<= XPAY_DATE_B LOOP
        BEGIN
          --判斷『付款日B2(@PAY_DATE_B2)』是否為營業日
          SELECT COUNT(DISTINCT HOLIDAY)
            INTO XCEHCK_BUS
            FROM FAS.CALENDAR
           WHERE HOLIDAY = XPAY_DATE_B1
             AND CALENDAR_CODE = XNAV_CALENDAR_OUT;
          IF XCEHCK_BUS > 0 THEN
            BEGIN
              --星期幾? 星期日為1,星期六為7
              SELECT to_char(XPAY_DATE_B2,'d')
                INTO XWEEK_DAY
                FROM DUAL;
              IF XWEEK_DAY = '1' OR XWEEK_DAY = '7' THEN
                XCNT_2 := XCNT_2 + 1;
              END IF;
            END;
          END IF;
          XPAY_DATE_B2 := XPAY_DATE_B2 +1;
        END;
      END LOOP;
    END IF; --IF WTX_DATE <= XPAY_DATE_B THEN

    --3.5 轉入總天數(@CNT_TOT)：『轉入天數(@TX_DAYS)』＋『轉入天數1(@CNT_1)』＋『轉入天數2(@CNT_2)』
	   XCNT_TOT := WTX_DAYS + XCNT_1 + XCNT_2;

    --3.6 轉申購前置日期(@PRE_SWITCH_DATE)：以『買回交易日期(@TX_DATE)』加上『轉入總天數(@CNT_TOT)』，以日曆日推算(不含星期六、星期日)
	   I := 0;
    XPRE_SWITCH_DATE := WTX_DATE;

    WHILE I <= XCNT_TOT LOOP
      BEGIN
        SELECT to_char(XPRE_SWITCH_DATE,'d')
	  	    INTO XWEEK_DAY
          FROM DUAL;

        WHILE XWEEK_DAY = '1' OR XWEEK_DAY = '7' LOOP
          BEGIN
            XPRE_SWITCH_DATE := XPRE_SWITCH_DATE+1;

  		      SELECT to_char(XPRE_SWITCH_DATE,'d')
	  	        INTO XWEEK_DAY
              FROM DUAL;
          END;    
        END LOOP;
        IF I > 0 THEN
          XPRE_SWITCH_DATE := XPRE_SWITCH_DATE+1;
        END IF;
        I := I+1;
      END;
    END LOOP;

    --3.7 轉申購日期(@SWITCH_DATE)：以『轉申購前置日期(@PRE_SWITCH_DATE)』，至【行事曆(FAS.CALENDAR)】判斷「營業日系統(CALENDAR_CODE)」的『轉入基金淨值日行事曆類別(@NAV_CALENDAR_IN)』，是否有資料；若有抓到資料，則再加一個日曆日重新推算，直到該日期無資料為止
    --3.7.1 判斷傳入的轉申購前置日期是否為營業日
    --      若不是營業日，則取得該轉申購前置日期的次一個營業日，作為該基金的轉申購日期
    SELECT MIN(CALENDAR_DATE) INTO XSWITCH_DATE
      FROM Table(FundCalendarB)
     WHERE CALENDAR_DATE >= XPRE_SWITCH_DATE
       AND BUSS_ID = 'W';
  END IF;

  return XSWITCH_DATE;

END F_GetSwitchDate_1;

/
--------------------------------------------------------
--  DDL for Function F_GETTODODATA
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETTODODATA" (
  strUserID in varchar2,
  strFunctionID in varchar2,
  strEVAAction in varchar2
)
RETURN T_F_GetToDoData_TABLE as
       v_striUserID varchar2(11) := strUserID;
       v_striFunctionID varchar2(20) := strFunctionID;
       v_striEVAAction varchar2(1) := strEVAAction;
       v_ret   T_F_GetToDoData_TABLE;
       v_AANDEMUSTUNEQUALONE2V2A NUMBER(5,0):=0;



begin
   SELECT ( SELECT AANDEMUSTUNEQUALONE2V2A
            FROM AA_SW WHERE ROWNUM <= 1 )
   Into
      v_AANDEMUSTUNEQUALONE2V2A
     FROM DUAL ;

if(v_AANDEMUSTUNEQUALONE2V2A = 0)
Then
  Begin

  select
  cast(
  multiset(
              SELECT Distinct
                 ToDoDataID
               FROM ToDo
               Where ToDo.ToFunctionID = v_striFunctionID
               And ToDo.ToGroupID IN (
                                         Select GroupID From  Table(fn_GetLoginGroup(v_striUserID))
                                      )

               And 
               ( v_striEVAAction = 'R' AND ToDo.EVAAction Not In ('V','A')
                 OR -- 自己可以重送自己退回的資料
                 (
                    (v_striEVAAction = 'V' And ToDo.EVAAction = 'V' AND (ToDo.ToDoEntryID<>v_striUserID))
                     OR
                    (v_striEVAAction = 'A' And ToDo.EVAAction = 'A' AND
                                                 (
                                                    (((ToDo.ToDoUpdateDate = ToDo.ToDoVerifyDate) And (ToDo.ToDoEntryDate <> ToDo.ToDoVerifyDate)) AND (ToDo.ToDoUpdateID<>v_striUserID)) --最後修改者動作為驗證
                                                 OR (((ToDo.ToDoUpdateDate <> ToDo.ToDoVerifyDate) OR (ToDo.ToDoEntryDate  = ToDo.ToDoVerifyDate)))  --最後修改者動作不為驗證(為輸入或重送)，因為要可以看到自己送件待覆核的資料，故不排除EntryID為自己
                                                 )
                    )
                 )
               )
           )
      as T_F_GetToDoData_TABLE)
    into
      v_ret
    from
      dual;
  END;
	Else --欲執行覆核者的ID必須與Data的EntryID不同才可執行覆核
	Begin
  select
  cast(
  multiset(
              SELECT Distinct
                 ToDoDataID
               FROM ToDo
               Where ToDo.ToFunctionID = v_striFunctionID
               And ToDo.ToGroupID IN (
                                         Select GroupID From  Table(fn_GetLoginGroup(v_striUserID))
                                      )

               And 
               ( v_striEVAAction = 'R' AND ToDo.EVAAction Not In ('V','A')
                 OR -- 自己可以重送自己退回的資料
                 (
                    (v_striEVAAction = 'V' And ToDo.EVAAction = 'V' AND (ToDo.ToDoEntryID<>v_striUserID))
                     OR
                    (v_striEVAAction = 'A' And ToDo.EVAAction = 'A' AND
                                                 (
  --                                                  (((ToDo.ToDoUpdateDate = ToDo.ToDoVerifyDate) And (ToDo.ToDoEntryDate <> ToDo.ToDoVerifyDate)) AND (ToDo.ToDoUpdateID<>v_striUserID)) --最後修改者動作為驗證
                                                                                                                --若SW.AANDEMUSTUNEQUALONE2V2A = 1,代表 執行覆核者ID(@striUserID)不可與待覆核資料的ToDoEntryID同一人，故排除 (<>)
                                                    (((ToDo.ToDoUpdateDate = ToDo.ToDoVerifyDate) And (ToDo.ToDoEntryDate <> ToDo.ToDoVerifyDate))  AND ((ToDo.ToDoUpdateID<>v_striUserID) AND (ToDo.ToDoEntryID <> v_striUserID))) --最後修改者動作為驗證
                                                 OR (((ToDo.ToDoUpdateDate <> ToDo.ToDoVerifyDate) OR (ToDo.ToDoEntryDate  = ToDo.ToDoVerifyDate)))  --最後修改者動作不為驗證(為輸入或重送)，因為要可以看到自己送件待覆核的資料，故不排除EntryID為自己
                                                 )
                    )
                 )
               )
           )
      as T_F_GetToDoData_TABLE)
    into
      v_ret
    from
      dual;


  END;
END if;


  return v_ret;

end F_GetToDoData;

/

  GRANT EXECUTE ON "ECS"."F_GETTODODATA" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETTRADEDATE_ALLOT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETTRADEDATE_ALLOT" --取得申購時的交易日期
-- =============================================
-- Author:      STU
-- Create date: 
-- Description: 行事曆
-- 2019.07.18 JIANXIN MOD 若販售終止日有日期，則代表不可EC申購，但不一定不能EC RSP扣款，停止交易日有日期，則代表EC 申購與 EC RSP 皆不能扣款
-- =============================================
(
  WFUND_NO        IN varchar2, --基金代碼
  WDATE           IN date,     --日期
  WALLOT_TYPE     IN VARCHAR2, --交易種類(1.申購;2.EC RSP)
  WALLOT_DATE    OUT date      --申購日期
)
return varchar2
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆

  XALLOT_DATE DATE;           --申購日期
  XMSGID VARCHAR2(6);         --訊息流水號 
  XCOUNT NUMBER(9);
  ---------------------------------------------------------
  XTX_CALENDAR_CODE VARCHAR2(5);
  XLAUNCH_DATE DATE;          --開始募集日
  XSALES_DATE DATE;           --開賣日
  XCLEAR_DATE DATE;           --停止交易日
  XELIMINATION_DATE DATE;     --販售終止日

BEGIN
  --設定初始值
  XALLOT_DATE := TO_DATE('20000101','YYYYMMDD');
  XMSGID := NULL;

  --1.準備事項
  --1.1 取得傳入日期前30後365天的基金交易行事曆
  SELECT CAST(MULTISET(
                        SELECT *
                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'1',WDATE-30,WDATE+365) as CalendarTypes))
                       ) AS ECS.CalendarTypes) INTO FundCalendar
    FROM DUAL;

  --1.2 取得基金的開始募集日、開賣日、停止交易日、販售終止日
  SELECT TX_CALENDAR_CODE, 
         NVL(LAUNCH_DATE,TO_DATE('19000101','YYYYMMDD')),     --開始募集日
         NVL(SALES_DATE,TO_DATE('19000101','YYYYMMDD')),      --開賣日
         CLEAR_DATE,                                          --停止交易日
         ELIMINATION_DATE                                     --販售終止日
    INTO XTX_CALENDAR_CODE,
         XLAUNCH_DATE,
         XSALES_DATE,
         XCLEAR_DATE,
         XELIMINATION_DATE
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO;

  --2.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T001
  SELECT COUNT(*) INTO XCOUNT
    FROM FAS.CALENDAR A
   WHERE CALENDAR_CODE = XTX_CALENDAR_CODE
     AND HOLIDAY >= WDATE;

  IF XCOUNT = 0 THEN
    XMSGID := 'T001';
    GOTO TO_END;
  END IF; 

  --3.以傳入的日期導出申購日期
  --3.1 判斷是否為營業日
  --    若不是營業日，則取得該日期的次一個營業日，作為該基金的交易日期
  SELECT MIN(CALENDAR_DATE) INTO XALLOT_DATE
    FROM Table(FundCalendar)
   WHERE CALENDAR_DATE >= WDATE
     AND BUSS_ID = 'W';

  --3.2 若上點的『交易日期』小於『開始募集日(FUND.LAUNCH_DATE)』時，表示要
  --    重新取得大於等於該開始募集日期的最近的營業日，作為該基金的交易日期
  IF XALLOT_DATE < XLAUNCH_DATE THEN
    SELECT MIN(CALENDAR_DATE) INTO XALLOT_DATE
      FROM Table(FundCalendar)
     WHERE CALENDAR_DATE >= XLAUNCH_DATE
       AND BUSS_ID = 'W';
  END IF; 

  --3.3	若上點的『交易日期』小於『開賣日(FUND.SALES_DATE) 』時，表示要
  --    重新取得大於等於該開賣日的最近的營業日，作為該基金的交易日期
  IF XALLOT_DATE < XSALES_DATE THEN
    SELECT MIN(CALENDAR_DATE) INTO XALLOT_DATE
      FROM Table(FundCalendar)
     WHERE CALENDAR_DATE >= XSALES_DATE
       AND BUSS_ID = 'W';
  END IF; 

  --3.4 若上點的『交易日期』大於『停止交易日』且『停止交易日(FUND.CLEAR_DATE)』不為空白時，表示該基金已停止交易，則以'2000/01/01'作為該基金的(新)交易日期  
  IF XCLEAR_DATE IS NOT NULL AND XALLOT_DATE > XCLEAR_DATE THEN
    XALLOT_DATE := TO_DATE('20000101','YYYYMMDD');
    XMSGID := 'T002';
    GOTO TO_END;
  END IF; 

  --3.5 若3.3點的『交易日期』大於『販售終止日(FUND.ELIMINATION_DATE)』且『販售終止日』不為空白時，表示該基金已停止交易，則以'2000/01/01'作為該基金的(新)交易日期
  -- 2019.07.18 JIANXIN MOD 若販售終止日有日期，則代表不可EC申購，但不一定不能EC RSP扣款，停止交易日有日期，則代表EC 申購與 EC RSP 皆不能扣款
  IF XELIMINATION_DATE IS NOT NULL AND XALLOT_DATE > XELIMINATION_DATE  AND WALLOT_TYPE = '1' THEN
    XALLOT_DATE := TO_DATE('20000101','YYYYMMDD');
    XMSGID := 'T003';
  END IF; 

  <<TO_END>>
  WALLOT_DATE := XALLOT_DATE;
  return XMSGID;

END F_GetTradeDate_Allot;

/

  GRANT EXECUTE ON "ECS"."F_GETTRADEDATE_ALLOT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETTRADEDATE_REDEM
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETTRADEDATE_REDEM" --取得贖回/轉出時的交易日期
(
  WFUND_NO        IN varchar2, --基金代碼
  WDATE           IN date,     --日期
  WREDEM_DATE    OUT date      --贖回日期
)
return varchar2
IS
  FundCalendar ECS.CalendarTypes; --基金行事曆

  XREDEM_DATE DATE;           --申購日期
  XMSGID VARCHAR2(6);         --訊息流水號 
  XCOUNT NUMBER(9);
  ---------------------------------------------------------
  XTX_CALENDAR_CODE VARCHAR2(5);
  XFIRST_RED_DATE DATE;       -- 開始買回日
  XCLEAR_DATE DATE;           --停止交易日

BEGIN
  --設定初始值
  XREDEM_DATE := TO_DATE('20000101','YYYYMMDD');
  XMSGID := NULL;

  --1.準備事項
  --1.1 取得傳入日期前30後365天的基金交易行事曆
  SELECT CAST(MULTISET(
                        SELECT *
                          FROM Table( cast(ECS.F_GET_FUNDCALENDAR(WFUND_NO,'1',WDATE-30,WDATE+365) as CalendarTypes))
                       ) AS ECS.CalendarTypes) INTO FundCalendar
    FROM DUAL;

  --1.2 取得基金的停止交易日
  SELECT TX_CALENDAR_CODE, 
         FIRST_RED_DATE, -- 開始買回日
         CLEAR_DATE      --停止交易日
    INTO XTX_CALENDAR_CODE,
         XFIRST_RED_DATE,
         XCLEAR_DATE
    FROM FAS.FUND
   WHERE FUND_NO = WFUND_NO;

  --2.若【行事曆檔(FAS.CALENDAR)】無法取得資料時，則回傳錯誤代碼T001
  SELECT COUNT(*) INTO XCOUNT
    FROM FAS.CALENDAR A
   WHERE CALENDAR_CODE = XTX_CALENDAR_CODE
     AND HOLIDAY >= WDATE;

  IF XCOUNT = 0 THEN
    XMSGID := 'T001';
    GOTO TO_END;
  END IF; 

  --3.以傳入的日期導出贖回日期
  --3.1 判斷是否為營業日
  --    若不是營業日，則取得該日期的次一個營業日，作為該基金的交易日期
  SELECT MIN(CALENDAR_DATE) INTO XREDEM_DATE
    FROM Table(FundCalendar)
   WHERE CALENDAR_DATE >= WDATE
     AND BUSS_ID = 'W';

  --3.2	若上點的『交易日期』小於『開始買回日(XFIRST_RED_DATE)』時，表示要
  --    重新取得大於等於該開始買回日的最近的營業日，作為該基金的交易日期
  IF XREDEM_DATE < XFIRST_RED_DATE THEN
    SELECT MIN(CALENDAR_DATE) INTO XREDEM_DATE
      FROM Table(FundCalendar)
     WHERE CALENDAR_DATE >= XFIRST_RED_DATE
       AND BUSS_ID = 'W';
  END IF; 

  --3.4 若上點的『交易日期』大於『停止交易日』且『停止交易日(FUND.CLEAR_DATE)』不為空白時，表示該基金已停止交易，則以'2000/01/01'作為該基金的(新)交易日期  
  IF XCLEAR_DATE IS NOT NULL AND XREDEM_DATE > XCLEAR_DATE THEN
    XREDEM_DATE := TO_DATE('20000101','YYYYMMDD');
    XMSGID := 'T004';
  END IF; 

  <<TO_END>>
  WREDEM_DATE := XREDEM_DATE;
  return XMSGID;

END F_GetTradeDate_Redem;

/

  GRANT EXECUTE ON "ECS"."F_GETTRADEDATE_REDEM" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETTXNO
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETTXNO" 
-- =============================================
-- Author:      Joseph
-- Create date: 2018/03/19
-- Description: 取得交易序號
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
-- 2018.10.30 tingting 1.調整取交易序號方式，防止PK重覆問題(原：先SELECT再UPDATE 後：先UPDATE再SELECT)
--                     2.增加傳入參數：交易種類(1.申購 2:贖回)
-- 2019.06.20 JIANXIN 若序號超過9999，則序號更新為1
-- =============================================
(
     WYEAR          IN NUMBER    	    --年份
    ,WBROKER_NO     IN VARCHAR2  	    --代銷單位
    ,WBRANCH_NO     IN VARCHAR2  	    --代銷分公司碼
    ,WFUND_NO       IN VARCHAR2		    --基金代碼
    ,WTRADE_TYPE    IN VARCHAR2		    --交易種類(1.申購 2:贖回)
)
-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
RETURN VARCHAR2 IS

	-- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
	FUNCTIONRESULT VARCHAR2(4);
 MAX_NUM INT := 9999;

BEGIN

    DECLARE

        PRE_SN NUMBER(4) := NULL;

    BEGIN

        IF (WTRADE_TYPE = '1') THEN
        BEGIN

            UPDATE FAS.SN_SUBSCRIPTION
               -- 2019.06.20 JIANXIN 若序號超過9999，則序號更新為1
               SET SN = CASE WHEN SN + 1 > MAX_NUM THEN 1 ELSE SN + 1 END
             WHERE YEAR = WYEAR
               AND BROKER_NO = WBROKER_NO
               AND BRANCH_NO = WBRANCH_NO
               AND FUND_NO = WFUND_NO;

            SELECT SN
              INTO PRE_SN
              FROM FAS.SN_SUBSCRIPTION
             WHERE YEAR = WYEAR
               AND BROKER_NO = WBROKER_NO
               AND BRANCH_NO = WBRANCH_NO
               AND FUND_NO = WFUND_NO;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN PRE_SN := 1;

                INSERT INTO FAS.SN_SUBSCRIPTION
                (YEAR, BROKER_NO, BRANCH_NO, FUND_NO, SN)
                VALUES
                (WYEAR, WBROKER_NO, WBRANCH_NO, WFUND_NO, PRE_SN);

        END;
        ELSE
        BEGIN

            UPDATE FAS.SN_REDEMPTION
               -- 2019.06.20 JIANXIN 若序號超過9999，則序號更新為1
               SET SN = CASE WHEN SN + 1 > MAX_NUM THEN 1 ELSE SN + 1 END
             WHERE YEAR = WYEAR
               AND BROKER_NO = WBROKER_NO
               AND BRANCH_NO = WBRANCH_NO
               AND FUND_NO = WFUND_NO;

            SELECT SN
              INTO PRE_SN
              FROM FAS.SN_REDEMPTION
             WHERE YEAR = WYEAR
               AND BROKER_NO = WBROKER_NO
               AND BRANCH_NO = WBRANCH_NO
               AND FUND_NO = WFUND_NO;

            EXCEPTION
                WHEN NO_DATA_FOUND THEN PRE_SN := 1;

                INSERT INTO FAS.SN_REDEMPTION
                (YEAR, BROKER_NO, BRANCH_NO, FUND_NO, SN)
                VALUES
                (WYEAR, WBROKER_NO, WBRANCH_NO, WFUND_NO, PRE_SN);

        END;
        END IF;

        -- 2018.07.12 JIANXIN SER_NO 必須填滿4碼
        FUNCTIONRESULT := LPAD(PRE_SN,4,'0');

    END;

    RETURN(FUNCTIONRESULT);

END f_GetTxNo;

/

  GRANT EXECUTE ON "ECS"."F_GETTXNO" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GETUSR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GETUSR" (V_USRID in VARCHAR2)
  return varchar2 is
  X_Result varchar2(6);
  X_Count int;
begin
  X_Result := 'N';
  X_Count := 0;
  -- 2018.10.18 yunchu 撠？SR_ID(雿輻？？？？？？？？？)？？？？？？？MP_NO(隞？蝣？)
  SELECT COUNT(EMP_NO) INTO X_Count
    FROM SMS.USR
   WHERE EMP_NO = V_USRID;

  IF X_Count > 0 THEN
    SELECT EMP_NO INTO X_Result
      FROM SMS.USR
     WHERE EMP_NO = V_USRID;
  END IF;

  return(X_Result);
end F_GETUSR;

/

  GRANT EXECUTE ON "ECS"."F_GETUSR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_COUPON_ID
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_COUPON_ID" 
(
  WCOUPON_ID_STR NVARCHAR2 :=''  --ECSB007執行時，尚未Commit的優惠券編號
)
RETURN NVARCHAR2  --回傳優惠券編號
IS
  XCOUPON_ID     NVARCHAR2(7):= '';   --優惠券編號
  XDATA_NUM      INTEGER:= 0;         --資料筆數

  Pragma autonomous_transaction; 
BEGIN

  WHILE (XCOUPON_ID IS NULL OR XDATA_NUM > 0)
  LOOP 

     -- 2021.07.12 Chengyu 調整優惠券代碼取法
     XCOUPON_ID:= dbms_random.string('x',7); --取得英文數字亂碼7碼

     --確認是否存在資料庫中
     SELECT COUNT(1)  
       INTO XDATA_NUM
       FROM ECS.COUPON_DATA 
      WHERE COUPON_ID = XCOUPON_ID;

     --確認執行批次時是否重複
     SELECT XDATA_NUM + NVL(COUNT(1),0)
       INTO XDATA_NUM
       FROM (TABLE(ECS.F_FormatStringListToTable(WCOUPON_ID_STR))) TB_TEMP
      WHERE TB_TEMP.VALUE1 = XCOUPON_ID; 

  END LOOP;

  RETURN XCOUPON_ID;

END F_GET_COUPON_ID;

/

  GRANT EXECUTE ON "ECS"."F_GET_COUPON_ID" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_EX_RATE
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_EX_RATE" 
-- =============================================
-- Author:      tingting
-- Create date: 2019/07/10
-- Description: 取得最近的參考匯率
-- 2023.10.25 JIANXIN 增加傳入參數，判斷要回傳哪種欄位
-- =============================================
-- SELECT ECS.F_GET_EX_RATE('M54',TO_DATE('2019/07/09','YYYY/MM/DD')) EX_RATE FROM DUAL;
(
    WFUND_NO        VARCHAR2,                 --基金代碼
    WDATE           DATE,                     --日期
    WTYPE           VARCHAR2 DEFAULT NULL     --種類；B：買入匯率；S：賣出匯率；NULL：一般
)
RETURN FAS.FUND_CURRENCY_RATE.EX_RATE%TYPE
IS

    XEX_RATE        FAS.FUND_CURRENCY_RATE.EX_RATE%TYPE;    --參考匯率

BEGIN

    -- 2023.10.25 JIANXIN 增加傳入參數，判斷要回傳哪種欄位
    SELECT CASE WHEN WTYPE = 'B' THEN BUY
                WHEN WTYPE = 'S' THEN SELL
                ELSE EX_RATE END
      INTO XEX_RATE
      FROM FAS.V_CURRENCY_RATE
     WHERE FUND_NO = WFUND_NO
       AND TX_DATE = WDATE;

    RETURN XEX_RATE;

END;

/

  GRANT EXECUTE ON "ECS"."F_GET_EX_RATE" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_FUNDCALENDAR
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_FUNDCALENDAR" --取得指定日期區間的基金行事曆
(
  WFUND_NO        IN varchar2, --基金代碼
  WCALENDAR_TYPE  IN varchar2, --行事曆種類(1.交易日行事曆、2.淨值日行事曆、3.付款日行事曆)
  WCALENDAR_DATES IN date,     --開始日期
  WCALENDAR_DATEE IN date      --截止日期
)
return ECS.CalendarTypes
IS
  r ECS.CalendarTypes;
  XTX_CALENDAR_CODE VARCHAR2(5);  --基金交易日設定(for 交易日)
  XNAV_CALENDAR_CODE VARCHAR2(5); --基金淨值日設定(for 淨值日)
  XPAY_CALENDAR_CODE VARCHAR2(5); --基金付款日設定(for 付款日)--即基金計價幣別(FUND.CURRENCY_NO)的前二碼
  XCALENDAR_CODE VARCHAR2(5);     --基金行事曆代碼
BEGIN
   --取得基金交易日/淨值日的行事曆設定
   SELECT TX_CALENDAR_CODE,
          CALENDAR_CODE,
          SUBSTR(CURRENCY_NO,1,2)
     INTO XTX_CALENDAR_CODE,
          XNAV_CALENDAR_CODE,
          XPAY_CALENDAR_CODE
     FROM FAS.FUND
    WHERE FUND_NO = WFUND_NO;

   --決定基金行事曆代碼
   XCALENDAR_CODE := CASE WHEN WCALENDAR_TYPE = '1' THEN XTX_CALENDAR_CODE 
                          WHEN WCALENDAR_TYPE = '2' THEN XNAV_CALENDAR_CODE
                          ELSE XPAY_CALENDAR_CODE END;

   --取得指定基金的行事曆
   SELECT CAST(MULTISET(
                         SELECT A.CALENDAR_DATE, --日期
                                A.YEAR_DAY,      --當年度的第幾天
                                A.QUARTER_ID,    --當年度的第幾季
                                A.WEEK_ID,       --第幾週
                                A.WEEK_DAY,      --星期幾(0表示星期日)
                                CASE WHEN B.CALENDAR_CODE IS NULL THEN 'W' ELSE 'H' END BUSS_ID, --是否為營業日(W:營業日, H:假日)
                                B.NAME REMARK    --備註
                           FROM Table( cast(ECS.F_SWS_GETDATELIST(WCALENDAR_DATES,WCALENDAR_DATEE) as ECS.CalendarTypes)) A
                           LEFT JOIN FAS.CALENDAR B ON B.CALENDAR_CODE = XCALENDAR_CODE
                                                   AND B.HOLIDAY = A.CALENDAR_DATE
                          ORDER BY A.CALENDAR_DATE
                      ) AS ECS.CalendarTypes) INTO r
    FROM DUAL;

  return r;

END F_GET_FUNDCALENDAR;

/

  GRANT EXECUTE ON "ECS"."F_GET_FUNDCALENDAR" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_PRODUCT_NAME
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_PRODUCT_NAME" 
(
  WPRODUCT_TYPE VARCHAR2   --產品代碼
)
RETURN VARCHAR2  --產品名稱
IS
  XPRODUCT_NAME     VARCHAR2(30):= '';   --優惠券編號

BEGIN

  SELECT CASE WPRODUCT_TYPE WHEN 'P8' THEN '網路定額'
                            WHEN 'S2' THEN '效率投資法 (定期轉申購)'
                            WHEN 'S1' THEN '定期轉申購'
                            WHEN 'R1' THEN '買回'
                            WHEN 'L1' THEN '單筆申購'
                            WHEN 'L2' THEN '效率投資 (期初母基金申購)'
                            WHEN 'L3' THEN '效率投資 (母基金轉投資子基金)'
                            WHEN 'L4' THEN '效率投資 (子基金獲利了結)'
                            WHEN 'P1' THEN '定期定額'
                            WHEN 'P2' THEN '五年儲蓄計畫'
                            WHEN 'R4' THEN '效率投資 (子基金獲利了結)'
                            WHEN 'R3' THEN '效率投資 (母基金轉投資子基金)'
                            WHEN 'P3' THEN '定期不定額'
                            WHEN 'L5' THEN '定期不定額 (獲利了結)'
                            WHEN 'R5' THEN '定期不定額 (獲利了結)'
                            WHEN 'P9' THEN '網路不定額'
                            WHEN 'L7' THEN 'ROBO申購'
                            WHEN 'R7' THEN 'ROBO買回'
                            WHEN 'L6' THEN '後收型基金期滿轉前收'
                            WHEN 'R6' THEN '後收型基金期滿轉前收'
                            WHEN 'R8' THEN '基金清算'
                            WHEN 'RA' THEN '提前到期結算'
                            WHEN 'R9' THEN '到期結算'
                            ELSE ' ' END
    INTO XPRODUCT_NAME
    FROM DUAL;


  RETURN XPRODUCT_NAME;

END F_GET_PRODUCT_NAME;

/

  GRANT EXECUTE ON "ECS"."F_GET_PRODUCT_NAME" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_REMOVE_CLOSE_FUND
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_REMOVE_CLOSE_FUND" 
--SELECT COLUMN_VALUE AS FUND_NO FROM TABLE(ECS.F_GET_REMOVE_CLOSE_FUND);
--SELECT COLUMN_VALUE AS FUND_NO FROM TABLE(ECS.F_GET_REMOVE_CLOSE_FUND('D162'));
-- =============================================
-- Author:      tingting
-- Create date: 2019/08/13
-- Description: 取得排除已清算的基金
-- =============================================
(
    WFUND_MASTER_NO     IN NVARCHAR2 := NULL      --母基金代碼
)
RETURN type_string_split_tab IS v_ret ECS.type_string_split_tab;

    XSYSDATE DATE := SYSDATE;

BEGIN

    SELECT FUND.FUND_NO
      BULK COLLECT
      INTO v_ret
      FROM FAS.FUND
      LEFT JOIN FAS.FUND_MASTER
        ON FUND_MASTER.FUND_MASTER_NO = FUND.FUND_MASTER_NO
     WHERE (WFUND_MASTER_NO IS NULL OR FUND_MASTER.FUND_MASTER_NO = WFUND_MASTER_NO)
       -- 2019.02.19 tingting 調整已清算基金條件語法
       AND (
             -- 境內基金清算日期判斷 CLEAR_DATE
             (     
               FUND.FUND_CATEGORY = '1' 
               AND  
               (
                 (FUND.CLEAR_DATE IS NULL) 
                 OR 
                 (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
               )
             )              
             OR
             -- 境外基金清算日期判斷 ELIMINATION_DATE
             (     
               FUND.FUND_CATEGORY = '2' 
               AND  
               (
                 -- 2018.10.15 JIANXIN 若是境外基金，清算日期要增加判斷 CLEAR_DATE 欄位
                 (FUND.ELIMINATION_DATE IS NULL AND FUND.CLEAR_DATE IS NULL) 
                 OR 
                 (XSYSDATE < FUND.ELIMINATION_DATE AND FUND.ELIMINATION_DATE IS NOT NULL)
                 OR 
                 (XSYSDATE < FUND.CLEAR_DATE AND FUND.CLEAR_DATE IS NOT NULL)
               )
             )
           )
    ORDER BY FUND.FUND_NO;

    RETURN v_ret;

END F_GET_REMOVE_CLOSE_FUND;

/

  GRANT EXECUTE ON "ECS"."F_GET_REMOVE_CLOSE_FUND" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_GET_RISK_LEVEL_MAPPING
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_GET_RISK_LEVEL_MAPPING" 
--SELECT * FROM TABLE(ECS.F_GET_RISK_LEVEL_MAPPING('1',TO_DATE('20181003','yyyyMMdd')));
-- =============================================
-- Author:      JIANXIN
-- Create date: 2018/10/03
-- Description: 取得風險屬性等級
-- =============================================
(
    WTYPE         IN VARCHAR2,  --適用類別 1:一般申購(含轉申購) 2:RSP
    WTX_DATE      IN DATE       --交易日期
)
RETURN TYPE_RISK_LEVEL_MAPPING_TABLE IS v_ret ECS.TYPE_RISK_LEVEL_MAPPING_TABLE;
BEGIN

    SELECT  TYPE_RISK_LEVEL_MAPPING_ROW(
            RISK_LEVEL_MAPPING.EFFECTIVE_DATE
           ,RISK_LEVEL_MAPPING.RISK_LEVEL
           ,RISK_LEVEL_MAPPING.RISK_CATEGORY
           ,RISK_LEVEL_MAPPING.TYPE
           ,RISK_LEVEL_MAPPING.CREATED_BY
           ,RISK_LEVEL_MAPPING.CREATION_DATE
           ,RISK_LEVEL_MAPPING.REVISED_BY
           ,RISK_LEVEL_MAPPING.REVISION_DATE
           ,RISK_LEVEL_MAPPING.REVIEWED_BY
           ,RISK_LEVEL_MAPPING.REVIEW_DATE
           ,RISK_LEVEL_MAPPING.STATUS)
      BULK COLLECT
      INTO v_ret
      FROM FAS.RISK_LEVEL_MAPPING
     WHERE RISK_LEVEL_MAPPING.EFFECTIVE_DATE = (SELECT MAX(EFFECTIVE_DATE) MAX_EFFECTIVE_DATE 
                                                  FROM FAS.RISK_LEVEL_MAPPING 
                                                 WHERE RISK_LEVEL_MAPPING.STATUS = 'R' 
                                                   AND EFFECTIVE_DATE <= WTX_DATE
                                               )
       AND RISK_LEVEL_MAPPING.TYPE = WTYPE
       AND RISK_LEVEL_MAPPING.STATUS = 'R';

    RETURN v_ret;

END F_GET_RISK_LEVEL_MAPPING;

/

  GRANT EXECUTE ON "ECS"."F_GET_RISK_LEVEL_MAPPING" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function F_SWS_GETDATELIST
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."F_SWS_GETDATELIST" --取得指定日期區間的每日之日期表
 (StartDate in date,
  EndDate in date)
return ECS.CalendarTypes
is
   r ECS.CalendarTypes;
   CurrDate      Date;
   YEAR_DAY      number(3);   --當年度的第幾天
   QUARTER_ID    number(1);   --當年度的第幾季
   WEEK_ID       number(2);   --第幾週
   WEEK_DAY      number(1);   --星期幾(0表示星期日)
   BUSS_ID   VARCHAR2(1);     --日曆之工作狀態(W.工作/H.休假)
   WEEK_ADD      number(1);
begin
  WEEK_ADD := 0;
  r := ECS.CalendarTypes();
  --CurrDate := TO_DATE(SUBSTRB(TO_CHAR(StartDate,'YYYYMMDD'),1,4)||'0101','YYYYMMDD');
  CurrDate := StartDate;
  while CurrDate <= EndDate
  loop
    IF SUBSTRB(TO_CHAR(CurrDate,'YYYYMMDD'),5,4) = '0101' THEN
      WEEK_ADD := 0;
    END IF;
    YEAR_DAY := to_number(to_char(CurrDate,'DDD'));
    QUARTER_ID := to_number(to_char(CurrDate,'Q'));
    WEEK_ID := to_number(to_char(CurrDate,'IW'));
    WEEK_DAY := to_number(to_char(CurrDate,'D')) - 1;
    BUSS_ID := case WEEK_DAY when 6 then 'H' when '0' then 'H' else 'W' end;
    IF QUARTER_ID = 1 AND WEEK_ID > 52 THEN
      WEEK_ID := WEEK_ID - 52;
      WEEK_ADD := 1;
    ELSE
      WEEK_ID := WEEK_ID + WEEK_ADD;
    END IF;
    IF WEEK_DAY = 0 THEN
      WEEK_ID := WEEK_ID + 1;
    END IF;
    IF QUARTER_ID = 1 AND WEEK_ID > 52 THEN
      WEEK_ID := 1;
    END IF;
    IF QUARTER_ID = 4 AND WEEK_ID = 1 THEN
      WEEK_ID := 53;
    END IF;
    IF CurrDate >= StartDate THEN
      r.extend;
      r(r.last) := ECS.CalendarType(CurrDate,YEAR_DAY,QUARTER_ID,WEEK_ID,WEEK_DAY,BUSS_ID,NULL);
    END IF;
    CurrDate := to_date(to_char(CurrDate+1,'yyyymmdd'),'yyyymmdd');
  end loop;
  return r;
end;

/

  GRANT EXECUTE ON "ECS"."F_SWS_GETDATELIST" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function PADLEFT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."PADLEFT" 
-- =============================================
-- Author: JIANXIN
-- Create date: 2019.06.06
-- Description:	文字不足左補字元
-- =============================================
(   
      WDATA   VARCHAR2
    , WLEN    NUMBER
    , WCR     VARCHAR2
)
RETURN VARCHAR2
IS 

  XStrLen INTEGER;
  XRetStr VARCHAR2(256);

BEGIN

  XRetStr := TRIM(WDATA);
  XStrLen := LENGTH(WDATA);

  IF WLEN > XStrLen THEN

    SELECT LPAD(WCR, WLEN - NVL(LENGTHB(XRetStr), 0), WCR) || SUBSTR(XRetStr, 1, WLEN) 
    --LPAD(XRetStr, WLEN - XStrLen,WCR)  
      INTO XRetStr
      FROM DUAL;

  END IF ;

  RETURN XRetStr;

END PADLeft;

/

  GRANT EXECUTE ON "ECS"."PADLEFT" TO "ECROBO";
--------------------------------------------------------
--  DDL for Function PADRIGHT
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE FUNCTION "ECS"."PADRIGHT" 
-- =============================================
-- Author: JIANXIN
-- Create date: 2019.06.06
-- Description:	文字不足右補字元
-- =============================================
(   
      WDATA   VARCHAR2
    , WLEN    NUMBER
    , WCR     VARCHAR2
)
RETURN VARCHAR2
IS 

  XStrLen INTEGER;
  XRetStr VARCHAR2(256);

BEGIN

  XRetStr := TRIM(WDATA);
  XStrLen := LENGTH(WDATA);

  IF WLEN > XStrLen THEN

    SELECT SUBSTR(XRetStr, 1, WLEN) || RPAD(WCR, WLEN - NVL(LENGTHB(XRetStr), 0), WCR)
      INTO XRetStr
      FROM DUAL;

  END IF ;

  RETURN XRetStr;

END PADRight;

/

  GRANT EXECUTE ON "ECS"."PADRIGHT" TO "ECROBO";
