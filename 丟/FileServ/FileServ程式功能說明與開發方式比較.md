# FileServ 程式功能說明與開發方式比較

## 一、程式概述

### 1.1 程式名稱與目的
- **w_mds17.srw** - EDW資料轉出作業（Fiserv Screening）
- **w_mds7b.srw** - EDW資料轉出作業（Fiserv Screening）

這兩個程式主要用於**企業資料倉儲（EDW）的資料轉出作業**，將基金系統的各種主檔和交易資料轉換成 CSV 格式檔案，供外部系統（Fiserv Screening）使用。

### 1.2 主要功能
1. **主檔資料轉出**：將各種主檔資料轉換成 CSV 格式
2. **交易明細轉出**：將基金交易明細轉換成 CSV 格式
3. **反洗錢資料處理**：處理 AML（Anti-Money Laundering）相關資料
4. **資料格式轉換**：處理字元編碼、日期格式、數值格式等
5. **檔案上傳**：支援檔案產生與上傳功能

---

## 二、詳細功能說明

### 2.1 主檔資料轉出功能

#### 2.1.1 分行主檔（BRANCH_MST_TWN）
- **功能**：轉出所有分行基本資料
- **資料來源**：`FAS.BRANCH`、`FAS.BROKER`
- **輸出欄位**：下載日期、分行代號、分行名稱、通路代號、通路名稱、區域代號、區域名稱
- **特殊處理**：根據郵遞區號自動判斷區域（北、中、南）

#### 2.1.2 付款方式主檔（PAYMENT_TYPE_MST_TWN）
- **功能**：轉出付款方式代碼與名稱對照
- **資料來源**：`FAS.PAY_TYPE`
- **輸出欄位**：下載日期、付款方式代號、付款方式名稱
- **特殊處理**：贖回的付款方式代號與申購不同，需額外 hardcode 轉出（代號 7-10）

#### 2.1.3 交易類型主檔（TRANS_TYPE_MST_TWN）
- **功能**：轉出交易類型代碼與名稱對照
- **資料來源**：`FAS.TX_TYPE`
- **輸出欄位**：下載日期、交易類型代號、交易類型描述
- **特殊處理**：包含 DAM（委託資產管理）的交易類型（代號 4、5）

#### 2.1.4 業務員主檔（SALES_MST_TWN）
- **功能**：轉出所有業務員基本資料
- **資料來源**：`FAS.SALES`
- **輸出欄位**：業務員編號、姓名、通路代號、分行代號、狀態、部門代號

#### 2.1.5 部門主檔（DEPT_MST_TWN）
- **功能**：轉出所有部門基本資料
- **資料來源**：`FAS.DEPT`
- **輸出欄位**：部門代號、部門名稱

#### 2.1.6 客戶主檔（CUSTOMER_MST_TWN）
- **功能**：轉出客戶基本資料
- **資料來源**：`FAS.HOLDER`、`FAS.DAM_HOLDER`
- **輸出欄位**：包含客戶 ID、姓名、地址、郵遞區號、聯絡人、電話、傳真、電子郵件、職業、業務員編號等 20+ 個欄位
- **特殊處理**：
  - 處理客戶開戶日期、完成日期、境外日期
  - 處理客戶類型（個人、法人）
  - 處理定額扣款人資料
  - 處理 DAM 客戶資料

#### 2.1.7 台灣假日行事曆（TWN_HOLIDAY_CALENDAR）
- **功能**：轉出台灣假日行事曆
- **資料來源**：`FAS.CALENDAR`
- **輸出欄位**：企業代碼、行事曆代碼、假日日期、假日名稱

### 2.2 交易明細轉出功能

#### 2.2.1 單位交易明細（UNIT_TRANSACTION_ACT_TWN）
- **功能**：轉出基金申購、贖回、轉換等交易明細
- **資料來源**：`FAS.JOURNAL`、`FAS.PURCHASE`、`FAS.REDEMPTION`、`FAS.PERIODIC_PURCHASE`
- **輸出欄位**：下載日期、交易日期、交易序號、通路代號、分行代號、付款方式、交易類型、客戶 ID、業務員編號、基金代號、轉換標記、單位數、金額
- **複雜業務邏輯**：
  1. **不同基金類型的交易日計算**：
     - **境內基金（股票/債券型）**：
       - 申購：轉出 T 日交易
       - 贖回：轉出 T-1 日交易
     - **境內基金（海外型）**：
       - 申購：轉出 T-1 日交易
       - 贖回：轉出 T-2 日交易
     - **境外基金（IOF）**：
       - 申購：轉出 T-1 日交易
       - 贖回：轉出 T-1 日交易
     - **境外基金（M&G）**：
       - 申購：轉出 T-1 日交易
       - 贖回：轉出 T-1 日交易
     - **Japan REIT's（境外私募基金）**：
       - 申購：轉出 T 日交易
       - 贖回：僅在每月 1 日轉出上月最後一個淨值日的交易
  2. **匯率轉換**：
     - 非台幣基金需轉換成台幣
     - 根據交易確認日（AC_DATE）判斷使用當月底或上月底匯率
     - 需考慮基金營業日與台灣營業日的差異
  3. **多帳戶贖回分攤**：
     - 當一筆贖回匯至多個帳戶時，需按比例分攤單位數和金額
     - 需考慮買回費用、短線費用、績效費用的分攤
  4. **DAM 交易處理**：
     - DAM 委託/增資視為申購交易
     - DAM 到期解約/減資視為贖回交易
     - DAM 可於當天日結，故轉出當天交易
  5. **境外基金補轉邏輯**：
     - 當境內假日但境外非假日時，需補轉前一營業日資料

#### 2.2.2 今日交易明細（UNIT_TRANSACTION_ACT_TWN_TODAY）
- **功能**：轉出當日交易明細（用於即時處理）
- **邏輯**：與一般交易明細類似，但僅處理當日資料

### 2.3 反洗錢資料處理功能

#### 2.3.1 AML 資料轉出（AML_PSIT）
- **功能**：轉出反洗錢相關的客戶資料
- **資料來源**：`FAS.HOLDER`、`FAS.DAM_HOLDER`、`FAS.PERIODIC`、`FAS.PURCHASE`、`FAS.REDEMPTION` 等
- **處理邏輯**：
  1. **資料類型分類**：
     - **受益人**：本人、負責人/法定代理人、定額扣款人、集合帳戶子帳戶、董監事及持股超過25%最終受益人
     - **供應商**：本人、負責人/法定代理人
     - **員工**：本人
  2. **觸發條件**：當日有變動的客戶資料
     - 客戶開戶/完成/境外日期變動
     - 定額扣款設定
     - 申購交易
     - 贖回交易
     - 定額扣款交易
  3. **參考編號規則**：`DATA_SOURCE-ACCOUNT_NO-TYPE-SEQ`
     - DATA_SOURCE：1=受益人、2=供應商、3=員工
     - ACCOUNT_NO：客戶戶號（10碼）
     - TYPE：1=本人、2=法定代理人/負責人、3=定額扣款人、4=集合帳戶子帳戶、5=董監事及持股超過25%最終受益人
     - SEQ：序號（6碼）
  4. **特殊處理**：
     - 星期五遇假日時，轉出類型為 'Y'（週末轉出）
     - 檢查重複執行，避免重複轉出
     - 處理字元編碼轉換（UTF-8、Big5、ANSI）

### 2.4 其他功能

#### 2.4.1 TWCRCAF1 檔案轉出
- **功能**：轉出特定格式的客戶資料檔案
- **用途**：供外部系統使用

#### 2.4.2 檔案上傳功能
- **功能**：支援將產生的 CSV 檔案上傳至指定路徑
- **路徑設定**：可設定檔案儲存路徑
- **上傳模式**：支援重新上傳功能

---

## 三、程式執行模式

### 3.1 執行模式選項
1. **產生檔案（rb_generate）**：僅產生 CSV 檔案，不上傳
2. **上傳檔案（rb_upload）**：上傳已產生的檔案
3. **今日資料（rb_today_data）**：處理當日資料
4. **前一日資料（rb_previous_data）**：處理前一日資料
5. **期間資料（rb_period）**：處理指定期間的資料
6. **全部期間（rb_period_all）**：處理所有期間的資料

### 3.2 檔案選擇
使用者可勾選要產生的檔案類型：
- ☑ 分行主檔
- ☑ 付款方式主檔
- ☑ 交易類型主檔
- ☑ 業務員主檔
- ☑ 部門主檔
- ☑ 客戶主檔
- ☑ 假日行事曆
- ☑ 單位交易明細
- ☑ 今日單位交易明細
- ☑ AML 資料
- ☑ TWCRCAF1 檔案

### 3.3 執行記錄
- **記錄位置**：`FAC.EDW_EXPORT_LOG`
- **記錄內容**：轉出時間、交易日期、檔案名稱、執行人員、狀態（成功/失敗）

---

## 四、技術特點

### 4.1 字元編碼處理
- **UTF-8 轉 Big5**：處理 Unicode 字元轉換
- **ANSI 轉 Big5**：處理 ANSI 編碼轉換
- **CSV 格式處理**：處理逗號、引號等特殊字元

### 4.2 日期處理
- **營業日計算**：根據不同基金的營業日曆計算前一營業日
- **相對日期計算**：計算相對日期（T-1、T-2 等）
- **日期格式轉換**：將資料庫日期格式轉換成 CSV 需要的格式（dd/mm/yyyy）

### 4.3 數值處理
- **匯率轉換**：根據交易確認日取得適當匯率並轉換
- **金額計算**：處理多帳戶分攤、費用分攤等複雜計算
- **單位數計算**：根據 NAV 計算單位數

### 4.4 資料驗證
- **重複執行檢查**：檢查是否已執行過相同日期的轉出作業
- **資料完整性檢查**：檢查必要欄位是否為空
- **錯誤處理**：完整的錯誤訊息與回滾機制

---

## 五、自己寫程式 vs Power Query 比較

### 5.1 自己寫程式（PowerBuilder）的優點

#### ✅ 優點
1. **完整的業務邏輯控制**
   - 可以精確控制每個步驟的執行順序
   - 可以處理複雜的條件判斷（如不同基金類型的交易日計算）
   - 可以處理複雜的資料關聯（如多帳戶贖回分攤）

2. **高效能處理**
   - 可以直接連接資料庫，執行效率高
   - 可以批次處理大量資料
   - 可以優化 SQL 查詢效能

3. **複雜計算能力**
   - 可以處理複雜的匯率轉換邏輯
   - 可以處理多層次的資料關聯
   - 可以處理複雜的日期計算（營業日、相對日期等）

4. **錯誤處理與回滾**
   - 完整的錯誤處理機制
   - 資料庫交易回滾功能
   - 詳細的錯誤訊息記錄

5. **檔案格式控制**
   - 可以精確控制 CSV 格式（欄位順序、引號、逗號等）
   - 可以處理特殊字元編碼轉換
   - 可以處理 COBOL 格式轉換

6. **執行記錄與稽核**
   - 完整的執行記錄功能
   - 可以記錄執行人員、時間、狀態等
   - 可以檢查重複執行

#### ❌ 缺點
1. **開發時間長**
   - 需要撰寫大量程式碼（兩個程式共約 22,000 行）
   - 需要處理各種邊界情況
   - 需要完整的測試

2. **維護成本高**
   - 業務邏輯變更時需要修改程式碼
   - 需要熟悉 PowerBuilder 語法
   - 需要了解複雜的業務邏輯

3. **擴充性較差**
   - 新增檔案類型需要修改程式碼
   - 修改邏輯需要重新編譯部署

### 5.2 Power Query 的優點

#### ✅ 優點
1. **快速開發**
   - 視覺化介面，不需要寫太多程式碼
   - 可以快速建立資料轉換流程
   - 可以快速測試與調整

2. **易於維護**
   - 邏輯變更時可以快速調整
   - 不需要重新編譯部署
   - 可以透過介面直接修改

3. **易於擴充**
   - 新增檔案類型可以快速新增查詢
   - 可以模組化設計

4. **資料預覽**
   - 可以即時預覽轉換結果
   - 可以快速發現資料問題

#### ❌ 缺點
1. **複雜業務邏輯處理困難**
   - **交易日計算**：Power Query 難以處理不同基金類型的複雜交易日計算邏輯（T、T-1、T-2，且需考慮營業日）
   - **多帳戶分攤**：難以處理多帳戶贖回的分攤計算（需查詢 NAV、計算比例、分攤費用等）
   - **匯率轉換**：難以處理複雜的匯率取得邏輯（需判斷交易確認日、判斷月底、判斷營業日等）

2. **效能問題**
   - 大量資料處理時效能較差
   - 複雜查詢可能導致記憶體不足
   - 無法像 PowerBuilder 一樣直接優化 SQL

3. **錯誤處理能力有限**
   - 錯誤處理機制不如程式語言完整
   - 難以實現資料庫交易回滾
   - 錯誤訊息不夠詳細

4. **檔案格式控制**
   - CSV 格式控制不如程式語言精確
   - 字元編碼轉換功能有限
   - 難以處理 COBOL 格式

5. **執行記錄與稽核**
   - 難以實現完整的執行記錄功能
   - 難以檢查重複執行
   - 難以記錄詳細的執行狀態

6. **資料庫連接限制**
   - Power Query 主要用於 Excel/Power BI，連接資料庫需要額外設定
   - 無法像 PowerBuilder 一樣直接使用資料庫連線池
   - 無法實現複雜的資料庫交易控制

### 5.3 結論與建議

#### 🎯 **建議：自己寫程式（PowerBuilder）較適合**

**原因：**

1. **業務邏輯複雜度高**
   - 這個系統涉及大量複雜的業務邏輯（不同基金類型的交易日計算、匯率轉換、多帳戶分攤等）
   - Power Query 難以處理這些複雜邏輯

2. **資料量龐大**
   - 需要處理大量交易明細資料
   - Power Query 在大量資料處理時效能較差

3. **資料完整性要求高**
   - 需要完整的錯誤處理與回滾機制
   - 需要執行記錄與稽核功能
   - Power Query 難以實現這些功能

4. **檔案格式要求嚴格**
   - 需要精確控制 CSV 格式
   - 需要處理特殊字元編碼
   - Power Query 難以實現這些需求

#### 📊 **適用場景比較**

| 項目 | 自己寫程式（PowerBuilder） | Power Query |
|------|---------------------------|-------------|
| **簡單資料轉換** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **複雜業務邏輯** | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **大量資料處理** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **錯誤處理** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |
| **執行記錄** | ⭐⭐⭐⭐⭐ | ⭐⭐ |
| **開發速度** | ⭐⭐ | ⭐⭐⭐⭐⭐ |
| **維護成本** | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| **擴充性** | ⭐⭐⭐ | ⭐⭐⭐⭐ |

#### 💡 **建議方案**

1. **繼續使用 PowerBuilder 開發**
   - 對於這種複雜的資料轉出作業，PowerBuilder 仍然是較好的選擇
   - 可以確保業務邏輯的正確性與資料完整性

2. **優化現有程式**
   - 可以將部分邏輯模組化，提高程式碼重用性
   - 可以優化 SQL 查詢，提高執行效能
   - 可以加強錯誤處理與記錄功能

3. **Power Query 的適用場景**
   - 適合用於**簡單的資料轉換**（如主檔資料轉出）
   - 適合用於**資料分析與報表**（如資料預覽、資料驗證）
   - 不適合用於**複雜的交易明細轉出**（如單位交易明細、AML 資料）

---

## 六、總結

### 6.1 程式功能總結
這兩個程式是**企業資料倉儲（EDW）的資料轉出作業系統**，主要功能包括：
1. **主檔資料轉出**：轉出各種主檔資料（分行、付款方式、交易類型、業務員、部門、客戶、假日行事曆）
2. **交易明細轉出**：轉出基金交易明細（申購、贖回、轉換等）
3. **反洗錢資料處理**：轉出 AML 相關的客戶資料
4. **檔案格式轉換**：處理字元編碼、日期格式、數值格式等

### 6.2 技術特點總結
- **複雜的業務邏輯**：不同基金類型的交易日計算、匯率轉換、多帳戶分攤等
- **完整的錯誤處理**：錯誤訊息、回滾機制、執行記錄等
- **精確的檔案格式控制**：CSV 格式、字元編碼、COBOL 格式等

### 6.3 開發方式建議
**建議繼續使用 PowerBuilder 開發**，因為：
1. 業務邏輯複雜度高，Power Query 難以處理
2. 資料量龐大，需要高效能處理
3. 資料完整性要求高，需要完整的錯誤處理與記錄功能
4. 檔案格式要求嚴格，需要精確控制

**Power Query 適合用於**：
- 簡單的資料轉換作業
- 資料分析與報表
- 資料預覽與驗證

---

## 七、相關檔案清單

### 7.1 程式檔案
- `w_mds17.srw` - EDW資料轉出作業（Fiserv Screening）
- `w_mds7b.srw` - EDW資料轉出作業（Fiserv Screening）

### 7.2 相關資料表
- `FAC.EDW_EXPORT_LOG` - 轉出記錄檔
- `FAS.AML_EXPORT_LIST` - AML 轉出清單
- `FAS.AML_EXPORT_LOG` - AML 轉出記錄
- `FAS.BRANCH` - 分行主檔
- `FAS.BROKER` - 通路主檔
- `FAS.PAY_TYPE` - 付款方式主檔
- `FAS.TX_TYPE` - 交易類型主檔
- `FAS.SALES` - 業務員主檔
- `FAS.DEPT` - 部門主檔
- `FAS.HOLDER` - 客戶主檔
- `FAS.DAM_HOLDER` - DAM 客戶主檔
- `FAS.CALENDAR` - 假日行事曆
- `FAS.JOURNAL` - 日記帳
- `FAS.PURCHASE` - 申購交易
- `FAS.REDEMPTION` - 贖回交易
- `FAS.PERIODIC` - 定額扣款設定
- `FAS.PERIODIC_PURCHASE` - 定額扣款交易
- `FAS.FUND` - 基金主檔
- `FAS.CURRENCY_RATE` - 匯率主檔
- `NAV.NAV` - 淨值主檔

---

**文件建立日期**：2024年
**文件版本**：1.0

