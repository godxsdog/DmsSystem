# MDS373_ALL 完整業務流程說明

## 目錄
1. [系統概述](#系統概述)
2. [基礎設定作業](#基礎設定作業)
3. [通路回饋計算作業](#通路回饋計算作業)
4. [報表查詢作業](#報表查詢作業)
5. [特殊處理作業](#特殊處理作業)
6. [完整作業流程圖](#完整作業流程圖)

---

## 系統概述

### 系統目的
MDS373 系統是**通路回饋管理系統**，主要用於管理與計算基金銷售通路（代銷機構）的回饋獎金。系統涵蓋從參數設定、資料計算、到報表產出的完整流程。

### 核心資料表
- **CHANNEL_BONUS_MASTER** - 通路回饋主檔（代銷機構基本資料）
- **CHANNEL_BONUS_SET** - 獎金群組設定（計算生效日、計算類型、費率級距等）
- **CHANNEL_BONUS_FUND** - 基金清單（單一基金計算用）
- **CHANNEL_BONUS_FUND_BEL** - 後收基金清單（後收基金服務費計算用）
- **CHANNEL_BONUS_DETAIL** - 費率級距明細（獎金計算的級距設定）
- **CHANNEL_BONUS_DETAIL_FUND** - 基金類型費率設定（不同基金類型可設定不同費率）
- **CHANNEL_BONUS** - 通路回饋計算結果檔（計算後的獎金明細）
- **CHANNEL_BONUS_BROKER** - 代銷ID清單（代銷機構下的所有ID）
- **CHANNEL_BONUS_SHARE** - 自有資金扣除單位數設定
- **CHANNEL_BONUS_EXG_RATE** - 轉換匯率設定
- **CHANNEL_BONUS_MF_RATE** - 基金經理費率設定
- **CHANNEL_BONUS_EX_ID** - 代銷排除ID設定

---

## 基礎設定作業

### 一、MDS37321/37322 - 通路回饋參數設定作業

#### 1.1 程式目的
設定境內/境外基金的通路回饋參數，包含主檔、獎金群組、基金清單、費率級距等所有計算所需的基礎資料。

#### 1.2 作業流程

##### 步驟1：主檔設定（dw_1）
- **資料來源**：`MDS.CHANNEL_BONUS_MASTER`
- **關鍵欄位**：
  - `BROKER_NO` - 銷售機構代碼
  - `ID` - 銷售機構ID
  - `COMP_ID` - 合併ID（用於合併計算）
  - `BROKER_TYPE` - 是否代銷（Y=代銷, N=非代銷）
  - `OFFSHORE_TYPE` - 境內/境外（1=境內, 2=境外）
  - `STATUS` - 資料狀態（U=未確認, O=有效, C=無效）
  - `PAY_TYPE` - 付款週期（M=月, Q=季, S=半年）
  - `FUM_PER_TYPE` - 自有資金類型
  - `MA_TYPE` - 是否為MA類型
  - `REPORT_CB4` - 是否勾選傳真（通路回饋明細表）
  - `REPORT_CB5` - 是否勾選傳真（後收基金通路服務費明細表）

- **控制規則**：
  - 資料新增後不可刪除
  - 資料註記無效後不可變更
  - 資料變更後狀態會回覆至未確認
  - 資料未確認時，無法變更中/下半部資料

##### 步驟2：獎金群組設定（tabpage_1 - dw_detail）
- **資料來源**：`MDS.CHANNEL_BONUS_SET`
- **關鍵欄位**：
  - `SEQ` - 序號（自動產生）
  - `EFFECTIVE_DATE` - **計算生效日**（重要！決定何時開始計算）
  - `TERMINATION_DATE` - 終止日期
  - `CAL_TYPE` - 計算類型（1=群組計算, 2=單一基金計算, 3=群組+單一基金）
  - `CAL_WAY` - 計算方式（1=平均餘額×經理費率×分享比率, 2=平均餘額×分享比率, 3=平均餘額×分享比率, 4=平均餘額×經理費率×分享比率/12）
  - `AMOUNT_TYPE` - 金額計算類型（1=非級距式, 2=級距式）
  - `FUND_GROUP` - 基金群組（PCA, IOF, M&G, OFF, VON, OFV等）
  - `FUND_TYPE` - 基金類型（B, C, E, D, M, E+D, NM等）
  - `FUND_AREA_TYPE` - 基金區域類型（N/A, T, NT）
  - `FUND_CRNCY_CD` - 基金幣別
  - `CRNCY_CD` - 計算幣別
  - `PAY_CRNCY_CD` - 付款幣別
  - `PAY_DATE` - 付款日

- **確認機制**：
  - 確認時會自動帶入符合條件的基金清單
  - 若基金已終止交易，則註記為無效
  - 確認人員不可與維護人員同一人

##### 步驟3：基金清單設定（tabpage_3 - dw_fund_list）
- **資料來源**：`MDS.CHANNEL_BONUS_FUND`
- **適用條件**：僅當 `CAL_TYPE = '2'`（單一基金計算）時才可新增
- **關鍵欄位**：
  - `FUND_NO` - 基金代碼
  - `EFFECTIVE_DATE` - 生效日
  - `TERMINATION_DATE` - 終止日期
  - `PAY_DATE` - 付款日

- **驗證邏輯**：
  - 基金清單的 `EFFECTIVE_DATE` 必須與獎金群組的 `EFFECTIVE_DATE` 一致
  - 若不一致，系統會顯示錯誤：`基金清單: [基金代碼] 與獎金群組序號: [序號] [計算生效日]不同`
  - 不可重複設定同一基金
  - 不可設定法人級別基金

##### 步驟4：費率級距設定（tabpage_4 - dw_rang）
- **資料來源**：`MDS.CHANNEL_BONUS_DETAIL`ㄕ
- **關鍵欄位**：
  - `EFFECTIVE_DATE` - 生效日（可設定多個生效日，支援月中調整）
  - `LOW_AMOUNT` - 級距下限
  - `HIGH_AMOUNT` - 級距上限
  - `SHARE_RATE` - 分享比率
  - `CAL_WAY` - 計算方式（必須與獎金群組的計算方式一致）

- **控制規則**：
  - 若 `AMOUNT_TYPE = '2'`（級距式），可設定多個級距（最多5個）
  - 若 `AMOUNT_TYPE = '1'`（非級距式），只需設定一個級距
  - 費率級距的公式類型必須與獎金群組公式類型相同

##### 步驟5：基金類型費率設定（tabpage_4 - dw_rang_fund）
- **資料來源**：`MDS.CHANNEL_BONUS_DETAIL_FUND`
- **適用條件**：僅當 `AMOUNT_TYPE = '1'`（非級距式）時才可新增
- **關鍵欄位**：
  - `FUND_TYPE` - 基金類型（BD, NM, FF, BL, PR, MA等）
  - `SHARE_RATE_FUND` - 基金類型分享比率

- **邏輯說明**：
  - 若基金類型費率 <> 0，則用基金類型費率取代原費率
  - 群組計算採金額差額級距時，不可設定基金類型分享比率

##### 步驟6：代銷排除ID設定（tabpage_5 - dw_ex_id）
- **資料來源**：`MDS.CHANNEL_BONUS_EX_ID`
- **適用條件**：僅當 `BROKER_TYPE = 'Y'`（代銷）時才顯示
- **關鍵欄位**：
  - `EX_ID` - 排除的ID

- **邏輯說明**：
  - 設定後，計算時會排除這些ID的資料
  - 用於特殊情況，例如某些ID不參與獎金計算

##### 步驟7：後收基金設定（tabpage_6 - dw_fund_bel_list）
- **資料來源**：`MDS.CHANNEL_BONUS_FUND_BEL`
- **關鍵欄位**：
  - `FUND_NO` - 基金代碼
  - `EFFECTIVE_DATE` - **生效日**（重要！決定何時開始計算後收基金服務費）
  - `TERMINATION_DATE` - 終止日期
  - `PAY_DATE` - 付款日

- **邏輯說明**：
  - 用於後收基金通路服務費的計算
  - 生效日必須正確設定，否則會影響報表資料的完整性

##### 步驟8：重要說明設定（tabpage_2 - dw_memo）
- **資料來源**：`MDS.CHANNEL_BONUS_MEMO`
- **用途**：記錄重要說明事項

##### 步驟9：帶入基金清單（cb_8 按鈕）
- **功能**：根據獎金群組的設定條件，自動帶入符合條件的基金清單
- **執行條件**：
  - 獎金群組狀態必須為 `O`（有效）
  - 計算類型必須為 `CAL_TYPE = '2'`（單一基金計算）
- **執行邏輯**：
  1. 讀取所有有效的獎金群組
  2. 根據 `FUND_GROUP`、`FUND_TYPE`、`FUND_AREA_TYPE`、`FUND_CRNCY_CD` 等條件
  3. 從 `FAS.FUND` 中篩選符合條件的基金
  4. 自動插入到 `MDS.CHANNEL_BONUS_FUND` 和 `MDS.CHANNEL_BONUS_FUND_BEL`
  5. 若基金已終止交易，則註記為無效

##### 步驟10：資料確認
- **確認項目**：
  - 主檔確認（cb_1）
  - 獎金群組確認（cb_2）
  - 重要說明確認（cb_3）
  - 代銷排除確認（cb_4）
  - 基金清單確認（cb_5）
  - 費率級距確認（cb_6）
  - 後收基金確認（cb_9）

- **確認規則**：
  - 確認人員不可與維護人員同一人
  - 確認後狀態變為 `O`（有效）
  - 取消確認後狀態變為 `U`（未確認）

### 二、MDS37323 - 通路回饋方案設定檢核表

#### 2.1 程式目的
檢核通路回饋方案設定的完整性，確保所有必要資料都已設定完成。

#### 2.2 檢核項目
- 主檔是否已確認
- 獎金群組是否已設定
- 基金清單是否已設定
- 費率級距是否已設定
- 生效日是否正確
- 終止日期是否正確

### 三、MDS37324 - 通路回饋方案相關日期設定明細表

#### 3.1 程式目的
查詢所有通路回饋方案相關的日期設定，包括生效日、終止日、付款日等。

### 四、MDS37325 - 通路回饋方案設定未確認統計表

#### 4.1 程式目的
統計尚未確認的通路回饋方案設定資料，提醒使用者進行確認。

### 五、MDS37326 - 通路回饋方案代銷排除ID設定檢核表

#### 5.1 程式目的
檢核代銷排除ID設定的正確性。

### 六、MDS37327/37328 - 自有資金單位數設定

#### 6.1 程式目的
設定自有資金扣除單位數，用於計算時扣除自有資金部分。

#### 6.2 關鍵欄位
- `BROKER_NO` - 銷售機構代碼
- `ID` - 銷售機構ID
- `FUND_NO` - 基金代碼
- `EFFECTIVE_DATE` - 生效日
- `TERMINATION_DATE` - 終止日期
- `SHARES` - 扣除單位數

#### 6.3 邏輯說明
- 計算時會扣除自有資金單位數對應的金額
- 用於特殊情況，例如某些自有資金不參與獎金計算

### 七、MDS37329 - 轉換匯率設定

#### 7.1 程式目的
設定各種幣別之間的轉換匯率，用於獎金計算時的幣別轉換。

#### 7.2 關鍵欄位
- `AC_DATE` - 會計日期
- `ORG_CRNCY` - 原始幣別
- `EXG_CRNCY` - 轉換幣別
- `EXG_RATE` - 轉換匯率

#### 7.3 邏輯說明
- 計算時會根據會計日期和幣別，自動取得對應的匯率
- 若原始幣別與轉換幣別相同，匯率為 1
- 若未設定匯率，計算作業會失敗

### 八、MDS3733 - 通路回饋基金經理費率設定

#### 8.1 程式目的
設定各基金的經理費率，用於獎金計算。

#### 8.2 關鍵欄位
- `FUND_NO` - 基金代碼
- `CALENDAR_DATE` - 日曆日期
- `MF_RATE` - 經理費率
- `MF_RATE_F` - 經理費率（前端輸入）

#### 8.3 邏輯說明
- 系統會檢查是否有新基金未設定經理費率
- 計算時會根據日期取得對應的經理費率
- 若未設定經理費率，計算作業會失敗

---

## 通路回饋計算作業

### MDS3736 - 通路回饋計算作業

#### 程式目的
根據設定的參數，計算所有通路回饋獎金。這是整個系統最核心的計算作業。

#### 完整計算流程（共15個主要步驟）

##### Step0：填入執行記錄開始時間
- 記錄計算作業開始時間到 `DMS.PRG_LOG`
- 用於追蹤計算作業的執行狀況

##### Step1：檢查必要資料
- **檢查項目**：
  1. 檢查是否有有效的通路回饋主檔
  2. 檢查是否有有效的獎金群組設定
  3. 檢查是否有有效的基金清單
  4. 檢查是否有有效的費率級距設定
  5. 檢查是否有必要的匯率設定

- **檢查邏輯**：
  - 若缺少必要資料，計算作業會失敗並回滾

##### Step2：取得計算參數
- **輸入參數**：
  - `ld_begin_date` - 計算起始日期（通常為月初）
  - `ld_end_date` - 計算結束日期（通常為月底）
  - `ls_id` - 銷售機構ID（可為 'ALL' 表示全部）
  - `ls_type` - 基金類型（1=境內, 2=境外, 4=境外MA）
  - `ls_fund_no_temp` - 基金代碼篩選條件

- **計算參數**：
  - `ll_days` - 計算天數（月底日期 - 月初日期 + 1）
  - `ll_tot_days` - 總天數（用於平均計算）
  - `ld_m_pay` - 月付付款日
  - `ld_q_pay` - 季付付款日
  - `ld_s_pay` - 半年付付款日

##### Step3：檢查匯率設定
- **檢查邏輯**：
  1. 取得所有獎金群組使用的幣別
  2. 取得所有基金使用的幣別
  3. 檢查所有幣別組合的匯率是否已設定
  4. 若未設定，自動建立匯率為 1 的記錄（相同幣別）
  5. 若不同幣別且未設定匯率，計算作業會失敗

##### Step4：清空舊資料
- **刪除範圍**：
  1. 刪除 `MDS.CHANNEL_BONUS` 中符合條件的舊資料
  2. 刪除 `MDS.CHANNEL_BONUS_BROKER` 中符合條件的舊資料

- **刪除條件**：
  - 符合計算日期範圍
  - 符合基金類型
  - 符合銷售機構ID

##### Step5：填入初始化資料

###### Step5.0：填入代銷的ID清單
- **資料來源**：`FAS.CERTIFICATE`（憑證檔）
- **邏輯說明**：
  1. 根據 `CHANNEL_BONUS_MASTER` 和 `CERTIFICATE` 的關聯
  2. 取得所有代銷機構下的ID清單
  3. 插入到 `MDS.CHANNEL_BONUS_BROKER`
  4. 排除已設定在 `CHANNEL_BONUS_EX_ID` 中的ID

###### Step5.1：填入單一基金的資料
- **適用條件**：`CAL_TYPE = '2'`（單一基金計算）
- **邏輯說明**：
  1. 根據 `CHANNEL_BONUS_SET`、`CHANNEL_BONUS_MASTER`、`CHANNEL_BONUS_FUND` 的關聯
  2. 取得所有符合條件的基金
  3. 插入到 `MDS.CHANNEL_BONUS`
  4. 初始化所有計算欄位為 0

###### Step5.2：填入群組基金的資料
- **適用條件**：`CAL_TYPE = '1'`（群組計算）
- **邏輯說明**：
  1. 根據 `CHANNEL_BONUS_SET` 的 `FUND_GROUP`、`FUND_TYPE`、`FUND_CRNCY_CD` 等條件
  2. 從 `FAS.FUND` 中篩選符合條件的基金
  3. 根據基金群組類型（PCA, IOF, M&G等）和基金類型（B, C, E, D等）進行複雜的對應
  4. 插入到 `MDS.CHANNEL_BONUS`
  5. 初始化所有計算欄位為 0

##### Step6：清除簽呈簽訂日為空或在日期範圍外的資料
- **邏輯說明**：
  - 若 `CONTRACT_DATE`（簽呈簽訂日）為空或大於計算結束日期
  - 則刪除該筆資料（因為不在計算範圍內）

##### Step7：填入新的計算範圍
- **邏輯說明**：
  1. 設定 `TERM_FROM1` 和 `TERM_TO1`（實際計算日期範圍）
  2. 若 `CONTRACT_DATE <= TERM_FROM`，則 `TERM_FROM1 = TERM_FROM`
  3. 若 `CONTRACT_DATE > TERM_FROM`，則 `TERM_FROM1 = CONTRACT_DATE`
  4. `TERM_TO1 = TERM_TO`（計算結束日期）

##### Step8：填入自有資金扣除單位數
- **邏輯說明**：
  1. 從 `MDS.CHANNEL_BONUS_SHARE` 取得自有資金扣除單位數
  2. 根據生效日和終止日期，判斷是否在計算範圍內
  3. 填入 `DEDUCT_SHARES`（扣除單位數）
  4. 填入 `SHARES_DATE_FROM` 和 `SHARES_DATE_TO`（扣除期間）
  5. 若未設定自有資金扣除，則設為 0

##### Step9：填入計算參數（EFFECTIVE_DATE、CANCEL_DATE、MF_RATE、EXG_RATE）

###### Step9.0：填入MF_RATE、EXG_RATE、NTD_RATE、PAY_RATE
- **MF_RATE（經理費率）**：
  - 從 `MDS.V_CHANNEL_BONUS_MF_RATE` 和 `FAS.NAV` 取得
  - 計算期間內的平均經理費率

- **EXG_RATE（轉換匯率）**：
  - 從 `MDS.CHANNEL_BONUS_EXG_RATE` 取得
  - 原始幣別轉換為計算幣別的匯率

- **NTD_RATE（台幣匯率）**：
  - 從 `MDS.CHANNEL_BONUS_EXG_RATE` 取得
  - 計算幣別轉換為台幣的匯率

- **PAY_RATE（付款幣別匯率）**：
  - 從 `MDS.CHANNEL_BONUS_EXG_RATE` 取得
  - 付款幣別轉換為台幣的匯率

###### Step9.1：計算EFFECTIVE_DATE、CANCEL_DATE、BAL_AMOUNT（非代銷）
- **適用條件**：`BROKER_TYPE = 'N'`（非代銷）
- **計算邏輯**：
  1. 從 `FAS.CERTIFICATE` 和 `FAS.NAV` 取得憑證資料
  2. 計算 `EFFECTIVE_DATE`（最早有資料的日期）
  3. 計算 `CANCEL_DATE`（最晚有資料的日期）
  4. 計算 `BAL_AMOUNT`（餘額 = 單位數 × NAV）
  5. 扣除自有資金：`BAL_AMOUNT = BAL_AMOUNT - (自有資金單位數 × NAV)`
  6. 計算 `AVG_AMOUNT`（平均餘額 = BAL_AMOUNT / 天數）
  7. 計算 `MF_AMOUNT`（經理費金額 = BAL_AMOUNT × MF_RATE / 總天數）

- **特殊處理**：
  - 安聯人壽委託瀚亞投信投資帳戶-富利平衡（ID=990214092）需扣除自有基金
  - 從 `MDS.MDS436_DATA_FA` 取得自有基金資料進行扣除

###### Step9.2：計算EFFECTIVE_DATE、CANCEL_DATE、BAL_AMOUNT（代銷）
- **適用條件**：`BROKER_TYPE = 'Y'`（代銷）
- **計算邏輯**：
  1. 從 `FAS.CERTIFICATE` 和 `FAS.NAV` 取得憑證資料
  2. 根據 `CHANNEL_BONUS_BROKER` 中的ID清單進行篩選
  3. 計算 `EFFECTIVE_DATE`、`CANCEL_DATE`、`BAL_AMOUNT`
  4. 扣除自有資金
  5. 計算 `AVG_AMOUNT` 和 `MF_AMOUNT`

##### Step10：填入轉換金額
- **邏輯說明**：
  1. 若計算幣別與原始幣別相同，`EXG_RATE = 1`
  2. 計算 `EXG_BAL_AMOUNT`（轉換後餘額 = BAL_AMOUNT × EXG_RATE）
  3. 計算 `EXG_AVG_AMOUNT`（轉換後平均餘額 = AVG_AMOUNT × EXG_RATE）
  4. 計算 `EXG_MF_AMOUNT`（轉換後經理費金額 = MF_AMOUNT × EXG_RATE）
  5. 刪除餘額為 0 的資料

##### Step11：計算獎金（單一基金）

###### Step11.1：計算單一基金（CAL_TYPE = '2'）
- **計算邏輯**：
  1. 依 `BROKER_NO`、`COMP_ID`、`SEQ`、`FUND_NO` 分組
  2. 計算 `TOT_BAL_AMOUNT`（總餘額）
  3. 計算 `TOT_AVG_AMOUNT`（總平均餘額）
  4. 計算 `TOT_MF_AMOUNT`（總經理費金額）
  5. 判斷是否有月中調整獎金參數（多個生效日）
  6. 根據生效日期區間，分段計算獎金

- **非級距式計算（AMOUNT_TYPE = '1'）**：
  1. 根據 `TOT_AVG_AMOUNT` 找到對應的費率級距
  2. 取得 `SHARE_RATE`（分享比率）
  3. 檢查是否有基金類型費率設定
  4. 若有基金類型費率，則使用基金類型費率
  5. 根據 `CAL_WAY` 計算獎金：
     - `CAL_WAY = '1'`：`EXG_BONUS = (EXG_AVG_AMOUNT × MF_RATE) / 總天數 × 適用天數 × SHARE_RATE`
     - `CAL_WAY = '2'`：`EXG_BONUS = (EXG_AVG_AMOUNT × SHARE_RATE) / 總天數 × 適用天數`
     - `CAL_WAY = '3'`：`EXG_BONUS = (EXG_AVG_AMOUNT × SHARE_RATE) / 總天數 × 適用天數`
     - `CAL_WAY = '4'`：`EXG_BONUS = (EXG_AVG_AMOUNT × MF_RATE × SHARE_RATE) / 12 / 天數 × 適用天數`
  6. 若有多個生效日，分別計算各期間的獎金並累加

- **級距式計算（AMOUNT_TYPE = '2'）**：
  1. 根據 `TOT_AVG_AMOUNT` 找到對應的最大級距
  2. 取得所有符合的級距（最多5個）
  3. 計算各級距的獎金：
     - 計算各級距的金額差額
     - 根據各級距的 `SHARE_RATE` 和 `CAL_WAY` 計算獎金
     - 使用函數 `MDS.F_CHANNEL_BONUS` 計算各級距獎金
  4. 計算總獎金：`EXG_BONUS = (各級距獎金總和 / 總級距金額) × EXG_AVG_AMOUNT`
  5. 若有多個生效日，分別計算各期間的獎金並累加

##### Step12：計算獎金（群組基金）

###### Step12.1：計算群組基金（CAL_TYPE = '1' 或 '3'）
- **計算邏輯**：
  1. 依 `BROKER_NO`、`COMP_ID`、`SEQ` 分組（不區分基金）
  2. 計算 `TOT_BAL_AMOUNT`（所有基金的總餘額）
  3. 計算 `TOT_AVG_AMOUNT`（所有基金的總平均餘額）
  4. 計算 `TOT_MF_AMOUNT`（所有基金的總經理費金額）
  5. 判斷是否有月中調整獎金參數
  6. 根據生效日期區間，分段計算獎金

- **非級距式計算**：
  - 邏輯與單一基金相同，但計算基準是群組的總平均餘額

- **級距式計算**：
  - 邏輯與單一基金相同，但計算基準是群組的總平均餘額
  - **重要**：群組計算採金額差額級距時，不可設定基金類型分享比率

##### Step13：更新獎金小數位數
- **邏輯說明**：
  - 根據計算幣別的小數位數，四捨五入獎金金額
  - 使用函數 `RIS.F_CRNCY_POINT` 取得幣別小數位數

##### Step14：填入付款日
- **邏輯說明**：
  1. 根據 `PAY_TYPE`（付款週期）設定 `PAYMENT_DATE`（付款日）
  2. 若 `PAY_TYPE = 'M'`，使用月付付款日
  3. 若 `PAY_TYPE = 'Q'`，使用季付付款日
  4. 若 `PAY_TYPE = 'S'`，使用半年付付款日
  5. 若 `PAY_DATE <= TERM_TO`，則填入付款日
  6. 若之前月份尚有應付款，也需填入付款日

##### Step15：獎金轉換為台幣
- **邏輯說明**：
  1. 取得計算幣別轉換為台幣的匯率（`BAS_RATE`）
  2. 計算 `BAS_BONUS`（台幣獎金 = EXG_BONUS × BAS_RATE）
  3. 四捨五入到台幣小數位數

##### Step16：更新計算天數
- **邏輯說明**：
  - 計算 `DAYS`（計算天數 = CANCEL_DATE - EFFECTIVE_DATE + 1）
  - 更新 `SORT`（排序欄位，用於報表排序）

##### Step17：變更FUND_GROUP
- **邏輯說明**：
  - 根據 `AMC_NO`（投信代碼）更新 `FUND_GROUP`
  - `AMC_NO = '02'` → `FUND_GROUP = 'IOF'`
  - `AMC_NO = '03'` → `FUND_GROUP = 'M&G'`
  - `AMC_NO = '04'` → `FUND_GROUP = 'MA'`

##### Step18：變更台幣數字
- **邏輯說明**：
  1. 計算 `NTD_BAL_AMOUNT`（台幣餘額 = EXG_BAL_AMOUNT × NTD_RATE）
  2. 計算 `NTD_AVG_AMOUNT`（台幣平均餘額 = EXG_AVG_AMOUNT × NTD_RATE）
  3. 計算 `NTD_MF_AMOUNT`（台幣經理費金額 = EXG_MF_AMOUNT × NTD_RATE）
  4. 計算 `NTD_BONUS`（台幣獎金 = EXG_BONUS × NTD_RATE）
  5. 四捨五入到整數

##### Step19：變更付款幣數字
- **邏輯說明**：
  1. 計算 `PAY_BAL_AMOUNT`（付款幣餘額 = NTD_BAL_AMOUNT / PAY_RATE）
  2. 計算 `PAY_AVG_AMOUNT`（付款幣平均餘額 = NTD_AVG_AMOUNT / PAY_RATE）
  3. 計算 `PAY_MF_AMOUNT`（付款幣經理費金額 = NTD_MF_AMOUNT / PAY_RATE）
  4. 計算 `PAY_BONUS`（付款幣獎金 = NTD_BONUS / PAY_RATE）
  5. 四捨五入到付款幣別小數位數

##### Step20：填入執行記錄結束時間
- **邏輯說明**：
  - 更新 `DMS.PRG_LOG` 的結束時間
  - 提交交易（Commit）

---

## 報表查詢作業

### 一、MDS37391 - 通路回饋明細表

#### 1.1 程式目的
查詢通路回饋計算結果的明細資料，可依銷售機構、基金、日期等條件篩選。

#### 1.2 查詢條件
- **日期範圍**：計算起始日期、計算結束日期
- **銷售機構**：可選擇特定ID或全部
- **基金類型**：境內/境外/境外MA
- **是否代銷**：代銷/非代銷
- **是否合併ID**：是否合併同一COMP_ID下的所有ID
- **是否傳真**：是否只查詢勾選傳真的機構

#### 1.3 報表內容
- 銷售機構代碼、ID
- 基金代碼、基金名稱
- 計算日期範圍
- 餘額、平均餘額、經理費金額
- 分享比率、獎金金額
- 付款日、付款幣別

#### 1.4 功能
- **查詢**：根據條件查詢資料
- **列印**：列印報表
- **轉出Excel**：將資料轉出為Excel檔案
- **自動傳真**：自動產生PDF並傳真給勾選傳真的機構

### 二、MDS37392 - 通路回饋總表

#### 2.1 程式目的
查詢通路回饋計算結果的彙總資料，依銷售機構彙總。

#### 2.2 報表內容
- 銷售機構代碼、ID
- 計算日期範圍
- 總餘額、總平均餘額、總經理費金額
- 總獎金金額
- 付款日、付款幣別

### 三、MDS37393 - 通路回饋應付款報表

#### 3.1 程式目的
查詢應付款項的彙總資料，用於財務付款作業。

### 四、MDS37394 - 每月通路銷售ID增減明細表

#### 4.1 程式目的
查詢每月通路銷售ID的增減明細，用於追蹤ID變動。

### 五、MDS37395 - 每月通路銷售基金增減明細表

#### 5.1 程式目的
查詢每月通路銷售基金的增減明細，用於追蹤基金變動。

### 六、MDS37396 - 每月通路回饋金額增減明細表

#### 6.1 程式目的
查詢每月通路回饋金額的增減明細，用於分析金額變動。

### 七、MDS37397 - 每月通路扣除自有資金存量明細表

#### 7.1 程式目的
查詢每月扣除自有資金存量的明細，用於追蹤自有資金扣除狀況。

### 八、MDS37398 - 每月通路銷售基金未設參數明細表

#### 8.1 程式目的
查詢每月通路銷售基金但未設定參數的明細，用於提醒設定參數。

### 九、MDS37399 - 後收基金通路服務費明細表

#### 9.1 程式目的
查詢後收基金通路服務費的明細資料。

#### 9.2 查詢流程
1. **查詢條件輸入**（w_mds37399_query）：
   - 輸入計算起始日期
   - 系統自動計算結束日期（該月最後一天）
   - 選擇銷售機構ID

2. **資料準備**：
   - 從 `MDS.CHANNEL_BONUS_FUND_BEL` 取得後收基金清單
   - 根據 `EFFECTIVE_DATE` 和 `TERMINATION_DATE` 篩選符合條件的基金
   - 從 `FAS.CERTIFICATE` 和 `FAS.PURCHASE` 取得申購和贖回資料
   - 計算服務費金額

3. **服務費計算邏輯**：
   - 根據申購日期和 `EFFECTIVE_DATE` 判斷是否在計算範圍內
   - 若 `EFFECTIVE_DATE > 查詢起始日期`，則調整計算起始日期為 `EFFECTIVE_DATE`
   - 計算攤銷金額和贖回金額
   - 服務費 = 攤銷金額 - 贖回金額

4. **報表產出**：
   - 顯示後收基金清單
   - 顯示各基金的服務費明細
   - 可列印、轉出Excel、自動傳真

#### 9.3 自動傳真功能
- **執行條件**：`CHANNEL_BONUS_MASTER.REPORT_CB5 = 'Y'`
- **執行流程**：
  1. 取得所有勾選傳真的銷售機構
  2. 逐一產生PDF檔案
  3. 插入 `MDS.STATEMENT_REPORT` 記錄
  4. 插入 `MDS.E_DOCUMENTS` 記錄
  5. 標記為待處理（`HANDLE = 1`）
  6. 等待檔案產生完成
  7. 取消標記（`HANDLE = null`），觸發RightFAX傳真

---

## 特殊處理作業

### 一、MDS37381 - 先鋒投顧存量計算作業

#### 1.1 程式目的
計算Vontobel（先鋒投顧）基金的存量，用於特殊獎金計算。

#### 1.2 計算邏輯
1. **Vontobel前手存量計算**：
   - 贖回一律先扣除Vontobel的前手存量
   - 直至前手存量扣除完畢則Vontobel的前手存量就歸0

2. **Eastspring存量計算**：
   - Eastspring存量 = 總存量 - Vontobel前手剩餘存量

3. **經理費計算**：
   - 經理費計算的天數基準由使用者自行輸入參數決定

4. **Rebate計算**：
   - Rebate計算之基準為Vontobel前手剩餘存量的每日平均餘額
   - Rebate採逐日計算
   - Rebate費率採User自行維護的CHANNEL_BONUS_MF_RATE

#### 1.3 執行條件
- 必須先完成MDS741的計算
- 必須輸入計算月份和經理費計算基準天數

### 二、MDS37382 - 先鋒投顧調整表

#### 2.1 程式目的
查詢先鋒投顧存量計算的調整表，用於檢核計算結果。

#### 2.2 報表類型
- **明細表**：顯示每日的存量變動明細
- **總表**：顯示彙總的存量資料

---

## 完整作業流程圖

### 標準作業流程

```
1. 基礎設定階段
   ├─ MDS37321/37322：設定通路回饋參數
   │   ├─ 主檔設定
   │   ├─ 獎金群組設定（含生效日）
   │   ├─ 基金清單設定
   │   ├─ 費率級距設定
   │   ├─ 後收基金設定
   │   └─ 資料確認
   │
   ├─ MDS3733：設定基金經理費率
   ├─ MDS37329：設定轉換匯率
   ├─ MDS37327/37328：設定自有資金扣除單位數（如需要）
   └─ MDS37323：檢核設定完整性

2. 計算作業階段
   └─ MDS3736：執行通路回饋計算
       ├─ 檢查必要資料
       ├─ 填入初始化資料
       ├─ 計算餘額和平均餘額
       ├─ 計算獎金
       ├─ 轉換幣別
       └─ 更新付款日

3. 報表查詢階段
   ├─ MDS37391：通路回饋明細表
   ├─ MDS37392：通路回饋總表
   ├─ MDS37393：通路回饋應付款報表
   ├─ MDS37394-37398：各種增減明細表
   └─ MDS37399：後收基金通路服務費明細表

4. 特殊處理階段（如需要）
   ├─ MDS37381：先鋒投顧存量計算
   └─ MDS37382：先鋒投顧調整表
```

### 每月標準作業時程

```
月初（1-5日）
├─ 檢查上月計算結果
├─ 確認參數設定是否完整
└─ 執行MDS3736計算作業

月中（10-15日）
├─ 產出各種報表
├─ 執行自動傳真（如需要）
└─ 財務付款作業

月底（25-30日）
├─ 準備下月參數設定
├─ 檢查新基金是否需要設定參數
└─ 預先設定下月生效的參數
```

---

## 重要注意事項

### 1. 生效日的重要性
- **CHANNEL_BONUS_SET.EFFECTIVE_DATE**：決定獎金群組何時開始計算
- **CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE**：決定後收基金何時開始計算服務費
- **若生效日設定錯誤，會導致資料遺漏**

### 2. 資料確認的必要性
- 所有設定資料都必須經過確認（狀態變為 'O'）才能用於計算
- 確認人員不可與維護人員同一人

### 3. 匯率設定的必要性
- 計算前必須確保所有幣別組合的匯率都已設定
- 若未設定匯率，計算作業會失敗

### 4. 經理費率設定的必要性
- 所有基金都必須設定經理費率
- 若未設定經理費率，計算作業會失敗

### 5. 計算作業的不可逆性
- 計算作業會刪除舊資料並重新計算
- 執行前請確認參數設定正確
- 建議先執行小範圍測試

### 6. 月中調整參數的處理
- 系統支援月中調整獎金參數（多個生效日）
- 會自動分段計算各期間的獎金

### 7. 自有資金扣除的處理
- 若需要扣除自有資金，必須先在MDS37327/37328設定
- 計算時會自動扣除自有資金對應的金額

### 8. 代銷排除ID的處理
- 若需要排除某些ID，必須先在MDS37321/37322設定
- 計算時會自動排除這些ID的資料

---

## 常見問題與解決方案

### Q1：為什麼報表看不到某些日期的資料？
**A：** 檢查 `EFFECTIVE_DATE` 是否正確設定。若 `EFFECTIVE_DATE` 晚於查詢起始日期，則該日期之前的資料不會被計算。

### Q2：為什麼計算作業失敗？
**A：** 檢查以下項目：
1. 是否有有效的通路回饋主檔
2. 是否有有效的獎金群組設定
3. 是否有必要的匯率設定
4. 是否有必要的經理費率設定
5. 是否有有效的基金清單

### Q3：為什麼獎金金額為0？
**A：** 檢查以下項目：
1. 是否有符合條件的憑證資料
2. 費率級距設定是否正確
3. 分享比率是否正確設定
4. 計算方式是否正確

### Q4：為什麼後收基金服務費計算不正確？
**A：** 檢查以下項目：
1. `CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE` 是否正確
2. 申購和贖回資料是否正確
3. 服務費計算邏輯是否正確

### Q5：如何處理月中調整參數？
**A：** 在費率級距設定中，設定多個生效日。系統會自動分段計算各期間的獎金。

---

## 結語

本文件詳細說明了MDS373_ALL系統的完整業務流程，包含所有基礎設定、計算作業、報表查詢和特殊處理的邏輯。建議在執行各項作業前，先仔細閱讀相關章節，確保理解每個步驟的邏輯和注意事項。

如有任何疑問，請參考系統中的錯誤訊息或聯繫系統管理員。

