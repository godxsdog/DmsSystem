# MDS37321 與 MDS37399 完整邏輯說明

## 一、MDS37321 - 通路回饋參數設定作業

### 1.1 程式目的
**通路回饋方案設定輸入作業**，用於設定境內/境外基金的通路回饋參數。

### 1.2 主要資料表
- `MDS.CHANNEL_BONUS_MASTER` - 通路回饋主檔
- `MDS.CHANNEL_BONUS_SET` - 獎金群組設定（包含 **EFFECTIVE_DATE 計算生效日**）
- `MDS.CHANNEL_BONUS_FUND` - 基金清單
- `MDS.CHANNEL_BONUS_FUND_BEL` - 後收基金清單（包含 **EFFECTIVE_DATE 生效日**）
- `MDS.CHANNEL_BONUS_RANGE` - 費率級距

### 1.3 作業流程

#### 1.3.1 主檔設定（dw_1）
- **資料狀態控制**：
  - `U` = 未確認
  - `O` = 有效
  - `C` = 無效
- **控制規則**：
  - 資料新增後不可刪除
  - 資料註記無效後不可變更
  - 資料變更後狀態會回覆至未確認
  - 資料未確認時，無法變更中/下半部資料

#### 1.3.2 獎金群組設定（tabpage_1 - dw_detail）
- **資料來源**：`MDS.CHANNEL_BONUS_SET`
- **關鍵欄位**：
  - `EFFECTIVE_DATE` - **計算生效日**（重要！）
  - `SEQ` - 序號
  - `CAL_TYPE` - 計算類型（1=群組計算, 2=單一基金計算）
  - `AMOUNT_TYPE` - 金額計算類型
- **確認機制**：
  - 確認時會自動帶入符合條件的基金清單
  - 若基金已終止交易，則註記為無效

#### 1.3.3 基金清單設定（tabpage_3 - dw_fund_list）
- **資料來源**：`MDS.CHANNEL_BONUS_FUND`
- **關鍵欄位**：
  - `EFFECTIVE_DATE` - 基金生效日
  - `FUND_NO` - 基金代碼
- **驗證邏輯**（第1303-1321行）：
  ```powerscript
  // 檢查基金清單的生效日是否與獎金群組的計算生效日一致
  if Date(ld_effective_date_fund) <> ld_effective_date_set then
      f_error('基金清單: ' + ls_fund_no + ' 與獎金群組序號: ' + ls_seq + ' [計算生效日]不同');
  end if
  ```
- **重要**：基金清單的生效日必須與獎金群組的計算生效日相同

#### 1.3.4 後收基金設定（tabpage_6 - dw_fund_bel_list）
- **資料來源**：`MDS.CHANNEL_BONUS_FUND_BEL`
- **關鍵欄位**：
  - `EFFECTIVE_DATE` - **生效日**（影響 MDS37399 查詢）
  - `TERMINATION_DATE` - 終止日
  - `PAY_CRNCY` - 支付幣別

---

## 二、MDS37399 - 後收基金通路服務費明細表

### 2.1 程式目的
產生**後收基金通路服務費明細表**，計算各通路在指定期間內應收取的服務費。

### 2.2 報表類型
1. **業務報表**（`ls_rpt_user_type = '1'`）
2. **財務報表**（`ls_rpt_user_type = '2'`，僅支援境內）

### 2.3 完整邏輯流程

#### 步驟 1：開啟查詢視窗（w_mds37399_query）
- 使用者輸入查詢條件：
  - `ad_begin_date` - 開始日期
  - `as_broker` - 銷售機構（可為 % 表示全部）
  - `as_offshore_type` - 境內/境外類型（1=境內, 2=境外）
  - `as_all_fax` - 是否傳真搜尋（Y/N）

#### 步驟 2：清除舊資料
```sql
DELETE FROM MDS.MDS37399_TEMP
WHERE START_DATE = :ld_start_date 
  AND EMP_NO = :gs_id
```

#### 步驟 3：查詢符合條件的後收基金設定
**查詢條件**（第178-204行）：
```sql
SELECT 
    CHANNEL_BONUS_MASTER.BROKER_NO,
    a.ID,
    CHANNEL_BONUS_MASTER.OFFSHORE_TYPE,
    CHANNEL_BONUS_FUND_BEL.FUND_NO,
    FUND.CURRENCY_NO,
    CHANNEL_BONUS_MASTER.BEL_FEE_RATE,
    CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE,      -- 生效日
    nvl(CHANNEL_BONUS_FUND_BEL.TERMINATION_DATE, :ld_end_date),
    CHANNEL_BONUS_FUND_BEL.PAY_CRNCY
FROM CHANNEL_BONUS_FUND_BEL,
     CHANNEL_BONUS_MASTER,
     CHANNEL_BONUS_MASTER a,
     FAS.FUND
WHERE 
    -- 關聯條件
    CHANNEL_BONUS_MASTER.BROKER_NO = CHANNEL_BONUS_FUND_BEL.BROKER_NO
    AND CHANNEL_BONUS_MASTER.ID = CHANNEL_BONUS_FUND_BEL.ID
    AND CHANNEL_BONUS_MASTER.OFFSHORE_TYPE = CHANNEL_BONUS_FUND_BEL.OFFSHORE_TYPE
    AND nvl(a.comp_id, a.id) = CHANNEL_BONUS_MASTER.ID
    AND a.broker_no = CHANNEL_BONUS_MASTER.BROKER_NO
    AND a.offshore_type = CHANNEL_BONUS_MASTER.OFFSHORE_TYPE
    AND CHANNEL_BONUS_FUND_BEL.FUND_NO = FUND.FUND_NO
    -- 生效日條件（關鍵！）
    AND CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE <= :ld_end_date
    AND (CHANNEL_BONUS_FUND_BEL.TERMINATION_DATE > :ld_start_date 
         OR CHANNEL_BONUS_FUND_BEL.TERMINATION_DATE IS NULL)
    -- 其他條件
    AND CHANNEL_BONUS_MASTER.BROKER_NO LIKE :ls_broker
    AND CHANNEL_BONUS_MASTER.OFFSHORE_TYPE = DECODE(:ls_rpt_offshore_type, 1, 1, 2)
    AND SUBSTR(FUND.AMC_NO, 2, 1) = :ls_rpt_offshore_type
```

#### 步驟 4：對每個符合條件的基金進行處理（迴圈）
**4.1 取得生效日範圍**
- `ld_tx_date1` = `CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE`（生效日）
- `ld_tx_date2` = `CHANNEL_BONUS_FUND_BEL.TERMINATION_DATE`（終止日，若為 NULL 則用結束日期）

**4.2 調整日期範圍**（第224-230行）
```powerscript
// 如果生效日早於查詢開始日期，則使用查詢開始日期
if ld_tx_date1 < ld_start_date then
    ld_tx_date1 = ld_start_date
end if

// 如果終止日晚於查詢結束日期，則使用查詢結束日期
if ld_tx_date2 > ld_end_date then
    ld_tx_date2 = ld_end_date
end if
```

**4.3 查詢匯率**
```sql
SELECT exg_rate 
INTO :ldec_exg_rate
FROM mds.channel_bonus_exg_rate
WHERE org_crncy = :ls_crncy_cd      -- 原始幣別
  AND exg_crncy = :ls_pay_crncy     -- 支付幣別
  AND ac_date = :ld_start_date
```

**4.4 查詢申購交易資料並計算服務費**（第232-272行）
```sql
INSERT INTO MDS.MDS37399_TEMP (
    FUND_NO, ID, TX_DATE, BROKER_NO, BRANCH_NO, SER_NO,
    AMOUNT, BEL_FEE_RATE, EXG_RATE, EMP_NO,
    BEL_FEE,                    -- 原始幣別服務費
    BEL_FEE_PAY,                -- 支付幣別服務費
    START_DATE, END_DATE, PAY_CRNCY, OFFSHORE_TYPE, BEL_CUS_NO
)
SELECT 
    PURCHASE.FUND_NO,
    PURCHASE.ID,
    PURCHASE.TX_DATE,
    PURCHASE.BROKER_NO,
    PURCHASE.BRANCH_NO,
    PURCHASE.SER_NO,
    PURCHASE.AMOUNT,
    :ldec_bel_fee_rate,         -- 服務費費率
    :ldec_exg_rate,             -- 匯率
    :gs_id,
    -- 計算原始幣別服務費
    round(PURCHASE.AMOUNT * :ldec_bel_fee_rate, :li_bas_point),
    -- 計算支付幣別服務費（原始服務費 * 匯率）
    round(round(PURCHASE.AMOUNT * :ldec_bel_fee_rate, :li_bas_point) * :ldec_exg_rate, :li_point),
    :ld_start_date,
    :ld_end_date,
    :ls_pay_crncy,
    :ls_offshore_type,
    PURCHASE.BEL_CUS_NO
FROM FAS.PURCHASE
WHERE 
    PURCHASE.FUND_NO = :ls_fund_no
    AND PURCHASE.ID = :ls_id
    -- 關鍵：交易日期必須在生效日範圍內
    AND PURCHASE.TX_DATE BETWEEN :ld_tx_date1 AND :ld_tx_date2
    AND PURCHASE.BROKER_NO = :ls_broker_no
    AND PURCHASE.FUND_NO_OUT IS NULL  -- 尚未贖回
```

#### 步驟 5：儲存查詢條件
```sql
INSERT INTO MDS.MDS344_CONDITION (
    EMP_NO, EXC_TIME, FUND_NO, BROKER_NO,
    DATE_FROM, DATE_TO, DAYS, FUND_CATEGORY, TYPE
)
VALUES (
    :gs_id,
    to_date('1900-03-01', 'yyyy-mm-dd'),
    '',
    :ls_broker,
    :ld_start_date,
    :ld_end_date,
    '',
    :ls_rpt_offshore_type,
    ''
)
```

#### 步驟 6：顯示報表
- 根據 `offshore_type` 選擇對應的 DataWindow：
  - 境內：`d_mds37399`
  - 境外：`d_mds37399_f`
- 從 `MDS.MDS37399_TEMP` 讀取資料顯示

---

## 三、關鍵邏輯說明

### 3.1 生效日的作用

#### MDS37321 中的生效日
1. **CHANNEL_BONUS_SET.EFFECTIVE_DATE**（計算生效日）
   - 用途：獎金群組的計算生效日
   - 驗證：基金清單的生效日必須與此一致

2. **CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE**（後收基金生效日）
   - 用途：決定何時開始計算該基金的服務費
   - **影響 MDS37399 的查詢範圍**

#### MDS37399 中的生效日使用
1. **查詢條件**（第200行）：
   ```sql
   CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE <= :ld_end_date
   ```
   確保只查詢已生效的基金設定

2. **交易日期範圍**（第207行）：
   ```powerscript
   ld_tx_date1 = CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE
   ```
   將生效日作為查詢交易資料的起始日期

3. **日期調整**（第224-226行）：
   ```powerscript
   if ld_tx_date1 < ld_start_date then
       ld_tx_date1 = ld_start_date
   end if
   ```
   如果生效日早於查詢開始日期，則使用查詢開始日期

### 3.2 問題分析：為什麼看不到早於 9/9 的申購資料？

**情境**：
- 生效日 = 9/9
- 查詢日期區間 = 9/1 ~ 9/30

**執行流程**：
1. `ld_tx_date1 = 9/9`（生效日）
2. `ld_start_date = 9/1`（查詢開始日期）
3. 因為 `9/9 > 9/1`，所以不會執行調整
4. 查詢條件：`TX_DATE BETWEEN 9/9 AND 9/30`
5. **結果**：9/1 ~ 9/8 的申購資料被排除

**解決方案**：
將 `CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE` 改為 `9/1`，則：
1. `ld_tx_date1 = 9/1`
2. 查詢條件：`TX_DATE BETWEEN 9/1 AND 9/30`
3. **結果**：可以包含 9/1 ~ 9/8 的申購資料

### 3.3 傳真模式（ls_all_fax = 'Y'）
- 只查詢 `REPORT_CB5 = 'Y'` 的銷售機構
- 其他邏輯與一般模式相同

### 3.4 服務費計算公式
1. **原始幣別服務費**：
   ```
   BEL_FEE = round(AMOUNT * BEL_FEE_RATE, 幣別小數位數)
   ```

2. **支付幣別服務費**：
   ```
   BEL_FEE_PAY = round(BEL_FEE * EXG_RATE, 支付幣別小數位數)
   ```

---

## 四、資料表關聯圖

```
CHANNEL_BONUS_MASTER (主檔)
    ├── CHANNEL_BONUS_SET (獎金群組)
    │   └── EFFECTIVE_DATE (計算生效日)
    │
    ├── CHANNEL_BONUS_FUND (基金清單)
    │   └── EFFECTIVE_DATE (必須與 SET.EFFECTIVE_DATE 一致)
    │
    └── CHANNEL_BONUS_FUND_BEL (後收基金清單)
        ├── EFFECTIVE_DATE (生效日 - 影響 37399 查詢)
        ├── TERMINATION_DATE (終止日)
        └── PAY_CRNCY (支付幣別)
            │
            └──> PURCHASE (申購交易)
                └── TX_DATE (交易日期)
                    └──> 必須在 EFFECTIVE_DATE ~ TERMINATION_DATE 之間
```

---

## 五、修改建議

### 5.1 需要修改的欄位
**`MDS.CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE`**

### 5.2 SQL 修改範例
```sql
-- 修改環球智數基金的生效日從 9/9 改為 9/1
UPDATE MDS.CHANNEL_BONUS_FUND_BEL 
SET EFFECTIVE_DATE = TO_DATE('2021-09-01', 'YYYY-MM-DD')
WHERE EFFECTIVE_DATE = TO_DATE('2021-09-09', 'YYYY-MM-DD')
  AND FUND_NO = '環球智數基金代碼'  -- 請填入實際基金代碼
  AND OFFSHORE_TYPE = '1'           -- 境內
  AND BROKER_NO = '相關銷售機構'     -- 請填入實際銷售機構
  AND ID = '相關ID';                 -- 請填入實際ID
```

### 5.3 注意事項
1. **僅在測試環境修改**（Beta 測試資料庫的測試區）
2. **不要動到帳務資料區的測試區**（會影響目前資料）
3. 修改後需要重新執行 MDS37399 報表查詢
4. 確認修改的基金代碼、銷售機構、ID 等條件正確

---

## 六、相關程式檔案

- `w_mds37321.srw` - 通路回饋參數設定作業
- `w_mds37399.srw` - 後收基金通路服務費明細表
- `w_mds37399_query.srw` - 查詢條件視窗
- `d_mds37399.srd` - 境內報表 DataWindow
- `d_mds37399_f.srd` - 境外報表 DataWindow

---

## 七、總結

1. **MDS37321** 用於設定通路回饋參數，包含生效日的設定
2. **MDS37399** 根據生效日來決定查詢哪些申購交易資料
3. **生效日的作用**：決定從哪一天開始計算該基金的服務費
4. **問題根源**：生效日設為 9/9，導致 9/1~9/8 的申購資料被排除
5. **解決方法**：將 `CHANNEL_BONUS_FUND_BEL.EFFECTIVE_DATE` 改為 9/1

