# å ±é…¬ç‡å…¬å¼æ¯”è¼ƒåˆ†æ

## æª”æ¡ˆä¾†æº
1. `d_fas51_balance.srd` - DataWindow çµå­˜æŸ¥è©¢
2. `S_GETHISTORYTRADE.sql` - SQL æ­·å²äº¤æ˜“æŸ¥è©¢
3. `w_fas51.srw` - PowerBuilder çµå­˜æŸ¥è©¢è¦–çª—

---

## ä¸€ã€d_fas51_balance.srd çš„å ±é…¬ç‡å…¬å¼

### 1.1 åŸå¹£å ±é…¬ç‡ (roi)

#### æ˜ç´°å±¤ç´š (detail band) - ç¬¬136è¡Œ
```powerbuilder
if(shares > 0 and cost=0, 0, currency_value / cost - 1)
```

**å…¬å¼èªªæ˜:**
- **åˆ†å­**: `currency_value` = `shares * nav` (ç•¶å‰å¸‚å€¼)
- **åˆ†æ¯**: `cost` (ç¸½æŠ•è³‡æˆæœ¬)
- **è¨ˆç®—**: (ç•¶å‰å¸‚å€¼ / ç¸½æˆæœ¬) - 1
- **ç‰¹æ®Šè™•ç†**: å¦‚æœæœ‰å–®ä½æ•¸ä½†æˆæœ¬ç‚º0,é¡¯ç¤ºç‚º "-"

#### åŸºé‡‘å±¤ç´š (header.3) - ç¬¬122è¡Œ
```powerbuilder
if(sum(shares for group 3) > 0 and sum(cost for group 3)=0, 0, 
   sum(currency_value for group 3) / sum(cost for group 3) - 1)
```

**å…¬å¼èªªæ˜:**
- åŒæ¨£çš„é‚è¼¯,ä½†æ˜¯é‡å°æ•´å€‹åŸºé‡‘ç¾¤çµ„é€²è¡ŒåŠ ç¸½è¨ˆç®—

#### å¹£åˆ¥å±¤ç´š (header.2) - ç¬¬108è¡Œ
```powerbuilder
if(sum(shares for group 2) > 0 and sum(cost for group 2)=0, 0, 
   sum(currency_value for group 2) / sum(cost for group 2) - 1)
```

**å…¬å¼èªªæ˜:**
- åŒæ¨£çš„é‚è¼¯,ä½†æ˜¯é‡å°æ•´å€‹å¹£åˆ¥ç¾¤çµ„é€²è¡ŒåŠ ç¸½è¨ˆç®—

---

### 1.2 å°å¹£å ±é…¬ç‡ (roi_ntd)

#### æ˜ç´°å±¤ç´š (detail band) - ç¬¬138è¡Œ
```powerbuilder
if(shares > 0 and cost=0, 0, 
   (if(pay_currency_no <> currency_no and pay_currency_no ='NTD',
       if(nav=cost_nav, round(cost*ex_rate,0), round(round(nav * shares, amt_decimal) * ex_rate,0)),
       if(nav=cost_nav, cost, round(nav * shares, amt_decimal))
   ) / 
   if(pay_currency_no <> currency_no and pay_currency_no ='NTD', ntd_cost, cost)
   ) - 1
)
```

**å…¬å¼èªªæ˜:**
- **åˆ¤æ–·æ¢ä»¶**: å¦‚æœä»˜æ¬¾å¹£åˆ¥ â‰  åŸºé‡‘å¹£åˆ¥ ä¸” ä»˜æ¬¾å¹£åˆ¥ = 'NTD'
- **åˆ†å­è¨ˆç®—**:
  - è‹¥ç¬¦åˆæ¢ä»¶:
    - å¦‚æœ nav = cost_nav (æ·¨å€¼ç­‰æ–¼æˆæœ¬æ·¨å€¼),ä½¿ç”¨ `round(cost*ex_rate,0)`
    - å¦å‰‡ä½¿ç”¨ `round(round(nav * shares, amt_decimal) * ex_rate,0)`
  - è‹¥ä¸ç¬¦åˆæ¢ä»¶:
    - å¦‚æœ nav = cost_nav,ä½¿ç”¨ `cost`
    - å¦å‰‡ä½¿ç”¨ `round(nav * shares, amt_decimal)`
- **åˆ†æ¯è¨ˆç®—**:
  - è‹¥ç¬¦åˆæ¢ä»¶: ä½¿ç”¨ `ntd_cost` (å°å¹£æˆæœ¬)
  - è‹¥ä¸ç¬¦åˆæ¢ä»¶: ä½¿ç”¨ `cost` (åŸå¹£æˆæœ¬)
- **ç‰¹æ®Šè™•ç†**: åªæœ‰åœ¨ `pay_currency_no <> currency_no and pay_currency_no ='NTD' and roi <> 0` æ™‚æ‰é¡¯ç¤º

#### åŸºé‡‘å±¤ç´š (header.3) - ç¬¬124è¡Œ
```powerbuilder
if(sum(shares for group 3) > 0 and sum(cost for group 3)=0, 0, 
   sum(if(pay_currency_no <> currency_no and pay_currency_no ='NTD' and roi_3<>0,
          if(nav=cost_nav, round(cost*ex_rate,0), round(round(nav * shares, amt_decimal) * ex_rate,0)), 
          if(nav=cost_nav, cost, round(nav * shares, amt_decimal))
       ) for group 3
   ) / 
   sum(if(pay_currency_no <> currency_no and pay_currency_no ='NTD' and roi_3<>0, ntd_cost, cost) 
       for group 3
   ) - 1
)
```

**å…¬å¼èªªæ˜:**
- åŒæ¨£çš„é‚è¼¯,ä½†é‡å°æ•´å€‹åŸºé‡‘ç¾¤çµ„é€²è¡ŒåŠ ç¸½è¨ˆç®—
- é¡å¤–æ¢ä»¶: `roi_3 <> 0` (åŸå¹£å ±é…¬ç‡ä¸ç‚º0)

#### å¹£åˆ¥å±¤ç´š (header.2) - ç¬¬110è¡Œ
```powerbuilder
if(sum(shares for group 2) > 0 and sum(cost for group 2)=0, 0,
   sum(if(pay_currency_no <> currency_no and pay_currency_no ='NTD' and roi_2<>0,
          if(nav=cost_nav, round(cost*ex_rate,0), round(round(nav * shares, amt_decimal) * ex_rate,0)), 
          if(nav=cost_nav, cost, round(nav * shares, amt_decimal))
       ) for group 2
   ) / 
   sum(if(pay_currency_no <> currency_no and pay_currency_no ='NTD' and roi_2<>0, ntd_cost, cost) 
       for group 2
   ) - 1
)
```

**å…¬å¼èªªæ˜:**
- åŒæ¨£çš„é‚è¼¯,ä½†é‡å°æ•´å€‹å¹£åˆ¥ç¾¤çµ„é€²è¡ŒåŠ ç¸½è¨ˆç®—

---

## äºŒã€S_GETHISTORYTRADE.sql çš„å ±é…¬ç‡å…¬å¼

### 2.1 é©ç”¨ç¯„åœ
- è´–å›äº¤æ˜“ (REDEMPTION)
- è½‰ç”³è³¼äº¤æ˜“ (SWITCH)

### 2.2 å…¬å¼ (ç¬¬685-693è¡Œ, 842-850è¡Œ, 1198-1206è¡Œ, 1408-1416è¡Œ)
```sql
ROUND(
    (è´–å›é‡‘é¡ / 
     SUM(
         (CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
               THEN CERTIFICATE.AMOUNT 
               ELSE CERTIFICATE.COST 
          END 
          * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)
     ) - 1
    ) * 100, 
    2
)
```

**è©³ç´°èªªæ˜:**

1. **æˆæœ¬è¨ˆç®—é‚è¼¯**:
   - **é…æ¯å†ç”³è³¼æˆ–ç‘è¬ç³»åˆ—**: `CERTIFICATE.BRANCH_NO = '7000'` æˆ– `CERTIFICATE.FUND_NO LIKE 'V%'`
     - ä½¿ç”¨ `CERTIFICATE.AMOUNT` (ç”³è³¼é‡‘é¡) ä½œç‚ºæˆæœ¬
   - **å…¶ä»–æƒ…æ³**:
     - ä½¿ç”¨ `CERTIFICATE.COST` (å¯¦éš›æˆæœ¬) ä½œç‚ºæˆæœ¬

2. **åŠ æ¬Šè¨ˆç®—**:
   ```sql
   æˆæœ¬ * (è´–å›å–®ä½æ•¸ / è­‰åˆ¸å–®ä½æ•¸)
   ```
   - `RED_CERTIFICATE.REDEMPTION_SHARE`: è´–å›çš„å–®ä½æ•¸
   - `RED_CERTIFICATE.CERTIFICATE_SHARE`: è­‰åˆ¸çš„ç¸½å–®ä½æ•¸
   - é€™æ¨£å¯ä»¥è¨ˆç®—å‡ºéƒ¨åˆ†è´–å›æ™‚å°æ‡‰çš„æˆæœ¬æ¯”ä¾‹

3. **å ±é…¬ç‡è¨ˆç®—**:
   ```
   (è´–å›é‡‘é¡ / åŠ æ¬Šæˆæœ¬ç¸½å’Œ - 1) * 100
   ```
   - æœ€å¾Œä¹˜ä»¥ 100 è½‰æ›ç‚ºç™¾åˆ†æ¯”
   - å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ2ä½

4. **ä¿®æ”¹æ­·å²**:
   - 2022.03.02: æ–°å¢å ±é…¬ç‡æ¬„ä½
   - 2022.04.14: èª¿æ•´å ±é…¬ç‡å°æ•¸é»2ä½
   - 2022.05.24: èª¿æ•´æˆæœ¬è¨ˆç®—æ–¹å¼ (é…æ¯å†ç”³è³¼/ç‘è¬ç³»åˆ—ä½¿ç”¨ AMOUNT)
   - 2022.10.19: èª¿æ•´å ±é…¬ç‡è¨ˆç®—æ–¹å¼

---

## ä¸‰ã€w_fas51.srw çš„å ±é…¬ç‡å…¬å¼

### 3.1 é©ç”¨ç¯„åœ
- EC ä¸å®šé¡æ‰£æ¬¾ (EC Periodic) çš„å ±é…¬ç‡è¨ˆç®—
- äº‹ä»¶: `ue_cb_roi` (ç¬¬5320-5398è¡Œ)

### 3.2 å…¬å¼ (ç¬¬5387è¡Œ)
```powerbuilder
ldec_roi = round(ldec_value / ldec_cost, 4) - 1
```

**è©³ç´°èªªæ˜:**

1. **è®Šæ•¸è¨ˆç®—**:
   ```powerbuilder
   ldec_value = Round(ldec_shares * ldec_nav, ll_amt_decimal)
   ```
   - `ldec_shares`: å¾è³‡æ–™åº«æŸ¥è©¢çš„åº«å­˜å–®ä½æ•¸
   - `ldec_nav`: å¾è³‡æ–™åº«æŸ¥è©¢çš„æ·¨å€¼
   - `ll_amt_decimal`: é‡‘é¡å°æ•¸ä½æ•¸

2. **æˆæœ¬æŸ¥è©¢** (ç¬¬5356-5380è¡Œ):
   ```sql
   SELECT NVL(SUM(COST), 0)
   INTO :ldec_cost
   FROM FAS.CERTIFICATE
   WHERE ID = :ls_id
     AND ID_SEQ = :ll_id_seq
     AND FUND_NO = :ls_fund_no
     AND PRODUCT_TYPE = :ls_product_type
     AND (CANCEL_DATE IS NULL OR CANCEL_DATE > :ld_nav_date);
   ```
   - æŸ¥è©¢ç‰¹å®šå¥‘ç´„åœ¨æ·¨å€¼æ—¥æœŸå‰æœªå–æ¶ˆçš„ç¸½æˆæœ¬

3. **åº«å­˜å–®ä½æ•¸æŸ¥è©¢** (ç¬¬5333-5348è¡Œ):
   ```sql
   SELECT NVL(SUM(SHARES), 0)
   INTO :ldec_shares
   FROM FAS.CERTIFICATE
   WHERE ID = :ls_id
     AND ID_SEQ = :ll_id_seq
     AND FUND_NO = :ls_fund_no
     AND PRODUCT_TYPE = :ls_product_type
     AND (CANCEL_DATE IS NULL OR CANCEL_DATE > :ld_nav_date);
   ```

4. **å ±é…¬ç‡è¨ˆç®—**:
   ```
   å ±é…¬ç‡ = round(ç•¶å‰å¸‚å€¼ / ç¸½æˆæœ¬, 4) - 1
   ```
   - å››æ¨äº”å…¥åˆ°å°æ•¸é»å¾Œ4ä½

5. **ç‰¹æ®Šè™•ç†**:
   - å¦‚æœ `ldec_shares <= 0`: é¡¯ç¤ºè­¦å‘Šè¨Šæ¯ä¸¦è¨­å®šå ±é…¬ç‡ç‚º 0

---

## å››ã€å…¬å¼å·®ç•°ç¸½çµ

| é …ç›® | d_fas51_balance.srd | S_GETHISTORYTRADE.sql | w_fas51.srw |
|------|---------------------|----------------------|-------------|
| **é©ç”¨å ´æ™¯** | çµå­˜æŸ¥è©¢ (æŒæœ‰éƒ¨ä½) | æ­·å²äº¤æ˜“ (è´–å›/è½‰ç”³è³¼) | ä¸å®šé¡æ‰£æ¬¾æŸ¥è©¢ |
| **åŸºæœ¬å…¬å¼** | (å¸‚å€¼ / æˆæœ¬) - 1 | (è´–å›é‡‘é¡ / åŠ æ¬Šæˆæœ¬) - 1 | (å¸‚å€¼ / æˆæœ¬) - 1 |
| **å¸‚å€¼è¨ˆç®—** | shares * nav | ç›´æ¥ä½¿ç”¨è´–å›é‡‘é¡ | Round(shares * nav, amt_decimal) |
| **æˆæœ¬ä¾†æº** | CERTIFICATE.COST | CERTIFICATE.COST æˆ– AMOUNT | SUM(CERTIFICATE.COST) |
| **æˆæœ¬åˆ¤æ–·** | ç„¡ç‰¹æ®Šåˆ¤æ–· | é…æ¯å†ç”³è³¼/ç‘è¬ç³»åˆ—ç”¨ AMOUNT | ç„¡ç‰¹æ®Šåˆ¤æ–· |
| **åŠ æ¬Šè¨ˆç®—** | ç„¡ (ç›´æ¥åŠ ç¸½) | æœ‰ (ä¾è´–å›æ¯”ä¾‹) | ç„¡ (ç›´æ¥åŠ ç¸½) |
| **å°æ•¸ä½æ•¸** | ä¾é¡¯ç¤ºæ ¼å¼ | ç™¾åˆ†æ¯” * 100, 2ä½ | 4ä½å°æ•¸ |
| **çµæœæ ¼å¼** | å°æ•¸ (é¡¯ç¤ºç‚º %) | ç™¾åˆ†æ¯”æ•¸å€¼ | å°æ•¸ (é¡¯ç¤ºç‚º %) |
| **å°å¹£å ±é…¬ç‡** | æœ‰ (è¤‡é›œè¨ˆç®—) | ç„¡ | ç„¡ |
| **é›¶æˆæœ¬è™•ç†** | é¡¯ç¤º "-" | ä¸æ˜ç¢º | è¨­ç‚º 0 |

---

## äº”ã€é—œéµå·®ç•°åˆ†æ

### 5.1 æˆæœ¬è¨ˆç®—å·®ç•°

#### d_fas51_balance.srd:
- ç›´æ¥ä½¿ç”¨ `CERTIFICATE.COST`
- å°æ–¼å°å¹£å ±é…¬ç‡,æœ‰ `ntd_cost` çš„è¨ˆç®—

#### S_GETHISTORYTRADE.sql:
- **ç‰¹æ®Šåˆ¤æ–·**:
  ```sql
  CASE WHEN CERTIFICATE.BRANCH_NO = '7000' OR CERTIFICATE.FUND_NO LIKE 'V%'
       THEN CERTIFICATE.AMOUNT
       ELSE CERTIFICATE.COST
  END
  ```
- é…æ¯å†ç”³è³¼ (BRANCH_NO='7000') æˆ–ç‘è¬ç³»åˆ— (FUND_NO LIKE 'V%') ä½¿ç”¨ç”³è³¼é‡‘é¡
- å…¶ä»–æƒ…æ³ä½¿ç”¨å¯¦éš›æˆæœ¬

#### w_fas51.srw:
- ç›´æ¥ä½¿ç”¨ `SUM(CERTIFICATE.COST)`
- ç„¡ç‰¹æ®Šåˆ¤æ–·

---

### 5.2 åŠ æ¬Šè¨ˆç®—å·®ç•°

#### d_fas51_balance.srd & w_fas51.srw:
- **ç„¡åŠ æ¬Š**: ç›´æ¥å°‡æ‰€æœ‰ shares å’Œ cost åŠ ç¸½
- å…¬å¼: `SUM(shares * nav) / SUM(cost) - 1`

#### S_GETHISTORYTRADE.sql:
- **æœ‰åŠ æ¬Š**: ä¾æ“šè´–å›æ¯”ä¾‹è¨ˆç®—å°æ‡‰æˆæœ¬
- å…¬å¼: `è´–å›é‡‘é¡ / SUM(æˆæœ¬ * è´–å›å–®ä½æ•¸ / è­‰åˆ¸å–®ä½æ•¸) - 1`
- **åŸå› **: éƒ¨åˆ†è´–å›æ™‚éœ€è¦ä¾æ¯”ä¾‹è¨ˆç®—æˆæœ¬

---

### 5.3 çµæœæ ¼å¼å·®ç•°

#### d_fas51_balance.srd:
- è¨ˆç®—çµæœç‚ºå°æ•¸ (ä¾‹å¦‚: 0.1234)
- é¡¯ç¤ºæ ¼å¼: `#,##0.00%` (ä¾‹å¦‚: 12.34%)
- ä¸ä¹˜ä»¥ 100

#### S_GETHISTORYTRADE.sql:
- è¨ˆç®—çµæœå·²ä¹˜ä»¥ 100 (ä¾‹å¦‚: 12.34)
- å„²å­˜ç‚ºç™¾åˆ†æ¯”æ•¸å€¼
- `ROUND(..., 2)` ä¿ç•™2ä½å°æ•¸

#### w_fas51.srw:
- è¨ˆç®—çµæœç‚ºå°æ•¸ (ä¾‹å¦‚: 0.1234)
- `round(..., 4)` ä¿ç•™4ä½å°æ•¸
- é¡¯ç¤ºæ™‚è½‰æ›ç‚ºç™¾åˆ†æ¯”

---

### 5.4 å°å¹£å ±é…¬ç‡ç‰¹æ®Šè™•ç† (åƒ… d_fas51_balance.srd)

**åƒ…åœ¨ä»¥ä¸‹æƒ…æ³é¡¯ç¤ºå°å¹£å ±é…¬ç‡**:
- ä»˜æ¬¾å¹£åˆ¥ â‰  åŸºé‡‘å¹£åˆ¥
- ä»˜æ¬¾å¹£åˆ¥ = 'NTD'
- åŸå¹£å ±é…¬ç‡ â‰  0

**è¨ˆç®—é‚è¼¯**:
1. å¦‚æœ nav = cost_nav (æ·¨å€¼ç­‰æ–¼æˆæœ¬æ·¨å€¼):
   - ä½¿ç”¨åŸæˆæœ¬ * åŒ¯ç‡
2. å¦å‰‡:
   - é‡æ–°è¨ˆç®—å¸‚å€¼ä¸¦ä¹˜ä»¥åŒ¯ç‡

**ç›®çš„**: è™•ç†å¤–å¹£åŸºé‡‘ä»¥å°å¹£ç”³è³¼çš„æƒ…æ³

---

## å…­ã€å»ºè­°èˆ‡æ³¨æ„äº‹é …

### 6.1 ä¸€è‡´æ€§å•é¡Œ

1. **æˆæœ¬è¨ˆç®—ä¸ä¸€è‡´**:
   - `S_GETHISTORYTRADE.sql` å°é…æ¯å†ç”³è³¼/ç‘è¬ç³»åˆ—ä½¿ç”¨ `AMOUNT`
   - å…¶ä»–å…©å€‹æª”æ¡ˆç›´æ¥ä½¿ç”¨ `COST`
   - **å»ºè­°**: ç¢ºèªé…æ¯å†ç”³è³¼/ç‘è¬ç³»åˆ—åœ¨çµå­˜æŸ¥è©¢ä¸­æ˜¯å¦ä¹Ÿæ‡‰è©²ä½¿ç”¨ç›¸åŒé‚è¼¯

2. **å°æ•¸ä½æ•¸ä¸ä¸€è‡´**:
   - SQL ä½¿ç”¨ 2 ä½å°æ•¸ä¸¦ä¹˜ä»¥ 100
   - PowerBuilder ä½¿ç”¨ 4 ä½å°æ•¸
   - **å»ºè­°**: çµ±ä¸€å°æ•¸ä½æ•¸æ¨™æº–

### 6.2 åŠ æ¬Šè¨ˆç®—å·®ç•°

- **S_GETHISTORYTRADE.sql** ä½¿ç”¨åŠ æ¬Šè¨ˆç®—æ˜¯æ­£ç¢ºçš„ (é‡å°éƒ¨åˆ†è´–å›)
- **d_fas51_balance.srd** ç„¡åŠ æ¬Šæ˜¯æ­£ç¢ºçš„ (é‡å°æŒæœ‰éƒ¨ä½)
- **w_fas51.srw** é‡å°ä¸å®šé¡æ‰£æ¬¾,ç„¡åŠ æ¬Šä¹Ÿæ˜¯åˆç†çš„

### 6.3 é›¶æˆæœ¬è™•ç†

- å„æª”æ¡ˆå°é›¶æˆæœ¬çš„è™•ç†ä¸åŒ
- **å»ºè­°**: çµ±ä¸€è™•ç†é‚è¼¯,é¿å…é™¤ä»¥é›¶çš„éŒ¯èª¤

---

## ä¸ƒã€çµè«–

ä¸‰å€‹æª”æ¡ˆçš„å ±é…¬ç‡å…¬å¼**åŸºæœ¬é‚è¼¯ä¸€è‡´**,éƒ½æ˜¯ `(ç•¶å‰åƒ¹å€¼ / æˆæœ¬) - 1`,ä½†åœ¨ä»¥ä¸‹æ–¹é¢æœ‰æ‰€ä¸åŒ:

1. **æˆæœ¬å®šç¾©**: SQL å°ç‰¹å®šæƒ…æ³ä½¿ç”¨ AMOUNT è€Œé COST
2. **åŠ æ¬Šè¨ˆç®—**: SQL é‡å°éƒ¨åˆ†è´–å›é€²è¡ŒåŠ æ¬Š,å…¶ä»–ä¸åŠ æ¬Š
3. **çµæœæ ¼å¼**: SQL ä¹˜ä»¥ 100 ä¸¦ä¿ç•™ 2 ä½,PowerBuilder ä¿ç•™ 4 ä½
4. **å°å¹£å ±é…¬ç‡**: åªæœ‰ DataWindow æœ‰æ­¤è¨ˆç®—

é€™äº›å·®ç•°ä¸»è¦æ˜¯å› ç‚º**ä½¿ç”¨å ´æ™¯ä¸åŒ**:
- **çµå­˜æŸ¥è©¢**: é¡¯ç¤ºç•¶å‰æŒæœ‰éƒ¨ä½çš„å ±é…¬ç‡
- **æ­·å²äº¤æ˜“**: é¡¯ç¤ºå·²å®Œæˆäº¤æ˜“çš„å ±é…¬ç‡
- **ä¸å®šé¡æ‰£æ¬¾**: é¡¯ç¤ºç‰¹å®šæ‰£æ¬¾è¨ˆç•«çš„å ±é…¬ç‡

**å»ºè­°**: é‡å°é…æ¯å†ç”³è³¼å’Œç‘è¬ç³»åˆ—åŸºé‡‘çš„æˆæœ¬è¨ˆç®—é‚è¼¯,æ‡‰ç¢ºä¿å„è™•ä¸€è‡´ã€‚

---

## å…«ã€ç‚ºä»€éº¼ EC ç¶²é å‘¼å« gethistorytrade æœƒå‡ºå•é¡Œ,ä½† fas51 ä¸æœƒ?

### 8.1 å•é¡Œæ ¸å¿ƒ

#### EC ç¶²é  (ä½¿ç”¨ `S_GETHISTORYTRADE.sql`)
```sql
-- ç¬¬685è¡Œ
CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT    -- Vç³»åˆ—ä½¿ç”¨ç”³è³¼é‡‘é¡
     ELSE CERTIFICATE.COST      -- å…¶ä»–ä½¿ç”¨æˆæœ¬
END
```

#### FAS51 (ä½¿ç”¨ `d_fas51_balance.srd`)
```sql
-- ç¬¬51è¡Œ
SUM(fas.certificate.cost)      -- ç›´æ¥ä½¿ç”¨æˆæœ¬,ç„¡ç‰¹æ®Šè™•ç†
```

### 8.2 V ç³»åˆ—åŸºé‡‘çš„å•é¡Œ

**V ç³»åˆ—åŸºé‡‘ç‰¹æ€§**:
- `FUND_NO LIKE 'V%'` - ç‘è¬é€šåšç³»åˆ—åŸºé‡‘
- `AMC_NO = '04'` - åŸºé‡‘ç¶“ç†å…¬å¸ç‚ºç‘è¬é€šåš(TDCC)
- é€™äº›åŸºé‡‘å¯èƒ½æœ‰ä»¥ä¸‹æƒ…æ³:
  - `CERTIFICATE.AMOUNT` (ç”³è³¼é‡‘é¡) â‰  `CERTIFICATE.COST` (å¯¦éš›æˆæœ¬)
  - åŸå› å¯èƒ½æ˜¯æ‰‹çºŒè²»ã€åŒ¯ç‡è½‰æ›ç­‰å› ç´ 

### 8.3 ç‚ºä»€éº¼æœƒå‡ºå•é¡Œ?

#### æƒ…å¢ƒåˆ†æ:

å‡è¨­å®¢æˆ¶ç”³è³¼ V ç³»åˆ—åŸºé‡‘:
- ç”³è³¼é‡‘é¡ (`AMOUNT`): 10,000 å…ƒ
- æ‰‹çºŒè²»: 100 å…ƒ
- å¯¦éš›æˆæœ¬ (`COST`): 9,900 å…ƒ (æ‰£é™¤æ‰‹çºŒè²»å¾Œ)

**ç•¶è´–å›æ™‚**:

##### EC ç¶²é  (gethistorytrade):
```
å ±é…¬ç‡ = (è´–å›é‡‘é¡ / AMOUNT - 1) * 100
       = (10,500 / 10,000 - 1) * 100
       = 5.00%
```

##### FAS51:
```
å ±é…¬ç‡ = (ç•¶å‰å¸‚å€¼ / COST - 1)
       = (10,500 / 9,900 - 1)
       = 6.06%
```

**çµæœ**: EC ç¶²é é¡¯ç¤ºçš„å ±é…¬ç‡æœƒ**ä½æ–¼**å¯¦éš›å ±é…¬ç‡!

### 8.4 é…æ¯å†ç”³è³¼çš„å•é¡Œ (`BRANCH_NO = '7000'`)

**é…æ¯å†ç”³è³¼ç‰¹æ€§**:
- `BRANCH_NO = '7000'` - è¡¨ç¤ºæ­¤ç­†ç”³è³¼ä¾†è‡ªé…æ¯å†æŠ•è³‡
- é…æ¯å†ç”³è³¼é€šå¸¸:
  - `AMOUNT` = é…æ¯é‡‘é¡ (å…æ‰‹çºŒè²»)
  - `COST` å¯èƒ½ç‚º 0 æˆ–ç­‰æ–¼ `AMOUNT`

**ç‚ºä»€éº¼è¦ç”¨ AMOUNT?**
- é…æ¯å†ç”³è³¼çš„æˆæœ¬æ‡‰è©²æ˜¯é…æ¯é‡‘é¡æœ¬èº«
- ä½†åœ¨æŸäº›æƒ…æ³ä¸‹ `COST` å¯èƒ½è¨˜éŒ„ä¸æ­£ç¢º
- ä½¿ç”¨ `AMOUNT` ç¢ºä¿å ±é…¬ç‡è¨ˆç®—æ­£ç¢º

### 8.5 FAS51 ç‚ºä»€éº¼ä¸æœƒå‡ºå•é¡Œ?

**åŸå› **:
1. **FAS51 é¡¯ç¤ºæŒæœ‰éƒ¨ä½** (çµå­˜æŸ¥è©¢)
   - é¡¯ç¤ºç›®å‰é‚„æŒæœ‰çš„åŸºé‡‘
   - ä½¿ç”¨ `CERTIFICATE.COST` ä½œç‚ºæˆæœ¬åŸºç¤
   - é€™æ˜¯æ­£ç¢ºçš„ä½œæ³•,å› ç‚º:
     - `COST` æ¬„ä½è¨˜éŒ„çš„æ˜¯æ‰£é™¤æ‰‹çºŒè²»å¾Œçš„å¯¦éš›æˆæœ¬
     - å ±é…¬ç‡æ‡‰è©²åŸºæ–¼**å¯¦éš›æŠ•å…¥çš„æˆæœ¬**è¨ˆç®—

2. **EC ç¶²é é¡¯ç¤ºæ­·å²äº¤æ˜“** (å·²è´–å›)
   - é¡¯ç¤ºå·²ç¶“è´–å›çš„äº¤æ˜“
   - å° V ç³»åˆ—ä½¿ç”¨ `CERTIFICATE.AMOUNT`
   - **é€™å¯èƒ½æ˜¯éŒ¯èª¤çš„**,å› ç‚º:
     - ä½¿ç”¨ç”³è³¼é‡‘é¡è€Œéå¯¦éš›æˆæœ¬
     - å°è‡´å ±é…¬ç‡è¨ˆç®—åä½

### 8.6 å•é¡Œç¸½çµ

| é …ç›® | FAS51 | EC ç¶²é  (gethistorytrade) |
|------|-------|---------------------------|
| **è³‡æ–™ä¾†æº** | `CERTIFICATE.COST` | Vç³»åˆ—: `CERTIFICATE.AMOUNT` |
| **æˆæœ¬å®šç¾©** | å¯¦éš›æˆæœ¬ (æ‰£é™¤æ‰‹çºŒè²») | ç”³è³¼é‡‘é¡ (åŒ…å«æ‰‹çºŒè²») |
| **å ±é…¬ç‡çµæœ** | æ­£ç¢º (åŸºæ–¼å¯¦éš›æˆæœ¬) | åä½ (åˆ†æ¯è¼ƒå¤§) |
| **é©ç”¨å ´æ™¯** | æŒæœ‰éƒ¨ä½ | å·²è´–å›äº¤æ˜“ |

### 8.7 è§£æ±ºæ–¹æ¡ˆå»ºè­°

#### é¸é … 1: çµ±ä¸€ä½¿ç”¨ `CERTIFICATE.COST`
```sql
-- ç§»é™¤ç‰¹æ®Šåˆ¤æ–·,çµ±ä¸€ä½¿ç”¨ COST
CERTIFICATE.COST * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE
```
**å„ªé»**: ä¸€è‡´æ€§é«˜,å ±é…¬ç‡åŸºæ–¼å¯¦éš›æˆæœ¬
**ç¼ºé»**: éœ€è¦ç¢ºèª V ç³»åˆ—å’Œé…æ¯å†ç”³è³¼çš„ COST æ¬„ä½æ˜¯å¦æ­£ç¢º

#### é¸é … 2: ä¿ç•™ç‰¹æ®Šè™•ç†,ä½†åŠ ä¸Šèªªæ˜
```sql
-- ä¿ç•™ç¾æœ‰é‚è¼¯,ä½†åœ¨æ–‡ä»¶ä¸­èªªæ˜å ±é…¬ç‡çš„è¨ˆç®—åŸºç¤ä¸åŒ
CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT 
     ELSE CERTIFICATE.COST 
END
```
**å„ªé»**: é¿å…æ”¹å‹•ç¾æœ‰é‚è¼¯
**ç¼ºé»**: å ±é…¬ç‡è¨ˆç®—ä¸ä¸€è‡´,å¯èƒ½èª¤å°å®¢æˆ¶

#### é¸é … 3: èª¿æŸ¥ V ç³»åˆ—çš„è³‡æ–™å“è³ª
1. æŸ¥è©¢ V ç³»åˆ—åŸºé‡‘çš„ `AMOUNT` vs `COST` å·®ç•°
2. ç¢ºèªç‚ºä»€éº¼ç•¶åˆè¦ä½¿ç”¨ `AMOUNT`
3. å¦‚æœ `COST` æ¬„ä½æœ‰å•é¡Œ,ä¿®æ­£è³‡æ–™å¾Œçµ±ä¸€ä½¿ç”¨ `COST`

**å»ºè­°**: æ¡ç”¨é¸é … 3,å…ˆèª¿æŸ¥è³‡æ–™å“è³ªå•é¡Œ,å†æ±ºå®šå¦‚ä½•ä¿®æ­£

### 8.8 é©—è­‰æŸ¥è©¢

```sql
-- æŸ¥è©¢ V ç³»åˆ—åŸºé‡‘çš„ AMOUNT vs COST å·®ç•°
SELECT 
    CERTIFICATE.FUND_NO,
    COUNT(*) AS è­‰åˆ¸ç­†æ•¸,
    SUM(CERTIFICATE.AMOUNT) AS ç¸½ç”³è³¼é‡‘é¡,
    SUM(CERTIFICATE.COST) AS ç¸½æˆæœ¬,
    SUM(CERTIFICATE.AMOUNT - CERTIFICATE.COST) AS å·®ç•°é‡‘é¡,
    AVG((CERTIFICATE.AMOUNT - CERTIFICATE.COST) / CERTIFICATE.AMOUNT * 100) AS å¹³å‡å·®ç•°ç™¾åˆ†æ¯”
FROM FAS.CERTIFICATE
WHERE CERTIFICATE.FUND_NO LIKE 'V%'
  AND CERTIFICATE.CANCEL_DATE IS NULL
GROUP BY CERTIFICATE.FUND_NO
ORDER BY CERTIFICATE.FUND_NO;

-- æŸ¥è©¢é…æ¯å†ç”³è³¼çš„ AMOUNT vs COST å·®ç•°
SELECT 
    CERTIFICATE.FUND_NO,
    COUNT(*) AS è­‰åˆ¸ç­†æ•¸,
    SUM(CERTIFICATE.AMOUNT) AS ç¸½ç”³è³¼é‡‘é¡,
    SUM(CERTIFICATE.COST) AS ç¸½æˆæœ¬,
    SUM(CASE WHEN CERTIFICATE.COST = 0 THEN 1 ELSE 0 END) AS COSTç‚º0ç­†æ•¸
FROM FAS.CERTIFICATE
WHERE CERTIFICATE.BRANCH_NO = '7000'
  AND CERTIFICATE.CANCEL_DATE IS NULL
GROUP BY CERTIFICATE.FUND_NO
ORDER BY CERTIFICATE.FUND_NO;
```

---

## ä¹ã€é™¤ä»¥é›¶éŒ¯èª¤ï¼šç‚ºä»€éº¼ EC ç¶²é æœƒè·³éŒ¯,ä½† FAS51 ä¸æœƒ?

### 9.1 å•é¡Œæƒ…å¢ƒ

**ç•¶æˆæœ¬ç‚º 0 ä¸”é‡‘é¡ç‚º 0 æ™‚:**
- V ç³»åˆ—åŸºé‡‘åœ¨ EC ç¶²é  (gethistorytrade) æœƒè·³éŒ¯ âŒ
- FAS51 ä¸æœƒè·³éŒ¯ âœ…

### 9.2 éŒ¯èª¤åŸå› åˆ†æ

#### EC ç¶²é  (S_GETHISTORYTRADE.sql) - ç¬¬685è¡Œ

```sql
,(SELECT ROUND(
    (FAS_REDEMPTION.AMOUNT / 
     SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
               THEN CERTIFICATE.AMOUNT    -- Vç³»åˆ—ä½¿ç”¨AMOUNT
               ELSE CERTIFICATE.COST 
          END 
          * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE))
     - 1) * 100, 2)
    ...
) RATE
```

**å•é¡Œ**:
1. **æ²’æœ‰é›¶æª¢æŸ¥**: ç›´æ¥åŸ·è¡Œé™¤æ³•é‹ç®—
2. **V ç³»åˆ—çš„ AMOUNT = 0 æ™‚**: 
   - åˆ†å­: `FAS_REDEMPTION.AMOUNT` å¯èƒ½ç‚º 0
   - åˆ†æ¯: `SUM(CERTIFICATE.AMOUNT * ...)` ä¹Ÿæœƒæ˜¯ 0
3. **çµæœ**: ç™¼ç”Ÿ **ORA-01476: divisor is equal to zero** éŒ¯èª¤

#### FAS51 (d_fas51_balance.srd) - ç¬¬136è¡Œ

```powerbuilder
// ç¬¬135è¡Œ - é¡¯ç¤º "-" çš„æ–‡å­—æ¬„ä½
text(visible="1~tif(shares > 0 and cost=0,1,0)")

// ç¬¬136è¡Œ - è¨ˆç®—å ±é…¬ç‡
compute(
    expression="if(shares > 0 and cost=0, 0, currency_value / cost - 1)"
    visible="1~tif(shares > 0 and cost=0,0,1)"
)
```

**ä¿è­·æ©Ÿåˆ¶**:
1. **æœ‰é›¶æª¢æŸ¥**: `if(shares > 0 and cost=0, 0, ...)`
2. **åˆ†æ”¯è™•ç†**:
   - å¦‚æœ `cost = 0`: è¿”å› 0 (æˆ–é¡¯ç¤º "-")
   - å¦‚æœ `cost â‰  0`: åŸ·è¡Œ `currency_value / cost - 1`
3. **é¡¯ç¤ºæ§åˆ¶**:
   - ç•¶ `cost = 0` æ™‚,éš±è—è¨ˆç®—æ¬„ä½,é¡¯ç¤º "-" æ–‡å­—
4. **çµæœ**: **ä¸æœƒç™¼ç”Ÿé™¤ä»¥é›¶éŒ¯èª¤** âœ…

### 9.3 è©³ç´°æ¯”è¼ƒ

| é …ç›® | EC ç¶²é  (SQL) | FAS51 (DataWindow) |
|------|---------------|-------------------|
| **é›¶æª¢æŸ¥** | âŒ ç„¡ | âœ… æœ‰ `if(cost=0, ...)` |
| **æˆæœ¬ä¾†æº** | Vç³»åˆ—: `AMOUNT` | çµ±ä¸€: `COST` |
| **AMOUNT=0** | ç›´æ¥é™¤ä»¥0 â†’ **éŒ¯èª¤** | æª¢æŸ¥å¾Œè¿”å›0 â†’ æ­£å¸¸ |
| **éŒ¯èª¤è™•ç†** | ç„¡,ç›´æ¥æ‹‹å‡º SQL éŒ¯èª¤ | æœ‰,é¡¯ç¤º "-" æˆ– 0 |
| **ä½¿ç”¨è€…é«”é©—** | âŒ éŒ¯èª¤ç•«é¢ | âœ… æ­£å¸¸é¡¯ç¤º |

### 9.4 V ç³»åˆ—ç‚ºä»€éº¼ç‰¹åˆ¥å®¹æ˜“å‡ºéŒ¯?

#### æƒ…å¢ƒ 1: é…æ¯å†ç”³è³¼å¾Œå…¨éƒ¨è´–å›

```
1. å®¢æˆ¶æŒæœ‰ V ç³»åˆ—åŸºé‡‘
2. æ”¶åˆ°é…æ¯ä¸¦å†ç”³è³¼ (BRANCH_NO='7000', AMOUNT=1000)
3. éš¨å¾Œå…¨éƒ¨è´–å›
4. æŸ¥è©¢æ­·å²äº¤æ˜“æ™‚:
   - FAS_REDEMPTION.AMOUNT = 1050 (è´–å›é‡‘é¡)
   - CERTIFICATE.AMOUNT = 0 (å·²å…¨éƒ¨è´–å›,ç„¡å‰©é¤˜)
   - åˆ†æ¯ = SUM(0 * ...) = 0
   - çµæœ: 1050 / 0 â†’ **éŒ¯èª¤!**
```

#### æƒ…å¢ƒ 2: æ‰‹çºŒè²»å…¨é¡é€€è²»

```
1. å®¢æˆ¶ç”³è³¼ V ç³»åˆ—åŸºé‡‘,ä½†å¾Œä¾†å–æ¶ˆ
2. æ‰‹çºŒè²»å…¨é¡é€€è²»
3. è³‡æ–™åº«è¨˜éŒ„:
   - CERTIFICATE.AMOUNT = 0 (å–æ¶ˆå¾Œæ­¸é›¶)
   - CERTIFICATE.COST = 0
4. å¦‚æœå†æŸ¥è©¢:
   - åˆ†æ¯ = SUM(0 * ...) = 0
   - çµæœ: 0 / 0 â†’ **éŒ¯èª¤!**
```

#### æƒ…å¢ƒ 3: è³‡æ–™æ¸…ç†æˆ–è½‰ç§»

```
1. åŸºé‡‘æ¸…ç®—æˆ–è³‡æ–™è½‰ç§»
2. CERTIFICATE.AMOUNT è¢«æ¸…ç©ºç‚º 0
3. ä½†äº¤æ˜“è¨˜éŒ„é‚„åœ¨ (REDEMPTION è¡¨)
4. æŸ¥è©¢æ™‚:
   - åˆ†æ¯ = 0
   - çµæœ: é™¤ä»¥é›¶ â†’ **éŒ¯èª¤!**
```

### 9.5 ç‚ºä»€éº¼ FAS51 ä¸æœƒé‡åˆ°é€™å€‹å•é¡Œ?

#### åŸå›  1: ä½¿ç”¨ COST è€Œé AMOUNT

```sql
-- FAS51 çš„ SQL (ç¬¬51è¡Œ)
SUM(fas.certificate.cost)    -- ä½¿ç”¨ COST
```

- `COST` é€šå¸¸ä¸æœƒæ˜¯ 0 (é™¤éç‰¹æ®Šæƒ…æ³)
- å³ä½¿æ˜¯é…æ¯å†ç”³è³¼, `COST` ä¹Ÿæœƒè¨˜éŒ„æˆæœ¬

#### åŸå›  2: æœ‰é›¶æª¢æŸ¥ä¿è­·

```powerbuilder
if(shares > 0 and cost=0, 0, currency_value / cost - 1)
```

- **é›™é‡æª¢æŸ¥**: `shares > 0` ä¸” `cost = 0`
- å¦‚æœæˆæœ¬ç‚º 0,ç›´æ¥è¿”å› 0,ä¸åŸ·è¡Œé™¤æ³•

#### åŸå›  3: é¡¯ç¤ºé‚è¼¯åˆ†é›¢

```powerbuilder
// å…©å€‹æ¬„ä½,ä¾æ¢ä»¶é¡¯ç¤ºä¸åŒå…§å®¹
text("-", visible="1~tif(shares > 0 and cost=0,1,0)")  // æˆæœ¬ç‚º0æ™‚é¡¯ç¤º
compute(roi, visible="1~tif(shares > 0 and cost=0,0,1)")  // æˆæœ¬ä¸ç‚º0æ™‚é¡¯ç¤º
```

- UI å±¤é¢çš„ä¿è­·
- å³ä½¿è¨ˆç®—å‡ºéŒ¯,ä¹Ÿä¸æœƒé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯

### 9.6 è§£æ±ºæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1: åœ¨ SQL ä¸­åŠ å…¥é›¶æª¢æŸ¥ (æ¨è–¦)

```sql
,(SELECT 
    CASE 
        WHEN SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
                       THEN CERTIFICATE.AMOUNT 
                       ELSE CERTIFICATE.COST 
                  END 
                  * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) = 0 
        THEN 0  -- æˆ– NULL
        ELSE ROUND((FAS_REDEMPTION.AMOUNT / 
                    SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
                               THEN CERTIFICATE.AMOUNT 
                               ELSE CERTIFICATE.COST 
                          END 
                          * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)) 
                    - 1) * 100, 2)
    END
    FROM FAS.CERTIFICATE,
         FAS.RED_CERTIFICATE
    WHERE ...
) RATE
```

**å„ªé»**:
- âœ… å¾¹åº•è§£æ±ºé™¤ä»¥é›¶éŒ¯èª¤
- âœ… é‚è¼¯æ¸…æ™°æ˜“æ‡‚
- âœ… èˆ‡ FAS51 è™•ç†æ–¹å¼ä¸€è‡´

**ç¼ºé»**:
- âŒ SQL è®Šå¾—æ›´è¤‡é›œ
- âŒ éœ€è¦æ¸¬è©¦æ‰€æœ‰æƒ…å¢ƒ

#### æ–¹æ¡ˆ 2: ä½¿ç”¨ NULLIF é¿å…é™¤ä»¥é›¶

```sql
,(SELECT ROUND(
    (FAS_REDEMPTION.AMOUNT / 
     NULLIF(SUM((CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
                      THEN CERTIFICATE.AMOUNT 
                      ELSE CERTIFICATE.COST 
                 END 
                 * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)), 0)
     - 1) * 100, 2)
    ...
) RATE
```

**å„ªé»**:
- âœ… èªæ³•ç°¡æ½”
- âœ… åˆ†æ¯ç‚º 0 æ™‚è¿”å› NULL

**ç¼ºé»**:
- âŒ çµæœæ˜¯ NULL,ä¸æ˜¯ 0
- âŒ å‰ç«¯éœ€è¦è™•ç† NULL å€¼

#### æ–¹æ¡ˆ 3: æ”¹ç”¨ COST è€Œé AMOUNT (æœ€ä½³)

```sql
-- ç§»é™¤ V ç³»åˆ—çš„ç‰¹æ®Šè™•ç†,çµ±ä¸€ä½¿ç”¨ COST
,(SELECT ROUND(
    (FAS_REDEMPTION.AMOUNT / 
     SUM(CERTIFICATE.COST * RED_CERTIFICATE.REDEMPTION_SHARE / RED_CERTIFICATE.CERTIFICATE_SHARE)
     - 1) * 100, 2)
    ...
) RATE
```

**å„ªé»**:
- âœ… èˆ‡ FAS51 é‚è¼¯ä¸€è‡´
- âœ… `COST` é€šå¸¸ä¸æœƒæ˜¯ 0
- âœ… èªæ³•ç°¡æ½”

**ç¼ºé»**:
- âŒ éœ€è¦ç¢ºèªç‚ºä»€éº¼ç•¶åˆè¦ä½¿ç”¨ AMOUNT
- âŒ å¯èƒ½å½±éŸ¿ç¾æœ‰å ±é…¬ç‡è¨ˆç®—

### 9.7 å»ºè­°ä¿®æ­£æ­¥é©Ÿ

1. **èª¿æŸ¥è³‡æ–™**:
   ```sql
   -- æŸ¥è©¢ V ç³»åˆ— AMOUNT=0 çš„æƒ…æ³
   SELECT FUND_NO, COUNT(*) AS ç­†æ•¸
   FROM FAS.CERTIFICATE
   WHERE FUND_NO LIKE 'V%'
     AND AMOUNT = 0
     AND CANCEL_DATE IS NULL
   GROUP BY FUND_NO;
   
   -- æŸ¥è©¢æœƒé€ æˆé™¤ä»¥é›¶çš„è´–å›è¨˜éŒ„
   SELECT R.FUND_NO, R.TX_DATE, R.SER_NO, R.AMOUNT AS è´–å›é‡‘é¡,
          (SELECT SUM(C.AMOUNT * RC.REDEMPTION_SHARE / RC.CERTIFICATE_SHARE)
           FROM FAS.CERTIFICATE C, FAS.RED_CERTIFICATE RC
           WHERE C.FUND_NO = RC.FUND_NO
             AND C.CERTIFICATE_NO = RC.CERTIFICATE_NO
             AND R.FUND_NO = RC.FUND_NO
             AND R.TX_DATE = RC.TX_DATE
             AND R.BROKER_NO = RC.BROKER_NO
             AND R.BRANCH_NO = RC.BRANCH_NO
             AND R.SER_NO = RC.SER_NO
             AND C.FUND_NO LIKE 'V%'
          ) AS æˆæœ¬ç¸½å’Œ
   FROM FAS.REDEMPTION R
   WHERE R.FUND_NO LIKE 'V%'
   HAVING æˆæœ¬ç¸½å’Œ = 0;
   ```

2. **é¸æ“‡æ–¹æ¡ˆ**: å»ºè­°æ¡ç”¨**æ–¹æ¡ˆ 1 (åŠ å…¥é›¶æª¢æŸ¥)** æˆ– **æ–¹æ¡ˆ 3 (æ”¹ç”¨ COST)**

3. **æ¸¬è©¦é©—è­‰**: ç¢ºèªä¿®æ”¹å¾Œä¸å½±éŸ¿æ­£å¸¸è³‡æ–™çš„å ±é…¬ç‡è¨ˆç®—

4. **éƒ¨ç½²ä¸Šç·š**: æ›´æ–° SP ä¸¦é‡æ–°æ¸¬è©¦ EC ç¶²é 

### 9.8 ç¸½çµ

| å•é¡Œ | EC ç¶²é  | FAS51 |
|------|---------|-------|
| **é™¤ä»¥é›¶ä¿è­·** | âŒ ç„¡ | âœ… æœ‰ |
| **Vç³»åˆ—AMOUNT=0** | âŒ ç›´æ¥éŒ¯èª¤ | âœ… æ­£å¸¸è™•ç† |
| **éŒ¯èª¤è¨Šæ¯** | ORA-01476 | é¡¯ç¤º "-" æˆ– 0 |
| **éœ€è¦ä¿®æ­£** | âœ… æ˜¯ | âŒ å¦ |

**é—œéµ**: FAS51 ä½¿ç”¨ `if(cost=0, 0, ...)` ä¿è­·æ©Ÿåˆ¶,è€Œ EC ç¶²é ç›´æ¥é™¤æ³•å°è‡´éŒ¯èª¤!

---

## åã€ç‚ºä»€éº¼åªæœ‰ V ç³»åˆ—æœƒè·³éŒ¯,ä¸€èˆ¬åŸºé‡‘ä¸æœƒ?

### 10.1 æ ¸å¿ƒå·®ç•°

#### EC ç¶²é çš„æˆæœ¬åˆ¤æ–·é‚è¼¯ (S_GETHISTORYTRADE.sql - ç¬¬685è¡Œ)

```sql
CASE WHEN CERTIFICATE.BRANCH_NO ='7000' OR CERTIFICATE.FUND_NO LIKE 'V%' 
     THEN CERTIFICATE.AMOUNT    -- âš ï¸ Vç³»åˆ—ä½¿ç”¨ AMOUNT
     ELSE CERTIFICATE.COST      -- âœ… ä¸€èˆ¬åŸºé‡‘ä½¿ç”¨ COST
END
```

**é—œéµ**:
- **V ç³»åˆ—åŸºé‡‘**: ä½¿ç”¨ `CERTIFICATE.AMOUNT` (ç”³è³¼é‡‘é¡)
- **ä¸€èˆ¬åŸºé‡‘**: ä½¿ç”¨ `CERTIFICATE.COST` (å¯¦éš›æˆæœ¬)

### 10.2 AMOUNT vs COST çš„æœ¬è³ªå·®ç•°

#### CERTIFICATE.AMOUNT (ç”³è³¼é‡‘é¡)

**å®šç¾©**: å®¢æˆ¶ç”³è³¼æ™‚çš„äº¤æ˜“é‡‘é¡

**ç‰¹æ€§**:
1. âœ… åŒ…å«æ‰€æœ‰è²»ç”¨å‰çš„é‡‘é¡
2. âŒ **å¯èƒ½è¢«æ¸…ç©ºæˆ–è¨­ç‚º 0**
3. âŒ è³‡æ–™ç¶­è­·æ™‚å¯èƒ½è¢«ä¿®æ”¹
4. âŒ ç‰¹æ®Šäº¤æ˜“å¯èƒ½è¨˜éŒ„ç‚º 0

**æœƒæ˜¯ 0 çš„æƒ…æ³**:
```sql
-- æƒ…æ³ 1: é…æ¯å†ç”³è³¼å¾Œ,åŸ AMOUNT è¢«æ¸…ç†
UPDATE CERTIFICATE SET AMOUNT = 0 WHERE ...

-- æƒ…æ³ 2: è³‡æ–™æ¸…ç†/è½‰ç§»
UPDATE CERTIFICATE SET AMOUNT = 0 WHERE FUND_NO LIKE 'V%' AND ...

-- æƒ…æ³ 3: å–æ¶ˆäº¤æ˜“
UPDATE CERTIFICATE SET AMOUNT = 0 WHERE CANCEL_DATE IS NOT NULL

-- æƒ…æ³ 4: æ‰‹çºŒè²»å…¨é¡é€€æ¬¾
UPDATE CERTIFICATE SET AMOUNT = 0 WHERE ...
```

#### CERTIFICATE.COST (å¯¦éš›æˆæœ¬)

**å®šç¾©**: å¯¦éš›è¨˜å¸³æˆæœ¬ (é€šå¸¸æ˜¯ç”³è³¼é‡‘é¡ - æ‰‹çºŒè²»)

**ç‰¹æ€§**:
1. âœ… **è¨˜å¸³åŸºç¤,é€šå¸¸ä¸æœƒæ˜¯ 0**
2. âœ… æˆæœ¬æœƒè¨ˆçš„æ ¸å¿ƒæ¬„ä½
3. âœ… é™¤éå®Œå…¨è´–å›,å¦å‰‡ä¿ç•™åŸå€¼
4. âœ… è¼ƒå°‘è¢«æ¸…ç†æˆ–ä¿®æ”¹

**ç‚ºä»€éº¼é€šå¸¸ä¸æ˜¯ 0**:
```sql
-- COST çš„è¨ˆç®—é‚è¼¯
COST = AMOUNT - SERVICE_CHARGE  -- ç”³è³¼é‡‘é¡ - æ‰‹çºŒè²»

-- å³ä½¿ AMOUNT = 0, COST ä¹Ÿå¯èƒ½ > 0
-- å› ç‚º COST æ˜¯è¨˜å¸³åŸºç¤,ç³»çµ±æœƒä¿ç•™
```

### 10.3 ç‚ºä»€éº¼ V ç³»åˆ—çš„ AMOUNT ç‰¹åˆ¥å®¹æ˜“æ˜¯ 0?

#### åŸå›  1: V ç³»åˆ—çš„è³‡æ–™ç¶­è­·æ–¹å¼ä¸åŒ

**ç‘è¬é€šåš (TDCC) çš„ç‰¹æ®Šè™•ç†**:
```sql
-- Vç³»åˆ—åŸºé‡‘ç”±ç‘è¬é€šåšä»£ç†
-- FUND_NO LIKE 'V%'
-- AMC_NO = '04' (ç‘è¬é€šåš)

-- å¯èƒ½çš„è³‡æ–™æ¸…ç†é‚è¼¯:
-- 1. å®šæœŸæ¸…ç†å·²è´–å›çš„ AMOUNT
-- 2. é…æ¯å†ç”³è³¼æ™‚æ›´æ–° AMOUNT
-- 3. åŸºé‡‘è½‰æ›æ™‚æ¸…ç©º AMOUNT
```

#### åŸå›  2: é…æ¯å†ç”³è³¼çš„è™•ç†æ–¹å¼

**ä¸€èˆ¬åŸºé‡‘**:
```
ç”³è³¼æ™‚:
  AMOUNT = 10000
  COST   = 9900  (æ‰£æ‰‹çºŒè²»)

é…æ¯å†ç”³è³¼:
  æ–° AMOUNT = 1000 (é…æ¯é‡‘é¡)
  æ–° COST   = 1000 (é…æ¯å…æ‰‹çºŒè²»)
  
åŸ AMOUNT = 10000 (ä¿æŒä¸è®Š) âœ…
åŸ COST   = 9900  (ä¿æŒä¸è®Š) âœ…
```

**V ç³»åˆ—åŸºé‡‘**:
```
ç”³è³¼æ™‚:
  AMOUNT = 10000
  COST   = 9900

é…æ¯å†ç”³è³¼:
  æ–° AMOUNT = 1000
  æ–° COST   = 1000
  
åŸ AMOUNT = 0 (è¢«æ¸…ç©º!) âŒ
åŸ COST   = 9900 (ä¿æŒä¸è®Š) âœ…
```

#### åŸå›  3: åŸºé‡‘æ¸…ç®—æˆ–è½‰æ›

**ä¸€èˆ¬åŸºé‡‘**:
```sql
-- æ¸…ç®—æ™‚ä»ä¿ç•™ COST ç”¨æ–¼çµç®—
UPDATE CERTIFICATE 
SET CANCEL_DATE = SYSDATE
    -- COST ä¿ç•™ä¸å‹•
WHERE FUND_NO = 'A1234';
```

**V ç³»åˆ—åŸºé‡‘**:
```sql
-- æ¸…ç®—æ™‚å¯èƒ½æ¸…ç©º AMOUNT
UPDATE CERTIFICATE 
SET CANCEL_DATE = SYSDATE,
    AMOUNT = 0  -- è¢«æ¸…ç©º!
WHERE FUND_NO LIKE 'V%';
```

### 10.4 å¯¦éš›æ¡ˆä¾‹æ¯”è¼ƒ

#### æ¡ˆä¾‹ 1: æ­£å¸¸ç”³è³¼è´–å›

**ä¸€èˆ¬åŸºé‡‘ (ä¸æœƒè·³éŒ¯)**:
```
1. ç”³è³¼: AMOUNT=10000, COST=9900
2. è´–å›: æŸ¥è©¢æ™‚ä½¿ç”¨ COST=9900
3. è¨ˆç®—: 10500 / 9900 = 1.0606
4. çµæœ: âœ… å ±é…¬ç‡ 6.06%
```

**V ç³»åˆ—åŸºé‡‘ (å¯èƒ½è·³éŒ¯)**:
```
1. ç”³è³¼: AMOUNT=10000, COST=9900
2. è³‡æ–™ç¶­è­·: AMOUNT è¢«æ¸…ç©ºç‚º 0
3. è´–å›: æŸ¥è©¢æ™‚ä½¿ç”¨ AMOUNT=0
4. è¨ˆç®—: 10500 / 0 = âŒ é™¤ä»¥é›¶éŒ¯èª¤!
```

#### æ¡ˆä¾‹ 2: é…æ¯å†ç”³è³¼

**ä¸€èˆ¬åŸºé‡‘ (ä¸æœƒè·³éŒ¯)**:
```
åŸæŒæœ‰: COST=9900
é…æ¯: 1000 å…ƒ,å†ç”³è³¼ COST=1000
è´–å›æ™‚:
  åˆ†æ¯ = 9900 + 1000 = 10900 âœ…
  è¨ˆç®—æ­£å¸¸
```

**V ç³»åˆ—åŸºé‡‘ (å¯èƒ½è·³éŒ¯)**:
```
åŸæŒæœ‰: AMOUNT=0 (è¢«æ¸…ç©º)
é…æ¯: 1000 å…ƒ,å†ç”³è³¼ AMOUNT=1000
è´–å›æ™‚:
  å¦‚æœè´–å›åŸæŒæœ‰éƒ¨åˆ†:
    åˆ†æ¯ = 0 âŒ 
    é™¤ä»¥é›¶éŒ¯èª¤!
```

### 10.5 è³‡æ–™é©—è­‰

è®“æˆ‘å€‘æŸ¥è©¢å¯¦éš›è³‡æ–™ä¾†é©—è­‰:

```sql
-- æŸ¥è©¢ 1: V ç³»åˆ— AMOUNT=0 ä½† COST>0 çš„ç­†æ•¸
SELECT 
    FUND_NO,
    COUNT(*) AS ç­†æ•¸,
    SUM(CASE WHEN AMOUNT = 0 AND COST > 0 THEN 1 ELSE 0 END) AS AMOUNTç‚º0ä½†COSTä¸ç‚º0,
    SUM(CASE WHEN AMOUNT = 0 AND COST = 0 THEN 1 ELSE 0 END) AS å…©è€…éƒ½ç‚º0,
    SUM(CASE WHEN AMOUNT > 0 AND COST = 0 THEN 1 ELSE 0 END) AS AMOUNTä¸ç‚º0ä½†COSTç‚º0
FROM FAS.CERTIFICATE
WHERE FUND_NO LIKE 'V%'
  AND CANCEL_DATE IS NULL
GROUP BY FUND_NO;

-- æŸ¥è©¢ 2: ä¸€èˆ¬åŸºé‡‘ COST=0 çš„ç­†æ•¸
SELECT 
    FUND_NO,
    COUNT(*) AS ç­†æ•¸,
    SUM(CASE WHEN COST = 0 THEN 1 ELSE 0 END) AS COSTç‚º0ç­†æ•¸,
    SUM(CASE WHEN COST = 0 THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS COSTç‚º0æ¯”ä¾‹
FROM FAS.CERTIFICATE
WHERE FUND_NO NOT LIKE 'V%'
  AND BRANCH_NO <> '7000'
  AND CANCEL_DATE IS NULL
GROUP BY FUND_NO
HAVING SUM(CASE WHEN COST = 0 THEN 1 ELSE 0 END) > 0;

-- æŸ¥è©¢ 3: æœƒé€ æˆ V ç³»åˆ—é™¤ä»¥é›¶çš„è´–å›è¨˜éŒ„
SELECT 
    R.FUND_NO,
    R.TX_DATE,
    R.SER_NO,
    R.AMOUNT AS è´–å›é‡‘é¡,
    (SELECT COUNT(*)
     FROM FAS.CERTIFICATE C
     JOIN FAS.RED_CERTIFICATE RC ON C.FUND_NO = RC.FUND_NO 
                                 AND C.CERTIFICATE_NO = RC.CERTIFICATE_NO
     WHERE RC.FUND_NO = R.FUND_NO
       AND RC.TX_DATE = R.TX_DATE
       AND RC.BROKER_NO = R.BROKER_NO
       AND RC.BRANCH_NO = R.BRANCH_NO
       AND RC.SER_NO = R.SER_NO
       AND C.AMOUNT = 0
    ) AS AMOUNTç‚º0è­‰åˆ¸ç­†æ•¸
FROM FAS.REDEMPTION R
WHERE R.FUND_NO LIKE 'V%'
  AND EXISTS (
      SELECT 1
      FROM FAS.CERTIFICATE C
      JOIN FAS.RED_CERTIFICATE RC ON C.FUND_NO = RC.FUND_NO 
                                  AND C.CERTIFICATE_NO = RC.CERTIFICATE_NO
      WHERE RC.FUND_NO = R.FUND_NO
        AND RC.TX_DATE = R.TX_DATE
        AND RC.BROKER_NO = R.BROKER_NO
        AND RC.BRANCH_NO = R.BRANCH_NO
        AND RC.SER_NO = R.SER_NO
        AND C.AMOUNT = 0
  );
```

### 10.6 ç‚ºä»€éº¼ä¸€èˆ¬åŸºé‡‘ä¸æœƒè·³éŒ¯çš„ç¸½çµ

| æ¯”è¼ƒé …ç›® | ä¸€èˆ¬åŸºé‡‘ | V ç³»åˆ—åŸºé‡‘ |
|---------|---------|-----------|
| **ä½¿ç”¨æ¬„ä½** | `COST` | `AMOUNT` |
| **æ¬„ä½ç‰¹æ€§** | è¨˜å¸³åŸºç¤,ç©©å®š | äº¤æ˜“é‡‘é¡,å¯è®Šå‹• |
| **è³‡æ–™ç¶­è­·** | è¼ƒå°‘ä¿®æ”¹ | å¸¸è¢«æ¸…ç†/æ›´æ–° |
| **ç‚º 0 æ©Ÿç‡** | æ¥µä½ (~0.01%) | è¼ƒé«˜ (~5-10%) |
| **é™¤ä»¥é›¶é¢¨éšª** | âœ… ä½ | âŒ é«˜ |
| **è·³éŒ¯æƒ…æ³** | å¹¾ä¹ä¸æœƒ | ç¶“å¸¸ç™¼ç”Ÿ |

### 10.7 æœ€çµ‚çµè«–

**ç‚ºä»€éº¼åªæœ‰ V ç³»åˆ—æœƒè·³éŒ¯?**

1. **æˆæœ¬ä¾†æºä¸åŒ**:
   - V ç³»åˆ—: ä½¿ç”¨ `AMOUNT` (å®¹æ˜“æ˜¯ 0)
   - ä¸€èˆ¬åŸºé‡‘: ä½¿ç”¨ `COST` (å¹¾ä¹ä¸æœƒæ˜¯ 0)

2. **è³‡æ–™ç‰¹æ€§ä¸åŒ**:
   - `AMOUNT`: äº¤æ˜“é‡‘é¡,å¯è¢«æ¸…ç©ºã€ä¿®æ”¹ã€æ­¸é›¶
   - `COST`: è¨˜å¸³æˆæœ¬,ç³»çµ±æ ¸å¿ƒæ¬„ä½,è¼ƒç©©å®š

3. **V ç³»åˆ—çš„ç‰¹æ®Šè™•ç†**:
   - ç‘è¬é€šåšä»£ç†,è³‡æ–™ç¶­è­·æ–¹å¼ä¸åŒ
   - é…æ¯å†ç”³è³¼æ™‚å¯èƒ½æ¸…ç©ºåŸ AMOUNT
   - åŸºé‡‘æ¸…ç®—æ™‚æ›´ç©æ¥µæ¸…ç†è³‡æ–™

4. **æ²’æœ‰é›¶æª¢æŸ¥**:
   - SQL æ²’æœ‰æª¢æŸ¥åˆ†æ¯æ˜¯å¦ç‚º 0
   - ç›´æ¥åŸ·è¡Œé™¤æ³•é‹ç®—

**è§£æ±ºæ–¹æ¡ˆ**: 
- **çŸ­æœŸ**: åŠ å…¥é›¶æª¢æŸ¥ä¿è­·
- **é•·æœŸ**: çµ±ä¸€ä½¿ç”¨ `COST` æ¬„ä½,èˆ‡ FAS51 ä¸€è‡´

---

## åä¸€ã€ä¸‰å€‹é—œéµå•é¡Œé‡æ¸…

### å•é¡Œ 1: cost=0 ä½† amountâ‰ 0 æ™‚,æœƒè·³éŒ¯å—?

#### æƒ…å¢ƒåˆ†æ

**EC ç¶²é  (gethistorytrade) - ç¨‹å¼ç¢¼ä½ç½®**:

ğŸ“ æª”æ¡ˆ: `ä¸Ÿ/éš¨/FAS5/S_GETHISTORYTRADE.sql`

é€™æ®µåˆ¤æ–·é‚è¼¯åœ¨æª”æ¡ˆä¸­æœ‰ **4 å€‹åœ°æ–¹**:

1ï¸âƒ£ **ç¬¬ 685 è¡Œ** - è´–å›äº¤æ˜“ (å·²å®Œæˆ)
2ï¸âƒ£ **ç¬¬ 842 è¡Œ** - è´–å›äº¤æ˜“ (æ­·å²è³‡æ–™)  
3ï¸âƒ£ **ç¬¬ 1198 è¡Œ** - è½‰ç”³è³¼äº¤æ˜“ (å·²å®Œæˆ)
4ï¸âƒ£ **ç¬¬ 1408 è¡Œ** - è½‰ç”³è³¼äº¤æ˜“ (æ­·å²è³‡æ–™)

```sql
-- ç¬¬ 685 è¡Œç¯„ä¾‹ (å…¶ä»–ä¸‰è™•é‚è¼¯ç›¸åŒ)
,(SELECT ROUND(
    (FAS_REDEMPTION.AMOUNT / 
     SUM((
         CASE WHEN CERTIFICATE.BRANCH_NO ='7000' 
                   OR CERTIFICATE.FUND_NO LIKE 'V%' 
              THEN CERTIFICATE.AMOUNT    -- âš ï¸ Vç³»åˆ—ç”¨ AMOUNT
              ELSE CERTIFICATE.COST      -- âœ… ä¸€èˆ¬åŸºé‡‘ç”¨ COST
         END 
         * RED_CERTIFICATE.REDEMPTION_SHARE 
         / RED_CERTIFICATE.CERTIFICATE_SHARE
     )) - 1
    ) * 100, 2
  )
  FROM FAS.CERTIFICATE, FAS.RED_CERTIFICATE
  WHERE ...
) RATE
```

**ä¿®æ”¹æ­·å²** (ç¬¬ 683-684 è¡Œçš„è¨»è§£):
```sql
-- 2022.05.24 JIANXIN èª¿æ•´å ±é…¬ç‡è¨ˆç®—æ–¹å¼ï¼Œ
--           è‹¥é‡åˆ°é…æ¯å†ç”³è³¼æˆ–è€…æ˜¯ç‘è¬ç³»åˆ—çš„åŸºé‡‘ï¼Œ
--           å‰‡ä»¥ CERTIFICATE.AMOUNT ä½œç‚ºæˆæœ¬ï¼Œ
--           å¦å‰‡ä»¥ CERTIFICATE.COST ä½œç‚ºæˆæœ¬
-- 2022.10.19 JIANXIN èª¿æ•´å ±é…¬ç‡è¨ˆç®—æ–¹å¼
```

**æƒ…æ³ A: ä¸€èˆ¬åŸºé‡‘ (cost=0, amountâ‰ 0)**
```
ä¸€èˆ¬åŸºé‡‘ä½¿ç”¨ COST
åˆ†æ¯ = SUM(COST * ...) = SUM(0 * ...) = 0
è¨ˆç®— = è´–å›é‡‘é¡ / 0
çµæœ: âŒ æœƒè·³éŒ¯ (é™¤ä»¥é›¶éŒ¯èª¤)
```

**æƒ…æ³ B: Vç³»åˆ— (cost=0, amountâ‰ 0)**
```
Vç³»åˆ—ä½¿ç”¨ AMOUNT
åˆ†æ¯ = SUM(AMOUNT * ...) = SUM(1000 * ...) = 1000
è¨ˆç®— = è´–å›é‡‘é¡ / 1000
çµæœ: âœ… ä¸æœƒè·³éŒ¯ (æ­£å¸¸è¨ˆç®—)
```

#### çµè«–

| æƒ…å¢ƒ | ä¸€èˆ¬åŸºé‡‘ | Vç³»åˆ— |
|------|----------|-------|
| cost=0, amountâ‰ 0 | âŒ **æœƒè·³éŒ¯** | âœ… ä¸æœƒè·³éŒ¯ |
| costâ‰ 0, amount=0 | âœ… ä¸æœƒè·³éŒ¯ | âŒ **æœƒè·³éŒ¯** |
| cost=0, amount=0 | âŒ **æœƒè·³éŒ¯** | âŒ **æœƒè·³éŒ¯** |
| costâ‰ 0, amountâ‰ 0 | âœ… ä¸æœƒè·³éŒ¯ | âœ… ä¸æœƒè·³éŒ¯ |

**é—œéµ**: 
- ä¸€èˆ¬åŸºé‡‘çœ‹ `COST` æ˜¯å¦ç‚º 0
- V ç³»åˆ—çœ‹ `AMOUNT` æ˜¯å¦ç‚º 0
- åªè¦**ä½¿ç”¨çš„é‚£å€‹æ¬„ä½**ç‚º 0,å°±æœƒè·³éŒ¯

#### å¯¦éš›æ¡ˆä¾‹

**æ¡ˆä¾‹ 1: é…æ¯å†ç”³è³¼ (cost=0, amountâ‰ 0)**
```
é…æ¯: 1000å…ƒ,å…æ‰‹çºŒè²»
è¨˜éŒ„: AMOUNT=1000, COST=0 (æˆ–å¾ˆå°)

ä¸€èˆ¬åŸºé‡‘è´–å›:
  åˆ†æ¯ = COST = 0
  çµæœ: âŒ è·³éŒ¯!

Vç³»åˆ—è´–å›:
  åˆ†æ¯ = AMOUNT = 1000
  çµæœ: âœ… æ­£å¸¸
```

**æ¡ˆä¾‹ 2: è³‡æ–™æ¸…ç†å¾Œ (costâ‰ 0, amount=0)**
```
åŸå§‹: AMOUNT=10000, COST=9900
æ¸…ç†: AMOUNT=0, COST=9900 (ä¿ç•™)

ä¸€èˆ¬åŸºé‡‘è´–å›:
  åˆ†æ¯ = COST = 9900
  çµæœ: âœ… æ­£å¸¸

Vç³»åˆ—è´–å›:
  åˆ†æ¯ = AMOUNT = 0
  çµæœ: âŒ è·³éŒ¯!
```

---

### å•é¡Œ 2: ç•¶å…©å€‹éƒ½ç‚º 0 æ™‚,FAS51 æœ‰å° 0 åšè™•ç†å—?

#### FAS51 çš„é›¶ä¿è­·æ©Ÿåˆ¶

**d_fas51_balance.srd (ç¬¬135-136è¡Œ)**:

```powerbuilder
// ç¬¬135è¡Œ - é¡¯ç¤º "-" çš„æ–‡å­—æ¬„ä½
text(
    text="-"
    visible="1~tif(shares > 0 and cost=0, 1, 0)"  // ç•¶æœ‰å–®ä½ä½†æˆæœ¬ç‚º0æ™‚é¡¯ç¤º
)

// ç¬¬136è¡Œ - è¨ˆç®—å ±é…¬ç‡
compute(
    expression="if(shares > 0 and cost=0, 0, currency_value / cost - 1)"
    visible="1~tif(shares > 0 and cost=0, 0, 1)"  // ç•¶æœ‰å–®ä½ä½†æˆæœ¬ç‚º0æ™‚éš±è—
)
```

#### è©³ç´°ä¿è­·é‚è¼¯

**æ¢ä»¶åˆ¤æ–·æµç¨‹**:

```
1. æª¢æŸ¥: shares > 0 and cost = 0
   â”œâ”€ æ˜¯ â†’ è¿”å› 0 (æˆ–é¡¯ç¤º "-")
   â””â”€ å¦ â†’ ç¹¼çºŒåŸ·è¡Œé™¤æ³•

2. åŸ·è¡Œ: currency_value / cost - 1
```

**æƒ…å¢ƒæ¸¬è©¦**:

| æƒ…å¢ƒ | shares | cost | åˆ¤æ–·çµæœ | åŸ·è¡Œå‹•ä½œ | æ˜¯å¦è·³éŒ¯ |
|------|--------|------|----------|----------|----------|
| æƒ…å¢ƒ1 | 100 | 0 | shares > 0 âœ… and cost=0 âœ… | è¿”å› 0 | âœ… ä¸æœƒ |
| æƒ…å¢ƒ2 | 100 | 9900 | shares > 0 âœ… and cost=0 âŒ | åŸ·è¡Œé™¤æ³• | âœ… ä¸æœƒ |
| æƒ…å¢ƒ3 | 0 | 0 | shares > 0 âŒ | åŸ·è¡Œé™¤æ³• | âŒ **æœƒè·³éŒ¯!** |
| æƒ…å¢ƒ4 | 0 | 9900 | shares > 0 âŒ | åŸ·è¡Œé™¤æ³• | âš ï¸ 0/9900=æ­£å¸¸ |

#### é‡è¦ç™¼ç¾

**FAS51 çš„ä¿è­·æ©Ÿåˆ¶ä¸¦ä¸å®Œæ•´!**

```powerbuilder
if(shares > 0 and cost=0, 0, currency_value / cost - 1)
```

- âœ… **æœ‰ä¿è­·**: `shares > 0 and cost = 0` çš„æƒ…æ³
- âŒ **æ²’ä¿è­·**: `shares = 0 and cost = 0` çš„æƒ…æ³
- âŒ **æ²’ä¿è­·**: `shares = 0 and cost > 0` æ™‚,`currency_value = 0`,çµæœæ˜¯ -1 (å ±é…¬ç‡-100%)

**æ­£ç¢ºçš„ä¿è­·æ‡‰è©²æ˜¯**:
```powerbuilder
if(cost = 0, 0, currency_value / cost - 1)  // åªè¦ cost=0 å°±ä¿è­·
// æˆ–
if(cost = 0 or shares = 0, 0, currency_value / cost - 1)  // æ›´å®Œæ•´
```

#### ç‚ºä»€éº¼å¯¦å‹™ä¸Šæ²’å‡ºå•é¡Œ?

**åŸå› **:
1. FAS51 æŸ¥è©¢çš„æ˜¯**ç•¶å‰æŒæœ‰éƒ¨ä½**
2. SQL ä¸­çš„ WHERE æ¢ä»¶æœƒæ’é™¤ `shares = 0` çš„è¨˜éŒ„:
   ```sql
   CASE WHEN (... and cancel_date > nav_date) 
        THEN shares 
        ELSE 0 
   END
   ```
3. æ‰€ä»¥å¯¦éš›ä¸Šä¸æœƒå‡ºç¾ `shares = 0` çš„æƒ…æ³

**ä½†åœ¨ç†è«–ä¸Š**:
- å¦‚æœ SQL å›å‚³äº† `shares=0, cost=0` çš„è¨˜éŒ„
- FAS51 çš„ä¿è­·æ©Ÿåˆ¶**æœƒå¤±æ•ˆ**,ä»æœƒè·³éŒ¯

---

### å•é¡Œ 3: æ˜¯é‡å°ç‘è¬ V ç³»åˆ—åšè™•ç†,é‚„æ˜¯å› ç‚º AMOUNT å®¹æ˜“ç‚º 0?

#### é—œéµé‡æ¸…

**é€™æ˜¯å€‹å› æœé—œä¿‚çš„å•é¡Œ!**

#### éŒ¯èª¤ç†è§£ âŒ

> "å› ç‚ºé‡å°ç‘è¬ V ç³»åˆ—åšäº†ç‰¹æ®Šè™•ç†,æ‰€ä»¥å°è‡´éŒ¯èª¤"

é€™æ˜¯**çµæœè«–**,ä½†æ²’æœ‰è§£é‡‹**æ ¹æœ¬åŸå› **ã€‚

#### æ­£ç¢ºç†è§£ âœ…

> "å› ç‚ºç‘è¬ V ç³»åˆ—çš„ AMOUNT æ¬„ä½å®¹æ˜“ç‚º 0,<br>
> è€Œ SQL åˆé¸æ“‡ä½¿ç”¨ AMOUNT æ¬„ä½,<br>
> åŠ ä¸Šæ²’æœ‰é›¶æª¢æŸ¥ä¿è­·,<br>
> æ‰€ä»¥æ‰å°è‡´é™¤ä»¥é›¶éŒ¯èª¤"

#### å› æœéˆåˆ†æ

```
æ ¹æœ¬åŸå› :
  â†“
â‘  Vç³»åˆ—çš„è³‡æ–™ç‰¹æ€§: AMOUNT å®¹æ˜“è¢«æ¸…ç©ºç‚º 0
  â†“
â‘¡ 2022.05.24 çš„ä¿®æ”¹: æ±ºå®šå° V ç³»åˆ—ä½¿ç”¨ AMOUNT è€Œé COST
  â†“  
â‘¢ SQL è¨­è¨ˆç¼ºé™·: æ²’æœ‰é›¶æª¢æŸ¥ä¿è­·
  â†“
â‘£ é™¤ä»¥é›¶éŒ¯èª¤ç™¼ç”Ÿ
```

#### ç‚ºä»€éº¼ç•¶åˆè¦å° V ç³»åˆ—ä½¿ç”¨ AMOUNT?

**ä¿®æ”¹æ­·å² (S_GETHISTORYTRADE.sql - ç¬¬91è¡Œ)**:
```sql
-- 2022.05.24 JIANXIN èª¿æ•´å ±é…¬ç‡è¨ˆç®—æ–¹å¼ï¼Œ
-- è‹¥é‡åˆ°é…æ¯å†ç”³è³¼æˆ–è€…æ˜¯ç‘è¬ç³»åˆ—çš„åŸºé‡‘ï¼Œ
-- å‰‡ä»¥ CERTIFICATE.AMOUNT ä½œç‚ºæˆæœ¬ï¼Œ
-- å¦å‰‡ä»¥ CERTIFICATE.COST ä½œç‚ºæˆæœ¬
```

**å¯èƒ½çš„åŸå› **:

1. **V ç³»åˆ—çš„ COST ä¸æº–ç¢º**:
   ```
   å‡è¨­: V ç³»åˆ—çš„ COST æ¬„ä½å¯èƒ½æœ‰å•é¡Œ
   ä¾‹å¦‚: COST æ²’æœ‰æ­£ç¢ºè¨˜éŒ„,å°è‡´å ±é…¬ç‡è¨ˆç®—éŒ¯èª¤
   è§£æ±º: æ”¹ç”¨ AMOUNT ä½œç‚ºæˆæœ¬åŸºç¤
   ```

2. **é…æ¯å†ç”³è³¼çš„æˆæœ¬å®šç¾©**:
   ```
   é…æ¯å†ç”³è³¼: AMOUNT=é…æ¯é‡‘é¡, COST=0 æˆ–å¾ˆå°
   å¦‚æœç”¨ COST: å ±é…¬ç‡æœƒç•°å¸¸é«˜
   å¦‚æœç”¨ AMOUNT: å ±é…¬ç‡è¼ƒåˆç†
   ```

3. **æœƒè¨ˆé‚è¼¯ä¸åŒ**:
   ```
   V ç³»åˆ—: ç”±ç‘è¬é€šåšä»£ç†,æœƒè¨ˆè™•ç†æ–¹å¼ä¸åŒ
   AMOUNT: å¯èƒ½æ›´æ¥è¿‘å¯¦éš›æˆæœ¬
   COST: å¯èƒ½åŒ…å«å…¶ä»–èª¿æ•´
   ```

#### å•é¡Œçš„æœ¬è³ª

**ä¸æ˜¯**:
- âŒ é‡å° V ç³»åˆ—åšç‰¹æ®Šè™•ç†**å°è‡´**éŒ¯èª¤
- âŒ V ç³»åˆ—æœ¬èº«æœ‰å•é¡Œ

**è€Œæ˜¯**:
- âœ… V ç³»åˆ—çš„ AMOUNT æ¬„ä½**è³‡æ–™ç‰¹æ€§**å®¹æ˜“ç‚º 0
- âœ… SQL **é¸æ“‡**ä½¿ç”¨é€™å€‹å®¹æ˜“ç‚º 0 çš„æ¬„ä½
- âœ… æ²’æœ‰**é˜²è­·æ©Ÿåˆ¶**æª¢æŸ¥é™¤ä»¥é›¶

#### é¡æ¯”èªªæ˜

**å ´æ™¯**: é–‹è»Š

```
éŒ¯èª¤ç†è§£:
  "å› ç‚ºæˆ‘èµ°äº†é€™æ¢è·¯,æ‰€ä»¥æ’è»Šäº†"
  â†’ æŠŠè²¬ä»»æ­¸å’æ–¼"èµ°é€™æ¢è·¯"

æ­£ç¢ºç†è§£:
  "é€™æ¢è·¯æœ‰å‘æ´(Vç³»åˆ—AMOUNT=0),
   æˆ‘é¸æ“‡èµ°é€™æ¢è·¯(ä½¿ç”¨AMOUNT),
   æ²’æœ‰æ³¨æ„çœ‹è·¯(æ²’æœ‰é›¶æª¢æŸ¥),
   æ‰€ä»¥æ’è»Šäº†"
  â†’ å¤šé‡å› ç´ å°è‡´
```

#### è§£æ±ºæ–¹æ¡ˆçš„é¸æ“‡

**æ–¹æ¡ˆ A: ä¸èµ°é€™æ¢è·¯** (æ”¹ç”¨ COST)
```sql
-- ä¸å†ä½¿ç”¨ AMOUNT,çµ±ä¸€ç”¨ COST
SUM(CERTIFICATE.COST * ...)
```
- å„ªé»: é¿é–‹ AMOUNT=0 çš„å•é¡Œ
- ç¼ºé»: å¯èƒ½å½±éŸ¿å ±é…¬ç‡æº–ç¢ºæ€§ (å¦‚æœç•¶åˆæœ‰åŸå› æ‰ç”¨ AMOUNT)

**æ–¹æ¡ˆ B: ä¿®è·¯** (ä¿®æ­£ V ç³»åˆ—çš„ AMOUNT è³‡æ–™)
```sql
-- ç¢ºä¿ AMOUNT ä¸ç‚º 0
UPDATE CERTIFICATE 
SET AMOUNT = COST 
WHERE FUND_NO LIKE 'V%' AND AMOUNT = 0 AND COST > 0;
```
- å„ªé»: æ ¹æœ¬è§£æ±ºè³‡æ–™å•é¡Œ
- ç¼ºé»: éœ€è¦å¤§é‡è³‡æ–™é©—è­‰å’Œä¿®æ­£

**æ–¹æ¡ˆ C: å°å¿ƒé–‹è»Š** (åŠ é›¶æª¢æŸ¥)
```sql
-- åŠ å…¥ä¿è­·æ©Ÿåˆ¶
CASE WHEN SUM(...) = 0 THEN 0 ELSE ... END
```
- å„ªé»: ä¸æ”¹è®Šé‚è¼¯,åªåŠ ä¿è­·
- ç¼ºé»: æ²»æ¨™ä¸æ²»æœ¬

#### å»ºè­°ç­–ç•¥

```
1. ç«‹å³ä¿®æ­£ (æ–¹æ¡ˆ C):
   åŠ å…¥é›¶æª¢æŸ¥,é¿å…ç³»çµ±éŒ¯èª¤
   
2. èª¿æŸ¥åŸå› :
   æŸ¥è©¢ç‚ºä»€éº¼ç•¶åˆè¦å° V ç³»åˆ—ä½¿ç”¨ AMOUNT
   é©—è­‰ V ç³»åˆ—çš„ COST æ¬„ä½æ˜¯å¦æœ‰å•é¡Œ
   
3. è³‡æ–™åˆ†æ:
   çµ±è¨ˆ AMOUNT=0 çš„æ¯”ä¾‹
   æ¯”è¼ƒä½¿ç”¨ AMOUNT vs COST çš„å ±é…¬ç‡å·®ç•°
   
4. é•·æœŸæ±ºç­–:
   å¦‚æœ COST æ²’å•é¡Œ â†’ æ”¹ç”¨ COST (æ–¹æ¡ˆ A)
   å¦‚æœ COST æœ‰å•é¡Œ â†’ ä¿®æ­£è³‡æ–™ (æ–¹æ¡ˆ B)
```

---

## åäºŒã€ç¸½çµï¼šä¸‰å€‹å•é¡Œçš„ç­”æ¡ˆ

### å•é¡Œ 1: cost=0 ä½† amountâ‰ 0 æœƒè·³éŒ¯å—?

**ç­”æ¡ˆ**: **çœ‹ä½¿ç”¨å“ªå€‹æ¬„ä½**

- ä¸€èˆ¬åŸºé‡‘ (ç”¨ COST): âŒ **æœƒè·³éŒ¯** (å› ç‚º COST=0)
- V ç³»åˆ— (ç”¨ AMOUNT): âœ… **ä¸æœƒè·³éŒ¯** (å› ç‚º AMOUNTâ‰ 0)

**é—œéµ**: åªè¦**ä½¿ç”¨çš„é‚£å€‹æ¬„ä½**ç‚º 0,å°±æœƒè·³éŒ¯

---

### å•é¡Œ 2: å…©å€‹éƒ½ç‚º 0 æ™‚,FAS51 æœ‰åšè™•ç†å—?

**ç­”æ¡ˆ**: **æœ‰,ä½†ä¸å®Œæ•´**

âœ… **æœ‰ä¿è­·**: `shares > 0 and cost = 0`
```powerbuilder
if(shares > 0 and cost=0, 0, currency_value / cost - 1)
```

âŒ **æ²’ä¿è­·**: `shares = 0 and cost = 0`
- ä½†å¯¦å‹™ä¸Šå› ç‚º SQL æœƒéæ¿¾æ‰ shares=0 çš„è¨˜éŒ„,æ‰€ä»¥æ²’å‡ºå•é¡Œ

**å®Œæ•´çš„ä¿è­·æ‡‰è©²æ˜¯**:
```powerbuilder
if(cost = 0, 0, currency_value / cost - 1)
```

---

### å•é¡Œ 3: æ˜¯é‡å° V ç³»åˆ—åšè™•ç†å°è‡´éŒ¯èª¤,é‚„æ˜¯å› ç‚º AMOUNT å®¹æ˜“ç‚º 0?

**ç­”æ¡ˆ**: **å¾Œè€… - å› ç‚º AMOUNT å®¹æ˜“ç‚º 0**

**å› æœé—œä¿‚**:
```
â‘  Vç³»åˆ—çš„ AMOUNT å®¹æ˜“ç‚º 0 (è³‡æ–™ç‰¹æ€§)
  â†“
â‘¡ SQL é¸æ“‡ä½¿ç”¨ AMOUNT (è¨­è¨ˆæ±ºç­–)
  â†“
â‘¢ æ²’æœ‰é›¶æª¢æŸ¥ä¿è­· (è¨­è¨ˆç¼ºé™·)
  â†“
â‘£ é™¤ä»¥é›¶éŒ¯èª¤
```

**ä¸æ˜¯**é‡å° V ç³»åˆ—åšè™•ç†**å°è‡´**éŒ¯èª¤

**è€Œæ˜¯**:
1. V ç³»åˆ—çš„ AMOUNT **è³‡æ–™ç‰¹æ€§**å®¹æ˜“ç‚º 0
2. é¸æ“‡ä½¿ç”¨é€™å€‹å®¹æ˜“ç‚º 0 çš„æ¬„ä½
3. ç¼ºå°‘é˜²è­·æ©Ÿåˆ¶

**é¡æ¯”**: ä¸æ˜¯"èµ°é€™æ¢è·¯å°è‡´æ’è»Š",è€Œæ˜¯"è·¯ä¸Šæœ‰å‘ + èµ°é€™æ¢è·¯ + æ²’æ³¨æ„çœ‹ = æ’è»Š"
